!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("regenerator-runtime"),require("three")):"function"==typeof define&&define.amd?define(["exports","regenerator-runtime","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Phy={},null,e.THREE$1)}(this,(function(e,t,s){"use strict";function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var a=i(s);const r=Math.PI,o=r/180,n=180/r,l=Number.EPSILON,h=.5*r,c={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:e=>Math.pow(e,5),candelaToLumens:e=>4*e*Math.PI,lumensToCandela:e=>e/(4*Math.PI),todeg:n,torad:o,toFixed:(e,t=3)=>1*e.toFixed(t),toRound:(e,t=3)=>Math.trunc(e),clamp:(e,t=0,s=1)=>e=(e=e<t?t:e)>s?s:e,clampA:(e,t,s)=>Math.max(t,Math.min(s,e)),lerp:(e,t,s)=>(1-s)*e+s*t,damp:(e,t,s,i)=>c.lerp(e,t,1-Math.exp(-s*i)),nearAngle:(e,t,s=!1)=>t+Math.atan2(Math.sin(e-t),Math.cos(e-t))*(s?n:1),unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,autoSize:(e=[1,1,1],t="box")=>{1===e.length&&(e[1]=e[0]);let s=e[0],i=e[1];return"sphere"===t&&(e=[s,s,s]),"cylinder"!==t&&"wheel"!==t&&"capsule"!==t||(e=[s,i,s]),"cone"!==t&&"pyramid"!==t||(e=[s,i,s]),2===e.length&&(e[2]=e[0]),e},shuffle:e=>e.map((e=>({value:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({value:e})=>e)),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),randIntUnic:(e,t,s)=>{for(var i=[];i.length<s;){var a=c.randInt(e,t);-1===i.indexOf(a)&&i.push(a)}return i},fromTransform:(e,t,s,i=[0,0,0,1],a=!1)=>{let r=c.composeMatrixArray(e,t),o=c.composeMatrixArray(s,i);return a&&(r=c.invertMatrixArray(r)),r=c.multiplyMatrixArray(r,o),[r[12],r[13],r[14]]},fromTransformToQ:(e,t,s=!1)=>{let i=c.composeMatrixArray(e,t),a=c.decomposeFullMatrixArray(i).q;return s&&(a=c.quatInvert(a)),a},composeMatrixArray:(e,t,s=[1,1,1])=>{const i=t[0],a=t[1],r=t[2],o=t[3],n=i+i,l=a+a,h=r+r,c=i*n,A=i*l,d=i*h,u=a*l,p=a*h,m=r*h,g=o*n,f=o*l,b=o*h,y=s[0],w=s[1],v=s[2];return[(1-(u+m))*y,(A+b)*y,(d-f)*y,0,(A-b)*w,(1-(c+m))*w,(p+g)*w,0,(d+f)*v,(p-g)*v,(1-(c+u))*v,0,e[0],e[1],e[2],1]},multiplyMatrixArray:(e,t)=>{const s=e,i=t,a=[],r=s[0],o=s[4],n=s[8],l=s[12],h=s[1],c=s[5],A=s[9],d=s[13],u=s[2],p=s[6],m=s[10],g=s[14],f=s[3],b=s[7],y=s[11],w=s[15],v=i[0],C=i[4],I=i[8],x=i[12],B=i[1],E=i[5],M=i[9],S=i[13],k=i[2],Q=i[6],R=i[10],T=i[14],F=i[3],D=i[7],L=i[11],P=i[15];return a[0]=r*v+o*B+n*k+l*F,a[4]=r*C+o*E+n*Q+l*D,a[8]=r*I+o*M+n*R+l*L,a[12]=r*x+o*S+n*T+l*P,a[1]=h*v+c*B+A*k+d*F,a[5]=h*C+c*E+A*Q+d*D,a[9]=h*I+c*M+A*R+d*L,a[13]=h*x+c*S+A*T+d*P,a[2]=u*v+p*B+m*k+g*F,a[6]=u*C+p*E+m*Q+g*D,a[10]=u*I+p*M+m*R+g*L,a[14]=u*x+p*S+m*T+g*P,a[3]=f*v+b*B+y*k+w*F,a[7]=f*C+b*E+y*Q+w*D,a[11]=f*I+b*M+y*R+w*L,a[15]=f*x+b*S+y*T+w*P,a},invertMatrixArray:e=>{const t=e,s=t[0],i=t[1],a=t[2],r=t[3],o=t[4],n=t[5],l=t[6],h=t[7],c=t[8],A=t[9],d=t[10],u=t[11],p=t[12],m=t[13],g=t[14],f=t[15],b=A*g*h-m*d*h+m*l*u-n*g*u-A*l*f+n*d*f,y=p*d*h-c*g*h-p*l*u+o*g*u+c*l*f-o*d*f,w=c*m*h-p*A*h+p*n*u-o*m*u-c*n*f+o*A*f,v=p*A*l-c*m*l-p*n*d+o*m*d+c*n*g-o*A*g,C=s*b+i*y+a*w+r*v;if(0===C)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const I=1/C;return t[0]=b*I,t[1]=(m*d*r-A*g*r-m*a*u+i*g*u+A*a*f-i*d*f)*I,t[2]=(n*g*r-m*l*r+m*a*h-i*g*h-n*a*f+i*l*f)*I,t[3]=(A*l*r-n*d*r-A*a*h+i*d*h+n*a*u-i*l*u)*I,t[4]=y*I,t[5]=(c*g*r-p*d*r+p*a*u-s*g*u-c*a*f+s*d*f)*I,t[6]=(p*l*r-o*g*r-p*a*h+s*g*h+o*a*f-s*l*f)*I,t[7]=(o*d*r-c*l*r+c*a*h-s*d*h-o*a*u+s*l*u)*I,t[8]=w*I,t[9]=(p*A*r-c*m*r-p*i*u+s*m*u+c*i*f-s*A*f)*I,t[10]=(o*m*r-p*n*r+p*i*h-s*m*h-o*i*f+s*n*f)*I,t[11]=(c*n*r-o*A*r-c*i*h+s*A*h+o*i*u-s*n*u)*I,t[12]=v*I,t[13]=(c*m*a-p*A*a+p*i*d-s*m*d-c*i*g+s*A*g)*I,t[14]=(p*n*a-o*m*a-p*i*l+s*m*l+o*i*g-s*n*g)*I,t[15]=(o*A*a-c*n*a+c*i*l-s*A*l-o*i*d+s*n*d)*I,t},matrixArrayDeterminant:e=>{const t=e,s=t[0],i=t[4],a=t[8],r=t[12],o=t[1],n=t[5],l=t[9],h=t[13],c=t[2],A=t[6],d=t[10],u=t[14];return t[3]*(+r*l*A-a*h*A-r*n*d+i*h*d+a*n*u-i*l*u)+t[7]*(+s*l*u-s*h*d+r*o*d-a*o*u+a*h*c-r*l*c)+t[11]*(+s*h*A-s*n*u-r*o*A+i*o*u+r*n*c-i*h*c)+t[15]*(-a*n*c-s*l*A+s*n*d+a*o*A-i*o*d+i*l*c)},decomposeMatrixArray:e=>[e[12],e[13],e[14]],decomposeFullMatrixArray:e=>{const t=e;let s=c.lengthArray([t[0],t[1],t[2]]);const i=c.lengthArray([t[4],t[5],t[6]]),a=c.lengthArray([t[8],t[9],t[10]]);c.matrixArrayDeterminant(e)<0&&(s=-s);let r=[...e];const o=1/s,n=1/i,l=1/a;r[0]*=o,r[1]*=o,r[2]*=o,r[4]*=n,r[5]*=n,r[6]*=n,r[8]*=l,r[9]*=l,r[10]*=l;let h=c.quatFromRotationMatrix(r);return{p:[e[12],e[13],e[14]],q:h,s:[s,i,a]}},applyTransformArray:(e,t,s,i=[1,1,1])=>{const a=c.composeMatrixArray(t,s,i),r=e[0],o=e[1],n=e[2],l=1/(a[3]*r+a[7]*o+a[11]*n+a[15]);return[(a[0]*r+a[4]*o+a[8]*n+a[12])*l,(a[1]*r+a[5]*o+a[9]*n+a[13])*l,(a[2]*r+a[6]*o+a[10]*n+a[14])*l]},slerpQuatArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let i=[...e];const a=e[0],r=e[1],o=e[2],n=e[3],h=t[0],A=t[1],d=t[2],u=t[3];let p=n*u+a*h+r*A+o*d;if(p<0?(i=[-h,-A,-d,-u],p=-p):i=[...t],p>=1)return e;const m=1-p*p;if(m<=l){const e=1-s;return i[3]=e*n+s*i[3],i[0]=e*a+s*i[0],i[1]=e*r+s*i[1],i[2]=e*o+s*i[2],c.quatNomalize(i)}const g=Math.sqrt(m),f=Math.atan2(g,p),b=Math.sin((1-s)*f)/g,y=Math.sin(s*f)/g;return i[3]=n*b+i[3]*y,i[0]=a*b+i[0]*y,i[1]=r*b+i[1]*y,i[2]=o*b+i[2]*y,i},toLocalQuatArray:(e=[0,0,0],t)=>{let s=c.quatFromEuler(e),i=c.quatInvert(t.quaternion.toArray());return c.quatMultiply(i,s)},quatFromRotationMatrix:e=>{let t=[0,0,0,1];const s=e,i=s[0],a=s[4],r=s[8],o=s[1],n=s[5],l=s[9],h=s[2],c=s[6],A=s[10],d=i+n+A;if(d>0){const e=.5/Math.sqrt(d+1);t[3]=.25/e,t[0]=(c-l)*e,t[1]=(r-h)*e,t[2]=(o-a)*e}else if(i>n&&i>A){const e=2*Math.sqrt(1+i-n-A);t[3]=(c-l)/e,t[0]=.25*e,t[1]=(a+o)/e,t[2]=(r+h)/e}else if(n>A){const e=2*Math.sqrt(1+n-i-A);t[3]=(r-h)/e,t[0]=(a+o)/e,t[1]=.25*e,t[2]=(l+c)/e}else{const e=2*Math.sqrt(1+A-i-n);t[3]=(o-a)/e,t[0]=(r+h)/e,t[1]=(l+c)/e,t[2]=.25*e}return t},quatFromEuler:(e=[0,0,0],t=!0)=>{const s=Math.cos,i=Math.sin,a=t?o:1,r=e[0]*a*.5,n=e[1]*a*.5,l=e[2]*a*.5,h=s(r),c=s(n),A=s(l),d=i(r),u=i(n),p=i(l);return[d*c*A+h*u*p,h*u*A-d*c*p,h*c*p+d*u*A,h*c*A-d*u*p]},quatFromAxis:(e=[0,0,0],t,s=!0)=>{const i=.5*t*(s?o:1),a=Math.sin(i);return[e[0]*a,e[1]*a,e[2]*a,Math.cos(i)]},quatNomalize:e=>{let t=c.lengthArray(e);return 0===t?[0,0,0,1]:(t=1/t,c.scaleArray(e,t,4))},quatInvert:e=>[-e[0],-e[1],-e[2],e[3]],quatMultiply:(e,t)=>{const s=e[0],i=e[1],a=e[2],r=e[3],o=t[0],n=t[1],l=t[2],h=t[3];return[s*h+r*o+i*l-a*n,i*h+r*n+a*o-s*l,a*h+r*l+s*n-i*o,r*h-s*o-i*n-a*l]},quatToAxis:e=>{let t=2*Math.acos(e[3]);const s=Math.sqrt(1-e[3]*e[3]);return s<1e-4?[1,0,0]:[e[0]/s,e[1]/s,e[2]/s,t]},eulerFromMatrix:e=>{const t=e[0],s=e[4],i=e[8];e[1];const a=e[5],r=e[9];e[2];const o=e[6],n=e[10];let l=[0,0,0];return l[1]=Math.asin(c.clamp(i,-1,1)),Math.abs(i)<.9999999?(l[0]=Math.atan2(-r,n),l[2]=Math.atan2(-s,t)):(l[0]=Math.atan2(o,a),l[2]=0),l},angleTo:(e,t)=>2*Math.acos(Math.abs(c.clamp(c.dotArray(e,t),-1,1))),getSize:e=>.001*e.byteLength+"kb",perpendicularArray:e=>{const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);let s=Math.acos(e[1]/t);const i=Math.atan2(e[2],e[0]);s>h?s-=h:s+=h;return[t*Math.sin(s)*Math.cos(i),t*Math.cos(s),t*Math.sin(s)*Math.sin(i)]},crossArray:(e,t)=>{const s=e[0],i=e[1],a=e[2],r=t[0],o=t[1],n=t[2];return[i*n-a*o,a*r-s*n,s*o-i*r]},applyQuaternion:(e,t)=>{const s=e[0],i=e[1],a=e[2],r=t[0],o=t[1],n=t[2],l=t[3],h=2*(o*a-n*i),c=2*(n*s-r*a),A=2*(r*i-o*s);return[s+l*h+o*A-n*c,i+l*c+n*h-r*A,a+l*A+r*c-o*h]},nullArray:(e,t,s)=>{let i=0;for(;s--;)i+=e[t+s];return i},equalArray:(e,t)=>{let s=e.length;for(;s--;)if(e[s]!==t[s])return!1;return!0},lerpArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let i=e.length,a=[];for(;i--;)a[i]=e[i],a[i]+=(t[i]-a[i])*s;return a},zeroArray:(e,t=0,s)=>{for(s=s??e.length;s--;)e[t+s]=0;return e},lengthArray:e=>{let t=e.length,s=0;for(;t--;)s+=e[t]*e[t];return Math.sqrt(s)},dotArray:(e,t)=>{let s=e.length,i=0;for(;s--;)i+=e[s]*t[s];return i},addArray:(e,t,s)=>{s=s??e.length;let i=[];for(;s--;)i[s]=e[s]+t[s];return i},subArray:(e,t,s)=>{s=s??e.length;let i=[];for(;s--;)i[s]=e[s]-t[s];return i},mulArray:(e,t,s)=>{if(t instanceof Array){let i=[];for(s=s??e.length;s--;)i[s]=e[s]*t[s];return i}return e.map((e=>e*t))},divArray:(e,t,s)=>c.mulArray(e,1/t,s),scaleArray:(e,t,s)=>c.mulArray(e,t,s),fillArray:(e,t,s=0,i)=>{for(i=i??e.length;i--;)t[s+i]=e[i]},copyArray:(e,t)=>{},cloneArray:e=>[...e],distanceArray:(e,t=[0,0,0])=>c.lengthArray(c.subArray(e,t)),normalizeArray:e=>c.divArray(e,c.lengthArray(e)||1),normalArray:(e,t=[0,0,0])=>c.normalizeArray(c.subArray(t,e)),getVolume:(e,t,s=null)=>{let i=1,a=t;switch(e){case"sphere":i=4*Math.PI*a[0]*a[0]*a[0]/3;break;case"cone":i=Math.PI*a[0]*(.5*a[1])*2;break;case"box":i=.5*a[0]*8*(.5*a[1])*(.5*a[2]);break;case"cylinder":i=Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"capsule":i=4*Math.PI*a[0]*a[0]*a[0]/3+Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"convex":case"mesh":i=c.getConvexVolume(s)}return i},getConvexVolume:e=>{let t,s=e.length/3,i=[0,0,0],a=[0,0,0];for(;s--;)t=3*s,e[t]<i[0]?i[0]=e[t]:e[t]>a[0]&&(a[0]=e[t]),e[t+1]<i[1]?i[1]=e[t+1]:e[t+1]>a[1]&&(a[1]=e[t+1]),e[t+2]<i[2]?i[2]=e[t+2]:e[t+2]>a[2]&&(a[2]=e[t+2]);let r=[a[0]-i[0],a[1]-i[1],a[2]-i[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])},massFromDensity:(e,t)=>e*t,densityFromMass:(e,t)=>e/t,toNonIndexed:e=>e.index?e.clone().toNonIndexed():e,getIndex:(e,t)=>!e.index||t?null:e.index.array||null,getVertex:(e,t)=>{let s=e.attributes.position.array;return t&&e.index&&(s=(e=e.clone().toNonIndexed()).attributes.position.array),s},getNormal:e=>e.attributes.normal.array,getFaces:e=>{let t=[];if(e.index){let s=e.getIndex();for(let e=0;e<s.count;e+=3)t.push([s.getX(e),s.getX(e+1),s.getX(e+2)])}else{let s=e.getAttribute("position").count;for(let e=0;e<s;e+=3)t.push([e,e+1,e+2])}return t},reduce:e=>{},barycentric:(e,t)=>{},solve:(e,t)=>{}},A=c,d=["PHYSX","HAVOK"],u=4e3,p=1e3,g=4e3,f=100,b=100,y=50,w=20,v={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},C=function(e,t=!1){const s={};let i={body:u*(t?v.bodyFull:v.body),joint:p*v.joint,ray:f*v.ray,contact:g*v.contact,character:b*v.character};"PHYSX"!==e&&"AMMO"!==e||(i.vehicle=y*v.vehicle),"PHYSX"===e&&(i.solver=w*v.solver),"HAVOK"!==e&&"RAPIER"!==e&&"JOLT"!==e||(v.joint=0);let a=0;for(let e in i)s[e]=a,a+=i[e];return s.total=a,s},I=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.mass||e.density||e.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return e.type}},x=new Map,B={debug:!1,Ar:null,ArPos:{},garbage:[],viewSize:null,engine:"OIMO",motor:null,scene:null,scenePlus:null,post:null,jointVisible:!1,delta:0,add:null,remove:null,items:null,tmpMesh:[],instanceMesh:{},tmpTex:[],mouseDown:!1,flow:{stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},reflow:{ray:[],stat:{fps:0},point:{},velocity:{}},extraMaterial:()=>{},disposeTmp:()=>{let e,t,s;for(e in B.tmpMesh){if(s=B.tmpMesh[e],s.children)for(t in s.children)B.disposeMesh(s.children[t]);B.disposeMesh(s),s.parent&&s.parent.remove(s)}for(e in B.tmpMesh=[],B.tmpTex)B.tmpTex[e].dispose()},disposeMesh:e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()}},E={byName:e=>x.has(e)?x.get(e):null,add:(e,t)=>{if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else if(e.isButton)B.scene.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":B.scenePlus.add(e);break;default:B.scene.add(e)}e.isInstance&&e.refName!==e.name&&x.set(e.refName,e),x.set(e.name,e)},remove:e=>{e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.isInstance&&(e.refName!==e.name&&x.delete(e.refName),e.instance.remove(e.id)),x.delete(e.name)},noRay:e=>{e.isObject3D&&(e.raycast=()=>{},e.traverse((e=>{e.isObject3D&&(e.raycast=()=>{})})))},morph:(e,t,s)=>{e.morphTargetInfluences&&void 0!==e.morphTargetDictionary[t]&&(e.morphTargetInfluences[e.morphTargetDictionary[t]]=s)},toLocal:(e,t,s=!1)=>{s||e.sub(t.position);let i=t.quaternion;return e.applyQuaternion({x:-i._x,y:-i._y,z:-i._z,w:i._w}),e},quatLocal:(e,t)=>{t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new s.Quaternion).fromArray(e),a=t.quaternion.clone().invert();return i.premultiply(a),i.normalize().toArray()},axisLocal:(e,t)=>{t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new s.Matrix3).setFromMatrix4(t.matrixWorld);return(new s.Vector3).fromArray(e).applyMatrix3(i).toArray()},quatToAngular:(e,t)=>{t[0]*=-1,t[1]*=-1,t[2]*=-1;let i,a=t[0]*e[3]+t[3]*e[0]+t[1]*e[2]-t[2]*e[1],r=t[1]*e[3]+t[3]*e[1]+t[2]*e[0]-t[0]*e[2],o=t[2]*e[3]+t[3]*e[2]+t[0]*e[1]-t[1]*e[0],n=t[3]*e[3]-t[0]*e[0]-t[1]*e[1]-t[2]*e[2],l=2*Math.acos(n),h=Math.sqrt(1-n*n);i=h<.001?[0,0,0]:[a/h,r/h,o/h];(new s.Vector3).fromArray(i).multiplyScalar(l/1)},refAxis:(e,t)=>{let i=(new s.Vector3).fromArray(t),a=new s.Vector3(1,0,0),r=new s.Vector3(0,1,0);Math.abs(t[1])>.9999||a.copy(i).cross(r).normalize(),r.copy(a).cross(i).normalize(),e.makeBasis(a,r,i)}};class M extends s.LineSegments{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),a=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],r=new s.BufferGeometry;r.setIndex(new s.BufferAttribute(i,1)),r.setAttribute("position",new s.Float32BufferAttribute(a,3)),r.setAttribute("color",new s.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(r,new s.LineBasicMaterial({color:t,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=e,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}let S=0,k={};const Q=e=>{k["geo"+S++]=e},R=e=>{k[e.name]=e},T=(e,t={})=>{if(!k[e]){let t;switch(e){case"plane":t=new s.PlaneGeometry(1,1),t.rotateX(.5*-Math.PI);break;case"box":t=new s.BoxGeometry(1,1,1);break;case"sphere":t=new s.SphereGeometry(1,16,12);break;case"cylinder":t=new s.CylinderGeometry(1,1,1,16);break;case"cone":t=new s.CylinderGeometry(.001,1,1,16);break;case"particle":t=new s.SphereGeometry(1,8,6);break;case"joint":t=(new M).geometry;break;default:return null}k[e]=t}return k[e]},F=()=>{for(let e in k)k[e].isBufferGeometry?k[e].dispose():console.log(k[e]);k={},S=0};class D{constructor(e,t="rgb(69,69,69)",i="rgb(39,39,39)"){const a=document.createElement("canvas");a.width=a.height=128;const r=a.getContext("2d");if(r.fillStyle=t,r.fillRect(0,0,128,128),e){let s,a,o,n,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=e?"rgb(128,128,255)":t,A=e?"rgb(160,100,255)":i,d=e?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(r.strokeStyle=d,r.lineWidth=1,s=0;s<5;s++){n=r.createLinearGradient(0,h[s][0],0,h[s][1]),n.addColorStop(0,A),n.addColorStop(1,c),r.beginPath(),r.fillStyle=n,r.rect(l[s][0],l[s][1],32,64),r.fill();for(let e=0;e<8;e++)o=2*(Math.random()-.5),r.beginPath(),r.moveTo(l[s][0]+o+2+4*e,l[s][1]),r.lineTo(l[s][0]+o+2+4*e,l[s][1]+64),r.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],s=0;s<5;s++)for(n=r.createLinearGradient(h[s][0],0,h[s][1],0),n.addColorStop(0,c),n.addColorStop(1,A),r.beginPath(),r.fillStyle=n,r.rect(l[s][0],l[s][1],64,32),r.fill(),a=0;a<8;a++)o=2*(Math.random()-.5),r.beginPath(),r.moveTo(l[s][0],l[s][1]+o+2+4*a),r.lineTo(l[s][0]+64,l[s][1]+o+2+4*a),r.stroke()}else r.beginPath(),r.fillStyle=i,r.rect(0,0,32,64),r.rect(32,32,32,64),r.rect(64,64,32,64),r.rect(96,96,32,64),r.rect(96,-32,32,64),r.fill();const o=new s.CanvasTexture(a);return o.wrapS=o.wrapT=s.RepeatWrapping,o.repeat.x=o.repeat.y=60,e||(o.colorSpace=s.SRGBColorSpace),o}}class L extends s.MeshPhysicalMaterial{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new s.Color(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(e);let t=this;t.onBeforeCompile=function(e){for(let s in t.extra)e.uniforms[s]={value:t.extra[s]};e.fragmentShader=e.fragmentShader.replace("#include <common>",P.common),e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",t.replaceAll(s.ShaderChunk.lights_fragment_begin,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",P.light)),t.userData.shader=e}}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.userData.shader&&(this.userData.shader.uniforms[e].value=this.extra[e])}})}replaceAll(e,t,s){return e.split(t).join(s)}}const P={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},_="\nfloat aoMapClr = 1.;\n\n#ifdef USE_AOMAP\n    aoMapClr = (texture2D(aoMap, vAoMapUv).r - 1.0) * aoMapIntensity + 1.0;\n#else\n    #ifdef USE_LIGHTMAP\n\n        float lightMapIntensityCorrect = lightMapIntensity;\n        if(useLegacyLights) lightMapIntensityCorrect = lightMapIntensity / PI;\n        vec3 lightMapVec = (texture2D(lightMap, vLightMapUv).rgb - vec3(1.)) * (lightMapIntensityCorrect) + vec3(1.);\n        \n        const vec3 luminanceWeight = vec3(0.2126, 0.7152, 0.0722);\n\n        // grayscale the lightmap\n        aoMapClr = dot(lightMapVec.rgb, luminanceWeight);\n    #endif\n#endif\n\nif(aoMapGamma != 1.) aoMapClr = pow(aoMapClr, 1. / aoMapGamma);\n\n// clamp\naoMapClr = min(1., aoMapClr);\n",G="\nenvMapColor.rgb *= aoMapClr;\n\nvec3 origEnvMapColor = vec3(envMapColor.rgb);\n\nfloat origAoMapClr = aoMapClr;\n\n#ifndef DISABLE_SMOOTHING\n    // calculate smoothing\n    float smoothingRoughnessInfluence = max(0.75 - roughness, 0.);\n    float smoothingAoInfluence = (1. - aoMapClr) * 0.75;\n\n    float totalSmoothing = 0.3 + smoothingPower + (1. - smoothingPower) * smoothingRoughnessInfluence - smoothingAoInfluence;\n    vec3 smoothing = vec3(max(totalSmoothing, 0.));\n\n    envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n#endif\n\nenvMapColor.rgb += pow(envMapColor.rgb, vec3(envPower)) * (aoPower * 0.2);\n\nfloat aoMapPower = pow(aoMapClr + aoSmoothing * (0.5 - aoMapClr), aoPower);\nif(aoMapPower > 1.) aoMapPower = 1.;\n",z=`\n\nif(enableESL){\n    ${G}\n\n    envMapColor.rgb *= irradianceColor;\n\n    #ifndef DISABLE_SMOOTHING\n        envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n    #endif\n\n    float origAoMapClrPow = origAoMapClr * origAoMapClr;\n\n    vec3 hemisphereInfluence = aoMapClr * mix(\n        irradianceColor,\n        hemisphereColor,\n        1. - origAoMapClrPow\n    ) * envMapColor.rgb * envMapIntensity * 0.125;\n\n    envMapColor.rgb = mix(envMapColor.rgb, hemisphereColor, 1. - origAoMapClrPow);\n\n    vec3 env = irradianceIntensity * envMapColor.rgb * envMapIntensity * aoMapPower + hemisphereInfluence;\n\n    if(sunIntensity != 0.){\n        env += irradianceIntensity * sunIntensity * irradianceColor * origEnvMapColor * envMapIntensity * pow(aoMapClr, 16.);\n    }\n\n     return env;\n} else {\n    return PI * envMapColor.rgb * envMapIntensity;\n}\n`,U=`\n\nif(enableESL) {\n    ${G}\n\n    #ifndef DISABLE_SMOOTHING\n\n        envMapColor.rgb *= radianceColor;\n        envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n\n    #endif\n\n    vec3 env = envMapColor.rgb * envMapIntensity * 0.125 * (aoMapPower * radianceIntensity + aoMapClr * radianceColor);\n\n    if(sunIntensity != 0.){\n        env += radianceIntensity * sunIntensity * irradianceColor * origEnvMapColor * envMapIntensity * pow(aoMapClr, 16.);\n    }\n\n    return env;\n\n} else {\n    return envMapColor.rgb * envMapIntensity;\n}\n`,O="\n#ifdef USE_MAP\n\n   vec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\n   #ifdef DECODE_VIDEO_TEXTURE\n\n        // use inline sRGB decode until browsers properly support SRGB8_ALPHA8 with video textures (#26516)\n\n        sampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n    \n    #endif\n\nif(enableESL) {\n    #ifdef USE_LIGHTMAP\n        float lightMapIntensityCorrect = lightMapIntensity;\n        if(useLegacyLights) lightMapIntensityCorrect = lightMapIntensity / PI;\n        vec3 lightMapClr = (texture2D(lightMap, vLightMapUv).rgb - vec3(1.)) * (lightMapIntensityCorrect) + vec3(1.);\n    #else\n        vec3 lightMapClr = vec3(1.);\n    #endif\n\n    if(lightMapGamma != 1.) lightMapClr = pow(lightMapClr, vec3(1. / lightMapGamma));\n\n    if(lightMapContrast != 1.) lightMapClr = adjustContrast(lightMapClr, lightMapContrast);\n\n    // clamp\n    lightMapClr = min(lightMapClr, vec3(1.));\n\n    // source: Chapter 16 of OpenGL Shading Language\n    const vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(lightMapClr, W));\n    lightMapClr = mix(intensity, lightMapClr, lightMapSaturation);\n\n    if(mapContrast != 1.) sampledDiffuseColor = vec4(adjustContrast(sampledDiffuseColor.rgb, mapContrast), sampledDiffuseColor.a);\n    //sampledDiffuseColor = clamp(sampledDiffuseColor, 0.0,1.0);\n    //if(mapContrast != 1.) sampledDiffuseColor *= contrastMatrix( mapContrast );\n    //if(mapContrast != 1.) sampledDiffuseColor *= saturationMatrix( mapContrast );\n\n    vec3 lightMapHsv = rgb2hsv(lightMapClr);\n    float saturation = lightMapHsv.y;\n\n    float mixVal = saturation;\n    \n    float value = pow(lightMapHsv.z, 0.05);\n    float darkness = 1. - value;\n\n     lightMapHsv.y = mix(lightMapHsv.y, lightMapHsv.y * 5., darkness * 1.75);\n    \n    lightMapHsv = hsv2rgb(lightMapHsv);\n\n    // blend the lightmap color towards the diffuse color the more light this spot receives\n    lightMapHsv = mix(lightMapHsv, lightMapHsv * normalize(sampledDiffuseColor.rgb) * length(sampledDiffuseColor.rgb), value);\n\n    mixVal += darkness * 0.2;\n    \n    lightMapClr = pow(\n        mix(lightMapClr, lightMapHsv, mixVal),\n        vec3(1.25)\n    );\n\n    float lightnessFactor = pow(lightMapHsv.z, 0.1);\n\n    diffuseColor *= lightnessFactor * sampledDiffuseColor * vec4(lightMapClr, 1.0);\n    diffuseColor.a = 1.0;\n\n} else {\n    diffuseColor *= sampledDiffuseColor;\n}\n#endif\n";a.ShaderChunk.map_fragment.replace("diffuseColor *= sampledDiffuseColor;",O);const N=a.ShaderChunk.lights_pars_begin.replace("vec3 irradiance = ambientLightColor;",`\n    vec3 irradiance = vec3(0.0);\n    if(enableESL) {\n        ${_}\n        aoMapClr *= aoMapClr;\n        irradiance = mix( ambientLightColor, aoColor * 15.0 * ((aoMapClr - 1.0) * 0.28 + 1.0), 1.0 - aoMapClr );\n    } else {\n        irradiance = ambientLightColor;\n    }\n    `),V=a.ShaderChunk.lights_fragment_maps.replace("irradiance += lightMapIrradiance;","if(!enableESL) irradiance += lightMapIrradiance;"),q=e=>{let t=Math.fround(e).toString();return t.includes(".")||(t+="."),t},H=e=>"vec3("+q(e.r)+", "+q(e.g)+", "+q(e.b)+")";function j(e,{enableESL:t=!0,useLegacyLights:s=!1,aoColor:i=new a.Color(0),hemisphereColor:r=new a.Color(16777215),irradianceColor:o=new a.Color(16777215),radianceColor:n=new a.Color(16777215),aoPower:l=1,aoSmoothing:h=0,aoMapGamma:c=1,lightMapGamma:A=1,lightMapSaturation:d=1,envPower:u=1,roughnessPower:p=1,sunIntensity:m=0,mapContrast:g=1,lightMapContrast:f=1,smoothingPower:b=.25,irradianceIntensity:y=Math.PI,radianceIntensity:w=1,hardcodeValues:v=!1}={}){e.defines&&e.fragmentShader.includes("#define ENHANCE_SHADER_LIGHTING")||(void 0===e.defines&&(e.defines={}),e.defines.ENHANCE_SHADER_LIGHTING="",v?e.fragmentShader=e.fragmentShader.replace("uniform float opacity;",`\n            uniform float opacity;\n            \n            const vec3 aoColor = ${H(i)};\n            const vec3 hemisphereColor = ${H(r)};\n            const vec3 irradianceColor = ${H(o)};\n            const vec3 radianceColor = ${H(n)};\n\n            const float aoPower = ${q(l)};\n            const float aoSmoothing = ${q(h)};\n            const float aoMapGamma = ${q(c)};\n            const float lightMapGamma = ${q(A)};\n            const float lightMapSaturation = ${q(d)};\n            const float envPower = ${q(u)};\n            const float roughnessPower = ${q(p)};\n            const float sunIntensity = ${q(m)};\n            const float mapContrast = ${q(g)};\n            const float lightMapContrast = ${q(f)};\n            const float smoothingPower = ${q(b)};\n            const float irradianceIntensity = ${q(y)};\n            const float radianceIntensity = ${q(w)};\n            `):(e.uniforms.aoColor={value:i},e.uniforms.hemisphereColor={value:r},e.uniforms.irradianceColor={value:o},e.uniforms.radianceColor={value:n},e.uniforms.enableESL={value:t},e.uniforms.useLegacyLights={value:s},e.uniforms.aoPower={value:l},e.uniforms.aoSmoothing={value:h},e.uniforms.lightMapGamma={value:A},e.uniforms.lightMapSaturation={value:d},e.uniforms.aoMapGamma={value:c},e.uniforms.envPower={value:u},e.uniforms.smoothingPower={value:b},e.uniforms.roughnessPower={value:p},e.uniforms.sunIntensity={value:m},e.uniforms.mapContrast={value:g},e.uniforms.lightMapContrast={value:f},e.uniforms.irradianceIntensity={value:y},e.uniforms.radianceIntensity={value:w},e.fragmentShader=e.fragmentShader.replace("uniform float opacity;","\n            uniform float opacity;\n            \n            uniform vec3 aoColor;\n            uniform vec3 hemisphereColor;\n            uniform vec3 irradianceColor;\n            uniform vec3 radianceColor;\n\n            uniform bool enableESL;\n            uniform bool useLegacyLights;\n\n            uniform float aoPower;\n            uniform float aoSmoothing;\n            uniform float aoMapGamma;\n            uniform float lightMapGamma;\n            uniform float lightMapSaturation;\n            uniform float envPower;\n            uniform float roughnessPower;\n            uniform float sunIntensity;\n            uniform float mapContrast;\n            uniform float lightMapContrast;\n            uniform float smoothingPower;\n            uniform float irradianceIntensity;\n            uniform float radianceIntensity;\n\n            #define ENHANCE_SHADER_LIGHTING\n            \n\nmat4 brightnessMatrix( float brightness )\n{\n    return mat4( 1, 0, 0, 0,\n                 0, 1, 0, 0,\n                 0, 0, 1, 0,\n                 brightness, brightness, brightness, 1 );\n}\n\nmat4 contrastMatrix( float contrast )\n{\n    float t = ( 1.0 - contrast ) / 2.0;\n    \n    return mat4( contrast, 0, 0, 0,\n                 0, contrast, 0, 0,\n                 0, 0, contrast, 0,\n                 t, t, t, 1 );\n\n}\n\nmat4 saturationMatrix( float saturation )\n{\n    vec3 luminance = vec3( 0.3086, 0.6094, 0.0820 );\n    \n    float oneMinusSat = 1.0 - saturation;\n    \n    vec3 red = vec3( luminance.x * oneMinusSat );\n    red+= vec3( saturation, 0, 0 );\n    \n    vec3 green = vec3( luminance.y * oneMinusSat );\n    green += vec3( 0, saturation, 0 );\n    \n    vec3 blue = vec3( luminance.z * oneMinusSat );\n    blue += vec3( 0, 0, saturation );\n    \n    return mat4( red,     0,\n                 green,   0,\n                 blue,    0,\n                 0, 0, 0, 1 );\n}\n//fragColor = brightnessMatrix( brightness ) *\n//                contrastMatrix( contrast ) * \n//                saturationMatrix( saturation ) *\n//                color;\n\n// source: https://timseverien.com/posts/2020-06-19-colour-correction-with-webgl/\nvec3 adjustContrast(vec3 color, float value) {\n    const vec3 zero = vec3(0.);\n    vec3 cc = color-0.5;\n    return max(zero, 0.5 + value * (cc));\n}\n\n// source: https://gist.github.com/yiwenl/745bfea7f04c456e0101\nvec3 hsv2rgb(vec3 c){\n    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\n\n// source: https://gist.github.com/yiwenl/745bfea7f04c456e0101\nvec3 rgb2hsv(vec3 rgb) {\n    float Cmax = max(rgb.r, max(rgb.g, rgb.b));\n    float Cmin = min(rgb.r, min(rgb.g, rgb.b));\n    float delta = Cmax - Cmin;\n    vec3 hsv = vec3(0., 0., Cmax);\n    if (Cmax > Cmin) {\n        hsv.y = delta / Cmax;\n        if (rgb.r == Cmax)\n            hsv.x = (rgb.g - rgb.b) / delta;\n        else {\n            if (rgb.g == Cmax)\n                hsv.x = 2. + (rgb.b - rgb.r) / delta;\n            else\n                hsv.x = 4. + (rgb.r - rgb.g) / delta;\n        }\n        hsv.x = fract(hsv.x / 6.);\n    }\n    return hsv;\n}\n\n            ")),e.fragmentShader=e.fragmentShader.replace("main() {",`\n            main() {\n            ${_}\n            `).replace("#include <aomap_fragment>","\n#ifdef USE_AOMAP\n\n    // reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n    if(!enableESL) {\n\n        float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n        reflectedLight.indirectDiffuse *= ambientOcclusion;\n\n        #if defined( USE_CLEARCOAT ) \n            clearcoatSpecularIndirect *= ambientOcclusion;\n        #endif\n\n        #if defined( USE_SHEEN ) \n            sheenSpecularIndirect *= ambientOcclusion;\n        #endif\n\n        #if defined( USE_ENVMAP ) && defined( STANDARD )\n\n            float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\n            reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\n        #endif\n    }\n\n#endif\n").replace("#include <lights_pars_begin>",N).replace("#include <lights_fragment_maps>",V).replace("#include <map_fragment>",O).replace("#include <envmap_physical_pars_fragment>",a.ShaderChunk.envmap_physical_pars_fragment).replace("getIBLIrradiance( const in vec3 normal )","getIBLIrradiance( const in vec3 normal, float aoMapClr )").replace("getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness )","getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, float aoMapClr )").replace("return PI * envMapColor.rgb * envMapIntensity;",z).replace("return envMapColor.rgb * envMapIntensity;",U).replace("#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","\n            //#include <aomap_fragment>\n            #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n            ").replace("iblIrradiance += getIBLIrradiance( geometryNormal );","iblIrradiance += getIBLIrradiance( geometryNormal, aoMapClr );").replace("radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );","radiance += getIBLRadiance( geometryViewDir, geometryNormal, pow(material.roughness, enableESL ? roughnessPower : 1.0), aoMapClr );").replace("clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );","clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, pow(material.clearcoatRoughness, enableESL ? roughnessPower : 1.0), aoMapClr );"))}class W extends s.ShaderMaterial{constructor(e={}){super(),this.vertexShader="\n      varying vec3 vPosition;\n      varying vec3 vNormal;\n\n      void main() {\n        vec4 modelPosition = modelMatrix * vec4(position, 1.0);\n        gl_Position = projectionMatrix * viewMatrix * modelPosition;\n        vec4 modelNormal = modelMatrix * vec4(normal, 0.0);\n        vPosition = modelPosition.xyz;\n        vNormal = modelNormal.xyz;\n\n      }\n    ",this.fragmentShader="\n      uniform vec3 glowColor;\n      uniform float falloff;\n      uniform float glowSharpness;\n      uniform float glowInternalRadius;\n      uniform float opacity;\n\n      varying vec3 vPosition;\n      varying vec3 vNormal;\n\n      void main()\n      {\n        // Normal\n        vec3 normal = normalize(vNormal);\n        if(!gl_FrontFacing)\n            normal *= - 1.0;\n        vec3 viewDirection = normalize(cameraPosition - vPosition);\n        float fresnel = dot(viewDirection, normal);\n        fresnel = pow(fresnel, glowInternalRadius + 0.1);\n        float falloff = smoothstep(0., falloff, fresnel);\n        float fakeGlow = fresnel;\n        fakeGlow += fresnel * glowSharpness;\n        fakeGlow *= falloff;\n        gl_FragColor = vec4(clamp(glowColor * fresnel, 0., 1.0), clamp(fakeGlow, 0., opacity));\n\n        #include <tonemapping_fragment>\n        #include <colorspace_fragment>\n      } \n      ",this.uniforms={opacity:new s.Uniform(void 0!==e.opacity?e.opacity:1),glowInternalRadius:new s.Uniform(void 0!==e.glowInternalRadius?e.glowInternalRadius:-2),glowSharpness:new s.Uniform(void 0!==e.glowSharpness?e.glowSharpness:0),falloff:new s.Uniform(void 0!==e.falloff?e.falloff:0),glowColor:new s.Uniform(void 0!==e.glowColor?new s.Color(e.glowColor):new s.Color("#202020"))},this.setValues(e),this.blending=void 0!==e.blendMode?e.blendMode:s.AdditiveBlending,this.transparent=!0,this.side=void 0!==e.side?e.side:s.FrontSide,this.polygonOffset=!0,this.polygonOffsetFactor=-1,this.polygonOffsetUnits=1,this.premultipliedAlpha=!0}}let K={},J=[];const Y={metalness:.1,roughness:.9},X={enableESL:!0,exposure:1,envMapIntensity:1,aoColor:new s.Color(0),hemisphereColor:new s.Color(16777215),irradianceColor:new s.Color(16777215),radianceColor:new s.Color(16777215),aoPower:9.7,aoSmoothing:.26,aoMapGamma:.89,lightMapGamma:.9,lightMapSaturation:1,envPower:1,roughnessPower:1,sunIntensity:0,mapContrast:1,lightMapContrast:1.03,smoothingPower:.76,irradianceIntensity:6.59,radianceIntensity:4.62,hardcodeValues:!1},Z={body:new s.Color("hsl(45, 15%, 90%)"),sleep:new s.Color("hsl(33, 15%, 54%)"),solid:new s.Color(7105128),base:new s.Color(13224135),black:new s.Color("hsl(220, 8%, 15%)"),gold:new s.Color(.944,.776,.373),gold2:new s.Color(.998,.981,.751),copper:new s.Color(.96467984,.37626296,.25818297),carPaint:new s.Color(.1037792,.59212029,.85064936),clay:new s.Color("hsl(12, 30%, 40%)"),concrete:new s.Color(11119017),Raw_Fire:new s.Color("hsl(40, 18%, 54%)"),Raw_Buff:new s.Color("hsl(33, 15%, 54%)"),Raw_Terracotta:new s.Color("hsl(12, 30%, 40%)"),Raw_Porcelain:new s.Color("hsl(45, 15%, 90%)")},$={No:s.NoBlending,Normal:s.NormalBlending,Additive:s.AdditiveBlending,Subtractive:s.SubtractiveBlending,Multiply:s.MultiplyBlending,Eadd:s.AddEquation,Esub:s.SubtractEquation,Erev:s.ReverseSubtractEquation,Emin:s.MinEquation,Emaw:s.MaxEquation,Fzero:s.ZeroFactor,Fone:s.OneFactor,Fcolor:s.SrcColorFactor,Fcolorm:s.OneMinusSrcColorFactor,Falpha:s.SrcAlphaFactor,Falpham:s.OneMinusSrcAlphaFactor,Fdstalpha:s.DstAlphaFactor,Fdstalpham:s.OneMinusDstAlphaFactor,Fdstcolor:s.DstColorFactor,Fdstcolorm:s.OneMinusDstColorFactor,Falphasaturate:s.SrcAlphaSaturateFactor,Front:s.FrontSide,Back:s.BackSide,Double:s.DoubleSide},ee={renderMode:{value:0},depthPacking:{value:0},isRealism:!1,realismOption:{},envMapIntensity:1,changeRenderMode:e=>{ee.renderMode.value=e},initExtandShader:()=>{(()=>{let e=s.ShaderChunk.common;e=e.replace("#define EPSILON 1e-6","\n\t\t#define EPSILON 1e-6\n\t\tuniform int renderMode;\n\t\tuniform int depthPacking;\n\t\tvarying vec2 vZW;\n    "),s.ShaderChunk.common=e,s.ShaderChunk.clipping_planes_vertex="\n        #if NUM_CLIPPING_PLANES > 0\n            vClipPosition = - mvPosition.xyz;\n        #endif\n        vZW = gl_Position.zw;\n    ",e=s.ShaderChunk.dithering_fragment,e=e.replace("#endif","\n\t\t#endif\n\n        #ifdef STANDARD\n\n        if( renderMode == 1 ){ // depth render\n            float fz = 0.5 * vZW[0] / vZW[1] + 0.5;\n            fz=pow(fz, 10.0);\n            gl_FragColor = depthPacking == 1 ? packDepthToRGBA( fz ) : vec4( vec3( 1.0 - fz ), opacity );\n        }\n        if( renderMode == 2 ) gl_FragColor = vec4(  packNormalToRGB( normal ), opacity );// normal render\n        //if( renderMode == 3 ) gl_FragColor = vec4(  shadowColor, opacity );// normal render\n\n        #else\n\n        if( renderMode != 0 ) discard;\n\n        #endif\n    "),s.ShaderChunk.dithering_fragment=e})()},useRealLight:e=>{ee.isRealism=!0;for(let t in e)-1!==t.search("Color")&&(e[t].isColor||(X[t].set(e[t]),delete e[t]));ee.realismOption={...X,...e}},setColor:e=>{ee.isRealism&&(X.aoColor.set(e.minLuma).convertLinearToSRGB(),X.hemisphereColor.set(e.maxLuma).convertLinearToSRGB(),X.irradianceColor.set(e.sun).convertLinearToSRGB(),X.radianceColor.set(e.vibrant).convertLinearToSRGB())},set:(e,t,s=null)=>{s||(s=e.onBeforeCompile),t||ee.extendShader(e,s),K[e.name]=e},extendShader:(e,t=null)=>{ee.isRealism?e.onBeforeCompile=function(s){s.uniforms.renderMode=ee.renderMode,s.uniforms.depthPacking=ee.depthPacking,j(s,ee.realismOption),e.userData.isRealism=!0,e.userData.shader=s,t&&t(s)}:e.onBeforeCompile=function(s){s.uniforms.renderMode=ee.renderMode,s.uniforms.depthPacking=ee.depthPacking,t&&t(s),e.userData.shader=s}},addToTmp:e=>{J.push(e)},create:e=>{let t,i=null;if(e.isMaterial)t=e;else{let a=void 0!==e.type?e.type:"Standard";switch(e.type&&delete e.type,i=e.beforeCompile||null,e.beforeCompile&&delete e.beforeCompile,(e.thickness||e.sheen||e.clearcoat||e.transmission||e.specularColor)&&(a="Physical"),e.normalScale&&(e.normalScale.isVector2||(e.normalScale=(new s.Vector2).fromArray(e.normalScale))),e.side&&(e.side=ee.findValue(e.side)),e.shadowSide&&(e.shadowSide=ee.findValue(e.shadowSide)),e.blending&&(e.blending=ee.findValue(e.blending)),e.blendEquation&&(e.blendEquation=ee.findValue(e.blendEquation)),e.blendEquationAlpha&&(e.blendEquationAlpha=ee.findValue(e.blendEquationAlpha)),e.blendSrc&&(e.blendSrc=ee.findValue(e.blendSrc)),e.blendDst&&(e.blendDst=ee.findValue(e.blendDst)),e.blendDstAlpha&&(e.blendDstAlpha=ee.findValue(e.blendDstAlpha)),e.blendSrcAlpha&&(e.blendSrcAlpha=ee.findValue(e.blendSrcAlpha)),e.clearcoatNormalScale&&(e.clearcoatNormalScale.isVector2||(e.clearcoatNormalScale=(new s.Vector2).fromArray(e.clearcoatNormalScale))),a=a.toLowerCase(),a){case"physical":t=new s.MeshPhysicalMaterial(e),t.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":t=new s.MeshPhongMaterial(e);break;case"lambert":t=new s.MeshLambertMaterial(e);break;case"basic":t=new s.MeshBasicMaterial(e);break;case"line":t=new s.LineBasicMaterial(e);break;case"toon":t=new s.MeshToonMaterial(e);break;case"shadow":t=new s.ShadowMaterial(e);break;case"sss":t=new L(e);break;default:t=new s.MeshStandardMaterial(e)}ee.upEnvmapIntensity(t)}return K[t.name]?null:(ee.set(t,!1,i),t)},findValue:e=>"string"===e?$[e.charAt(0).toUpperCase()+e.slice(1)]:e,addToMat:e=>{if(ee.isRealism)for(let t in e)e[t].shadowSide=s.DoubleSide,e[t].onBeforeCompile=function(s){j(s,ee.realismOption),e[t].userData.isRealism=!0,e[t].userData.shader=s};K={...K,...e}},changeType:()=>{},directIntensity:e=>{},setEnvmapIntensity:e=>{},upEnvmapIntensity:e=>{},getList:()=>{let e={...K};const t=["line","debug","hide","svg"];let s=t.length;for(;s--;)delete e[t[s]];return e},get:e=>{if(!K[e])switch(e){case"body":ee.create({name:"body",color:Z.body,...Y});break;case"sleep":ee.create({name:"sleep",color:Z.sleep,...Y});break;case"solid":ee.create({name:"solid",color:Z.solid,...Y});break;case"base":ee.create({name:"base",color:Z.base,...Y});break;case"clay":ee.create({name:"clay",color:Z.clay,...Y});break;case"concrete":ee.create({name:"concrete",color:Z.concrete,metalness:0,roughness:.9});break;case"black":ee.create({name:"black",color:Z.black,metalness:0,roughness:.25});break;case"chrome":ee.create({name:"chrome",color:13421772,metalness:1,roughness:.075});break;case"silver":ee.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":ee.create({name:"gold",color:Z.gold,specularColor:Z.gold2,metalness:1,roughness:.02});break;case"copper":ee.create({name:"copper",color:Z.copper,metalness:1,roughness:.25,clearcoat:1,clearcoatRoughness:.2});break;case"carPaint":ee.create({name:"carPaint",color:Z.carPaint,metalness:0,anisotropy:new s.Vector2(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":ee.create({name:"carbon",map:new D,normalMap:new D(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":ee.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":ee.create({name:"skinny",color:14724201,...Y});break;case"glass":ee.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:s.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":ee.create({name:"glassX",color:15658734,transparent:!1,opacity:1,roughness:.03,metalness:0,side:s.DoubleSide,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.02,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0});break;case"plexi":ee.create({name:"plexi",blending:s.AdditiveBlending,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:s.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":ee.create({name:"plexi2",blending:s.AdditiveBlending,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:s.DoubleSide,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":ee.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":ee.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":ee.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":ee.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":ee.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":K.outline||(K.outline=te),K.outline;break;case"debug":ee.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":ee.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":ee.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":ee.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":ee.create({name:"button",color:16728139,...Y});break;case"line":ee.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":ee.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":ee.create({name:"hide",type:"basic",visible:!1});break;case"particle":ee.create({name:"particle",type:"basic",toneMapped:!1,color:65280});break;case"svg":ee.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:s.DoubleSide})}return K[e]},dispose:()=>{ee.isRealism=!1;for(let e in K)K[e].dispose(),delete K[e];let e=J.length;for(;e--;)J[e].dispose();J=[]},upShader:()=>{let e=ee.realismOption;for(let t in K){const s=K[t],i=s.userData.shader;for(let t in e)i&&void 0!==i.uniforms[t]&&(i.uniforms[t].value=e[t]),s[t]&&(s[t]=e[t])}}},te=new W;let se=class{constructor(e=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(e),this.force=!1}up(e){let t=this.time;return this.unlimited&&(this.force=!0),t.now=void 0!==e?e:this.now(),t.delta=t.now-t.then,this.force&&(t.delta=t.interval,this.force=!1),!!(t.delta>=t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.interval,this.elapsedTime+=this.delta,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e,60===e&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(e){return e>1e3?e/1e3+" sec":e+" ms"}},ie=class{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,s,i,a,r,o=this.fix,n=navigator.getGamepads();for(e=0;e<n.length;e++)if(r=n[e])if(s=r.axes.length,i=r.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<s;t++)a=o(r.axes[t],.08),0==this.ready&&0!==a&&(this.ready=1),this.values[e][t]=a;for(t=0;t<i;t++)a=o(r.buttons[t].value),0==this.ready&&0!==a&&(this.ready=1),this.values[e][s+t]=a}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,s=19;s--;)t=this.values[e][s],0==this.ready&&0!==t&&(this.ready=1),this.key[s]=t}reset(){this.ready=0}fix(e,t){let s=Number(e.toString().substring(0,5));return t&&s<t&&s>-t&&(s=0),s}};class ae{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.list=[],this.id=0}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let s=this.byName(e);return s?this.clear(s,t):-1}clear(e,t){let s=this.list.indexOf(e);return-1===s||t?this.list[s]=null:this.list.splice(s,1),this.dispose(e),s}dispose(e){null!==e&&this.Utils.remove(e)}add(e={}){}set(e={}){}step(e,t){}}let re=class extends ae{constructor(){super(),this.Utils=E,this.type="ray",this.iType="ray"}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.ray,s.update(e,i,B.reflow.ray[a]||null)}add(e={}){this.setName(e);let t=new oe(e);return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&"string"!=typeof e.parent&&(e.parent=e.parent.name),e.callback&&delete e.callback,B.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.setRay(e)}},oe=class extends s.Line{constructor(e={}){super(new s.BufferGeometry,ee.get("line")),this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=e.name,this.parentMesh=null,e.parent&&(this.parentMesh="string"==typeof e.parent?E.byName(e.parent):e.parent,this.data.parent=this.parentMesh),this.callback=e.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new s.Vector3,this.end=new s.Vector3(0,1,0),this.tmp=new s.Vector3,this.vnormal=new s.Vector3,this.vv1=new s.Vector3,this.vv2=new s.Vector3,this.fullDistance=0,this.setRay(e);this.geometry.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new s.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(e){e.begin&&this.begin.fromArray(e.begin),e.end&&this.end.fromArray(e.end),this.fullDistance=this.begin.distanceTo(this.end)}update(e,t=0,s=null){if(this.data.hit=0!==e[t],this.data.body=s||"",this.data.distance=e[t+1],this.data.hit)this.local[0]=e[t+2],this.local[1]=e[t+3],this.local[2]=e[t+4],this.tmp.fromArray(e,t+5),this.vnormal.fromArray(e,t+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(A.angleTo(this.vv1.toArray(),this.data.normal)*n);else if(this.parentMesh){const e=this.parentMesh.matrixWorld;this.tmp.copy(this.begin).applyMatrix4(e).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(e),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let e=this.vertices.array,t=this.colors.array,s=this.local,i=this.data.hit,a=i?this.c2:this.c1,r=i?this.c3:this.c1;t[3]=a[0],t[4]=a[1],t[5]=a[2],t[6]=r[0],t[7]=r[1],t[8]=r[2],e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}},ne=0;const le=new s.Vector3,he=new s.Quaternion,ce=new s.Matrix4,Ae=new s.Vector3,de=new s.Vector3,ue=new s.Vector3,pe=new s.Quaternion,me=new s.Vector3(1,0,0),ge=new s.Vector3(0,1,0),fe=new s.Vector3(0,0,1),be={type:"added"},ye={type:"removed"};class we extends s.EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:ne++}),this.uuid=s.MathUtils.generateUUID(),this.isRay=!0,this.matrix=new s.Matrix4,this.matrixWorld=new s.Matrix4,this.name="",this.type="Object3D",this.children=[],this.parent=null,this.position=new s.Vector3,this.quaternion=new s.Quaternion,this.tmpRotation=new s.Euler,this.scale=new s.Vector3(1,1,1),this.isKinematic=!1,this.matrixAutoUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.layers=new s.Layers,this.visible=!0,this.isVisible=!0,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.mass=0,this.density=0,this.inertia=new s.Vector3(1,1,1),this.shapetype="box",this.size=[1,1,1],this.velocity=new s.Vector3,this.angular=new s.Vector3,this.defMat=!1,this.actif=!1,this.auto=!1,this.sleep=!1,this.mesh=null,this.meshSize=1,this.linked=[],this.isOver=!1,this.overMaterial=null}clearOutLine(){this.overMaterial&&this.outline&&(this.remove(this.outline),this.outline=null)}addOutLine(){if(!this.overMaterial)return;if(!this.children[0].isMesh)return;this.outline=(new s.Mesh).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.overMaterial.uniforms.power&&(this.overMaterial.uniforms.power.value=.01/this.meshSize),this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline)}over(e){e&&!this.isOver&&(this.isOver=!0,this.addOutLine()),!e&&this.isOver&&(this.isOver=!1,this.clearOutLine())}select(e){}dispose(){this.clearOutLine(),this.traverse((function(e){e.isMesh&&e.unic&&e.geometry.dispose()})),this.children=[]}set receiveShadow(e){this.traverse((function(t){t.isMesh&&(t.receiveShadow=e)}))}get receiveShadow(){return!!this.children[0]&&this.children[0].receiveShadow}set castShadow(e){this.traverse((function(t){t.isMesh&&(t.castShadow=e)}))}get castShadow(){return!!this.children[0]&&this.children[0].castShadow}set material(e){this.traverse((function(t){t.isMesh&&"outline"!==t.name&&(t.material=e)}))}get material(){return this.children,this.children[0]?this.children[0].material:null}set rotation(e){this.tmpRotation=e,quaternion.setFromEuler(this.tmpRotation,!1)}get rotation(){return this.tmpRotation.setFromQuaternion(this.quaternion,void 0,!1)}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return he.setFromAxisAngle(e,t),this.quaternion.multiply(he),this}rotateOnWorldAxis(e,t){return he.setFromAxisAngle(e,t),this.quaternion.premultiply(he),this}rotateX(e){return this.rotateOnAxis(me,e)}rotateY(e){return this.rotateOnAxis(ge,e)}rotateZ(e){return this.rotateOnAxis(fe,e)}translateOnAxis(e,t){return le.copy(e).applyQuaternion(this.quaternion),this.position.add(le.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(me,e)}translateY(e){return this.translateOnAxis(ge,e)}translateZ(e){return this.translateOnAxis(fe,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(ce.copy(this.matrixWorld).invert())}lookAt(e,t,s){e.isVector3?Ae.copy(e):Ae.set(e,t,s);const i=this.parent;this.updateWorldMatrix(!0,!1),de.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?ce.lookAt(de,Ae,this.up):ce.lookAt(Ae,de,this.up),this.quaternion.setFromRotationMatrix(ce),i&&(ce.extractRotation(i.matrixWorld),he.setFromRotationMatrix(ce),this.quaternion.premultiply(he.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(be)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(ye)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){const e=this.children;let t=e.length;for(;t--;){const s=e[t];s.parent=null,s.dispatchEvent(ye)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),ce.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),ce.multiply(e.parent.matrixWorld)),e.applyMatrix4(ce),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;const s=this.children;let i=s.length;for(;i--;){const a=s[i].getObjectByProperty(e,t);if(void 0!==a)return a}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(de,e,ue),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(de,pe,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}setRaycast(e){if(void 0!==e&&(this.isRay=e),!this.isRay){let e=this.children.length;for(;e--;){let t=this.children[e].children.length;for(;t--;)this.children[e].children[t].raycast=()=>{};this.children[e].raycast=()=>{}}}}raycast(e,t){if(!this.isRay)return;const s=this.children;let i=s.length;for(;i--;)s[i].layers.test(e.layers)&&s[i].raycast(e,t)}traverse(e){e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;let s=t.length;for(;s--;)t[s].updateMatrixWorld(e)}updateWorldMatrix(e,t){const s=this.parent;if(!0===e&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;let t=e.length;for(;t--;)e[t].updateWorldMatrix(!1,!0)}}}class ve extends s.InstancedMesh{constructor(e,t,i=0){super(e,t,i),this.matrixAutoUpdate=!1,this.tmpMatrix=new s.Matrix4,this.tmpQuat=new s.Quaternion,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(e){this.overMaterial&&(this.outline=new s.Mesh(this.geometry,this.overMaterial),this.overMaterial.uniforms.power&&(this.overMaterial.uniforms.power.value=.01),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e.id),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=e.id)}over(e){e&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!e&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}getInfo(e){this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e);let t={x:0,y:0,z:0},s={x:0,y:0,z:0};return this.tmpMatrix.decompose(t,this.tmpQuat,s),{pos:[t.x,t.y,t.z],quat:this.tmpQuat.toArray(),scale:[s.x,s.y,s.z]}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new s.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3)),t.isColor&&(t=t.toArray());let i=3*e;this.instanceColor.array[i]=t[0],this.instanceColor.array[i+1]=t[1],this.instanceColor.array[i+2]=t[2]}add(e,t=[0,0,0],i=[0,0,0,1],a=[1,1,1],r=null,o=null){3===i.length&&(i=this.tmpQuat.setFromEuler({_x:i[0],_y:i[1],_z:i[2],_order:"XYZ"},!1).toArray()),r&&(r.isColor&&(r=r.toArray()),null===this.instanceColor&&(this.instanceColor=new s.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(t,i,a,r,o),this.tmpElement.push(e)}slice(e,t,s){let i=new Float32Array(s-t);for(let a=0;a<t+s;++a)i[a]=e[t+a];return i}remove(e){if(!this.count)return;this.tmpElement.splice(e,1);let t=[...this.instanceMatrix.array];t.splice(16*e,16),this.instanceMatrix=new s.InstancedBufferAttribute(new Float32Array(t),16),null!==this.instanceColor&&(t=[...this.instanceColor.array],t.splice(3*e,3),this.instanceColor=new s.InstancedBufferAttribute(new Float32Array(t),3)),null!==this.instanceUv&&(t=[...this.instanceUv.array],t.splice(2*e,2),this.instanceUv=new s.InstancedBufferAttribute(new Float32Array(t),2)),this.count--,this.reDistribute()}reDistribute(){let e=this.count;for(;e--;)this.tmpElement[e].id=e}getByName(e){return this.tmpElement[e].name}getBodyList(){let e=[],t=this.count;for(;t--;)e.push(this.tmpElement[t].name);return e}expand(e,t,i,a=[1,1,1],r){let o=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:t[0],_y:t[1],_z:t[2],_w:t[3]},{x:i[0],y:i[1],z:i[2]}),this.instanceMatrix=new s.InstancedBufferAttribute(new Float32Array([...o,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(o=this.instanceColor.array,this.instanceColor=new s.InstancedBufferAttribute(new Float32Array([...o,...a]),3)),this.count++}setTransformAt(e,t,s,i){this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:s[0],_y:s[1],_z:s[2],_w:s[3]},{x:i[0],y:i[1],z:i[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*e),this.needSphereUp=!0,this.outline&&this.currentOver===e&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(e){void 0!==e&&(this.isRay=e)}raycast(e,t){this.isRay&&super.raycast(e,t)}update(){this.needSphereUp&&this.computeBoundingSphere(),this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp=!1}}function Ce(e,t=!1){const i=null!==e[0].index,a=new Set(Object.keys(e[0].attributes)),r=new Set(Object.keys(e[0].morphAttributes)),o={},n={},l=e[0].morphTargetsRelative,h=new s.BufferGeometry;let c=0;for(let s=0;s<e.length;++s){const A=e[s];let d=0;if(i!==(null!==A.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in A.attributes){if(!a.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[e]&&(o[e]=[]),o[e].push(A.attributes[e]),d++}if(d!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+". Make sure all geometries have the same number of attributes."),null;if(l!==A.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in A.morphAttributes){if(!r.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===n[e]&&(n[e]=[]),n[e].push(A.morphAttributes[e])}if(t){let e;if(i)e=A.index.count;else{if(void 0===A.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+s+". The geometry must have either an index or a position attribute"),null;e=A.attributes.position.count}h.addGroup(c,e,s),c+=e}}if(i){let t=0;const s=[];for(let i=0;i<e.length;++i){const a=e[i].index;for(let e=0;e<a.count;++e)s.push(a.getX(e)+t);t+=e[i].attributes.position.count}h.setIndex(s)}for(const e in o){const t=Ie(o[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;h.setAttribute(e,t)}for(const e in n){const t=n[e][0].length;if(0===t)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[e]=[];for(let s=0;s<t;++s){const t=[];for(let i=0;i<n[e].length;++i)t.push(n[e][i][s]);const i=Ie(t);if(!i)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;h.morphAttributes[e].push(i)}}return h}function Ie(e){let t,i,a,r=-1,o=0;for(let s=0;s<e.length;++s){const n=e[s];if(void 0===t&&(t=n.array.constructor),t!==n.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===i&&(i=n.itemSize),i!==n.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===a&&(a=n.normalized),a!==n.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=n.gpuType),r!==n.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;o+=n.count*i}const n=new t(o),l=new s.BufferAttribute(n,i,a);let h=0;for(let t=0;t<e.length;++t){const s=e[t];if(s.isInterleavedBufferAttribute){const e=h/i;for(let t=0,a=s.count;t<a;t++)for(let a=0;a<i;a++){const i=s.getComponent(t,a);l.setComponent(t+e,a,i)}}else n.set(s.array,h);h+=s.count*i}return void 0!==r&&(l.gpuType=r),l}function xe(e,t=1e-4){t=Math.max(t,Number.EPSILON);const i={},a=e.getIndex(),r=e.getAttribute("position"),o=a?a.count:r.count;let n=0;const l=Object.keys(e.attributes),h={},c={},A=[],d=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"];for(let t=0,i=l.length;t<i;t++){const i=l[t],a=e.attributes[i];h[i]=new s.BufferAttribute(new a.array.constructor(a.count*a.itemSize),a.itemSize,a.normalized);const r=e.morphAttributes[i];r&&(c[i]=new s.BufferAttribute(new r.array.constructor(r.count*r.itemSize),r.itemSize,r.normalized))}const p=.5*t,m=Math.log10(1/t),g=Math.pow(10,m),f=p*g;for(let t=0;t<o;t++){const s=a?a.getX(t):t;let r="";for(let t=0,i=l.length;t<i;t++){const i=l[t],a=e.getAttribute(i),o=a.itemSize;for(let e=0;e<o;e++)r+=~~(a[d[e]](s)*g+f)+","}if(r in i)A.push(i[r]);else{for(let t=0,i=l.length;t<i;t++){const i=l[t],a=e.getAttribute(i),r=e.morphAttributes[i],o=a.itemSize,A=h[i],p=c[i];for(let e=0;e<o;e++){const t=d[e],i=u[e];if(A[i](n,a[t](s)),r)for(let e=0,a=r.length;e<a;e++)p[e][i](n,r[e][t](s))}}i[r]=n,A.push(n),n++}}const b=e.clone();for(const t in e.attributes){const e=h[t];if(b.setAttribute(t,new s.BufferAttribute(e.array.slice(0,n*e.itemSize),e.itemSize,e.normalized)),t in c)for(let e=0;e<c[t].length;e++){const i=c[t][e];b.morphAttributes[t][e]=new s.BufferAttribute(i.array.slice(0,n*i.itemSize),i.itemSize,i.normalized)}}return b.setIndex(A),b}function Be(e,t){if(t===s.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===s.TriangleFanDrawMode||t===s.TriangleStripDrawMode){let i=e.getIndex();if(null===i){const t=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const a=i.count-2,r=[];if(t===s.TriangleFanDrawMode)for(let e=1;e<=a;e++)r.push(i.getX(0)),r.push(i.getX(e)),r.push(i.getX(e+1));else for(let e=0;e<a;e++)e%2==0?(r.push(i.getX(e)),r.push(i.getX(e+1)),r.push(i.getX(e+2))):(r.push(i.getX(e+2)),r.push(i.getX(e+1)),r.push(i.getX(e)));r.length/3!==a&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(r),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class Ee extends s.BufferGeometry{constructor(e=1,t=10,i=10,a=10,r=1){super(),this.type="SphereBox",this.name="SphereBox_"+e+"_"+t+"_"+i+"_"+a+"_"+r,e=e||1,t=Math.floor(t),i=Math.floor(i),a=Math.floor(a);let o,n=new s.BoxGeometry(1,1,1,t,i,a),l=new s.Vector3,h=new s.Vector3,c=n.attributes.position.array,A=n.attributes.normal.array;for(let t=0,s=n.attributes.position.count;t<s;t++)o=3*t,l.set(c[o],c[o+1],c[o+2]),h.copy(l).normalize(),l.lerp(h,r).multiplyScalar(e),c[o]=l.x,c[o+1]=l.y,c[o+2]=l.z,l.normalize(),A[o]=l.x,A[o+1]=l.y,A[o+2]=l.z;this.copy(n)}}class Me extends s.BufferGeometry{constructor(e=1,t=1,i=12,a=1){super(),this.type="CapsuleGeometry";let r=Math.PI,o=e/(2*e+t),n=1-2*o;i=Math.floor(i),a=Math.floor(a);let l=Math.floor(.5*i),h=2*Math.PI,c=.5*Math.PI,A=new s.CylinderGeometry(e,e,t,i,a,!0);Te(A,0,o,1,n);let d=new s.SphereGeometry(e,i,l,0,h,0,c);Te(d,0,1-o,1,o);let u=new s.SphereGeometry(e,i,l,0,h,c,c);Te(u,0,0,1,o);let p=(new s.Matrix4).makeRotationY(.5*-r),m=(new s.Matrix4).makeTranslation(0,.5*t,0),g=(new s.Matrix4).makeTranslation(0,.5*-t,0);A.applyMatrix4(p),d.applyMatrix4(m),u.applyMatrix4(g);let f=xe(Ce([A,d,u]));this.copy(f)}}class Se extends s.BufferGeometry{constructor(e=1,t=.4,i=8,a=6,r=2*Math.PI,o=0,n=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:a,arc:r},i=Math.floor(i),a=Math.floor(a);const l=[],h=[],c=[],A=[],d=new s.Vector3,u=new s.Vector3,p=new s.Vector3;let m,g;for(m=0;m<=i;m++)for(g=0;g<=a;g++){const s=g/a*r,l=m/i*n+o;u.x=(e+t*Math.cos(l))*Math.cos(s),u.y=(e+t*Math.cos(l))*Math.sin(s),u.z=t*Math.sin(l),h.push(u.x,u.y,u.z),d.x=e*Math.cos(s),d.y=e*Math.sin(s),p.subVectors(u,d).normalize(),c.push(p.x,p.y,p.z),A.push(g/a),A.push(m/i)}for(m=1;m<=i;m++)for(g=1;g<=a;g++){const e=(a+1)*m+g-1,t=(a+1)*(m-1)+g-1,s=(a+1)*(m-1)+g,i=(a+1)*m+g;l.push(e,t,i),l.push(t,s,i)}this.setIndex(l),this.setAttribute("position",new s.Float32BufferAttribute(h,3)),this.setAttribute("normal",new s.Float32BufferAttribute(c,3)),this.setAttribute("uv",new s.Float32BufferAttribute(A,2))}}class ke extends s.BufferGeometry{constructor(e=1,t=1,i=1,a=.01,r=12,o=1,n=2){super(),this.type="ChamferCyl",r=Math.floor(r),o=Math.floor(o),n=Math.floor(n);let l=new s.Matrix4,h=new s.Matrix4,c=Math.PI,A=.5*c,d=2*c,u=a/i,p=1-2*u,m=new s.CylinderGeometry(e,t,i-2*a,r,o,!0,0);l.makeRotationY(A),m.applyMatrix4(l),Te(m,0,u,1,p);let g=new Se(e-a,a,n,r,d,0,A),f=new s.CircleGeometry(e-a,r);h.makeTranslation(0,0,a),f.applyMatrix4(h),Te(g,0,1-u,1,u);let b=Ce([g,f]);l.makeTranslation(0,0,.5*i-a),h.makeRotationX(-A),b.applyMatrix4(h.multiply(l)),g=new Se(t-a,a,n,r,d,0,A),f=new s.CircleGeometry(t-a,r),h.makeTranslation(0,0,a),f.applyMatrix4(h),Te(g,0,1-u,1,u,!0);let y=Ce([g,f]);l.makeTranslation(0,0,.5*i-a),h.makeRotationX(A),y.applyMatrix4(h.multiply(l));let w=xe(Ce([b,m,y]));this.copy(w)}}class Qe extends s.BufferGeometry{constructor(e=1,t=1,i=1,a=.01,r=1,o=1,n=1,l=2){super(),this.type="ChamferBox",r=Math.floor(r),o=Math.floor(o),n=Math.floor(n),l=Math.floor(l);let h=Math.PI,c=.5*h,A=2*a,d=.5*e,u=.5*t,p=.5*i,m=new s.Matrix4,g=new s.Matrix4,f=new s.Matrix4,b=a/e,y=1-2*b,w=a/t,v=1-2*b,C=a/i,I=1-2*C,x=new s.PlaneGeometry(e-A,t-A,r,o),B=new s.CylinderGeometry(a,a,e-A,l,r,!0,0,c),E=new s.CylinderGeometry(a,a,t-A,l,o,!0,0,c),M=new Re(a,l,l,0,c,0,-c),S=new Re(a,l,l,0,c,0,-c);Te(x,-b,w,y,v),Te(B,0,b,w,y),g.makeTranslation(0,u-a,0),m.makeRotationX(c),M.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-u+a,0),m.makeRotationX(c),f.makeRotationY(-c),S.applyMatrix4(g.multiply(m).multiply(f));let k=Ce([E,M,S]),Q=k.clone();g.makeTranslation(d-a,0,-a),k.applyMatrix4(g),g.makeTranslation(-d+a,0,-a),m.makeRotationZ(h),Q.applyMatrix4(g.multiply(m));let R=B.clone();m.makeRotationZ(c),g.makeTranslation(0,u-a,-a),B.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-u+a,-a),m.makeRotationZ(-c),R.applyMatrix4(g.multiply(m));let T=Ce([B,R,x,k,Q]),F=T.clone();g.makeTranslation(0,0,p),T.applyMatrix4(g),g.makeTranslation(0,0,-p),m.makeRotationY(h),F.applyMatrix4(g.multiply(m)),x=new s.PlaneGeometry(i-A,t-A,n,o),B=new s.CylinderGeometry(a,a,i-A,l,n,!0,0,c),R=B.clone(),Te(x,-C,w,I,v),g.makeTranslation(0,-(u-a),-a,0),m.makeRotationZ(-c),B.applyMatrix4(g.multiply(m)),g.makeTranslation(0,u-a,-a,0),m.makeRotationZ(c),R.applyMatrix4(g.multiply(m));let D=Ce([B,R,x]),L=D.clone();g.makeTranslation(-d,0,0),m.makeRotationY(-c),D.applyMatrix4(g.multiply(m)),g.makeTranslation(d,0,0),m.makeRotationY(c),L.applyMatrix4(g.multiply(m)),x=new s.PlaneGeometry(e-A,i-A,r,n),Te(x,-b,C,y,I);let P=x.clone();g.makeTranslation(0,u,0),m.makeRotationX(-c),x.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-u,0),m.makeRotationX(c),P.applyMatrix4(g.multiply(m));let _=xe(Ce([T,F,D,L,x,P]));Fe(_,"box"),this.copy(_)}}class Re extends s.BufferGeometry{constructor(e=1,t=8,i=6,a=0,r=2*Math.PI,o=0,n=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:a,phiLength:r,thetaStart:o,thetaLength:n},t=Math.floor(t),i=Math.floor(i);const l=Math.min(o+n,Math.PI);let h=0;const c=[],A=new s.Vector3,d=new s.Vector3,u=[],p=[],m=[],g=[];for(let s=0;s<=i;s++){const u=[],f=s/i;let b=0;0==s&&0==o?b=.5/t:s==i&&l==Math.PI&&(b=-.5/t);for(let s=0;s<=t;s++){const i=s/t;A.x=-e*Math.cos(a+i*r)*Math.sin(o+f*n),A.y=e*Math.cos(o+f*n),A.z=e*Math.sin(a+i*r)*Math.sin(o+f*n),p.push(A.x,A.y,A.z),d.copy(A).normalize(),m.push(d.x,d.y,d.z),g.push(i+b,1-f),u.push(h++)}c.push(u)}for(let e=0;e<i;e++)for(let s=0;s<t;s++){const t=c[e][s+1],a=c[e][s],r=c[e+1][s],n=c[e+1][s+1];(0!==e||o>0)&&u.push(t,a,n),(e!==i-1||l<Math.PI)&&u.push(a,r,n)}this.setIndex(u),this.setAttribute("position",new s.Float32BufferAttribute(p,3)),this.setAttribute("normal",new s.Float32BufferAttribute(m,3)),this.setAttribute("uv",new s.Float32BufferAttribute(g,2))}}function Te(e,t=0,s=0,i=1,a=1,r){let o=e.attributes.uv,n=o.array,l=o.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*i-t,n[h+1]=n[h+1]*a+s,r&&(n[h]=1-n[h],n[h+1]=1-n[h+1])}function Fe(e,t="sphere",i,a=[0,0,0],r=[0,0,0,1],o){if(void 0===o&&(o=new s.Matrix4),o.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){e.boundingBox||e.computeBoundingBox();let t=e.boundingBox;i=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z)}let n=new s.Box3(new s.Vector3(-i/2,-i/2,-i/2),new s.Vector3(i/2,i/2,i/2)),l=[];l.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.setAttribute("uv",new s.Float32BufferAttribute(l,2));let h,c,A,d,u,p=function(e,t,i){e.applyMatrix4(o),t.applyMatrix4(o),i.applyMatrix4(o);let a=1/(2*Math.PI),r=1/Math.PI;return e.normalize(),t.normalize(),i.normalize(),{uv0:new s.Vector2(.5-Math.atan(e.z,-e.x)*a,.5-Math.asin(e.y)*r),uv1:new s.Vector2(.5-Math.atan(t.z,-t.x)*a,.5-Math.asin(t.y)*r),uv2:new s.Vector2(.5-Math.atan(i.z,-i.x)*a,.5-Math.asin(i.y)*r)}},m=function(e,t,a){e.applyMatrix4(o),t.applyMatrix4(o),a.applyMatrix4(o);let r=new s.Vector3;r.crossVectors(t.clone().sub(e),t.clone().sub(a)).normalize(),r.x<0||r.y<0||r.z,r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);let l=new s.Vector2,h=new s.Vector2,c=new s.Vector2,A=1/i;return r.y>r.x&&r.y>r.z?(l.set(e.x-n.min.x,n.max.z-e.z).multiplyScalar(A),h.set(t.x-n.min.x,n.max.z-t.z).multiplyScalar(A),c.set(a.x-n.min.x,n.max.z-a.z).multiplyScalar(A)):r.x>r.y&&r.x>r.z?(l.set(e.z-n.min.z,e.y-n.min.y).multiplyScalar(A),h.set(t.z-n.min.z,t.y-n.min.y).multiplyScalar(A),c.set(a.z-n.min.z,a.y-n.min.y).multiplyScalar(A)):r.z>r.y&&r.z>r.x&&(l.set(e.x-n.min.x,e.y-n.min.y).multiplyScalar(A),h.set(t.x-n.min.x,t.y-n.min.y).multiplyScalar(A),c.set(a.x-n.min.x,a.y-n.min.y).multiplyScalar(A)),{uv0:l,uv1:h,uv2:c}},g=new s.Vector3,f=new s.Vector3,b=new s.Vector3;new s.Vector3,new s.Vector3,new s.Vector3;const y=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(h=0;h<e.index.count;h+=3)c=e.index.getX(h+0),A=e.index.getX(h+1),d=e.index.getX(h+2),g.fromBufferAttribute(y,c),f.fromBufferAttribute(y,A),b.fromBufferAttribute(y,d),u="sphere"===t?p(g,f,b):m(g,f,b),l[2*c]=u.uv0.x,l[2*c+1]=u.uv0.y,l[2*A]=u.uv1.x,l[2*A+1]=u.uv1.y,l[2*d]=u.uv2.x,l[2*d+1]=u.uv2.y;else for(h=0;h<y.count;h+=3){g.fromBufferAttribute(y,h+0),f.fromBufferAttribute(y,h+1),b.fromBufferAttribute(y,h+2),u="sphere"===t?p(g,f,b):m(g,f,b);let e=h,s=h+1,i=h+2;l[2*e]=u.uv0.x,l[2*e+1]=u.uv0.y,l[2*s]=u.uv1.x,l[2*s+1]=u.uv1.y,l[2*i]=u.uv2.x,l[2*i+1]=u.uv2.y}e.attributes.uv.array=new Float32Array(l),e.attributes.uv.needsUpdate=!0}const De=new s.Vector3,Le=new s.Line3,Pe=new s.Plane,_e=new s.Vector3,Ge=new s.Triangle;class ze{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new Ve,this.unassigned=new Ve,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.vertices.push(new Ne(e[t]));this.compute()}return this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const i=e.geometry;if(void 0!==i){const a=i.attributes.position;if(void 0!==a)for(let i=0,r=a.count;i<r;i++){const r=new s.Vector3;r.fromBufferAttribute(a,i).applyMatrix4(e.matrixWorld),t.push(r)}}})),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let s=0,i=t.length;s<i;s++){if(t[s].distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){const s=this.faces;let i=-1/0,a=1/0;for(let t=0,r=s.length;t<r;t++){const r=s[t],o=r.distanceToPoint(e.origin),n=r.normal.dot(e.direction);if(o>0&&n>=0)return null;const l=0!==n?-o/n:0;if(!(l<=0)&&(n>0?a=Math.min(l,a):i=Math.max(l,i),i>a))return null}return i!==-1/0?e.at(i,t):e.at(a,t),t}intersectsRay(e){return null!==this.intersectRay(e,De)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let s=e.outside;for(;null!==s.next&&s.next.face===e;)s=s.next;return this.assigned.removeSubList(t,s),t.prev=s.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const s=this.removeAllVerticesFromFace(e);if(void 0!==s)if(void 0===t)this.unassigned.appendChain(s);else{let e=s;do{const s=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=s}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const s=t.next;let i=this.tolerance,a=null;for(let s=0;s<e.length;s++){const r=e[s];if(0===r.mark){const e=r.distanceToPoint(t.point);if(e>i&&(i=e,a=r),i>1e3*this.tolerance)break}}null!==a&&this.addVertexToFace(t,a),t=s}while(null!==t)}return this}computeExtremes(){const e=new s.Vector3,t=new s.Vector3,i=[],a=[];for(let e=0;e<3;e++)i[e]=a[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let s=0,r=this.vertices.length;s<r;s++){const r=this.vertices[s],o=r.point;for(let t=0;t<3;t++)o.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,o.getComponent(t)),i[t]=r);for(let e=0;e<3;e++)o.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,o.getComponent(e)),a[e]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:i,max:a}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),s=t.min,i=t.max;let a=0,r=0;for(let e=0;e<3;e++){const t=i[e].point.getComponent(e)-s[e].point.getComponent(e);t>a&&(a=t,r=e)}const o=s[r],n=i[r];let l,h;a=0,Le.set(o.point,n.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==o&&s!==n){Le.closestPointToPoint(s.point,!0,_e);const e=_e.distanceToSquared(s.point);e>a&&(a=e,l=s)}}a=-1,Pe.setFromCoplanarPoints(o.point,n.point,l.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==o&&s!==n&&s!==l){const e=Math.abs(Pe.distanceToPoint(s.point));e>a&&(a=e,h=s)}}const c=[];if(Pe.distanceToPoint(h.point)<0){c.push(Ue.create(o,n,l),Ue.create(h,n,o),Ue.create(h,l,n),Ue.create(h,o,l));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge(t)),c[e+1].getEdge(1).setTwin(c[t+1].getEdge(0))}}else{c.push(Ue.create(o,l,n),Ue.create(h,o,n),Ue.create(h,n,l),Ue.create(h,l,o));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge((3-e)%3)),c[e+1].getEdge(0).setTwin(c[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(c[e]);for(let t=0,s=e.length;t<s;t++){const s=e[t];if(s!==o&&s!==n&&s!==l&&s!==h){a=this.tolerance;let e=null;for(let t=0;t<4;t++){const i=this.faces[t].distanceToPoint(s.point);i>a&&(a=i,e=this.faces[t])}null!==e&&this.addVertexToFace(s,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const s=this.faces[t];0===s.mark&&e.push(s)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const s=this.assigned.first().face;let i=s.outside;do{const a=s.distanceToPoint(i.point);a>t&&(t=a,e=i),i=i.next}while(null!==i&&i.face===s);return e}}computeHorizon(e,t,s,i){let a;this.deleteFaceVertices(s),s.mark=1,a=null===t?t=s.getEdge(0):t.next;do{const t=a.twin,s=t.face;0===s.mark&&(s.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,s,i):i.push(a)),a=a.next}while(a!==t);return this}addAdjoiningFace(e,t){const s=Ue.create(e,t.tail(),t.head());return this.faces.push(s),s.getEdge(-1).setTwin(t.twin),s.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let s=null,i=null;for(let a=0;a<t.length;a++){const r=t[a],o=this.addAdjoiningFace(e,r);null===s?s=o:o.next.setTwin(i),this.newFaces.push(o.face),i=o}return s.next.setTwin(i),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class Ue{constructor(){this.normal=new s.Vector3,this.midpoint=new s.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,s){const i=new Ue,a=new Oe(e,i),r=new Oe(t,i),o=new Oe(s,i);return a.next=o.prev=r,r.next=a.prev=o,o.next=r.prev=a,i.edge=a,i.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),s=this.edge.next.head();return Ge.set(e.point,t.point,s.point),Ge.getNormal(this.normal),Ge.getMidpoint(this.midpoint),this.area=Ge.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class Oe{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class Ne{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class Ve{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class qe extends s.BufferGeometry{constructor(e=[]){super();const t=[],i=[],a=(new ze).setFromPoints(e).faces;for(let e=0;e<a.length;e++){const s=a[e];let r=s.edge;do{const e=r.head().point;t.push(e.x,e.y,e.z),i.push(s.normal.x,s.normal.y,s.normal.z),r=r.next}while(r!==s.edge)}this.setAttribute("position",new s.Float32BufferAttribute(t,3)),this.setAttribute("normal",new s.Float32BufferAttribute(i,3))}}class He extends s.Object3D{constructor(e,t,i,a,r=[0,1,0],o=[0,.5,0],n=!1){if(super(),!e)return;if(!t)return;const l=new s.BufferGeometry;let h=.5*t-e,c=12,A=.2*e,d=[];const u=[e,h,0,e,-h,0,-e,h,0,-e,-h,0,0,h,e-A,0,h,e+A];d.push(...r,...o,...r,...o,...o,...o),n&&(u.push(0,h,e,0,-h,e,0,h,-e,0,-h,-e),d.push(...r,...o,...r,...o));for(let t=0,s=1;t<c;t++,s++){const i=t/c*Math.PI*2,a=s/c*Math.PI*2;u.push(e*Math.cos(i),h,e*Math.sin(i),e*Math.cos(a),h,e*Math.sin(a),e*Math.cos(i),-h,e*Math.sin(i),e*Math.cos(a),-h,e*Math.sin(a)),d.push(...r,...r,...o,...o)}for(let t=0,s=1;t<c;t++,s++){const i=t/c*Math.PI*2,a=s/c*Math.PI*2;let l=s<=6?1:-1;u.push(e*Math.cos(i),h*l+e*Math.sin(i),0,e*Math.cos(a),h*l+e*Math.sin(a),0),1===l?d.push(...r,...r):d.push(...o,...o),n&&(u.push(0,h*l+e*Math.sin(i),e*Math.cos(i),0,h*l+e*Math.sin(a),e*Math.cos(a)),1===l?d.push(...r,...r):d.push(...o,...o))}if(l.setAttribute("position",new s.Float32BufferAttribute(u,3)),l.setAttribute("color",new s.Float32BufferAttribute(d,3)),l.computeBoundingSphere(),this.colors=l.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=l,this.cone=new s.LineSegments(l,a),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!i)return;const p=new s.BufferGeometry,m=[.5*A,-h,e-A,.5*A,-h,e+A,.5*-A,-h,e-A,.5*-A,-h,e+A,.5*A,-h,e-A,.5*-A,-h,e-A,.5*-A,-h,e+A,-A,-h,e+A,.5*A,-h,e+A,A,-h,e+A,-A,-h,e+A,0,-h,e+2*A,A,-h,e+A,0,-h,e+2*A];d=[];let g=m.length/3;for(;g--;)d.push(1,0,0);p.setAttribute("position",new s.Float32BufferAttribute(m,3)),p.setAttribute("color",new s.Float32BufferAttribute(d,3)),this.direction=new s.LineSegments(p,a),this.direction.raycast=function(){return!1},this.add(this.direction)}over(e){e?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(e){let t=this.colors.length;for(;t--;)this.colors[t]=e?1:this.colorsbase[t];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(e){this.direction&&(this.direction.rotation.y=e)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}let je=class extends ae{constructor(){super(),this.Utils=E,this.type="body",this.num=v[this.type],this.full=!1,this.extraConvex=!1,this.needMatrix="RAPIER"===B.engine||"HAVOK"===B.engine}setFull(e){this.num=v[e?"bodyFull":"body"],this.full=e}step(){const e=B.Ar,t=B.ArPos[this.type],s=this.list;let i,a,r,o=s.length;for(;o--;)if(i=s[o],null!==i){if(a=t+o*this.num,!i.actif){if(0===A.nullArray(e,a,this.num))continue;i.actif=!0}if(i.sleep=!(e[a]>0),i.defMat&&(i.isInstance?i.instance.setColorAt(i.id,i.sleep?Z.sleep:Z.body):(i.sleep||"sleep"!==i.material.name||(i.material=ee.get("body")),i.sleep&&"body"===i.material.name&&(i.material=ee.get("sleep")))),!i.sleep||i.isKinematic)if(i.isInstance){if(i.speedMat){let t=.01*e[a];i.instance.setColorAt(i.id,[t,t,t])}i.instance.setTransformAt(i.id,[e[a+1],e[a+2],e[a+3]],[e[a+4],e[a+5],e[a+6],e[a+7]],i.noScale?[1,1,1]:i.size),i.position={x:e[a+1],y:e[a+2],z:e[a+3]},i.quaternion={_x:e[a+4],_y:e[a+5],_z:e[a+6],_w:e[a+7]},this.needMatrix&&i.matrixWorld.compose(i.position,i.quaternion,{x:1,y:1,z:1}),this.full?(i.velocity={x:e[a+8],y:e[a+9],z:e[a+10]},i.angular={x:e[a+11],y:e[a+12],z:e[a+13]}):i.getVelocity&&(r=B.reflow.velocity[i.name],r&&(i.velocity={x:r[0],y:r[1],z:r[2]},i.angular={x:r[3],y:r[4],z:r[5]}))}else i.position.fromArray(e,a+1),i.quaternion.fromArray(e,a+4),this.full?(i.velocity.fromArray(e,a+8),i.angular.fromArray(e,a+11)):i.getVelocity&&(r=B.reflow.velocity[i.name],r&&(i.velocity={x:r[0],y:r[1],z:r[2]},i.angular={x:r[3],y:r[4],z:r[5]})),i.auto||i.updateMatrix()}}geometry(e={},t=null,i=null){let a,r,o,n=e.size,l="",c=e.type,d=!1,u=!1,p=e.seg||16;const m="OIMO"===B.engine||"JOLT"===B.engine||"AMMO"===B.engine||"CANNON"===B.engine;if(e.instance&&"compound"===c&&(c=e.shapes[0].type,n=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==c&&"convex"!==c||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&(e.breakable||("box"===c&&(c="ChamferBox"),"cylinder"===c&&(c="ChamferCyl"))),e.geometry&&("convex"===c?e.shape=e.geometry:c="direct"),"PHYSX"===B.engine&&"cylinder"===e.type){let t=new s.CylinderGeometry(e.size[0],e.size[0],e.size[1],p,1);e.isWheel&&t.rotateZ(-h),e.v=A.getVertex(t),e.type="convex"}if(("PHYSX"===B.engine||"HAVOK"===B.engine||"JOLT"===B.engine)&&"cone"===e.type){let t=new s.CylinderGeometry(0,e.size[0],e.size[1],p,1);e.v=A.getVertex(t),e.type="convex"}switch("stair"===e.type&&(e.type="box",c="box"),c){case"direct":a=e.geometry.clone(),e.size&&a.scale(e.size[0],e.size[1],e.size[2]),u=!0,d=!0;break;case"convex":if(e.v){if(e.nogeo)a=new s.BufferGeometry;else{let t=[];for(r=Math.floor(e.v.length/3);r--;)o=3*r,t.push(new s.Vector3(e.v[o],e.v[o+1],e.v[o+2]));a=new qe(t)}u=!0,d=!0}if(e.shape){a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.shapeScale&&a.scale(e.shapeScale[0],e.shapeScale[1],e.shapeScale[2]);let t=m?A.toNonIndexed(a):null;e.v=A.getVertex(t||a,m),e.index=A.getIndex(t||a,m),B.engine,u=!0,d=!0}a.boundingBox||a.computeBoundingBox();let t=a.boundingBox;e.boxSize=[-t.min.x+t.max.x,-t.min.y+t.max.y,-t.min.z+t.max.z];break;case"mesh":a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.v=A.getVertex(a,m),e.index=A.getIndex(a,m),u=!0,d=!0;break;case"customSphere":l="customSphere_"+n[0],a=T(l),a?l="":(a=new s.SphereGeometry(n[0],e.seg1||32,e.seg2||16),a.name=l),d=!0,e.type="sphere";break;case"highSphere":l="highSphere_"+n[0],a=T(l),a?l="":(a=new Ee(n[0]),a.name=l),d=!0,e.type="sphere";break;case"capsule":l="capsule_"+n[0]+"_"+n[1]+"_"+p,a=T(l),a?l="":(a=new Me(n[0],n[1],p),a.name=l),d=!0;break;case"ChamferBox":l="ChamferBox_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+e.radius,a=T(l),a?l="":(a=new Qe(n[0],n[1],n[2],e.radius),a.name=l),d=!0;break;case"ChamferCyl":l="ChamferCyl_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+e.radius+"_"+p,a=T(l),a?l="":(a=new ke(n[0],n[0],n[1],e.radius,p),a.name=l),d=!0;break;default:e.breakable?(a=T(c).clone(),a.scale(n[0],n[1],n[2]),u=!0,d=!0):a=T(c)}if(e.translate&&a.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,(void 0===a.attributes.uv||e.autoUV)&&Fe(a,"box",5,e.pos,e.quat),""!==l&&R(a),e.isWheel&&(a=a.clone(),a.rotateZ(-h),u=!0),u&&Q(a),null===t&&null===i)return a.noScale=d,a;e.meshRemplace&&e.debug&&(i=ee.get("debug"));let g=new s.Mesh(a,i);if(e.button&&(g.isButton=!0),e.helper){let t=e.hcolor||[.3,.1,0],s=e.hcolor2||[.8,.2,0],i=new He(n[0],n[1]+2*n[0],!1,ee.get("liner"),t,s,!0);g.add(i),g.userData.helper=i}e.localRot&&(e.localQuat=A.quatFromEuler(e.localRot)),e.localPos&&g.position.fromArray(e.localPos),e.localQuat&&g.quaternion.fromArray(e.localQuat),d||g.scale.fromArray(e.size),void 0!==e.ray&&(e.ray||(g.raycast=()=>{})),e.meshRemplace&&!e.debug||(t.add(g),g.userData.helper&&(t.over=e=>{g.userData.helper.over(e)}))}add(e={}){e.worldScale&&delete(e=this.scaler(e,e.worldScale)).worldScale;let t,i,a,r=0;if(e.instance||(a=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),"stair"===e.type){let t=new s.Vector3(0,0,e.size[2]),i=new s.Vector3(0,.5*e.size[1],.5*e.size[2]),a=t.angleTo(i),r=t.distanceTo(i);e.rot=[a*n,0,0],e.size[1]*=e.div||.2,e.size[2]=2*r;let o=new s.Vector3(0,.5*-e.size[1],0);o.applyAxisAngle({x:1,y:0,z:0},a),e.pos[1]+=o.y,e.pos[2]+=o.z}if(e.massCenter&&!d.indexOf(B.engine))if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.pos?i.pos=A.addArray(i.pos,e.massCenter):i.pos=e.massCenter;void 0!==e.collision&&!1===e.collision&&("PHYSX"===B.engine&&(e.flags=0),"OIMO"===B.engine&&(e.mask=0)),e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=A.quatFromEuler(e.rot)),void 0!==e.meshRot&&(e.meshQuat=A.quatFromEuler(e.meshRot)),e.size=A.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=A.autoSize(e.meshScale));let o,l=!1;!1===e.visible&&(e.material="hide"),void 0!==e.material?o=e.material.constructor===String?ee.get(e.material):e.material:(l=!0,o=ee.get(this.type),e.instance&&(o=ee.get("base"))),e.unicMat&&(o=o.clone(),ee.addToTmp(o));let h=e.instance?{}:new we;if(e.mesh&&!e.instance){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();if(t.position.fromArray(e.meshPos||[0,0,0]),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),!l&&(t.material=o,t.children&&!e.nofullmat))for(let e in t.children)t.children[e].material=o;B.tmpMesh.push(t),e.meshRemplace=!0,h.add(t)}switch(e.type){case"null":break;case"compound":for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.type=void 0===i.type?"box":i.type,i.size=A.autoSize(i.size,i.type),i.pos&&(i.localPos=i.pos),void 0!==i.rot&&(i.quat=A.quatFromEuler(i.rot)),i.quat&&(i.localQuat=i.quat),i.debug=e.debug,i.meshRemplace=e.meshRemplace||!1,e.instance?"convex"===i.type&&(i.v=A.getVertex(i.shape,!1)):this.geometry(i,h,o),r+=A.getVolume(i.type,i.size,i.v);break;default:e.instance?"convex"===e.type&&(e.v=A.getVertex(e.shape,!1)):this.geometry(e,h,o),r=A.getVolume(e.type,e.size,e.v)}if(h.type=this.type,h.size=e.size,h.shapetype=e.type,h.isKinematic=e.kinematic||!1,h.link=0,h.meshSize=e.meshSize?e.meshSize:1,e.button&&(h.isButton=!0),h.isRay=!0,void 0!==e.ray&&h.setRaycast(e.ray),e.instance||h.setRaycast(),h.defMat=!1,h.material&&l&&(h.defMat="body"===h.material.name),e.instance){h.isInstance=!0,h.instance=this.getInstance(e,o),h.instance.isRay=h.isRay,h.over=h.instance.over,h.isOver=!1,h.speedMat=e.speedMat||!1,h.defMat="base"===h.instance.material.name,h.id=h.instance.count,h.refName=h.instance.name+h.id,h.name=e.name?e.name:h.instance.name+h.id,e.name=h.name,h.noScale=h.instance.noScale,e.sizeByInstance&&(h.noScale=!1);let t=e.color;h.defMat&&(t=e.sleep?Z.sleep:Z.body),h.instance.add(h,e.pos,e.quat,h.noScale?[1,1,1]:h.size,t),h.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]},h.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]},h.velocity={x:0,y:0,z:0},h.angular={x:0,y:0,z:0},h.link=0,this.needMatrix&&(h.matrixWorld=new s.Matrix4),h.instance.v&&(e.v=h.instance.v),h.instance.index&&(e.index=h.instance.index),e.type=h.instance.type}else h.name=a,e.renderOrder&&(h.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),h.visible=void 0===e.visible||e.visible,h.receiveShadow=e.shadow,h.castShadow=e.shadow,h.overMaterial=ee.get("outline"),this.set(e,h);if(e.breakable){B.motor.addBreaker();let t=h.children[0];h.remove(t),h=t,h.name=a,h.type=this.type,h.density=e.density,h.breakable=!0,h.breakOption=void 0!==e.breakOption?e.breakOption:[250,1,2,1]}if(h.mass=e.mass||0,h.density=e.density||0,h.density&&!h.mass?h.mass=A.massFromDensity(h.density,r):h.mass&&!h.density&&(h.density=A.densityFromMass(h.mass,r),"RAPIER"!==B.engine&&"OIMO"!==B.engine||(e.density=h.density)),e.massInfo&&console.log("%c"+h.name+" %cdensity:"+h.density+" mass:"+h.mass,"font-size:16px","font-size:12px"),this.addToWorld(h,e.id),e.onlyMakeMesh)return h;if(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),e.rot&&delete e.rot,e.mesh&&delete e.mesh,e.meshRot&&delete e.meshRot,e.instance&&delete e.instance,e.material&&delete e.material,e.parent&&delete e.parent,e.solver&&"PHYSX"===B.engine){e.mass=h.mass;this.byName(e.solver).addBone(e.name)}return B.post({m:"add",o:e}),h}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(void 0!==e.getVelocity&&(t.getVelocity=e.getVelocity),t.isInstance?(e.pos&&(t.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]}),e.quat&&(t.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]}),t.instance.setTransformAt(t.id,t.position,t.quaternion,t.noScale?[1,1,1]:t.size)):(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix())))}clearInstance(e){let t=B.instanceMesh[e],s=t.getBodyList();B.motor.remove(s),t.dispose(),delete B.instanceMesh[e]}getInstance(e,t){if(B.instanceMesh[e.instance])return B.instanceMesh[e.instance];(e={...e}).sizeByInstance&&(e.size=[1,1,1]);let s=this.geometry(e);e.mesh&&(!e.material&&e.mesh.material&&(t=e.mesh.material),s=e.mesh.isObject3D?e.mesh.geometry.clone():e.mesh.clone(),e.meshSize&&s.scale(e.meshSize,e.meshSize,e.meshSize),e.meshScale&&s.scale(e.meshScale[0],e.meshScale[1],e.meshScale[2]),s.noScale=!0);let i=new ve(s,t,0);return i.type=e.type,i.noScale=s.noScale,"convex"===i.type&&(i.v=e.v),e.index&&(i.index=e.index),i.receiveShadow=void 0===e.shadow||e.shadow,i.castShadow=void 0===e.shadow||e.shadow,i.overMaterial=ee.get("outline"),i.name=e.instance,B.scene.add(i),B.instanceMesh[e.instance]=i,i}scaler(e,t){if(e.size&&(e.size=math.scaleArray(e.size,t)),e.pos&&(e.pos=math.scaleArray(e.pos,t)),"convex"===e.type&&(e.shapeScale=[t,t,t]),e.shapes){let s,i=e.shapes.length;for(;i--;)s=e.shapes[i],s.size&&(s.size=math.scaleArray(s.size,t)),s.pos&&(s.pos=math.scaleArray(s.pos,t)),"convex"===s.type&&(s.shapeScale=[t,t,t])}return e.mesh&&(e.meshScale=[t,t,t]),e}};const We=s.SRGBColorSpace;class Ke extends s.Loader{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,i,a){const r=this,o=new s.FileLoader(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,(function(s){try{t(r.parse(s))}catch(t){a?a(t):console.error(t),r.manager.itemError(e)}}),i,a)}parse(e){const t=this;function i(e,t,s,i,r,o,n,l){if(0==t||0==s)return void e.lineTo(l.x,l.y);i=i*Math.PI/180,t=Math.abs(t),s=Math.abs(s);const h=(n.x-l.x)/2,c=(n.y-l.y)/2,A=Math.cos(i)*h+Math.sin(i)*c,d=-Math.sin(i)*h+Math.cos(i)*c;let u=t*t,p=s*s;const m=A*A,g=d*d,f=m/u+g/p;if(f>1){const e=Math.sqrt(f);u=(t*=e)*t,p=(s*=e)*s}const b=u*g+p*m,y=(u*p-b)/b;let w=Math.sqrt(Math.max(0,y));r===o&&(w=-w);const v=w*t*d/s,C=-w*s*A/t,I=Math.cos(i)*v-Math.sin(i)*C+(n.x+l.x)/2,x=Math.sin(i)*v+Math.cos(i)*C+(n.y+l.y)/2,B=a(1,0,(A-v)/t,(d-C)/s),E=a((A-v)/t,(d-C)/s,(-A-v)/t,(-d-C)/s)%(2*Math.PI);e.currentPath.absellipse(I,x,t,s,B,B+E,0===o,i)}function a(e,t,s,i){const a=e*s+t*i,r=Math.sqrt(e*e+t*t)*Math.sqrt(s*s+i*i);let o=Math.acos(Math.max(-1,Math.min(1,a/r)));return e*i-t*s<0&&(o=-o),o}function r(e,t){t=Object.assign({},t);let s={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)s=Object.assign(s,g["."+t[e]])}function i(i,a,r){void 0===r&&(r=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(i)&&(t[a]=r(e.getAttribute(i))),s[i]&&(t[a]=r(s[i])),e.style&&""!==e.style[i]&&(t[a]=r(e.style[i]))}function a(e){return Math.max(0,Math.min(1,c(e)))}function r(e){return Math.max(0,c(e))}return e.hasAttribute("id")&&(s=Object.assign(s,g["#"+e.getAttribute("id")])),i("fill","fill"),i("fill-opacity","fillOpacity",a),i("fill-rule","fillRule"),i("opacity","opacity",a),i("stroke","stroke"),i("stroke-opacity","strokeOpacity",a),i("stroke-width","strokeWidth",r),i("stroke-linejoin","strokeLineJoin"),i("stroke-linecap","strokeLineCap"),i("stroke-miterlimit","strokeMiterLimit",r),i("visibility","visibility"),t}function o(e,t){return e-(t-e)}function n(e,t,s){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const i={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let a=0,r=!0,o="",n="";const l=[];function h(e,t,s){const i=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw i.partial=s,i}function c(){""!==o&&(""===n?l.push(Number(o)):l.push(Number(o)*Math.pow(10,Number(n)))),o="",n=""}let A;const d=e.length;for(let u=0;u<d;u++)if(A=e[u],Array.isArray(t)&&t.includes(l.length%s)&&i.FLAGS.test(A))a=1,o=A,c();else{if(0===a){if(i.WHITESPACE.test(A))continue;if(i.DIGIT.test(A)||i.SIGN.test(A)){a=1,o=A;continue}if(i.POINT.test(A)){a=2,o=A;continue}i.COMMA.test(A)&&(r&&h(A,u,l),r=!0)}if(1===a){if(i.DIGIT.test(A)){o+=A;continue}if(i.POINT.test(A)){o+=A,a=2;continue}if(i.EXP.test(A)){a=3;continue}i.SIGN.test(A)&&1===o.length&&i.SIGN.test(o[0])&&h(A,u,l)}if(2===a){if(i.DIGIT.test(A)){o+=A;continue}if(i.EXP.test(A)){a=3;continue}i.POINT.test(A)&&"."===o[o.length-1]&&h(A,u,l)}if(3===a){if(i.DIGIT.test(A)){n+=A;continue}if(i.SIGN.test(A)){if(""===n){n+=A;continue}1===n.length&&i.SIGN.test(n)&&h(A,u,l)}}i.WHITESPACE.test(A)?(c(),a=0,r=!1):i.COMMA.test(A)?(c(),a=0,r=!0):i.SIGN.test(A)?(c(),a=1,o=A):i.POINT.test(A)?(c(),a=2,o=A):h(A,u,l)}return c(),l}const l=["mm","cm","in","pt","pc","px"],h={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function c(e){let s,i="px";if("string"==typeof e||e instanceof String)for(let t=0,s=l.length;t<s;t++){const s=l[t];if(e.endsWith(s)){i=s,e=e.substring(0,e.length-s.length);break}}return"px"===i&&"px"!==t.defaultUnit?s=h.in[t.defaultUnit]/t.defaultDPI:(s=h[i][t.defaultUnit],s<0&&(s=h[i].in*t.defaultDPI)),s*parseFloat(e)}function A(e){const t=e.elements;return t[0]*t[4]-t[1]*t[3]<0}function d(e){const t=e.elements,s=t[0]*t[3]+t[1]*t[4];if(0===s)return!1;const i=u(e),a=p(e);return Math.abs(s/(i*a))>Number.EPSILON}function u(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function p(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const m=[],g={},f=[],b=new s.Matrix3,y=new s.Matrix3,w=new s.Matrix3,v=new s.Matrix3,C=new s.Vector2,I=new s.Vector3,x=new s.Matrix3,B=(new DOMParser).parseFromString(e,"image/svg+xml");!function e(t,a){if(1!==t.nodeType)return;const l=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new s.Matrix3,i=b;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const s=c(e.getAttribute("x")),i=c(e.getAttribute("y"));t.translate(s,i)}if(e.hasAttribute("transform")){const s=e.getAttribute("transform").split(")");for(let e=s.length-1;e>=0;e--){const a=s[e].trim();if(""===a)continue;const r=a.indexOf("("),o=a.length;if(r>0&&r<o){const e=a.slice(0,r),t=n(a.slice(r+1));switch(i.identity(),e){case"translate":if(t.length>=1){const e=t[0];let s=0;t.length>=2&&(s=t[1]),i.translate(e,s)}break;case"rotate":if(t.length>=1){let e=0,s=0,a=0;e=t[0]*Math.PI/180,t.length>=3&&(s=t[1],a=t[2]),y.makeTranslation(-s,-a),w.makeRotation(e),v.multiplyMatrices(w,y),y.makeTranslation(s,a),i.multiplyMatrices(y,v)}break;case"scale":if(t.length>=1){const e=t[0];let s=e;t.length>=2&&(s=t[1]),i.scale(e,s)}break;case"skewX":1===t.length&&i.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&i.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&i.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(i)}}return t}(e);f.length>0&&t.premultiply(f[f.length-1]);return x.copy(t),f.push(t),t}(t);let h=!1,B=null;switch(t.nodeName){case"svg":case"g":a=r(t,a);break;case"style":!function(e){if(!e.sheet||!e.sheet.cssRules||!e.sheet.cssRules.length)return;for(let t=0;t<e.sheet.cssRules.length;t++){const s=e.sheet.cssRules[t];if(1!==s.type)continue;const i=s.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<i.length;e++){const t=Object.fromEntries(Object.entries(s.style).filter((([,e])=>""!==e)));g[i[e]]=Object.assign(g[i[e]]||{},t)}}}(t);break;case"path":a=r(t,a),t.hasAttribute("d")&&(B=function(e){const t=new s.ShapePath,a=new s.Vector2,r=new s.Vector2,l=new s.Vector2;let h=!0,c=!1;const A=e.getAttribute("d");if(""===A||"none"===A)return null;const d=A.match(/[a-df-z][^a-df-z]*/gi);for(let e=0,s=d.length;e<s;e++){const s=d[e],A=s.charAt(0),u=s.slice(1).trim();let p;switch(!0===h&&(c=!0,h=!1),A){case"M":p=n(u);for(let e=0,s=p.length;e<s;e+=2)a.x=p[e+0],a.y=p[e+1],r.x=a.x,r.y=a.y,0===e?t.moveTo(a.x,a.y):t.lineTo(a.x,a.y),0===e&&l.copy(a);break;case"H":p=n(u);for(let e=0,s=p.length;e<s;e++)a.x=p[e],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"V":p=n(u);for(let e=0,s=p.length;e<s;e++)a.y=p[e],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"L":p=n(u);for(let e=0,s=p.length;e<s;e+=2)a.x=p[e+0],a.y=p[e+1],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"C":p=n(u);for(let e=0,s=p.length;e<s;e+=6)t.bezierCurveTo(p[e+0],p[e+1],p[e+2],p[e+3],p[e+4],p[e+5]),r.x=p[e+2],r.y=p[e+3],a.x=p[e+4],a.y=p[e+5],0===e&&!0===c&&l.copy(a);break;case"S":p=n(u);for(let e=0,s=p.length;e<s;e+=4)t.bezierCurveTo(o(a.x,r.x),o(a.y,r.y),p[e+0],p[e+1],p[e+2],p[e+3]),r.x=p[e+0],r.y=p[e+1],a.x=p[e+2],a.y=p[e+3],0===e&&!0===c&&l.copy(a);break;case"Q":p=n(u);for(let e=0,s=p.length;e<s;e+=4)t.quadraticCurveTo(p[e+0],p[e+1],p[e+2],p[e+3]),r.x=p[e+0],r.y=p[e+1],a.x=p[e+2],a.y=p[e+3],0===e&&!0===c&&l.copy(a);break;case"T":p=n(u);for(let e=0,s=p.length;e<s;e+=2){const s=o(a.x,r.x),i=o(a.y,r.y);t.quadraticCurveTo(s,i,p[e+0],p[e+1]),r.x=s,r.y=i,a.x=p[e+0],a.y=p[e+1],0===e&&!0===c&&l.copy(a)}break;case"A":p=n(u,[3,4],7);for(let e=0,s=p.length;e<s;e+=7){if(p[e+5]==a.x&&p[e+6]==a.y)continue;const s=a.clone();a.x=p[e+5],a.y=p[e+6],r.x=a.x,r.y=a.y,i(t,p[e],p[e+1],p[e+2],p[e+3],p[e+4],s,a),0===e&&!0===c&&l.copy(a)}break;case"m":p=n(u);for(let e=0,s=p.length;e<s;e+=2)a.x+=p[e+0],a.y+=p[e+1],r.x=a.x,r.y=a.y,0===e?t.moveTo(a.x,a.y):t.lineTo(a.x,a.y),0===e&&l.copy(a);break;case"h":p=n(u);for(let e=0,s=p.length;e<s;e++)a.x+=p[e],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"v":p=n(u);for(let e=0,s=p.length;e<s;e++)a.y+=p[e],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"l":p=n(u);for(let e=0,s=p.length;e<s;e+=2)a.x+=p[e+0],a.y+=p[e+1],r.x=a.x,r.y=a.y,t.lineTo(a.x,a.y),0===e&&!0===c&&l.copy(a);break;case"c":p=n(u);for(let e=0,s=p.length;e<s;e+=6)t.bezierCurveTo(a.x+p[e+0],a.y+p[e+1],a.x+p[e+2],a.y+p[e+3],a.x+p[e+4],a.y+p[e+5]),r.x=a.x+p[e+2],r.y=a.y+p[e+3],a.x+=p[e+4],a.y+=p[e+5],0===e&&!0===c&&l.copy(a);break;case"s":p=n(u);for(let e=0,s=p.length;e<s;e+=4)t.bezierCurveTo(o(a.x,r.x),o(a.y,r.y),a.x+p[e+0],a.y+p[e+1],a.x+p[e+2],a.y+p[e+3]),r.x=a.x+p[e+0],r.y=a.y+p[e+1],a.x+=p[e+2],a.y+=p[e+3],0===e&&!0===c&&l.copy(a);break;case"q":p=n(u);for(let e=0,s=p.length;e<s;e+=4)t.quadraticCurveTo(a.x+p[e+0],a.y+p[e+1],a.x+p[e+2],a.y+p[e+3]),r.x=a.x+p[e+0],r.y=a.y+p[e+1],a.x+=p[e+2],a.y+=p[e+3],0===e&&!0===c&&l.copy(a);break;case"t":p=n(u);for(let e=0,s=p.length;e<s;e+=2){const s=o(a.x,r.x),i=o(a.y,r.y);t.quadraticCurveTo(s,i,a.x+p[e+0],a.y+p[e+1]),r.x=s,r.y=i,a.x=a.x+p[e+0],a.y=a.y+p[e+1],0===e&&!0===c&&l.copy(a)}break;case"a":p=n(u,[3,4],7);for(let e=0,s=p.length;e<s;e+=7){if(0==p[e+5]&&0==p[e+6])continue;const s=a.clone();a.x+=p[e+5],a.y+=p[e+6],r.x=a.x,r.y=a.y,i(t,p[e],p[e+1],p[e+2],p[e+3],p[e+4],s,a),0===e&&!0===c&&l.copy(a)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(a.copy(l),t.currentPath.currentPoint.copy(a),h=!0);break;default:console.warn(s)}c=!1}return t}(t));break;case"rect":a=r(t,a),B=function(e){const t=c(e.getAttribute("x")||0),i=c(e.getAttribute("y")||0),a=c(e.getAttribute("rx")||e.getAttribute("ry")||0),r=c(e.getAttribute("ry")||e.getAttribute("rx")||0),o=c(e.getAttribute("width")),n=c(e.getAttribute("height")),l=.448084975506,h=new s.ShapePath;h.moveTo(t+a,i),h.lineTo(t+o-a,i),(0!==a||0!==r)&&h.bezierCurveTo(t+o-a*l,i,t+o,i+r*l,t+o,i+r);h.lineTo(t+o,i+n-r),(0!==a||0!==r)&&h.bezierCurveTo(t+o,i+n-r*l,t+o-a*l,i+n,t+o-a,i+n);h.lineTo(t+a,i+n),(0!==a||0!==r)&&h.bezierCurveTo(t+a*l,i+n,t,i+n-r*l,t,i+n-r);h.lineTo(t,i+r),(0!==a||0!==r)&&h.bezierCurveTo(t,i+r*l,t+a*l,i,t+a,i);return h}(t);break;case"polygon":a=r(t,a),B=function(e){function t(e,t,s){const i=c(t),o=c(s);0===r?a.moveTo(i,o):a.lineTo(i,o),r++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,a=new s.ShapePath;let r=0;return e.getAttribute("points").replace(i,t),a.currentPath.autoClose=!0,a}(t);break;case"polyline":a=r(t,a),B=function(e){function t(e,t,s){const i=c(t),o=c(s);0===r?a.moveTo(i,o):a.lineTo(i,o),r++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,a=new s.ShapePath;let r=0;return e.getAttribute("points").replace(i,t),a.currentPath.autoClose=!1,a}(t);break;case"circle":a=r(t,a),B=function(e){const t=c(e.getAttribute("cx")||0),i=c(e.getAttribute("cy")||0),a=c(e.getAttribute("r")||0),r=new s.Path;r.absarc(t,i,a,0,2*Math.PI);const o=new s.ShapePath;return o.subPaths.push(r),o}(t);break;case"ellipse":a=r(t,a),B=function(e){const t=c(e.getAttribute("cx")||0),i=c(e.getAttribute("cy")||0),a=c(e.getAttribute("rx")||0),r=c(e.getAttribute("ry")||0),o=new s.Path;o.absellipse(t,i,a,r,0,2*Math.PI);const n=new s.ShapePath;return n.subPaths.push(o),n}(t);break;case"line":a=r(t,a),B=function(e){const t=c(e.getAttribute("x1")||0),i=c(e.getAttribute("y1")||0),a=c(e.getAttribute("x2")||0),r=c(e.getAttribute("y2")||0),o=new s.ShapePath;return o.moveTo(t,i),o.lineTo(a,r),o.currentPath.autoClose=!1,o}(t);break;case"defs":h=!0;break;case"use":a=r(t,a);const l=(t.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),A=t.viewportElement.getElementById(l);A?e(A,a):console.warn("SVGLoader: 'use node' references non-existent node id: "+l)}B&&(void 0!==a.fill&&"none"!==a.fill&&B.color.setStyle(a.fill,We),function(e,t){function i(e){I.set(e.x,e.y,1).applyMatrix3(t),e.set(I.x,I.y)}function a(e){const i=e.xRadius,a=e.yRadius,r=Math.cos(e.aRotation),o=Math.sin(e.aRotation),n=new s.Vector3(i*r,i*o,0),l=new s.Vector3(-a*o,a*r,0),h=n.applyMatrix3(t),c=l.applyMatrix3(t),d=b.set(h.x,c.x,0,h.y,c.y,0,0,0,1),u=y.copy(d).invert(),p=w.copy(u).transpose().multiply(u).elements,m=function(e,t,s){let i,a,r,o,n;const l=e+s,h=e-s,c=Math.sqrt(h*h+4*t*t);l>0?(i=.5*(l+c),n=1/i,a=e*n*s-t*n*t):l<0?a=.5*(l-c):(i=.5*c,a=-.5*c);r=h>0?h+c:h-c;Math.abs(r)>2*Math.abs(t)?(n=-2*t/r,o=1/Math.sqrt(1+n*n),r=n*o):0===Math.abs(t)?(r=1,o=0):(n=-.5*r/t,r=1/Math.sqrt(1+n*n),o=n*r);h>0&&(n=r,r=-o,o=n);return{rt1:i,rt2:a,cs:r,sn:o}}(p[0],p[1],p[4]),g=Math.sqrt(m.rt1),f=Math.sqrt(m.rt2);e.xRadius=1/g,e.yRadius=1/f,e.aRotation=Math.atan2(m.sn,m.cs);if(!((e.aEndAngle-e.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const i=y.set(g,0,0,0,f,0,0,0,1),a=w.set(m.cs,m.sn,0,-m.sn,m.cs,0,0,0,1),r=i.multiply(a).multiply(d),o=e=>{const{x:t,y:i}=new s.Vector3(Math.cos(e),Math.sin(e),0).applyMatrix3(r);return Math.atan2(i,t)};e.aStartAngle=o(e.aStartAngle),e.aEndAngle=o(e.aEndAngle),A(t)&&(e.aClockwise=!e.aClockwise)}}function r(e){const s=u(t),i=p(t);e.xRadius*=s,e.yRadius*=i;const a=s>Number.EPSILON?Math.atan2(t.elements[1],t.elements[0]):Math.atan2(-t.elements[3],t.elements[4]);e.aRotation+=a,A(t)&&(e.aStartAngle*=-1,e.aEndAngle*=-1,e.aClockwise=!e.aClockwise)}const o=e.subPaths;for(let e=0,s=o.length;e<s;e++){const s=o[e].curves;for(let e=0;e<s.length;e++){const o=s[e];o.isLineCurve?(i(o.v1),i(o.v2)):o.isCubicBezierCurve?(i(o.v0),i(o.v1),i(o.v2),i(o.v3)):o.isQuadraticBezierCurve?(i(o.v0),i(o.v1),i(o.v2)):o.isEllipseCurve&&(C.set(o.aX,o.aY),i(C),o.aX=C.x,o.aY=C.y,d(t)?a(o):r(o))}}}(B,x),m.push(B),B.userData={node:t,style:a});const E=t.childNodes;for(let t=0;t<E.length;t++){const s=E[t];h&&"style"!==s.nodeName&&"defs"!==s.nodeName||e(s,a)}l&&(f.pop(),f.length>0?x.copy(f[f.length-1]):x.identity())}(B.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:m,xml:B.documentElement}}static createShapes(e){const t=999999999,i=0,a=1,r=2,o=3,n=4,l=5,h=6,c={loc:i,t:0};function A(e,t,s,a){const o=e.x,n=t.x,l=s.x,h=a.x,A=e.y,u=t.y,p=s.y,m=a.y,g=(h-l)*(A-p)-(m-p)*(o-l),f=(m-p)*(n-o)-(h-l)*(u-A),b=g/f,y=((n-o)*(A-p)-(u-A)*(o-l))/f;if(0===f&&0!==g||b<=0||b>=1||y<0||y>1)return null;if(0===g&&0===f){for(let l=0;l<2;l++){if(d(0===l?s:a,e,t),c.loc==i){const e=0===l?s:a;return{x:e.x,y:e.y,t:c.t}}if(c.loc==r){return{x:+(o+c.t*(n-o)).toPrecision(10),y:+(A+c.t*(u-A)).toPrecision(10),t:c.t}}}return null}for(let r=0;r<2;r++)if(d(0===r?s:a,e,t),c.loc==i){const e=0===r?s:a;return{x:e.x,y:e.y,t:c.t}}return{x:+(o+b*(n-o)).toPrecision(10),y:+(A+b*(u-A)).toPrecision(10),t:b}}function d(e,t,s){const A=s.x-t.x,d=s.y-t.y,u=e.x-t.x,p=e.y-t.y,m=A*p-u*d;if(e.x===t.x&&e.y===t.y)return c.loc=i,void(c.t=0);if(e.x===s.x&&e.y===s.y)return c.loc=a,void(c.t=1);if(m<-Number.EPSILON)return void(c.loc=o);if(m>Number.EPSILON)return void(c.loc=n);if(A*u<0||d*p<0)return void(c.loc=l);if(Math.sqrt(A*A+d*d)<Math.sqrt(u*u+p*p))return void(c.loc=h);let g;g=0!==A?u/A:p/d,c.loc=r,c.t=g}function u(e,t,i){const a=new s.Vector2;t.getCenter(a);const r=[];return i.forEach((t=>{if(t.boundingBox.containsPoint(a)){const i=function(e,t){const i=[],a=[];for(let r=1;r<e.length;r++){const o=e[r-1],n=e[r];for(let e=1;e<t.length;e++){const r=A(o,n,t[e-1],t[e]);null!==r&&void 0===i.find((e=>e.t<=r.t+Number.EPSILON&&e.t>=r.t-Number.EPSILON))&&(i.push(r),a.push(new s.Vector2(r.x,r.y)))}}return a}(e,t.points);i.forEach((e=>{r.push({identifier:t.identifier,isCW:t.isCW,point:e})}))}})),r.sort(((e,t)=>e.point.x-t.point.x)),r}let p=t,m=-999999999,g=e.subPaths.map((e=>{const i=e.getPoints();let a=-999999999,r=t,o=-999999999,n=t;for(let e=0;e<i.length;e++){const t=i[e];t.y>a&&(a=t.y),t.y<r&&(r=t.y),t.x>o&&(o=t.x),t.x<n&&(n=t.x)}return m<=o&&(m=o+1),p>=n&&(p=n-1),{curves:e.curves,points:i,isCW:s.ShapeUtils.isClockWise(i),identifier:-1,boundingBox:new s.Box2(new s.Vector2(n,r),new s.Vector2(o,a))}}));g=g.filter((e=>e.points.length>1));for(let e=0;e<g.length;e++)g[e].identifier=e;const f=g.map((t=>function(e,t,i,a,r){null!=r&&""!==r||(r="nonzero");const o=new s.Vector2;e.boundingBox.getCenter(o);const n=u([new s.Vector2(i,o.y),new s.Vector2(a,o.y)],e.boundingBox,t);n.sort(((e,t)=>e.point.x-t.point.x));const l=[],h=[];n.forEach((t=>{t.identifier===e.identifier?l.push(t):h.push(t)}));const c=l[0].point.x,A=[];let d=0;for(;d<h.length&&h[d].point.x<c;)A.length>0&&A[A.length-1]===h[d].identifier?A.pop():A.push(h[d].identifier),d++;if(A.push(e.identifier),"evenodd"===r){const t=A.length%2==0,s=A[A.length-2];return{identifier:e.identifier,isHole:t,for:s}}if("nonzero"===r){let s=!0,i=null,a=null;for(let e=0;e<A.length;e++){const r=A[e];s?(a=t[r].isCW,s=!1,i=r):a!==t[r].isCW&&(a=t[r].isCW,s=!0)}return{identifier:e.identifier,isHole:s,for:i}}console.warn('fill-rule: "'+r+'" is currently not implemented.')}(t,g,p,m,e.userData?e.userData.style.fillRule:void 0))),b=[];return g.forEach((e=>{if(!f[e.identifier].isHole){const t=new s.Shape;t.curves=e.curves;f.filter((t=>t.isHole&&t.for===e.identifier)).forEach((e=>{const i=g[e.identifier],a=new s.Path;a.curves=i.curves,t.holes.push(a)})),b.push(t)}})),b}static getStrokeStyle(e,t,s,i,a){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:s=void 0!==s?s:"miter",strokeLineCap:i=void 0!==i?i:"butt",strokeMiterLimit:a=void 0!==a?a:4}}static pointsToStroke(e,t,i,a){const r=[],o=[],n=[];if(0===Ke.pointsToStrokeWithBuffers(e,t,i,a,r,o,n))return null;const l=new s.BufferGeometry;return l.setAttribute("position",new s.Float32BufferAttribute(r,3)),l.setAttribute("normal",new s.Float32BufferAttribute(o,3)),l.setAttribute("uv",new s.Float32BufferAttribute(n,2)),l}static pointsToStrokeWithBuffers(e,t,i,a,r,o,n,l){const h=new s.Vector2,c=new s.Vector2,A=new s.Vector2,d=new s.Vector2,u=new s.Vector2,p=new s.Vector2,m=new s.Vector2,g=new s.Vector2,f=new s.Vector2,b=new s.Vector2,y=new s.Vector2,w=new s.Vector2,v=new s.Vector2,C=new s.Vector2,I=new s.Vector2,x=new s.Vector2,B=new s.Vector2;i=void 0!==i?i:12,a=void 0!==a?a:.001,l=void 0!==l?l:0,e=function(e){let t=!1;for(let s=1,i=e.length-1;s<i;s++)if(e[s].distanceTo(e[s+1])<a){t=!0;break}if(!t)return e;const s=[];s.push(e[0]);for(let t=1,i=e.length-1;t<i;t++)e[t].distanceTo(e[t+1])>=a&&s.push(e[t]);return s.push(e[e.length-1]),s}(e);const E=e.length;if(E<2)return 0;const M=e[0].equals(e[E-1]);let S,k,Q=e[0];const R=t.strokeWidth/2,T=1/(E-1);let F,D,L,P,_=0,G=!1,z=0,U=3*l,O=2*l;N(e[0],e[1],h).multiplyScalar(R),g.copy(e[0]).sub(h),f.copy(e[0]).add(h),b.copy(g),y.copy(f);for(let s=1;s<E;s++){S=e[s],k=s===E-1?M?e[1]:void 0:e[s+1];const i=h;if(N(Q,S,i),A.copy(i).multiplyScalar(R),w.copy(S).sub(A),v.copy(S).add(A),F=_+T,D=!1,void 0!==k){N(S,k,c),A.copy(c).multiplyScalar(R),C.copy(S).sub(A),I.copy(S).add(A),L=!0,A.subVectors(k,Q),i.dot(A)<0&&(L=!1),1===s&&(G=L),A.subVectors(k,S),A.normalize();const e=Math.abs(i.dot(A));if(e>Number.EPSILON){const s=R/e;A.multiplyScalar(-s),d.subVectors(S,Q),u.copy(d).setLength(s).add(A),x.copy(u).negate();const i=u.length(),a=d.length();d.divideScalar(a),p.subVectors(k,S);const r=p.length();switch(p.divideScalar(r),d.dot(x)<a&&p.dot(x)<r&&(D=!0),B.copy(u).add(S),x.add(S),P=!1,D?L?(I.copy(x),v.copy(x)):(C.copy(x),w.copy(x)):H(),t.strokeLineJoin){case"bevel":j(L,D,F);break;case"round":W(L,D),L?q(S,w,C,F,0):q(S,I,v,F,1);break;default:const e=R*t.strokeMiterLimit/i;if(e<1){if("miter-clip"!==t.strokeLineJoin){j(L,D,F);break}W(L,D),L?(p.subVectors(B,w).multiplyScalar(e).add(w),m.subVectors(B,C).multiplyScalar(e).add(C),V(w,F,0),V(p,F,0),V(S,F,.5),V(S,F,.5),V(p,F,0),V(m,F,0),V(S,F,.5),V(m,F,0),V(C,F,0)):(p.subVectors(B,v).multiplyScalar(e).add(v),m.subVectors(B,I).multiplyScalar(e).add(I),V(v,F,1),V(p,F,1),V(S,F,.5),V(S,F,.5),V(p,F,1),V(m,F,1),V(S,F,.5),V(m,F,1),V(I,F,1))}else D?(L?(V(f,_,1),V(g,_,0),V(B,F,0),V(f,_,1),V(B,F,0),V(x,F,1)):(V(f,_,1),V(g,_,0),V(B,F,1),V(g,_,0),V(x,F,0),V(B,F,1)),L?C.copy(B):I.copy(B)):L?(V(w,F,0),V(B,F,0),V(S,F,.5),V(S,F,.5),V(B,F,0),V(C,F,0)):(V(v,F,1),V(B,F,1),V(S,F,.5),V(S,F,.5),V(B,F,1),V(I,F,1)),P=!0}}else H()}else H();M||s!==E-1||K(e[0],b,y,L,!0,_),_=F,Q=S,g.copy(C),f.copy(I)}if(M){if(D&&r){let e=B,t=x;G!==L&&(e=x,t=B),L?(P||G)&&(t.toArray(r,0),t.toArray(r,9),P&&e.toArray(r,3)):!P&&G||(t.toArray(r,3),t.toArray(r,9),P&&e.toArray(r,0))}}else K(S,w,v,L,!1,F);return z;function N(e,t,s){return s.subVectors(t,e),s.set(-s.y,s.x).normalize()}function V(e,t,s){r&&(r[U]=e.x,r[U+1]=e.y,r[U+2]=0,o&&(o[U]=0,o[U+1]=0,o[U+2]=1),U+=3,n&&(n[O]=t,n[O+1]=s,O+=2)),z+=3}function q(e,t,s,a,r){h.copy(t).sub(e).normalize(),c.copy(s).sub(e).normalize();let o=Math.PI;const n=h.dot(c);Math.abs(n)<1&&(o=Math.abs(Math.acos(n))),o/=i,A.copy(t);for(let t=0,s=i-1;t<s;t++)d.copy(A).rotateAround(e,o),V(A,a,r),V(d,a,r),V(e,a,.5),A.copy(d);V(d,a,r),V(s,a,r),V(e,a,.5)}function H(){V(f,_,1),V(g,_,0),V(w,F,0),V(f,_,1),V(w,F,1),V(v,F,0)}function j(e,t,s){t?e?(V(f,_,1),V(g,_,0),V(w,F,0),V(f,_,1),V(w,F,0),V(x,F,1),V(w,s,0),V(C,s,0),V(x,s,.5)):(V(f,_,1),V(g,_,0),V(v,F,1),V(g,_,0),V(x,F,0),V(v,F,1),V(v,s,1),V(I,s,0),V(x,s,.5)):e?(V(w,s,0),V(C,s,0),V(S,s,.5)):(V(v,s,1),V(I,s,0),V(S,s,.5))}function W(e,t){t&&(e?(V(f,_,1),V(g,_,0),V(w,F,0),V(f,_,1),V(w,F,0),V(x,F,1),V(w,_,0),V(S,F,.5),V(x,F,1),V(S,F,.5),V(C,_,0),V(x,F,1)):(V(f,_,1),V(g,_,0),V(v,F,1),V(g,_,0),V(x,F,0),V(v,F,1),V(v,_,1),V(x,F,0),V(S,F,.5),V(S,F,.5),V(x,F,0),V(I,_,1)))}function K(e,s,i,a,o,n){switch(t.strokeLineCap){case"round":o?q(e,i,s,n,.5):q(e,s,i,n,.5);break;case"square":if(o)h.subVectors(s,e),c.set(h.y,-h.x),A.addVectors(h,c).add(e),d.subVectors(c,h).add(e),a?(A.toArray(r,3),d.toArray(r,0),d.toArray(r,9)):(A.toArray(r,3),A.toArray(r,9),d.toArray(r,0));else{h.subVectors(i,e),c.set(h.y,-h.x),A.addVectors(h,c).add(e),d.subVectors(c,h).add(e);const t=r.length;a?(A.toArray(r,t-3),d.toArray(r,t-6),d.toArray(r,t-12)):(A.toArray(r,t-6),d.toArray(r,t-3),d.toArray(r,t-12))}}}}}class Je extends s.Mesh{constructor(e,t={},i=null){if(super(),this.model=e,this.material=i,this.outMaterial=!!i,this.XML=new XMLSerializer,this.color=new s.Color,this.opacity=1,this.svgLoader=new Ke,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=t.size||1,this.scaler=1/this.size,!this.model)return;let a={radius:5,min:90,max:90,strokeSize:.25,...t};switch(this.model){case"angle":this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke;let e=Math.abs(a.min);this.add("path",{d:this.circle(0,0,a.radius,180,180+a.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,a.radius,180,180+a.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,a.radius,180-e,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,a.radius,180-e,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let t=.5*a.radius,s=a.max*this.scaler,i=a.min*this.scaler;this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke,this.add("path",{d:this.segment({x:-t,y:0},{x:t,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-t,y:s},{x:t,y:s}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-t,y:i},{x:t,y:i}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:s}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let r=.5*a.radius;this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-r},{x:0,y:r}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-r,y:0},{x:r,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":a.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(e={}){let t={};if("angle"===this.model){t={radius:5,min:-90,max:90,...e};let s=Math.abs(t.min);this.change("d",this.circle(0,0,t.radius,180,180+t.max,!0),0),this.change("d",this.circle(0,0,t.radius,180,180+t.max,!1,!1,.3),1),this.change("d",this.circle(0,0,t.radius,180-s,180,!0),2),this.change("d",this.circle(0,0,t.radius,180-s,180,!1,!1,.3,!0),3)}void 0!==e.wireframe&&(this.material.wireframe=e.wireframe),this.fill=void 0===t.fill||t.fill,this.stroke=void 0===t.stroke||t.stroke,this.toMesh()}set(e={},t){for(let s in e)t?t.setAttributeNS(null,s,e[s]):this.svg.setAttributeNS(null,s,e[s])}add(e,t={}){let s=document.createElementNS(this.base,e);this.set(t,s),this.svg.appendChild(s)}change(e,t,s){this.svg.childNodes[s].setAttributeNS(null,e,t)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(e,t,s,i){var a=(i-90)*Math.PI/180;return{x:e+s*Math.cos(a),y:t+s*Math.sin(a)}}circle(e,t,s,i=0,a=360,r=!1,o=!1,n=0,l=!1){0===i&&360===a&&(i=1e-4,o=!0);let h=this.polarToCartesian(e,t,s,a),c=this.polarToCartesian(e,t,s,i),A=a-i<=180?"0":"1",d=["M",h.x,h.y,"A",s,s,0,A,0,c.x,c.y];if(r&&d.push("L",e,t,"L",h.x,h.y),o&&d.push("Z"),0!==n){let r=this.polarToCartesian(e,t,s-n,l?i:a),o=this.polarToCartesian(e,t,s+n,l?i:a);d.push("M",r.x,r.y,"L",o.x,o.y)}return d.join(" ")}segment(e,t){return["M",e.x,e.y,"L",t.x,t.y].join(" ")}geomColor(e,t,i=1){let a=e.attributes.position.count,r=[];for(;a--;)r.push(t.r,t.g,t.b,i);e.setAttribute("color",new s.Float32BufferAttribute(r,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let e=[],t=0,i=1,a=this.svgLoader.parse(this.getString());for(const r of a.paths){const a=r.userData.style.fill;if(this.fill&&void 0!==a&&"none"!==a){this.color.setStyle(a),i=r.userData.style.fillOpacity,i<this.opacity&&(this.opacity=i);const o=Ke.createShapes(r);for(const a of o){const r=new s.ShapeGeometry(a);if(r){this.geomColor(r,this.color,i);let a=(new s.BufferGeometry).copy(r).toNonIndexed();a.translate(0,0,-t*this.layerUp),e.push(a),t++}}}const o=r.userData.style.stroke;if(this.stroke&&void 0!==o&&"none"!==o){this.color.setStyle(o),i=r.userData.style.strokeOpacity,i<this.opacity&&(this.opacity=i);for(const s of r.subPaths){const a=Ke.pointsToStroke(s.getPoints(),r.userData.style,6);a&&(this.geomColor(a,this.color,i),a.translate(0,0,-t*this.layerUp),e.push(a),t++)}}}return e}toMesh(){let e=this.size;this.geometry&&this.geometry.dispose();let t=this.toGeometry();t?(this.geometry=Ce(t),this.geometry.scale(e,-e,e),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new s.BufferGeometry,null===this.material&&(this.material=new s.MeshBasicMaterial({vertexColors:!0,transparent:1!==this.opacity,side:s.DoubleSide}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}let Ye=class extends we{constructor(e={}){super(),this.isJoint=!0,this.type="joint",this.mode=e.mode||"hinge",this.visible=void 0!==e.visible&&e.visible,this.mtx=new s.Matrix4,this.size=e.helperSize||.1;let t,i,a=ee.get("line");switch(this.mode){case"prismatic":t=ee.get("svg"),i={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},e.lm&&(i.min=e.lm[0],i.max=e.lm[1]),this.m1=new Je("liner",i,t),this.m2=new Je("middle",i,t),this.m1.geometry.rotateY(90*A.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":t=ee.get("svg"),i={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},e.lm&&(i.min=e.lm[0],i.max=e.lm[1]),e.lmr&&(i.min=e.lmr[0],i.max=e.lmr[1]),this.m1=new Je("angle",i,t),this.m2=new Je("needle",i,t),this.add(this.m1),this.add(this.m2);break;default:const r=T("joint");let o=r.clone();o.scale(this.size,this.size,this.size),this.m1=new s.LineSegments(o,a),this.add(this.m1),o=r.clone(),o.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new s.LineSegments(o,a),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new s.Matrix4,this.mat2=new s.Matrix4,this.end=new s.Vector3;let r=new s.Quaternion;e.quat1&&this.mat1.makeRotationFromQuaternion(r.fromArray(e.quat1)),e.quat2&&this.mat2.makeRotationFromQuaternion(r.fromArray(e.quat2)),this.mat1.setPosition(e.pos1[0],e.pos1[1],e.pos1[2]),this.mat2.setPosition(e.pos2[0],e.pos2[1],e.pos2[2]);const o=new s.BufferGeometry;o.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,0,0],3)),o.setAttribute("color",new s.Float32BufferAttribute([1,0,0,1,0,0],3)),o.computeBoundingSphere(),this.m3=new s.LineSegments(o,a),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()),this.visible||(this.visible=!0))}updateFromPhy(e,t=0){this.visible&&(this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()),this.visible||(this.visible=!0))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}},Xe=class extends ae{constructor(){super(),this.Utils=E,this.type="joint",this.v1=new s.Vector3,this.v2=new s.Vector3}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.joint,16===v.joint?s.updateFromPhy(e,i):s.update()}add(e={}){let t,i=this.setName(e),a=null,r=null,n=!1;if(e.axis1||(e.axis1=[1,0,0]),e.axis2||(e.axis2=[1,0,0]),e.pos1||(e.pos1=[0,0,0]),e.pos2||(e.pos2=[0,0,0]),e.limit?e.lm=e.limit:e.lm&&(e.limit=e.lm),"universal"!==e.mode&&"dof"!==e.mode&&"d6"!==e.mode||(e.mode="generic"),"revolute"===e.mode&&(e.mode="hinge"),"slider"===e.mode&&(e.mode="cylindrical"),e.b1&&(t="string"==typeof e.b1,a=t?E.byName(e.b1):e.b1,t||(e.b1=e.b1.name),a&&a.link++),e.b2&&(t="string"==typeof e.b2,r=t?E.byName(e.b2):e.b2,t||(e.b2=e.b2.name),r&&r.link++),e.worldPos&&(e.worldAnchor=e.worldPos),e.worldAnchor&&(e.pos1=a?E.toLocal(this.v1.fromArray(e.worldAnchor),a).toArray():e.worldAnchor,e.pos2=r?E.toLocal(this.v2.fromArray(e.worldAnchor),r).toArray():e.worldAnchor,delete e.worldAnchor),e.worldAxis&&(e.axis1=a?E.toLocal(this.v1.fromArray(e.worldAxis),a,!0).toArray():e.worldAxis,e.axis2=r?E.toLocal(this.v2.fromArray(e.worldAxis),r,!0).toArray():e.worldAxis,n=!0,delete e.worldAxis),e.worldQuat&&(e.quat1=E.quatLocal(e.worldQuat,a),e.quat2=E.quatLocal(e.worldQuat,r),"OIMO"!==B.engine&&"HAVOK"!==B.engine&&"JOLT"!==B.engine||(e.axis1=E.axisLocal(A.quatToAxis(e.worldQuat),a),e.axis2=E.axisLocal(A.quatToAxis(e.worldQuat),r)),delete e.worldQuat),void 0!==e.rot1&&(e.quat1=A.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=A.quatFromEuler(e.rot2),delete e.rot2),e.quat1||(e.quat1=(new s.Quaternion).setFromUnitVectors(new s.Vector3(1,0,0),(new s.Vector3).fromArray(e.axis1).normalize()).toArray()),e.quat2||(e.quat2=(new s.Quaternion).setFromUnitVectors(new s.Vector3(1,0,0),(new s.Vector3).fromArray(e.axis2).normalize()).toArray()),"AMMO"===B.engine&&n&&"hinge"===e.mode){let t=new s.Euler(0,-90*o,0),i=(new s.Quaternion).setFromEuler(t).toArray();e.quatX=i}e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot);let l=new Ye(e);return l.name=i,l.body1=a,l.body2=r,void 0===e.visible&&(e.visible=B.jointVisible||!1),this.set(e,l),this.addToWorld(l,e.id),B.post({m:"add",o:e}),l}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&void 0!==e.visible&&(t.visible=e.visible)}},Ze=class extends ae{constructor(){super(),this.Utils=E,this.type="contact"}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.contact,s.update(e,i)}add(e={}){this.setName(e);let t=new $e(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),B.post({m:"add",o:e}),t}},$e=class{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.simple=e.simple||!1,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}},et=class extends ae{constructor(){super(),this.Utils=E,this.type="vehicle",this.num=v[this.type]}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*this.num,i.step(e,s)}add(e={}){this.setName(e);const t=new tt(e);return this.addToWorld(t,e.id),B.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}},tt=class extends we{constructor(e){super(),e.extra&&(this.extra=e.extra,delete e.extra),this.type="vehicle",this.name=e.name||"car",this.isRay=e.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(e)}drive(){}raycast(){}init(e){this.mass=e.mass||2e3,this.model=null,this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.maxSteering=e.maxSteering||24,this.incSteering=e.incSteering||2,this.s_travel=e.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===B.engine?.5*this.s_travel:0,this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep;let t=this.numWheel<4?1:2;if(e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){this.wPos=e.wPos;var s,i,a,r,o,n,l=e.wPos,h=[],c=1,d=0;l.length,l.length;for(let e=0;e<this.numWheel;e++)c=e%2==0?-1:1,i=Math.floor(.5*e),d=e>=t,0===(a=l[1])&&(a=d?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][i]),o=d?-l[2]:l[2],l[2]instanceof Array&&(o=l[2][i]),s=[r*c,a,o],h.push(s);this.wheelsPosition=h,delete e.wPos}e.wheelsPosition&&(this.wheelsPosition=e.wheelsPosition);const u=e.meshScale||1,p=[];e.chassisShape?p.push({type:"convex",shape:e.chassisShape,size:[u],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):p.push({type:"box",size:this.size,pos:this.chassisPos});for(let s=0;s<this.numWheel;s++)s<t?p.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1}):p.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1});var m=ee.get(e.debug?"debug":void 0===e.chassisMesh?"body":"hide");let g,f;for(let e=0;e<p.length;e++)g=p[e],g.pos&&(g.localPos=g.pos),g.size=A.autoSize(g.size,g.type),B.items.body.geometry(g,this,m);if(e.chassisMesh&&(f=e.noClone?e.chassisMesh:e.chassisMesh.clone(),f.position.set(0,0,0),E.noRay(f),f.scale.set(u,u,u),this.children[0].add(f),this.model=f,delete e.chassisMesh),e.wheelMesh){for(let s=1;s<this.numWheel+1;s++)d=s>=t+1,f=e.wheelMeshBack&&d?e.wheelMeshBack.clone():e.wheelMesh.clone(),E.noRay(f),f.position.set(0,0,0),2==s||4==s?f.scale.set(-u,u,u):f.scale.set(u,u,u),this.children[s].add(f);delete e.wheelMesh}if(e.suspensionMesh){this.suspensionMesh=[];for(let t=1;t<this.numWheel+1;t++)f=e.suspensionMesh.clone(),E.noRay(f),f.position.set(0,0,0),f.position.fromArray(this.wheelsPosition[t-1]),f.position.x=0,2==t||4==t?f.scale.set(u,u,u):f.scale.set(-u,u,u),this.children[0].add(f),this.suspensionMesh.push(f);delete e.suspensionMesh}if(e.brakeMesh){this.brake=[];for(let t=1;t<this.numWheel+1;t++)d=t>2,f=e.brakeMeshBack&&d?e.brakeMeshBack.clone():e.brakeMesh.clone(),E.noRay(f),f.position.set(0,0,0),f.position.fromArray(this.wheelsPosition[t-1]),n=e.brakeMeshBack||d?u:-u,2==t||4==t?f.scale.set(-u,u,n):f.scale.set(u,u,n),this.children[0].add(f),this.brake.push(f);delete e.brakeMesh}e.mass=this.mass,e.size=e.chassisShape?p[0].boxSize:this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=p[0],e.maxSteering=this.maxSteering,e.incSteering=this.incSteering,e.s_travel=this.s_travel,e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}set(e){e.name=this.name,B.motor.change(e)}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.quaternion.toArray()),B.motor.change(e)}move(){}dispose(){}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.updateMatrix();let s,i=this.numWheel+1,a=0,r=0,o=[],l=0;for(let n=0;n<i;n++)l=8*n+t,0===n&&(e[l],this.circum),1===n&&(a=e[l]),2===n&&(r=e[l]),s=this.children[n],s&&n>0&&(o[n-1]=this.wheelsPosition[n-1][1]-this.decaly-e[l+2],s.position.fromArray(e,l+1),s.quaternion.fromArray(e,l+4),this.rolling[n-1]=s.rotation.x,this.brake&&(this.brake[n-1].position.copy(s.position),1!=n&&2!=n||(this.brake[n-1].rotation.y=e[l])));for(l=4;l--;)this.suspension[l]=A.clamp(o[l]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[l]>0?(E.morph(this.suspensionMesh[l].children[0],"low",this.suspension[l]),E.morph(this.suspensionMesh[l].children[0],"top",0)):(E.morph(this.suspensionMesh[l].children[0],"low",0),E.morph(this.suspensionMesh[l].children[0],"top",-this.suspension[l])));this.steering=Math.round(.5*(a+r)*n)/this.maxSteering}};const st=new s.Matrix4,it=new s.Vector3,at=new s.Quaternion,rt=new s.Vector3,ot=new s.Matrix4,nt=new s.Matrix4,lt=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];let ht,ct,At,dt,ut=class extends s.Object3D{constructor(e,t,s,i=null,a={}){super(),this.prefix=e||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=t,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==B.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=i,this.friction=.5,this.restitution=0,this.option=a,this.useDrive=void 0===a.useDrive||a.useDrive,this.showJoint=void 0!==a.showJoint&&a.showJoint,this.init()}setMass(e){if(e===this.mass)return;this.mass=e;const t=[];let s=this.nodes.length,i=this.mass/s;for(;s--;)t.push({name:this.nodes[s].name,mass:i});B.motor.change(t)}setMode(e){if(e===this.mode)return;this.mode=e;const t=[];let s,i="follow"===this.mode,a=this.nodes.length;for(;a--;)s=this.nodes[a],t.push({name:s.name,kinematic:i}),s.kinematic=i,s.bone.isPhysics=!i;B.motor.change(t)}freeBone(e){e.kinematic&&(e.cc++,20===e.cc&&(e.cc=0,e.kinematic=!1,e.bone.isPhysics=!0,B.motor.change({name:e.name,kinematic:!1})))}isVisible(e){let t=this.nameList.length;for(;t--;)E.byName(this.nameList[t]).visible=e}init(){this.useSolver&&(this.solver=B.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===B.engine;const e=[];let t=(new s.Matrix4).makeScale(this.scaler,this.scaler,this.scaler),i=new s.Vector3,a=new s.Vector3,r=new s.Quaternion,n=new s.Euler,l=new s.Matrix4,h=new s.Matrix4,c=new s.Matrix4;ot.copy(this.model.matrixWorld).invert();let d=new s.Vector3,u=new s.Vector3,p=[1,1,1,1,1,1,1];this.option.sizer&&(p=this.option.sizer);let m,g,f,b,y,w,v,C,I,x,E,M,S,k=this.bones.length,Q=0;for(this.mass&&(Q=this.mass/k),m=0;m<k;m++)if(I=null,b=this.bones[m],g=b.name,y=b.parent,y){f=y.name,nt.multiplyMatrices(ot,b.matrixWorld),d.setFromMatrixPosition(nt),nt.multiplyMatrices(ot,y.matrixWorld),u.setFromMatrixPosition(nt),v=d.distanceTo(u),E=[0,0,.5*v],w=[v,1,1],C=null,x=!0,S=!1,"hip"===f&&"abdomen"===g&&(I="capsule",w=[v*p[0],.08],E=[0,0,-v*p[0]],C=[0,0,90]),"abdomen"===f&&"chest"===g&&(I="capsule",w=[.7*v*p[1],.08],E=[0,0,.5*-v-.06],C=[90,0,0]),"chest"===f&&"neck"===g&&(I="capsule",w=[.4*v*p[2],.04],E=[0,0,.5*-v-.02],C=[0,0,90]),"neck"===f&&"head"===g&&(I="capsule",w=[.06*p[3],v],E=[0,0,.5*-v],C=[90,0,0]),"head"===f&&"End_head"===g&&(I="capsule",w=[.1*p[4],v-.17],E=[0,.02,.5*-v+.02],C=[90,0,0]),"chest"===f&&"rBreast"===g&&"HAVOK"!==B.engine&&(f="rBreast",y=b,I="sphere",w=[.065],E=[.065,0,0],this.breast=!0,S=!0),"chest"===f&&"lBreast"===g&&"HAVOK"!==B.engine&&(f="lBreast",y=b,I="sphere",w=[.065],E=[.065,0,0],this.breast=!0,S=!0);let s=.04*p[5],m=v-s;if("lCollar"===f&&"lShldr"===g&&(I="capsule",w=[s,.3*v],E=[.6*v,0,0],C=[0,0,90]),"lShldr"===f&&"lForeArm"===g&&(I="capsule",w=[s,m],E=[.5*m,0,0],C=[0,0,90]),"lForeArm"===f&&"lHand"===g&&(I="capsule",w=[s,m],E=[.5*m,0,0],C=[0,0,90]),"lHand"===f&&"lMid1"===g&&(I="box",w=[2*v,.09,.05],E=[v,0,0]),"rCollar"===f&&"rShldr"===g&&(I="capsule",w=[s,.3*v],E=[.6*-v,0,0],C=[0,0,90]),"rShldr"===f&&"rForeArm"===g&&(I="capsule",w=[s,m],E=[.5*-m,0,0],C=[0,0,90]),"rForeArm"===f&&"rHand"===g&&(I="capsule",w=[s,m],E=[.5*-m,0,0],C=[0,0,90]),"rHand"===f&&"rMid1"===g&&(I="box",w=[2*v,.09,.05],E=[-v,0,0]),s=.06*p[6],m=v-s,"lThigh"===f&&(I="capsule",w=[s,v],C=[90,0,0],E=[0,0,.5*m]),"lShin"===f&&(I="capsule",w=[s,v],C=[90,0,0],E=[0,0,.5*m]),"lFoot"===f&&(I="capsule",w=[.05,v],E=[0,.5*v-.025,.04]),"rThigh"===f&&(I="capsule",w=[s,v],C=[90,0,0],E=[0,0,.5*m]),"rShin"===f&&(I="capsule",w=[s,v],C=[90,0,0],E=[0,0,.5*m]),"rFoot"===f&&(I="capsule",w=[.05,v],E=[0,.5*v-.025,.04]),s=.04,m=v-s,"rEar_0"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("rEar_0")),"rEar_1"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("rEar_1")),"rEar_2"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("rEar_2")),"rEar_3"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0]),"lEar_0"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("lEar_0")),"lEar_1"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("lEar_1")),"lEar_2"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0],lt.push("lEar_2")),"lEar_3"===f&&(I="capsule",w=[s,v],C=[0,0,90],E=[.5*m,0,0]),this.withFinger&&("lHand"===f&&"lMid1"===g&&(I="box",w=[v,.09,.05],E=[.5*v,0,0]),"rHand"===f&&"rMid1"===g&&(I="box",w=[v,.09,.05],E=[.5*-v,0,0]),"rThumb1"===f&&"rThumb2"===g&&(I="capsule",w=[.02,v],C=[0,0,90]),"rThumb2"===f&&"rThumb3"===g&&(I="capsule",w=[.02,v],C=[0,0,90]),"rHand"===f&&"rMid1"===g&&(I="capsule",w=[.02,v],C=[0,0,90],E=[.6*-v,0,0]),"rMid1"===f&&"rMid2"===g&&(I="capsule",w=[.02,v],C=[0,0,90],E=[.6*-v,0,0]),"rMid2"===f&&"rMid3"===g&&(I="capsule",w=[.02,v],C=[0,0,90],E=[.6*-v,0,0])),null!==I){M=this.prefix+"_bone_"+f,h.makeTranslation(E[0],E[1],E[2]),C&&(c.makeRotationFromEuler(n.set(C[0]*o,C[1]*o,C[2]*o)),h.multiply(c)),y.updateWorldMatrix(!0,!1),nt.multiplyMatrices(ot,y.matrixWorld),l.copy(nt),l.decompose(i,r,a),this.posRef[M]=i.toArray(),"lForeArm"!==f&&"rForeArm"!==f||(at.setFromAxisAngle({x:0,y:1,z:0},-90*o),r.multiply(at)),this.quatRef[M]=r.toArray(),l.multiplyMatrices(nt,h),l.decompose(i,r,a),this.nameList.push(M);let s={name:M,friction:this.friction,restitution:this.restitution,type:I,size:A.scaleArray(w,this.scaler,3),pos:i.toArray(),quat:r.toArray(),kinematic:x,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==lt.indexOf(f)&&(s.aggregate=this.prefix+"__Group",s.aggregateMax=21),s.mask=3;else{let e=3;"lForeArm"!==f&&"rForeArm"!==f&&"lShin"!==f&&"rShin"!==f||(e=35),"rEar_1"!==f&&"rEar_2"!==f&&"rEar_3"!==f&&"lEar_1"!==f&&"lEar_2"!==f&&"lEar_3"!==f||(e=35),"rEar_0"!==f&&"rEar_0"!==f||(e=0),s.group=32,s.mask=e}null!==this.mass?s.mass=Q:s.density=1,e.push(s);let d=h.clone().invert().premultiply(t);this.nodes.push({name:M,kinematic:x,motion:S,bone:y,decal:h.clone(),decalinv:d,quat:r.toArray(),pos:i.toArray(),cc:0})}}B.motor.add(e),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(e){return-1!==this.nameList.indexOf(e)}addLink(){let e=[.05,1,0];"PHYSX"===B.engine&&(e=[50,10,0,.5]);let t=2,s=.1,i=1e7,a=!1,r=this.prefix+"_bone_",o=[],n={type:"joint",mode:"d6",lm:[["ry",-180,180,...e],["rz",-180,180,...e]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(n.drives=[["rx",t,s,i,a],["ry",t,s,i,a],["rz",t,s,i,a]]);let l=[-.001,.001,100,.2,.5];o.push({...n,b1:r+"hip",b2:r+"abdomen",worldPos:this.posRef[r+"abdomen"],worldQuat:this.quatRef[r+"hip"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),o.push({...n,b1:r+"abdomen",b2:r+"chest",worldPos:this.posRef[r+"chest"],worldQuat:this.quatRef[r+"chest"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),o.push({...n,b1:r+"chest",b2:r+"neck",worldPos:this.posRef[r+"neck"],worldQuat:this.quatRef[r+"neck"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),o.push({...n,b1:r+"neck",b2:r+"head",worldPos:this.posRef[r+"head"],worldQuat:this.quatRef[r+"head"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),o.push({...n,b1:r+"chest",b2:r+"rCollar",worldPos:this.posRef[r+"rCollar"],worldQuat:this.quatRef[r+"rCollar"],mode:"fixe"}),o.push({...n,b1:r+"chest",b2:r+"lCollar",worldPos:this.posRef[r+"lCollar"],worldQuat:this.quatRef[r+"lCollar"],mode:"fixe"}),o.push({...n,b1:r+"rCollar",b2:r+"rShldr",worldPos:this.posRef[r+"rShldr"],worldQuat:this.quatRef[r+"rShldr"]}),o.push({...n,b1:r+"lCollar",b2:r+"lShldr",worldPos:this.posRef[r+"lShldr"],worldQuat:this.quatRef[r+"lShldr"]}),this.existe(r+"rForeArm")&&o.push({...n,b1:r+"rShldr",b2:r+"rForeArm",worldPos:this.posRef[r+"rForeArm"],worldQuat:this.quatRef[r+"rForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"lForeArm")&&o.push({...n,b1:r+"lShldr",b2:r+"lForeArm",worldPos:this.posRef[r+"lForeArm"],worldQuat:this.quatRef[r+"lForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"rHand")&&o.push({...n,b1:r+"rForeArm",b2:r+"rHand",worldPos:this.posRef[r+"rHand"],worldQuat:this.quatRef[r+"rHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),this.existe(r+"lHand")&&o.push({...n,b1:r+"lForeArm",b2:r+"lHand",worldPos:this.posRef[r+"lHand"],worldQuat:this.quatRef[r+"lHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),o.push({...n,b1:r+"hip",b2:r+"rThigh",worldPos:this.posRef[r+"rThigh"],worldQuat:this.quatRef[r+"rThigh"]}),o.push({...n,b1:r+"hip",b2:r+"lThigh",worldPos:this.posRef[r+"lThigh"],worldQuat:this.quatRef[r+"lThigh"]}),this.existe(r+"rShin")&&o.push({...n,b1:r+"rThigh",b2:r+"rShin",worldPos:this.posRef[r+"rShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"rShin"]}),this.existe(r+"lShin")&&o.push({...n,b1:r+"lThigh",b2:r+"lShin",worldPos:this.posRef[r+"lShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"lShin"]}),this.existe(r+"rFoot")&&o.push({...n,b1:r+"rShin",b2:r+"rFoot",worldPos:this.posRef[r+"rFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"rFoot"]}),this.existe(r+"lFoot")&&o.push({...n,b1:r+"lShin",b2:r+"lFoot",worldPos:this.posRef[r+"lFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"lFoot"]}),this.breast&&(this.existe(r+"rBreast")&&o.push({...n,b1:r+"chest",b2:r+"rBreast",worldPos:this.posRef[r+"rBreast"],worldQuat:this.quatRef[r+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(r+"lBreast")&&o.push({...n,b1:r+"chest",b2:r+"lBreast",worldPos:this.posRef[r+"lBreast"],worldQuat:this.quatRef[r+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(r+"lEar_0")&&o.push({...n,b1:r+"head",b2:r+"lEar_0",worldPos:this.posRef[r+"lEar_0"],worldQuat:this.quatRef[r+"lEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_1")&&o.push({...n,b1:r+"lEar_0",b2:r+"lEar_1",worldPos:this.posRef[r+"lEar_1"],worldQuat:this.quatRef[r+"lEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_2")&&o.push({...n,b1:r+"lEar_1",b2:r+"lEar_2",worldPos:this.posRef[r+"lEar_2"],worldQuat:this.quatRef[r+"lEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_3")&&o.push({...n,b1:r+"lEar_2",b2:r+"lEar_3",worldPos:this.posRef[r+"lEar_3"],worldQuat:this.quatRef[r+"lEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_0")&&o.push({...n,b1:r+"head",b2:r+"rEar_0",worldPos:this.posRef[r+"rEar_0"],worldQuat:this.quatRef[r+"rEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_1")&&o.push({...n,b1:r+"rEar_0",b2:r+"rEar_1",worldPos:this.posRef[r+"rEar_1"],worldQuat:this.quatRef[r+"rEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_2")&&o.push({...n,b1:r+"rEar_1",b2:r+"rEar_2",worldPos:this.posRef[r+"rEar_2"],worldQuat:this.quatRef[r+"rEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_3")&&o.push({...n,b1:r+"rEar_2",b2:r+"rEar_3",worldPos:this.posRef[r+"rEar_3"],worldQuat:this.quatRef[r+"rEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]});let h=0;for(let e in o)o[e].name=this.prefix+"_joint_"+h,this.jointList.push(o[e].name),h++;B.motor.add(o)}updateMatrixWorld(e){if(!this.ready)return;let t=[];const s=this.nodes;let i,a,r,o=s.length,n=0;for(;o--;)i=s[n],a=i.bone,n++,i.kinematic?(st.multiplyMatrices(a.matrixWorld,i.decal),st.decompose(it,at,rt),i.pos=it.toArray(),i.quat=at.toArray(),t.push({name:i.name,pos:i.pos,quat:i.quat}),i.motion&&this.freeBone(i)):(r=E.byName(i.name),r&&(st.copy(r.matrixWorld).multiply(i.decalinv),a.phyMtx.copy(st),a.isPhysics=!0));0!==t.length&&B.motor.change(t,!0)}dispose(){B.motor.remove(this.jointList),B.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}};function pt(e,t=1/0,i=null){ct||(ct=new s.PlaneGeometry(2,2,1,1)),At||(At=new s.ShaderMaterial({uniforms:{blitTexture:new s.Uniform(e)},vertexShader:"\n\t\t\tvarying vec2 vUv;\n\t\t\tvoid main(){\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = vec4(position.xy * 1.0,0.,.999999);\n\t\t\t}",fragmentShader:"\n\t\t\tuniform sampler2D blitTexture; \n\t\t\tvarying vec2 vUv;\n\n\t\t\tvoid main(){ \n\t\t\t\tgl_FragColor = vec4(vUv.xy, 0, 1);\n\t\t\t\t\n\t\t\t\t#ifdef IS_SRGB\n\t\t\t\tgl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );\n\t\t\t\t#else\n\t\t\t\tgl_FragColor = texture2D( blitTexture, vUv);\n\t\t\t\t#endif\n\t\t\t}"})),At.uniforms.blitTexture.value=e,At.defines.IS_SRGB=e.colorSpace==s.SRGBColorSpace,At.needsUpdate=!0,dt||(dt=new s.Mesh(ct,At),dt.frustrumCulled=!1);const a=new s.PerspectiveCamera,r=new s.Scene;r.add(dt),null===i&&(i=ht=new s.WebGLRenderer({antialias:!1}));const o=Math.min(e.image.width,t),n=Math.min(e.image.height,t);i.setSize(o,n),i.clear(),i.render(r,a);const l=document.createElement("canvas"),h=l.getContext("2d");l.width=o,l.height=n,h.drawImage(i.domElement,0,0,o,n);const c=new s.CanvasTexture(l);return c.minFilter=e.minFilter,c.magFilter=e.magFilter,c.wrapS=e.wrapS,c.wrapT=e.wrapT,c.name=e.name,ht&&(ht.forceContextLoss(),ht.dispose(),ht=null),c}const mt={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class gt{constructor(){this.pluginCallbacks=[],this.register((function(e){return new Yt(e)})),this.register((function(e){return new Xt(e)})),this.register((function(e){return new es(e)})),this.register((function(e){return new ts(e)})),this.register((function(e){return new ss(e)})),this.register((function(e){return new is(e)})),this.register((function(e){return new Zt(e)})),this.register((function(e){return new $t(e)})),this.register((function(e){return new as(e)})),this.register((function(e){return new rs(e)})),this.register((function(e){return new os(e)})),this.register((function(e){return new ns(e)})),this.register((function(e){return new ls(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){const a=new Jt,r=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)r.push(this.pluginCallbacks[e](a));a.setPlugins(r),a.write(e,t,i).catch(s)}parseAsync(e,t){const s=this;return new Promise((function(i,a){s.parse(e,i,a,t)}))}}const ft=0,bt=1,yt=2,wt=3,vt=4,Ct=5120,It=5121,xt=5122,Bt=5123,Et=5124,Mt=5125,St=5126,kt=34962,Qt=34963,Rt=9728,Tt=9729,Ft=9984,Dt=9985,Lt=9986,Pt=9987,_t=33071,Gt=33648,zt=10497,Ut="KHR_mesh_quantization",Ot={};Ot[s.NearestFilter]=Rt,Ot[s.NearestMipmapNearestFilter]=Ft,Ot[s.NearestMipmapLinearFilter]=Lt,Ot[s.LinearFilter]=Tt,Ot[s.LinearMipmapNearestFilter]=Dt,Ot[s.LinearMipmapLinearFilter]=Pt,Ot[s.ClampToEdgeWrapping]=_t,Ot[s.RepeatWrapping]=zt,Ot[s.MirroredRepeatWrapping]=Gt;const Nt={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Vt=new s.Color;function qt(e,t){return e.length===t.length&&e.every((function(e,s){return e===t[s]}))}function Ht(e){return 4*Math.ceil(e/4)}function jt(e,t=0){const s=Ht(e.byteLength);if(s!==e.byteLength){const i=new Uint8Array(s);if(i.set(new Uint8Array(e)),0!==t)for(let a=e.byteLength;a<s;a++)i[a]=t;return i.buffer}return e}function Wt(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function Kt(e,t){if(void 0!==e.toBlob)return new Promise((s=>e.toBlob(s,t)));let s;return"image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s})}class Jt{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const i=this,a=i.buffers,r=i.json;s=i.options;const o=i.extensionsUsed,n=i.extensionsRequired,l=new Blob(a,{type:"application/octet-stream"}),h=Object.keys(o),c=Object.keys(n);if(h.length>0&&(r.extensionsUsed=h),c.length>0&&(r.extensionsRequired=c),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=l.size),!0===s.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const s=jt(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,s.byteLength,!0),i.setUint32(4,5130562,!0);const a=jt((o=JSON.stringify(r),(new TextEncoder).encode(o).buffer),32);var o;const n=new DataView(new ArrayBuffer(8));n.setUint32(0,a.byteLength,!0),n.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),h=new DataView(l);h.setUint32(0,1179937895,!0),h.setUint32(4,2,!0);const c=12+n.byteLength+a.byteLength+i.byteLength+s.byteLength;h.setUint32(8,c,!0);const A=new Blob([l,n,a,i,s],{type:"application/octet-stream"}),d=new FileReader;d.readAsArrayBuffer(A),d.onloadend=function(){t(d.result)}}}else if(r.buffers&&r.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const s=e.result;r.buffers[0].uri=s,t(r)}}else t(r)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,i=this.extensionsUsed;try{const a=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&a.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in a.gltfExtensions)t.extensions[e]=a.gltfExtensions[e],i[e]=!0;delete a.gltfExtensions}Object.keys(a).length>0&&(t.extras=a)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new s.Vector3;for(let s=0,i=e.count;s<i;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const i=e.clone(),a=new s.Vector3;for(let e=0,t=i.count;e<t;e++)a.fromBufferAttribute(i,e),0===a.x&&0===a.y&&0===a.z?a.setX(1):a.normalize(),i.setXYZ(e,a.x,a.y,a.z);return t.attributesNormalized.set(e,i),i}applyTextureTransform(e,t){let s=!1;const i={};0===t.offset.x&&0===t.offset.y||(i.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(i.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(i.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function i(e){return e.colorSpace===s.SRGBColorSpace?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof s.CompressedTexture&&(e=pt(e)),t instanceof s.CompressedTexture&&(t=pt(t));const a=e?e.image:null,r=t?t.image:null,o=Math.max(a?a.width:0,r?r.width:0),n=Math.max(a?a.height:0,r?r.height:0),l=Wt();l.width=o,l.height=n;const h=l.getContext("2d");h.fillStyle="#00ffff",h.fillRect(0,0,o,n);const c=h.getImageData(0,0,o,n);if(a){h.drawImage(a,0,0,o,n);const t=i(e),s=h.getImageData(0,0,o,n).data;for(let e=2;e<s.length;e+=4)c.data[e]=256*t(s[e]/256)}if(r){h.drawImage(r,0,0,o,n);const e=i(t),s=h.getImageData(0,0,o,n).data;for(let t=1;t<s.length;t+=4)c.data[t]=256*e(s[t]/256)}h.putImageData(c,0,0);const A=(e||t).clone();return A.source=new s.Source(l),A.colorSpace=s.NoColorSpace,A.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),A}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,i,a,r){const o=this.json;let n;switch(o.bufferViews||(o.bufferViews=[]),t){case Ct:case It:n=1;break;case xt:case Bt:n=2;break;default:n=4}const l=Ht(a*e.itemSize*n),h=new DataView(new ArrayBuffer(l));let c=0;for(let r=i;r<i+a;r++)for(let i=0;i<e.itemSize;i++){let a;e.itemSize>4?a=e.array[r*e.itemSize+i]:(0===i?a=e.getX(r):1===i?a=e.getY(r):2===i?a=e.getZ(r):3===i&&(a=e.getW(r)),!0===e.normalized&&(a=s.MathUtils.normalize(a,e.array))),t===St?h.setFloat32(c,a,!0):t===Et?h.setInt32(c,a,!0):t===Mt?h.setUint32(c,a,!0):t===xt?h.setInt16(c,a,!0):t===Bt?h.setUint16(c,a,!0):t===Ct?h.setInt8(c,a):t===It&&h.setUint8(c,a),c+=n}const A={buffer:this.processBuffer(h.buffer),byteOffset:this.byteOffset,byteLength:l};void 0!==r&&(A.target=r),r===kt&&(A.byteStride=e.itemSize*n),this.byteOffset+=l,o.bufferViews.push(A);return{id:o.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise((function(i){const a=new FileReader;a.readAsArrayBuffer(e),a.onloadend=function(){const e=jt(a.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,i(s.bufferViews.push(r)-1)}}))}processAccessor(e,t,i,a){const r=this.json;let o;if(e.array.constructor===Float32Array)o=St;else if(e.array.constructor===Int32Array)o=Et;else if(e.array.constructor===Uint32Array)o=Mt;else if(e.array.constructor===Int16Array)o=xt;else if(e.array.constructor===Uint16Array)o=Bt;else if(e.array.constructor===Int8Array)o=Ct;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);o=It}if(void 0===i&&(i=0),void 0!==a&&a!==1/0||(a=e.count),0===a)return null;const n=function(e,t,i){const a={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let r=t;r<t+i;r++)for(let t=0;t<e.itemSize;t++){let i;e.itemSize>4?i=e.array[r*e.itemSize+t]:(0===t?i=e.getX(r):1===t?i=e.getY(r):2===t?i=e.getZ(r):3===t&&(i=e.getW(r)),!0===e.normalized&&(i=s.MathUtils.normalize(i,e.array))),a.min[t]=Math.min(a.min[t],i),a.max[t]=Math.max(a.max[t],i)}return a}(e,i,a);let l;void 0!==t&&(l=e===t.index?Qt:kt);const h=this.processBufferView(e,o,i,a,l),c={bufferView:h.id,byteOffset:h.byteOffset,componentType:o,count:a,max:n.max,min:n.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),r.accessors||(r.accessors=[]),r.accessors.push(c)-1}processImage(e,t,i,a="image/png"){if(null!==e){const r=this,o=r.cache,n=r.json,l=r.options,h=r.pending;o.images.has(e)||o.images.set(e,{});const c=o.images.get(e),A=a+":flipY/"+i.toString();if(void 0!==c[A])return c[A];n.images||(n.images=[]);const d={mimeType:a},u=Wt();u.width=Math.min(e.width,l.maxTextureSize),u.height=Math.min(e.height,l.maxTextureSize);const p=u.getContext("2d");if(!0===i&&(p.translate(0,u.height),p.scale(1,-1)),void 0!==e.data){t!==s.RGBAFormat&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const i=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<i.length;t+=4)i[t+0]=e.data[t+0],i[t+1]=e.data[t+1],i[t+2]=e.data[t+2],i[t+3]=e.data[t+3];p.putImageData(new ImageData(i,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement or ImageBitmap.");p.drawImage(e,0,0,u.width,u.height)}!0===l.binary?h.push(Kt(u,a).then((e=>r.processBufferViewImage(e))).then((e=>{d.bufferView=e}))):void 0!==u.toDataURL?d.uri=u.toDataURL(a):h.push(Kt(u,a).then((e=>(new FileReader).readAsDataURL(e))).then((e=>{d.uri=e})));const m=n.images.push(d)-1;return c[A]=m,m}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:Ot[e.magFilter],minFilter:Ot[e.minFilter],wrapS:Ot[e.wrapS],wrapT:Ot[e.wrapT]};return t.samplers.push(s)-1}processTexture(e){const t=this.options,i=this.cache,a=this.json;if(i.textures.has(e))return i.textures.get(e);a.textures||(a.textures=[]),e instanceof s.CompressedTexture&&(e=pt(e,t.maxTextureSize));let r=e.userData.mimeType;"image/webp"===r&&(r="image/png");const o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,r)};e.name&&(o.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,o)}));const n=a.textures.push(o)-1;return i.textures.set(e,n),n}processMaterial(e){const t=this.cache,i=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;i.materials||(i.materials=[]);const a={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const r=e.color.toArray().concat([e.opacity]);if(qt(r,[1,1,1,1])||(a.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(a.pbrMetallicRoughness.metallicFactor=e.metalness,a.pbrMetallicRoughness.roughnessFactor=e.roughness):(a.pbrMetallicRoughness.metallicFactor=.5,a.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),s={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(s,t),a.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){const t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),a.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(a.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),a.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),a.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),a.occlusionTexture=t}e.transparent?a.alphaMode="BLEND":e.alphaTest>0&&(a.alphaMode="MASK",a.alphaCutoff=e.alphaTest),e.side===s.DoubleSide&&(a.doubleSided=!0),""!==e.name&&(a.name=e.name),this.serializeUserData(e,a),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,a)}));const o=i.materials.push(a)-1;return t.materials.set(e,o),o}processMesh(e){const t=this.cache,i=this.json,a=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,s=e.material.length;t<s;t++)a.push(e.material[t].uuid);else a.push(e.material.uuid);const r=a.join(":");if(t.meshes.has(r))return t.meshes.get(r);const o=e.geometry;let n;n=e.isLineSegments?bt:e.isLineLoop?yt:e.isLine?wt:e.isPoints?ft:e.material.wireframe?bt:vt;const l={},h={},c=[],A=[],d={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},u=o.getAttribute("normal");void 0===u||this.isNormalizedNormalAttribute(u)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),o.setAttribute("normal",this.createNormalizedNormalAttribute(u)));let p=null;for(let e in o.attributes){if("morph"===e.slice(0,5))continue;const i=o.attributes[e];e=d[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(i))){h[e]=t.attributes.get(this.getUID(i));continue}p=null;const a=i.array;"JOINTS_0"!==e||a instanceof Uint16Array||a instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),p=new s.BufferAttribute(new Uint16Array(a),i.itemSize,i.normalized));const r=this.processAccessor(p||i,o);null!==r&&(e.startsWith("_")||this.detectMeshQuantization(e,i),h[e]=r,t.attributes.set(this.getUID(i),r))}if(void 0!==u&&o.setAttribute("normal",u),0===Object.keys(h).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const s=[],i=[],a={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)a[e.morphTargetDictionary[t]]=t;for(let r=0;r<e.morphTargetInfluences.length;++r){const n={};let l=!1;for(const e in o.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const s=o.morphAttributes[e][r],i=e.toUpperCase(),a=o.attributes[e];if(t.attributes.has(this.getUID(s,!0))){n[i]=t.attributes.get(this.getUID(s,!0));continue}const h=s.clone();if(!o.morphTargetsRelative)for(let e=0,t=s.count;e<t;e++)for(let t=0;t<s.itemSize;t++)0===t&&h.setX(e,s.getX(e)-a.getX(e)),1===t&&h.setY(e,s.getY(e)-a.getY(e)),2===t&&h.setZ(e,s.getZ(e)-a.getZ(e)),3===t&&h.setW(e,s.getW(e)-a.getW(e));n[i]=this.processAccessor(h,o),t.attributes.set(this.getUID(a,!0),n[i])}A.push(n),s.push(e.morphTargetInfluences[r]),void 0!==e.morphTargetDictionary&&i.push(a[r])}l.weights=s,i.length>0&&(l.extras={},l.extras.targetNames=i)}const m=Array.isArray(e.material);if(m&&0===o.groups.length)return null;let g=!1;if(m&&null===o.index){const e=[];for(let t=0,s=o.attributes.position.count;t<s;t++)e[t]=t;o.setIndex(e),g=!0}const f=m?e.material:[e.material],b=m?o.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,s=b.length;e<s;e++){const s={mode:n,attributes:h};if(this.serializeUserData(o,s),A.length>0&&(s.targets=A),null!==o.index){let i=this.getUID(o.index);void 0===b[e].start&&void 0===b[e].count||(i+=":"+b[e].start+":"+b[e].count),t.attributes.has(i)?s.indices=t.attributes.get(i):(s.indices=this.processAccessor(o.index,o,b[e].start,b[e].count),t.attributes.set(i,s.indices)),null===s.indices&&delete s.indices}const i=this.processMaterial(f[b[e].materialIndex]);null!==i&&(s.material=i),c.push(s)}!0===g&&o.setIndex(null),l.primitives=c,i.meshes||(i.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,l)}));const y=i.meshes.push(l)-1;return t.meshes.set(r,y),y}detectMeshQuantization(e,t){if(this.extensionsUsed[Ut])return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const i=e.split("_",1)[0];mt[i]&&mt[i].includes(s)&&(this.extensionsUsed[Ut]=!0,this.extensionsRequired[Ut]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const i=e.isOrthographicCamera,a={type:i?"orthographic":"perspective"};return i?a.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:a.perspective={aspectRatio:e.aspect,yfov:s.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(a.name=e.type),t.cameras.push(a)-1}processAnimation(e,t){const i=this.json,a=this.nodeMap;i.animations||(i.animations=[]);const r=(e=gt.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,o=[],n=[];for(let e=0;e<r.length;++e){const i=r[e],l=s.PropertyBinding.parseTrackName(i.name);let h=s.PropertyBinding.findNode(t,l.nodeName);const c=Nt[l.propertyName];if("bones"===l.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(l.objectIndex):void 0),!h||!c)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',i.name),null;const A=1;let d,u=i.values.length/i.times.length;c===Nt.morphTargetInfluences&&(u/=h.morphTargetInfluences.length),!0===i.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(d="CUBICSPLINE",u/=3):d=i.getInterpolation()===s.InterpolateDiscrete?"STEP":"LINEAR",n.push({input:this.processAccessor(new s.BufferAttribute(i.times,A)),output:this.processAccessor(new s.BufferAttribute(i.values,u)),interpolation:d}),o.push({sampler:n.length-1,target:{node:a.get(h),path:c}})}return i.animations.push({name:e.name||"clip_"+i.animations.length,samplers:n,channels:o}),i.animations.length-1}processSkin(e){const t=this.json,i=this.nodeMap,a=t.nodes[i.get(e)],r=e.skeleton;if(void 0===r)return null;const o=e.skeleton.bones[0];if(void 0===o)return null;const n=[],l=new Float32Array(16*r.bones.length),h=new s.Matrix4;for(let t=0;t<r.bones.length;++t)n.push(i.get(r.bones[t])),h.copy(r.boneInverses[t]),h.multiply(e.bindMatrix).toArray(l,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new s.BufferAttribute(l,16)),joints:n,skeleton:i.get(o)});return a.skin=t.skins.length-1}processNode(e){const t=this.json,s=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);const a={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),i=e.scale.toArray();qt(t,[0,0,0,1])||(a.rotation=t),qt(s,[0,0,0])||(a.translation=s),qt(i,[1,1,1])||(a.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===qt(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(a.matrix=e.matrix.elements);if(""!==e.name&&(a.name=String(e.name)),this.serializeUserData(e,a),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(a.mesh=t)}else e.isCamera&&(a.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let i=0,a=e.children.length;i<a;i++){const a=e.children[i];if(a.visible||!1===s.onlyVisible){const e=this.processNode(a);null!==e&&t.push(e)}}t.length>0&&(a.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,a)}));const r=t.nodes.push(a)-1;return i.set(e,r),r}processScene(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);const a=[];for(let t=0,i=e.children.length;t<i;t++){const i=e.children[t];if(i.visible||!1===s.onlyVisible){const e=this.processNode(i);null!==e&&a.push(e)}}a.length>0&&(i.nodes=a),this.serializeUserData(e,i)}processObjects(e){const t=new s.Scene;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const i=[];for(let t=0;t<e.length;t++)e[t]instanceof s.Scene?this.processScene(e[t]):i.push(e[t]);i.length>0&&this.processObjects(i);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}}class Yt{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const s=this.writer,i=s.json,a=s.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(1-e.penumbra)*e.angle,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),a[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},a[this.name]=!0);const o=i.extensions[this.name].lights;o.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}let Xt=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}},Zt=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const s=this.writer,i=s.extensionsUsed,a={};if(a.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:s.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(t,e.clearcoatMap),a.clearcoatTexture=t}if(a.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:s.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(t,e.clearcoatRoughnessMap),a.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:s.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};s.applyTextureTransform(t,e.clearcoatNormalMap),a.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},$t=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const s=this.writer,i=s.extensionsUsed,a={};if(a.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:s.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(t,e.iridescenceMap),a.iridescenceTexture=t}if(a.iridescenceIor=e.iridescenceIOR,a.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],a.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:s.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(t,e.iridescenceThicknessMap),a.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},es=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,i=s.extensionsUsed,a={};if(a.transmissionFactor=e.transmission,e.transmissionMap){const t={index:s.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(t,e.transmissionMap),a.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},ts=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,i=s.extensionsUsed,a={};if(a.thicknessFactor=e.thickness,e.thicknessMap){const t={index:s.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(t,e.thicknessMap),a.thicknessTexture=t}a.attenuationDistance=e.attenuationDistance,a.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},ss=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const s=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}},is=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(Vt)&&!e.specularIntensityMap&&!e.specularColorMap)return;const s=this.writer,i=s.extensionsUsed,a={};if(e.specularIntensityMap){const t={index:s.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(t,e.specularIntensityMap),a.specularTexture=t}if(e.specularColorMap){const t={index:s.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(t,e.specularColorMap),a.specularColorTexture=t}a.specularFactor=e.specularIntensity,a.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},as=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const s=this.writer,i=s.extensionsUsed,a={};if(e.sheenRoughnessMap){const t={index:s.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(t,e.sheenRoughnessMap),a.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:s.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(t,e.sheenColorMap),a.sheenColorTexture=t}a.sheenRoughnessFactor=e.sheenRoughness,a.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},rs=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const s=this.writer,i=s.extensionsUsed,a={};if(e.anisotropyMap){const t={index:s.processTexture(e.anisotropyMap)};s.applyTextureTransform(t,e.anisotropyMap),a.anisotropyTexture=t}a.anisotropyStrength=e.anisotropy,a.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},os=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const s=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}},ns=class{constructor(e){this.writer=e,this.name="EXT_materials_bump"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const s=this.writer,i=s.extensionsUsed,a={};if(e.bumpMap){const t={index:s.processTexture(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(t,e.bumpMap),a.bumpTexture=t}a.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},ls=class{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const i=this.writer,a=e,r=new Float32Array(3*a.count),o=new Float32Array(4*a.count),n=new Float32Array(3*a.count),l=new s.Matrix4,h=new s.Vector3,c=new s.Quaternion,A=new s.Vector3;for(let e=0;e<a.count;e++)a.getMatrixAt(e,l),l.decompose(h,c,A),h.toArray(r,3*e),c.toArray(o,4*e),A.toArray(n,3*e);const d={TRANSLATION:i.processAccessor(new s.BufferAttribute(r,3)),ROTATION:i.processAccessor(new s.BufferAttribute(o,4)),SCALE:i.processAccessor(new s.BufferAttribute(n,3))};a.instanceColor&&(d._COLOR_0=i.processAccessor(a.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:d},i.extensionsUsed[this.name]=!0,i.extensionsRequired[this.name]=!0}};function hs(e){const t=new Map,s=new Map,i=e.clone();return cs(e,i,(function(e,i){t.set(i,e),s.set(e,i)})),i.traverse((function(e){if(!e.isSkinnedMesh)return;const i=e,a=t.get(e),r=a.skeleton.bones;i.skeleton=a.skeleton.clone(),i.bindMatrix.copy(a.bindMatrix),i.skeleton.bones=r.map((function(e){return s.get(e)})),i.bind(i.skeleton,i.bindMatrix)})),i}function cs(e,t,s){s(e,t);for(let i=0;i<e.children.length;i++)cs(e.children[i],t.children[i],s)}gt.Utils={insertKeyframe:function(e,t){const s=.001,i=e.getValueSize(),a=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+i),o=e.createInterpolant(new e.ValueBufferType(i));let n;if(0===e.times.length){a[0]=t;for(let e=0;e<i;e++)r[e]=0;n=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;a[0]=t,a.set(e.times,1),r.set(o.evaluate(t),0),r.set(e.values,i),n=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;a[a.length-1]=t,a.set(e.times,0),r.set(e.values,0),r.set(o.evaluate(t),e.values.length),n=a.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){a.set(e.times.slice(0,l+1),0),a[l+1]=t,a.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*i),0),r.set(o.evaluate(t),(l+1)*i),r.set(e.values.slice((l+1)*i),(l+2)*i),n=l+1;break}}return e.times=a,e.values=r,n},mergeMorphTargetTracks:function(e,t){const i=[],a={},r=e.tracks;for(let e=0;e<r.length;++e){let o=r[e];const n=s.PropertyBinding.parseTrackName(o.name),l=s.PropertyBinding.findNode(t,n.nodeName);if("morphTargetInfluences"!==n.propertyName||void 0===n.propertyIndex){i.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),o=o.clone(),o.setInterpolation(s.InterpolateLinear)}const h=l.morphTargetInfluences.length,c=l.morphTargetDictionary[n.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+n.propertyIndex);let A;if(void 0===a[l.uuid]){A=o.clone();const e=new A.ValueBufferType(h*A.times.length);for(let t=0;t<A.times.length;t++)e[t*h+c]=A.values[t];A.name=(n.nodeName||"")+".morphTargetInfluences",A.values=e,a[l.uuid]=A,i.push(A);continue}const d=o.createInterpolant(new o.ValueBufferType(1));A=a[l.uuid];for(let e=0;e<A.times.length;e++)A.values[e*h+c]=d.evaluate(A.times[e]);for(let e=0;e<o.times.length;e++){const t=this.insertKeyframe(A,o.times[e]);A.values[t*h+c]=o.values[e]}}return e.tracks=i,e}};class As extends s.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new fs(e)})),this.register((function(e){return new bs(e)})),this.register((function(e){return new Ms(e)})),this.register((function(e){return new Ss(e)})),this.register((function(e){return new ks(e)})),this.register((function(e){return new ws(e)})),this.register((function(e){return new vs(e)})),this.register((function(e){return new Cs(e)})),this.register((function(e){return new Is(e)})),this.register((function(e){return new gs(e)})),this.register((function(e){return new xs(e)})),this.register((function(e){return new ys(e)})),this.register((function(e){return new Es(e)})),this.register((function(e){return new Bs(e)})),this.register((function(e){return new ps(e)})),this.register((function(e){return new Qs(e)})),this.register((function(e){return new Rs(e)}))}load(e,t,i,a){const r=this;let o;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){const t=s.LoaderUtils.extractUrlBase(e);o=s.LoaderUtils.resolveURL(t,this.path)}else o=s.LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const n=function(t){a?a(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},l=new s.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(s){try{r.parse(s,o,(function(s){t(s),r.manager.itemEnd(e)}),n)}catch(e){n(e)}}),i,n)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let a;const r={},o={},n=new TextDecoder;if("string"==typeof e)a=JSON.parse(e);else if(e instanceof ArrayBuffer){if(n.decode(new Uint8Array(e,0,4))===Ts){try{r[us.KHR_BINARY_GLTF]=new Ls(e)}catch(e){return void(i&&i(e))}a=JSON.parse(r[us.KHR_BINARY_GLTF].content)}else a=JSON.parse(n.decode(e))}else a=e;if(void 0===a.asset||a.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new oi(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[t.name]=t,r[t.name]=!0}if(a.extensionsUsed)for(let e=0;e<a.extensionsUsed.length;++e){const t=a.extensionsUsed[e],s=a.extensionsRequired||[];switch(t){case us.KHR_MATERIALS_UNLIT:r[t]=new ms;break;case us.KHR_DRACO_MESH_COMPRESSION:r[t]=new Ps(a,this.dracoLoader);break;case us.KHR_TEXTURE_TRANSFORM:r[t]=new _s;break;case us.KHR_MESH_QUANTIZATION:r[t]=new Gs;break;default:s.indexOf(t)>=0&&void 0===o[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(r),l.setPlugins(o),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise((function(i,a){s.parse(e,t,i,a)}))}}function ds(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const us={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ps{constructor(e){this.parser=e,this.name=us.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let a=t.cache.get(i);if(a)return a;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let n;const l=new s.Color(16777215);void 0!==o.color&&l.setRGB(o.color[0],o.color[1],o.color[2],s.LinearSRGBColorSpace);const h=void 0!==o.range?o.range:0;switch(o.type){case"directional":n=new s.DirectionalLight(l),n.target.position.set(0,0,-1),n.add(n.target);break;case"point":n=new s.PointLight(l),n.distance=h;break;case"spot":n=new s.SpotLight(l),n.distance=h,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,n.angle=o.spot.outerConeAngle,n.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,n.target.position.set(0,0,-1),n.add(n.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return n.position.set(0,0,0),ei(n,o),void 0!==o.intensity&&(n.intensity=o.intensity),n.name=t.createUniqueName(o.name||"light_"+e),a=Promise.resolve(n),t.cache.add(i,a),a}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],a=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return s._getNodeRef(t.cache,a,e)}))}}class ms{constructor(){this.name=us.KHR_MATERIALS_UNLIT}getMaterialType(){return s.MeshBasicMaterial}extendParams(e,t,i){const a=[];e.color=new s.Color(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],s.LinearSRGBColorSpace),e.opacity=t[3]}void 0!==r.baseColorTexture&&a.push(i.assignTexture(e,"map",r.baseColorTexture,s.SRGBColorSpace))}return Promise.all(a)}}class gs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class fs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,a=i.json.materials[e];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();const r=[],o=a.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new s.Vector2(e,e)}return Promise.all(r)}}class bs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class ys{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],r=i.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&a.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&a.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(a)}}class ws{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,a=i.json.materials[e];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new s.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=a.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],s.LinearSRGBColorSpace)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&r.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,s.SRGBColorSpace)),void 0!==o.sheenRoughnessTexture&&r.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class vs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],r=i.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)}}class Cs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,a=i.json.materials[e];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();const r=[],o=a.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&r.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const n=o.attenuationColor||[1,1,1];return t.attenuationColor=(new s.Color).setRGB(n[0],n[1],n[2],s.LinearSRGBColorSpace),Promise.all(r)}}class Is{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class xs{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,a=i.json.materials[e];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();const r=[],o=a.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&r.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const n=o.specularColorFactor||[1,1,1];return t.specularColor=(new s.Color).setRGB(n[0],n[1],n[2],s.LinearSRGBColorSpace),void 0!==o.specularColorTexture&&r.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,s.SRGBColorSpace)),Promise.all(r)}}class Bs{constructor(e){this.parser=e,this.name=us.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],r=i.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&a.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(a)}}class Es{constructor(e){this.parser=e,this.name=us.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],r=i.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&a.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(a)}}class Ms{constructor(e){this.parser=e,this.name=us.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const a=i.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,a.source,r)}}class Ss{constructor(e){this.parser=e,this.name=us.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,a=i.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],o=i.images[r.source];let n=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(n=e)}return this.detectSupport().then((function(a){if(a)return s.loadTextureImage(e,r.source,n);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class ks{constructor(e){this.parser=e,this.name=us.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,a=i.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],o=i.images[r.source];let n=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(n=e)}return this.detectSupport().then((function(a){if(a)return s.loadTextureImage(e,r.source,n);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Qs{constructor(e){this.name=us.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const s=e.byteOffset||0,i=e.byteLength||0,r=e.count,o=e.byteStride,n=new Uint8Array(t,s,i);return a.decodeGltfBufferAsync?a.decodeGltfBufferAsync(r,o,n,e.mode,e.filter).then((function(e){return e.buffer})):a.ready.then((function(){const t=new ArrayBuffer(r*o);return a.decodeGltfBuffer(new Uint8Array(t),r,o,n,e.mode,e.filter),t}))}))}return null}}class Rs{constructor(e){this.name=us.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const a=t.meshes[i.mesh];for(const e of a.primitives)if(e.mode!==Ns.TRIANGLES&&e.mode!==Ns.TRIANGLE_STRIP&&e.mode!==Ns.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=i.extensions[this.name].attributes,o=[],n={};for(const e in r)o.push(this.parser.getDependency("accessor",r[e]).then((t=>(n[e]=t,n[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),i=t.isGroup?t.children:[t],a=e[0].count,r=[];for(const e of i){const t=new s.Matrix4,i=new s.Vector3,o=new s.Quaternion,l=new s.Vector3(1,1,1),h=new s.InstancedMesh(e.geometry,e.material,a);for(let e=0;e<a;e++)n.TRANSLATION&&i.fromBufferAttribute(n.TRANSLATION,e),n.ROTATION&&o.fromBufferAttribute(n.ROTATION,e),n.SCALE&&l.fromBufferAttribute(n.SCALE,e),h.setMatrixAt(e,t.compose(i,o,l));for(const t in n)if("_COLOR_0"===t){const e=n[t];h.instanceColor=new s.InstancedBufferAttribute(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,n[t]);s.Object3D.prototype.copy.call(h,e),this.parser.assignFinalMaterial(h),r.push(h)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const Ts="glTF",Fs=1313821514,Ds=5130562;class Ls{constructor(e){this.name=us.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Ts)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,a=new DataView(e,12);let r=0;for(;r<i;){const t=a.getUint32(r,!0);r+=4;const i=a.getUint32(r,!0);if(r+=4,i===Fs){const i=new Uint8Array(e,12+r,t);this.content=s.decode(i)}else if(i===Ds){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ps{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=us.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,a=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,n={},l={},h={};for(const e in o){const t=Ws[e]||e.toLowerCase();n[t]=o[e]}for(const t in e.attributes){const s=Ws[t]||t.toLowerCase();if(void 0!==o[t]){const a=i.accessors[e.attributes[t]],r=Vs[a.componentType];h[s]=r.name,l[s]=!0===a.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t,i){a.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],i=l[t];void 0!==i&&(s.normalized=i)}t(e)}),n,h,s.LinearSRGBColorSpace,i)}))}))}}class _s{constructor(){this.name=us.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Gs{constructor(){this.name=us.KHR_MESH_QUANTIZATION}}class zs extends s.Interpolant{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,a=e*i*3+i;for(let e=0;e!==i;e++)t[e]=s[a+e];return t}interpolate_(e,t,s,i){const a=this.resultBuffer,r=this.sampleValues,o=this.valueSize,n=2*o,l=3*o,h=i-t,c=(s-t)/h,A=c*c,d=A*c,u=e*l,p=u-l,m=-2*d+3*A,g=d-A,f=1-m,b=g-A+c;for(let e=0;e!==o;e++){const t=r[p+e+o],s=r[p+e+n]*h,i=r[u+e+o],l=r[u+e]*h;a[e]=f*t+b*s+m*i+g*l}return a}}const Us=new s.Quaternion;class Os extends zs{interpolate_(e,t,s,i){const a=super.interpolate_(e,t,s,i);return Us.fromArray(a).normalize().toArray(a),a}}const Ns={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Vs={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},qs={9728:s.NearestFilter,9729:s.LinearFilter,9984:s.NearestMipmapNearestFilter,9985:s.LinearMipmapNearestFilter,9986:s.NearestMipmapLinearFilter,9987:s.LinearMipmapLinearFilter},Hs={33071:s.ClampToEdgeWrapping,33648:s.MirroredRepeatWrapping,10497:s.RepeatWrapping},js={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ws={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ks={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Js={CUBICSPLINE:void 0,LINEAR:s.InterpolateLinear,STEP:s.InterpolateDiscrete},Ys="OPAQUE",Xs="MASK",Zs="BLEND";function $s(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function ei(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ti(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function si(e){let t;const s=e.extensions&&e.extensions[us.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+ii(s.attributes):e.indices+":"+ii(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,i=e.targets.length;s<i;s++)t+=":"+ii(e.targets[s]);return t}function ii(e){let t="";const s=Object.keys(e).sort();for(let i=0,a=s.length;i<a;i++)t+=s[i]+":"+e[s[i]]+";";return t}function ai(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ri=new s.Matrix4;class oi{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ds,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,a=-1,r=!1,o=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;i=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);a=i&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,o=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||i&&a<17||r&&o<98?this.textureLoader=new s.TextureLoader(this.options.manager):this.textureLoader=new s.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new s.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,a=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const r={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};return $s(a,r,i),ei(r,i),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s].joints;for(let t=0,s=i.length;t<s;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(s[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),a=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[s,i]of e.children.entries())a(i,t.children[s])};return a(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const a=e(t[i]);a&&s.push(a)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return s.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[us.KHR_BINARY_GLTF].body);const a=this.options;return new Promise((function(e,r){i.load(s.LoaderUtils.resolveURL(t.uri,a.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)}))}loadAccessor(e){const t=this,i=this.json,a=this.json.accessors[e];if(void 0===a.bufferView&&void 0===a.sparse){const e=js[a.type],t=Vs[a.componentType],i=!0===a.normalized,r=new t(a.count*e);return Promise.resolve(new s.BufferAttribute(r,e,i))}const r=[];return void 0!==a.bufferView?r.push(this.getDependency("bufferView",a.bufferView)):r.push(null),void 0!==a.sparse&&(r.push(this.getDependency("bufferView",a.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",a.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],o=js[a.type],n=Vs[a.componentType],l=n.BYTES_PER_ELEMENT,h=l*o,c=a.byteOffset||0,A=void 0!==a.bufferView?i.bufferViews[a.bufferView].byteStride:void 0,d=!0===a.normalized;let u,p;if(A&&A!==h){const e=Math.floor(c/A),i="InterleavedBuffer:"+a.bufferView+":"+a.componentType+":"+e+":"+a.count;let h=t.cache.get(i);h||(u=new n(r,e*A,a.count*A/l),h=new s.InterleavedBuffer(u,A/l),t.cache.add(i,h)),p=new s.InterleavedBufferAttribute(h,o,c%A/l,d)}else u=null===r?new n(a.count*o):new n(r,c,a.count*o),p=new s.BufferAttribute(u,o,d);if(void 0!==a.sparse){const t=js.SCALAR,i=Vs[a.sparse.indices.componentType],l=a.sparse.indices.byteOffset||0,h=a.sparse.values.byteOffset||0,c=new i(e[1],l,a.sparse.count*t),A=new n(e[2],h,a.sparse.count*o);null!==r&&(p=new s.BufferAttribute(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(p.setX(t,A[e*o]),o>=2&&p.setY(t,A[e*o+1]),o>=3&&p.setZ(t,A[e*o+2]),o>=4&&p.setW(t,A[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=d}return p}))}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,a=t.images[i];let r=this.textureLoader;if(a.uri){const e=s.manager.getHandler(a.uri);null!==e&&(r=e)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,i){const a=this,r=this.json,o=r.textures[e],n=r.images[t],l=(n.uri||n.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const h=this.loadImageSource(t,i).then((function(t){t.flipY=!1,t.name=o.name||n.name||"",""===t.name&&"string"==typeof n.uri&&!1===n.uri.startsWith("data:image/")&&(t.name=n.uri);const i=(r.samplers||{})[o.sampler]||{};return t.magFilter=qs[i.magFilter]||s.LinearFilter,t.minFilter=qs[i.minFilter]||s.LinearMipmapLinearFilter,t.wrapS=Hs[i.wrapS]||s.RepeatWrapping,t.wrapT=Hs[i.wrapT]||s.RepeatWrapping,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==s.NearestFilter&&t.minFilter!==s.LinearFilter,a.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[l]=h,h}loadImageSource(e,t){const i=this,a=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=a.images[e],n=self.URL||self.webkitURL;let l=o.uri||"",h=!1;if(void 0!==o.bufferView)l=i.getDependency("bufferView",o.bufferView).then((function(e){h=!0;const t=new Blob([e],{type:o.mimeType});return l=n.createObjectURL(t),l}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(l).then((function(e){return new Promise((function(i,a){let o=i;!0===t.isImageBitmapLoader&&(o=function(e){const t=new s.Texture(e);t.needsUpdate=!0,i(t)}),t.load(s.LoaderUtils.resolveURL(e,r.path),o,void 0,a)}))})).then((function(e){var t;return!0===h&&n.revokeObjectURL(l),ei(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),e}));return this.sourceCache[e]=c,c}assignTexture(e,t,s,i){const a=this;return this.getDependency("texture",s.index).then((function(r){if(!r)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((r=r.clone()).channel=s.texCoord),a.extensions[us.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[us.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=a.associations.get(r);r=a.extensions[us.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),a.associations.set(r,t)}}return void 0!==i&&(r.colorSpace=i),e[t]=r,r}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const a=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new s.PointsMaterial,s.Material.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new s.LineBasicMaterial,s.Material.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(e,t)),i=t}if(a||r||o){let e="ClonedMaterial:"+i.uuid+":";a&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),a&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}e.material=i}getMaterialType(){return s.MeshStandardMaterial}loadMaterial(e){const t=this,i=this.json,a=this.extensions,r=i.materials[e];let o;const n={},l=[];if((r.extensions||{})[us.KHR_MATERIALS_UNLIT]){const e=a[us.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),l.push(e.extendParams(n,r,t))}else{const i=r.pbrMetallicRoughness||{};if(n.color=new s.Color(1,1,1),n.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;n.color.setRGB(e[0],e[1],e[2],s.LinearSRGBColorSpace),n.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(t.assignTexture(n,"map",i.baseColorTexture,s.SRGBColorSpace)),n.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,n.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(t.assignTexture(n,"metalnessMap",i.metallicRoughnessTexture)),l.push(t.assignTexture(n,"roughnessMap",i.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,n)}))))}!0===r.doubleSided&&(n.side=s.DoubleSide);const h=r.alphaMode||Ys;if(h===Zs?(n.transparent=!0,n.depthWrite=!1):(n.transparent=!1,h===Xs&&(n.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&o!==s.MeshBasicMaterial&&(l.push(t.assignTexture(n,"normalMap",r.normalTexture)),n.normalScale=new s.Vector2(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;n.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&o!==s.MeshBasicMaterial&&(l.push(t.assignTexture(n,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(n.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&o!==s.MeshBasicMaterial){const e=r.emissiveFactor;n.emissive=(new s.Color).setRGB(e[0],e[1],e[2],s.LinearSRGBColorSpace)}return void 0!==r.emissiveTexture&&o!==s.MeshBasicMaterial&&l.push(t.assignTexture(n,"emissiveMap",r.emissiveTexture,s.SRGBColorSpace)),Promise.all(l).then((function(){const s=new o(n);return r.name&&(s.name=r.name),ei(s,r),t.associations.set(s,{materials:e}),r.extensions&&$s(a,s,r),s}))}createUniqueName(e){const t=s.PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,a=this.primitiveCache;function r(e){return i[us.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return ni(s,e,t)}))}const o=[];for(let i=0,n=e.length;i<n;i++){const n=e[i],l=si(n),h=a[l];if(h)o.push(h.promise);else{let e;e=n.extensions&&n.extensions[us.KHR_DRACO_MESH_COMPRESSION]?r(n):ni(new s.BufferGeometry,n,t),a[l]={primitive:n,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,a=this.extensions,r=i.meshes[e],o=r.primitives,n=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new s.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:s.FrontSide})),l.DefaultMaterial):this.getDependency("material",o[e].material);n.push(t)}var l;return n.push(t.loadGeometries(o)),Promise.all(n).then((function(i){const n=i.slice(0,i.length-1),l=i[i.length-1],h=[];for(let i=0,c=l.length;i<c;i++){const c=l[i],A=o[i];let d;const u=n[i];if(A.mode===Ns.TRIANGLES||A.mode===Ns.TRIANGLE_STRIP||A.mode===Ns.TRIANGLE_FAN||void 0===A.mode)d=!0===r.isSkinnedMesh?new s.SkinnedMesh(c,u):new s.Mesh(c,u),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),A.mode===Ns.TRIANGLE_STRIP?d.geometry=Be(d.geometry,s.TriangleStripDrawMode):A.mode===Ns.TRIANGLE_FAN&&(d.geometry=Be(d.geometry,s.TriangleFanDrawMode));else if(A.mode===Ns.LINES)d=new s.LineSegments(c,u);else if(A.mode===Ns.LINE_STRIP)d=new s.Line(c,u);else if(A.mode===Ns.LINE_LOOP)d=new s.LineLoop(c,u);else{if(A.mode!==Ns.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+A.mode);d=new s.Points(c,u)}Object.keys(d.geometry.morphAttributes).length>0&&ti(d,r),d.name=t.createUniqueName(r.name||"mesh_"+e),ei(d,r),A.extensions&&$s(a,d,A),t.assignFinalMaterial(d),h.push(d)}for(let s=0,i=h.length;s<i;s++)t.associations.set(h[s],{meshes:e,primitives:s});if(1===h.length)return r.extensions&&$s(a,h[0],r),h[0];const c=new s.Group;r.extensions&&$s(a,c,r),t.associations.set(c,{meshes:e});for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c}))}loadCamera(e){let t;const i=this.json.cameras[e],a=i[i.type];if(a)return"perspective"===i.type?t=new s.PerspectiveCamera(s.MathUtils.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===i.type&&(t=new s.OrthographicCamera(-a.xmag,a.xmag,a.ymag,-a.ymag,a.znear,a.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),ei(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],i=[];for(let e=0,s=t.joints.length;e<s;e++)i.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then((function(e){const i=e.pop(),a=e,r=[],o=[];for(let e=0,n=a.length;e<n;e++){const n=a[e];if(n){r.push(n);const t=new s.Matrix4;null!==i&&t.fromArray(i.array,16*e),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new s.Skeleton(r,o)}))}loadAnimation(e){const t=this.json,i=this,a=t.animations[e],r=a.name?a.name:"animation_"+e,o=[],n=[],l=[],h=[],c=[];for(let e=0,t=a.channels.length;e<t;e++){const t=a.channels[e],s=a.samplers[t.sampler],i=t.target,r=i.node,A=void 0!==a.parameters?a.parameters[s.input]:s.input,d=void 0!==a.parameters?a.parameters[s.output]:s.output;void 0!==i.node&&(o.push(this.getDependency("node",r)),n.push(this.getDependency("accessor",A)),l.push(this.getDependency("accessor",d)),h.push(s),c.push(i))}return Promise.all([Promise.all(o),Promise.all(n),Promise.all(l),Promise.all(h),Promise.all(c)]).then((function(e){const t=e[0],a=e[1],o=e[2],n=e[3],l=e[4],h=[];for(let e=0,s=t.length;e<s;e++){const s=t[e],r=a[e],c=o[e],A=n[e],d=l[e];if(void 0===s)continue;s.updateMatrix&&s.updateMatrix();const u=i._createAnimationTracks(s,r,c,A,d);if(u)for(let e=0;e<u.length;e++)h.push(u[e])}return new s.AnimationClip(r,void 0,h)}))}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,s=this.json.nodes[e],i=t._loadNodeShallow(e),a=[],r=s.children||[];for(let e=0,s=r.length;e<s;e++)a.push(t.getDependency("node",r[e]));const o=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([i,Promise.all(a),o]).then((function(e){const t=e[0],s=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,ri)}));for(let e=0,i=s.length;e<i;e++)t.add(s[e]);return t}))}_loadNodeShallow(e){const t=this.json,i=this.extensions,a=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],o=r.name?a.createUniqueName(r.name):"",n=[],l=a._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return l&&n.push(l),void 0!==r.camera&&n.push(a.getDependency("camera",r.camera).then((function(e){return a._getNodeRef(a.cameraCache,r.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){n.push(e)})),this.nodeCache[e]=Promise.all(n).then((function(t){let n;if(n=!0===r.isBone?new s.Bone:t.length>1?new s.Group:1===t.length?t[0]:new s.Object3D,n!==t[0])for(let e=0,s=t.length;e<s;e++)n.add(t[e]);if(r.name&&(n.userData.name=r.name,n.name=o),ei(n,r),r.extensions&&$s(i,n,r),void 0!==r.matrix){const e=new s.Matrix4;e.fromArray(r.matrix),n.applyMatrix4(e)}else void 0!==r.translation&&n.position.fromArray(r.translation),void 0!==r.rotation&&n.quaternion.fromArray(r.rotation),void 0!==r.scale&&n.scale.fromArray(r.scale);return a.associations.has(n)||a.associations.set(n,{}),a.associations.get(n).nodes=e,n})),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],a=this,r=new s.Group;i.name&&(r.name=a.createUniqueName(i.name)),ei(r,i),i.extensions&&$s(t,r,i);const o=i.nodes||[],n=[];for(let e=0,t=o.length;e<t;e++)n.push(a.getDependency("node",o[e]));return Promise.all(n).then((function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return a.associations=(e=>{const t=new Map;for(const[e,i]of a.associations)(e instanceof s.Material||e instanceof s.Texture)&&t.set(e,i);return e.traverse((e=>{const s=a.associations.get(e);null!=s&&t.set(e,s)})),t})(r),r}))}_createAnimationTracks(e,t,i,a,r){const o=[],n=e.name?e.name:e.uuid,l=[];let h;switch(Ks[r.path]===Ks.weights?e.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(n),Ks[r.path]){case Ks.weights:h=s.NumberKeyframeTrack;break;case Ks.rotation:h=s.QuaternionKeyframeTrack;break;case Ks.position:case Ks.scale:h=s.VectorKeyframeTrack;break;default:if(1===i.itemSize)h=s.NumberKeyframeTrack;else h=s.VectorKeyframeTrack}const c=void 0!==a.interpolation?Js[a.interpolation]:s.InterpolateLinear,A=this._getArrayFromAccessor(i);for(let e=0,s=l.length;e<s;e++){const s=new h(l[e]+"."+Ks[r.path],t.array,A,c);"CUBICSPLINE"===a.interpolation&&this._createCubicSplineTrackInterpolant(s),o.push(s)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=ai(t.constructor),s=new Float32Array(t.length);for(let i=0,a=t.length;i<a;i++)s[i]=t[i]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof s.QuaternionKeyframeTrack?Os:zs)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ni(e,t,i){const a=t.attributes,r=[];function o(t,s){return i.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(const t in a){const s=Ws[t]||t.toLowerCase();s in e.attributes||r.push(o(a[t],s))}if(void 0!==t.indices&&!e.index){const s=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(s)}return s.ColorManagement.workingColorSpace!==s.LinearSRGBColorSpace&&"COLOR_0"in a&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${s.ColorManagement.workingColorSpace}" not supported.`),ei(e,t),function(e,t,i){const a=t.attributes,r=new s.Box3;if(void 0===a.POSITION)return;{const e=i.json.accessors[a.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new s.Vector3(t[0],t[1],t[2]),new s.Vector3(o[0],o[1],o[2])),e.normalized){const t=ai(Vs[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new s.Vector3,t=new s.Vector3;for(let s=0,a=o.length;s<a;s++){const a=o[s];if(void 0!==a.POSITION){const s=i.json.accessors[a.POSITION],r=s.min,o=s.max;if(void 0!==r&&void 0!==o){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(o[2]))),s.normalized){const e=ai(Vs[s.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const n=new s.Sphere;r.getCenter(n.center),n.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=n}(e,t,i),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,s){let i=!1,a=!1,r=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(i=!0),void 0!==s.NORMAL&&(a=!0),void 0!==s.COLOR_0&&(r=!0),i&&a&&r)break}if(!i&&!a&&!r)return Promise.resolve(e);const o=[],n=[],l=[];for(let h=0,c=t.length;h<c;h++){const c=t[h];if(i){const t=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;o.push(t)}if(a){const t=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal;n.push(t)}if(r){const t=void 0!==c.COLOR_0?s.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(o),Promise.all(n),Promise.all(l)]).then((function(t){const s=t[0],o=t[1],n=t[2];return i&&(e.morphAttributes.position=s),a&&(e.morphAttributes.normal=o),r&&(e.morphAttributes.color=n),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}const li=new WeakMap;class hi extends s.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,a){const r=new s.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{this.parse(e,t,a)}),i,a)}parse(e,t,i){this.decodeDracoFile(e,t,null,null,s.SRGBColorSpace).catch(i)}decodeDracoFile(e,t,i,a,r=s.LinearSRGBColorSpace){const o={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:a||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:r};return this.decodeGeometry(e,o).then(t)}decodeGeometry(e,t){const s=JSON.stringify(t);if(li.has(e)){const t=li.get(e);if(t.key===s)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const a=this.workerNextTaskID++,r=e.byteLength,o=this._getWorker(a,r).then((s=>(i=s,new Promise(((s,r)=>{i._callbacks[a]={resolve:s,reject:r},i.postMessage({type:"decode",id:a,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return o.catch((()=>!0)).then((()=>{i&&a&&this._releaseTask(i,a)})),li.set(e,{key:s,promise:o}),o}_createGeometry(e){const t=new s.BufferGeometry;e.index&&t.setIndex(new s.BufferAttribute(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const a=e.attributes[i],r=a.name,o=a.array,n=a.itemSize,l=new s.BufferAttribute(o,n);"color"===r&&(this._assignVertexColorSpace(l,a.vertexColorSpace),l.normalized=o instanceof Float32Array==!1),t.setAttribute(r,l)}return t}_assignVertexColorSpace(e,t){if(t!==s.SRGBColorSpace)return;const i=new s.Color;for(let t=0,s=e.count;t<s;t++)i.fromBufferAttribute(e,t).convertSRGBToLinear(),e.setXYZ(t,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new s.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise(((t,s)=>{i.load(e,t,void 0,s)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?e.push(this._loadLibrary("draco_decoder.js","text")):e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(e).then((e=>{const t=e[0],s=ci.toString(),i=["/* draco decoder */",t,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const s=t.data;switch(s.type){case"decode":e._callbacks[s.id].resolve(s);break;case"error":e._callbacks[s.id].reject(s);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+s.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function ci(){let e,t;function s(e,t,s,i,a,r){const o=r.num_components(),n=s.num_points()*o,l=n*a.BYTES_PER_ELEMENT,h=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(s,r,h,l,c);const A=new a(e.HEAPF32.buffer,c,n).slice();return e._free(c),{name:i,array:A,itemSize:o}}onmessage=function(i){const a=i.data;switch(a.type){case"init":e=a.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const i=a.buffer,r=a.taskConfig;t.then((e=>{const t=e.draco,o=new t.Decoder;try{const e=function(e,t,i,a){const r=a.attributeIDs,o=a.attributeTypes;let n,l;const h=t.GetEncodedGeometryType(i);if(h===e.TRIANGULAR_MESH)n=new e.Mesh,l=t.DecodeArrayToMesh(i,i.byteLength,n);else{if(h!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new e.PointCloud,l=t.DecodeArrayToPointCloud(i,i.byteLength,n)}if(!l.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const i in r){const l=self[o[i]];let h,A;if(a.useUniqueIDs)A=r[i],h=t.GetAttributeByUniqueId(n,A);else{if(A=t.GetAttributeId(n,e[r[i]]),-1===A)continue;h=t.GetAttribute(n,A)}const d=s(e,t,n,i,l,h);"color"===i&&(d.vertexColorSpace=a.vertexColorSpace),c.attributes.push(d)}h===e.TRIANGULAR_MESH&&(c.index=function(e,t,s){const i=s.num_faces(),a=3*i,r=4*a,o=e._malloc(r);t.GetTrianglesUInt32Array(s,r,o);const n=new Uint32Array(e.HEAPF32.buffer,o,a).slice();return e._free(o),{array:n,itemSize:1}}(e,t,n));return e.destroy(n),c}(t,o,new Int8Array(i),r),n=e.attributes.map((e=>e.array.buffer));e.index&&n.push(e.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:e},n)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{t.destroy(o)}}))}}}
/*!
    fflate - fast JavaScript compression/decompression
    <https://101arrowz.github.io/fflate>
    Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
    version 0.6.9
    */var Ai=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};try{URL.revokeObjectURL(Ai(""))}catch(e){Ai=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var di=Uint8Array,ui=Uint16Array,pi=Uint32Array,mi=new di([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),gi=new di([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),fi=new di([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),bi=function(e,t){for(var s=new ui(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];var a=new pi(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)a[r]=r-s[i]<<5|i;return[s,a]},yi=bi(mi,2),wi=yi[0],vi=yi[1];wi[28]=258,vi[258]=28;for(var Ci=bi(gi,0)[0],Ii=new ui(32768),xi=0;xi<32768;++xi){var Bi=(43690&xi)>>>1|(21845&xi)<<1;Bi=(61680&(Bi=(52428&Bi)>>>2|(13107&Bi)<<2))>>>4|(3855&Bi)<<4,Ii[xi]=((65280&Bi)>>>8|(255&Bi)<<8)>>>1}var Ei=function(e,t,s){for(var i=e.length,a=0,r=new ui(t);a<i;++a)++r[e[a]-1];var o,n=new ui(t);for(a=0;a<t;++a)n[a]=n[a-1]+r[a-1]<<1;if(s){o=new ui(1<<t);var l=15-t;for(a=0;a<i;++a)if(e[a])for(var h=a<<4|e[a],c=t-e[a],A=n[e[a]-1]++<<c,d=A|(1<<c)-1;A<=d;++A)o[Ii[A]>>>l]=h}else for(o=new ui(i),a=0;a<i;++a)e[a]&&(o[a]=Ii[n[e[a]-1]++]>>>15-e[a]);return o},Mi=new di(288);for(xi=0;xi<144;++xi)Mi[xi]=8;for(xi=144;xi<256;++xi)Mi[xi]=9;for(xi=256;xi<280;++xi)Mi[xi]=7;for(xi=280;xi<288;++xi)Mi[xi]=8;var Si=new di(32);for(xi=0;xi<32;++xi)Si[xi]=5;var ki=Ei(Mi,9,1),Qi=Ei(Si,5,1),Ri=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},Ti=function(e,t,s){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&s},Fi=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},Di=function(e){return(e/8|0)+(7&e&&1)},Li=function(e,t,s){var i=e.length;if(!i||s&&!s.l&&i<5)return t||new di(0);var a=!t||s,r=!s||s.i;s||(s={}),t||(t=new di(3*i));var o=function(e){var s=t.length;if(e>s){var i=new di(Math.max(2*s,e));i.set(t),t=i}},n=s.f||0,l=s.p||0,h=s.b||0,c=s.l,A=s.d,d=s.m,u=s.n,p=8*i;do{if(!c){s.f=n=Ti(e,l,1);var m=Ti(e,l+1,3);if(l+=3,!m){var g=e[(M=Di(l)+4)-4]|e[M-3]<<8,f=M+g;if(f>i){if(r)throw"unexpected EOF";break}a&&o(h+g),t.set(e.subarray(M,f),h),s.b=h+=g,s.p=l=8*f;continue}if(1==m)c=ki,A=Qi,d=9,u=5;else{if(2!=m)throw"invalid block type";var b=Ti(e,l,31)+257,y=Ti(e,l+10,15)+4,w=b+Ti(e,l+5,31)+1;l+=14;for(var v=new di(w),C=new di(19),I=0;I<y;++I)C[fi[I]]=Ti(e,l+3*I,7);l+=3*y;var x=Ri(C),B=(1<<x)-1,E=Ei(C,x,1);for(I=0;I<w;){var M,S=E[Ti(e,l,B)];if(l+=15&S,(M=S>>>4)<16)v[I++]=M;else{var k=0,Q=0;for(16==M?(Q=3+Ti(e,l,3),l+=2,k=v[I-1]):17==M?(Q=3+Ti(e,l,7),l+=3):18==M&&(Q=11+Ti(e,l,127),l+=7);Q--;)v[I++]=k}}var R=v.subarray(0,b),T=v.subarray(b);d=Ri(R),u=Ri(T),c=Ei(R,d,1),A=Ei(T,u,1)}if(l>p){if(r)throw"unexpected EOF";break}}a&&o(h+131072);for(var F=(1<<d)-1,D=(1<<u)-1,L=l;;L=l){var P=(k=c[Fi(e,l)&F])>>>4;if((l+=15&k)>p){if(r)throw"unexpected EOF";break}if(!k)throw"invalid length/literal";if(P<256)t[h++]=P;else{if(256==P){L=l,c=null;break}var _=P-254;if(P>264){var G=mi[I=P-257];_=Ti(e,l,(1<<G)-1)+wi[I],l+=G}var z=A[Fi(e,l)&D],U=z>>>4;if(!z)throw"invalid distance";l+=15&z;T=Ci[U];if(U>3){G=gi[U];T+=Fi(e,l)&(1<<G)-1,l+=G}if(l>p){if(r)throw"unexpected EOF";break}a&&o(h+131072);for(var O=h+_;h<O;h+=4)t[h]=t[h-T],t[h+1]=t[h+1-T],t[h+2]=t[h+2-T],t[h+3]=t[h+3-T];h=O}}s.l=c,s.p=L,s.b=h,c&&(n=1,s.m=d,s.d=A,s.n=u)}while(!n);return h==t.length?t:function(e,t,s){(null==s||s>e.length)&&(s=e.length);var i=new(e instanceof ui?ui:e instanceof pi?pi:di)(s-t);return i.set(e.subarray(t,s)),i}(t,0,h)},Pi=new di(0);function _i(e,t){return Li((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),t)}var Gi="undefined"!=typeof TextDecoder&&new TextDecoder;try{Gi.decode(Pi,{stream:!0})}catch(e){}function zi(e,t,s){const i=s.length-e-1;if(t>=s[i])return i-1;if(t<=s[e])return e;let a=e,r=i,o=Math.floor((a+r)/2);for(;t<s[o]||t>=s[o+1];)t<s[o]?r=o:a=o,o=Math.floor((a+r)/2);return o}function Ui(e,t){let s=1;for(let t=2;t<=e;++t)s*=t;let i=1;for(let e=2;e<=t;++e)i*=e;for(let s=2;s<=e-t;++s)i*=s;return s/i}function Oi(e,t,i,a,r){const o=function(e,t,i,a,r){const o=r<e?r:e,n=[],l=zi(e,a,t),h=function(e,t,s,i,a){const r=[];for(let e=0;e<=s;++e)r[e]=0;const o=[];for(let e=0;e<=i;++e)o[e]=r.slice(0);const n=[];for(let e=0;e<=s;++e)n[e]=r.slice(0);n[0][0]=1;const l=r.slice(0),h=r.slice(0);for(let i=1;i<=s;++i){l[i]=t-a[e+1-i],h[i]=a[e+i]-t;let s=0;for(let e=0;e<i;++e){const t=h[e+1],a=l[i-e];n[i][e]=t+a;const r=n[e][i-1]/n[i][e];n[e][i]=s+t*r,s=a*r}n[i][i]=s}for(let e=0;e<=s;++e)o[0][e]=n[e][s];for(let e=0;e<=s;++e){let t=0,a=1;const l=[];for(let e=0;e<=s;++e)l[e]=r.slice(0);l[0][0]=1;for(let r=1;r<=i;++r){let i=0;const h=e-r,c=s-r;e>=r&&(l[a][0]=l[t][0]/n[c+1][h],i=l[a][0]*n[h][c]);const A=e-1<=c?r-1:s-e;for(let e=h>=-1?1:-h;e<=A;++e)l[a][e]=(l[t][e]-l[t][e-1])/n[c+1][h+e],i+=l[a][e]*n[h+e][c];e<=c&&(l[a][r]=-l[t][r-1]/n[c+1][e],i+=l[a][r]*n[e][c]),o[r][e]=i;const d=t;t=a,a=d}}let c=s;for(let e=1;e<=i;++e){for(let t=0;t<=s;++t)o[e][t]*=c;c*=s-e}return o}(l,a,e,o,t),c=[];for(let e=0;e<i.length;++e){const t=i[e].clone(),s=t.w;t.x*=s,t.y*=s,t.z*=s,c[e]=t}for(let t=0;t<=o;++t){const s=c[l-e].clone().multiplyScalar(h[t][0]);for(let i=1;i<=e;++i)s.add(c[l-e+i].clone().multiplyScalar(h[t][i]));n[t]=s}for(let e=o+1;e<=r+1;++e)n[e]=new s.Vector4(0,0,0);return n}(e,t,i,a,r);return function(e){const t=e.length,i=[],a=[];for(let r=0;r<t;++r){const t=e[r];i[r]=new s.Vector3(t.x,t.y,t.z),a[r]=t.w}const r=[];for(let e=0;e<t;++e){const t=i[e].clone();for(let s=1;s<=e;++s)t.sub(r[e-s].clone().multiplyScalar(Ui(e,s)*a[s]));r[e]=t.divideScalar(a[0])}return r}(o)}class Ni extends s.Curve{constructor(e,t,i,a,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=a||0,this.endKnot=r||this.knots.length-1;for(let e=0;e<i.length;++e){const t=i[e];this.controlPoints[e]=new s.Vector4(t.x,t.y,t.z,t.w)}}getPoint(e,t=new s.Vector3){const i=t,a=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=function(e,t,i,a){const r=zi(e,a,t),o=function(e,t,s,i){const a=[],r=[],o=[];a[0]=1;for(let n=1;n<=s;++n){r[n]=t-i[e+1-n],o[n]=i[e+n]-t;let s=0;for(let e=0;e<n;++e){const t=o[e+1],i=r[n-e],l=a[e]/(t+i);a[e]=s+t*l,s=i*l}a[n]=s}return a}(r,a,e,t),n=new s.Vector4(0,0,0,0);for(let t=0;t<=e;++t){const s=i[r-e+t],a=o[t],l=s.w*a;n.x+=s.x*l,n.y+=s.y*l,n.z+=s.z*l,n.w+=s.w*a}return n}(this.degree,this.knots,this.controlPoints,a);return 1!==r.w&&r.divideScalar(r.w),i.set(r.x,r.y,r.z)}getTangent(e,t=new s.Vector3){const i=t,a=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=Oi(this.degree,this.knots,this.controlPoints,a,1);return i.copy(r[1]).normalize(),i}}let Vi,qi,Hi;class ji extends s.Loader{constructor(e){super(e)}load(e,t,i,a){const r=this,o=""===r.path?s.LoaderUtils.extractUrlBase(e):r.path,n=new s.FileLoader(this.manager);n.setPath(r.path),n.setResponseType("arraybuffer"),n.setRequestHeader(r.requestHeader),n.setWithCredentials(r.withCredentials),n.load(e,(function(s){try{t(r.parse(s,o))}catch(t){a?a(t):console.error(t),r.manager.itemError(e)}}),i,a)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===ha(e,0,t.length)}(e))Vi=(new Xi).parse(e);else{const t=ha(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let s=0;function i(t){const i=e[t-1];return e=e.slice(s+t),s++,i}for(let e=0;e<t.length;++e){if(i(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(ea(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+ea(t));Vi=(new Yi).parse(t)}const i=new s.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Wi(i,this.manager).parse(Vi)}}class Wi{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){qi=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),s=this.parseMaterials(t),i=this.parseDeformers(),a=(new Ki).parse(i);return this.parseScene(i,a,s),Hi}parseConnections(){const e=new Map;if("Connections"in Vi){Vi.Connections.connections.forEach((function(t){const s=t[0],i=t[1],a=t[2];e.has(s)||e.set(s,{parents:[],children:[]});const r={ID:i,relationship:a};e.get(s).parents.push(r),e.has(i)||e.set(i,{parents:[],children:[]});const o={ID:s,relationship:a};e.get(i).children.push(o)}))}return e}parseImages(){const e={},t={};if("Video"in Vi.Objects){const s=Vi.Objects.Video;for(const i in s){const a=s[i];if(e[parseInt(i)]=a.RelativeFilename||a.Filename,"Content"in a){const e=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,r="string"==typeof a.Content&&""!==a.Content;if(e||r){const e=this.parseImage(s[i]);t[a.RelativeFilename||a.Filename]=e}}}}for(const s in e){const i=e[s];void 0!==t[i]?e[s]=t[i]:e[s]=e[s].split("\\").pop()}return e}parseImage(e){const t=e.Content,s=e.RelativeFilename||e.Filename,i=s.slice(s.lastIndexOf(".")+1).toLowerCase();let a;switch(i){case"bmp":a="image/bmp";break;case"jpg":case"jpeg":a="image/jpeg";break;case"png":a="image/png";break;case"tif":a="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",s),a="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"==typeof t)return"data:"+a+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:a}))}}parseTextures(e){const t=new Map;if("Texture"in Vi.Objects){const s=Vi.Objects.Texture;for(const i in s){const a=this.parseTexture(s[i],e);t.set(parseInt(i),a)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const a=e.WrapModeU,r=e.WrapModeV,o=void 0!==a?a.value:0,n=void 0!==r?r.value:0;if(i.wrapS=0===o?s.RepeatWrapping:s.ClampToEdgeWrapping,i.wrapT=0===n?s.RepeatWrapping:s.ClampToEdgeWrapping,"Scaling"in e){const t=e.Scaling.value;i.repeat.x=t[0],i.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;i.offset.x=t[0],i.offset.y=t[1]}return i}loadTexture(e,t){const i=new Set(["tga","tif","tiff","exr","dds","hdr","ktx2"]),a=e.FileName.split(".").pop().toLowerCase(),r=i.has(a)?this.manager.getHandler(`.${a}`):this.textureLoader;if(!r)return console.warn(`FBXLoader: ${a.toUpperCase()} loader not found, creating placeholder texture for`,e.RelativeFilename),new s.Texture;const o=r.path;o||r.setPath(this.textureLoader.path);const n=qi.get(e.id).children;let l;void 0!==n&&n.length>0&&void 0!==t[n[0].ID]&&(l=t[n[0].ID],0!==l.indexOf("blob:")&&0!==l.indexOf("data:")||r.setPath(void 0));const h=r.load(l);return r.setPath(o),h}parseMaterials(e){const t=new Map;if("Material"in Vi.Objects){const s=Vi.Objects.Material;for(const i in s){const a=this.parseMaterial(s[i],e);null!==a&&t.set(parseInt(i),a)}}return t}parseMaterial(e,t){const i=e.id,a=e.attrName;let r=e.ShadingModel;if("object"==typeof r&&(r=r.value),!qi.has(i))return null;const o=this.parseParameters(e,t,i);let n;switch(r.toLowerCase()){case"phong":n=new s.MeshPhongMaterial;break;case"lambert":n=new s.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),n=new s.MeshPhongMaterial}return n.setValues(o),n.name=a,n}parseParameters(e,t,i){const a={};e.BumpFactor&&(a.bumpScale=e.BumpFactor.value),e.Diffuse?a.color=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.Diffuse.value),s.SRGBColorSpace):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(a.color=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.DiffuseColor.value),s.SRGBColorSpace)),e.DisplacementFactor&&(a.displacementScale=e.DisplacementFactor.value),e.Emissive?a.emissive=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.Emissive.value),s.SRGBColorSpace):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(a.emissive=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.EmissiveColor.value),s.SRGBColorSpace)),e.EmissiveFactor&&(a.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),a.opacity=1-(e.TransparencyFactor?parseFloat(e.TransparencyFactor.value):0),1!==a.opacity&&0!==a.opacity||(a.opacity=e.Opacity?parseFloat(e.Opacity.value):null,null===a.opacity&&(a.opacity=1-(e.TransparentColor?parseFloat(e.TransparentColor.value[0]):0))),a.opacity<1&&(a.transparent=!0),e.ReflectionFactor&&(a.reflectivity=e.ReflectionFactor.value),e.Shininess&&(a.shininess=e.Shininess.value),e.Specular?a.specular=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.Specular.value),s.SRGBColorSpace):e.SpecularColor&&"Color"===e.SpecularColor.type&&(a.specular=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(e.SpecularColor.value),s.SRGBColorSpace));const r=this;return qi.get(i).children.forEach((function(e){const i=e.relationship;switch(i){case"Bump":a.bumpMap=r.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":a.aoMap=r.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":a.map=r.getTexture(t,e.ID),void 0!==a.map&&(a.map.colorSpace=s.SRGBColorSpace);break;case"DisplacementColor":a.displacementMap=r.getTexture(t,e.ID);break;case"EmissiveColor":a.emissiveMap=r.getTexture(t,e.ID),void 0!==a.emissiveMap&&(a.emissiveMap.colorSpace=s.SRGBColorSpace);break;case"NormalMap":case"Maya|TEX_normal_map":a.normalMap=r.getTexture(t,e.ID);break;case"ReflectionColor":a.envMap=r.getTexture(t,e.ID),void 0!==a.envMap&&(a.envMap.mapping=s.EquirectangularReflectionMapping,a.envMap.colorSpace=s.SRGBColorSpace);break;case"SpecularColor":a.specularMap=r.getTexture(t,e.ID),void 0!==a.specularMap&&(a.specularMap.colorSpace=s.SRGBColorSpace);break;case"TransparentColor":case"TransparencyFactor":a.alphaMap=r.getTexture(t,e.ID),a.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",i)}})),a}getTexture(e,t){return"LayeredTexture"in Vi.Objects&&t in Vi.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=qi.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Vi.Objects){const s=Vi.Objects.Deformer;for(const i in s){const a=s[i],r=qi.get(parseInt(i));if("Skin"===a.attrType){const t=this.parseSkeleton(r,s);t.ID=i,r.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=r.parents[0].ID,e[i]=t}else if("BlendShape"===a.attrType){const e={id:i};e.rawTargets=this.parseMorphTargets(r,s),e.id=i,r.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach((function(e){const a=t[e.ID];if("Cluster"!==a.attrType)return;const r={ID:e.ID,indices:[],weights:[],transformLink:(new s.Matrix4).fromArray(a.TransformLink.a)};"Indexes"in a&&(r.indices=a.Indexes.a,r.weights=a.Weights.a),i.push(r)})),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const s=[];for(let i=0;i<e.children.length;i++){const a=e.children[i],r=t[a.ID],o={name:r.attrName,initialWeight:r.DeformPercent,id:r.id,fullWeights:r.FullWeights.a};if("BlendShapeChannel"!==r.attrType)return;o.geoID=qi.get(parseInt(a.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,s.push(o)}return s}parseScene(e,t,i){Hi=new s.Group;const a=this.parseModels(e.skeletons,t,i),r=Vi.Objects.Model,o=this;a.forEach((function(e){const t=r[e.ID];o.setLookAtProperties(e,t);qi.get(e.ID).parents.forEach((function(t){const s=a.get(t.ID);void 0!==s&&s.add(e)})),null===e.parent&&Hi.add(e)})),this.bindSkeleton(e.skeletons,t,a),this.addGlobalSceneSettings(),Hi.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=oa(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const n=(new Ji).parse();1===Hi.children.length&&Hi.children[0].isGroup&&(Hi.children[0].animations=n,Hi=Hi.children[0]),Hi.animations=n}parseModels(e,t,i){const a=new Map,r=Vi.Objects.Model;for(const o in r){const n=parseInt(o),l=r[o],h=qi.get(n);let c=this.buildSkeleton(h,e,n,l.attrName);if(!c){switch(l.attrType){case"Camera":c=this.createCamera(h);break;case"Light":c=this.createLight(h);break;case"Mesh":c=this.createMesh(h,t,i);break;case"NurbsCurve":c=this.createCurve(h,t);break;case"LimbNode":case"Root":c=new s.Bone;break;default:c=new s.Group}c.name=l.attrName?s.PropertyBinding.sanitizeNodeName(l.attrName):"",c.userData.originalName=l.attrName,c.ID=n}this.getTransformData(c,l),a.set(n,c)}return a}buildSkeleton(e,t,i,a){let r=null;return e.parents.forEach((function(e){for(const o in t){const n=t[o];n.rawBones.forEach((function(t,o){if(t.ID===e.ID){const e=r;r=new s.Bone,r.matrixWorld.copy(t.transformLink),r.name=a?s.PropertyBinding.sanitizeNodeName(a):"",r.userData.originalName=a,r.ID=i,n.bones[o]=r,null!==e&&r.add(e)}}))}})),r}createCamera(e){let t,i;if(e.children.forEach((function(e){const t=Vi.Objects.NodeAttribute[e.ID];void 0!==t&&(i=t)})),void 0===i)t=new s.Object3D;else{let e=0;void 0!==i.CameraProjectionType&&1===i.CameraProjectionType.value&&(e=1);let a=1;void 0!==i.NearPlane&&(a=i.NearPlane.value/1e3);let r=1e3;void 0!==i.FarPlane&&(r=i.FarPlane.value/1e3);let o=window.innerWidth,n=window.innerHeight;void 0!==i.AspectWidth&&void 0!==i.AspectHeight&&(o=i.AspectWidth.value,n=i.AspectHeight.value);const l=o/n;let h=45;void 0!==i.FieldOfView&&(h=i.FieldOfView.value);const c=i.FocalLength?i.FocalLength.value:null;switch(e){case 0:t=new s.PerspectiveCamera(h,l,a,r),null!==c&&t.setFocalLength(c);break;case 1:console.warn("THREE.FBXLoader: Orthographic cameras not supported yet."),t=new s.Object3D;break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new s.Object3D}}return t}createLight(e){let t,i;if(e.children.forEach((function(e){const t=Vi.Objects.NodeAttribute[e.ID];void 0!==t&&(i=t)})),void 0===i)t=new s.Object3D;else{let e;e=void 0===i.LightType?0:i.LightType.value;let a=16777215;void 0!==i.Color&&(a=s.ColorManagement.toWorkingColorSpace((new s.Color).fromArray(i.Color.value),s.SRGBColorSpace));let r=void 0===i.Intensity?1:i.Intensity.value/100;void 0!==i.CastLightOnObject&&0===i.CastLightOnObject.value&&(r=0);let o=0;void 0!==i.FarAttenuationEnd&&(o=void 0!==i.EnableFarAttenuation&&0===i.EnableFarAttenuation.value?0:i.FarAttenuationEnd.value);const n=1;switch(e){case 0:t=new s.PointLight(a,r,o,n);break;case 1:t=new s.DirectionalLight(a,r);break;case 2:let e=Math.PI/3;void 0!==i.InnerAngle&&(e=s.MathUtils.degToRad(i.InnerAngle.value));let l=0;void 0!==i.OuterAngle&&(l=s.MathUtils.degToRad(i.OuterAngle.value),l=Math.max(l,1)),t=new s.SpotLight(a,r,o,e,l,n);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new s.PointLight(a,r)}void 0!==i.CastShadows&&1===i.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,i){let a,r=null,o=null;const n=[];return e.children.forEach((function(e){t.has(e.ID)&&(r=t.get(e.ID)),i.has(e.ID)&&n.push(i.get(e.ID))})),n.length>1?o=n:n.length>0?o=n[0]:(o=new s.MeshPhongMaterial({name:s.Loader.DEFAULT_MATERIAL_NAME,color:13421772}),n.push(o)),"color"in r.attributes&&n.forEach((function(e){e.vertexColors=!0})),r.FBX_Deformer?(a=new s.SkinnedMesh(r,o),a.normalizeSkinWeights()):a=new s.Mesh(r,o),a}createCurve(e,t){const i=e.children.reduce((function(e,s){return t.has(s.ID)&&(e=t.get(s.ID)),e}),null),a=new s.LineBasicMaterial({name:s.Loader.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new s.Line(i,a)}getTransformData(e,t){const s={};"InheritType"in t&&(s.inheritType=parseInt(t.InheritType.value)),s.eulerOrder=na("RotationOrder"in t?t.RotationOrder.value:0),"Lcl_Translation"in t&&(s.translation=t.Lcl_Translation.value),"PreRotation"in t&&(s.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(s.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(s.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(s.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(s.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(s.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(s.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(s.rotationPivot=t.RotationPivot.value),e.userData.transformData=s}setLookAtProperties(e,t){if("LookAtProperty"in t){qi.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const i=Vi.Objects.Model[t.ID];if("Lcl_Translation"in i){const t=i.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),Hi.add(e.target)):e.lookAt((new s.Vector3).fromArray(t))}}}))}}bindSkeleton(e,t,i){const a=this.parsePoseNodes();for(const r in e){const o=e[r];qi.get(parseInt(o.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;qi.get(t).parents.forEach((function(e){if(i.has(e.ID)){i.get(e.ID).bind(new s.Skeleton(o.bones),a[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in Vi.Objects){const t=Vi.Objects.Pose;for(const i in t)if("BindPose"===t[i].attrType&&t[i].NbPoseNodes>0){const a=t[i].PoseNode;Array.isArray(a)?a.forEach((function(t){e[t.Node]=(new s.Matrix4).fromArray(t.Matrix.a)})):e[a.Node]=(new s.Matrix4).fromArray(a.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in Vi){if("AmbientColor"in Vi.GlobalSettings){const e=Vi.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],a=e[2];if(0!==t||0!==i||0!==a){const e=(new s.Color).setRGB(t,i,a,s.SRGBColorSpace);Hi.add(new s.AmbientLight(e,1))}}"UnitScaleFactor"in Vi.GlobalSettings&&(Hi.userData.unitScaleFactor=Vi.GlobalSettings.UnitScaleFactor.value)}}}class Ki{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in Vi.Objects){const s=Vi.Objects.Geometry;for(const i in s){const a=qi.get(parseInt(i)),r=this.parseGeometry(a,s[i],e);t.set(parseInt(i),r)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,s){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,s);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,s){const i=s.skeletons,a=[],r=e.parents.map((function(e){return Vi.Objects.Model[e.ID]}));if(0===r.length)return;const o=e.children.reduce((function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e}),null);e.children.forEach((function(e){void 0!==s.morphTargets[e.ID]&&a.push(s.morphTargets[e.ID])}));const n=r[0],l={};"RotationOrder"in n&&(l.eulerOrder=na(n.RotationOrder.value)),"InheritType"in n&&(l.inheritType=parseInt(n.InheritType.value)),"GeometricTranslation"in n&&(l.translation=n.GeometricTranslation.value),"GeometricRotation"in n&&(l.rotation=n.GeometricRotation.value),"GeometricScaling"in n&&(l.scale=n.GeometricScaling.value);const h=oa(l);return this.genGeometry(t,o,a,h)}genGeometry(e,t,i,a){const r=new s.BufferGeometry;e.attrName&&(r.name=e.attrName);const o=this.parseGeoNode(e,t),n=this.genBuffers(o),l=new s.Float32BufferAttribute(n.vertex,3);if(l.applyMatrix4(a),r.setAttribute("position",l),n.colors.length>0&&r.setAttribute("color",new s.Float32BufferAttribute(n.colors,3)),t&&(r.setAttribute("skinIndex",new s.Uint16BufferAttribute(n.weightsIndices,4)),r.setAttribute("skinWeight",new s.Float32BufferAttribute(n.vertexWeights,4)),r.FBX_Deformer=t),n.normal.length>0){const e=(new s.Matrix3).getNormalMatrix(a),t=new s.Float32BufferAttribute(n.normal,3);t.applyNormalMatrix(e),r.setAttribute("normal",t)}if(n.uvs.forEach((function(e,t){const i=0===t?"uv":`uv${t}`;r.setAttribute(i,new s.Float32BufferAttribute(n.uvs[t],2))})),o.material&&"AllSame"!==o.material.mappingType){let e=n.materialIndex[0],t=0;if(n.materialIndex.forEach((function(s,i){s!==e&&(r.addGroup(t,i-t,e),e=s,t=i)})),r.groups.length>0){const t=r.groups[r.groups.length-1],s=t.start+t.count;s!==n.materialIndex.length&&r.addGroup(s,n.materialIndex.length-s,e)}0===r.groups.length&&r.addGroup(0,n.materialIndex.length,n.materialIndex[0])}return this.addMorphTargets(r,e,i,a),r}parseGeoNode(e,t){const s={};if(s.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],s.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(s.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(s.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(s.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){s.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&s.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return s.weightTable={},null!==t&&(s.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(i,a){void 0===s.weightTable[i]&&(s.weightTable[i]=[]),s.weightTable[i].push({id:t,weight:e.weights[a]})}))}))),s}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let s=0,i=0,a=!1,r=[],o=[],n=[],l=[],h=[],c=[];const A=this;return e.vertexIndices.forEach((function(d,u){let p,m=!1;d<0&&(d=~d,m=!0);let g=[],f=[];if(r.push(3*d,3*d+1,3*d+2),e.color){const t=ia(u,s,d,e.color);n.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){f.push(e.weight),g.push(e.id)})),f.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);const e=[0,0,0,0],t=[0,0,0,0];f.forEach((function(s,i){let a=s,r=g[i];t.forEach((function(t,s,i){if(a>t){i[s]=a,a=t;const o=e[s];e[s]=r,r=o}}))})),g=e,f=t}for(;f.length<4;)f.push(0),g.push(0);for(let e=0;e<4;++e)h.push(f[e]),c.push(g[e])}if(e.normal){const t=ia(u,s,d,e.normal);o.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(p=ia(u,s,d,e.material)[0],p<0&&(A.negativeMaterialIndices=!0,p=0)),e.uv&&e.uv.forEach((function(e,t){const i=ia(u,s,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(i[0]),l[t].push(i[1])})),i++,m&&(A.genFace(t,e,r,p,o,n,l,h,c,i),s++,i=0,r=[],o=[],n=[],l=[],h=[],c=[])})),t}getNormalNewell(e){const t=new s.Vector3(0,0,0);for(let s=0;s<e.length;s++){const i=e[s],a=e[(s+1)%e.length];t.x+=(i.y-a.y)*(i.z+a.z),t.y+=(i.z-a.z)*(i.x+a.x),t.z+=(i.x-a.x)*(i.y+a.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),i=(Math.abs(t.z)>.5?new s.Vector3(0,1,0):new s.Vector3(0,0,1)).cross(t).normalize(),a=t.clone().cross(i).normalize();return{normal:t,tangent:i,bitangent:a}}flattenVertex(e,t,i){return new s.Vector2(e.dot(t),e.dot(i))}genFace(e,t,i,a,r,o,n,l,h,c){let A;if(c>3){const e=[],a=t.baseVertexPositions||t.vertexPositions;for(let t=0;t<i.length;t+=3)e.push(new s.Vector3(a[i[t]],a[i[t+1]],a[i[t+2]]));const{tangent:r,bitangent:o}=this.getNormalTangentAndBitangent(e),n=[];for(const t of e)n.push(this.flattenVertex(t,r,o));A=s.ShapeUtils.triangulateShape(n,[])}else A=[[0,1,2]];for(const[s,c,d]of A)e.vertex.push(t.vertexPositions[i[3*s]]),e.vertex.push(t.vertexPositions[i[3*s+1]]),e.vertex.push(t.vertexPositions[i[3*s+2]]),e.vertex.push(t.vertexPositions[i[3*c]]),e.vertex.push(t.vertexPositions[i[3*c+1]]),e.vertex.push(t.vertexPositions[i[3*c+2]]),e.vertex.push(t.vertexPositions[i[3*d]]),e.vertex.push(t.vertexPositions[i[3*d+1]]),e.vertex.push(t.vertexPositions[i[3*d+2]]),t.skeleton&&(e.vertexWeights.push(l[4*s]),e.vertexWeights.push(l[4*s+1]),e.vertexWeights.push(l[4*s+2]),e.vertexWeights.push(l[4*s+3]),e.vertexWeights.push(l[4*c]),e.vertexWeights.push(l[4*c+1]),e.vertexWeights.push(l[4*c+2]),e.vertexWeights.push(l[4*c+3]),e.vertexWeights.push(l[4*d]),e.vertexWeights.push(l[4*d+1]),e.vertexWeights.push(l[4*d+2]),e.vertexWeights.push(l[4*d+3]),e.weightsIndices.push(h[4*s]),e.weightsIndices.push(h[4*s+1]),e.weightsIndices.push(h[4*s+2]),e.weightsIndices.push(h[4*s+3]),e.weightsIndices.push(h[4*c]),e.weightsIndices.push(h[4*c+1]),e.weightsIndices.push(h[4*c+2]),e.weightsIndices.push(h[4*c+3]),e.weightsIndices.push(h[4*d]),e.weightsIndices.push(h[4*d+1]),e.weightsIndices.push(h[4*d+2]),e.weightsIndices.push(h[4*d+3])),t.color&&(e.colors.push(o[3*s]),e.colors.push(o[3*s+1]),e.colors.push(o[3*s+2]),e.colors.push(o[3*c]),e.colors.push(o[3*c+1]),e.colors.push(o[3*c+2]),e.colors.push(o[3*d]),e.colors.push(o[3*d+1]),e.colors.push(o[3*d+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(a),e.materialIndex.push(a),e.materialIndex.push(a)),t.normal&&(e.normal.push(r[3*s]),e.normal.push(r[3*s+1]),e.normal.push(r[3*s+2]),e.normal.push(r[3*c]),e.normal.push(r[3*c+1]),e.normal.push(r[3*c+2]),e.normal.push(r[3*d]),e.normal.push(r[3*d+1]),e.normal.push(r[3*d+2])),t.uv&&t.uv.forEach((function(t,i){void 0===e.uvs[i]&&(e.uvs[i]=[]),e.uvs[i].push(n[i][2*s]),e.uvs[i].push(n[i][2*s+1]),e.uvs[i].push(n[i][2*c]),e.uvs[i].push(n[i][2*c+1]),e.uvs[i].push(n[i][2*d]),e.uvs[i].push(n[i][2*d+1])}))}addMorphTargets(e,t,s,i){if(0===s.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const a=this;s.forEach((function(s){s.rawTargets.forEach((function(s){const r=Vi.Objects.Geometry[s.geoID];void 0!==r&&a.genMorphGeometry(e,t,r,i,s.name)}))}))}genMorphGeometry(e,t,i,a,r){const o=void 0!==t.Vertices?t.Vertices.a:[],n=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],l=void 0!==i.Vertices?i.Vertices.a:[],h=void 0!==i.Indexes?i.Indexes.a:[],c=3*e.attributes.position.count,A=new Float32Array(c);for(let e=0;e<h.length;e++){const t=3*h[e];A[t]=l[3*e],A[t+1]=l[3*e+1],A[t+2]=l[3*e+2]}const d={vertexIndices:n,vertexPositions:A,baseVertexPositions:o},u=this.genBuffers(d),p=new s.Float32BufferAttribute(u.vertex,3);p.name=r||i.attrName,p.applyMatrix4(a),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,i=e.Normals.a;let a=[];return"IndexToDirect"===s&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:a,mappingType:t,referenceType:s}}parseUVs(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,i=e.UV.a;let a=[];return"IndexToDirect"===s&&(a=e.UVIndex.a),{dataSize:2,buffer:i,indices:a,mappingType:t,referenceType:s}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,a=e.Colors.a;let r=[];"IndexToDirect"===i&&(r=e.ColorIndex.a);for(let e=0,t=new s.Color;e<a.length;e+=4)t.fromArray(a,e),s.ColorManagement.toWorkingColorSpace(t,s.SRGBColorSpace),t.toArray(a,e);return{dataSize:4,buffer:a,indices:r,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,s=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:s};const i=e.Materials.a,a=[];for(let e=0;e<i.length;++e)a.push(e);return{dataSize:1,buffer:i,indices:a,mappingType:t,referenceType:s}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new s.BufferGeometry;const i=t-1,a=e.KnotVector.a,r=[],o=e.Points.a;for(let e=0,t=o.length;e<t;e+=4)r.push((new s.Vector4).fromArray(o,e));let n,l;if("Closed"===e.Form)r.push(r[0]);else if("Periodic"===e.Form){n=i,l=a.length-1-n;for(let e=0;e<i;++e)r.push(r[e])}const h=new Ni(i,a,r,n,l).getPoints(12*r.length);return(new s.BufferGeometry).setFromPoints(h)}}class Ji{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const s in t){const i=t[s],a=this.addClip(i);e.push(a)}return e}parseClips(){if(void 0===Vi.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Vi.Objects.AnimationCurveNode,t=new Map;for(const s in e){const i=e[s];if(null!==i.attrName.match(/S|R|T|DeformPercent/)){const e={id:i.id,attr:i.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Vi.Objects.AnimationCurve;for(const s in t){const i={id:t[s].id,times:t[s].KeyTime.a.map(ta),values:t[s].KeyValueFloat.a},a=qi.get(i.id);if(void 0!==a){const t=a.parents[0].ID,s=a.parents[0].relationship;s.match(/X/)?e.get(t).curves.x=i:s.match(/Y/)?e.get(t).curves.y=i:s.match(/Z/)?e.get(t).curves.z=i:s.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=i)}}}parseAnimationLayers(e){const t=Vi.Objects.AnimationLayer,i=new Map;for(const a in t){const t=[],r=qi.get(parseInt(a));if(void 0!==r){r.children.forEach((function(i,a){if(e.has(i.ID)){const r=e.get(i.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===t[a]){const e=qi.get(i.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const r=Vi.Objects.Model[e.toString()];if(void 0===r)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",i);const o={modelName:r.attrName?s.PropertyBinding.sanitizeNodeName(r.attrName):"",ID:r.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Hi.traverse((function(e){e.ID===r.id&&(o.transform=e.matrix,e.userData.transformData&&(o.eulerOrder=e.userData.transformData.eulerOrder))})),o.transform||(o.transform=new s.Matrix4),"PreRotation"in r&&(o.preRotation=r.PreRotation.value),"PostRotation"in r&&(o.postRotation=r.PostRotation.value),t[a]=o}}t[a]&&(t[a][r.attr]=r)}else if(void 0!==r.curves.morph){if(void 0===t[a]){const e=qi.get(i.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,r=qi.get(e).parents[0].ID,o=qi.get(r).parents[0].ID,n=qi.get(o).parents[0].ID,l=Vi.Objects.Model[n],h={modelName:l.attrName?s.PropertyBinding.sanitizeNodeName(l.attrName):"",morphName:Vi.Objects.Deformer[e].attrName};t[a]=h}t[a][r.attr]=r}}})),i.set(parseInt(a),t)}}return i}parseAnimStacks(e){const t=Vi.Objects.AnimationStack,s={};for(const i in t){const a=qi.get(parseInt(i)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const r=e.get(a[0].ID);s[i]={name:t[i].attrName,layer:r}}return s}addClip(e){let t=[];const i=this;return e.layer.forEach((function(e){t=t.concat(i.generateTracks(e))})),new s.AnimationClip(e.name,-1,t)}generateTracks(e){const t=[];let i=new s.Vector3,a=new s.Vector3;if(e.transform&&e.transform.decompose(i,new s.Quaternion,a),i=i.toArray(),a=a.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");void 0!==s&&t.push(s)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const s=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==s&&t.push(s)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");void 0!==s&&t.push(s)}if(void 0!==e.DeformPercent){const s=this.generateMorphTrack(e);void 0!==s&&t.push(s)}return t}generateVectorTrack(e,t,i,a){const r=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(r,t,i);return new s.VectorKeyframeTrack(e+"."+a,r,o)}generateRotationTrack(e,t,i,a,r){let o,n;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,r);o=e[0],n=e[1]}const l=na(0);void 0!==i&&((i=i.map(s.MathUtils.degToRad)).push(l),i=(new s.Euler).fromArray(i),i=(new s.Quaternion).setFromEuler(i)),void 0!==a&&((a=a.map(s.MathUtils.degToRad)).push(l),a=(new s.Euler).fromArray(a),a=(new s.Quaternion).setFromEuler(a).invert());const h=new s.Quaternion,c=new s.Euler,A=[];if(!n||!o)return new s.QuaternionKeyframeTrack(e+".quaternion",[0],[0]);for(let e=0;e<n.length;e+=3){if(c.set(n[e],n[e+1],n[e+2],r),h.setFromEuler(c),void 0!==i&&h.premultiply(i),void 0!==a&&h.multiply(a),e>2){(new s.Quaternion).fromArray(A,(e-3)/3*4).dot(h)<0&&h.set(-h.x,-h.y,-h.z,-h.w)}h.toArray(A,e/3*4)}return new s.QuaternionKeyframeTrack(e+".quaternion",o,A)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map((function(e){return e/100})),a=Hi.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new s.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+a+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,s=t[0];for(let i=1;i<t.length;i++){const a=t[i];a!==s&&(t[e]=a,s=a,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,s){const i=s,a=[];let r=-1,o=-1,n=-1;return e.forEach((function(e){if(t.x&&(r=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(n=t.z.times.indexOf(e)),-1!==r){const e=t.x.values[r];a.push(e),i[0]=e}else a.push(i[0]);if(-1!==o){const e=t.y.values[o];a.push(e),i[1]=e}else a.push(i[1]);if(-1!==n){const e=t.z.values[n];a.push(e),i[2]=e}else a.push(i[2])})),a}interpolateRotations(e,t,i,a){const r=[],o=[];r.push(e.times[0]),o.push(s.MathUtils.degToRad(e.values[0])),o.push(s.MathUtils.degToRad(t.values[0])),o.push(s.MathUtils.degToRad(i.values[0]));for(let n=1;n<e.values.length;n++){const l=[e.values[n-1],t.values[n-1],i.values[n-1]];if(isNaN(l[0])||isNaN(l[1])||isNaN(l[2]))continue;const h=l.map(s.MathUtils.degToRad),c=[e.values[n],t.values[n],i.values[n]];if(isNaN(c[0])||isNaN(c[1])||isNaN(c[2]))continue;const A=c.map(s.MathUtils.degToRad),d=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],u=[Math.abs(d[0]),Math.abs(d[1]),Math.abs(d[2])];if(u[0]>=180||u[1]>=180||u[2]>=180){const t=Math.max(...u)/180,i=new s.Euler(...h,a),l=new s.Euler(...A,a),c=(new s.Quaternion).setFromEuler(i),d=(new s.Quaternion).setFromEuler(l);c.dot(d)&&d.set(-d.x,-d.y,-d.z,-d.w);const p=e.times[n-1],m=e.times[n]-p,g=new s.Quaternion,f=new s.Euler;for(let e=0;e<1;e+=1/t)g.copy(c.clone().slerp(d.clone(),e)),r.push(p+e*m),f.setFromQuaternion(g,a),o.push(f.x),o.push(f.y),o.push(f.z)}else r.push(e.times[n]),o.push(s.MathUtils.degToRad(e.values[n])),o.push(s.MathUtils.degToRad(t.values[n])),o.push(s.MathUtils.degToRad(i.values[n]))}return[r,o]}}class Yi{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new $i,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,s=e.split(/[\r\n]+/);return s.forEach((function(e,i){const a=e.match(/^[\s\t]*;/),r=e.match(/^[\s\t]*$/);if(a||r)return;const o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),n=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):n?t.parseNodeProperty(e,n,s[++i]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const s=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),a={name:s},r=this.parseNodeAttr(i),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(s,a):s in o?("PoseNode"===s?o.PoseNode.push(a):void 0!==o[s].id&&(o[s]={},o[s][o[s].id]=o[s]),""!==r.id&&(o[s][r.id]=a)):"number"==typeof r.id?(o[s]={},o[s][r.id]=a):"Properties70"!==s&&(o[s]="PoseNode"===s?[a]:a),"number"==typeof r.id&&(a.id=r.id),""!==r.name&&(a.attrName=r.name),""!==r.type&&(a.attrType=r.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let s="",i="";return e.length>1&&(s=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:s,type:i}}parseNodeProperty(e,t,s){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===i&&","===a&&(a=s.replace(/"/g,"").replace(/,$/,"").trim());const r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===i){const e=a.split(",").slice(1),t=parseInt(e[0]),s=parseInt(e[1]);let o=a.split(",").slice(3);o=o.map((function(e){return e.trim().replace(/^"/,"")})),i="connections",a=[t,s],function(e,t){for(let s=0,i=e.length,a=t.length;s<a;s++,i++)e[i]=t[s]}(a,o),void 0===r[i]&&(r[i]=[])}"Node"===i&&(r.id=a),i in r&&Array.isArray(r[i])?r[i].push(a):"a"!==i?r[i]=a:r.a=a,this.setCurrentProp(r,i),"a"===i&&","!==a.slice(-1)&&(r.a=la(a))}else this.parseNodeSpecialProperty(e,i,a)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=la(t.a))}parseNodeSpecialProperty(e,t,s){const i=s.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),a=i[0],r=i[1],o=i[2],n=i[3];let l=i[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=la(l)}this.getPrevNode()[a]={type:r,type2:o,flag:n,value:l},this.setCurrentProp(this.getPrevNode(),a)}}class Xi{parse(e){const t=new Zi(e);t.skip(23);const s=t.getUint32();if(s<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+s);const i=new $i;for(;!this.endOfContent(t);){const e=this.parseNode(t,s);null!==e&&i.add(e.name,e)}return i}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const s={},i=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const r=e.getUint8(),o=e.getString(r);if(0===i)return null;const n=[];for(let t=0;t<a;t++)n.push(this.parseProperty(e));const l=n.length>0?n[0]:"",h=n.length>1?n[1]:"",c=n.length>2?n[2]:"";for(s.singleProperty=1===a&&e.getOffset()===i;i>e.getOffset();){const i=this.parseNode(e,t);null!==i&&this.parseSubNode(o,s,i)}return s.propertyList=n,"number"==typeof l&&(s.id=l),""!==h&&(s.attrName=h),""!==c&&(s.attrType=c),""!==o&&(s.name=o),s}parseSubNode(e,t,s){if(!0===s.singleProperty){const e=s.propertyList[0];Array.isArray(e)?(t[s.name]=s,s.a=e):t[s.name]=e}else if("Connections"===e&&"C"===s.name){const e=[];s.propertyList.forEach((function(t,s){0!==s&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===s.name){Object.keys(s).forEach((function(e){t[e]=s[e]}))}else if("Properties70"===e&&"P"===s.name){let e=s.propertyList[0],i=s.propertyList[1];const a=s.propertyList[2],r=s.propertyList[3];let o;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===i.indexOf("Lcl ")&&(i=i.replace("Lcl ","Lcl_")),o="Color"===i||"ColorRGB"===i||"Vector"===i||"Vector3D"===i||0===i.indexOf("Lcl_")?[s.propertyList[4],s.propertyList[5],s.propertyList[6]]:s.propertyList[4],t[e]={type:i,type2:a,flag:r,value:o}}else void 0===t[s.name]?"number"==typeof s.id?(t[s.name]={},t[s.name][s.id]=s):t[s.name]=s:"PoseNode"===s.name?(Array.isArray(t[s.name])||(t[s.name]=[t[s.name]]),t[s.name].push(s)):void 0===t[s.name][s.id]&&(t[s.name][s.id]=s)}parseProperty(e){const t=e.getString(1);let s;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return s=e.getUint32(),e.getArrayBuffer(s);case"S":return s=e.getUint32(),e.getString(s);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),a=e.getUint32(),r=e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const o=_i(new Uint8Array(e.getArrayBuffer(r))),n=new Zi(o.buffer);switch(t){case"b":case"c":return n.getBooleanArray(i);case"d":return n.getFloat64Array(i);case"f":return n.getFloat32Array(i);case"i":return n.getInt32Array(i);case"l":return n.getInt64Array(i)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Zi{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let s=0;s<e;s++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let s=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const i=s.indexOf(0);return i>=0&&(s=new Uint8Array(this.dv.buffer,t,i)),this._textDecoder.decode(s)}}class $i{add(e,t){this[e]=t}}function ea(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function ta(e){return e/46186158e3}const sa=[];function ia(e,t,s,i){let a;switch(i.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=s;break;case"AllSame":a=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}"IndexToDirect"===i.referenceType&&(a=i.indices[a]);const r=a*i.dataSize,o=r+i.dataSize;return function(e,t,s,i){for(let a=s,r=0;a<i;a++,r++)e[r]=t[a];return e}(sa,i.buffer,r,o)}const aa=new s.Euler,ra=new s.Vector3;function oa(e){const t=new s.Matrix4,i=new s.Matrix4,a=new s.Matrix4,r=new s.Matrix4,o=new s.Matrix4,n=new s.Matrix4,l=new s.Matrix4,h=new s.Matrix4,c=new s.Matrix4,A=new s.Matrix4,d=new s.Matrix4,u=new s.Matrix4,p=e.inheritType?e.inheritType:0;e.translation&&t.setPosition(ra.fromArray(e.translation));const m=na(0);if(e.preRotation){const t=e.preRotation.map(s.MathUtils.degToRad);t.push(m),i.makeRotationFromEuler(aa.fromArray(t))}if(e.rotation){const t=e.rotation.map(s.MathUtils.degToRad);t.push(e.eulerOrder||m),a.makeRotationFromEuler(aa.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(s.MathUtils.degToRad);t.push(m),r.makeRotationFromEuler(aa.fromArray(t)),r.invert()}e.scale&&o.scale(ra.fromArray(e.scale)),e.scalingOffset&&l.setPosition(ra.fromArray(e.scalingOffset)),e.scalingPivot&&n.setPosition(ra.fromArray(e.scalingPivot)),e.rotationOffset&&h.setPosition(ra.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(ra.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),A.copy(e.parentMatrixWorld));const g=i.clone().multiply(a).multiply(r),f=new s.Matrix4;f.extractRotation(A);const b=new s.Matrix4;b.copyPosition(A);const y=b.clone().invert().multiply(A),w=f.clone().invert().multiply(y),v=o,C=new s.Matrix4;if(0===p)C.copy(f).multiply(g).multiply(w).multiply(v);else if(1===p)C.copy(f).multiply(w).multiply(g).multiply(v);else{const e=(new s.Matrix4).scale((new s.Vector3).setFromMatrixScale(d)).clone().invert(),t=w.clone().multiply(e);C.copy(f).multiply(g).multiply(t).multiply(v)}const I=c.clone().invert(),x=n.clone().invert();let B=t.clone().multiply(h).multiply(c).multiply(i).multiply(a).multiply(r).multiply(I).multiply(l).multiply(n).multiply(o).multiply(x);const E=(new s.Matrix4).copyPosition(B),M=A.clone().multiply(E);return u.copyPosition(M),B=u.clone().multiply(C),B.premultiply(A.invert()),B}function na(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function la(e){return e.split(",").map((function(e){return parseFloat(e)}))}function ha(e,t,s){return void 0===t&&(t=0),void 0===s&&(s=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,s))}var ca=function(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var s,i=WebAssembly.validate(e)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",a=WebAssembly.instantiate(r(i),{}).then((function(e){(s=e.instance).exports.__wasm_call_ctors()}));function r(e){for(var s=new Uint8Array(e.length),i=0;i<e.length;++i){var a=e.charCodeAt(i);s[i]=a>96?a-97:a>64?a-39:a+4}var r=0;for(i=0;i<e.length;++i)s[r++]=s[i]<60?t[s[i]]:64*(s[i]-60)+s[++i];return s.buffer.slice(0,r)}function o(e,t,i,a,r,o){var n=s.exports.sbrk,l=i+3&-4,h=n(l*a),c=n(r.length),A=new Uint8Array(s.exports.memory.buffer);A.set(r,c);var d=e(h,i,a,c,r.length);if(0==d&&o&&o(h,l,a),t.set(A.subarray(h,h+i*a)),n(h-n(0)),0!=d)throw new Error("Malformed buffer data: "+d)}var n={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function A(e){var t={object:new Worker(e),pending:0,requests:{}};return t.object.onmessage=function(e){var s=e.data;t.pending-=s.count,t.requests[s.id][s.action](s.value),delete t.requests[s.id]},t}function d(e){for(var t="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(i))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+o.toString()+u.toString(),s=new Blob([t],{type:"text/javascript"}),a=URL.createObjectURL(s),n=0;n<e;++n)h[n]=A(a);URL.revokeObjectURL(a)}function u(e){a.then((function(){var t=e.data;try{var i=new Uint8Array(t.count*t.size);o(s.exports[t.mode],i,t.count,t.size,t.source,s.exports[t.filter]),self.postMessage({id:t.id,count:t.count,action:"resolve",value:i},[i.buffer])}catch(e){self.postMessage({id:t.id,count:t.count,action:"reject",value:e})}}))}return{ready:a,supported:!0,useWorkers:function(e){d(e)},decodeVertexBuffer:function(e,t,i,a,r){o(s.exports.meshopt_decodeVertexBuffer,e,t,i,a,s.exports[n[r]])},decodeIndexBuffer:function(e,t,i,a){o(s.exports.meshopt_decodeIndexBuffer,e,t,i,a)},decodeIndexSequence:function(e,t,i,a){o(s.exports.meshopt_decodeIndexSequence,e,t,i,a)},decodeGltfBuffer:function(e,t,i,a,r,h){o(s.exports[l[r]],e,t,i,a,s.exports[n[h]])},decodeGltfBufferAsync:function(e,t,i,r,A){return h.length>0?function(e,t,s,i,a){for(var r=h[0],o=1;o<h.length;++o)h[o].pending<r.pending&&(r=h[o]);return new Promise((function(o,n){var l=new Uint8Array(s),h=c++;r.pending+=e,r.requests[h]={resolve:o,reject:n},r.object.postMessage({id:h,count:e,size:t,source:l,mode:i,filter:a},[l.buffer])}))}(e,t,i,l[r],n[A]):a.then((function(){var a=new Uint8Array(e*t);return o(s.exports[l[r]],a,e,t,i,s.exports[n[A]]),a}))}}}();const Aa=/^[og]\s*(.+)?/,da=/^mtllib /,ua=/^usemtl /,pa=/^usemap /,ma=/\s+/,ga=new s.Vector3,fa=new s.Vector3,ba=new s.Vector3,ya=new s.Vector3,wa=new s.Vector3,va=new s.Color;function Ca(){const e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);const s=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(e,t){const s=this._finalize(!1);s&&(s.inherited||s.groupCount<=0)&&this.materials.splice(s.index,1);const i={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==s?s.smooth:this.smooth,groupStart:void 0!==s?s.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){const t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(i),i},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){const t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(let e=this.materials.length-1;e>=0;e--)this.materials[e].groupCount<=0&&this.materials.splice(e,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},s&&s.name&&"function"==typeof s.clone){const e=s.clone(0);e.inherited=!0,this.object.materials.push(e)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const s=parseInt(e,10);return 3*(s>=0?s-1:s+t/3)},parseNormalIndex:function(e,t){const s=parseInt(e,10);return 3*(s>=0?s-1:s+t/3)},parseUVIndex:function(e,t){const s=parseInt(e,10);return 2*(s>=0?s-1:s+t/2)},addVertex:function(e,t,s){const i=this.vertices,a=this.object.geometry.vertices;a.push(i[e+0],i[e+1],i[e+2]),a.push(i[t+0],i[t+1],i[t+2]),a.push(i[s+0],i[s+1],i[s+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,s){const i=this.normals,a=this.object.geometry.normals;a.push(i[e+0],i[e+1],i[e+2]),a.push(i[t+0],i[t+1],i[t+2]),a.push(i[s+0],i[s+1],i[s+2])},addFaceNormal:function(e,t,s){const i=this.vertices,a=this.object.geometry.normals;ga.fromArray(i,e),fa.fromArray(i,t),ba.fromArray(i,s),wa.subVectors(ba,fa),ya.subVectors(ga,fa),wa.cross(ya),wa.normalize(),a.push(wa.x,wa.y,wa.z),a.push(wa.x,wa.y,wa.z),a.push(wa.x,wa.y,wa.z)},addColor:function(e,t,s){const i=this.colors,a=this.object.geometry.colors;void 0!==i[e]&&a.push(i[e+0],i[e+1],i[e+2]),void 0!==i[t]&&a.push(i[t+0],i[t+1],i[t+2]),void 0!==i[s]&&a.push(i[s+0],i[s+1],i[s+2])},addUV:function(e,t,s){const i=this.uvs,a=this.object.geometry.uvs;a.push(i[e+0],i[e+1]),a.push(i[t+0],i[t+1]),a.push(i[s+0],i[s+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,s,i,a,r,o,n,l){const h=this.vertices.length;let c=this.parseVertexIndex(e,h),A=this.parseVertexIndex(t,h),d=this.parseVertexIndex(s,h);if(this.addVertex(c,A,d),this.addColor(c,A,d),void 0!==o&&""!==o){const e=this.normals.length;c=this.parseNormalIndex(o,e),A=this.parseNormalIndex(n,e),d=this.parseNormalIndex(l,e),this.addNormal(c,A,d)}else this.addFaceNormal(c,A,d);if(void 0!==i&&""!==i){const e=this.uvs.length;c=this.parseUVIndex(i,e),A=this.parseUVIndex(a,e),d=this.parseUVIndex(r,e),this.addUV(c,A,d),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let s=0,i=e.length;s<i;s++){const i=this.parseVertexIndex(e[s],t);this.addVertexPoint(i),this.addColor(i)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const s=this.vertices.length,i=this.uvs.length;for(let t=0,i=e.length;t<i;t++)this.addVertexLine(this.parseVertexIndex(e[t],s));for(let e=0,s=t.length;e<s;e++)this.addUVLine(this.parseUVIndex(t[e],i))}};return e.startObject("",!1),e}class Ia extends s.Loader{constructor(e){super(e),this.materials=null}load(e,t,i,a){const r=this,o=new s.FileLoader(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(s){try{t(r.parse(s))}catch(t){a?a(t):console.error(t),r.manager.itemError(e)}}),i,a)}setMaterials(e){return this.materials=e,this}parse(e){const t=new Ca;-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));const i=e.split("\n");let a=[];for(let e=0,r=i.length;e<r;e++){const r=i[e].trimStart();if(0===r.length)continue;const o=r.charAt(0);if("#"!==o)if("v"===o){const e=r.split(ma);switch(e[0]){case"v":t.vertices.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),e.length>=7?(va.setRGB(parseFloat(e[4]),parseFloat(e[5]),parseFloat(e[6]),s.SRGBColorSpace),t.colors.push(va.r,va.g,va.b)):t.colors.push(void 0,void 0,void 0);break;case"vn":t.normals.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));break;case"vt":t.uvs.push(parseFloat(e[1]),parseFloat(e[2]))}}else if("f"===o){const e=r.slice(1).trim().split(ma),s=[];for(let t=0,i=e.length;t<i;t++){const i=e[t];if(i.length>0){const e=i.split("/");s.push(e)}}const i=s[0];for(let e=1,a=s.length-1;e<a;e++){const a=s[e],r=s[e+1];t.addFace(i[0],a[0],r[0],i[1],a[1],r[1],i[2],a[2],r[2])}}else if("l"===o){const e=r.substring(1).trim().split(" ");let s=[];const i=[];if(-1===r.indexOf("/"))s=e;else for(let t=0,a=e.length;t<a;t++){const a=e[t].split("/");""!==a[0]&&s.push(a[0]),""!==a[1]&&i.push(a[1])}t.addLineGeometry(s,i)}else if("p"===o){const e=r.slice(1).trim().split(" ");t.addPointGeometry(e)}else if(null!==(a=Aa.exec(r))){const e=(" "+a[0].slice(1).trim()).slice(1);t.startObject(e)}else if(ua.test(r))t.object.startMaterial(r.substring(7).trim(),t.materialLibraries);else if(da.test(r))t.materialLibraries.push(r.substring(7).trim());else if(pa.test(r))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if("s"===o){if(a=r.split(" "),a.length>1){const e=a[1].trim().toLowerCase();t.object.smooth="0"!==e&&"off"!==e}else t.object.smooth=!0;const e=t.object.currentMaterial();e&&(e.smooth=t.object.smooth)}else{if("\0"===r)continue;console.warn('THREE.OBJLoader: Unexpected line: "'+r+'"')}}t.finalize();const r=new s.Group;r.materialLibraries=[].concat(t.materialLibraries);if(!0===!(1===t.objects.length&&0===t.objects[0].geometry.vertices.length))for(let e=0,i=t.objects.length;e<i;e++){const i=t.objects[e],a=i.geometry,o=i.materials,n="Line"===a.type,l="Points"===a.type;let h=!1;if(0===a.vertices.length)continue;const c=new s.BufferGeometry;c.setAttribute("position",new s.Float32BufferAttribute(a.vertices,3)),a.normals.length>0&&c.setAttribute("normal",new s.Float32BufferAttribute(a.normals,3)),a.colors.length>0&&(h=!0,c.setAttribute("color",new s.Float32BufferAttribute(a.colors,3))),!0===a.hasUVIndices&&c.setAttribute("uv",new s.Float32BufferAttribute(a.uvs,2));const A=[];for(let e=0,i=o.length;e<i;e++){const i=o[e],a=i.name+"_"+i.smooth+"_"+h;let r=t.materials[a];if(null!==this.materials)if(r=this.materials.create(i.name),!n||!r||r instanceof s.LineBasicMaterial){if(l&&r&&!(r instanceof s.PointsMaterial)){const e=new s.PointsMaterial({size:10,sizeAttenuation:!1});s.Material.prototype.copy.call(e,r),e.color.copy(r.color),e.map=r.map,r=e}}else{const e=new s.LineBasicMaterial;s.Material.prototype.copy.call(e,r),e.color.copy(r.color),r=e}void 0===r&&(r=n?new s.LineBasicMaterial:l?new s.PointsMaterial({size:1,sizeAttenuation:!1}):new s.MeshPhongMaterial,r.name=i.name,r.flatShading=!i.smooth,r.vertexColors=h,t.materials[a]=r),A.push(r)}let d;if(A.length>1){for(let e=0,t=o.length;e<t;e++){const t=o[e];c.addGroup(t.groupStart,t.groupCount,e)}d=n?new s.LineSegments(c,A):l?new s.Points(c,A):new s.Mesh(c,A)}else d=n?new s.LineSegments(c,A[0]):l?new s.Points(c,A[0]):new s.Mesh(c,A[0]);d.name=i.name,r.add(d)}else if(t.vertices.length>0){const e=new s.PointsMaterial({size:1,sizeAttenuation:!1}),i=new s.BufferGeometry;i.setAttribute("position",new s.Float32BufferAttribute(t.vertices,3)),t.colors.length>0&&void 0!==t.colors[0]&&(i.setAttribute("color",new s.Float32BufferAttribute(t.colors,3)),e.vertexColors=!0);const a=new s.Points(i,e);r.add(a)}return r}}class xa extends s.Loader{constructor(e){super(e)}load(e,t,i,a){const r=this,o=new s.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(s){try{t(r.parse(s))}catch(t){a?a(t):console.error(t),r.manager.itemError(e)}}),i,a)}parse(e){function t(e,t,s){for(let i=0,a=e.length;i<a;i++)if(e[i]!==t.getUint8(s+i))return!1;return!0}const i=function(e){if("string"==typeof e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=255&e.charCodeAt(s);return t.buffer||t}return e}(e);return function(e){const s=new DataView(e);if(84+50*s.getUint32(80,!0)===s.byteLength)return!0;const i=[115,111,108,105,100];for(let e=0;e<5;e++)if(t(i,s,e))return!1;return!0}(i)?function(e){const t=new DataView(e),i=t.getUint32(80,!0);let a,r,o,n,l,h,c,A,d=!1;for(let e=0;e<70;e++)1129270351==t.getUint32(e,!1)&&82==t.getUint8(e+4)&&61==t.getUint8(e+5)&&(d=!0,n=new Float32Array(3*i*3),l=t.getUint8(e+6)/255,h=t.getUint8(e+7)/255,c=t.getUint8(e+8)/255,A=t.getUint8(e+9)/255);const u=new s.BufferGeometry,p=new Float32Array(3*i*3),m=new Float32Array(3*i*3),g=new s.Color;for(let e=0;e<i;e++){const i=84+50*e,A=t.getFloat32(i,!0),u=t.getFloat32(i+4,!0),f=t.getFloat32(i+8,!0);if(d){const e=t.getUint16(i+48,!0);32768&e?(a=l,r=h,o=c):(a=(31&e)/31,r=(e>>5&31)/31,o=(e>>10&31)/31)}for(let l=1;l<=3;l++){const h=i+12*l,c=3*e*3+3*(l-1);p[c]=t.getFloat32(h,!0),p[c+1]=t.getFloat32(h+4,!0),p[c+2]=t.getFloat32(h+8,!0),m[c]=A,m[c+1]=u,m[c+2]=f,d&&(g.setRGB(a,r,o,s.SRGBColorSpace),n[c]=g.r,n[c+1]=g.g,n[c+2]=g.b)}}return u.setAttribute("position",new s.BufferAttribute(p,3)),u.setAttribute("normal",new s.BufferAttribute(m,3)),d&&(u.setAttribute("color",new s.BufferAttribute(n,3)),u.hasColors=!0,u.alpha=A),u}(i):function(e){const t=new s.BufferGeometry,i=/solid([\s\S]*?)endsolid/g,a=/facet([\s\S]*?)endfacet/g,r=/solid\s(.+)/;let o=0;const n=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,l=new RegExp("vertex"+n+n+n,"g"),h=new RegExp("normal"+n+n+n,"g"),c=[],A=[],d=[],u=new s.Vector3;let p,m=0,g=0,f=0;for(;null!==(p=i.exec(e));){g=f;const e=p[0],s=null!==(p=r.exec(e))?p[1]:"";for(d.push(s);null!==(p=a.exec(e));){let e=0,t=0;const s=p[0];for(;null!==(p=h.exec(s));)u.x=parseFloat(p[1]),u.y=parseFloat(p[2]),u.z=parseFloat(p[3]),t++;for(;null!==(p=l.exec(s));)c.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])),A.push(u.x,u.y,u.z),e++,f++;1!==t&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+o),3!==e&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+o),o++}const i=g,n=f-g;t.userData.groupNames=d,t.addGroup(i,n,m),m++}return t.setAttribute("position",new s.Float32BufferAttribute(c,3)),t.setAttribute("normal",new s.Float32BufferAttribute(A,3)),t}("string"!=typeof(a=e)?(new TextDecoder).decode(a):a);var a}}class Ba extends s.DataTextureLoader{constructor(e){super(e),this.type=s.HalfFloatType}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},i=function(e,t,s){t=t||1024;let i=e.pos,a=-1,r=0,o="",n=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));for(;0>(a=n.indexOf("\n"))&&r<t&&i<e.byteLength;)o+=n,r+=n.length,i+=128,n+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));return-1<a&&(e.pos+=r+a+1,o+n.slice(0,a))},a=function(e,t,s,i){const a=e[t+3],r=Math.pow(2,a-128)/255;s[i+0]=e[t+0]*r,s[i+1]=e[t+1]*r,s[i+2]=e[t+2]*r,s[i+3]=1},r=function(e,t,i,a){const r=e[t+3],o=Math.pow(2,r-128)/255;i[a+0]=s.DataUtils.toHalfFloat(Math.min(e[t+0]*o,65504)),i[a+1]=s.DataUtils.toHalfFloat(Math.min(e[t+1]*o,65504)),i[a+2]=s.DataUtils.toHalfFloat(Math.min(e[t+2]*o,65504)),i[a+3]=s.DataUtils.toHalfFloat(1)},o=new Uint8Array(e);o.pos=0;const n=function(e){const s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,o=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,n={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((e.pos>=e.byteLength||!(l=i(e)))&&t(1,"no header found"),(h=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),n.valid|=1,n.programtype=h[1],n.string+=l+"\n";l=i(e),!1!==l;)if(n.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(s))&&(n.gamma=parseFloat(h[1])),(h=l.match(a))&&(n.exposure=parseFloat(h[1])),(h=l.match(r))&&(n.valid|=2,n.format=h[1]),(h=l.match(o))&&(n.valid|=4,n.height=parseInt(h[1],10),n.width=parseInt(h[2],10)),2&n.valid&&4&n.valid)break}else n.comments+=l+"\n";return 2&n.valid||t(3,"missing format specifier"),4&n.valid||t(3,"missing image size specifier"),n}(o),l=n.width,h=n.height,c=function(e,s,i){const a=s;if(a<8||a>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);a!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const r=new Uint8Array(4*s*i);r.length||t(4,"unable to allocate buffer space");let o=0,n=0;const l=4*a,h=new Uint8Array(4),c=new Uint8Array(l);let A=i;for(;A>0&&n<e.byteLength;){n+4>e.byteLength&&t(1),h[0]=e[n++],h[1]=e[n++],h[2]=e[n++],h[3]=e[n++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==a||t(3,"bad rgbe scanline format");let s,i=0;for(;i<l&&n<e.byteLength;){s=e[n++];const a=s>128;if(a&&(s-=128),(0===s||i+s>l)&&t(3,"bad scanline data"),a){const t=e[n++];for(let e=0;e<s;e++)c[i++]=t}else c.set(e.subarray(n,n+s),i),i+=s,n+=s}const d=a;for(let e=0;e<d;e++){let t=0;r[o]=c[e+t],t+=a,r[o+1]=c[e+t],t+=a,r[o+2]=c[e+t],t+=a,r[o+3]=c[e+t],o+=4}A--}return r}(o.subarray(o.pos),l,h);let A,d,u;switch(this.type){case s.FloatType:u=c.length/4;const e=new Float32Array(4*u);for(let t=0;t<u;t++)a(c,4*t,e,4*t);A=e,d=s.FloatType;break;case s.HalfFloatType:u=c.length/4;const t=new Uint16Array(4*u);for(let e=0;e<u;e++)r(c,4*e,t,4*e);A=t,d=s.HalfFloatType;break;default:throw new Error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:l,height:h,data:A,header:n.string,gamma:n.gamma,exposure:n.exposure,type:d}}setDataType(e){return this.type=e,this}load(e,t,i,a){return super.load(e,(function(e,i){switch(e.type){case s.FloatType:case s.HalfFloatType:e.colorSpace=s.LinearSRGBColorSpace,e.minFilter=s.LinearFilter,e.magFilter=s.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,i)}),i,a)}}class Ea extends s.DataTextureLoader{constructor(e){super(e),this.type=s.HalfFloatType}parse(e){const t=65536,i=14,a=65537,r=16384,o=Math.pow(2.7182818,2.2);const n={l:0,c:0,lc:0};function l(e,t,s,i,a){for(;s<e;)t=t<<8|N(i,a),s+=8;s-=e,n.l=t>>s&(1<<e)-1,n.c=t,n.lc=s}const h=new Array(59);function c(e,t,s,i,r,o){const c=t;let A=0,d=0;for(;i<=r;i++){if(c.value-t.value>s)return!1;l(6,A,d,e,c);const a=n.l;if(A=n.c,d=n.lc,o[i]=a,63==a){if(c.value-t.value>s)throw new Error("Something wrong with hufUnpackEncTable");l(8,A,d,e,c);let a=n.l+6;if(A=n.c,d=n.lc,i+a>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;a--;)o[i++]=0;i--}else if(a>=59){let e=a-59+2;if(i+e>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)o[i++]=0;i--}}!function(e){for(let e=0;e<=58;++e)h[e]=0;for(let t=0;t<a;++t)h[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const s=t+h[e]>>1;h[e]=t,t=s}for(let t=0;t<a;++t){const s=e[t];s>0&&(e[t]=s|h[s]++<<6)}}(o)}function A(e){return 63&e}function d(e){return e>>6}const u={c:0,lc:0};function p(e,t,s,i){e=e<<8|N(s,i),t+=8,u.c=e,u.lc=t}const m={c:0,lc:0};function g(e,t,s,i,a,r,o,n,l){if(e==t){i<8&&(p(s,i,a,r),s=u.c,i=u.lc);let e=s>>(i-=8);if(e=new Uint8Array([e])[0],n.value+e>l)return!1;const t=o[n.value-1];for(;e-- >0;)o[n.value++]=t}else{if(!(n.value<l))return!1;o[n.value++]=e}m.c=s,m.lc=i}function f(e){return 65535&e}function b(e){const t=f(e);return t>32767?t-65536:t}const y={a:0,b:0};function w(e,t){const s=b(e),i=b(t),a=s+(1&i)+(i>>1),r=a,o=a-i;y.a=r,y.b=o}function v(e,t){const s=f(e),i=f(t),a=s-(i>>1)&65535,r=i+a-32768&65535;y.a=r,y.b=a}function C(e,t,s,i,a,r,o){const n=o<16384,l=s>a?a:s;let h,c,A=1;for(;A<=l;)A<<=1;for(A>>=1,h=A,A>>=1;A>=1;){c=0;const o=c+r*(a-h),l=r*A,d=r*h,u=i*A,p=i*h;let m,g,f,b;for(;c<=o;c+=d){let a=c;const r=c+i*(s-h);for(;a<=r;a+=p){const s=a+u,i=a+l,r=i+u;n?(w(e[a+t],e[i+t]),m=y.a,f=y.b,w(e[s+t],e[r+t]),g=y.a,b=y.b,w(m,g),e[a+t]=y.a,e[s+t]=y.b,w(f,b),e[i+t]=y.a,e[r+t]=y.b):(v(e[a+t],e[i+t]),m=y.a,f=y.b,v(e[s+t],e[r+t]),g=y.a,b=y.b,v(m,g),e[a+t]=y.a,e[s+t]=y.b,v(f,b),e[i+t]=y.a,e[r+t]=y.b)}if(s&A){const s=a+l;n?w(e[a+t],e[s+t]):v(e[a+t],e[s+t]),m=y.a,e[s+t]=y.b,e[a+t]=m}}if(a&A){let a=c;const r=c+i*(s-h);for(;a<=r;a+=p){const s=a+u;n?w(e[a+t],e[s+t]):v(e[a+t],e[s+t]),m=y.a,e[s+t]=y.b,e[a+t]=m}}h=A,A>>=1}return c}function I(e,t,s,o,n,l){const h=s.value,f=O(t,s),b=O(t,s);s.value+=4;const y=O(t,s);if(s.value+=4,f<0||f>=a||b<0||b>=a)throw new Error("Something wrong with HUF_ENCSIZE");const w=new Array(a),v=new Array(r);!function(e){for(let t=0;t<r;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(v);if(c(e,s,o-(s.value-h),f,b,w),y>8*(o-(s.value-h)))throw new Error("Something wrong with hufUncompress");!function(e,t,s,a){for(;t<=s;t++){const s=d(e[t]),r=A(e[t]);if(s>>r)throw new Error("Invalid table entry");if(r>i){const e=a[s>>r-i];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let s=0;s<e.lit-1;++s)e.p[s]=t[s]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(r){let e=0;for(let o=1<<i-r;o>0;o--){const o=a[(s<<i-r)+e];if(o.len||o.p)throw new Error("Invalid table entry");o.len=r,o.lit=t,e++}}}}(w,f,b,v),function(e,t,s,a,r,o,n,l,h){let c=0,f=0;const b=n,y=Math.trunc(a.value+(r+7)/8);for(;a.value<y;)for(p(c,f,s,a),c=u.c,f=u.lc;f>=i;){const r=t[c>>f-i&16383];if(r.len)f-=r.len,g(r.lit,o,c,f,s,a,l,h,b),c=m.c,f=m.lc;else{if(!r.p)throw new Error("hufDecode issues");let t;for(t=0;t<r.lit;t++){const i=A(e[r.p[t]]);for(;f<i&&a.value<y;)p(c,f,s,a),c=u.c,f=u.lc;if(f>=i&&d(e[r.p[t]])==(c>>f-i&(1<<i)-1)){f-=i,g(r.p[t],o,c,f,s,a,l,h,b),c=m.c,f=m.lc;break}}if(t==r.lit)throw new Error("hufDecode issues")}}const w=8-r&7;for(c>>=w,f-=w;f>0;){const e=t[c<<i-f&16383];if(!e.len)throw new Error("hufDecode issues");f-=e.len,g(e.lit,o,c,f,s,a,l,h,b),c=m.c,f=m.lc}}(w,v,e,s,y,b,l,n,{value:0})}function x(e){for(let t=1;t<e.length;t++){const s=e[t-1]+e[t]-128;e[t]=s}}function B(e,t){let s=0,i=Math.floor((e.length+1)/2),a=0;const r=e.length-1;for(;!(a>r||(t[a++]=e[s++],a>r));)t[a++]=e[i++]}function E(e){let t=e.byteLength;const s=new Array;let i=0;const a=new DataView(e);for(;t>0;){const e=a.getInt8(i++);if(e<0){const r=-e;t-=r+1;for(let e=0;e<r;e++)s.push(a.getUint8(i++))}else{const r=e;t-=2;const o=a.getUint8(i++);for(let e=0;e<r+1;e++)s.push(o)}}return s}function M(e,t,s){let i,a=1;for(;a<64;)i=t[e.value],65280==i?a=64:i>>8==255?a+=255&i:(s[a]=i,a++),e.value++}function S(e,t){t[0]=W(e[0]),t[1]=W(e[1]),t[2]=W(e[5]),t[3]=W(e[6]),t[4]=W(e[14]),t[5]=W(e[15]),t[6]=W(e[27]),t[7]=W(e[28]),t[8]=W(e[2]),t[9]=W(e[4]),t[10]=W(e[7]),t[11]=W(e[13]),t[12]=W(e[16]),t[13]=W(e[26]),t[14]=W(e[29]),t[15]=W(e[42]),t[16]=W(e[3]),t[17]=W(e[8]),t[18]=W(e[12]),t[19]=W(e[17]),t[20]=W(e[25]),t[21]=W(e[30]),t[22]=W(e[41]),t[23]=W(e[43]),t[24]=W(e[9]),t[25]=W(e[11]),t[26]=W(e[18]),t[27]=W(e[24]),t[28]=W(e[31]),t[29]=W(e[40]),t[30]=W(e[44]),t[31]=W(e[53]),t[32]=W(e[10]),t[33]=W(e[19]),t[34]=W(e[23]),t[35]=W(e[32]),t[36]=W(e[39]),t[37]=W(e[45]),t[38]=W(e[52]),t[39]=W(e[54]),t[40]=W(e[20]),t[41]=W(e[22]),t[42]=W(e[33]),t[43]=W(e[38]),t[44]=W(e[46]),t[45]=W(e[51]),t[46]=W(e[55]),t[47]=W(e[60]),t[48]=W(e[21]),t[49]=W(e[34]),t[50]=W(e[37]),t[51]=W(e[47]),t[52]=W(e[50]),t[53]=W(e[56]),t[54]=W(e[59]),t[55]=W(e[61]),t[56]=W(e[35]),t[57]=W(e[36]),t[58]=W(e[48]),t[59]=W(e[49]),t[60]=W(e[57]),t[61]=W(e[58]),t[62]=W(e[62]),t[63]=W(e[63])}function k(e){const t=.5*Math.cos(.7853975),s=.5*Math.cos(3.14159/16),i=.5*Math.cos(3.14159/8),a=.5*Math.cos(3*3.14159/16),r=.5*Math.cos(.981746875),o=.5*Math.cos(3*3.14159/8),n=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),A=new Array(4);for(let d=0;d<8;++d){const u=8*d;l[0]=i*e[u+2],l[1]=o*e[u+2],l[2]=i*e[u+6],l[3]=o*e[u+6],h[0]=s*e[u+1]+a*e[u+3]+r*e[u+5]+n*e[u+7],h[1]=a*e[u+1]-n*e[u+3]-s*e[u+5]-r*e[u+7],h[2]=r*e[u+1]-s*e[u+3]+n*e[u+5]+a*e[u+7],h[3]=n*e[u+1]-r*e[u+3]+a*e[u+5]-s*e[u+7],c[0]=t*(e[u+0]+e[u+4]),c[3]=t*(e[u+0]-e[u+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[u+0]=A[0]+h[0],e[u+1]=A[1]+h[1],e[u+2]=A[2]+h[2],e[u+3]=A[3]+h[3],e[u+4]=A[3]-h[3],e[u+5]=A[2]-h[2],e[u+6]=A[1]-h[1],e[u+7]=A[0]-h[0]}for(let d=0;d<8;++d)l[0]=i*e[16+d],l[1]=o*e[16+d],l[2]=i*e[48+d],l[3]=o*e[48+d],h[0]=s*e[8+d]+a*e[24+d]+r*e[40+d]+n*e[56+d],h[1]=a*e[8+d]-n*e[24+d]-s*e[40+d]-r*e[56+d],h[2]=r*e[8+d]-s*e[24+d]+n*e[40+d]+a*e[56+d],h[3]=n*e[8+d]-r*e[24+d]+a*e[40+d]-s*e[56+d],c[0]=t*(e[d]+e[32+d]),c[3]=t*(e[d]-e[32+d]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[0+d]=A[0]+h[0],e[8+d]=A[1]+h[1],e[16+d]=A[2]+h[2],e[24+d]=A[3]+h[3],e[32+d]=A[3]-h[3],e[40+d]=A[2]-h[2],e[48+d]=A[1]-h[1],e[56+d]=A[0]-h[0]}function Q(e){for(let t=0;t<64;++t){const s=e[0][t],i=e[1][t],a=e[2][t];e[0][t]=s+1.5747*a,e[1][t]=s-.1873*i-.4682*a,e[2][t]=s+1.8556*i}}function R(e,t,i){for(let a=0;a<64;++a)t[i+a]=s.DataUtils.toHalfFloat(T(e[a]))}function T(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(o,Math.abs(e)-1)}function F(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function D(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),s=new Uint8Array(E(t)),i=new Uint8Array(s.length);return x(s),B(s,i),new DataView(i.buffer)}function L(e){const t=_i(e.array.slice(e.offset.value,e.offset.value+e.size)),s=new Uint8Array(t.length);return x(t),B(t,s),new DataView(s.buffer)}function P(e){const s=e.viewer,i={value:e.offset.value},a=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),r=new Uint8Array(8192);let o=0;const n=new Array(e.inputChannels.length);for(let t=0,s=e.inputChannels.length;t<s;t++)n[t]={},n[t].start=o,n[t].end=n[t].start,n[t].nx=e.columns,n[t].ny=e.lines,n[t].size=e.type,o+=n[t].nx*n[t].ny*n[t].size;const l=K(s,i),h=K(s,i);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let e=0;e<h-l+1;e++)r[e+l]=V(s,i);const c=new Uint16Array(t),A=function(e,s){let i=0;for(let a=0;a<t;++a)(0==a||e[a>>3]&1<<(7&a))&&(s[i++]=a);const a=i-1;for(;i<t;)s[i++]=0;return a}(r,c),d=O(s,i);I(e.array,s,i,d,a,o);for(let t=0;t<e.inputChannels.length;++t){const e=n[t];for(let s=0;s<n[t].size;++s)C(a,e.start+s,e.nx,e.size,e.ny,e.nx*e.size,A)}!function(e,t,s){for(let i=0;i<s;++i)t[i]=e[t[i]]}(c,a,o);let u=0;const p=new Uint8Array(a.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){const e=n[t],s=e.nx*e.size,i=new Uint8Array(a.buffer,2*e.end,2*s);p.set(i,u),u+=2*s,e.end+=s}return new DataView(p.buffer)}function _(e){const t=_i(e.array.slice(e.offset.value,e.offset.value+e.size)),s=e.inputChannels.length*e.lines*e.columns*e.totalBytes,i=new ArrayBuffer(s),a=new DataView(i);let r=0,o=0;const n=new Array(4);for(let s=0;s<e.lines;s++)for(let s=0;s<e.inputChannels.length;s++){let i=0;switch(e.inputChannels[s].pixelType){case 1:n[0]=r,n[1]=n[0]+e.columns,r=n[1]+e.columns;for(let s=0;s<e.columns;++s){i+=t[n[0]++]<<8|t[n[1]++],a.setUint16(o,i,!0),o+=2}break;case 2:n[0]=r,n[1]=n[0]+e.columns,n[2]=n[1]+e.columns,r=n[2]+e.columns;for(let s=0;s<e.columns;++s){i+=t[n[0]++]<<24|t[n[1]++]<<16|t[n[2]++]<<8,a.setUint32(o,i,!0),o+=4}}}return a}function G(e){const t=e.viewer,s={value:e.offset.value},i=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),a={version:q(t,s),unknownUncompressedSize:q(t,s),unknownCompressedSize:q(t,s),acCompressedSize:q(t,s),dcCompressedSize:q(t,s),rleCompressedSize:q(t,s),rleUncompressedSize:q(t,s),rleRawSize:q(t,s),totalAcUncompressedCount:q(t,s),totalDcUncompressedCount:q(t,s),acCompression:q(t,s)};if(a.version<2)throw new Error("EXRLoader.parse: "+ae.compression+" version "+a.version+" is unsupported");const r=new Array;let o=K(t,s)-2;for(;o>0;){const e=z(t.buffer,s),i=V(t,s),a=i>>2&3,n=new Int8Array([(i>>4)-1])[0],l=V(t,s);r.push({name:e,index:n,type:l,compression:a}),o-=e.length+3}const n=ae.channels,l=new Array(e.inputChannels.length);for(let t=0;t<e.inputChannels.length;++t){const s=l[t]={},i=n[t];s.name=i.name,s.compression=0,s.decoded=!1,s.type=i.pixelType,s.pLinear=i.pLinear,s.width=e.columns,s.height=e.lines}const h={idx:new Array(3)};for(let t=0;t<e.inputChannels.length;++t){const e=l[t];for(let s=0;s<r.length;++s){const i=r[s];e.name==i.name&&(e.compression=i.compression,i.index>=0&&(h.idx[i.index]=t),e.offset=t)}}let c,A,d;if(a.acCompressedSize>0)switch(a.acCompression){case 0:c=new Uint16Array(a.totalAcUncompressedCount),I(e.array,t,s,a.acCompressedSize,c,a.totalAcUncompressedCount);break;case 1:const i=_i(e.array.slice(s.value,s.value+a.totalAcUncompressedCount));c=new Uint16Array(i.buffer),s.value+=a.totalAcUncompressedCount}if(a.dcCompressedSize>0){const t={array:e.array,offset:s,size:a.dcCompressedSize};A=new Uint16Array(L(t).buffer),s.value+=a.dcCompressedSize}if(a.rleRawSize>0){d=E(_i(e.array.slice(s.value,s.value+a.rleCompressedSize)).buffer),s.value+=a.rleCompressedSize}let u=0;const p=new Array(l.length);for(let e=0;e<p.length;++e)p[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<l.length;++t)p[t].push(u),u+=l[t].width*e.type*2;!function(e,t,s,i,a,r){let o=new DataView(r.buffer);const n=s[e.idx[0]].width,l=s[e.idx[0]].height,h=Math.floor(n/8),c=Math.ceil(n/8),A=Math.ceil(l/8),d=n-8*(c-1),u=l-8*(A-1),p={value:0},m=new Array(3),g=new Array(3),f=new Array(3),b=new Array(3),y=new Array(3);for(let s=0;s<3;++s)y[s]=t[e.idx[s]],m[s]=s<1?0:m[s-1]+c*A,g[s]=new Float32Array(64),f[s]=new Uint16Array(64),b[s]=new Uint16Array(64*c);for(let t=0;t<A;++t){let r=8;t==A-1&&(r=u);let n=8;for(let e=0;e<c;++e){e==c-1&&(n=d);for(let e=0;e<3;++e)f[e].fill(0),f[e][0]=a[m[e]++],M(p,i,f[e]),S(f[e],g[e]),k(g[e]);Q(g);for(let t=0;t<3;++t)R(g[t],b[t],64*e)}let l=0;for(let i=0;i<3;++i){const a=s[e.idx[i]].type;for(let e=8*t;e<8*t+r;++e){l=y[i][e];for(let t=0;t<h;++t){const s=64*t+8*(7&e);o.setUint16(l+0*a,b[i][s+0],!0),o.setUint16(l+2*a,b[i][s+1],!0),o.setUint16(l+4*a,b[i][s+2],!0),o.setUint16(l+6*a,b[i][s+3],!0),o.setUint16(l+8*a,b[i][s+4],!0),o.setUint16(l+10*a,b[i][s+5],!0),o.setUint16(l+12*a,b[i][s+6],!0),o.setUint16(l+14*a,b[i][s+7],!0),l+=16*a}}if(h!=c)for(let e=8*t;e<8*t+r;++e){const t=y[i][e]+8*h*2*a,s=64*h+8*(7&e);for(let e=0;e<n;++e)o.setUint16(t+2*e*a,b[i][s+e],!0)}}}const w=new Uint16Array(n);o=new DataView(r.buffer);for(let t=0;t<3;++t){s[e.idx[t]].decoded=!0;const i=s[e.idx[t]].type;if(2==s[t].type)for(let e=0;e<l;++e){const s=y[t][e];for(let e=0;e<n;++e)w[e]=o.getUint16(s+2*e*i,!0);for(let e=0;e<n;++e)o.setFloat32(s+2*e*i,W(w[e]),!0)}}}(h,p,l,c,A,i);for(let t=0;t<l.length;++t){const s=l[t];if(!s.decoded){if(2!==s.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let a=0,r=0;for(let o=0;o<e.lines;++o){let e=p[t][a];for(let t=0;t<s.width;++t){for(let t=0;t<2*s.type;++t)i[e++]=d[r+t*s.width*s.height];r++}a++}}}}return new DataView(i.buffer)}function z(e,t){const s=new Uint8Array(e);let i=0;for(;0!=s[t.value+i];)i+=1;const a=(new TextDecoder).decode(s.slice(t.value,t.value+i));return t.value=t.value+i+1,a}function U(e,t){const s=e.getInt32(t.value,!0);return t.value=t.value+4,s}function O(e,t){const s=e.getUint32(t.value,!0);return t.value=t.value+4,s}function N(e,t){const s=e[t.value];return t.value=t.value+1,s}function V(e,t){const s=e.getUint8(t.value);return t.value=t.value+1,s}const q=function(e,t){let s;return s="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,s};function H(e,t){const s=e.getFloat32(t.value,!0);return t.value+=4,s}function j(e,t){return s.DataUtils.toHalfFloat(H(e,t))}function W(e){const t=(31744&e)>>10,s=1023&e;return(e>>15?-1:1)*(t?31===t?s?NaN:1/0:Math.pow(2,t-15)*(1+s/1024):s/1024*6103515625e-14)}function K(e,t){const s=e.getUint16(t.value,!0);return t.value+=2,s}function J(e,t){return W(K(e,t))}function Y(e,t,s,i,a){return"string"===i||"stringvector"===i||"iccProfile"===i?function(e,t,s){const i=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+s));return t.value=t.value+s,i}(t,s,a):"chlist"===i?function(e,t,s,i){const a=s.value,r=[];for(;s.value<a+i-1;){const i=z(t,s),a=U(e,s),o=V(e,s);s.value+=3;const n=U(e,s),l=U(e,s);r.push({name:i,pixelType:a,pLinear:o,xSampling:n,ySampling:l})}return s.value+=1,r}(e,t,s,a):"chromaticities"===i?function(e,t){return{redX:H(e,t),redY:H(e,t),greenX:H(e,t),greenY:H(e,t),blueX:H(e,t),blueY:H(e,t),whiteX:H(e,t),whiteY:H(e,t)}}(e,s):"compression"===i?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][V(e,t)]}(e,s):"box2i"===i?function(e,t){return{xMin:U(e,t),yMin:U(e,t),xMax:U(e,t),yMax:U(e,t)}}(e,s):"envmap"===i?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][V(e,t)]}(e,s):"tiledesc"===i?function(e,t){const s=O(e,t),i=O(e,t),a=V(e,t);return{xSize:s,ySize:i,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&a],roundingMode:["ROUND_DOWN","ROUND_UP"][a>>4]}}(e,s):"lineOrder"===i?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][V(e,t)]}(e,s):"float"===i?H(e,s):"v2f"===i?function(e,t){return[H(e,t),H(e,t)]}(e,s):"v3f"===i?function(e,t){return[H(e,t),H(e,t),H(e,t)]}(e,s):"int"===i?U(e,s):"rational"===i?function(e,t){return[U(e,t),O(e,t)]}(e,s):"timecode"===i?function(e,t){return[O(e,t),O(e,t)]}(e,s):"preview"===i?(s.value+=a,"skipped"):void(s.value+=a)}function X(e,t,s){let i=0;switch(e.levelMode){case"ONE_LEVEL":i=1;break;case"MIPMAP_LEVELS":i=function(e,t){const s=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(s):Math.ceil(s)}(Math.max(t,s),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return i}function Z(e,t,s,i){const a=new Array(e);for(let r=0;r<e;r++){const e=1<<r;let o=t/e|0;"ROUND_UP"==i&&o*e<t&&(o+=1);const n=Math.max(o,1);a[r]=(n+s-1)/s|0}return a}function $(){const e=this,t=e.offset,s={value:0};for(let i=0;i<e.tileCount;i++){const i=U(e.viewer,t),a=U(e.viewer,t);t.value+=8,e.size=O(e.viewer,t);const r=i*e.blockWidth,o=a*e.blockHeight;e.columns=r+e.blockWidth>e.width?e.width-r:e.blockWidth,e.lines=o+e.blockHeight>e.height?e.height-o:e.blockHeight;const n=e.columns*e.totalBytes,l=e.size<e.lines*n?e.uncompress(e):F(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const i=t*e.columns*e.totalBytes;for(let a=0;a<e.inputChannels.length;a++){const n=ae.channels[a].name,h=e.channelByteOffsets[n]*e.columns,c=e.decodeChannels[n];if(void 0===c)continue;s.value=i+h;const A=(e.height-(1+o+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const i=A+(t+r)*e.outputChannels+c;e.byteArray[i]=e.getter(l,s)}}}}}function ee(){const e=this,t=e.offset,s={value:0};for(let i=0;i<e.height/e.blockHeight;i++){const a=U(e.viewer,t)-ae.dataWindow.yMin;e.size=O(e.viewer,t),e.lines=a+e.blockHeight>e.height?e.height-a:e.blockHeight;const r=e.columns*e.totalBytes,o=e.size<e.lines*r?e.uncompress(e):F(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const a=i*e.blockHeight,n=t+e.scanOrder(a);if(n>=e.height)continue;const l=t*r,h=(e.height-1-n)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const i=ae.channels[t].name,a=e.channelByteOffsets[i]*e.columns,r=e.decodeChannels[i];if(void 0!==r){s.value=l+a;for(let t=0;t<e.columns;t++){const i=h+t*e.outputChannels+r;e.byteArray[i]=e.getter(o,s)}}}}}}const te={value:0},se=new DataView(e),ie=new Uint8Array(e),ae=function(e,t,s){const i={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");i.version=e.getUint8(4);const a=e.getUint8(5);i.spec={singleTile:!!(2&a),longName:!!(4&a),deepFormat:!!(8&a),multiPart:!!(16&a)},s.value=8;let r=!0;for(;r;){const a=z(t,s);if(0==a)r=!1;else{const r=z(t,s),o=Y(e,t,s,r,O(e,s));void 0===o?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${r}'.`):i[a]=o}}if(-7&a)throw console.error("THREE.EXRHeader:",i),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return i}(se,e,te),re=function(e,t,i,a,r){const o={size:0,viewer:t,array:i,offset:a,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:s.LinearSRGBColorSpace};switch(e.compression){case"NO_COMPRESSION":o.blockHeight=1,o.uncompress=F;break;case"RLE_COMPRESSION":o.blockHeight=1,o.uncompress=D;break;case"ZIPS_COMPRESSION":o.blockHeight=1,o.uncompress=L;break;case"ZIP_COMPRESSION":o.blockHeight=16,o.uncompress=L;break;case"PIZ_COMPRESSION":o.blockHeight=32,o.uncompress=P;break;case"PXR24_COMPRESSION":o.blockHeight=16,o.uncompress=_;break;case"DWAA_COMPRESSION":o.blockHeight=32,o.uncompress=G;break;case"DWAB_COMPRESSION":o.blockHeight=256,o.uncompress=G;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const n={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":n[t.name]=!0,o.type=t.pixelType}let l=!1;if(n.R&&n.G&&n.B)l=!n.A,o.outputChannels=4,o.decodeChannels={R:0,G:1,B:2,A:3};else{if(!n.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");o.outputChannels=1,o.decodeChannels={Y:0}}if(1==o.type)switch(r){case s.FloatType:o.getter=J;break;case s.HalfFloatType:o.getter=K}else{if(2!=o.type)throw new Error("EXRLoader.parse: unsupported pixelType "+o.type+" for "+e.compression+".");switch(r){case s.FloatType:o.getter=H;break;case s.HalfFloatType:o.getter=j}}o.columns=o.width;const h=o.width*o.height*o.outputChannels;switch(r){case s.FloatType:o.byteArray=new Float32Array(h),l&&o.byteArray.fill(1,0,h);break;case s.HalfFloatType:o.byteArray=new Uint16Array(h),l&&o.byteArray.fill(15360,0,h);break;default:console.error("THREE.EXRLoader: unsupported type: ",r)}let c=0;for(const t of e.channels)void 0!==o.decodeChannels[t.name]&&(o.channelByteOffsets[t.name]=c),c+=2*t.pixelType;if(o.totalBytes=c,o.outLineWidth=o.width*o.outputChannels,"INCREASING_Y"===e.lineOrder?o.scanOrder=e=>e:o.scanOrder=e=>o.height-1-e,4==o.outputChannels?(o.format=s.RGBAFormat,o.colorSpace=s.LinearSRGBColorSpace):(o.format=s.RedFormat,o.colorSpace=s.NoColorSpace),e.spec.singleTile){o.blockHeight=e.tiles.ySize,o.blockWidth=e.tiles.xSize;const s=X(e.tiles,o.width,o.height),i=Z(s,o.width,e.tiles.xSize,e.tiles.roundingMode),r=Z(s,o.height,e.tiles.ySize,e.tiles.roundingMode);o.tileCount=i[0]*r[0];for(let e=0;e<s;e++)for(let s=0;s<r[e];s++)for(let s=0;s<i[e];s++)q(t,a);o.decode=$.bind(o)}else{o.blockWidth=o.width;const e=Math.ceil(o.height/o.blockHeight);for(let s=0;s<e;s++)q(t,a);o.decode=ee.bind(o)}return o}(ae,se,ie,te,this.type);return re.decode(),{header:ae,width:re.width,height:re.height,data:re.byteArray,format:re.format,colorSpace:re.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,a){return super.load(e,(function(e,i){e.colorSpace=i.colorSpace,e.minFilter=s.LinearFilter,e.magFilter=s.LinearFilter,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,i)}),i,a)}}class Ma{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const s=this.workersResolve[e];if(s&&s(t),this.queue.length){const{resolve:t,msg:s,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(s,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((s=>{const i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=s,this.workers[i].postMessage(e,t)):this.queue.push({resolve:s,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const Sa=9,ka=15,Qa=16,Ra=22,Ta=37,Fa=43,Da=76,La=83,Pa=97,_a=100,Ga=103,za=109,Ua=165,Oa=166,Na=1000066e3;class Va{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class qa{constructor(e,t,s,i){this._dataView=new DataView(e.buffer,e.byteOffset+t,s),this._littleEndian=i,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_skip(e){return this._offset+=e,this}_scan(e,t=0){const s=this._offset;let i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,i)}}const Ha=[171,75,84,88,32,50,48,187,13,10,26,10];function ja(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}let Wa,Ka,Ja;const Ya={env:{emscripten_notify_memory_growth:function(e){Ja=new Uint8Array(Ka.exports.memory.buffer)}}};class Xa{init(){return Wa||(Wa="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+Za).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,Ya))).then(this._init):WebAssembly.instantiate(Buffer.from(Za,"base64"),Ya).then(this._init),Wa)}_init(e){Ka=e.instance,Ya.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Ka)throw new Error("ZSTDDecoder: Await .init() before decoding.");const s=e.byteLength,i=Ka.exports.malloc(s);Ja.set(e,i),t=t||Number(Ka.exports.ZSTD_findDecompressedSize(i,s));const a=Ka.exports.malloc(t),r=Ka.exports.ZSTD_decompress(a,t,i,s),o=Ja.slice(a,a+r);return Ka.exports.free(i),Ka.exports.free(a),o}}const Za="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQh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ASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEE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",$a=new WeakMap;let er,tr=0;class sr extends s.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new Ma,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const e=new s.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new s.FileLoader(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const a=i.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,a]).then((([e,t])=>{const s=sr.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(sr.EngineFormat),"let _EngineType = "+JSON.stringify(sr.EngineType),"let _TranscoderFormat = "+JSON.stringify(sr.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(sr.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),tr>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),tr++}return this.transcoderPending}load(e,t,i,a){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const r=new s.FileLoader(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{this.parse(e,t,a)}),i,a)}parse(e,t,s){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if($a.has(e)){return $a.get(e).promise.then(t).catch(s)}this._createTexture(e).then((e=>t?t(e):null)).catch(s)}_createTextureFrom(e,t){const{type:i,error:a,data:{faces:r,width:o,height:n,format:l,type:h,dfdFlags:c}}=e;if("error"===i)return Promise.reject(a);let A;if(6===t.faceCount)A=new s.CompressedCubeTexture(r,l,h);else{const e=r[0].mipmaps;A=t.layerCount>1?new s.CompressedArrayTexture(e,o,n,t.layerCount,l,h):new s.CompressedTexture(e,o,n,l,h)}return A.minFilter=1===r[0].mipmaps.length?s.LinearFilter:s.LinearMipmapLinearFilter,A.magFilter=s.LinearFilter,A.generateMipmaps=!1,A.needsUpdate=!0,A.colorSpace=or(t),A.premultiplyAlpha=!!(1&c),A}async _createTexture(e,t={}){const i=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,Ha.length);if(t[0]!==Ha[0]||t[1]!==Ha[1]||t[2]!==Ha[2]||t[3]!==Ha[3]||t[4]!==Ha[4]||t[5]!==Ha[5]||t[6]!==Ha[6]||t[7]!==Ha[7]||t[8]!==Ha[8]||t[9]!==Ha[9]||t[10]!==Ha[10]||t[11]!==Ha[11])throw new Error("Missing KTX 2.0 identifier.");const s=new Va,i=17*Uint32Array.BYTES_PER_ELEMENT,a=new qa(e,Ha.length,i,!0);s.vkFormat=a._nextUint32(),s.typeSize=a._nextUint32(),s.pixelWidth=a._nextUint32(),s.pixelHeight=a._nextUint32(),s.pixelDepth=a._nextUint32(),s.layerCount=a._nextUint32(),s.faceCount=a._nextUint32();const r=a._nextUint32();s.supercompressionScheme=a._nextUint32();const o=a._nextUint32(),n=a._nextUint32(),l=a._nextUint32(),h=a._nextUint32(),c=a._nextUint64(),A=a._nextUint64(),d=new qa(e,Ha.length+i,3*r*8,!0);for(let t=0;t<r;t++)s.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const u=new qa(e,o,n,!0),p={vendorId:u._skip(4)._nextUint16(),descriptorType:u._nextUint16(),versionNumber:u._nextUint16(),descriptorBlockSize:u._nextUint16(),colorModel:u._nextUint8(),colorPrimaries:u._nextUint8(),transferFunction:u._nextUint8(),flags:u._nextUint8(),texelBlockDimension:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],bytesPlane:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],samples:[]},m=(p.descriptorBlockSize/4-6)/4;for(let e=0;e<m;e++){const t={bitOffset:u._nextUint16(),bitLength:u._nextUint8(),channelType:u._nextUint8(),samplePosition:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=u._nextInt32(),t.sampleUpper=u._nextInt32()):(t.sampleLower=u._nextUint32(),t.sampleUpper=u._nextUint32()),p.samples[e]=t}s.dataFormatDescriptor.length=0,s.dataFormatDescriptor.push(p);const g=new qa(e,l,h,!0);for(;g._offset<h;){const e=g._nextUint32(),t=g._scan(e),i=ja(t),a=g._scan(e-t.byteLength);s.keyValue[i]=i.match(/^ktx/i)?ja(a):a,g._offset%4&&g._skip(4-g._offset%4)}if(A<=0)return s;const f=new qa(e,c,A,!0),b=f._nextUint16(),y=f._nextUint16(),w=f._nextUint32(),v=f._nextUint32(),C=f._nextUint32(),I=f._nextUint32(),x=[];for(let e=0;e<r;e++)x.push({imageFlags:f._nextUint32(),rgbSliceByteOffset:f._nextUint32(),rgbSliceByteLength:f._nextUint32(),alphaSliceByteOffset:f._nextUint32(),alphaSliceByteLength:f._nextUint32()});const B=c+f._offset,E=B+w,M=E+v,S=M+C,k=new Uint8Array(e.buffer,e.byteOffset+B,w),Q=new Uint8Array(e.buffer,e.byteOffset+E,v),R=new Uint8Array(e.buffer,e.byteOffset+M,C),T=new Uint8Array(e.buffer,e.byteOffset+S,I);return s.globalData={endpointCount:b,selectorCount:y,imageDescs:x,endpointsData:k,selectorsData:Q,tablesData:R,extendedData:T},s}(new Uint8Array(e)),a=i.vkFormat===Na&&167===i.dataFormatDescriptor[0].colorModel;if(!(0===i.vkFormat||a&&!this.workerConfig.astcHDRSupported))return async function(e){const{vkFormat:t}=e;if(void 0===ar[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let i;2===e.supercompressionScheme&&(er||(er=new Promise((async e=>{const t=new Xa;await t.init(),e(t)}))),i=await er);const a=[];for(let r=0;r<e.levels.length;r++){const o=Math.max(1,e.pixelWidth>>r),n=Math.max(1,e.pixelHeight>>r),l=e.pixelDepth?Math.max(1,e.pixelDepth>>r):0,h=e.levels[r];let c,A;if(0===e.supercompressionScheme)c=h.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");c=i.decode(h.levelData,h.uncompressedByteLength)}A=rr[t]===s.FloatType?new Float32Array(c.buffer,c.byteOffset,c.byteLength/Float32Array.BYTES_PER_ELEMENT):rr[t]===s.HalfFloatType?new Uint16Array(c.buffer,c.byteOffset,c.byteLength/Uint16Array.BYTES_PER_ELEMENT):c,a.push({data:A,width:o,height:n,depth:l})}let r;if(ir.has(ar[t]))r=0===e.pixelDepth?new s.DataTexture(a[0].data,e.pixelWidth,e.pixelHeight):new s.Data3DTexture(a[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");r=new s.CompressedTexture(a,e.pixelWidth,e.pixelHeight),r.minFilter=1===a.length?s.LinearFilter:s.LinearMipmapLinearFilter,r.magFilter=s.LinearFilter}return r.mipmaps=a,r.type=rr[t],r.format=ar[t],r.colorSpace=or(e),r.needsUpdate=!0,Promise.resolve(r)}(i);const r=t,o=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:r},[e]))).then((e=>this._createTextureFrom(e.data,i)));return $a.set(e,{promise:o}),o}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),tr--,this}}sr.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},sr.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},sr.EngineFormat={RGBAFormat:s.RGBAFormat,RGBA_ASTC_4x4_Format:s.RGBA_ASTC_4x4_Format,RGB_BPTC_UNSIGNED_Format:s.RGB_BPTC_UNSIGNED_Format,RGBA_BPTC_Format:s.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:s.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:s.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:s.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:s.RGB_ETC1_Format,RGB_ETC2_Format:s.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:s.RGB_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:s.RGBA_S3TC_DXT1_Format},sr.EngineType={UnsignedByteType:s.UnsignedByteType,HalfFloatType:s.HalfFloatType,FloatType:s.FloatType},sr.BasisWorker=function(){let e,t,s;const i=_EngineFormat,a=_EngineType,r=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",(function(i){const r=i.data;switch(r.type){case"init":e=r.config,n=r.transcoderBinary,t=new Promise((e=>{s={wasmBinary:n,onRuntimeInitialized:e},BASIS(s)})).then((()=>{s.initializeBasis(),void 0===s.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:i,width:n,height:A,hasAlpha:d,format:u,type:p,dfdFlags:m}=function(t){const i=new s.KTX2File(new Uint8Array(t));function r(){i.close(),i.delete()}if(!i.isValid())throw r(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");let n;if(i.isUASTC())n=o.UASTC;else if(i.isETC1S())n=o.ETC1S;else{if(!i.isHDR())throw new Error("THREE.KTX2Loader: Unknown Basis encoding");n=o.UASTC_HDR}const A=i.getWidth(),d=i.getHeight(),u=i.getLayers()||1,p=i.getLevels(),m=i.getFaces(),g=i.getHasAlpha(),f=i.getDFDFlags(),{transcoderFormat:b,engineFormat:y,engineType:w}=function(t,s,i,a){const r=l[t];for(let o=0;o<r.length;o++){const n=r[o];if(n.if&&!e[n.if])continue;if(!n.basisFormat.includes(t))continue;if(a&&n.transcoderFormat.length<2)continue;if(n.needsPowerOfTwo&&(!h(s)||!h(i)))continue;return{transcoderFormat:n.transcoderFormat[a?1:0],engineFormat:n.engineFormat[a?1:0],engineType:n.engineType[0]}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}(n,A,d,g);if(!A||!d||!p)throw r(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!i.startTranscoding())throw r(),new Error("THREE.KTX2Loader: .startTranscoding failed");const v=[],C=[];for(let e=0;e<m;e++){const t=[];for(let s=0;s<p;s++){const o=[];let n,l;for(let t=0;t<u;t++){const h=i.getImageLevelInfo(s,t,e);0!==e||0!==s||0!==t||h.origWidth%4==0&&h.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),p>1?(n=h.origWidth,l=h.origHeight):(n=h.width,l=h.height);let c=new Uint8Array(i.getImageTranscodedSizeInBytes(s,t,0,b));const A=i.transcodeImage(c,s,t,e,b,0,-1,-1);if(w===a.HalfFloatType&&(c=new Uint16Array(c.buffer,c.byteOffset,c.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!A)throw r(),new Error("THREE.KTX2Loader: .transcodeImage failed.");o.push(c)}const h=c(o);t.push({data:h,width:n,height:l}),C.push(h.buffer)}v.push({mipmaps:t,width:A,height:d,format:y,type:w})}return r(),{faces:v,buffers:C,width:A,height:d,hasAlpha:g,dfdFlags:f,format:y,type:w}}(r.buffer);self.postMessage({type:"transcode",id:r.id,data:{faces:t,width:n,height:A,hasAlpha:d,format:u,type:p,dfdFlags:m}},i)}catch(e){console.error(e),self.postMessage({type:"error",id:r.id,error:e.message})}}))}var n}));const n=[{if:"astcSupported",basisFormat:[o.UASTC],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],engineType:[a.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],engineType:[a.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.BC1,r.BC3],engineFormat:[i.RGBA_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],engineType:[a.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],engineType:[a.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.ETC1],engineFormat:[i.RGB_ETC1_Format],engineType:[a.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],engineType:[a.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[o.UASTC_HDR],transcoderFormat:[r.BC6H],engineFormat:[i.RGB_BPTC_UNSIGNED_Format],engineType:[a.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[o.ETC1S,o.UASTC],transcoderFormat:[r.RGBA32,r.RGBA32],engineFormat:[i.RGBAFormat,i.RGBAFormat],engineType:[a.UnsignedByteType,a.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[o.UASTC_HDR],transcoderFormat:[r.RGBA_HALF],engineFormat:[i.RGBAFormat],engineType:[a.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],l={[o.ETC1S]:n.filter((e=>e.basisFormat.includes(o.ETC1S))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[o.UASTC]:n.filter((e=>e.basisFormat.includes(o.UASTC))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[o.UASTC_HDR]:n.filter((e=>e.basisFormat.includes(o.UASTC_HDR))).sort(((e,t)=>e.priorityHDR-t.priorityHDR))};function h(e){return e<=2||!(e&e-1)&&0!==e}function c(e){if(1===e.length)return e[0];let t=0;for(let s=0;s<e.length;s++){t+=e[s].byteLength}const s=new Uint8Array(t);let i=0;for(let t=0;t<e.length;t++){const a=e[t];s.set(a,i),i+=a.byteLength}return s}};const ir=new Set([s.RGBAFormat,s.RGFormat,s.RedFormat]),ar={[za]:s.RGBAFormat,[Pa]:s.RGBAFormat,[Ta]:s.RGBAFormat,[Fa]:s.RGBAFormat,[Ga]:s.RGFormat,[La]:s.RGFormat,[Qa]:s.RGFormat,[Ra]:s.RGFormat,[_a]:s.RedFormat,[Da]:s.RedFormat,[ka]:s.RedFormat,[Sa]:s.RedFormat,[Na]:s.RGBA_ASTC_4x4_Format,[Oa]:s.RGBA_ASTC_6x6_Format,[Ua]:s.RGBA_ASTC_6x6_Format},rr={[za]:s.FloatType,[Pa]:s.HalfFloatType,[Ta]:s.UnsignedByteType,[Fa]:s.UnsignedByteType,[Ga]:s.FloatType,[La]:s.HalfFloatType,[Qa]:s.UnsignedByteType,[Ra]:s.UnsignedByteType,[_a]:s.FloatType,[Da]:s.HalfFloatType,[ka]:s.UnsignedByteType,[Sa]:s.UnsignedByteType,[Na]:s.HalfFloatType,[Oa]:s.UnsignedByteType,[Ua]:s.UnsignedByteType};function or(e){const t=e.dataFormatDescriptor[0];return 1===t.colorPrimaries?2===t.transferFunction?s.SRGBColorSpace:s.LinearSRGBColorSpace:10===t.colorPrimaries?2===t.transferFunction?"display-p3":"display-p3-linear":(0===t.colorPrimaries||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),s.NoColorSpace)}var nr=function(){var e,t=0x10000000000000000,s=4294967295,i=2147483647;function a(e){var t=[];return t[e-1]=void 0,t}function r(e,t){return n(e[0]+t[0],e[1]+t[1])}function o(e,t){var s,i;return e[0]==t[0]&&e[1]==t[1]?0:(s=0>e[1],i=0>t[1],s&&!i?-1:!s&&i?1:function(e,t){return n(e[0]-t[0],e[1]-t[1])}(e,t)[1]<0?-1:1)}function n(e,i){var a,r;for(e%=t,i=(i%=t)-(a=i%P)+(r=Math.floor(e/P)*P),e=e-r+a;0>e;)e+=P,i-=P;for(;e>s;)e-=P,i+=P;for(i%=t;i>0x7fffffff00000000;)i-=t;for(;-0x10000000000000000>i;)i+=t;return[e,i]}function l(e){return e>=0?[e,0]:[e+P,-4294967296]}function h(e){return e[0]>=2147483648?~~Math.max(Math.min(e[0]-P,i),-2147483648):~~Math.max(Math.min(e[0],i),-2147483648)}function c(e){return e.cb>=e.O?-1:255&e.ab[e.cb++]}function A(e){var t=e.ab;return t.length=e.O,t}function d(e,t,i){var a,r,o,n,h="",A=[];for(r=0;5>r;++r){if(-1==(o=c(t)))throw Error("truncated input");A[r]=o<<24>>24}if(!function(e,t){var s,i,a,r,o,n,l;if(5>t.length)return 0;for(l=255&t[0],a=l%9,r=(n=~~(l/9))%5,o=~~(n/5),s=0,i=0;4>i;++i)s+=(255&t[1+i])<<8*i;return s>99999999||!function(e,t,s,i){if(t>8||s>4||i>4)return 0;x(e.k,s,t);var a=1<<i;return w(e.C,a),w(e.o,a),e.P=a-1,1}(e,a,r,o)?0:function(e,t){return 0>t?0:(e.z!=t&&(e.z=t,e.m=Math.max(e.z,1),p(e.b,Math.max(e.m,4096))),1)}(e,s)}(a=y({}),A))throw Error("corrupted input");for(r=0;64>r;r+=8){if(-1==(o=c(t)))throw Error("truncated input");1==(o=o.toString(16)).length&&(o="0"+o),h=o+""+h}/^0+$|^f+$/i.test(h)?e.N=_:(n=parseInt(h,16),e.N=n>s?_:l(n)),e.Q=function(e,t,s,i){return e.a.K=t,f(e.b),e.b.V=s,function(e){e.b.w=0,e.b.D=0,Q(e.q),Q(e.n),Q(e.E),Q(e.s),Q(e.u),Q(e.r),Q(e.J),function(e){var t,s;for(s=1<<e.g+e.y,t=0;s>t;++t)Q(e.F[t].v)}(e.k);for(var t=0;4>t;++t)Q(e.j[t].B);I(e.C),I(e.o),Q(e.t.B),function(e){e.p=0,e.i=-1;for(var t=0;5>t;++t)e.p=e.p<<8|c(e.K)}(e.a)}(e),e.f=0,e.l=0,e.T=0,e.R=0,e._=0,e.U=i,e.d=G,e.I=0,function(e,t){return e.h=t,e.bb=null,e.X=1,e}({},e)}(a,t,i,e.N)}function u(e,t){return e.S=function(e){return e.ab=a(32),e.O=0,e}({}),d(e,function(e,t){return e.ab=t,e.cb=0,e.O=t.length,e}({},t),e.S),e}function p(e,t){(null==e.x||e.c!=t)&&(e.x=a(t)),e.c=t,e.D=0,e.w=0}function m(e){var t=e.D-e.w;t&&(function(e,t,s,i){(function(e,t,s,i,a){for(var r=0;a>r;++r)s[i+r]=e[t+r]})(t,s,e.ab,e.O,i),e.O+=i}(e.V,e.x,e.w,t),e.D>=e.c&&(e.D=0),e.w=e.D)}function g(e,t){var s=e.D-t-1;return 0>s&&(s+=e.c),e.x[s]}function f(e){m(e),e.V=null}function b(e){if(!e.X)throw Error("bad state");if(e.bb)throw Error("No encoding");return function(e){var t=function(e){var t,s,i,a,n,c;if(c=h(e.d)&e.P,S(e.a,e.q,(e.f<<4)+c)){if(S(e.a,e.E,e.f))i=0,S(e.a,e.s,e.f)?(S(e.a,e.u,e.f)?(S(e.a,e.r,e.f)?(s=e._,e._=e.R):s=e.R,e.R=e.T):s=e.T,e.T=e.l,e.l=s):S(e.a,e.n,(e.f<<4)+c)||(e.f=7>e.f?9:11,i=1),i||(i=v(e.o,e.a,c)+2,e.f=7>e.f?8:11);else if(e._=e.R,e.R=e.T,e.T=e.l,i=2+v(e.C,e.a,c),e.f=7>e.f?7:10,n=M(e.j[function(e){return 4>(e-=2)?e:3}(i)],e.a),n>=4){if(a=(n>>1)-1,e.l=(2|1&n)<<a,14>n)e.l+=function(e,t,s,i){var a,r,o=1,n=0;for(r=0;i>r;++r)a=S(s,e,t+o),o<<=1,o+=a,n|=a<<r;return n}(e.J,e.l-n-1,e.a,a);else if(e.l+=k(e.a,a-4)<<4,e.l+=function(e,t){var s,i,a=1,r=0;for(i=0;e.A>i;++i)s=S(t,e.B,a),a<<=1,a+=s,r|=s<<i;return r}(e.t,e.a),0>e.l)return-1==e.l?1:-1}else e.l=n;if(o(l(e.l),e.d)>=0||e.l>=e.m)return-1;(function(e,t,s){var i=e.D-t-1;for(0>i&&(i+=e.c);0!=s;--s)i>=e.c&&(i=0),e.x[e.D++]=e.x[i++],e.D>=e.c&&m(e)})(e.b,e.l,i),e.d=r(e.d,l(i)),e.I=g(e.b,0)}else t=function(e,t,s){return e.F[((t&e.Y)<<e.g)+((255&s)>>>8-e.g)]}(e.k,h(e.d),e.I),e.I=7>e.f?function(e,t){var s=1;do{s=s<<1|S(t,e.v,s)}while(256>s);return s<<24>>24}(t,e.a):function(e,t,s){var i,a,r=1;do{if(a=s>>7&1,s<<=1,i=S(t,e.v,(1+a<<8)+r),r=r<<1|i,a!=i){for(;256>r;)r=r<<1|S(t,e.v,r);break}}while(256>r);return r<<24>>24}(t,e.a,g(e.b,e.l)),function(e,t){e.x[e.D++]=t,e.D>=e.c&&m(e)}(e.b,e.I),e.f=function(e){return 4>e?0:10>e?e-3:e-6}(e.f),e.d=r(e.d,z);return 0}(e.h);if(-1==t)throw Error("corrupted input");e.$=_,e.Z=e.h.d,(t||o(e.h.U,G)>=0&&o(e.h.d,e.h.U)>=0)&&(m(e.h.b),f(e.h.b),e.h.a.K=null,e.X=0)}(e),e.X}function y(e){e.b={},e.a={},e.q=a(192),e.E=a(12),e.s=a(12),e.u=a(12),e.r=a(12),e.n=a(192),e.j=a(4),e.J=a(114),e.t=E({},4),e.C=C({}),e.o=C({}),e.k={};for(var t=0;4>t;++t)e.j[t]=E({},6);return e}function w(e,t){for(;t>e.e;++e.e)e.G[e.e]=E({},3),e.H[e.e]=E({},3)}function v(e,t,s){return S(t,e.M,0)?8+(S(t,e.M,1)?8+M(e.L,t):M(e.H[s],t)):M(e.G[s],t)}function C(e){return e.M=a(2),e.G=a(16),e.H=a(16),e.L=E({},8),e.e=0,e}function I(e){Q(e.M);for(var t=0;e.e>t;++t)Q(e.G[t].B),Q(e.H[t].B);Q(e.L.B)}function x(e,t,s){var i,r;if(null==e.F||e.g!=s||e.y!=t)for(e.y=t,e.Y=(1<<t)-1,e.g=s,r=1<<e.g+e.y,e.F=a(r),i=0;r>i;++i)e.F[i]=B({})}function B(e){return e.v=a(768),e}function E(e,t){return e.A=t,e.B=a(1<<t),e}function M(e,t){var s,i=1;for(s=e.A;0!=s;--s)i=(i<<1)+S(t,e.B,i);return i-(1<<e.A)}function S(e,t,s){var i,a=t[s];return(-2147483648^(i=(e.i>>>11)*a))>(-2147483648^e.p)?(e.i=i,t[s]=a+(2048-a>>>5)<<16>>16,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8),0):(e.i-=i,e.p-=i,t[s]=a-(a>>>5)<<16>>16,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8),1)}function k(e,t){var s,i,a=0;for(s=t;0!=s;--s)e.i>>>=1,i=e.p-e.i>>>31,e.p-=e.i&i-1,a=a<<1|1-i,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8);return a}function Q(e){for(var t=e.length-1;t>=0;--t)e[t]=1024}function R(e){for(var t,s,i,a=0,r=0,o=e.length,n=[],l=[];o>a;++a,++r){if(128&(t=255&e[a]))if(192==(224&t)){if(a+1>=o)return e;if(128!=(192&(s=255&e[++a])))return e;l[r]=(31&t)<<6|63&s}else{if(224!=(240&t))return e;if(a+2>=o)return e;if(128!=(192&(s=255&e[++a])))return e;if(128!=(192&(i=255&e[++a])))return e;l[r]=(15&t)<<12|(63&s)<<6|63&i}else{if(!t)return e;l[r]=t}16383==r&&(n.push(String.fromCharCode.apply(String,l)),r=-1)}return r>0&&(l.length=r,n.push(String.fromCharCode.apply(String,l))),n.join("")}function T(e){return e[1]+e[0]}var F=2,D=3,L="function"==typeof setImmediate?setImmediate:setTimeout,P=4294967296,_=[s,-4294967296],G=[0,0],z=[1,0];return{decompress:function(t,s,i){var a,r,o,n,l={},h=void 0===s&&void 0===i;if("function"!=typeof s&&(r=s,s=i=0),i=i||function(t){return void 0!==r?function(t,s){e({action:D,cbn:s,result:t})}(o?t:-1,r):void 0},s=s||function(t,s){return void 0!==r?e({action:F,cbn:r,result:t,error:s}):void 0},h){for(l.d=u({},t);b(l.d.Q););return R(A(l.d.S))}try{l.d=u({},t),n=T(l.d.N),o=n>-1,i(0)}catch(e){return s(null,e)}L((function e(){try{for(var t,r=0,h=(new Date).getTime();b(l.d.Q);)if(++r%1e3==0&&(new Date).getTime()-h>200)return o&&(a=T(l.d.Q.h.d)/n,i(a)),L(e,0),0;i(1),t=R(A(l.d.S)),L(s.bind(null,t),0)}catch(e){s(null,e)}}),0)}}}();const lr={decompress:(e,t)=>{nr.decompress(new Uint8Array(e),t)}};let hr=!0,cr=!1,Ar=null;const dr=new Map,ur={renderMode:{value:0},fogMode:{value:1},depthPacking:{value:1},time:{value:0},shadow:{value:.5},shadowGamma:{value:.25},shadowLuma:{value:0},shadowContrast:{value:1},lightSizeUV:{value:1},nearPlane:{value:1},rings:{value:4},nSample:{value:16},noiseIntensity:{value:1},softness:{value:1.6},noiseMap:{value:null},useNoiseMap:{value:0}};class pr{get renderer(){return Ar}set renderer(e){Ar=e}static setGl2(e){hr=e}static getGl2(e){return hr}static setting(){return ur}static getRandomUv(){return br}static addParsFragment(e,t){e.fragmentShader=e.fragmentShader.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+t)}static init(e={}){const t="PCSS"===e.shadowType;if(s.ShaderChunk.tonemapping_pars_fragment=s.ShaderChunk.tonemapping_pars_fragment.replace("vec3 CustomToneMapping( vec3 color ) { return color; }","#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\n            float toneMappingWhitePoint = 1.0;\n            vec3 CustomToneMapping( vec3 color ) {\n                color *= toneMappingExposure;\n                return saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n            }"),!t)return;let i;this.up(e),t&&(i=s.ShaderChunk.shadowmap_pars_fragment,i=i.replace("#ifdef USE_SHADOWMAP",fr),i=i.replace("shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );","\n                return PCSS( shadowMap, shadowCoord );\n            "),s.ShaderChunk.shadowmap_pars_fragment=i),i=s.ShaderChunk.common,i=i.replace("#define EPSILON 1e-6","\n        \t#define EPSILON 1e-6\n        \tuniform float shadow;\n            uniform float shadowLuma;\n            uniform float shadowContrast;\n            uniform float shadowGamma;\n\n            uniform int renderMode;\n            uniform int fogMode;\n            uniform int depthPacking;\n\n            varying vec2 vZW;\n            varying vec3 rayDir;\n            varying vec3 rayDir2;\n            varying vec3 rayOri;\n            //varying float fDist;\n\n            float shadowValue = 1.0;\n            float shadowTmp = 1.0;\n            vec3 shadowColor = vec3(1.0);\n            \n            float color_distance( vec3 a, vec3 b){\n                vec3 s = vec3( a - b );\n                float dist = sqrt( s.r * s.r + s.g * s.g + s.b * s.b );\n                return clamp(dist, 0.0, 1.0);\n            }\n\n            vec3 adjustContrast(vec3 color, float value) {\n                const vec3 zero = vec3(0.);\n                return max(zero, 0.5 + value * (color - 0.5));\n            }\n\n            vec3 hsv2rgb(vec3 c){\n                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n            }\n\n            vec3 rgb2hsv(vec3 rgb) {\n                float Cmax = max(rgb.r, max(rgb.g, rgb.b));\n                float Cmin = min(rgb.r, min(rgb.g, rgb.b));\n                float delta = Cmax - Cmin;\n                vec3 hsv = vec3(0., 0., Cmax);\n                if (Cmax > Cmin) {\n                    hsv.y = delta / Cmax;\n                    if (rgb.r == Cmax) hsv.x = (rgb.g - rgb.b) / delta;\n                    else {\n                        if (rgb.g == Cmax) hsv.x = 2. + (rgb.b - rgb.r) / delta;\n                        else hsv.x = 4. + (rgb.r - rgb.g) / delta;\n                    }\n                    hsv.x = fract(hsv.x / 6.);\n                }\n                return hsv;\n            }\n\n            /*\n            vec3 rgb2hsv(vec3 c){\n                vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n                vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n                vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\n                float d = q.x - min(q.w, q.y);\n                float e = 1.0e-10;\n                return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n            }\n\n            vec3 brightnessContrastCorrection(vec3 value, float brightness, float contrast){\n                return (value - 0.5) * contrast + 0.5 + brightness;\n            }\n\n            vec3 GammaCorrection(vec3 value, float param){\n                return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));\n            }\n            */\n            \n\n        "),s.ShaderChunk.common=i,s.ShaderChunk.clipping_planes_vertex="\n            #if NUM_CLIPPING_PLANES > 0\n                vClipPosition = - mvPosition.xyz;\n            #endif\n            vZW = gl_Position.zw;\n        ",i=s.ShaderChunk.lights_fragment_begin,i=i.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),i=i.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),i=i.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),s.ShaderChunk.lights_fragment_begin=i,s.ShaderChunk.fog_vertex=mr,s.ShaderChunk.fog_fragment=gr,i=s.ShaderChunk.opaque_fragment,i=i.replace("gl_FragColor = vec4( outgoingLight, diffuseColor.a );","\n\n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        \t#if defined( USE_SHADOWMAP )\n\n            shadowValue = (shadowValue - 0.5) * shadowContrast + 0.5 + shadowLuma;\n            shadowValue = pow(abs(shadowValue), shadowGamma );\n            shadowValue = clamp( shadowValue, 0.0, 1.0 );\n\n            shadowColor = vec3( shadowValue );\n\n            ///shadowColor = vec3( 0.0,0.0,1.0-shadowValue );\n\n            //vec3 sColor = vec3( 0.1, 0.1, 0.8 );\n            //shadowColor.b += 1.0-shadowValue ;\n\n\n\n            // TODO find better shadow variation\n\n            vec3 invert = vec3( 1.0 - gl_FragColor.rgb );\n            vec3 dd = vec3(0.38,0.42,0.63);\n            float gray = ((gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0);\n            vec3 invColor = gray * dd;\n            invColor = invColor * mix( invColor, invert, 1.0-gray*0.5 );\n\n\n\n\n                    \n\n\n            //gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * shadowColor, (1.0-shadowValue) * shadow );\n\n            //gl_FragColor.rgb *= ((1.0-shadowValue) * (1.0-shadow)) + shadowColor;\n\n            //gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * invColor, (1.0-shadowValue) * shadow );\n\n            gl_FragColor.rgb = mix( gl_FragColor.rgb, invColor, (1.0-shadowValue) * shadow );\n\n            //gl_FragColor.rgb = invColor;\n\n            //gl_FragColor.rgb = gl_FragColor.rgb * shadowColor;\n\n            //gl_FragColor.rgb *= ((1.0-shadowValue) * shadow) * invColor;\n\n\n        \t#endif\n            \n        "),s.ShaderChunk.opaque_fragment=i,i=s.ShaderChunk.dithering_fragment,i=i.replace("#endif","\n\n            #endif\n\n            #ifdef STANDARD\n\n            if( renderMode == 1 ){ \n                float fz = 0.5 * vZW[0] / vZW[1] + 0.5;\n                gl_FragColor = depthPacking == 1 ? packDepthToRGBA( fz ) : vec4( vec3( 1.0 - fz ), opacity );// depth render\n            }\n            if( renderMode == 2 ) gl_FragColor = vec4(  packNormalToRGB( normal ), opacity );// normal render\n            if( renderMode == 3 ) gl_FragColor = vec4(  shadowColor, opacity );// normal render\n\n            #else\n\n            if( renderMode != 0 ) discard;\n\n            #endif\n\n        "),s.ShaderChunk.dithering_fragment=i,i=s.ShaderChunk.color_vertex,i=i.replace("vColor.xyz *= instanceColor.xyz;","vColor.xyz = instanceColor.xyz;"),s.ShaderChunk.color_vertex=i,cr=!0}static add(e,t=null){if(!cr)return;if(!e)return;let i=e.name;dr.has(i)?console.log("already add",i):(dr.set(i,!0),null===e.shadowSide&&(e.shadowSide=s.DoubleSide),e.onBeforeCompile=function(e){pr.modify(e),t&&t(e)})}static refresh(){}static setDefines(e){}static modify(e){if(cr)for(let t in ur)e.uniforms[t]=ur[t]}static up(e){for(let t in e)ur[t]&&(ur[t].value.isColor?ur[t].value.setHex(e[t]):ur[t].value=e[t])}static reset(){dr.clear()}}const mr="\n\n#ifdef USE_FOG\n\n    vFogDepth = - mvPosition.z;\n\n    rayDir2 = normalize( worldPosition.xyz - cameraPosition );\n    rayDir = normalize( mvPosition.xyz );\n    rayOri = cameraPosition.xyz;\n\n    //rayOri = worldPosition.xyz; //( cameraPosition-worldPosition.xyz  );\n    //vec3 tt = vec3(cameraPosition-mvPosition);\n    //float fDist = sqrt(tt.x*tt.x+tt.y*tt.y+tt.z*tt.z);\n    //fDist = distance(cameraPosition.xyz, mvPosition.xyz);\n\n#endif\n",gr="\n\n#ifdef USE_FOG\n\n    #ifdef FOG_EXP2\n\n        float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\n    #else\n\n        float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n        float fogDensity = 0.01;\n\n    #endif\n\n    \n\n    /*vec4 CCF = vec4(fogColor, 1.0);\n    #if defined( TONE_MAPPING )\n        CCF.rgb = toneMapping( CCF.rgb );\n        //CCF = linearToOutputTexel( CCF );\n    #endif*/\n\n    if( fogMode == 0 ){\n\n        gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n    } \n\n    if( fogMode == 1 ){\n\n        vec3 fcolor = fogColor;\n\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n            float aa = fogDensity * fogDensity * 1.0;\n            float bb = fogDensity * fogDensity * 12.0;\n            //bb = pow(bb, 0.8);\n            float distance = vFogDepth * vFogDepth;\n\n            fogFactor = 1.0 - exp( -distance*bb );\n            fogFactor = (aa/bb) * exp(-rayOri.y*bb) * (1.0-exp( -distance*rayDir2.y*bb ))/rayDir2.y;\n            fogFactor = clamp( fogFactor, 0.0, 1.0 );\n\n            vec3 sunDir = normalize( directionalLights[ 0 ].direction );\n            vec3 sunColor = directionalLights[ 0 ].color;\n            // sunColor = vec3(1,0,0);\n            float sunAmount = max( dot( rayDir, sunDir ), 0.0 );\n            //float sunAdd = clamp( pow(sunAmount, 60.0), 0.0, 1.0 );\n            float sunAdd = pow(sunAmount, 16.0);\n            fcolor = mix( fogColor, sunColor, sunAdd ); // 8.0\n\n        #endif\n\n        gl_FragColor.rgb = gl_FragColor.rgb * (1.0-fogFactor) + fcolor * fogFactor;\n\n    }\n\n#endif\n",fr="\n\n#ifdef USE_SHADOWMAP\n\nuniform float lightSizeUV;\nuniform float nearPlane;\nuniform float rings;\nuniform int nSample;\nuniform float noiseIntensity;\nuniform float softness;\n\n//#define LIGHT_WORLD_SIZE 0.005\n//#define LIGHT_FRUSTUM_WIDTH 3.75\n//#define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH)\n//#define NEAR_PLANE 9.5\n\n#define SAMPLE 16\n#define RINGS 4\n\nvec2 poissonDisk[32];\n\nvoid initPoissonSamples( const in vec2 randomSeed ) {\n\n    float ANGLE_STEP = PI2 * float(rings) / float( nSample );\n    float INV_NUM_SAMPLES = 1.0 / float( nSample );\n\n    // jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n    float angle = rand( randomSeed ) * PI2;\n    float radius = INV_NUM_SAMPLES;\n    float radiusStep = radius;\n\n    for( int i = 0; i < nSample; i ++ ) {\n        poissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );\n        radius += radiusStep;\n        angle += ANGLE_STEP;\n    }\n}\n\nfloat penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n    return (zReceiver - zBlocker) / zBlocker;\n}\n\nfloat findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver, float ls ) {\n\n    // This uses similar triangles to compute what\n    // area of the shadow map we should search\n    float searchRadius = ls * ( zReceiver - nearPlane ) / zReceiver;\n    float blockerDepthSum = 0.0;\n    int numBlockers = 0;\n    float shadowMapDepth = 0.0;\n\n    for( int i = 0; i < nSample; i++ ) {\n        shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));\n        if ( shadowMapDepth < zReceiver ) {\n            blockerDepthSum += shadowMapDepth;\n            numBlockers ++;\n        }\n    }\n\n    if( numBlockers == 0 ) return -1.0;\n\n    return blockerDepthSum / float( numBlockers );\n\n}\n\nfloat PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {\n    \n    /*\n    int numSample = nSample;\n    float sum = 0.0;\n    float depth;\n    #pragma unroll_loop_start\n    for( int i = 0; i < nSample; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    #pragma unroll_loop_start\n    for( int i = 0; i < nSample; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( nSample ) );\n    */\n\n    \n    float sum = 0.0;\n    float top = 0.0;\n    float low = 0.0;\n    #pragma unroll_loop_start\n    for( int i = 0; i < 16; i ++ ) {\n        top = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        low = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= top ) sum += 1.0;\n        if( zReceiver <= low ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( nSample ) );\n}\n\nfloat PCSS ( sampler2D shadowMap, vec4 coords ) {\n\n    vec2 uv = coords.xy;\n    float zReceiver = coords.z; // Assumed to be eye-space z in this code\n    //float lightSizeUV = LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH;\n\n    float ls = lightSizeUV * 0.001;\n\n    initPoissonSamples( uv );\n    // STEP 1: blocker search\n    float avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver, ls );\n\n    //There are no occluders so early out (this saves filtering)\n    if( avgBlockerDepth == -1.0 ) return 1.0;\n\n    // STEP 2: penumbra size\n    float penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );\n    float filterRadius = penumbraRatio * ls * nearPlane / zReceiver;\n\n    // STEP 3: filtering\n    //return avgBlockerDepth;\n    return PCF_Filter( shadowMap, uv, zReceiver, filterRadius * softness );\n}\n\n\n",br="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n",yr={getMesh:(e,t)=>{let s={};if(t){let t=[],s=[],i={},a=[];e.traverse((e=>{if(e.isGroup){let r=yr.groupToMesh(e);r&&(t.push(e),a.push(e.name),r.applyMatrix4(e.matrix),s.push(r),i[r.name]=s)}}));let r,o,n=t.length;for(;n--;)r=t[n].parent,o=r.name,r.remove(t[n]),-1!==a.indexOf(o)&&(r=i[o]),r.add(s[n])}return e.traverse((e=>{e.isMesh&&(s[e.name]=e)})),s},getGroup:(e,t,s)=>{const i={};return e.traverse((e=>{e.isGroup&&(i[e.name]=t?yr.groupToMesh(e,mats):e)})),i},getMaterial:e=>{const t={};let s,i=[];return e.traverse((e=>{e.isMesh&&(s=e.material,-1===i.indexOf(s.name)&&(i.push(s.name),pr.add(s),t[s.name]=s,s.vertexColors&&(s.vertexColors=!1)))})),t},groupToMesh:e=>{if(e.children[0].name!==e.name+"_1")return!1;if(!e.children[0].isMesh)return!1;let t=[],s=[],i=e.children.length;for(;i--;)s[i]=e.children[i].material,t[i]=e.children[i].geometry,t[i].group=i;let a=new THREE.Mesh(new Ce(t,!0),s);return a.name=e.name,a},symetric:e=>{e.isMesh&&(e=e.geometry);let t=e.attributes.uv.array,s=.5*t.length;for(;s--;)t[2*s]<0&&(t[2*s]*=-1);e.attributes.uv.needsUpdate=!0},uv2:e=>{e.isMesh&&(e=e.geometry),e.setAttribute("uv2",e.attributes.uv)},autoMorph:(e,t,i=!0,a=!1)=>{let r,o,n,l,h,c,A,d,u,p,m,g={},f=[];e.traverse((e=>{e.isMesh&&-1!==e.name.search("__M__")&&(g[e.name]=e.geometry,f.push(e))}));for(let e in g)if(r=e.substring(0,e.indexOf("__")),o=e.substring(e.lastIndexOf("__")+2),n=t[r],n)if(h=n.geometry,c=g[e],h.morphTargetsRelative=a,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],i&&(h.morphAttributes.normal=[]),n.morphTargetInfluences=[],n.morphTargetDictionary={}),l=h.morphAttributes.position.length,a){for(A=c.attributes.position.array.length,p=[];A--;)p[A]=c.attributes.position.array[A]-h.attributes.position.array[A];d=new s.Float32BufferAttribute(p,3)}else d=new s.Float32BufferAttribute(c.attributes.position.array,3);h.morphAttributes.position.push(d),i&&(u=new s.Float32BufferAttribute(c.attributes.normal.array,3),h.morphAttributes.normal.push(u)),n.morphTargetInfluences.push(0),n.morphTargetDictionary[o]=l}else console.warn("Morph "+o+" target is no good on "+n.name);for(g={},A=f.length;A--;)m=f[A],m.parent&&m.parent.remove(m),m.material&&m.material.dispose(),m.geometry&&m.geometry.dispose()}},wr={manager:new s.LoadingManager,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./src/libs/draco/",basisPath:"./src/jsm/libs/basis/",maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:e=>{},materialRoot:e=>{console.log(e)},setLoadEvent:(e,t)=>{wr.onLoad=e,wr.onEnd=t},prefix:e=>{let t="";switch(e){case"S":case"sound":case"mp3":case"wav":case"ogg":t="S_";break;case"I":case"image":case"jpg":case"png":t="I_";break;case"E":case"hdr":case"env":case"T":case"texture":t="T_";break;case"J":case"json":t="J_";break;case"JS":case"js":t="JS_";break;case"H":case"bin":case"hex":t="H_";break;case"O":case"object3d":t="O_";break;case"M":case"material":t="M_"}return t},dispose:()=>{wr.data.forEach((function(e,t){(e.isMaterial||e.isTexture)&&(e.dispose(),wr.data.delete(t)),e.isObject3D&&(e.traverse((function(e){e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose())})),wr.data.delete(t))}))},createElementNS:e=>document.createElementNS("http://www.w3.org/1999/xhtml",e),exist:(e,t="")=>!!wr.get(e,t),delete:(e,t="")=>wr.data.delete(wr.prefix(t)+e),get:(e,t="")=>wr.data.get(wr.prefix(t)+e),set:(e,t,s="",i)=>{t?(t.isMaterial&&(s="material",t.name=e,wr.materialRoot(t,i)),t.isTexture&&(s="texture"),t.isObject3D&&(s="object3d"),wr.get(e,s)||wr.data.set(wr.prefix(s)+e,t)):console.log("Loading error on "+e)},getScript:e=>wr.data.get(wr.prefix("js")+e),getMaterials:e=>("string"==typeof e&&(e=wr.get(e,"O")),yr.getMaterial(e)),getGLB:(e,t)=>("string"==typeof e&&(e=wr.get(e,"O")),e?(t&&yr.getMesh(e,t),e):console.error("Not find Model ?")),getMesh:(e,t)=>("string"==typeof e&&(e=wr.get(e,"O")),e?yr.getMesh(e,t):console.error("Not find Model ?")),getGroup:(e,t,s)=>("string"==typeof e&&(e=wr.get(e,"O")),yr.getGroup(e,t,s)),applyMorph(e,t=null,s=!0,i=!0){let a;a=e.isObject3D?e:wr.get(e,"O"),t||(t=wr.getMesh(e)),a&&t&&yr.autoMorph(a,t,s,i)},uv2(e){yr.uv2(e)},symetric(e){yr.symetric(e)},objectSpaceNormal(e){e.material.normalMapType=s.ObjectSpaceNormalMap},add:(e,t,s)=>{wr.set(e,t,s),wr.next()},getMaterial:e=>wr.data.get("M_"+e),texture:(e={})=>{wr.loaderMap||(wr.loaderMap=new s.TextureLoader);let t=e.name||"";return e.url&&(t=-1!==e.url.lastIndexOf(".")?e.url.substring(e.url.lastIndexOf("/")+1,e.url.lastIndexOf(".")):e.url.substring(e.url.lastIndexOf("/")+1)),-1===t.search("_c")&&-1===t.search("_l")&&-1===t.search("_u")&&-1===t.search("_d")||(e.srgb=!0),wr.exist(t,"texture")?wr.get(t,"texture"):wr.exist(t,"image")?wr.getTexture(t,e):wr.loaderMap.load(e.url,(function(s){return wr.setTextureOption(s,e),wr.data.set("T_"+t,s),e.callback&&e.callback(),s}))},getTexture:(e,t={})=>{e=(t.quality?t.quality+"k_":"")+e;let i=wr.get(e,"texture");if(!i){let a=wr.get(e,"image");if(!a)return null;i=new s.Texture(a),-1===e.search("_c")&&-1===e.search("_d")&&-1===e.search("_l")&&-1===e.search("_u")||(t.srgb=!0),wr.data.set("T_"+e,i)}return wr.setTextureOption(i,t),i},setTextureOption:(e,t={})=>{t.encoding&&(e.colorSpace=s.SRGBColorSpace),t.srgb&&(e.colorSpace=s.SRGBColorSpace),e.flipY=(void 0!==t.flipY||void 0!==t.flip)&&t.flipY,t.anisotropy&&(e.anisotropy="max"===t.anisotropy?wr.maxAnisotropy:t.anisotropy),void 0!==t.generateMipmaps&&(e.generateMipmaps=t.generateMipmaps),t.repeat&&(e.repeat.fromArray(t.repeat),e.wrapS=e.wrapT=s.RepeatWrapping),t.center&&e.center.fromArray(t.center),t.offset&&e.offset.fromArray(t.offset),t.filter&&"near"===t.filter&&(e.minFilter=s.NearestFilter,e.magFilter=s.NearestFilter),t.channel&&(e.channel=t.channel),e.needsUpdate=!0},loadAsync:(e,t="",s="")=>new Promise(((i,a)=>{wr.waiting=!0,wr.load(e,(()=>{wr.waiting=!1}),t,s)})),load:(e,t,s="",i="",a=0)=>{wr.msg=i;let r=[],o=t||function(){},n=("undefined"==typeof performance?Date:performance).now();"string"==typeof e||e instanceof String?r.push(e):r=r.concat(e),wr.tmp.push({urls:r,path:s,callback:o,start:n,quality:a}),wr.inLoad||wr.loadOne()},loadOne:()=>{wr.inLoad=!0,wr.onLoad();let e=wr.tmp[0].path+wr.tmp[0].urls[0],t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),s=e.substring(e.lastIndexOf(".")+1).toLowerCase();"jpg"!==s&&"png"!==s||(t=(wr.tmp[0].quality?wr.tmp[0].quality+"k_":"")+t),wr.exist(t,s)?wr.next():wr.loading(e,t,s)},next:()=>{wr.tmp[0].urls.shift(),0===wr.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-wr.tmp[0].start),wr.tmp[0].callback(),wr.tmp.shift(),wr.tmp.length>0?wr.loadOne():(wr.inLoad=!1,wr.clearDRACO(),wr.onEnd())):wr.loadOne()},loading:(e,t,s)=>{switch(wr.log(wr.msg),s){case"glb":case"gltf":wr.load_GLTF(e,t);break;case"fbx":case"FBX":wr.load_FBX(e,t);break;case"obj":wr.load_OBJ(e,t);break;case"stl":wr.load_STL(e,t);break;case"ktx2":wr.load_KTX2(e,t);break;case"hdr":wr.load_RGBE(e,t);break;case"exr":wr.load_EXR(e,t);break;default:wr.extand(e,t,s)}},extand:(e,t,s)=>{wr.XHTTP||(wr.XHTTP=new XMLHttpRequest);const i=wr.XHTTP;switch(i.open("GET",e,!0),"json"===s&&i.overrideMimeType("application/json"),s){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":i.responseType="arraybuffer";break;case"jpg":case"png":i.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":i.responseType="text"}i.onreadystatechange=function(){4===i.readyState&&(i.status>=300?console.log("Error, status code = "+i.status):wr.direct(i.response,t,s))},"onprogress"in i&&(i.onprogress=function(e){}),i.send(null)},direct:(e,t,s)=>{switch(s){case"jpg":case"png":let i=wr.createElementNS("img");i.onload=function(e){window.URL.revokeObjectURL(i.src),wr.add(t,i,"image")},i.src=window.URL.createObjectURL(e);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(e.slice(0),(function(e){wr.add(t,e,"sound")}),(function(e){console.error("decodeAudioData error",e)}));break;case"hex":case"bin":lr.decompress(e,(e=>{wr.add(t,e,s)}));break;case"wasm":wr.add(t,new Uint8Array(e),s);break;case"json":wr.add(t,JSON.parse(e),s);break;default:wr.add(t,e,s)}},clearDRACO:()=>{wr.dracoLoader&&(wr.dracoLoader.dispose(),wr.dracoLoader=null),wr.GLTF&&(wr.GLTF=null)},loaderDRACO:()=>{if(wr.dracoLoader)return wr.dracoLoader;if(!wr.dracoLoaderType)if(navigator.userAgentData)wr.dracoLoaderType="wasm";else{let e=navigator.userAgent.toLowerCase();wr.dracoLoaderType=-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"js":"wasm"}return wr.dracoLoader=(new hi).setDecoderPath(wr.dracoPath),wr.dracoLoader.setDecoderConfig({type:wr.dracoLoaderType}),wr.dracoLoader},loaderKTX2:()=>(wr.KTX2||(wr.KTX2=new sr(wr.manager).setTranscoderPath(wr.basisPath).detectSupport(wr.renderer)),wr.KTX2),loaderGLTF:()=>(wr.GLTF||(wr.GLTF=new As(wr.manager).setCrossOrigin("anonymous").setDRACOLoader(wr.loaderDRACO()).setKTX2Loader(wr.loaderKTX2()).setMeshoptDecoder(ca)),wr.GLTF),loaderFBX:()=>(wr.FBX||(wr.FBX=new ji(wr.manager)),wr.FBX),loaderSTL:()=>(wr.STL||(wr.STL=new xa(wr.manager)),wr.STL),loaderOBJ:()=>(wr.OBJ||(wr.OBJ=new Ia(wr.manager)),wr.OBJ),loaderRGBE:()=>(wr.RGBE||(wr.RGBE=new Ba(wr.manager)),wr.RGBE),loaderEXR:()=>(wr.EXR||(wr.EXR=new Ea(wr.manager)),wr.EXR),load_GLTF:(e,t)=>{wr.loaderGLTF().load(e,(function(e){const i=e.scene;if(e.animations){const t=e.animations,a=new s.AnimationMixer(e.scene);i.mixer=a,i.actions={};for(let e=0;e<t.length;e++){let s=t[e];i.actions[s.name]=a.clipAction(s)}i.play=e=>{i.actions[e]&&(i.actions[e].paused=!1,i.actions[e].time=0,i.actions[e].play())},i.pause=(e,t=!0)=>{i.actions[e]&&(i.actions[e].paused=t)}}wr.add(t,i)}))},load_FBX:(e,t)=>{wr.loaderFBX().load(e,(function(e){wr.add(t,e)}))},load_OBJ:(e,t)=>{wr.loaderOBJ().load(e,(function(e){wr.add(t,e)}))},load_STL:(e,t)=>{wr.loaderSTL().load(e,(function(e){let i=new s.Mesh(e);wr.add(t,i)}))},load_KTX2:(e,t,s)=>{wr.loaderKTX2().load(e,(function(e){return wr.add(t,e),e}))},load_RGBE:(e,t)=>{wr.loaderRGBE().load(e,(function(e){e.mapping=s.EquirectangularReflectionMapping,wr.add(t,e)}))},load_EXR:(e,t,s)=>{wr.loaderEXR().load(e,(function(e){return s&&s(e),e}))},direct_EXR:(e,t)=>{wr.loaderEXR().parse(url,(function(e){return wr.add(t,e),e}))}};class vr{constructor(e,t){this.target=t||e,this.baseGeometry=e.geometry,this.geometry=this.target.geometry,this.V=[new s.Vector3,new s.Vector3,new s.Vector3],this.X=[new s.Vector4,new s.Vector4,new s.Matrix4],this.M=[new s.Vector3,new s.Vector3,new s.Vector3],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const e=this.geometry;let t=e.attributes.position.array.length;e.setAttribute("color",new s.Float32BufferAttribute(new Array(t).fill(0),3))}resetEdge(e){let t=e.length;for(;t--;)e[t]=0}getEdge(e,t,s=!1,i=!1){let a=e.attributes.position.array;const r=e.index.array;let o,n,l,h,c,A,d,u=this.V[0],p=this.V[1],m=this.V[2],g=0;for(i&&(a=this.getMorph()),s&&(a=this.getSkinned(a)),(s||i)&&this.resetEdge(t),o=this.indexLength;o--;)n=r[g],l=r[g+1],h=r[g+2],u.fromArray(a,3*n),p.fromArray(a,3*l),m.fromArray(a,3*h),c=u.distanceTo(p),A=u.distanceTo(m),d=p.distanceTo(m),t[n]+=.5*(c+A),t[l]+=.5*(c+d),t[h]+=.5*(A+d),g+=3}isZero(e){return 0===e.x&&0===e.y&&0===e.z}getMorph(){const e=this.target.morphTargetInfluences,t=this.geometry.morphAttributes.position,s=e.length,i=this.geometry.attributes.position.array;let a,r,o,n,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],A=this.M[2],d=this.geometry.morphTargetsRelative;for(r=l;r--;){for(a=3*r,c.fromArray(i,a),h.set(0,0,0),o=s;o--;)0!=e[o]&&(n=t[o].data?t[o].data.array:t[o].array,d?h.addScaledVector(A.fromArray(n,a),e[o]):h.addScaledVector(A.fromArray(n,a).sub(c),e[o]));c.add(h),c.toArray(this.back,a)}return this.back}getSkinned(e){const t=this.target.skeleton;t.boneMatrices;const s=this.geometry,i=s.attributes.skinIndex.array,a=s.attributes.skinWeight.array,r=this.target.bindMatrix,o=this.target.bindMatrixInverse;let n,l,h,c,A,d=this.V[0],u=this.V[1],p=this.V[2],m=this.X[0],g=this.X[1],f=this.X[2];for(n=s.attributes.position.count;n--;){for(A=3*n,m.fromArray(i,4*n),g.fromArray(a,4*n),d.fromArray(e,A).applyMatrix4(r),u.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=m.getComponent(l),f.multiplyMatrices(t.bones[h].matrixWorld,t.boneInverses[h]),u.addScaledVector(p.copy(d).applyMatrix4(f),c));u.applyMatrix4(o),u.toArray(this.back,A)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const e=this.geometry.attributes.color.array;let t,s,i,a=this.length;for(;a--;)t=this.originEdges[a],s=(t-this.targetEdges[a])/t+.5,i=3*a,e[i]=s>.5?2*(s-.5):0,e[i+1]=0,e[i+2]=s<.5?1-2*s:0;this.geometry.attributes.color.needsUpdate=!0}}class Cr extends s.Object3D{constructor(e,t){super(),this.isReady=!1,this.skeleton=t,this.bones=this.skeleton.bones,this.root=e,this.box=new s.BoxGeometry,this.mtxr=new s.Matrix4,this.mtx0=new s.Matrix4,this.mtx1=new s.Matrix4,this.mtx=new s.Matrix4,this.mtx2=new s.Matrix4,this.p=new s.Vector3,this.s=new s.Vector3,this.q=new s.Quaternion,this.e=new s.Euler,this.mat=new s.MeshBasicMaterial({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){if(!this.isReady)return;let t,s,i=this.children,a=i.length;for(this.mtxr.copy(this.root.matrixWorld).invert();a--;)t=i[a],s=t.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,s.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,t.userData.decal),this.mtx.decompose(this.p,this.q,this.s),t.position.copy(this.p),t.quaternion.copy(this.q),t.updateMatrix();super.updateMatrixWorld(e)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const e=this.bones;let t,i,a,r,o,n,l,h,c,A,d,u=new s.Vector3,p=new s.Vector3,m=e.length;for(t=0;t<m;t++)h=null,r=e[t],i=r.name,o=r.parent,o&&(a=o.name,u.setFromMatrixPosition(o.matrixWorld),p.setFromMatrixPosition(r.matrixWorld),l=u.distanceTo(p),c=[0,0,.5*l],n=[l,1,1],A=[0,0,0],d="_C","head"===a&&"End_head"===i&&(h="box",n=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===a&&"neck"===i&&(h="box",n=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===a&&(h="box",n=[.28,.24,l+.14],A[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===a&&(h="box",n=[.15,.15,l]),"lThigh"===a&&(h="box",n=[.15,.15,l]),"rShin"===a&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"lShin"===a&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"rShldr"===a&&(h="box",n=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===a&&(h="box",n=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===a&&(h="box",n=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===a&&(h="box",n=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(o,h,n,c,A,"_C"));this.isReady=!0}addMesh(e,t,i,a,r,o){this.mtx.makeTranslation(a[0],a[1],a[2]);var n=new s.Mesh(this.box,this.mat);n.scale.fromArray(i),n.userData.decal=this.mtx.clone(),n.userData.bone=e,n.userData.size=i,this.add(n)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const Ir={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:1,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},xr={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:Ir,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",roughness:.54,metalness:.14,normalScale:new s.Vector2(Ir.normal,-Ir.normal),wireframe:Ir.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new s.Color(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new s.Vector2(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new s.Vector2(2,-2),clearcoat:.25},hair:{type:"Standard",color:Ir.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:s.DoubleSide,emissive:Ir.hair,emissiveIntensity:.5,transparent:!0,blending:s.CustomBlending,blendDst:s.ZeroFactor,blendDstAlpha:s.SrcAlphaFactor,alphaToCoverage:!0},hair_man:{type:"Standard",color:Ir.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:s.DoubleSide,transparent:!0,blending:s.CustomBlending,blendDst:s.ZeroFactor,blendDstAlpha:s.SrcAlphaFactor,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:Ir.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:s.DoubleSide,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(e={},t=!1)=>{if(!wr.getMaterial(xr.materialRef))return;const s=xr.setting,i=xr.materials;let a,r=!1;for(let t in e)void 0!==s[t]&&s[t]!==e[t]&&(s[t]=e[t],r=!0);if(r)for(let s in i){a=wr.getMaterial(s);for(let r in e)void 0!==a[r]&&(t&&i[s][r]?a[r]=i[s][r]:a[r]=e[r])}},applyMaterial:(e,t)=>{const s=!0,i=wr.getMaterial("skin");//!Human.haveLOD;
e.traverse((e=>{if(e.isMesh)switch(e.name){case"body":case"Head":e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.visible=s;break;case"body_low":e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.visible=!1;break;case"crane":e.material=i,e.receiveShadow=!0,e.castShadow=!1,e.visible=!xr.haveHair;break;case"mouth":e.material=wr.getMaterial("mouth")||i,e.receiveShadow=!0,e.castShadow=!1,e.visible=s,e.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":e.material=wr.getMaterial("eyelash")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"tear":e.material=wr.getMaterial("tear")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"eye_l":case"eye_r":e.material=wr.getMaterial("eye")||i,e.receiveShadow=!1,e.castShadow=!1;break;case"eye_l_s":case"eye_r_s":e.material=wr.getMaterial("sub_eye")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"hair":e.material=wr.getMaterial("hair")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=!!xr.haveHair&&s;break;case"hair_man":e.material=wr.getMaterial("hair_man")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=!!xr.haveHair&&s}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},Br={wireframe:!1,normal:.25,hair:2433041},Er={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:Br,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new s.Vector2(Br.normal,-Br.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:Br.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:Br.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(e={},t=!1)=>{if(!wr.getMaterial(Er.materialRef))return;const s=Lee.materials;let i;for(let a in s){i=wr.getMaterial(a);for(let r in e)void 0!==i[r]&&(t&&s[a][r]?i[r]=s[a][r]:i[r]=e[r])}},applyMaterial:(e,t)=>{const s=wr.getMaterial(Er.materialRef);e.traverse((e=>{if(e.isMesh)switch(e.name){case"body_low":e.material=s,e.receiveShadow=!0,e.castShadow=!0;break;case"hair_low":e.material=wr.getMaterial("hair_low")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"hair_low_2":e.material=wr.getMaterial("hair_low_2")||s,e.receiveShadow=!1,e.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},Mr={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},Sr={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:Mr,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:Mr.roughness,metalness:Mr.metalness,wireframe:Mr.wireframe,clearcoat:Mr.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:Mr.roughness,metalness:Mr.metalness,wireframe:Mr.wireframe,clearcoat:Mr.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:Mr.roughness,metalness:Mr.metalness,wireframe:Mr.wireframe,clearcoat:Mr.clearcoat,aoMap:"eva_ao"}},changeMaterial:(e,t=!1)=>{if(!wr.getMaterial(Sr.materialRef))return;const s=Sr.materials;let i;for(let a in s){i=wr.getMaterial(a);for(let r in e)void 0!==i[r]&&(t&&s[a][r]?i[r]=s[a][r]:i[r]=e[r]);i.needsUpdate=!0}},applyMaterial:(e,t)=>{const s=wr.getMaterial(t);e.traverse((e=>{if(e.isMesh)switch(e.material=s,e.receiveShadow=!0,e.castShadow=!0,e.name){case"eva_2_head":case"eva_2_mach":e.visible="eva02"===t;break;case"eva_L_COLLAR":case"eva_R_COLLAR":e.visible="eva00"!==t;break;case"eva_HEAD":case"eva_MACHOIR":e.visible="eva01"===t;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":e.visible="eva00"===t;break;case"eva_0_CHEST2":e.visible="eva01"!==t}}))}},kr={metalness:.2,roughness:.8,wireframe:!1},Qr={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:kr,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:kr.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(e,t=!1)=>{if(!wr.getMaterial(Qr.materialRef))return;const s=Qr.materials;let i;for(let a in s){i=wr.getMaterial(a);for(let r in e)void 0!==i[r]&&(t&&s[a][r]?i[r]=s[a][r]:i[r]=e[r])}},applyMaterial:(e,t)=>{const s=wr.getMaterial("lee_material");e.traverse((e=>{e.isMesh&&(e.material=s,e.receiveShadow=!0,e.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},Rr={metalness:.2,roughness:.8,wireframe:!1},Tr={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:Rr,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:Rr.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(e,t=!1)=>{},applyMaterial:(e,t)=>{},adjustment:()=>[]},Fr=1/30,Dr=Math.PI/180,Lr=180/Math.PI,Pr=new s.Vector3,_r={tmp:[],model:[],avatar:null,callback:()=>{},add:(e,t)=>{_r.tmp=[...e],_r.callback=t,_r.tmp.length&&_r.loadOne()},loadOne:()=>{let e=_r.tmp[0];_r.avatar=new Gr({type:e,callback:_r.next,morph:!0,isPreload:!0})},next:e=>{_r.avatar.dispose(),_r.tmp.shift(),0===_r.tmp.length?_r.callback():_r.loadOne()}};class Gr extends s.Group{constructor(e={}){switch(super(),this.isPreload=e.isPreload||!1,this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.rootPath=e.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",wr.dracoPath=this.rootPath+"src/libs/draco/",this.callback=e.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=e.randomMorph||!1,this.randomSize=e.randomSize||!1,this.actionPose=null,this.model=e.type||"man",this.startAnimation=e.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=Tr;break;case"lee":this.ref=Qr;break;case"man":case"woman":this.ref=xr;break;case"man_low":case"woman_low":this.ref=Er;break;case"eva00":case"eva01":case"eva02":this.ref=Sr}this.compact=void 0===e.compact||e.compact,this.haveMorph=void 0!==e.morph&&e.morph,this.fullMaterial=void 0===e.material||e.material,this.size=e.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,e.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new s.Quaternion).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new s.Vector3,this.eyeTarget=new s.Group,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new s.Matrix4,this.tmpQ=new s.Quaternion,this.setting={},this.root=wr.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=hs(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(e=0,t=1){return e+Math.random()*(t-e)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=wr.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const e=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");wr.load(this.ref.textures,this.loadModels.bind(this),e,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const e=this.ref.forceModel?this.ref.forceModel:this.model,t=[e+".glb"],s=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&t.push(e+"_morph.glb"),wr.load(t,this.init.bind(this),s,"loading models...")}update(e){this.done&&this.mixer&&(this.mixer.update(e),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*e),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const e=this.n++;let t=0;e<=10&&(t=.1*e),e>10&&e<=20&&(t=1-.1*(e-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",t)}look(e){if(!this.isEyeMove)return;if(this.isPause)return;const t=window.mouse||{x:0,y:0};e>1&&(e=1),this.headBoneLook.lerp({x:-20*t.y*Dr,y:0,z:-20*t.x*Dr},e),this.eyeTarget.position.lerp({x:.5*t.x,y:1,z:.25*-t.y},e);let s=this.headBoneLook;this.tmpQ.setFromEuler({_x:s.x,_y:s.y,_z:s.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let i=this.bones.ER,a=this.bones.EL,r={x:0,y:0,z:1};this.tmpMtx.lookAt(a.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),r),a.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(i.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),r),i.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let e=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,e),this.lerp(1,1.04,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,e),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,e),this.lerp(1.04,1,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,e),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(e,t,s){this.position.set(e,t,s),this.updateMatrix()}setRotation(e,t,s,i){let a=this.lerp(this.rotation.y,t,i);this.rotation.set(e,a,s),this.updateMatrix()}lerp(e,t,s){return(1-s)*e+s*t}onReady(){}initMaterial(){if(wr.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void wr.set(this.ref.materialRef,new s.MeshStandardMaterial);let e,t,i;for(const a in this.ref.materials){i={...this.ref.materials[a]},t=i.type,delete i.type;for(const e in i)"envMapIntensity"!==e&&"normalMapType"!==e&&"aoMapIntensity"!==e&&"aoMapIntensity"!==e&&("map"!==e&&-1===e.search("Map")||(i[e]=wr.getTexture(i[e],{quality:this.textureQuality})));"Basic"===t?e=new s.MeshBasicMaterial(i):"Standard"===t?e=new s.MeshStandardMaterial(i):"Physical"===t?e=new s.MeshPhysicalMaterial(i):"Sss"===t&&(e=new L(i)),e.name=a,wr.set(a,e)}this.setting=this.ref.setting}setMaterial(e,t){let s=wr.getMaterial(this.ref.materialRef);if(s)for(let t in e)void 0!==s[t]&&(s[t]=e[t])}setMaterialNormal(e){let t=wr.getMaterial("skin");t&&(e<0&&(e=0),t.normalScale.set(e,-e))}getMaterial(e){return wr.getMaterial(e)}init(){if(this.initMaterial(),!this.isClone){let e=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&wr.getMesh(e,!0),this.root=wr.get(e,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(e){e.raycast=function(){},e.isMesh&&(e.name===this.ref.skeletonRef&&(e.matrixAutoUpdate=!1,this.skeleton=e.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=e.geometry.boundingBox.max.y),"Head"===e.name&&(this.realSize=e.geometry.boundingBox.max.y),this.mesh[e.name]=e),e.isBone&&(this.bones[e.name]=e)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let e in this.mesh)this.mesh[e].isSkinnedMesh&&e!==this.ref.skeletonRef&&(this.mesh[e].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&wr.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),wr.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new s.AnimationMixer(this),0===wr.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let e=wr.clip.length;for(;e--;)this.addAction(wr.clip[e]);this.start()}}setRealSize(e){this.realSize=e;let t=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(t)}setSize(e){this.size=e,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(e){this.bones.head.scale.set(1,1,1).multiplyScalar(e)}addTensionMap(){this.tension1=new vr(this.mesh.body),this.tension2=new vr(this.mesh.Head)}setBounding(e){for(let t in this.mesh)this.mesh[t].isMesh&&(this.mesh[t].geometry.boundingSphere.radius=e)}setLevel(e){this.haveLOD&&this.lod!==e&&(this.lod=e,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let e in this.mesh)this.mesh[e].visible=!1}setVisible(e,t){"string"==typeof e&&(e=[e]);let s,i=e.length;for(;i--;)s=e[i],this.mesh[s]&&(this.mesh[s].visible=t)}setMorph(e,t){t=t<0?0:t,this.haveMorph&&(this.morpher("eyelash",e,t),this.morpher("eyebrow",e,t),this.morpher("tear",e,t),this.morpher("mouth",e,t),this.morpher("body",e,t),this.morpher("Head",e,t),this.morpher("body_low",e,t))}morpher(e,t,s){this.mesh[e]&&this.mesh[e].morphTargetInfluences&&void 0!==this.mesh[e].morphTargetDictionary[t]&&(this.mesh[e].morphTargetInfluences[this.mesh[e].morphTargetDictionary[t]]=s)}lerp(e,t,s){return(1-s)*e+s*t}clone(e){return new this.constructor({type:e.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(e){if(!this.haveMorph)return;e&&(this.bodyMorph=e);let t=Number(this.bodyMorph[0]),s=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",s<0?-s:0),this.setMorph("LOW",s>=0?s:0),this.setMorph("BIG",t<0?-t:0),this.setMorph("MONSTER",t>=0?t:0);let i=.5*(t+1),a=1-.5*(s+1);this.setMaterialNormal(.5*(a+i))}setFaceMorph(e){if(!this.haveMorph)return;e&&(this.faceMorph=e);let t=Number(this.faceMorph[0]),s=Number(this.faceMorph[1]);this.setMorph("Shock",s<0?-s:0),this.setMorph("Frown",s>=0?s:0),this.setMorph("SmileOpen",t<0?-t:0),this.setMorph("Angry",t>=0?t:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new s.SkeletonHelper(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new Cr(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(e,t){e.matrix=t.matrixWorld,e.matrixAutoUpdate=!1}loadAnimationJson(e,t){const s=new XMLHttpRequest;s.open("GET",e,!0),s.onreadystatechange=function(){if(4===s.readyState&&(200===s.status||0===s.status)){let e=JSON.parse(s.responseText);this.urls=[];for(let t in e)"main"===t?this.urls.push(...e[t]):this.urls.push(...e[t].map((e=>t+"/"+e)));this.endCallback=t||function(){},this.loadOne()}}.bind(this),s.send()}loadOne(){let e=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+e+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(e="./assets/models/animations.bin"){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer";const i={animations:[]},a=this;t.onload=function(){lr.decompress(t.response,(e=>{const t=JSON.parse(e);for(let e in t)i.animations.push(s.AnimationClip.parse(t[e]));a.applydAnimation(i),a.start()}))},t.send()}loadAnimationGlb(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));wr.loaderGLTF().load(e,function(e){this.applydAnimation(e,s),t&&t()}.bind(this),null,t)}directGlb(e,t){wr.loaderGLTF().parse(e,"",function(e){this.stop(),this.applydAnimation(e,t)}.bind(this))}loadAnimationFbx(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));wr.loaderFBX().load(e,function(e){this.convertFbx(s,e.animations[0]),t&&t()}.bind(this),null,t)}directFbx(e,t){try{let s=wr.loaderFBX().parse(e,"");this.convertFbx(t,s.animations[0],!0)}catch(e){console.error("bug",e)}}applydAnimation(e,t){let s=e.animations.length,i=!1;for(1===s&&(t&&(e.animations[0].name=t),i=!0);s--;)this.addClip(e.animations[s]),this.addAction(e.animations[s],i)}addClip(e,t=!1){t&&s.AnimationUtils.makeClipAdditive(e);let i=wr.clip.length,a=-1;for(;i--;)wr.clip[i].name===e.name&&(a=i);-1!==a&&wr.clip.slice(a,1),wr.clip.push(e)}addAction(e,t){const s=this.mixer.clipAction(e);s.frameMax=Math.round(30*e.duration),s.play(),s.enabled=!0,-1!==e.name.search("idle")&&(s.enabled=!0),"Jumping Up"===e.name&&(s.loop=LoopPingPong),this.actions.set(e.name,s),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(e=!1,t=!1){let s=[],i=0;if(t){let t=wr.clip.length;for(;t--;)s[i]=e?wr.clip[i].toJSON():wr.clip[i],i++}else this.actions.forEach((function(t,a){s[i]=e?t._clip.toJSON():t._clip,i++}));return s}exportAnimationLzma(e){this.lzma||(this.lzma=new lr(this.lzmaPath));const t=this.getAnimation(!0);this.lzma.compress(JSON.stringify(t),2,(function(t){if(e)e({name:"animations",data:new Uint8Array(t),type:"bin"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"application/octet-stream"})),e.download="animations.bin",e.click()}}))}exportGLB(e){this.exporter||(this.exporter=new gt);const t=this.getAnimation();this.exporter.parse(this.root,(function(t){if(e)e({name:"model",data:t,type:"glb"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),e.download="model.glb",e.click()}}),null,{animations:t,binary:!0,onlyVisible:!0})}armAngle(){}autoToes(){if(!this.fixToe)return;let e=this.getRot("rFoot"),t=this.getRot("lFoot"),s=this.getWorldPos("hip"),i=this.getWorldPos("rToes"),a=this.getWorldPos("lToes");e[0]>0&&i.z-s.z<0?this.setRot("rToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("rToes",0,0,0),t[0]>0&&a.z-s.z<0?this.setRot("lToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(e,t,i){const a=Math.PI/180;let r=new s.Vector3,o=new s.Quaternion,n=(new s.Quaternion).setFromAxisAngle({x:1,y:0,z:0},90*a);const l=t.tracks,h=[];let c,A,d,u,p=l.length,m=0;for(;p--;){if(d=l[m],u=d.name.substring(0,d.name.lastIndexOf(".")),"hip.position"===d.name){let e=[];for(c=d.values.length/3;c--;)A=3*c,r.set(d.values[A],d.values[A+1],0).multiplyScalar(.01),r.toArray(e,A);h.push(new s.VectorKeyframeTrack(d.name,d.times,e))}else{let e=[];for(c=d.values.length/4;c--;)A=4*c,"hip"===u?o.set(d.values[A],d.values[A+1],d.values[A+2],d.values[A+3]).multiply(n):o.set(d.values[A],d.values[A+2],-d.values[A+1],d.values[A+3]),o.toArray(e,A);h.push(new s.QuaternionKeyframeTrack(d.name,d.times,e))}m++}let g=new s.AnimationClip(e,-1,h);g.duration=t.duration,this.stop(),this.addClip(g),this.addAction(g,i)}makePoseTrack(e,t,i=!1){const a=Math.PI/180;let r=new s.Quaternion;const o=t,n=[];let l,h,c,A,d=o.length,u=0;for(;d--;){A=o[d],A.name;let e=[],t=[];for(u=0,l=3;l--;)h=0,c=4*u,t.push(.03333333507180214*u),r.setFromEuler({_x:A.values[0]*a,_y:A.values[1]*a,_z:A.values[2]*a,_order:"XYZ"}),r.toArray(e,c),u++;n.push(new s.QuaternionKeyframeTrack(A.name+".quaternion",t,e))}let p=i?s.AdditiveAnimationBlendMode:s.NormalAnimationBlendMode,m=new s.AnimationClip(e,-1,n,p);m.duration=.10000000521540642;const g=this.mixer.clipAction(m);g.enabled=!0,g.setEffectiveTimeScale(1),g.setEffectiveWeight(1),g.play(),this.actionPose=g}prepareCrossFade(e,t,s){this.isPause=!1,this.unPause(),"idle"!==t._clip.name?this.executeCrossFade(e,t,s):this.synchronizeCrossFade(e,t,s)}synchronizeCrossFade(e,t,s){this.mixer.addEventListener("loop",(function a(r){r.action===e&&(i.mixer.removeEventListener("loop",a),i.executeCrossFade(e,t,s))}));const i=this}executeCrossFade(e,t,s,i=!0){this.setWeight(t,1),t.time=0,e.crossFadeTo(t,s,!0)}pause(){this.actions.forEach((function(e){e.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(e){e.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(e){e.play()}))}setTimescale(e){this.actions.forEach((function(t){t.setEffectiveTimeScale(e)}))}syncro(e){let t=this.getAction(e);if(!t)return;let s=t.time;this.actions.forEach((function(e){e.time=s}))}setWeight(e,t){e.enabled=!0,t<0&&(t=0),t>1&&(t=1),e.setEffectiveWeight(t)}getAnimInfo(e){let t=this.getAction(e);if(t)return{name:e,time:t.time,frame:Math.round(30*t.time),frameMax:t.frameMax,timeScale:t.timeScale}}getAction(e){return this.actions.get(e)}play(e,t=.5){let s=this.getAction(e);if(!s)return!1;if(this.current){if(this.current!==s){this.old=this.current,this.current=s;let i="idle"===this.current.getClip().name;i="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(e)?this.fixToe=!0:this.resetToes();let a=this.old.getEffectiveWeight(),r=this.current.getEffectiveWeight(),o=this.current.time;if(!i){let e=this.current.getClip().duration/this.old.getClip().duration;o=this.old.time*e}this.current.reset(),this.current.time=o,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(t,a,0),this.current._scheduleFading(t,r,1)):this.executeCrossFade(this.old,this.current,t)}}else this.stop(),this.current=s,s.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(e,t,s=1){let i=this.getAction(e);i&&(i.time=t*Fr,i.setEffectiveWeight(s),i.play(),i.paused=!0,this.isPause=!0)}playOne(e,t=1){this.current&&(this.current.time=e*Fr,this.current.setEffectiveWeight(t),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(e){e.setEffectiveWeight(0)}))}setRot(e,t,s,i){let a=this.bones[e];a&&(a.rotation.set(t*Dr,s*Dr,i*Dr,"XYZ"),a.updateMatrix())}setRot2(e,t,i,a){let r=this.bones[e];if(!r)return;let o=(new s.Quaternion).setFromEuler({_x:t*Lr,_y:i*Lr,_z:a*Lr,_order:"XYZ"}).invert();r.quaternion.premultiply(o),r.updateMatrix()}getRot(e){let t=this.bones[e];if(!t)return;let s=t.rotation.toArray();return[Math.round(s[0]*Lr),Math.round(s[1]*Lr),Math.round(s[2]*Lr)]}getWorldPos(e){let t=this.bones[e];if(t)return Pr.set(0,0,0),t.localToWorld(Pr),{x:Pr.x,y:Pr.y,z:Pr.z}}bodyMask(e={arm:!0,leg:!0,foot:!0,chest:!0}){let t=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const i=this.canvas.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,256,256),i.fillStyle="black",e.arm&&i.fillRect(196,112,59,46.5),e.leg&&i.fillRect(128,183.5,71.75,72.5),e.foot&&i.fillRect(817*t,205.5,51.5,50),e.chest&&(i.fillRect(120,144,75,40),i.fillRect(553*t,116.5,57,27.5),i.fillRect(533*t,531*t,5,45*t));let a=new Image;a.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new s.Texture(a),this.mask.flipY=!1,this.mask.needsUpdate=!0;const r=wr.getMaterial("skin");r.alphaTest=.9,r.alphaMap=this.mask}zeroColor(e){e.isMesh&&(e=e.geometry);let t=e.attributes.position.array.length;e.setAttribute("color",new s.Float32BufferAttribute(new Array(t).fill(0),3))}}let zr=class extends we{constructor(e={}){super(),this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=e.useImpulse||!1,this.useFloating=e.floating||!1,this.waitRotation=!1;let t=.3,i=e.radius||.3,a=e.height||1.8;this.realHeight=a,this.useFloating&&(a-=t),this.option={debug:!1,capsuleHalfHeight:.5*a,capsuleRadius:i,floatHeight:t,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-a,z:0},rayHitForgiveness:.1,rayLength:i+2,rayDir:{x:0,y:-1,z:0},floatingDis:i+t+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:i-.03,slopeRayLength:i+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new s.Vector3,movingObjectVelocity:new s.Vector3,standingForcePoint:new s.Vector3,pivotPosition:new s.Vector3,modelQuat:new s.Quaternion,moveImpulse:new s.Vector3,impulseCenter:new s.Vector3,movingDirection:new s.Vector3,moveAccNeeded:new s.Vector3,jumpVelocityVec:new s.Vector3,jumpDirection:new s.Vector3,currentVel:new s.Vector3,currentPos:new s.Vector3,dragForce:new s.Vector3,dragAngForce:new s.Vector3,wantToMoveVel:new s.Vector3,rejectVel:new s.Vector3,floatingForce:null,springDirVec:new s.Vector3,rayOrigin:new s.Vector3,characterMassForce:new s.Vector3,slopeAngle:null,actualSlopeNormal:new s.Vector3,actualSlopeAngle:null,actualSlopeNormalVec:new s.Vector3,floorNormal:new s.Vector3(0,1,0),slopeRayOriginRef:new s.Vector3,slopeRayorigin:new s.Vector3,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.type="character",this.name=e.name||"hero",e.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=i,this.height=a,this.mass=e.mass||.84,delete e.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.tmpV1=new s.Vector3,this.tmpV2=new s.Vector3,this.ease=new s.Vector3,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(e.angle||0)*o,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=e.ray||!1,this.callback=e.callback||function(){},e.callback&&delete e.callback,this.initPhysic(e)}setHeight(e){this.model&&this.model.setRealSize(e)}reSizePhysics(e){if(e===this.realHeight)return;this.realHeight=e,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let t=this.position.toArray();t[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let s=[this.radius,this.height-2*this.radius];this.phyData.pos=t,this.phyData.size=s,B.post({m:"add",o:this.phyData})}initPhysic(e){e.size||(e.size=[this.radius,this.height-2*this.radius]),e.pos||(e.pos=[0,0,0]),e.pos[1]+=.5*this.height,this.useFloating&&(e.pos[1]+=this.option.floatHeight),this.globalRay&&B.items.body.geometry({...e,type:"capsule",ray:!0},this,ee.get("hide")),this.phyData={name:this.name,size:e.size,pos:e.pos,type:"character",shapeType:e.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==e.friction?e.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:e.massInfo},e.mask&&(this.phyData.mask=e.mask),B.items.character.addToWorld(this,e.id),B.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=B.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),e.gender?this.addModel(e):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&B.motor.remove(this.name+"_ray")}selfRay(e){e.hit?(this.distance=e.distance,this.rayAngle=e.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(e){this.contact=e}showHelper(e){e?this.helper||(this.helper=new He(this.radius,this.height,!0,ee.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=e)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new ut(this.name,this.model.root,this.model.skeleton.bones),B.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(e=!1){this.skeletonBody&&this.skeletonBody.isVisible(e),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:e,opacity:e?.8:1},!e),this.showHelper(e)}setMode(e){this.skeletonBody&&this.skeletonBody.setMode(e)}addModel(e){this.model=new Gr({type:e.gender,anim:void 0!==e.anim?e.anim:"idle",compact:!0,material:!e.noMat,morph:e.morph||!1,randomMorph:e.randomMorph||!1,randomSize:e.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:e.noLOD||!1}),this.add(this.model);let t=-.5*this.height;this.useFloating&&(t-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+t,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(e,t){this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.velocity.fromArray(e,t+8),this.angular.fromArray(e,t+11),this.fall=this.position.y<this.oy,this.floor=A.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(B.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),B.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const e=B.motor.getCamera();this.tmpV1.copy(B.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let t=this.tmpV1.distanceTo(this.tmpV2)/e.zoom>3?0:1;this.model.setLevel(t)}set(e){e.morph&&this.model&&this.model.setMorph(e.morph,e.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper(),super.dispose()}onFrame(e,t){this.v,this.option}autoBalance(){const e=this.v,t=this.option,s=this.rotation;e.dragAngForce.set(-t.autoBalanceSpringK*s.x-this.angular.x*t.autoBalanceDampingC,-t.autoBalanceSpringK*s.y-this.angular.y*t.autoBalanceDampingOnY,-t.autoBalanceSpringK*s.z-this.angular.z*t.autoBalanceDampingC)}moveCharacter(e,t=0){const s=this.v,i=this.option,a=B.motor.getKey();B.motor.getAzimut(),s.currentPos.copy(this.position),s.slopeAngle=0,s.actualSlopeAngle<i.slopeMaxAngle&&Math.abs(s.slopeAngle)>.2&&Math.abs(s.slopeAngle)<i.slopeMaxAngle?s.movingDirection.set(0,Math.sin(s.slopeAngle),Math.cos(s.slopeAngle)):s.actualSlopeAngle>=i.slopeMaxAngle?s.movingDirection.set(0,Math.sin(s.slopeAngle)>0?0:Math.sin(s.slopeAngle),Math.sin(s.slopeAngle)>0?.1:1):s.movingDirection.set(0,0,1),s.movingDirection.applyAxisAngle({x:0,y:1,z:0},t),s.movingObjectVelocityInCharacterDir.copy(s.movingObjectVelocity).projectOnVector(s.movingDirection).multiply(s.movingDirection);const r=s.movingObjectVelocity.angleTo(s.movingDirection),o=s.currentVel.dot(s.movingDirection);s.wantToMoveVel.set(s.movingDirection.x*o,0,s.movingDirection.z*o),s.rejectVel.copy(s.currentVel).sub(s.wantToMoveVel),s.moveAccNeeded.set((s.movingDirection.x*(i.maxVelLimit*(this.running?i.sprintMult:1)+s.movingObjectVelocityInCharacterDir.x)-(s.currentVel.x-s.movingObjectVelocity.x*Math.sin(r)+s.rejectVel.x*(s.isOnMovingObject?0:i.rejectVelMult)))/i.accDeltaTime,0,(s.movingDirection.z*(i.maxVelLimit*(this.running?i.sprintMult:1)+s.movingObjectVelocityInCharacterDir.z)-(s.currentVel.z-s.movingObjectVelocity.z*Math.sin(r)+s.rejectVel.z*(s.isOnMovingObject?0:i.rejectVelMult)))/i.accDeltaTime);const n=s.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(t).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?s.moveImpulse.set(n.x*(s.canJump?1:i.airDragMultiplier),null===s.slopeAngle||0==s.slopeAngle?0:s.movingDirection.y*(s.movingDirection.y>0?i.slopeUpExtraForce:i.slopeDownExtraForce)*(this.running?i.sprintMult:1),n.z*(s.canJump?1:i.airDragMultiplier)):s.moveImpulse.set(n.x*i.turnVelMultiplier*(s.canJump?1:i.airDragMultiplier),null===s.slopeAngle||0==s.slopeAngle?0:s.movingDirection.y*i.turnVelMultiplier*(s.movingDirection.y>0?i.slopeUpExtraForce:i.slopeDownExtraForce)*(this.running?i.sprintMult:1),n.z*i.turnVelMultiplier*(s.canJump?1:i.airDragMultiplier)),s.impulseCenter.set(s.currentPos.x,s.currentPos.y+i.moveImpulsePointY,s.currentPos.z),s.currentVel.copy(this.velocity),a[4]&&s.canJump&&(s.jumpVelocityVec.set(s.currentVel.x,this.running?i.sprintJumpMult*i.jumpVel:i.jumpVel,s.currentVel.z),s.moveImpulse.y=s.jumpVelocityVec.y)}getFloating(){const e=this.v,t=this.option,s=t.springK*(t.floatingDis-this.distance)-this.velocity.y*t.dampingC;e.moveImpulse.y=s*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&B.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const e=B.motor.getKey(),t=B.motor.getAzimut(),s=B.delta;let i=0!==e[7]?"run":"walk";0===e[0]&&0===e[1]&&(i="idle");let a=0!==e[0]&&0!==e[1]?this.diagonal:1;e[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===e[5]&&(this.toggle=!0),"walk"!==i&&"run"!==i||!this.crouch||(i="crouch"),1===e[6]&&(i="fight"),!this.jump&&e[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(i){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}this.moving=0!==e[0]||0!==e[1],this.running=0!==e[7],this.wantJump=0!==e[4];let o=A.unwrapRad(Math.atan2(e[0],e[1])+t);if(this.useImpulse)this.moving?this.moveCharacter(s,o):this.stopMoving(),this.useFloating&&this.getFloating(),B.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*s;const r=1;let o=this.speed[i]*r;this.moving&&(this.rs=e[0]*o,this.ts=e[1]*o),0===e[0]&&0===e[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*a),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let n=this.vy-9.81;this.ease.y=n,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},t),this.tmpV2.set(0,0,0),B.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=t,"idle"!==i&&this.helper.setDirection(o)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(r,.75),"idle"!==i)){let e=A.unwrapRad(this.model.rotation.y),s=A.nearAngle(o,e),a=Math.abs(Math.floor((e-s)*math.todeg)/180);this.model.rotation.y="fight"===i?t+Math.PI:A.lerp(e,s,.2-.1*a),this.model.updateMatrix()}}},Ur=class extends ae{constructor(){super(),this.Utils=E,this.type="character",this.num=v[this.type]}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*this.num,i&&i.step(e,s)}add(e={}){this.setName(e);return new zr(e)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}};const Or={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),toFixed:(e,t=3)=>1*e.toFixed(t),int:e=>Math.floor(e),lerp:(e,t,s)=>(1-s)*e+s*t,clamp:(e,t,s)=>Math.max(t,Math.min(s,e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,lerpAr:(e,t,s,i)=>{let a=e.length;for(;a--;)e[a]=Or.lerp(t[a],s[a],i)},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),scaleArray:(e,t)=>{for(var s=e.length;s--;)e[s]*=t;return e},addArray:(e,t)=>{for(var s=[],i=e.length;i--;)s[i]=e[i]+t[i];return s},angleDistance:(e,t)=>{var s=(e-t+180)%360-180;return s<-180?s+360:s},tmpE:new s.Euler,tmpM:new s.Matrix4,tmpM2:new s.Matrix4,tmpV:new s.Vector3,tmpQ:new s.Quaternion,fromTransformToQ:(e,t,s)=>(s=s||!1,Or.tmpM.compose(Or.tmpV.fromArray(e),Or.tmpQ.fromArray(t),{x:1,y:1,z:1}),Or.tmpM.decompose(Or.tmpV,Or.tmpQ,{x:1,y:1,z:1}),s&&Or.tmpQ.invert(),Or.tmpQ.toArray()),fromTransform:(e,t,s,i,a)=>(a=a||!1,i=i||[0,0,0,1],Or.tmpM.compose(Or.tmpV.fromArray(e),Or.tmpQ.fromArray(t),{x:1,y:1,z:1}),Or.tmpM2.compose(Or.tmpV.fromArray(s),Or.tmpQ.fromArray(i),{x:1,y:1,z:1}),a?(Or.tmpM.invert(),Or.tmpM.multiply(Or.tmpM2)):Or.tmpM.multiply(Or.tmpM2),Or.tmpM.decompose(Or.tmpV,Or.tmpQ,{x:1,y:1,z:1}),Or.tmpV.toArray()),arCopy:(e,t)=>{},axisToQuatArray:(e,t)=>(t=t||!1,Or.tmpQ.setFromAxisAngle(Or.tmpV.fromArray(e,1),t?e[0]*Or.torad:e[0]).normalize().toArray()),toQuatArray:e=>Or.tmpQ.setFromEuler(Or.tmpE.fromArray(Or.vectorad(e))).toArray(),vectorad:e=>{let t=3,s=[];for(;t--;)s[t]=e[t]*Or.torad;return s[3]=e[3],s},rgbToHex:e=>"0x"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]).toString(16)).slice(-6),hexToRgb:e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255],htmlToHex:e=>e.toUpperCase().replace("#","0x"),hexToHtml:e=>"#"+("000000"+(e=void 0===e?0:e).toString(16)).substr(-6),rgbToHtml:e=>"#"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==Or.perlin&&(Or.perlin=null)},noise:(e,t)=>{null===Or.perlin&&(Or.perlin=new Nr);let s,i,a=(t=t||{}).level||[1,.2,.05],r=t.frequency||[.016,.05,.2],o=0,n=0;for(s=0;s<a.length;s++)i=r[s],o+=a[s]*(.5+.5*Or.perlin.noise3d(e.x*i,e.y*i,e.z*i)),n+=a[s];return o/=n,o}};class Nr{constructor(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,s){return e[0]*t+e[1]*s}dot3(e,t,s,i){return e[0]*t+e[1]*s+e[2]*i}dot4(e,t,s,i,a){return e[0]*t+e[1]*s+e[2]*i+e[3]*a}noise(e,t){var s,i,a=(e+t)*(.5*(Math.sqrt(3)-1)),r=Math.floor(e+a),o=Math.floor(t+a),n=(3-Math.sqrt(3))/6,l=(r+o)*n,h=e-(r-l),c=t-(o-l);h>c?(s=1,i=0):(s=0,i=1);var A=h-s+n,d=c-i+n,u=h-1+2*n,p=c-1+2*n,m=255&r,g=255&o,f=this.perm[m+this.perm[g]]%12,b=this.perm[m+s+this.perm[g+i]]%12,y=this.perm[m+1+this.perm[g+1]]%12,w=.5-h*h-c*c,v=.5-A*A-d*d,C=.5-u*u-p*p;return 70*((w<0?0:(w*=w)*w*this.dot(this.grad3[f],h,c))+(v<0?0:(v*=v)*v*this.dot(this.grad3[b],A,d))+(C<0?0:(C*=C)*C*this.dot(this.grad3[y],u,p)))}noise3d(e,t,s){var i,a,r,o,n,l,h=(e+t+s)*(1/3),c=Math.floor(e+h),A=Math.floor(t+h),d=Math.floor(s+h),u=1/6,p=(c+A+d)*u,m=e-(c-p),g=t-(A-p),f=s-(d-p);m>=g?g>=f?(i=1,a=0,r=0,o=1,n=1,l=0):m>=f?(i=1,a=0,r=0,o=1,n=0,l=1):(i=0,a=0,r=1,o=1,n=0,l=1):g<f?(i=0,a=0,r=1,o=0,n=1,l=1):m<f?(i=0,a=1,r=0,o=0,n=1,l=1):(i=0,a=1,r=0,o=1,n=1,l=0);var b=m-i+u,y=g-a+u,w=f-r+u,v=m-o+2*u,C=g-n+2*u,I=f-l+2*u,x=m-1+.5,B=g-1+.5,E=f-1+.5,M=255&c,S=255&A,k=255&d,Q=this.perm[M+this.perm[S+this.perm[k]]]%12,R=this.perm[M+i+this.perm[S+a+this.perm[k+r]]]%12,T=this.perm[M+o+this.perm[S+n+this.perm[k+l]]]%12,F=this.perm[M+1+this.perm[S+1+this.perm[k+1]]]%12,D=.6-m*m-g*g-f*f,L=.6-b*b-y*y-w*w,P=.6-v*v-C*C-I*I,_=.6-x*x-B*B-E*E;return 32*((D<0?0:(D*=D)*D*this.dot3(this.grad3[Q],m,g,f))+(L<0?0:(L*=L)*L*this.dot3(this.grad3[R],b,y,w))+(P<0?0:(P*=P)*P*this.dot3(this.grad3[T],v,C,I))+(_<0?0:(_*=_)*_*this.dot3(this.grad3[F],x,B,E)))}noise4d(e,t,s,i){var a,r,o,n,l,h,c,A,d,u,p,m,g=this.grad4,f=this.simplex,b=this.perm,y=(Math.sqrt(5)-1)/4,w=(5-Math.sqrt(5))/20,v=(e+t+s+i)*y,C=Math.floor(e+v),I=Math.floor(t+v),x=Math.floor(s+v),B=Math.floor(i+v),E=(C+I+x+B)*w,M=e-(C-E),S=t-(I-E),k=s-(x-E),Q=i-(B-E),R=(M>S?32:0)+(M>k?16:0)+(S>k?8:0)+(M>Q?4:0)+(S>Q?2:0)+(k>Q?1:0),T=M-(a=f[R][0]>=3?1:0)+w,F=S-(r=f[R][1]>=3?1:0)+w,D=k-(o=f[R][2]>=3?1:0)+w,L=Q-(n=f[R][3]>=3?1:0)+w,P=M-(l=f[R][0]>=2?1:0)+2*w,_=S-(h=f[R][1]>=2?1:0)+2*w,G=k-(c=f[R][2]>=2?1:0)+2*w,z=Q-(A=f[R][3]>=2?1:0)+2*w,U=M-(d=f[R][0]>=1?1:0)+3*w,O=S-(u=f[R][1]>=1?1:0)+3*w,N=k-(p=f[R][2]>=1?1:0)+3*w,V=Q-(m=f[R][3]>=1?1:0)+3*w,q=M-1+4*w,H=S-1+4*w,j=k-1+4*w,W=Q-1+4*w,K=255&C,J=255&I,Y=255&x,X=255&B,Z=b[K+b[J+b[Y+b[X]]]]%32,$=b[K+a+b[J+r+b[Y+o+b[X+n]]]]%32,ee=b[K+l+b[J+h+b[Y+c+b[X+A]]]]%32,te=b[K+d+b[J+u+b[Y+p+b[X+m]]]]%32,se=b[K+1+b[J+1+b[Y+1+b[X+1]]]]%32,ie=.6-M*M-S*S-k*k-Q*Q,ae=.6-T*T-F*F-D*D-L*L,re=.6-P*P-_*_-G*G-z*z,oe=.6-U*U-O*O-N*N-V*V,ne=.6-q*q-H*H-j*j-W*W;return 27*((ie<0?0:(ie*=ie)*ie*this.dot4(g[Z],M,S,k,Q))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[$],T,F,D,L))+(re<0?0:(re*=re)*re*this.dot4(g[ee],P,_,G,z))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[te],U,O,N,V))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[se],q,H,j,W)))}}class Vr extends s.Mesh{constructor(e={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=e.name,this.folder=e.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=e.terrainType||"terrain",this.callback=e.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[e.uv||18,e.uv||18],this.sample=null==e.sample?[128,128]:e.sample,this.size=void 0===e.size?[100,30,100]:e.size;let t=this.sample[0]-1,i=this.sample[1]-1;this.rx=t/this.size[0],this.rz=i/this.size[2],this.zone=e.zone||1;let a=[this.size[0]/t,this.size[2]/i];this.sampleZ=[e.sample[0]*this.zone,e.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*a[0],e.size[1],(this.sampleZ[1]-1)*a[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:e.level||[1,.2,.05],frequency:e.frequency||[.016,.05,.2],expo:e.expo||1},this.isWater=e.water||!1,this.isIsland=e.island||!1,this.isBorder=!1,this.wantBorder=e.border||!1,this.isBottom=!1,this.wantBottom=e.bottom||!1,this.wantBorder=e.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=e.maxSpeed||.1,this.acc=null==e.acc?.01:e.acc,this.dec=null==e.dec?.01:e.dec,this.deep=null==e.deep?0:e.deep,this.ease=new s.Vector2,this.complexity=null==e.complexity?30:e.complexity,this.complexity2=null==e.complexity2?null:e.complexity2,this.local=new s.Vector3,e.local&&this.local.fromArray(e.local),this.pp=new s.Vector3,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=e.is64||!1,this.isTurn=e.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=e.isAbsolute||!1,this.isTurned=e.isTurned||!1,this.isReverse=e.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new s.PlaneGeometry(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-Or.PI90),this.geometry.setAttribute("color",new s.BufferAttribute(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var r=new s.Quaternion(.5,.5,.1,.2);e.maplevels&&r.fromArray(e.maplevels);var o,n=qr,l=e.maps||["sand","grass3","rock"],h={};this.isWater&&(l=["water"]);for(let t in l)o=l[t],h[o+"_c"]=wr.texture({url:this.folder+o+"_c.jpg",flip:!1,repeat:this.uvx,encoding:e.encoding||!0,callback:this.mapcallback.bind(this)}),h[o+"_n"]=wr.texture({url:this.folder+o+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});h.noise=wr.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=h,this.material=new s.MeshPhysicalMaterial({name:"terrain",vertexColors:!0,color:16777215,map:h[l[0]+"_c"],normalMap:h[l[0]+"_n"]}),void 0!==e.envmap&&(this.material.envMap=e.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=e.opacity||.4,this.material.side=s.DoubleSide,this.material.alphaMap=h[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=e.metalness||0,this.material.roughness=e.roughness||.3);var c=e.nScale||.5;if(this.material.normalScale.set(c,-c),this.isWater)this.material.onBeforeCompile=function(e){var t=e.fragmentShader;t=t.replace("#include <alphamap_fragment>",n.alphamap),e.fragmentShader=t};else{let e=this;this.material.onBeforeCompile=function(t){let s=t.uniforms;s.clevels={value:r},s.map1={value:h[l[1]+"_c"]},s.map2={value:h[l[2]+"_c"]},s.randomUv={value:1},s.normalMap1={value:h[l[1]+"_n"]},s.normalMap2={value:h[l[2]+"_n"]},s.noiseMap={value:h.noise},s.useNoiseMap={value:1},t.uniforms=s,pr.addParsFragment(t,pr.getRandomUv()+n.fragmentAdd);let i=t.fragmentShader;i=i.replace("#include <map_fragment>",n.map),i=i.replace("#include <normal_fragment_maps>",n.normal),i=i.replace("#include <color_fragment>",""),t.fragmentShader=i,e.material.userData.shader=t,pr.modify(t)},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(e){this.userData.shader.uniforms.randomUv.value=e?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(e){this.userData.shader.uniforms.map1.value=e}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(e){this.userData.shader.uniforms.map2.value=e}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(e){this.userData.shader.uniforms.normalMap1.value=e}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(e){this.userData.shader.uniforms.normalMap2.value=e}})}e.debug&&this.debugZone(e),this.wantBorder&&this.addBorder(e),this.wantBottom&&this.addBottom(e),e.pos&&this.position.fromArray(e.pos),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=Or.toQuatArray(e.rot),delete e.rot),this.quaternion.fromArray(e.quat),e.decal&&(this.position.y+=e.decal),this.castShadow=!0,this.receiveShadow=!0,wr.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let e=.5*(this.sample[0]-this.sampleZ[0]),t=.5*(this.sample[1]-this.sampleZ[1]),s=this.sample[0]*t+e,i=0;for(let t=0;t<this.lngZ;t++)i=Math.floor(t/this.sampleZ[0]),this.zid[s+t+i*(2*e)]=t}debugZone(e){this.geometryZ=new s.PlaneGeometry(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-Or.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const t=new s.Mesh(this.geometryZ,new s.MeshBasicMaterial({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(t)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(e){var t=new s.PlaneGeometry(this.size[0],this.size[2],1,1);t.rotateX(Or.PI90),this.bottomMesh=new s.Mesh(t,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(e){this.borderMaterial=new s.MeshStandardMaterial({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?e.opacity||.8:1,envMap:e.envmap||null});var t=new s.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),i=new s.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),a=new s.PlaneGeometry(this.size[2],2,this.sample[1]-1,1),r=new s.PlaneGeometry(this.size[2],2,this.sample[1]-1,1);t.translate(0,1,.5*this.size[2]),i.rotateY(-Or.Pi),i.translate(0,1,.5*-this.size[2]),a.rotateY(-Or.PI90),a.translate(.5*-this.size[0],1,0),r.rotateY(Or.PI90),r.translate(.5*this.size[0],1,0),this.borderGeometry=xe(Ce([t,i,a,r])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new s.BufferAttribute(this.borderColors,3)),this.borderMesh=new s.Mesh(this.borderGeometry,this.borderMaterial);for(var o,n,l=this.lng2;l--;)o=3*l,n=this.borderVertices[o+1]>0?this.findPoint(this.borderVertices[o],this.borderVertices[o+2]):-1,this.list[l]=n;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let e in this.txt)this.txt[e].dispose()}easing(e,t,s){if(0!==e[0]||0!==e[1]){var i=t||0;e[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=e[1]*this.acc,this.ease.x+=e[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,e[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),e[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(i)*this.ease.x+Math.cos(i)*this.ease.y,this.local.x+=Math.cos(i)*this.ease.x-Math.sin(i)*this.ease.y,this.update(s))}}getTri(){return this.geometry}getHeight(e,t){return e*=this.rx,t*=this.rz,e+=.5*this.sample[0],t+=.5*this.sample[1],e=Math.floor(e),t=Math.floor(t),(this.isTurn?this.height[this.findId2(e,t)]:this.height[this.findId(e,t)])*this.size[1]+this.position.y}findIdZ(e,t){return e+t*this.sampleZ[1]}findId(e,t){return e+t*this.sample[1]}findId2(e,t){return t+-e*this.sample[0]||1}findPoint(e,t){for(var s,i=this.lng;i--;)if(s=3*i,this.vertices[s]===e&&this.vertices[s+2]===t)return i;return-1}getReverseID(){this.invId=[];let e,t,s=this.lngZ;const i=this.sampleZ[1]-1;for(this.sampleZ[0];s--;)e=s%this.sampleZ[0],t=Math.floor(s*this.ratioZ),this.isReverse&&(t=i-t),this.invId[s]=this.isTurned?this.lngZ-1-this.findIdZ(t,e):this.findIdZ(e,t)}set(e){e.ease&&this.easing(e.key,e.azimut),e.decal&&this.decal(e.decal,!0)}decal(e,t){this.local.x+=e[0],this.local.y+=e[1],this.local.z+=e[2],this.update(t)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let e={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(e),this.material.normalMap&&this.material.normalMap.offset.copy(e)}}distance(e,t){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}clamp(e,t=0,s=1){return e=(e=e<t?t:e)>s?s:e}update(e){let t,s,i,a,r,o,n,l,h,c,A,d=this.pp,u=[1,1,1],p=this.lng;for(;p--;){if(t=3*p,s=p%this.sample[0],i=Math.floor(p*this.ratio),d.set(s+this.local.x*this.rx,this.local.y,i+this.local.z*this.rz),a=Or.noise(d,this.data),this.isIsland){let e=1-this.distance({x:s,y:i},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));e*=4,e=this.clamp(e),a*=e}a=Math.pow(a,this.data.expo),a=this.clamp(a),"road"===this.ttype&&(l===i?a=1===s||2===s||29===s||30===s?h+.1:h:(l=i,h=a)),this.height[p]=a,c=a*this.size[1]+this.deep,this.vertices[t+1]=c,o=this.isAbsolute?a:a*this.size[1],void 0!==this.zid[p]&&(n=this.zid[p],r=this.changeId?this.invId[n]:n,this.heightData[r]=o,this.verticesZ&&(this.verticesZ[3*n+1]=c)),u=this.isWater?[a*this.colorBase.r,a*this.colorBase.g,a*this.colorBase.b]:[a,0,0],A=u[0],this.colors[t]=A,this.colors[t+1]=A,this.colors[t+2]=A}if(this.isBorder){let e,s=this.lng2;for(;s--;)t=3*s,-1!==this.list[s]?(e=this.height[this.list[s]],this.borderVertices[t+1]=e*this.size[1]+this.deep,A=Or.clamp(e+.25,.25,1),this.borderColors[t]=A,this.borderColors[t+1]=A,this.borderColors[t+2]=A):(this.borderColors[t]=this.colorBase.r,this.borderColors[t+1]=this.colorBase.g,this.borderColors[t+2]=this.colorBase.b)}e?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(e){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const qr={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "};let Hr=class extends ae{constructor(){super(),this.Utils=E,this.type="terrain",this.num=v[this.type]}step(){B.Ar,B.ArPos[this.type];let e,t=this.list.length;for(;t--;)e=this.list[t],e.step()}add(e={}){this.setName(e),"JOLT"===B.engine&&(e.isAbsolute=!0,e.isTurned=!1),"PHYSX"===B.engine&&(e.isAbsolute=!0,e.isTurned=!0),"HAVOK"===B.engine&&(e.isAbsolute=!0,e.isTurned=!0,e.isReverse=!1),"OIMO"!==B.engine&&(e.zone=e.zone||.25);const t=new Vr(e);return ee.extendShader(t.material,t.material.onBeforeCompile),t.physicsUpdate=(e,t)=>{B.flow.tmp.push({name:e,heightData:t})},this.addToWorld(t,e.id),B.post({m:"add",o:jr(t)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}};const jr=function(e){const t={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===B.engine?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===B.engine||"AMMO"===B.engine||"HAVOK"===B.engine||"JOLT"===B.engine?(t.type="terrain",t.size=e.sizeZ,t.sample=e.sampleZ,t.zone=e.zone,t.heightData=e.heightData):(t.type="mesh",t.v=A.getVertex(e.geometry,"OIMO"===B.engine),t.index="OIMO"===B.engine?null:A.getIndex(e.geometry)),t};let Wr=class extends ae{constructor(){super(),this.Utils=E,this.type="solver"}step(){const e=B.Ar,t=B.ArPos[this.type];let s,i=this.list.length;for(;i--;)s=t+i*v[this.type],this.list[i].update(e,s)}add(e={}){this.setName(e);let t=new Kr(e);return this.addToWorld(t,e.id),B.post({m:"add",o:e}),t}set(e={}){}},Kr=class{constructor(e){this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(e){this.bones.push(e)}dispose(){B.motor.remove(this.bones,!0)}update(e,t){if(!this.needData)return;let s,i,a=this.joints.length;for(;a--;)i=t+7*a,s=this.joints[a],s.data.target.x=e[i+0],s.data.target.y=e[i+1],s.data.target.z=e[i+2],s.data.target.rx=e[i+3],s.data.target.ry=e[i+4],s.data.target.rz=e[i+5],s.data.target.count=e[i+6]}start(){B.post({m:"startArticulation",o:{name:this.name}})}stop(){B.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){B.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,void 0!==e.rot1&&(e.quat1=A.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=A.quatFromEuler(e.rot2),delete e.rot2),"fixe"!==e.type&&this.joints.push(new Jr(e,this)),B.post({m:"addSolverJoint",o:e})}driveJoints(e){let t,s,i=!1,a=this.joints.length,r=[];for(;a--;)t=this.joints[a],t.update(e),s=t.isDrive,t.nup&&r.push(t.nup),i=!!s||i;i?B.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(!e)return;let s=this.joints.length;for(;s--;)this.joints[s].pose(void 0!==e[s]?e[s]:0,void 0!==t?t:this.speed);return new Promise((e=>this.resolve=e))}},Jr=class{constructor(e,t){if(this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},e.limits&&(this.driveType=e.limits[0][0],this.min=e.limits[0][1],this.max=e.limits[0][2]),e.position&&(e.target=e.position),e.target){let t,s=e.target.length;for(;s--;)t=e.target[s],this.data.target[t[0]]=t[1]}}start(){}pose(e,t){this.target=A.clamp(e,this.min,this.max),this.current=A.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e*this.time;let t=this.tmp;t=t>1?1:t;let s=A.lerp(this.start,this.target,t);this.nup={name:this.name,drivesTarget:[[this.driveType,s]]},1===t&&(this.isDrive=!1)}else this.nup=null}},Yr=class extends s.Mesh{constructor(e={}){super(new s.PlaneGeometry,new s.MeshBasicMaterial({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=e.nam||"text",this.canvas=null,this.w=e.w||0,this.h=e.h||0,this.weight=e.weight??700,this.font=e.font??"'Mulish', sans-serif",this.fontSize=e.fontSize??32,this.backgroundColor=e.backgroundColor??"#00000000",this.fontColor=e.fontColor??"#FFFFFF",this.material.alphaTest=.5,this.set(e.text),e.pos&&this.position.fromArray(e.pos),e.rot&&this.quaternion.fromArray(A.quatFromEuler(e.rot))}set(e){this.canvas||(this.canvas=document.createElement("canvas"));let t,i,a,r=this.canvas.getContext("2d");r.font=this.weight+" "+this.fontSize+"px "+this.font;let o=r.measureText(e);t=2**Math.ceil(Math.log2(o.width)),i=2**Math.ceil(Math.log2(r.measureText("M").width)),this.canvas.width=t,this.canvas.height=i,r.fillStyle=this.backgroundColor,r.fillRect(0,0,t,i),r.fillStyle=this.fontColor,r.font=this.weight+" "+this.fontSize+"px "+this.font,r.textAlign="center",r.textBaseline="middle",r.fillText(e,.5*t,.5*i),this.material.map=new s.CanvasTexture(this.canvas),0!==this.h?(a=this.h/i,this.scale.set(t*a,this.h,0)):0!==this.w?(a=this.w/i,this.scale.set(this.w,i*a,0)):this.scale.set(.025*t,.025*i,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}},Xr=0,Zr=class{constructor(e={}){this.down=!1,this.time=e.time||250,this.p=e.pos||[0,0,0],this.type=e.type||"box",this.name=e.name||"button"+Xr++,this.pos=e.pos||[0,0,0],this.size=e.size||[1,1,1],this.radius=e.radius||0,this.axe=void 0!==e.axe?e.axe:1,this.fontSize=e.fontSize||.8,this.fontScale=e.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let t=this.size[this.axe]-2*this.radius;this.range=[this.origin-t,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},e.callback&&(this.callback=e.callback,delete e.callback),e.button=!0,e.pos=this.pos,e.material||(e.material="button"),e.kinematic=!0,e.mask=1,this.timeout=null,this.b=B.motor.add(e),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),e.text&&this.addText(e.text)}addText(e,t){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let s={text:e,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(s={text:e,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new Yr(s),this.b.add(this.txt)}action(e){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&B.motor.explosion(e||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&B.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=A.lerp(this.value,this.target,this.speed),A.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,B.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}};const $r=new s.Box3;class eo extends s.LineSegments{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),a=new Float32Array(24);let r=new s.Color(t),o=[],n=8;for(;n--;)o.push(r.r,r.g,r.b);const l=new Float32Array(o),h=new s.BufferGeometry;h.setIndex(new s.BufferAttribute(i,1)),h.setAttribute("position",new s.BufferAttribute(a,3)),h.setAttribute("color",new s.BufferAttribute(l,3)),super(h,new s.LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&$r.setFromObject(this.object),$r.isEmpty())return;const t=$r.min,s=$r.max,i=this.geometry.attributes.position,a=i.array;a[0]=s.x,a[1]=s.y,a[2]=s.z,a[3]=t.x,a[4]=s.y,a[5]=s.z,a[6]=t.x,a[7]=t.y,a[8]=s.z,a[9]=s.x,a[10]=t.y,a[11]=s.z,a[12]=s.x,a[13]=s.y,a[14]=t.z,a[15]=t.x,a[16]=s.y,a[17]=t.z,a[18]=t.x,a[19]=t.y,a[20]=t.z,a[21]=s.x,a[22]=t.y,a[23]=t.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e,t){return super.copy(e,t),this.object=e.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}let to=class{constructor(e={}){this.isCompound=!0,this.remplace=e.remplace||!1,this.init(e)}init(e={}){const t=e.intern||!1;let i=e.size||[5,3,8],a=e.pos||[0,2,0],r=e.wall||.1;void 0!==e.size[3]&&(r=e.size[3]),r<=0&&(r=.01);let o=.5*r,n=2*r;e.face||(e.face={});let l={up:1,down:1,left:1,right:1,front:1,back:1,...e.face};delete e.face;const h=[];t?(1===l.up&&h.push({pos:[0,.5*i[1]+o,0],size:[i[0]+n,r,i[2]+n]}),1===l.down&&h.push({pos:[0,-o-.5*i[1],0],size:[i[0]+n,r,i[2]+n]}),1===l.left&&h.push({pos:[-o-.5*i[0],0,0],size:[r,i[1],i[2]]}),1===l.right&&h.push({pos:[.5*i[0]+o,0,0],size:[r,i[1],i[2]]}),1===l.back&&h.push({pos:[0,0,-o-.5*i[2]],size:[i[0]+n,i[1],r]}),1===l.front&&h.push({pos:[0,0,.5*i[2]+o],size:[i[0]+n,i[1],r]})):(1===l.up&&h.push({pos:[0,.5*i[1]-o,0],size:[i[0],r,i[2]]}),1===l.down&&h.push({pos:[0,o-.5*i[1],0],size:[i[0],r,i[2]]}),1===l.left&&h.push({pos:[o-.5*i[0],0,0],size:[r,i[1]-n,i[2]]}),1===l.right&&h.push({pos:[.5*i[0]-o,0,0],size:[r,i[1]-n,i[2]]}),1===l.back&&h.push({pos:[0,0,o-.5*i[2]],size:[i[0]-n,i[1]-n,r]}),1===l.front&&h.push({pos:[0,0,.5*i[2]-o],size:[i[0]-n,i[1]-n,r]}));const c=[];let d,u,p=h.length,m=0;for(;p--;)u=h[m],d=this.isCompound?u.pos:A.addArray(a,u.pos),c.push({type:"box",size:u.size,pos:d,material:e.material}),m++;if(this.isCompound){let t=null;this.remplace&&(t=0===e.radius?new s.Mesh(new s.BoxGeometry(i[0],i[1],i[2])):new s.Mesh(new Qe(i[0],i[1],i[2],e.radius||o)),e.material&&"debug"===e.material&&(t=new eo(t,e.color),e.material="line")),B.motor.add({...e,mesh:t,shapes:c,type:"compound"})}else B.motor.add(c)}},so=class{constructor(e,t="drag"){this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=t,this.option={},this.overObj=null,this.controler=e,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new s.Vector3,this.tmpPos=new s.Vector3,this.tmpD=new s.Vector3,this.mouse=new s.Vector2,this.oldMouse=new s.Vector2,this.raycast=new s.Raycaster,this.raycast.far=1e3,this.button=0,this.pos=new s.Vector3,this.velocity=new s.Vector3,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.helper=new io,this.dragPlane=new s.Mesh(new s.PlaneGeometry(1,1),ee.get("hide")),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),B.scenePlus.add(this.helper),B.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(B.scenePlus.remove(this.dragPlane),B.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(e,t={}){e!==this.mode&&(this.mode=e,this.option=t,"blast"===this.mode&&this.option.visible&&B.motor.initParticle())}activeDragMouse(e){e?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(e){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(e){this.raycastTest=!1}controleChange(e){}getMouse(e){B.viewSize?(this.mouse.x=e.offsetX/B.viewSize.w*2-1,this.mouse.y=-e.offsetY/B.viewSize.h*2+1):(this.mouse.x=e.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-e.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==e.pointerType?e.button:0}contextmenu(e){}mousedown(e){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(e),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(e){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,B.mouseDown=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(e){if("drag"===this.mode)this.getMouse(e),this.needRay=!0}castray(){let e,t,s,i,a,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObject(this.dragPlane),e.length&&this.mouseDown&&this.moveSelect(e[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObjects(B.scene.children,!0),this.tmpSelected=null,e.length>0?(s=e[0].object,a=e[0].instanceId,void 0!==a?t=B.motor.byName(s.getByName(a)):s.parent!==B.scene?(i=s.parent,t=i.parent!==B.scene?i.parent:i):t=s,this.mouseDown2&&t.extra&&t.extra(t.name),r=t&&!t.isButton?this.select(t,e[0].point):this.actionButton(t,e[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,B.mouseDown=!0,this.needRay=!0}blast(){let e=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let t=this.raycast.intersectObjects(B.scene.children,!0);t.length>0?t[0].object.isButton?t[0].object.parent.userData.direct():e=t[0]:(t=this.raycast.intersectObjects(B.scenePlus.children,!0),t.length>0&&(e=t[0]));const s=this.option;e&&(B.motor.explosion(e.point,s.radius||3,s.power||.1),s.visible&&B.motor.addParticle({name:"blast",type:"cube",position:e.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(60),B.motor.add({name:"bullet_"+this.numBullet,type:"sphere",density:20,size:[.2],material:"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(e,t){if(this.buttonRef?this.buttonRef.name!==e.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=e):this.mouseDown&&(this.buttonRef=e),this.mouseDown&&this.buttonRef.userData.action){let e=t.point;this.buttonRef.userData.action(e)}return"pointer"}setOver(e){e&&(this.overObj&&e.name!==this.overObj.name&&this.resetOver(),this.overObj=e,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(e,t){if(this.mouseDown||this.setOver(e),!this.mouseDown||this.selected===e)return"grab";this.pz=0;let s=t,i=[0,0,0,1];this.selected=e,this.decal.copy(s).sub(this.selected.position),this.tmpPos.copy(s).sub(this.decal),this.angle=this.controler.getAzimuthalAngle();let a=this.selected.quaternion;i=[a._x,a._y,a._z,a._w],this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(s),this.dragPlane.position.y=0,this.helper.position.copy(s);let r=s.toArray(),o=!1;if(B.motor.change({name:this.selected.name,neverSleep:!0,wake:!0}),this.moveDirect)B.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let e=[-.1,.1,600,1],t=[-.1,.1,600,1],s="OIMO"===B.engine||"RAPIER"===B.engine||"JOLT"===B.engine,a=0===this.selected.link?"fixe":"d6";"JOLT"===B.engine&&(a="fixe");let n=[["x",...e],["y",...e],["z",...e],["rx",...t],["ry",...t],["rz",...t]];"HAVOK"===B.engine&&(n=[["x",...e],["y",...e],["z",...e]]),"OIMO"===B.engine&&(o=!0,a=0===this.selected.link?"fixe":"spherical",n=[["x",...e],["y",...e],["z",...e]]),"HAVOK"===B.engine&&(o=!0,a=0===this.selected.link?"fixe":"spherical",n=[-180,180,.1,.1]),B.motor.add([{name:"mouse",type:"null",pos:r,quat:i,kinematic:!s},{name:"mouseJoint",type:"joint",mode:a,lm:n,sd:[4,1],autoDrive:!0,b1:o?this.selected.name:"mouse",b2:o?"mouse":this.selected.name,worldAnchor:r,visible:!1}])}return"grabbing"}moveSelect(e){if(null===this.selected)return;if(e&&this.tmpPos.copy(e).sub(this.decal),this.moveDeep){let e=this.selected.position.y,t=e-this.tmpPos.y;this.tmpPos.y=e,this.tmpD.set(0,0,t).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let t=this.tmpPos.toArray();this.moveDirect?B.motor.change({name:this.selected.name,pos:t,reset:!0}):B.motor.change({name:"mouse",pos:e.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?B.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(B.motor.remove(["mouseJoint","mouse"]),B.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let e=B.flow.key;if(0!==e[1]){let t=.1*e[1];this.dragPlane.translateZ(t),this.needRay=!0}this.moveDirect&&this.moveSelect()}},io=class extends s.Line{constructor(e={}){super(new s.BufferGeometry,ee.get("line"));let t=.75;const i=[t,t,t,0,0,0];this.geometry.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new s.Float32BufferAttribute(i,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}};const ao=new s.Vector3;class ro{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new s.Line3,this.tempPlane1=new s.Plane,this.tempPlane2=new s.Plane,this.tempPlane_Cut=new s.Plane,this.tempCM1=new s.Vector3,this.tempCM2=new s.Vector3,this.tempVector3=new s.Vector3,this.tempVector3_2=new s.Vector3,this.tempVector3_3=new s.Vector3,this.tempVector3_P0=new s.Vector3,this.tempVector3_P1=new s.Vector3,this.tempVector3_P2=new s.Vector3,this.tempVector3_N0=new s.Vector3,this.tempVector3_N1=new s.Vector3,this.tempVector3_AB=new s.Vector3,this.tempVector3_CB=new s.Vector3,this.tempResultObjects={object1:null,object2:null},this.box1=new s.Box3,this.box2=new s.Box3,this.sph1=new s.Sphere,this.sph2=new s.Sphere,this.tt=new s.Vector3,this.s1=new s.Vector3,this.s2=new s.Vector3,this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1}prepareBreakableObject(e,t,s,i,a){const r=e.userData;r.mass=t,r.velocity=s.clone(),r.angularVelocity=i.clone(),r.breakable=a}subdivideByImpact(e,t,s,i,a){const r=[],o=this.tempPlane1,n=this.tempPlane2;this.tempVector3.addVectors(t,s),o.setFromCoplanarPoints(t,e.position,this.tempVector3);const l=a+i,h=this;return function a(c,A,d,u){if(Math.random()<.05*u||u>l)return void r.push(c);let p=Math.PI;0===u?(n.normal.copy(o.normal),n.constant=o.constant):u<=i?(p=(d-A)*(.2+.6*Math.random())+A,h.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(s,p).add(t),n.setFromCoplanarPoints(t,h.tempVector3,h.tempVector3_2)):(p=(.5*(1&u)+.2*(2-Math.random()))*Math.PI,h.tempVector3_2.copy(t).sub(c.position).applyAxisAngle(s,p).add(c.position),h.tempVector3_3.copy(s).add(c.position),n.setFromCoplanarPoints(c.position,h.tempVector3_3,h.tempVector3_2)),h.cutByPlane(c,n,h.tempResultObjects);const m=h.tempResultObjects.object1,g=h.tempResultObjects.object2;m&&a(m,A,p,u+1),g&&a(g,p,d,u+1)}(e,0,2*Math.PI,0),r}cutByPlane(e,t,i){let a;const r=e.geometry,o=r.attributes.position.array,n=r.attributes.normal.array,l=o.length/3;let h=l/3,c=r.getIndex();function A(e,t){const s=3*e+t;return c?c[s]:s}c&&(c=c.array,h=c.length/3);const d=[],u=[],p=this.smallDelta,m=l*l;for(let e=0;e<m;e++)this.segments[e]=!1;const g=this.tempVector3_P0,f=this.tempVector3_P1,b=this.tempVector3_N0,y=this.tempVector3_N1;for(let e=0;e<h-1;e++){const t=A(e,0),s=A(e,1),i=A(e,2);b.set(n[t],n[t]+1,n[t]+2);for(let a=e+1;a<h;a++){const e=A(a,0),r=A(a,1),o=A(a,2);y.set(n[e],n[e]+1,n[e]+2);1-b.dot(y)<p&&(t===e||t===r||t===o?s===e||s===r||s===o?(this.segments[t*l+s]=!0,this.segments[s*l+t]=!0):(this.segments[i*l+t]=!0,this.segments[t*l+i]=!0):s!==e&&s!==r&&s!==o||(this.segments[i*l+s]=!0,this.segments[s*l+i]=!0))}}const w=this.tempPlane_Cut;e.updateMatrix(),ro.transformPlaneToLocalSpace(t,e.matrix,w);for(let e=0;e<h;e++){const t=A(e,0),a=A(e,1),r=A(e,2);for(let e=0;e<3;e++){const n=0===e?t:1===e?a:r,h=0===e?a:1===e?r:t;if(this.segments[n*l+h])continue;this.segments[n*l+h]=!0,this.segments[h*l+n]=!0,g.set(o[3*n],o[3*n+1],o[3*n+2]),f.set(o[3*h],o[3*h+1],o[3*h+2]);let c=0,A=w.distanceToPoint(g);A>p?(c=2,u.push(g.clone())):A<-p?(c=1,d.push(g.clone())):(c=3,d.push(g.clone()),u.push(g.clone()));let m=0;if(A=w.distanceToPoint(f),A>p?(m=2,u.push(f.clone())):A<-p?(m=1,d.push(f.clone())):(m=3,d.push(f.clone()),u.push(f.clone())),1===c&&2===m||2===c&&1===m){this.tempLine1.start.copy(g),this.tempLine1.end.copy(f);let e=new s.Vector3;if(e=w.intersectLine(this.tempLine1,e),null===e)return console.error("Internal error: segment does not intersect plane."),i.segmentedObject1=null,i.segmentedObject2=null,0;d.push(e),u.push(e.clone())}}}e.userData.mass;let v=this.box1,C=this.box2,I=d.length,x=u.length;for(v.makeEmpty(),C.makeEmpty(),a=I;a--;)v.expandByPoint(d[a]);for(a=x;a--;)C.expandByPoint(u[a]);for(v.getBoundingSphere(this.sph1),C.getBoundingSphere(this.sph2),this.tempCM1.copy(this.sph1.center),this.tempCM2.copy(this.sph2.center),a=I;a--;)d[a].sub(this.tempCM1);for(a=x;a--;)u[a].sub(this.tempCM2);this.tempCM1.add(e.position),this.tempCM2.add(e.position),v.getSize(this.s1),C.getSize(this.s2),2*this.sph1.radius<this.minSizeForBreak&&(I=0),2*this.sph2.radius<this.minSizeForBreak&&(x=0),this.testSize(this.s1)&&(I=0),this.testSize(this.s2)&&(x=0);let B=null,E=null,M=0;return I>4&&(B=new s.Mesh(new qe(d),e.material),B.position.copy(this.tempCM1),B.quaternion.copy(e.quaternion),M++),x>4&&(E=new s.Mesh(new qe(u),e.material),E.position.copy(this.tempCM2),E.quaternion.copy(e.quaternion),M++),i.object1=B,i.object2=E,M}testSize(e){let t=0;return e.x<.01&&t++,e.y<.01&&t++,e.z<.01&&t++,t>1}static transformFreeVector(e,t){const s=e.x,i=e.y,a=e.z,r=t.elements;return e.x=r[0]*s+r[4]*i+r[8]*a,e.y=r[1]*s+r[5]*i+r[9]*a,e.z=r[2]*s+r[6]*i+r[10]*a,e}static transformFreeVectorInverse(e,t){const s=e.x,i=e.y,a=e.z,r=t.elements;return e.x=r[0]*s+r[1]*i+r[2]*a,e.y=r[4]*s+r[5]*i+r[6]*a,e.z=r[8]*s+r[9]*i+r[10]*a,e}static transformTiedVectorInverse(e,t){const s=e.x,i=e.y,a=e.z,r=t.elements;return e.x=r[0]*s+r[1]*i+r[2]*a-r[12],e.y=r[4]*s+r[5]*i+r[6]*a-r[13],e.z=r[8]*s+r[9]*i+r[10]*a-r[14],e}static transformPlaneToLocalSpace(e,t,s){s.normal.copy(e.normal),s.constant=e.constant;const i=ro.transformTiedVectorInverse(e.coplanarPoint(ao),t);ro.transformFreeVectorInverse(s.normal,t),s.constant=-i.dot(s.normal)}}new s.Vector2(1,1),new s.Vector2,new s.Vector3,new s.Vector3,new s.Vector3,new s.Plane,new s.Plane;let oo=class{constructor(){this.convexBreaker=new ro,this.tmpI=new THREE.Vector3,this.tpos=new THREE.Vector3,this.tnormal=new THREE.Vector3,this.nDebris=0,this.maxDebris=300,this.tt=null}step(){let e;for(let t in B.reflow.point)e=B.reflow.point[t],0!==e.distance&&(this.makeBreak(e.b1,e.pos,e.normal,e.impulse,e.v1),this.makeBreak(e.b2,e.pos,e.normal,e.impulse,e.v2))}makeBreak(e,t,s,i,a){let r=E.byName(e);if(!r)return;if(!r.breakable)return;let o=r.breakOption;if(i<o[0])return;let n=this.convexBreaker.subdivideByImpact(r,this.tpos.fromArray(t),this.tnormal.fromArray(s),o[1],o[2]);if(n.length<1)return;o[3]-=1;const l={material:r.material,linearVelocity:[a[0],a[1],a[2]],angularVelocity:[a[3],a[4],a[5]],density:r.density};let h=[],c=n.length,A=0;for(;c--;)h.push(this.addDebris(n[A],o,l)),A++;this.tt=setTimeout((()=>{B.motor.remove(e),B.motor.add(h)}),0)}addDebris(e,t,s){let i=t[3]>0,a={...s,name:"debris_"+this.nDebris++,type:"convex",shape:e.geometry,pos:e.position.toArray(),quat:e.quaternion.toArray(),breakable:i,breakOption:t};return this.nDebris>this.maxDebris&&(this.nDebris=0),a}};new s.Vector3;const no=new s.Vector3,lo=new s.Vector3,ho=new s.Vector3,co=new s.Vector3,Ao=new s.Vector3;let uo=class{constructor(e={}){this.name=e.name||"ppp",this.particles=[],this.density=.01,this.smoothingRadius=.2,this.speedOfSound=.1,this.viscosity=.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.tv=new s.Vector3,this.tv2=new s.Vector3}add(e){let t=B.motor.add({instance:this.name,type:"particle",flags:"noQuery",size:[.1],pSize:.03,pos:e,inertia:[0,0,0],mass:.001,restitution:0,friction:.5,damping:[.1,.1],material:"hide"});t.force=new s.Vector3,this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(e){let t=e.length;console.log(t);let s,i,a,r=[],o=0;for(;t--;)s=e[t],this.name,s[0],this.name,s[1],i=this.particles[s[0]].position,a=this.particles[s[1]].position,o=this.tv.copy(i).distanceTo(a),this.tv.copy(a).sub(i),r.push({type:"distance",helperSize:.03,b1:this.name+s[0],b2:this.name+s[1],limit:[.5*o,o],spring:[20,1],friction:0});B.motor.add(r)}getPosition(){let e,t,s=[],i=this.particles.length;for(;i--;)t=3*i,e=this.particles[i],s[t]=e.position.x,s[t+1]=e.position.y,s[t+2]=e.position.z;return s}getNeighbors(e,t){const s=this.particles.length,i=e.id,a=this.smoothingRadius*this.smoothingRadius;let r=0;for(let o=0;o!==s;o++){const s=this.particles[o];r=this.distance(s,e),i!==s.id&&r<a&&t.push(s)}}distance(e,t){const s=e.position.x-t.position.x,i=e.position.y-t.position.y,a=e.position.z-t.position.z;return s*s+i*i+a*a}w(e){const t=this.smoothingRadius;return 315/(64*Math.PI*t**9)*(t*t-e*e)**3}gradw(e,t){const s=e.length(),i=this.smoothingRadius;t.copy(e).multiplyScalar(945/(32*Math.PI*i**9)*(i*i-s*s)**2)}nablaw(e){const t=this.smoothingRadius;return 945/(32*Math.PI*t**9)*(t*t-e*e)*(7*e*e-3*t*t)}update(){const e=[],t=this.particles.length,s=this.speedOfSound,i=this.eps;let a,r=t;for(;r--;){const e=this.particles[r];e.force.set(0,0,0);const t=this.neighbors[r];t.length=0,this.getNeighbors(e,t),t.push(this.particles[r]);let i=0;for(a=t.length;a--;){const s=this.w(this.distance(e,t[a]));i+=t[a].mass*s}this.densities[r]=i,this.pressures[r]=s*s*(this.densities[r]-this.density)}const o=no,n=lo,l=ho,h=co,c=Ao;for(r=t;r--;){const t=this.particles[r];let s,A;o.set(0,0,0),n.set(0,0,0);const d=this.neighbors[r];for(a=d.length;a--;){const e=d[a];h.copy(t.position).sub(e.position);const u=h.length();s=-e.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[a]/(this.densities[a]*this.densities[a]+i)),this.gradw(h,l),l.multiplyScalar(s),o.add(l),c.copy(e.velocity).sub(t.velocity),c.multiplyScalar(1/(1e-4+this.densities[r]*this.densities[a])*this.viscosity*e.mass),A=this.nablaw(u),c.multiplyScalar(A),n.add(c)}n.multiplyScalar(t.mass),o.multiplyScalar(t.mass),t.force.add(n),t.force.add(o),e.push({name:t.name,force:t.force.toArray()})}B.motor.change(e)}};const po=Math.PI/180,mo=[new s.Vector3(1,0,0),new s.Vector3(0,1,0),new s.Vector3(0,0,1)],go=new s.Vector3,fo=new s.Vector3,bo=new s.Vector3,yo=new s.Vector3,wo=[],vo=[],Co=new s.Vector3,Io=new s.Vector3,xo=new s.Vector3;new s.Matrix4;let Bo=class{constructor(e={}){this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=e.name||"car",this.mass=e.mass||1e3,this.size=e.size||[1.5,.7,3.8],this.pos=e.pos||[0,4,0],this.rot=e.rot||[0,0,0],this.friction=e.friction||.2,this.restitution=e.restitution||.3,this.massCenter=e.massCenter||[0,0,0],this.driveWheel=e.driveWheel||null;let t=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];e.shapeMesh&&(t=[{type:"convex",shape:e.shapeMesh.geometry,pos:e.shapePos||[0,0,0]}]),this.body=B.motor.add({type:"compound",shapes:t,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:e.bodyMesh||null,meshPos:e.meshPos||[0,-1.1,0],material:e.material,damping:[.05,.05],debug:!1}),this.body.inertia.set(283.33331298828125,333.33331298828125,83.33332824707031),this.vehicle=new Eo({chassis:this.body});let i=e.wheelPosition||[.61,0,1.2];const a=[new s.Vector3(-i[0],i[1],-i[2]),new s.Vector3(i[0],i[1],-i[2]),new s.Vector3(-i[0],i[1],i[2]),new s.Vector3(i[0],i[1],i[2])],r={radius:e.wheelRadius||.31,directionLocal:new s.Vector3(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new s.Vector3(1,0,0),chassisConnectionPointLocal:new s.Vector3(1,1,0)};let o,n,l;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),a.forEach((e=>{r.chassisConnectionPointLocal.copy(e),this.vehicle.addWheel(r)}));let h=B.motor.getMat("debug");if(e.wheelMesh?(n=e.wheelMesh,l=e.wheelMesh2?e.wheelMesh2:null,e.material&&(h=e.material||h,n.material=h,l&&(l.material=h))):(o=new s.CylinderGeometry(r.radius,r.radius,e.wheelDepth||.2),o.rotateZ(.5*Math.PI),n=new s.Mesh(o,h),l=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[l||n.clone(),n,l?l.clone():n.clone(),n.clone()];let e=this.vehicle.wheelMeshes.length,t=0;for(;e--;)this.body.add(this.vehicle.wheelMeshes[t++])}else m.matrixAutoUpdate=!1,l&&(l.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[B.motor.add(l||m.clone()),B.motor.add(m),B.motor.add(l?l.clone():m.clone()),B.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let e=B.motor.getDelta();B.motor.getAzimut();let t=B.motor.getKey();this.tmp.forwardForce=t[1],this.tmp.steerDirection=-1*t[0],this.tmp.brakeForce=1===t[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let s=Math.abs(this.vehicle.currentVehicleSpeedKmHour);s=Math.min(s,this.maxSpeed),this.maxSpeed;const i=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(i,0),this.vehicle.applyEngineForce(i,1),this.vehicle.applyEngineForce(i,2),this.vehicle.applyEngineForce(i,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(e),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*po)}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.vehicle&&this.vehicle.setWheels(e,this.extra[e])}})}},Eo=class{constructor(e){this.chassisBody=e.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:0,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:2,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(e={}){let t=new ko(e),s=this.wheelInfos.length-1;t.chassisBody=this.chassisBody;let i=t.suspensionRestLength+t.radius;return t.ray=B.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+s,begin:t.chassisConnectionPointLocal.toArray(),end:[t.chassisConnectionPointLocal.x,-i,t.chassisConnectionPointLocal.z],callback:function(e){t.castRay(e)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(t),s}setWheels(e,t){let s,i=this.wheelInfos.length;for(;i--;)s=this.wheelInfos[i],s[e]&&(s[e]=t)}setSteeringValue(e,t){this.wheelInfos[t].steering=e}applyEngineForce(e,t){this.wheelInfos[t].engineForce=e}setBrake(e,t){this.wheelInfos[t].brake=e}getVehicleAxisWorld(e,t){return t.set(0===e?1:0,1===e?1:0,2===e?1:0),No(t,Lo(this.chassisBody,new s.Matrix4),t),t}updateVehicle(e){let t=this.wheelInfos,i=t.length,a=this.chassisBody,r=i;for(;r--;)this.updateWheelTransform(r);const o=Do(a,new s.Vector3),n=Vo(o,Lo(a,new s.Matrix4).invert(),new s.Vector3);this.currentVehicleSpeedKmHour=n.z;let l=new s.Vector3;this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(a.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(e);let h=new s.Vector3;for(new s.Vector3,r=0;r<i;r++){let s=t[r],i=s.suspensionForce;i>s.maxSuspensionForce&&(i=s.maxSuspensionForce),h.copy(s.raycastResult.hitNormalWorld).multiplyScalar(i*e),_o(a,h,s.raycastResult.hitPointWorld)}this.updateFriction(e);let c=new s.Vector3,A=new s.Vector3,d=new s.Vector3;for(r=0;r<i;r++){let s=t[r];Go(a,s.chassisConnectionPointWorld,d);let i=1;if(1===this.indexUpAxis)i=-1;if(s.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,A);let t=Uo(A,s.raycastResult.hitNormalWorld);c.copy(s.raycastResult.hitNormalWorld).multiplyScalar(t),A.sub(c);let a=Uo(A,d);s.deltaRotation=i*a*e/s.radius}!s.sliding&&s.isInContact||0===s.engineForce||!s.useCustomSlidingRotationalSpeed||(s.deltaRotation=(s.engineForce>0?1:-1)*s.customSlidingRotationalSpeed*e),Math.abs(s.brake)>Math.abs(s.engineForce)&&(s.deltaRotation=0),s.rotation-=s.deltaRotation,s.deltaRotation*=.99}}updateSuspension(e){let t=this.chassisBody,s=Ro(t),i=this.wheelInfos,a=i.length;for(let e=0;e<a;e++){let t=i[e];if(t.isInContact){let e,i=t.suspensionRestLength-t.suspensionLength;e=t.suspensionStiffness*i*t.clippedInvContactDotSuspension;let a,r=t.suspensionRelativeVelocity;a=r<0?t.dampingCompression:t.dampingRelaxation,e-=a*r,t.suspensionForce=e*s,t.suspensionForce<0&&(t.suspensionForce=0)}else t.suspensionForce=0}}updateFriction(e){let t,i,a,r=yo,o=this.wheelInfos,n=o.length,l=this.chassisBody,h=wo,c=vo;for(t=0;t<n;t++)if(i=o[t],a=i.raycastResult.body,i.sideImpulse=0,i.forwardImpulse=0,h[t]||(h[t]=new s.Vector3),c[t]||(c[t]=new s.Vector3),a){let e=c[t],s=this.getWheelTransformWorld(t);Vo(mo[this.indexRightAxis],s,e);let o=i.raycastResult.hitNormalWorld,n=Uo(e,o);r.copy(o).multiplyScalar(n),e.sub(r).normalize(),Oo(o,e,h[t]),h[t].normalize(),i.sideImpulse=en(l,i.raycastResult.hitPointWorld,a,i.raycastResult.hitPointWorld,e),i.sideImpulse*=1}for(this.sliding=!1,t=0;t<n;t++){i=o[t],a=i.raycastResult.body;let s=0;if(i.slipInfo=1,a){let r=0,o=i.brake?i.brake:r;s=Ho(l,a,i.raycastResult.hitPointWorld,h[t],o),s+=i.engineForce*e;let n=o/s;i.slipInfo*=n}if(i.forwardImpulse=0,i.skidInfo=1,a){i.skidInfo=1;let t=i.suspensionForce*e*i.frictionSlip,a=t*t;i.forwardImpulse=s;let r=.5*i.forwardImpulse/i.forwardAcceleration,o=1*i.sideImpulse/i.sideAcceleration,n=r*r+o*o;if(i.sliding=!1,n>a){this.sliding=!0,i.sliding=!0;let e=t/Math.sqrt(n);i.skidInfo*=e}}}if(this.sliding)for(let e=0;e<n;e++)i=o[e],0!==i.sideImpulse&&i.skidInfo<1&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(t=0;t<n;t++){i=o[t];let e=new s.Vector3;if(e.copy(i.raycastResult.hitPointWorld).sub(Fo(l,new s.Vector3)),0!==i.forwardImpulse){let e=new s.Vector3;e.copy(h[t]).multiplyScalar(i.forwardImpulse),_o(l,e,i.raycastResult.hitPointWorld)}if(0!==i.sideImpulse){a=i.raycastResult.body,(new s.Vector3).copy(i.raycastResult.hitPointWorld).sub(Fo(a,new s.Vector3));let r=new s.Vector3;r.copy(c[t]).multiplyScalar(i.sideImpulse),Vo(e,Lo(l,new s.Matrix4).invert(),e),e["xyz"[this.indexUpAxis]]*=i.rollInfluence,Vo(e,Lo(l,new s.Matrix4),e),_o(l,r,Fo(l,new s.Vector3).add(e)),r.multiplyScalar(-1),_o(a,r,i.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(e){const t=this.chassisBody.matrixWorld;No(e.chassisConnectionPointLocal,t,e.chassisConnectionPointWorld),Vo(e.directionLocal,t,e.directionWorld)}updateWheelTransform(e){let t=Co,i=Io,a=xo,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),t.copy(r.directionLocal).multiplyScalar(-1),i.copy(r.axleLocal),Oo(t,i,a),a.normalize(),i.normalize();let o=r.steering,n=new s.Quaternion;qo(t,o,n);let l=new s.Quaternion;qo(i,r.rotation,l);let h=r.quaternion;Po(this.chassisBody,h),h.multiply(n).multiply(l).normalize();let c=r.position;c.copy(r.directionWorld),c.multiplyScalar(r.suspensionLength);let A=c.clone();c.add(r.chassisConnectionPointWorld),r.matrix.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.localWheel?(A.add(r.chassisConnectionPointLocal),this.wheelMeshes[e].quaternion.copy(n).multiply(l).normalize(),this.wheelMeshes[e].position.copy(A),this.brakeMeshs&&(2!==e&&3!==e||this.brakeMeshs[e].quaternion.copy(n).normalize(),this.brakeMeshs[e].position.copy(A),this.brakeMeshs[e].updateMatrix())):(this.wheelMeshes[e].position.copy(r.position),this.wheelMeshes[e].quaternion.copy(r.quaternion),this.wheelMeshes[e].updateMatrix())}getWheelTransformWorld(e){return this.wheelInfos[e].matrix}};var Mo=new s.Vector3,So=new s.Vector3;let ko=class{constructor(e){e=((e,t)=>{for(var s in e=e||{},t)s in e||(e[s]=t[s]);return e})(e,{chassisConnectionPointLocal:new s.Vector3,chassisConnectionPointWorld:new s.Vector3,directionLocal:new s.Vector3,directionWorld:new s.Vector3,axleLocal:new s.Vector3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointLocal.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionLocal.clone(),this.axleLocal=e.axleLocal.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.forwardAcceleration=e.forwardAcceleration,this.sideAcceleration=e.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Qo,this.position=(new s.Vector3).copy(this.chassisConnectionPointLocal),this.quaternion=new s.Quaternion,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new s.Matrix4}castRay(e){if(e.hit){this.isInContact=!0;let s=e.distance;this.raycastResult.hitPointWorld.fromArray(e.point),this.raycastResult.hitNormalWorld.fromArray(e.normal),this.raycastResult.body=B.motor.byName(e.body),this.suspensionLength=s-this.radius;let i=this.suspensionRestLength-this.maxSuspensionTravel,a=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<i&&(this.suspensionLength=i),this.suspensionLength>a&&(this.suspensionLength=a,this.raycastResult.reset());let r=Uo(this.raycastResult.hitNormalWorld,this.directionWorld);Go(this.chassisBody,this.raycastResult.hitPointWorld,Mo);var t=Uo(this.raycastResult.hitNormalWorld,Mo);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/r;this.suspensionRelativeVelocity=t*e,this.clippedInvContactDotSuspension=e}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(e){let t=this.raycastResult;if(this.isInContact){let s=t.hitNormalWorld.dot(t.directionWorld);So.copy(t.hitPointWorld).sub(e.position),Go(e,So,Mo);let i=t.hitNormalWorld.dot(Mo);if(s>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/s;this.suspensionRelativeVelocity=i*e,this.clippedInvContactDotSuspension=e}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.hitNormalWorld.copy(t.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}},Qo=class{constructor(){this.body=null,this.hitPointWorld=new s.Vector3,this.hitNormalWorld=new s.Vector3,this.directionWorld=new s.Vector3}reset(){this.body=null,this.hitPointWorld=new s.Vector3,this.hitNormalWorld=new s.Vector3,this.directionWorld=new s.Vector3}};const Ro=e=>e.mass,To=e=>e.mass>0?1/e.mass:0,Fo=(e,t)=>t.copy(e.position),Do=(e,t)=>t.copy(e.velocity),Lo=(e,t)=>t.copy(e.matrixWorld),Po=(e,t)=>t.copy(e.quaternion),_o=(e,t,s)=>{B.motor.change({name:e.name,impulse:t.toArray(),impulseCenter:s.toArray()})},Go=(e,t,s)=>(s.copy(t).sub(e.position),s.crossVectors(e.angular,s),s.add(e.velocity),s),zo=(e,t)=>(t.copy(e.inertia),Vo(t,e.matrixWorld,t),t.x=t.x>0?1/t.x:0,t.y=t.y>0?1/t.y:0,t.z=t.z>0?1/t.z:0,t),Uo=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,Oo=(e,t,s)=>{const i=e.y*t.z-e.z*t.y,a=e.z*t.x-e.x*t.z,r=e.x*t.y-e.y*t.x;return s.set(i,a,r),s},No=(e,t,s)=>{const i=e.x,a=e.y,r=e.z,o=t.elements,n=i*o[0]+a*o[4]+r*o[8]+o[12],l=i*o[1]+a*o[5]+r*o[9]+o[13],h=i*o[2]+a*o[6]+r*o[10]+o[14],c=1/(i*o[3]+a*o[7]+r*o[11]+o[15]);return s.x=n*c,s.y=l*c,s.z=h*c,s},Vo=(e,t,s)=>{const i=e.x,a=e.y,r=e.z,o=t.elements;return s.x=i*o[0]+a*o[4]+r*o[8],s.y=i*o[1]+a*o[5]+r*o[9],s.z=i*o[2]+a*o[6]+r*o[10],s},qo=(e,t,s)=>{const i=Math.sin(t/2);return e.normalize(),s.w=Math.cos(t/2),s.x=e.x*i,s.y=e.y*i,s.z=e.z*i,s};function Ho(e,t,s,i,a){var r=0,o=s,n=go,l=fo,h=bo;Go(e,o,n),Go(t,o,l),h.copy(n).sub(l);return a<(r=-Uo(i,h)*(1/(Yo(e,s,i)+Yo(t,s,i))))&&(r=a),r<-a&&(r=-a),r}var jo=new s.Vector3,Wo=new s.Vector3,Ko=new s.Vector3,Jo=new s.Vector3;function Yo(e,t,i){var a=jo,r=Wo,o=Ko,n=Jo;return a.copy(t).sub(Fo(e,new s.Vector3)),Oo(a,i,r),n.copy(zo(e,new s.Vector3)).multiply(r),Oo(n,a,o),To(e)+Uo(i,o)}var Xo=new s.Vector3,Zo=new s.Vector3,$o=new s.Vector3;function en(e,t,s,i,a){if(a.lengthSq()>1.1)return 0;let r=Xo,o=Zo,n=$o;return Go(e,t,r),Go(s,i,o),n.copy(r).sub(o),-.1*Uo(a,n)*(1/(To(e)+To(s)))}class tn extends s.ShaderMaterial{constructor({gamma:e,offsetHdr:t,offsetSdr:i,gainMapMin:a,gainMapMax:r,maxDisplayBoost:o,hdrCapacityMin:n,hdrCapacityMax:l,sdr:h,gainMap:c}){super({name:"GainMapDecoderMaterial",vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\n// min half float value\n#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )\n// max half float value\n#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )\n\nuniform sampler2D sdr;\nuniform sampler2D gainMap;\nuniform vec3 gamma;\nuniform vec3 offsetHdr;\nuniform vec3 offsetSdr;\nuniform vec3 gainMapMin;\nuniform vec3 gainMapMax;\nuniform float weightFactor;\n\nvarying vec2 vUv;\n\nvoid main() {\n  vec3 rgb = texture2D( sdr, vUv ).rgb;\n  vec3 recovery = texture2D( gainMap, vUv ).rgb;\n  vec3 logRecovery = pow( recovery, gamma );\n  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;\n  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;\n  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));\n  gl_FragColor = vec4( clampedHdrColor , 1.0 );\n}\n",uniforms:{sdr:{value:h},gainMap:{value:c},gamma:{value:new s.Vector3(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:(new s.Vector3).fromArray(t)},offsetSdr:{value:(new s.Vector3).fromArray(i)},gainMapMin:{value:(new s.Vector3).fromArray(a)},gainMapMax:{value:(new s.Vector3).fromArray(r)},weightFactor:{value:(Math.log2(o)-n)/(l-n)}},blending:s.NoBlending,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=o,this._hdrCapacityMin=n,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class sn extends Error{}class an extends Error{}const rn=(e,t,s)=>{var i;let a;const r=null===(i=e.attributes.getNamedItem(t))||void 0===i?void 0:i.nodeValue;if(r)a=r;else{const i=e.getElementsByTagName(t)[0];if(!i){if(s)return s;throw new Error(`Can't find ${t} in gainmap metadata`)}{const e=i.getElementsByTagName("rdf:li");if(3!==e.length)throw new Error(`Gainmap metadata contains an array of items for ${t} but its length is not 3`);a=Array.from(e).map((e=>e.innerHTML))}}return a};class on{constructor(e){this.options={debug:!(!e||void 0===e.debug)&&e.debug,extractFII:!e||void 0===e.extractFII||e.extractFII,extractNonFII:!e||void 0===e.extractNonFII||e.extractNonFII}}extract(e){return new Promise(((t,s)=>{const i=this.options.debug,a=new DataView(e.buffer);if(65496!==a.getUint16(0))return void s(new Error("Not a valid jpeg"));const r=a.byteLength;let o,n=2,l=0;for(;n<r;){if(++l>250)return void s(new Error(`Found no marker after ${l} loops 😵`));if(255!==a.getUint8(n))return void s(new Error(`Not a valid marker at offset 0x${n.toString(16)}, found: 0x${a.getUint8(n).toString(16)}`));if(o=a.getUint8(n+1),i&&console.log(`Marker: ${o.toString(16)}`),226===o){i&&console.log("Found APP2 marker (0xffe2)");const e=n+4;if(1297106432===a.getUint32(e)){const i=e+4;let r;if(18761===a.getUint16(i))r=!1;else{if(19789!==a.getUint16(i))return void s(new Error("No valid endianness marker found in TIFF header"));r=!0}if(42!==a.getUint16(i+2,!r))return void s(new Error("Not valid TIFF data! (no 0x002A marker)"));const o=a.getUint32(i+4,!r);if(o<8)return void s(new Error("Not valid TIFF data! (First offset less than 8)"));const n=i+o,l=a.getUint16(n,!r),h=n+2;let c=0;for(let e=h;e<h+12*l;e+=12)45057===a.getUint16(e,!r)&&(c=a.getUint32(e+8,!r));const A=n+2+12*l+4,d=[];for(let e=A;e<A+16*c;e+=16){const t={MPType:a.getUint32(e,!r),size:a.getUint32(e+4,!r),dataOffset:a.getUint32(e+8,!r),dependantImages:a.getUint32(e+12,!r),start:-1,end:-1,isFII:!1};t.dataOffset?(t.start=i+t.dataOffset,t.isFII=!1):(t.start=0,t.isFII=!0),t.end=t.start+t.size,d.push(t)}if(this.options.extractNonFII&&d.length){const e=new Blob([a]),s=[];for(const t of d){if(t.isFII&&!this.options.extractFII)continue;const i=e.slice(t.start,t.end+1,"image/jpeg");s.push(i)}t(s)}}}n+=2+a.getUint16(n+2)}}))}}const nn=async e=>{const t=(e=>{var t,s;let i;i="undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):e.toString();let a=i.indexOf("<x:xmpmeta");const r=new DOMParser;for(;-1!==a;){const e=i.indexOf("x:xmpmeta>",a);i.slice(a,e+10);const o=i.slice(a,e+10);try{const e=r.parseFromString(o,"text/xml").getElementsByTagName("rdf:Description")[0],i=rn(e,"hdrgm:GainMapMin","0"),a=rn(e,"hdrgm:GainMapMax"),n=rn(e,"hdrgm:Gamma","1"),l=rn(e,"hdrgm:OffsetSDR","0.015625"),h=rn(e,"hdrgm:OffsetHDR","0.015625");let c=null===(t=e.attributes.getNamedItem("hdrgm:HDRCapacityMin"))||void 0===t?void 0:t.nodeValue;c||(c="0");const A=null===(s=e.attributes.getNamedItem("hdrgm:HDRCapacityMax"))||void 0===s?void 0:s.nodeValue;if(!A)throw new Error("Incomplete gainmap metadata");return{gainMapMin:Array.isArray(i)?i.map((e=>parseFloat(e))):[parseFloat(i),parseFloat(i),parseFloat(i)],gainMapMax:Array.isArray(a)?a.map((e=>parseFloat(e))):[parseFloat(a),parseFloat(a),parseFloat(a)],gamma:Array.isArray(n)?n.map((e=>parseFloat(e))):[parseFloat(n),parseFloat(n),parseFloat(n)],offsetSdr:Array.isArray(l)?l.map((e=>parseFloat(e))):[parseFloat(l),parseFloat(l),parseFloat(l)],offsetHdr:Array.isArray(h)?h.map((e=>parseFloat(e))):[parseFloat(h),parseFloat(h),parseFloat(h)],hdrCapacityMin:parseFloat(c),hdrCapacityMax:parseFloat(A)}}catch(e){}a=i.indexOf("<x:xmpmeta",e)}})(e);if(!t)throw new an("Gain map XMP metadata not found");const s=new on({extractFII:!0,extractNonFII:!0}),i=await s.extract(e);if(2!==i.length)throw new sn("Gain map recovery image not found");return{sdr:new Uint8Array(await i[0].arrayBuffer()),gainMap:new Uint8Array(await i[1].arrayBuffer()),metadata:t}},ln=e=>new Promise(((t,s)=>{const i=document.createElement("img");i.onload=()=>{t(i)},i.onerror=e=>{s(e)},i.src=URL.createObjectURL(e)}));class hn extends s.Loader{constructor(e,t){super(t),this._renderer=e,this._internalLoadingManager=new s.LoadingManager}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){const e=new tn({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new s.Texture,sdr:new s.Texture});return new un({width:16,height:16,type:s.HalfFloatType,colorSpace:s.LinearSRGBColorSpace,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,i,a){const r=a?new Blob([a],{type:"image/jpeg"}):void 0,o=new Blob([i],{type:"image/jpeg"});let n,l,h=!1;if("undefined"==typeof createImageBitmap){const e=await Promise.all([r?ln(r):Promise.resolve(void 0),ln(o)]);l=e[0],n=e[1],h=!0}else{const e=await Promise.all([r?createImageBitmap(r,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(o,{imageOrientation:"flipY"})]);l=e[0],n=e[1]}const c=new s.Texture(l||new ImageData(2,2),s.UVMapping,s.ClampToEdgeWrapping,s.ClampToEdgeWrapping,s.LinearFilter,s.LinearMipMapLinearFilter,s.RGBAFormat,s.UnsignedByteType,1,s.LinearSRGBColorSpace);c.flipY=h,c.needsUpdate=!0;const A=new s.Texture(n,s.UVMapping,s.ClampToEdgeWrapping,s.ClampToEdgeWrapping,s.LinearFilter,s.LinearMipMapLinearFilter,s.RGBAFormat,s.UnsignedByteType,1,s.SRGBColorSpace);A.flipY=h,A.needsUpdate=!0,e.width=n.width,e.height=n.height,e.material.gainMap=c,e.material.sdr=A,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class cn extends hn{load(e,t,i,a){const r=this.prepareQuadRenderer(),o=new s.FileLoader(this._internalLoadingManager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(this.withCredentials),this.manager.itemStart(e),o.load(e,(async s=>{if("string"==typeof s)throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const i=new Uint8Array(s);let o,n,l;try{const e=await nn(i);o=e.sdr,n=e.gainMap,l=e.metadata}catch(t){if(!(t instanceof an||t instanceof sn))throw t;console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),l={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},o=i}try{await this.render(r,l,o,n)}catch(t){return this.manager.itemError(e),"function"==typeof a&&a(t),void r.disposeOnDemandRenderer()}"function"==typeof t&&t(r),this.manager.itemEnd(e),r.disposeOnDemandRenderer()}),i,(t=>{this.manager.itemError(e),"function"==typeof a&&a(t)})),r}}const An=(e,t,i)=>{let a;switch(e){case s.UnsignedByteType:a=new Uint8ClampedArray(t*i*4);break;case s.HalfFloatType:a=new Uint16Array(t*i*4);break;case s.UnsignedIntType:a=new Uint32Array(t*i*4);break;case s.ByteType:a=new Int8Array(t*i*4);break;case s.ShortType:a=new Int16Array(t*i*4);break;case s.IntType:a=new Int32Array(t*i*4);break;case s.FloatType:a=new Float32Array(t*i*4);break;default:throw new Error("Unsupported data type")}return a};let dn;class un{constructor(e){var t,i,a,r,o,n,l,h,c,A,d,u,p,m,g,f;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(e){throw this._renderer.setRenderTarget(null),e}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const b={format:s.RGBAFormat,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:void 0!==(null===(t=e.renderTargetOptions)||void 0===t?void 0:t.anisotropy)?null===(i=e.renderTargetOptions)||void 0===i?void 0:i.anisotropy:1,generateMipmaps:void 0!==(null===(a=e.renderTargetOptions)||void 0===a?void 0:a.generateMipmaps)&&(null===(r=e.renderTargetOptions)||void 0===r?void 0:r.generateMipmaps),magFilter:void 0!==(null===(o=e.renderTargetOptions)||void 0===o?void 0:o.magFilter)?null===(n=e.renderTargetOptions)||void 0===n?void 0:n.magFilter:s.LinearFilter,minFilter:void 0!==(null===(l=e.renderTargetOptions)||void 0===l?void 0:l.minFilter)?null===(h=e.renderTargetOptions)||void 0===h?void 0:h.minFilter:s.LinearFilter,samples:void 0!==(null===(c=e.renderTargetOptions)||void 0===c?void 0:c.samples)?null===(A=e.renderTargetOptions)||void 0===A?void 0:A.samples:void 0,wrapS:void 0!==(null===(d=e.renderTargetOptions)||void 0===d?void 0:d.wrapS)?null===(u=e.renderTargetOptions)||void 0===u?void 0:u.wrapS:s.ClampToEdgeWrapping,wrapT:void 0!==(null===(p=e.renderTargetOptions)||void 0===p?void 0:p.wrapT)?null===(m=e.renderTargetOptions)||void 0===m?void 0:m.wrapT:s.ClampToEdgeWrapping};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=un.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new s.Scene,this._camera=new s.OrthographicCamera,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!((e,t,i,a)=>{if(void 0!==dn)return dn;const r=new s.WebGLRenderTarget(1,1,a);t.setRenderTarget(r);const o=new s.Mesh(new s.PlaneGeometry,new s.MeshBasicMaterial({color:16777215}));t.render(o,i),t.setRenderTarget(null);const n=An(e,r.width,r.height);return t.readRenderTargetPixels(r,0,0,r.width,r.height,n),r.dispose(),o.geometry.dispose(),o.material.dispose(),dn=0!==n[0],dn})(this._type,this._renderer,this._camera,b)){let e;if(this._type===s.HalfFloatType)e=this._renderer.extensions.has("EXT_color_buffer_float")?s.FloatType:void 0;void 0!==e?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${s.FloatType}`),this._type=e):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new s.Mesh(new s.PlaneGeometry,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new s.WebGLRenderTarget(this.width,this.height,b),this._renderTarget.texture.mapping=void 0!==(null===(g=e.renderTargetOptions)||void 0===g?void 0:g.mapping)?null===(f=e.renderTargetOptions)||void 0===f?void 0:f.mapping:s.UVMapping}static instantiateRenderer(){const e=new s.WebGLRenderer;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=An(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new s.DataTexture(this.toArray(),this.width,this.height,s.RGBAFormat,this._type,(null==e?void 0:e.mapping)||s.UVMapping,(null==e?void 0:e.wrapS)||s.ClampToEdgeWrapping,(null==e?void 0:e.wrapT)||s.ClampToEdgeWrapping,(null==e?void 0:e.magFilter)||s.LinearFilter,(null==e?void 0:e.minFilter)||s.LinearFilter,(null==e?void 0:e.anisotropy)||1,s.LinearSRGBColorSpace);return t.generateMipmaps=void 0!==(null==e?void 0:e.generateMipmaps)&&(null==e?void 0:e.generateMipmaps),t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof s.ShaderMaterial&&Object.values(this.material.uniforms).forEach((e=>{e.value instanceof s.Texture&&e.value.dispose()})),Object.values(this.material).forEach((e=>{e instanceof s.Texture&&e.dispose()})),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}const pn={sunPosition:new s.Vector3(.27,1,.5),sunTop:new s.Vector3(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new s.Color(16777209).multiplyScalar(1),skyColor:new s.Color(4348022),fogColor:new s.Color(11253184),groundColor:new s.Color(8421504),sunColor:new s.Color(16777215).multiplyScalar(3)},mn={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:pn.sunPosition},sunTop:{value:pn.sunTop},noiseMap:{value:pn.noiseMap},mixRatio:{value:pn.mixRatio},cloud_size:{value:pn.cloud_size},cloud_covr:{value:pn.cloud_covr},cloud_dens:{value:pn.cloud_dens},cloud_dist:{value:pn.cloud_dist},nightLuminosity:{value:pn.nightLuminosity},haze:{value:pn.haze},saturation:{value:pn.saturation},SAMPLE:{value:pn.SAMPLE},STEP:{value:pn.STEP},fogy:{value:pn.fogy},t:{value:1},fogColor:{value:pn.fogColor},groundColor:{value:pn.groundColor},cloudColor:{value:pn.cloudColor},skyColor:{value:pn.skyColor},sunColor:{value:pn.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},gn=Math.PI/180;let fn=class{constructor(e={}){this.mainScene=e.scene,this.renderer=e.renderer,this.usePrem=void 0!==e.usePmrem&&e.usePmrem,this.useBackground=void 0===e.useBackground||e.useBackground,this.envBlur=void 0!==e.envBlur?e.envBlur:0,this.callback=e.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new s.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader()),e.cube&&this.initCubeEnv(e),e.url&&this.load(e.url)}initCubeEnv(e={}){this.isCubeEnv=!0,this._quality=e.quality||1,this.scene=new s.Scene,e.color&&(this.scene.background=new s.Color(e.color)),this.target=new s.WebGLCubeRenderTarget(256*this._quality,{minFilter:s.LinearFilter,type:s.HalfFloatType,colorSpace:s.SRGBColorSpace,anisotropy:1}),this.camera=new s.CubeCamera(e.near||.1,e.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let e=new s.IcosahedronGeometry(20,1);const t=new s.ShaderMaterial(mn);this.sky=new s.Mesh(e,t),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return pn}setSkyOtion(e){if(!this.isSky)return;let t=this.sky.material.uniforms;for(let s in e)t[s]&&(t[s].value=e[s]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const e=this.renderer,t=e.toneMapping;e.toneMapping=s.NoToneMapping,this.camera.update(e,this.scene),e.toneMapping=t}load(e){switch(this.name=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),this.type=e.substring(e.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new Ba).load(e,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new Ea).load(e,this.end.bind(this),null,this.bug.bind(this));break;case"jpg":this.loader=new cn(this.renderer).load(e,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let e;switch(this.type){case"hdr":case"exr":e=this.loader,e.mapping=s.EquirectangularReflectionMapping;break;case"jpg":e=this.loader.renderTarget.texture,e.mapping=s.EquirectangularReflectionMapping}this.usePrem&&(e=this.pmremGenerator.fromEquirectangular(e).texture,this.pmremGenerator.dispose()),e.needsUpdate=!0;const t=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(t.background=e),this.envBlur&&(t.backgroundBlurriness=this.envBlur),t.environment=e,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(e){this.mainScene.environmentIntensity=e}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(e){this.mainScene.backgroundIntensity=e}get blur(){return this.mainScene.backgroundBlurriness}set blur(e){this.mainScene.backgroundBlurriness=e}rotate(e=0,t=0,s=0){0!==e&&(e*=gn),0!==t&&(t*=gn),0!==s&&(s*=gn),this.mainScene.environmentRotation.set(e,t,s),this.mainScene.backgroundRotation.set(e,t,s)}},bn=class{constructor(e={}){this.id=0,this.type="autoRagdoll",this.name=e.name||this.type+this.id++;let t=E.byName(this.name);t&&E.remove(t),this._mode=e.mode||"follow",this._size=e.size||1,this._debug=e.debug||!1;const s=hs(e.model);let i;s.scale.set(1,1,1).multiplyScalar(this._size),e.pos&&s.position.fromArray(e.pos),s.raycast=function(){},s.name=this.name,s.traverse((t=>{t.isMesh&&(t.frustumCulled=!1),t.isSkinnedMesh&&(t.raycast=function(){},t.frustumCulled=!1,t.matrixAutoUpdate=!1,t.receiveShadow=!0,t.castShadow=!0,e.material&&(t.material=e.material),t.skeleton.resetScalling(),i=t.skeleton.bones)}));let a=e.mass||null;return this.skeletonBody=new ut(s.name,s,i,a,e.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),B.scene.add(s),this.model=s,E.add(this),this}getRealPosition(){return E.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(e){this._size=e,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(e){this._debug=e,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(e){this._mode=e,this.skeletonBody.setMode(this._mode)}};const yn=new s.Matrix4,wn=new s.Matrix4;new s.Vector3;let vn=s.Skeleton.prototype;vn.byName=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return this.bones[t];return null},vn.getId=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return t;return null},vn.setExtraRotation=function(e,t,i,a){(e.isBone?e:this.byName(e))&&s.MathUtils.DEG2RAD},vn.setScalling=function(e,t,i,a){let r=e.isBone?e:this.byName(e);r&&(r.scalling=new s.Vector3(t,i,a))},vn.resetScalling=function(e){this.pose(),this.scalled=!0;for(let e=0,t=this.bones.length;e<t;e++)this.bones[e].isPhysics=!1,this.bones[e].phyMtx=new s.Matrix4;e||this.applyScalling()},vn.childScale=function(e,t){if(!this.scalled)return;e.scalling&&t.scale(e.scalling);let s,i=e.children.length,a=0;for(;i--;)s=e.children[a],a++,s.isBone,s.matrixWorld.multiplyMatrices(t,s.matrix)},vn.applyScalling=function(e){let t,s,i,a=this.bones.length;for(s=0;s<a;s++)t=this.bones[s],i=t.parent||null,null!==i&&i.scalling&&"root"!==t.name&&(t.position.multiply(i.scalling),t.updateMatrixWorld(!0));this.calculateInverses()},vn.update=function(){const e=this.bones,t=this.boneInverses,s=this.boneMatrices,i=this.boneTexture;let a,r=e.length,o=0;for(;r--;){a=e[o];const i=a?a.isPhysics?a.phyMtx:a.matrixWorld:wn;this.childScale(a,i),yn.multiplyMatrices(i,t[o]),yn.toArray(s,16*o),o++}null!==i&&(i.needsUpdate=!0)};const Cn={PHY:"0.2.9",PHYSX:"5.06.00",HAVOK:"1.2.1",JOLT:"0.33.0",RAPIER:"0.14.0",OIMO:"1.2.4",AMMO:"3.2.6"},In={};let xn=null,Bn=null,En=null,Mn=!1,Sn=!1,kn=!1,Qn=!0,Rn=!1,Tn=null,Fn=!1,Dn={t1:0,t2:0,t3:0,t4:0},Ln=null,Pn=null,_n=null,Gn=!1,zn=!0,Un=null,On=null,Nn=0,Vn=0,qn="",Hn=null,jn=null,Wn=null;const Kn=new class{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new ie(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}setKey(e,t){this.key[e]=t}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,s[0]=1;break;case 68:case 39:t[0]=1,s[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,s[0]=1;break;case 68:t[0]=1,s[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,s[0]=1;break;case 39:t[2]=1,s[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],s[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],s[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}}},Jn=new se(60),Yn={start:0,end:0,startTime:""};let Xn=()=>0,Zn=()=>{},$n=()=>{},el=()=>{},tl=[],sl=[],il=[];const al={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};class rl{static math=A;static pool=wr;static RayCar=Bo;static version=Cn.PHY;static Version=Cn;static set onStep(e){$n=e}static debugMode(e){rl.setDebugMode(e)}static setDebugMode(e){B.debug=e}static useRealLight(e){ee.useRealLight(e)}static getSetting(){return al}static getRoot(){return B}static setGravity(e){e&&(al.gravity=e),B.post({m:"setGravity",o:{gravity:al.gravity}})}static set(e={}){al.fixe=void 0===e.fixe||e.fixe,al.full=void 0!==e.full&&e.full,al.gravity=e.gravity?e.gravity:[0,-9.81,0],al.substep=e.substep?e.substep:2,al.fps=e.fps?e.fps:60,e.key&&el(),In.body.setFull(al.full),rl.initArray(al.full),Vn=0,kn=Mn,Qn=!kn,B.jointVisible=e.jointVisible||!1,Qn&&Jn.setFramerate(al.fps);const t={...al,ArPos:B.ArPos,isTimeout:kn,outsideStep:Qn};B.post({m:"set",o:t})}static activeMouse(e,t){Ln||(Ln=new so(e,t))}static mouseMode(e,t){Ln&&Ln.setMode(e,t)}static getTime(){return se.now()}static readTime(e){return se.format_time(e)}static startTime(){return Yn.startTime}static getTimeTest(){return Dn}static setMaxFps(e){}static getMouse(){return Ln?Ln.mouse:null}static setMaxAnisotropy(e){wr.maxAnisotropy=e}static setAddControl(e){el=e}static setPrevUpdate(e){}static setPostUpdate(e){$n=null!==e?e:()=>{}}static setAzimut(e){Xn=e}static setRenderer(e){jn=e,wr.renderer=jn}static setKey(e,t){return Kn.setKey(e,t)}static getKey(){return Kn.key}static getKey2(){return Kn.key2}static getAzimut(){return Xn()}static setContent(e){Fn||(Wn=e,Wn.add(B.scene),Wn.add(B.scenePlus),Fn=!0)}static message=e=>{let t=e.data;t.Ar&&(B.Ar=t.Ar),t.reflow&&(B.reflow=t.reflow,B.reflow.stat.delta&&(Vn+=B.reflow.stat.delta)),rl[t.m](t.o)};static post=(e,t=null,s=!1)=>{Mn?(e.o&&("solver"===e.o.type&&(s=!0),void 0!==e.o.solver&&(s=!0)),s?En.postMessage(e,t):"add"===e.m?B.flow.add.push(e.o):"remove"===e.m?B.flow.remove.push(e.o):En.postMessage(e,t)):Pn({data:e})};static autoRagdoll=e=>new bn(e);static byName=e=>E.byName(e);static getScene=()=>B.scene;static makeView(){}static resize(e){B.viewSize=e}static init(e={}){"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,Yn.start=se.now();const t=e.compact||!1;let i=document.location.href.replace(/\/[^/]*$/,"/"),a=i.split("/");i=a[0]+"//"+a[2]+"/","https://lo-th.github.io/"===i&&(i="https://lo-th.github.io/phy/");let r=e.path||"";r+=t?"compact/":"build/";let o=e.type||"PHYSX",n=o.toLowerCase(),l=n.charAt(0).toUpperCase()+n.slice(1);if(B.engine=o,rl.initItems(),wr.materialRoot=ee.set,ee.initExtandShader(),e.callback&&(Bn=e.callback,delete e.callback),Mn=e.worker||!1,B.scene=new s.Group,B.scene.name="phy_scene",B.scenePlus=new s.Group,B.scenePlus.name="phy_scenePlus",e.scene&&(rl.setContent(e.scene),delete e.scene),e.renderer&&(rl.setRenderer(e.renderer),delete e.renderer),qn=e.envmap||"",B.post=rl.post,B.motor=rl,t)wr.load(i+r+l+".hex",(function(){rl.onCompactDone(e)}));else if(Mn){En=new Worker(i+r+l+".min.js"),En.postMessage=En.webkitPostMessage||En.postMessage,En.onmessage=rl.message;let t=new ArrayBuffer(1);En.postMessage({m:"test",ab:t},[t]),Sn=!t.byteLength,e.isBuffer=Sn,rl.initPhysics(e)}else e.devMode?rl.preLoad(l,e,i):rl.preLoadMin(l,e,i)}static onCompactDone(e){let t=B.engine.toLowerCase(),s=t.charAt(0).toUpperCase()+t.slice(1),i=wr.get(s,"H");if(Mn){let t;try{t=new Blob([i],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,t=new BlobBuilder,t.append(i),t=t.getBlob()}En=new Worker(URL.createObjectURL(t)),En.postMessage=En.webkitPostMessage||En.postMessage,En.onmessage=rl.message;let s=new ArrayBuffer(1);En.postMessage({m:"test",ab:s},[s]),Sn=!s.byteLength,e.isBuffer=Sn,rl.initPhysics(e)}else{let s=t.toUpperCase();"RAPIER"===s&&(s="RAPIER3D");let a=document.createElement("script");a.language="javascript",a.type="text/javascript",a.charset="utf-8",a.async=!0,a.innerHTML=i,document.getElementsByTagName("head")[0].appendChild(a),Pn=window[s].engine.message,e.message=rl.message,rl.initPhysics(e)}}static loadWasmDirect(e,t,s,i){let a=document.createElement("script");a.src=i+e,document.body.appendChild(a),a.onload=()=>{rl.preLoad(s,t,i)}}static preLoadMin(e,t,s){let i=s+"build/"+e+".min.js",a=e.toUpperCase();"RAPIER"===a&&(a="RAPIER3D");var r=new XMLHttpRequest;r.open("GET",i),r.overrideMimeType("text/javascript"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status){let e=document.createElement("script");e.language="javascript",e.type="text/javascript",e.charset="utf-8",e.async=!0,e.innerHTML=r.responseText,document.getElementsByTagName("head")[0].appendChild(e),Pn=window[a].engine.message,t.message=rl.message,rl.initPhysics(t)}else console.error("Couldn't load ["+e+"] ["+r.status+"]")}.bind(this),r.send(null)}static async preLoad(e,t,s){let i=s+"build/"+e+".module.js";t.devMode&&(i=s+"src/"+e+".js");let a=await import(i);Pn=a.engine.message,t.message=rl.message,rl.initPhysics(t)}static initPhysics(e){""===qn?(B.post({m:"init",o:e}),Rn=!0):rl.preloadEnvmap(e)}static addEnvmap(e){return Hn||(Hn=new fn({renderer:jn,scene:Wn,...e})),Hn}static preloadEnvmap(e){Hn=new fn({url:qn,renderer:jn,scene:Wn,usePmrem:e.usePmrem,useBackground:void 0===e.useBackground||e.useBackground,envBlur:void 0!==e.envBlur?e.envBlur:0,callback:()=>{qn="",rl.initPhysics(e)}})}static getPause(){return Gn}static pause(e){e!==Gn&&(Gn=e,Gn?rl.pausetimout():rl.playtimout(),B.post({m:"pause",o:{value:Gn}}))}static flowReset(){B.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}}static reset(e){if(zn)return zn=!1,void e();tl=[],xn=null,_n&&_n.resetAll(),Ln&&Ln.unSelect(),Zn=e,$n=function(){},rl.clearText(),rl.clearParticleSolver(),rl.cleartimout(),rl.flowReset(),rl.clearInstance(),rl.resetItems(),F(),ee.dispose(),B.disposeTmp(),B.garbage=[],null!==Tn&&(Tn=null),B.tmpTex=[],B.scenePlus.children=[],B.scene.children=[],B.post({m:"reset"})}static clearGarbage(){rl.remove(B.garbage),rl.clearInstance(),B.garbage=[]}static clear(e){rl.reset(e)}static resetCallback(){Zn()}static dispose(){rl.reset((()=>{En&&(En.terminate(),En=null),Fn&&(B.scene.parent.remove(B.scene),B.scenePlus.parent.remove(B.scenePlus),Fn=!1)}))}static ready(){Yn.end=se.now(),Yn.startTime=se.format_time(Yn.end-Yn.start),console.log("%c"+B.engine+" %c"+Cn[B.engine]+"%c | "+(Mn?"Worker":"Direct")+" "+Yn.startTime,"font-size:16px","font-size:12px","font-size:12px"),Bn&&Bn()}static start(e={}){B.post({m:"start",o:e})}static morph(e,t,s){E.morph(e,t,s)}static getFps(){return B.reflow.stat.fps}static getDelta2(){return B.delta}static getElapsedTime2(){return Vn}static setDelta(e){Jn.delta=e}static getDelta(){return Jn.delta}static getElapsedTime(){return Jn.elapsedTime}static doStep(e){Rn&&Qn&&Jn.up(e)&&B.post({m:"step",o:e})}static step(){B.delta=B.reflow.stat.delta,B.flow.key=Kn.update(),B.flow.current=null!==xn?xn.name:"",rl.stepItems(),null!==Tn&&Tn.step(),null!==xn&&xn.move(),Ln&&Ln.step();let e=Qn?Jn.delta:B.delta;$n(e),rl.changes(B.flow.tmp),Sn?B.post({m:"poststep",flow:B.flow,Ar:B.Ar},[B.Ar.buffer]):B.post({m:"poststep",flow:B.flow}),rl.flowReset()}static initArray(e=!1){B.ArPos=C(B.engine,e)}static takeControl(e=null){rl.control(e)}static control(e=null){null!==xn?null===e?(xn.isPlayer&&(xn.isPlayer=!1),xn=null):e!==xn.name&&(xn=rl.byName(e),xn&&(xn.isPlayer=!0)):null!==e&&(xn=rl.byName(e),xn&&(xn.isPlayer=!0))}static getAllBody(e){return In.body.list}static initItems(){In.body=new je,In.ray=new re,In.joint=new Xe,In.solid=new ol,In.contact=new Ze,In.terrain=new Hr,In.character=new Ur,"PHYSX"!==B.engine&&"AMMO"!==B.engine||(In.vehicle=new et),"PHYSX"===B.engine&&(In.solver=new Wr),B.items=In}static getBodyRef(){return In.body}static clearBody(){In.body.reset()}static resetItems(){Object.values(In).forEach((e=>e.reset()))}static stepItems(){Object.values(In).forEach((e=>e.step())),rl.upInstance(),rl.upButton()}static upInstance(){Object.values(B.instanceMesh).forEach((e=>e.update()))}static clearInstance(){Object.values(B.instanceMesh).forEach((e=>e.dispose())),B.instanceMesh={}}static adds(e=[],t=!1){let s=e.length,i=0;for(;s--;)rl.add(e[i++],t)}static add(e={},t=!1){if(e.isObject3D)return rl.addDirect(e);if(e.constructor===Array)return rl.adds(e,t);if("container"===e.type)return new to(e);void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box"),void 0!==e.mode&&(e.type="joint");let s=I(e);"joint"===s&&void 0===e.mode&&(e.mode=e.type,e.type="joint");let i=In[s].add(e);return B.garbage.push(i.name),i}static addDirect(e){return B.scenePlus.add(e),B.tmpMesh.push(e),e}static removes(e=[],t){let s=e.length,i=0;for(;s--;)rl.remove(e[i++],t)}static remove(e,t=!1){if(e.constructor===Array)return rl.removes(e,t);let s=rl.byName(e);null!==s?"autoRagdoll"!==s.type?(s.extraRemove&&s.extraRemove(),In[s.type].clear(s),B.post({m:"remove",o:{name:e,type:s.type}},null,t)):E.remove(s):B.instanceMesh[e]&&In.body.clearInstance(e)}static changes(e=[],t=!1){let s=e.length,i=0;for(;s--;)rl.changeOne(e[i++],t)}static change(e,t=!1){t?e instanceof Array?rl.changes(e,!0):rl.changeOne(e,!0):e instanceof Array?B.flow.tmp.push(...e):B.flow.tmp.push(e)}static changeOne(e={},t=!1){if(e.heightData)return;let s=rl.byName(e.name);if(null===s)return null;let i=s.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=A.quatFromEuler(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=A.toLocalQuatArray(e.localRot,s),delete e.localRot),i){case"terrain":s=In.terrain.set(e,s),t=!1;break;case"ray":s=In.ray.set(e,s),t=!1;break;case"character":s=In.character.set(e,s);break;case"solid":s=In.solid.set(e,s);break;case"joint":s=In.joint.set(e,s);break;case"body":s.isKinematic&&In.body.set(e,s),s.actif&&!s.sleep||In.body.set(e,s),e.sleep&&In.body.set(e,s)}t&&B.post({m:"change",o:e},null,t)}static setControl(e){_n=e,Xn=_n.getAzimuthalAngle}static getCurrentCharacterPosition(){return _n.followGroup.position}static getCamera(e={}){return _n.object}static setCamera(e={}){_n.moveCam(e)}static follow(e="",t={}){let s=null;"string"==typeof e||e instanceof String?s=""===e?null:rl.byName(e):e.isObject3D&&(s=e),null===s?_n.resetFollow():_n.startFollow(s,t)}static setTimeout(e,t=0,s=!1){s?Un=setTimeout(e,t):(On=e,Nn=t,Un=setTimeout(On,Nn))}static playtimout(){null!==On&&(Un=setTimeout(On,Nn))}static pausetimout(){null!==Un&&clearTimeout(Un)}static cleartimout(e,t){null!==Un&&(On=null,Nn=0,clearTimeout(Un),Un=null)}static texture=(e={})=>wr.texture(e);static getTexture=(e,t={})=>wr.getTexture(e,t);static setExtendShader(e){ee.extendShader=e}static addMaterial(e,t){ee.set(e,t)}static directIntensity(e){ee.directIntensity(e)}static setEnvmapIntensity(e){ee.setEnvmapIntensity(e)}static getMatRef=()=>ee;static getMat=e=>ee.get(e);static getMaterial=e=>ee.get(e);static getMaterialList=()=>ee.getList();static material=(e={})=>ee.create(e);static changeRenderMode=e=>ee.changeRenderMode(e);static load=wr.load;static get=wr.get;static getGroup=wr.getGroup;static getScript=wr.getScript;static preload(e,t){_r.add(e,t)}static async loadAsync(e,t="",s=""){await wr.loadAsync(e,t,s)}static applyMorph(e,t=null,s=!0,i=!0){wr.applyMorph(e,null,!0,!0)}static getMesh(e,t,s){if(t){let t=wr.getMaterials(e);for(let e in t)rl.addMaterial(t[e])}return wr.getMesh(e,s)}static getGlb(e,t,s){if(t){let t=wr.getMaterials(e);for(let e in t)rl.addMaterial(t[e])}return wr.getGLB(e,s)}static getGlbMaterial(e){let t=wr.getMaterials(e);return ee.addToMat(t),t}static poolDispose(){return wr.dispose()}static setDracoPath(e){return wr.dracoPath=e}static initParticle(){}static addParticle(){}static getParticle(){}static addParticleSolver(e){let t=new uo(e);return il.push(t),t}static updateParticleSolver(){let e=il.length;for(;e--;)il[e].update()}static clearParticleSolver(){il.length,il=[]}static addButton(e){let t=new Zr(e);return tl.push(t),t}static upButton(e){for(const e in tl)tl[e].update()}static addText(e){let t=new Yr(e);return e.parent?e.parent.add(t):B.scenePlus.add(t),sl.push(t),t}static clearText(){let e=sl.length;for(;e--;)sl[e].dispose();sl=[]}static screenshot(){var e=window.open("","");e.document.title="Screenshot",e.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var t=new Image;jn.render(Wn,rl.getCamera()),t.src=jn.domElement.toDataURL(),e.document.body.appendChild(t)}static addBreaker(){null===Tn&&(Tn=new oo)}static explosion(e=[0,0,0],t=10,i=1){let a=[],r=new s.Vector3;e&&(e.isVector3?r.copy(e):r.fromArray(e));let o,n,l=new s.Vector3,h=In.body.list.length;for(;h--;)o=In.body.list[h],l.copy(o.position).sub(r),n=1-l.length()/t,o.isKinematic||n<0||(l.setLength(n),l.multiplyScalar(i),a.push({name:o.name,impulse:l.toArray(),wake:!0}));rl.change(a)}}let ol=class extends je{constructor(){super(),this.type="solid"}step(){}},nl=class{constructor(){this.geoN=0,this.geo={}}unic(e){this.geo["geo"+this.geoN++]=e}set(e){this.geo[e.name]=e}get(e,t={}){if(!this.geo[e]){let t;switch(e){case"plane":t=new s.PlaneGeometry(1,1),t.rotateX(.5*-Math.PI);break;case"box":t=new s.BoxGeometry(1,1,1);break;case"sphere":t=new s.SphereGeometry(1,16,12);break;case"cylinder":t=new s.CylinderGeometry(1,1,1,16);break;case"cone":t=new s.CylinderGeometry(.001,1,1,16);break;case"particle":t=new s.SphereGeometry(1,8,6);break;case"joint":t=(new M).geometry;break;default:return null}this.geo[e]=t}return this.geo[e]}dispose(){for(let e in this.geo)this.geo[e].isBufferGeometry?this.geo[e].dispose():console.log(this.geo[e]);this.geo={},this.geoN=0}};const ll={metalness:.1,roughness:.9},hl={enableESL:!0,exposure:1,envMapIntensity:1,aoColor:new s.Color(0),hemisphereColor:new s.Color(16777215),irradianceColor:new s.Color(16777215),radianceColor:new s.Color(16777215),aoPower:9.7,aoSmoothing:.26,aoMapGamma:.89,lightMapGamma:.9,lightMapSaturation:1,envPower:1,roughnessPower:1,sunIntensity:0,mapContrast:1,lightMapContrast:1.03,smoothingPower:.76,irradianceIntensity:6.59,radianceIntensity:4.62,hardcodeValues:!1},cl={body:new s.Color("hsl(45, 15%, 90%)"),sleep:new s.Color("hsl(33, 15%, 54%)"),solid:new s.Color(7105128),base:new s.Color(13224135),black:new s.Color("hsl(220, 8%, 15%)"),gold:new s.Color(.944,.776,.373),gold2:new s.Color(.998,.981,.751),copper:new s.Color(.96467984,.37626296,.25818297),carPaint:new s.Color(.1037792,.59212029,.85064936),clay:new s.Color("hsl(12, 30%, 40%)"),concrete:new s.Color(11119017),Raw_Fire:new s.Color("hsl(40, 18%, 54%)"),Raw_Buff:new s.Color("hsl(33, 15%, 54%)"),Raw_Terracotta:new s.Color("hsl(12, 30%, 40%)"),Raw_Porcelain:new s.Color("hsl(45, 15%, 90%)")},Al={No:s.NoBlending,Normal:s.NormalBlending,Additive:s.AdditiveBlending,Subtractive:s.SubtractiveBlending,Multiply:s.MultiplyBlending,Eadd:s.AddEquation,Esub:s.SubtractEquation,Erev:s.ReverseSubtractEquation,Emin:s.MinEquation,Emaw:s.MaxEquation,Fzero:s.ZeroFactor,Fone:s.OneFactor,Fcolor:s.SrcColorFactor,Fcolorm:s.OneMinusSrcColorFactor,Falpha:s.SrcAlphaFactor,Falpham:s.OneMinusSrcAlphaFactor,Fdstalpha:s.DstAlphaFactor,Fdstalpham:s.OneMinusDstAlphaFactor,Fdstcolor:s.DstColorFactor,Fdstcolorm:s.OneMinusDstColorFactor,Falphasaturate:s.SrcAlphaSaturateFactor,Front:s.FrontSide,Back:s.BackSide,Double:s.DoubleSide};let dl=class e{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(e){this.renderMode.value=e}initExtandShader(){}useRealLight(e){this.isRealism=!0;for(let t in e)-1!==t.search("Color")&&(e[t].isColor||(hl[t].set(e[t]),delete e[t]));this.realismOption={...hl,...e}}setColor(e){this.isRealism&&(hl.aoColor.set(e.minLuma).convertLinearToSRGB(),hl.hemisphereColor.set(e.maxLuma).convertLinearToSRGB(),hl.irradianceColor.set(e.sun).convertLinearToSRGB(),hl.radianceColor.set(e.vibrant).convertLinearToSRGB())}set(e,t,s=null){s||(s=e.onBeforeCompile),t||this.extendShader(e,s),this.mat[e.name]=e}extendShader(t,s=null){this.isRealism?t.onBeforeCompile=function(i){i.uniforms.renderMode=e.renderMode,i.uniforms.depthPacking=e.depthPacking,j(i,e.realismOption),t.userData.isRealism=!0,t.userData.shader=i,s&&s(i)}:t.onBeforeCompile=function(i){i.uniforms.renderMode=e.renderMode,i.uniforms.depthPacking=e.depthPacking,s&&s(i),t.userData.shader=i}}addToTmp(e){this.TmpMat.push(e)}create(t){let i,a=null;if(t.isMaterial)i=t;else{let r=void 0!==t.type?t.type:"Standard";switch(t.type&&delete t.type,a=t.beforeCompile||null,t.beforeCompile&&delete t.beforeCompile,(t.thickness||t.sheen||t.clearcoat||t.transmission||t.specularColor)&&(r="Physical"),t.normalScale&&(t.normalScale.isVector2||(t.normalScale=(new s.Vector2).fromArray(t.normalScale))),t.side&&(t.side=e.findValue(t.side)),t.shadowSide&&(t.shadowSide=e.findValue(t.shadowSide)),t.blending&&(t.blending=e.findValue(t.blending)),t.blendEquation&&(t.blendEquation=e.findValue(t.blendEquation)),t.blendEquationAlpha&&(t.blendEquationAlpha=e.findValue(t.blendEquationAlpha)),t.blendSrc&&(t.blendSrc=e.findValue(t.blendSrc)),t.blendDst&&(t.blendDst=e.findValue(t.blendDst)),t.blendDstAlpha&&(t.blendDstAlpha=e.findValue(t.blendDstAlpha)),t.blendSrcAlpha&&(t.blendSrcAlpha=e.findValue(t.blendSrcAlpha)),t.clearcoatNormalScale&&(t.clearcoatNormalScale.isVector2||(t.clearcoatNormalScale=(new s.Vector2).fromArray(t.clearcoatNormalScale))),r=r.toLowerCase(),r){case"physical":i=new s.MeshPhysicalMaterial(t),i.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":i=new s.MeshPhongMaterial(t);break;case"lambert":i=new s.MeshLambertMaterial(t);break;case"basic":i=new s.MeshBasicMaterial(t);break;case"line":i=new s.LineBasicMaterial(t);break;case"toon":i=new s.MeshToonMaterial(t);break;case"shadow":i=new s.ShadowMaterial(t);break;case"sss":i=new L(t);break;default:i=new s.MeshStandardMaterial(t)}}return this.mat[i.name]?null:(this.set(i,!1,a),i)}findValue(e){return"string"===e?Al[e.charAt(0).toUpperCase()+e.slice(1)]:e}addToMat(t){if(this.isRealism)for(let i in t)t[i].shadowSide=s.DoubleSide,t[i].onBeforeCompile=function(s){j(s,e.realismOption),t[i].userData.isRealism=!0,t[i].userData.shader=s};this.mat={...this.mat,...t}}changeType(){}directIntensity(e){for(let e in this.mat);}getList(){let e={...this.mat};const t=["line","debug","hide","svg"];let s=t.length;for(;s--;)delete e[t[s]];return e}get(e){if(!this.mat[e])switch(e){case"body":this.create({name:"body",color:cl.body,...ll});break;case"sleep":this.create({name:"sleep",color:cl.sleep,...ll});break;case"solid":this.create({name:"solid",color:cl.solid,...ll});break;case"base":this.create({name:"base",color:cl.base,...ll});break;case"clay":this.create({name:"clay",color:cl.clay,...ll});break;case"concrete":this.create({name:"concrete",color:cl.concrete,metalness:0,roughness:.9});break;case"black":this.create({name:"black",color:cl.black,metalness:0,roughness:.25});break;case"chrome":this.create({name:"chrome",color:13421772,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:cl.gold,specularColor:cl.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:cl.copper,metalness:1,roughness:.25,clearcoat:1,clearcoatRoughness:.2});break;case"carPaint":this.create({name:"carPaint",color:cl.carPaint,metalness:0,anisotropy:new s.Vector2(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new D,normalMap:new D(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...ll});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:s.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:15658734,transparent:!1,opacity:1,roughness:.03,metalness:0,side:s.DoubleSide,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.02,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0});break;case"plexi":this.create({name:"plexi",blending:s.AdditiveBlending,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:s.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:s.AdditiveBlending,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:s.DoubleSide,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.mat.outline||(this.mat.outline=new W),this.mat.outline;break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...ll});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:65280});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:s.DoubleSide})}return this.mat[e]}dispose(){e.isRealism=!1;for(let e in this.mat)this.mat[e].dispose(),delete this.mat[e];let t=this.TmpMat.length;for(;t--;)this.TmpMat[t].dispose();this.TmpMat=[]}upShader(){let e=this.realismOption;for(let t in this.mat){const s=this.mat[t],i=s.userData.shader;for(let t in e)i&&void 0!==i.uniforms[t]&&(i.uniforms[t].value=e[t]),s[t]&&(s[t]=e[t])}}};class ul{constructor(e=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(e),this.force=!1}up(e){let t=this.time;return this.unlimited&&(this.force=!0),t.now=void 0!==e?e:this.now(),t.delta=t.now-t.then,this.force&&(t.delta=t.interval,this.force=!1),!!(t.delta>=t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.interval,this.elapsedTime+=this.delta,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e,60===e&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(e){return e>1e3?e/1e3+" sec":e+" ms"}}class pl{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new ml(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}setKey(e,t){this.key[e]=t}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,s[0]=1;break;case 68:case 39:t[0]=1,s[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,s[0]=1;break;case 68:t[0]=1,s[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,s[0]=1;break;case 39:t[2]=1,s[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],s[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],s[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}}}class ml{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,s,i,a,r,o=this.fix,n=navigator.getGamepads();for(e=0;e<n.length;e++)if(r=n[e])if(s=r.axes.length,i=r.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<s;t++)a=o(r.axes[t],.08),0==this.ready&&0!==a&&(this.ready=1),this.values[e][t]=a;for(t=0;t<i;t++)a=o(r.buttons[t].value),0==this.ready&&0!==a&&(this.ready=1),this.values[e][s+t]=a}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,s=19;s--;)t=this.values[e][s],0==this.ready&&0!==t&&(this.ready=1),this.key[s]=t}reset(){this.ready=0}fix(e,t){let s=Number(e.toString().substring(0,5));return t&&s<t&&s>-t&&(s=0),s}}class gl extends ae{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(e,t){let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.ray,s.update(e,i,this.motor.reflow.ray[a]||null)}add(e={}){this.setName(e);let t=new fl(e,this.motor.getMat("line"));return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&"string"!=typeof e.parent&&(e.parent=e.parent.name),e.callback&&delete e.callback,this.motor.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.setRay(e)}}class fl extends s.Line{constructor(e={},t){super(new s.BufferGeometry,t),this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=e.name,this.parentMesh=null,e.parent&&(this.parentMesh="string"==typeof e.parent?this.Utils.byName(e.parent):e.parent,this.data.parent=this.parentMesh),this.callback=e.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new s.Vector3,this.end=new s.Vector3(0,1,0),this.tmp=new s.Vector3,this.vnormal=new s.Vector3,this.vv1=new s.Vector3,this.vv2=new s.Vector3,this.fullDistance=0,this.setRay(e);this.geometry.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new s.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(e){e.begin&&this.begin.fromArray(e.begin),e.end&&this.end.fromArray(e.end),this.fullDistance=this.begin.distanceTo(this.end)}update(e,t=0,s=null){if(this.data.hit=0!==e[t],this.data.body=s||"",this.data.distance=e[t+1],this.data.hit)this.local[0]=e[t+2],this.local[1]=e[t+3],this.local[2]=e[t+4],this.tmp.fromArray(e,t+5),this.vnormal.fromArray(e,t+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(A.angleTo(this.vv1.toArray(),this.data.normal)*n);else if(this.parentMesh){const e=this.parentMesh.matrixWorld;this.tmp.copy(this.begin).applyMatrix4(e).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(e),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let e=this.vertices.array,t=this.colors.array,s=this.local,i=this.data.hit,a=i?this.c2:this.c1,r=i?this.c3:this.c1;t[3]=a[0],t[4]=a[1],t[5]=a[2],t[6]=r[0],t[7]=r[1],t[8]=r[2],e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}let bl=null,yl=null;class wl extends ae{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,bl=this.motor.geo,yl=this.motor.mat,this.type="body",this.num=v[this.type],this.full=!1,this.extraConvex=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(e){this.num=v[e?"bodyFull":"body"],this.full=e}step(e,t){const s=this.list;let i,a,r,o=s.length;for(;o--;)if(i=s[o],null!==i){if(a=t+o*this.num,!i.actif){if(0===A.nullArray(e,a,this.num))continue;i.actif=!0}if(i.sleep=!(e[a]>0),i.defMat&&(i.isInstance?i.instance.setColorAt(i.id,i.sleep?cl.sleep:cl.body):(i.sleep||"sleep"!==i.material.name||(i.material=yl.get("body")),i.sleep&&"body"===i.material.name&&(i.material=yl.get("sleep")))),!i.sleep||i.isKinematic)if(i.isInstance){if(i.speedMat){let t=.01*e[a];i.instance.setColorAt(i.id,[t,t,t])}i.instance.setTransformAt(i.id,[e[a+1],e[a+2],e[a+3]],[e[a+4],e[a+5],e[a+6],e[a+7]],i.noScale?[1,1,1]:i.size),i.position={x:e[a+1],y:e[a+2],z:e[a+3]},i.quaternion={_x:e[a+4],_y:e[a+5],_z:e[a+6],_w:e[a+7]},this.needMatrix&&i.matrixWorld.compose(i.position,i.quaternion,{x:1,y:1,z:1}),this.full?(i.velocity={x:e[a+8],y:e[a+9],z:e[a+10]},i.angular={x:e[a+11],y:e[a+12],z:e[a+13]}):i.getVelocity&&(r=this.motor.reflow.velocity[i.name],r&&(i.velocity={x:r[0],y:r[1],z:r[2]},i.angular={x:r[3],y:r[4],z:r[5]}))}else i.position.fromArray(e,a+1),i.quaternion.fromArray(e,a+4),this.full?(i.velocity.fromArray(e,a+8),i.angular.fromArray(e,a+11)):i.getVelocity&&(r=this.motor.reflow.velocity[i.name],r&&(i.velocity={x:r[0],y:r[1],z:r[2]},i.angular={x:r[3],y:r[4],z:r[5]})),i.auto||i.updateMatrix()}}geometry(e={},t=null,i=null){let a,r,o,n=e.size,l="",c=e.type,d=!1,u=!1,p=e.seg||16;const m="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(e.instance&&"compound"===c&&(c=e.shapes[0].type,n=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==c&&"convex"!==c||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&(e.breakable||("box"===c&&(c="ChamferBox"),"cylinder"===c&&(c="ChamferCyl"))),e.geometry&&("convex"===c?e.shape=e.geometry:c="direct"),"PHYSX"===this.engine&&"cylinder"===e.type){let t=new s.CylinderGeometry(e.size[0],e.size[0],e.size[1],p,1);e.isWheel&&t.rotateZ(-h),e.v=A.getVertex(t),e.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===e.type){let t=new s.CylinderGeometry(0,e.size[0],e.size[1],p,1);e.v=A.getVertex(t),e.type="convex"}switch("stair"===e.type&&(e.type="box",c="box"),c){case"direct":a=e.geometry.clone(),e.size&&a.scale(e.size[0],e.size[1],e.size[2]),u=!0,d=!0;break;case"convex":if(e.v){if(e.nogeo)a=new s.BufferGeometry;else{let t=[];for(r=Math.floor(e.v.length/3);r--;)o=3*r,t.push(new s.Vector3(e.v[o],e.v[o+1],e.v[o+2]));a=new qe(t)}u=!0,d=!0}if(e.shape){a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.shapeScale&&a.scale(e.shapeScale[0],e.shapeScale[1],e.shapeScale[2]);let t=m?A.toNonIndexed(a):null;e.v=A.getVertex(t||a,m),e.index=A.getIndex(t||a,m),this.engine,u=!0,d=!0}a.boundingBox||a.computeBoundingBox();let t=a.boundingBox;e.boxSize=[-t.min.x+t.max.x,-t.min.y+t.max.y,-t.min.z+t.max.z];break;case"mesh":a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.v=A.getVertex(a,m),e.index=A.getIndex(a,m),u=!0,d=!0;break;case"customSphere":l="customSphere_"+n[0],a=bl.get(l),a?l="":(a=new s.SphereGeometry(n[0],e.seg1||32,e.seg2||16),a.name=l),d=!0,e.type="sphere";break;case"highSphere":l="highSphere_"+n[0],a=bl.get(l),a?l="":(a=new Ee(n[0]),a.name=l),d=!0,e.type="sphere";break;case"capsule":l="capsule_"+n[0]+"_"+n[1]+"_"+p,a=bl.get(l),a?l="":(a=new Me(n[0],n[1],p),a.name=l),d=!0;break;case"ChamferBox":l="ChamferBox_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+e.radius,a=bl.get(l),a?l="":(a=new Qe(n[0],n[1],n[2],e.radius),a.name=l),d=!0;break;case"ChamferCyl":l="ChamferCyl_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+e.radius+"_"+p,a=bl.get(l),a?l="":(a=new ke(n[0],n[0],n[1],e.radius,p),a.name=l),d=!0;break;default:e.breakable?(a=bl.get(c).clone(),a.scale(n[0],n[1],n[2]),u=!0,d=!0):a=bl.get(c)}if(e.translate&&a.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,(void 0===a.attributes.uv||e.autoUV)&&Fe(a,"box",5,e.pos,e.quat),""!==l&&bl.set(a),e.isWheel&&(a=a.clone(),a.rotateZ(-h),u=!0),u&&bl.unic(a),null===t&&null===i)return a.noScale=d,a;e.meshRemplace&&e.debug&&(i=yl.get("debug"));let g=new s.Mesh(a,i);if(e.button&&(g.isButton=!0),e.helper){let t=e.hcolor||[.3,.1,0],s=e.hcolor2||[.8,.2,0],i=new He(n[0],n[1]+2*n[0],!1,yl.get("liner"),t,s,!0);g.add(i),g.userData.helper=i}e.localRot&&(e.localQuat=A.quatFromEuler(e.localRot)),e.localPos&&g.position.fromArray(e.localPos),e.localQuat&&g.quaternion.fromArray(e.localQuat),d||g.scale.fromArray(e.size),void 0!==e.ray&&(e.ray||(g.raycast=()=>{})),e.meshRemplace&&!e.debug||(t.add(g),g.userData.helper&&(t.over=e=>{g.userData.helper.over(e)}))}add(e={}){e.worldScale&&delete(e=this.scaler(e,e.worldScale)).worldScale;let t,i,a,r=0;if(e.instance||(a=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),"stair"===e.type){let t=new s.Vector3(0,0,e.size[2]),i=new s.Vector3(0,.5*e.size[1],.5*e.size[2]),a=t.angleTo(i),r=t.distanceTo(i);e.rot=[a*n,0,0],e.size[1]*=e.div||.2,e.size[2]=2*r;let o=new s.Vector3(0,.5*-e.size[1],0);o.applyAxisAngle({x:1,y:0,z:0},a),e.pos[1]+=o.y,e.pos[2]+=o.z}if(e.massCenter&&!d.indexOf(this.engine))if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.pos?i.pos=A.addArray(i.pos,e.massCenter):i.pos=e.massCenter;void 0!==e.collision&&!1===e.collision&&("PHYSX"===this.engine&&(e.flags=0),"OIMO"===this.engine&&(e.mask=0)),e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=A.quatFromEuler(e.rot)),void 0!==e.meshRot&&(e.meshQuat=A.quatFromEuler(e.meshRot)),e.size=A.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=A.autoSize(e.meshScale));let o,l=!1;!1===e.visible&&(e.material="hide"),void 0!==e.material?o=e.material.constructor===String?yl.get(e.material):e.material:(l=!0,o=yl.get(this.type),e.instance&&(o=yl.get("base"))),e.unicMat&&(o=o.clone(),yl.addToTmp(o));let h=e.instance?{}:new we;if(e.mesh&&!e.instance){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();if(t.position.fromArray(e.meshPos||[0,0,0]),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),!l&&(t.material=o,t.children&&!e.nofullmat))for(let e in t.children)t.children[e].material=o;this.motor.tmpMesh.push(t),e.meshRemplace=!0,h.add(t)}switch(e.type){case"null":break;case"compound":for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.type=void 0===i.type?"box":i.type,i.size=A.autoSize(i.size,i.type),i.pos&&(i.localPos=i.pos),void 0!==i.rot&&(i.quat=A.quatFromEuler(i.rot)),i.quat&&(i.localQuat=i.quat),i.debug=e.debug,i.meshRemplace=e.meshRemplace||!1,e.instance?"convex"===i.type&&(i.v=A.getVertex(i.shape,!1)):this.geometry(i,h,o),r+=A.getVolume(i.type,i.size,i.v);break;default:e.instance?"convex"===e.type&&(e.v=A.getVertex(e.shape,!1)):this.geometry(e,h,o),r=A.getVolume(e.type,e.size,e.v)}if(h.type=this.type,h.size=e.size,h.shapetype=e.type,h.isKinematic=e.kinematic||!1,h.link=0,h.meshSize=e.meshSize?e.meshSize:1,e.button&&(h.isButton=!0),h.isRay=!0,void 0!==e.ray&&h.setRaycast(e.ray),e.instance||h.setRaycast(),h.defMat=!1,h.material&&l&&(h.defMat="body"===h.material.name),e.instance){h.isInstance=!0,h.instance=this.getInstance(e,o),h.instance.isRay=h.isRay,h.over=h.instance.over,h.isOver=!1,h.speedMat=e.speedMat||!1,h.defMat="base"===h.instance.material.name,h.id=h.instance.count,h.refName=h.instance.name+h.id,h.name=e.name?e.name:h.instance.name+h.id,e.name=h.name,h.noScale=h.instance.noScale,e.sizeByInstance&&(h.noScale=!1);let t=e.color;h.defMat&&(t=e.sleep?cl.sleep:cl.body),h.instance.add(h,e.pos,e.quat,h.noScale?[1,1,1]:h.size,t),h.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]},h.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]},h.velocity={x:0,y:0,z:0},h.angular={x:0,y:0,z:0},h.link=0,this.needMatrix&&(h.matrixWorld=new s.Matrix4),h.instance.v&&(e.v=h.instance.v),h.instance.index&&(e.index=h.instance.index),e.type=h.instance.type}else h.name=a,e.renderOrder&&(h.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),h.visible=void 0===e.visible||e.visible,h.receiveShadow=e.shadow,h.castShadow=e.shadow,h.overMaterial=yl.get("outline"),this.set(e,h);if(e.breakable){this.motor.addBreaker();let t=h.children[0];h.remove(t),h=t,h.name=a,h.type=this.type,h.density=e.density,h.breakable=!0,h.breakOption=void 0!==e.breakOption?e.breakOption:[250,1,2,1]}if(h.mass=e.mass||0,h.density=e.density||0,h.density&&!h.mass?h.mass=A.massFromDensity(h.density,r):h.mass&&!h.density&&(h.density=A.densityFromMass(h.mass,r),"RAPIER"!==this.engine&&"OIMO"!==this.engine||(e.density=h.density)),e.massInfo&&console.log("%c"+h.name+" %cdensity:"+h.density+" mass:"+h.mass,"font-size:16px","font-size:12px"),e.getVelocity&&(h.getVelocity=!0),this.addToWorld(h,e.id),e.onlyMakeMesh)return h;if(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),e.rot&&delete e.rot,e.mesh&&delete e.mesh,e.meshRot&&delete e.meshRot,e.instance&&delete e.instance,e.material&&delete e.material,e.parent&&delete e.parent,e.solver&&"PHYSX"===this.engine){e.mass=h.mass;this.byName(e.solver).addBone(e.name)}return this.motor.post({m:"add",o:e}),h}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(void 0!==e.getVelocity&&(t.getVelocity=e.getVelocity),t.isInstance?(e.pos&&(t.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]}),e.quat&&(t.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]}),t.instance.setTransformAt(t.id,t.position,t.quaternion,t.noScale?[1,1,1]:t.size)):(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix())))}clearInstance(e){let t=this.motor.instanceMesh[e],s=t.getBodyList();this.motor.remove(s),t.dispose(),delete this.motor.instanceMesh[e]}getInstance(e,t){if(this.motor.instanceMesh[e.instance])return this.motor.instanceMesh[e.instance];(e={...e}).sizeByInstance&&(e.size=[1,1,1]);let s=this.geometry(e);e.mesh&&(!e.material&&e.mesh.material&&(t=e.mesh.material),s=e.mesh.isObject3D?e.mesh.geometry.clone():e.mesh.clone(),e.meshSize&&s.scale(e.meshSize,e.meshSize,e.meshSize),e.meshScale&&s.scale(e.meshScale[0],e.meshScale[1],e.meshScale[2]),s.noScale=!0);let i=new ve(s,t,0);return i.type=e.type,i.noScale=s.noScale,"convex"===i.type&&(i.v=e.v),e.index&&(i.index=e.index),i.receiveShadow=void 0===e.shadow||e.shadow,i.castShadow=void 0===e.shadow||e.shadow,i.overMaterial=yl.get("outline"),i.name=e.instance,this.motor.scene.add(i),this.motor.instanceMesh[e.instance]=i,i}scaler(e,t){if(e.size&&(e.size=math.scaleArray(e.size,t)),e.pos&&(e.pos=math.scaleArray(e.pos,t)),"convex"===e.type&&(e.shapeScale=[t,t,t]),e.shapes){let s,i=e.shapes.length;for(;i--;)s=e.shapes[i],s.size&&(s.size=math.scaleArray(s.size,t)),s.pos&&(s.pos=math.scaleArray(s.pos,t)),"convex"===s.type&&(s.shapeScale=[t,t,t])}return e.mesh&&(e.meshScale=[t,t,t]),e}}class vl extends we{constructor(e={},t){super(),this.motor=t,this.isJoint=!0,this.type="joint",this.mode=e.mode||"hinge",this.visible=void 0!==e.visible&&e.visible,this.mtx=new s.Matrix4,this.size=e.helperSize||.1;let i,a,r=this.motor.mat.get("line");switch(this.mode){case"prismatic":i=this.motor.mat.get("svg"),a={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},e.lm&&(a.min=e.lm[0],a.max=e.lm[1]),this.m1=new Je("liner",a,i),this.m2=new Je("middle",a,i),this.m1.geometry.rotateY(90*A.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":i=this.motor.mat.get("svg"),a={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},e.lm&&(a.min=e.lm[0],a.max=e.lm[1]),e.lmr&&(a.min=e.lmr[0],a.max=e.lmr[1]),this.m1=new Je("angle",a,i),this.m2=new Je("needle",a,i),this.add(this.m1),this.add(this.m2);break;default:const t=this.motor.geo.get("joint");let o=t.clone();o.scale(this.size,this.size,this.size),this.m1=new s.LineSegments(o,r),this.add(this.m1),o=t.clone(),o.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new s.LineSegments(o,r),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new s.Matrix4,this.mat2=new s.Matrix4,this.end=new s.Vector3;let o=new s.Quaternion;e.quat1&&this.mat1.makeRotationFromQuaternion(o.fromArray(e.quat1)),e.quat2&&this.mat2.makeRotationFromQuaternion(o.fromArray(e.quat2)),this.mat1.setPosition(e.pos1[0],e.pos1[1],e.pos1[2]),this.mat2.setPosition(e.pos2[0],e.pos2[1],e.pos2[2]);const n=new s.BufferGeometry;n.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,0,0],3)),n.setAttribute("color",new s.Float32BufferAttribute([1,0,0,1,0,0],3)),n.computeBoundingSphere(),this.m3=new s.LineSegments(n,r),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()),this.visible||(this.visible=!0))}updateFromPhy(e,t=0){this.visible&&(this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()),this.visible||(this.visible=!0))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Cl extends ae{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new s.Vector3,this.v2=new s.Vector3}step(e,t){let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.joint,16===v.joint?s.updateFromPhy(e,i):s.update()}add(e={}){let t,i=this.setName(e),a=null,r=null,n=!1;if(e.axis1||(e.axis1=[1,0,0]),e.axis2||(e.axis2=[1,0,0]),e.pos1||(e.pos1=[0,0,0]),e.pos2||(e.pos2=[0,0,0]),e.limit?e.lm=e.limit:e.lm&&(e.limit=e.lm),"universal"!==e.mode&&"dof"!==e.mode&&"d6"!==e.mode||(e.mode="generic"),"revolute"===e.mode&&(e.mode="hinge"),"slider"===e.mode&&(e.mode="cylindrical"),e.b1&&(t="string"==typeof e.b1,a=t?this.Utils.byName(e.b1):e.b1,t||(e.b1=e.b1.name),a&&a.link++),e.b2&&(t="string"==typeof e.b2,r=t?this.Utils.byName(e.b2):e.b2,t||(e.b2=e.b2.name),r&&r.link++),e.worldPos&&(e.worldAnchor=e.worldPos),e.worldAnchor&&(e.pos1=a?this.Utils.toLocal(this.v1.fromArray(e.worldAnchor),a).toArray():e.worldAnchor,e.pos2=r?this.Utils.toLocal(this.v2.fromArray(e.worldAnchor),r).toArray():e.worldAnchor,delete e.worldAnchor),e.worldAxis&&(e.axis1=a?this.Utils.toLocal(this.v1.fromArray(e.worldAxis),a,!0).toArray():e.worldAxis,e.axis2=r?this.Utils.toLocal(this.v2.fromArray(e.worldAxis),r,!0).toArray():e.worldAxis,n=!0,delete e.worldAxis),e.worldQuat&&(e.quat1=this.Utils.quatLocal(e.worldQuat,a),e.quat2=this.Utils.quatLocal(e.worldQuat,r),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(e.axis1=this.Utils.axisLocal(A.quatToAxis(e.worldQuat),a),e.axis2=this.Utils.axisLocal(A.quatToAxis(e.worldQuat),r)),delete e.worldQuat),void 0!==e.rot1&&(e.quat1=A.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=A.quatFromEuler(e.rot2),delete e.rot2),e.quat1||(e.quat1=(new s.Quaternion).setFromUnitVectors(new s.Vector3(1,0,0),(new s.Vector3).fromArray(e.axis1).normalize()).toArray()),e.quat2||(e.quat2=(new s.Quaternion).setFromUnitVectors(new s.Vector3(1,0,0),(new s.Vector3).fromArray(e.axis2).normalize()).toArray()),"AMMO"===this.engine&&n&&"hinge"===e.mode){let t=new s.Euler(0,-90*o,0),i=(new s.Quaternion).setFromEuler(t).toArray();e.quatX=i}e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot);let l=new vl(e,this.motor);return l.name=i,l.body1=a,l.body2=r,void 0===e.visible&&(e.visible=this.motor.jointVisible||!1),this.set(e,l),this.addToWorld(l,e.id),this.motor.post({m:"add",o:e}),l}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&void 0!==e.visible&&(t.visible=e.visible)}}class Il extends ae{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="contact"}step(e,t){let s,i,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*v.contact,s.update(e,i)}add(e={}){this.setName(e);let t=new xl(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),this.motor.post({m:"add",o:e}),t}}class xl{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.simple=e.simple||!1,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}class Bl extends ae{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="vehicle",this.num=v[this.type]}step(e,t){let s,i,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*this.num,i.step(e,s)}add(e={}){this.setName(e);const t=new El(e);return this.addToWorld(t,e.id),this.motor.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}class El extends we{constructor(e){super(),e.extra&&(this.extra=e.extra,delete e.extra),this.type="vehicle",this.name=e.name||"car",this.isRay=e.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(e)}drive(){}raycast(){}init(e){this.mass=e.mass||2e3,this.model=null,this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.maxSteering=e.maxSteering||24,this.incSteering=e.incSteering||2,this.s_travel=e.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep;let t=this.numWheel<4?1:2;if(e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){this.wPos=e.wPos;var s,i,a,r,o,n,l=e.wPos,h=[],c=1,d=0;l.length,l.length;for(let e=0;e<this.numWheel;e++)c=e%2==0?-1:1,i=Math.floor(.5*e),d=e>=t,0===(a=l[1])&&(a=d?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][i]),o=d?-l[2]:l[2],l[2]instanceof Array&&(o=l[2][i]),s=[r*c,a,o],h.push(s);this.wheelsPosition=h,delete e.wPos}e.wheelsPosition&&(this.wheelsPosition=e.wheelsPosition);const u=e.meshScale||1,p=[];e.chassisShape?p.push({type:"convex",shape:e.chassisShape,size:[u],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):p.push({type:"box",size:this.size,pos:this.chassisPos});for(let s=0;s<this.numWheel;s++)s<t?p.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1}):p.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1});var m=dl.get(e.debug?"debug":void 0===e.chassisMesh?"body":"hide");let g,f;for(let e=0;e<p.length;e++)g=p[e],g.pos&&(g.localPos=g.pos),g.size=A.autoSize(g.size,g.type),this.motor.items.body.geometry(g,this,m);if(e.chassisMesh&&(f=e.noClone?e.chassisMesh:e.chassisMesh.clone(),f.position.set(0,0,0),this.Utils.noRay(f),f.scale.set(u,u,u),this.children[0].add(f),this.model=f,delete e.chassisMesh),e.wheelMesh){for(let s=1;s<this.numWheel+1;s++)d=s>=t+1,f=e.wheelMeshBack&&d?e.wheelMeshBack.clone():e.wheelMesh.clone(),this.Utils.noRay(f),f.position.set(0,0,0),2==s||4==s?f.scale.set(-u,u,u):f.scale.set(u,u,u),this.children[s].add(f);delete e.wheelMesh}if(e.suspensionMesh){this.suspensionMesh=[];for(let t=1;t<this.numWheel+1;t++)f=e.suspensionMesh.clone(),this.Utils.noRay(f),f.position.set(0,0,0),f.position.fromArray(this.wheelsPosition[t-1]),f.position.x=0,2==t||4==t?f.scale.set(u,u,u):f.scale.set(-u,u,u),this.children[0].add(f),this.suspensionMesh.push(f);delete e.suspensionMesh}if(e.brakeMesh){this.brake=[];for(let t=1;t<this.numWheel+1;t++)d=t>2,f=e.brakeMeshBack&&d?e.brakeMeshBack.clone():e.brakeMesh.clone(),this.Utils.noRay(f),f.position.set(0,0,0),f.position.fromArray(this.wheelsPosition[t-1]),n=e.brakeMeshBack||d?u:-u,2==t||4==t?f.scale.set(-u,u,n):f.scale.set(u,u,n),this.children[0].add(f),this.brake.push(f);delete e.brakeMesh}e.mass=this.mass,e.size=e.chassisShape?p[0].boxSize:this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=p[0],e.maxSteering=this.maxSteering,e.incSteering=this.incSteering,e.s_travel=this.s_travel,e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}set(e){e.name=this.name,this.motor.change(e)}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.quaternion.toArray()),this.motor.change(e)}move(){}dispose(){}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.updateMatrix();let s,i=this.numWheel+1,a=0,r=0,o=[],l=0;for(let n=0;n<i;n++)l=8*n+t,0===n&&(e[l],this.circum),1===n&&(a=e[l]),2===n&&(r=e[l]),s=this.children[n],s&&n>0&&(o[n-1]=this.wheelsPosition[n-1][1]-this.decaly-e[l+2],s.position.fromArray(e,l+1),s.quaternion.fromArray(e,l+4),this.rolling[n-1]=s.rotation.x,this.brake&&(this.brake[n-1].position.copy(s.position),1!=n&&2!=n||(this.brake[n-1].rotation.y=e[l])));for(l=4;l--;)this.suspension[l]=A.clamp(o[l]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[l]>0?(this.Utils.morph(this.suspensionMesh[l].children[0],"low",this.suspension[l]),this.Utils.morph(this.suspensionMesh[l].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[l].children[0],"low",0),this.Utils.morph(this.suspensionMesh[l].children[0],"top",-this.suspension[l])));this.steering=Math.round(.5*(a+r)*n)/this.maxSteering}}const Ml=new s.Matrix4,Sl=new s.Vector3,kl=new s.Quaternion,Ql=new s.Vector3,Rl=new s.Matrix4,Tl=new s.Matrix4,Fl=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Dl extends s.Object3D{constructor(e,t,s,i,a=null,r={}){super(),this.motor=e,this.prefix=t||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=i,this.model=s,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=a,this.friction=.5,this.restitution=0,this.option=r,this.useDrive=void 0===r.useDrive||r.useDrive,this.showJoint=void 0!==r.showJoint&&r.showJoint,this.init()}setMass(e){if(e===this.mass)return;this.mass=e;const t=[];let s=this.nodes.length,i=this.mass/s;for(;s--;)t.push({name:this.nodes[s].name,mass:i});this.motor.change(t)}setMode(e){if(e===this.mode)return;this.mode=e;const t=[];let s,i="follow"===this.mode,a=this.nodes.length;for(;a--;)s=this.nodes[a],t.push({name:s.name,kinematic:i}),s.kinematic=i,s.bone.isPhysics=!i;this.motor.change(t)}freeBone(e){e.kinematic&&(e.cc++,20===e.cc&&(e.cc=0,e.kinematic=!1,e.bone.isPhysics=!0,this.motor.change({name:e.name,kinematic:!1})))}isVisible(e){let t=this.nameList.length;for(;t--;)this.motor.byName(this.nameList[t]).visible=e}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const e=[];let t=(new s.Matrix4).makeScale(this.scaler,this.scaler,this.scaler),i=new s.Vector3,a=new s.Vector3,r=new s.Quaternion,n=new s.Euler,l=new s.Matrix4,h=new s.Matrix4,c=new s.Matrix4;Rl.copy(this.model.matrixWorld).invert();let d=new s.Vector3,u=new s.Vector3,p=[1,1,1,1,1,1,1];this.option.sizer&&(p=this.option.sizer);let m,g,f,b,y,w,v,C,I,x,B,E,M,S=this.bones.length,k=0;for(this.mass&&(k=this.mass/S),m=0;m<S;m++)if(I=null,b=this.bones[m],g=b.name,y=b.parent,y){f=y.name,Tl.multiplyMatrices(Rl,b.matrixWorld),d.setFromMatrixPosition(Tl),Tl.multiplyMatrices(Rl,y.matrixWorld),u.setFromMatrixPosition(Tl),v=d.distanceTo(u),B=[0,0,.5*v],w=[v,1,1],C=null,x=!0,M=!1,"hip"===f&&"abdomen"===g&&(I="capsule",w=[v*p[0],.08],B=[0,0,-v*p[0]],C=[0,0,90]),"abdomen"===f&&"chest"===g&&(I="capsule",w=[.7*v*p[1],.08],B=[0,0,.5*-v-.06],C=[90,0,0]),"chest"===f&&"neck"===g&&(I="capsule",w=[.4*v*p[2],.04],B=[0,0,.5*-v-.02],C=[0,0,90]),"neck"===f&&"head"===g&&(I="capsule",w=[.06*p[3],v],B=[0,0,.5*-v],C=[90,0,0]),"head"===f&&"End_head"===g&&(I="capsule",w=[.1*p[4],v-.17],B=[0,.02,.5*-v+.02],C=[90,0,0]),"chest"===f&&"rBreast"===g&&"HAVOK"!==this.motor.engine&&(f="rBreast",y=b,I="sphere",w=[.065],B=[.065,0,0],this.breast=!0,M=!0),"chest"===f&&"lBreast"===g&&"HAVOK"!==this.motor.engine&&(f="lBreast",y=b,I="sphere",w=[.065],B=[.065,0,0],this.breast=!0,M=!0);let s=.04*p[5],m=v-s;if("lCollar"===f&&"lShldr"===g&&(I="capsule",w=[s,.3*v],B=[.6*v,0,0],C=[0,0,90]),"lShldr"===f&&"lForeArm"===g&&(I="capsule",w=[s,m],B=[.5*m,0,0],C=[0,0,90]),"lForeArm"===f&&"lHand"===g&&(I="capsule",w=[s,m],B=[.5*m,0,0],C=[0,0,90]),"lHand"===f&&"lMid1"===g&&(I="box",w=[2*v,.09,.05],B=[v,0,0]),"rCollar"===f&&"rShldr"===g&&(I="capsule",w=[s,.3*v],B=[.6*-v,0,0],C=[0,0,90]),"rShldr"===f&&"rForeArm"===g&&(I="capsule",w=[s,m],B=[.5*-m,0,0],C=[0,0,90]),"rForeArm"===f&&"rHand"===g&&(I="capsule",w=[s,m],B=[.5*-m,0,0],C=[0,0,90]),"rHand"===f&&"rMid1"===g&&(I="box",w=[2*v,.09,.05],B=[-v,0,0]),s=.06*p[6],m=v-s,"lThigh"===f&&(I="capsule",w=[s,v],C=[90,0,0],B=[0,0,.5*m]),"lShin"===f&&(I="capsule",w=[s,v],C=[90,0,0],B=[0,0,.5*m]),"lFoot"===f&&(I="capsule",w=[.05,v],B=[0,.5*v-.025,.04]),"rThigh"===f&&(I="capsule",w=[s,v],C=[90,0,0],B=[0,0,.5*m]),"rShin"===f&&(I="capsule",w=[s,v],C=[90,0,0],B=[0,0,.5*m]),"rFoot"===f&&(I="capsule",w=[.05,v],B=[0,.5*v-.025,.04]),s=.04,m=v-s,"rEar_0"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("rEar_0")),"rEar_1"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("rEar_1")),"rEar_2"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("rEar_2")),"rEar_3"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0]),"lEar_0"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("lEar_0")),"lEar_1"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("lEar_1")),"lEar_2"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0],Fl.push("lEar_2")),"lEar_3"===f&&(I="capsule",w=[s,v],C=[0,0,90],B=[.5*m,0,0]),this.withFinger&&("lHand"===f&&"lMid1"===g&&(I="box",w=[v,.09,.05],B=[.5*v,0,0]),"rHand"===f&&"rMid1"===g&&(I="box",w=[v,.09,.05],B=[.5*-v,0,0]),"rThumb1"===f&&"rThumb2"===g&&(I="capsule",w=[.02,v],C=[0,0,90]),"rThumb2"===f&&"rThumb3"===g&&(I="capsule",w=[.02,v],C=[0,0,90]),"rHand"===f&&"rMid1"===g&&(I="capsule",w=[.02,v],C=[0,0,90],B=[.6*-v,0,0]),"rMid1"===f&&"rMid2"===g&&(I="capsule",w=[.02,v],C=[0,0,90],B=[.6*-v,0,0]),"rMid2"===f&&"rMid3"===g&&(I="capsule",w=[.02,v],C=[0,0,90],B=[.6*-v,0,0])),null!==I){E=this.prefix+"_bone_"+f,h.makeTranslation(B[0],B[1],B[2]),C&&(c.makeRotationFromEuler(n.set(C[0]*o,C[1]*o,C[2]*o)),h.multiply(c)),y.updateWorldMatrix(!0,!1),Tl.multiplyMatrices(Rl,y.matrixWorld),l.copy(Tl),l.decompose(i,r,a),this.posRef[E]=i.toArray(),"lForeArm"!==f&&"rForeArm"!==f||(kl.setFromAxisAngle({x:0,y:1,z:0},-90*o),r.multiply(kl)),this.quatRef[E]=r.toArray(),l.multiplyMatrices(Tl,h),l.decompose(i,r,a),this.nameList.push(E);let s={name:E,friction:this.friction,restitution:this.restitution,type:I,size:A.scaleArray(w,this.scaler,3),pos:i.toArray(),quat:r.toArray(),kinematic:x,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==Fl.indexOf(f)&&(s.aggregate=this.prefix+"__Group",s.aggregateMax=21),s.mask=3;else{let e=3;"lForeArm"!==f&&"rForeArm"!==f&&"lShin"!==f&&"rShin"!==f||(e=35),"rEar_1"!==f&&"rEar_2"!==f&&"rEar_3"!==f&&"lEar_1"!==f&&"lEar_2"!==f&&"lEar_3"!==f||(e=35),"rEar_0"!==f&&"rEar_0"!==f||(e=0),s.group=32,s.mask=e}null!==this.mass?s.mass=k:s.density=1,e.push(s);let d=h.clone().invert().premultiply(t);this.nodes.push({name:E,kinematic:x,motion:M,bone:y,decal:h.clone(),decalinv:d,quat:r.toArray(),pos:i.toArray(),cc:0})}}this.motor.add(e),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(e){return-1!==this.nameList.indexOf(e)}addLink(){let e=[.05,1,0];"PHYSX"===this.motor.engine&&(e=[50,10,0,.5]);let t=2,s=.1,i=1e7,a=!1,r=this.prefix+"_bone_",o=[],n={type:"joint",mode:"d6",lm:[["ry",-180,180,...e],["rz",-180,180,...e]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(n.drives=[["rx",t,s,i,a],["ry",t,s,i,a],["rz",t,s,i,a]]);let l=[-.001,.001,100,.2,.5];o.push({...n,b1:r+"hip",b2:r+"abdomen",worldPos:this.posRef[r+"abdomen"],worldQuat:this.quatRef[r+"hip"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),o.push({...n,b1:r+"abdomen",b2:r+"chest",worldPos:this.posRef[r+"chest"],worldQuat:this.quatRef[r+"chest"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),o.push({...n,b1:r+"chest",b2:r+"neck",worldPos:this.posRef[r+"neck"],worldQuat:this.quatRef[r+"neck"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),o.push({...n,b1:r+"neck",b2:r+"head",worldPos:this.posRef[r+"head"],worldQuat:this.quatRef[r+"head"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),o.push({...n,b1:r+"chest",b2:r+"rCollar",worldPos:this.posRef[r+"rCollar"],worldQuat:this.quatRef[r+"rCollar"],mode:"fixe"}),o.push({...n,b1:r+"chest",b2:r+"lCollar",worldPos:this.posRef[r+"lCollar"],worldQuat:this.quatRef[r+"lCollar"],mode:"fixe"}),o.push({...n,b1:r+"rCollar",b2:r+"rShldr",worldPos:this.posRef[r+"rShldr"],worldQuat:this.quatRef[r+"rShldr"]}),o.push({...n,b1:r+"lCollar",b2:r+"lShldr",worldPos:this.posRef[r+"lShldr"],worldQuat:this.quatRef[r+"lShldr"]}),this.existe(r+"rForeArm")&&o.push({...n,b1:r+"rShldr",b2:r+"rForeArm",worldPos:this.posRef[r+"rForeArm"],worldQuat:this.quatRef[r+"rForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"lForeArm")&&o.push({...n,b1:r+"lShldr",b2:r+"lForeArm",worldPos:this.posRef[r+"lForeArm"],worldQuat:this.quatRef[r+"lForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"rHand")&&o.push({...n,b1:r+"rForeArm",b2:r+"rHand",worldPos:this.posRef[r+"rHand"],worldQuat:this.quatRef[r+"rHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),this.existe(r+"lHand")&&o.push({...n,b1:r+"lForeArm",b2:r+"lHand",worldPos:this.posRef[r+"lHand"],worldQuat:this.quatRef[r+"lHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),o.push({...n,b1:r+"hip",b2:r+"rThigh",worldPos:this.posRef[r+"rThigh"],worldQuat:this.quatRef[r+"rThigh"]}),o.push({...n,b1:r+"hip",b2:r+"lThigh",worldPos:this.posRef[r+"lThigh"],worldQuat:this.quatRef[r+"lThigh"]}),this.existe(r+"rShin")&&o.push({...n,b1:r+"rThigh",b2:r+"rShin",worldPos:this.posRef[r+"rShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"rShin"]}),this.existe(r+"lShin")&&o.push({...n,b1:r+"lThigh",b2:r+"lShin",worldPos:this.posRef[r+"lShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"lShin"]}),this.existe(r+"rFoot")&&o.push({...n,b1:r+"rShin",b2:r+"rFoot",worldPos:this.posRef[r+"rFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"rFoot"]}),this.existe(r+"lFoot")&&o.push({...n,b1:r+"lShin",b2:r+"lFoot",worldPos:this.posRef[r+"lFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"lFoot"]}),this.breast&&(this.existe(r+"rBreast")&&o.push({...n,b1:r+"chest",b2:r+"rBreast",worldPos:this.posRef[r+"rBreast"],worldQuat:this.quatRef[r+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(r+"lBreast")&&o.push({...n,b1:r+"chest",b2:r+"lBreast",worldPos:this.posRef[r+"lBreast"],worldQuat:this.quatRef[r+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(r+"lEar_0")&&o.push({...n,b1:r+"head",b2:r+"lEar_0",worldPos:this.posRef[r+"lEar_0"],worldQuat:this.quatRef[r+"lEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_1")&&o.push({...n,b1:r+"lEar_0",b2:r+"lEar_1",worldPos:this.posRef[r+"lEar_1"],worldQuat:this.quatRef[r+"lEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_2")&&o.push({...n,b1:r+"lEar_1",b2:r+"lEar_2",worldPos:this.posRef[r+"lEar_2"],worldQuat:this.quatRef[r+"lEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_3")&&o.push({...n,b1:r+"lEar_2",b2:r+"lEar_3",worldPos:this.posRef[r+"lEar_3"],worldQuat:this.quatRef[r+"lEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_0")&&o.push({...n,b1:r+"head",b2:r+"rEar_0",worldPos:this.posRef[r+"rEar_0"],worldQuat:this.quatRef[r+"rEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_1")&&o.push({...n,b1:r+"rEar_0",b2:r+"rEar_1",worldPos:this.posRef[r+"rEar_1"],worldQuat:this.quatRef[r+"rEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_2")&&o.push({...n,b1:r+"rEar_1",b2:r+"rEar_2",worldPos:this.posRef[r+"rEar_2"],worldQuat:this.quatRef[r+"rEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_3")&&o.push({...n,b1:r+"rEar_2",b2:r+"rEar_3",worldPos:this.posRef[r+"rEar_3"],worldQuat:this.quatRef[r+"rEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]});let h=0;for(let e in o)o[e].name=this.prefix+"_joint_"+h,this.jointList.push(o[e].name),h++;this.motor.add(o)}updateMatrixWorld(e){if(!this.ready)return;let t=[];const s=this.nodes;let i,a,r,o=s.length,n=0;for(;o--;)i=s[n],a=i.bone,n++,i.kinematic?(Ml.multiplyMatrices(a.matrixWorld,i.decal),Ml.decompose(Sl,kl,Ql),i.pos=Sl.toArray(),i.quat=kl.toArray(),t.push({name:i.name,pos:i.pos,quat:i.quat}),i.motion&&this.freeBone(i)):(r=this.motor.byName(i.name),r&&(Ml.copy(r.matrixWorld).multiply(i.decalinv),a.phyMtx.copy(Ml),a.isPhysics=!0));0!==t.length&&this.motor.change(t,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}class Ll extends we{constructor(e={},t){super(),this.motor=t,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=e.useImpulse||!1,this.useFloating=e.floating||!1,this.waitRotation=!1;let i=.3,a=e.radius||.3,r=e.height||1.8;this.realHeight=r,this.useFloating&&(r-=i),this.option={debug:!1,capsuleHalfHeight:.5*r,capsuleRadius:a,floatHeight:i,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-r,z:0},rayHitForgiveness:.1,rayLength:a+2,rayDir:{x:0,y:-1,z:0},floatingDis:a+i+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:a-.03,slopeRayLength:a+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new s.Vector3,movingObjectVelocity:new s.Vector3,standingForcePoint:new s.Vector3,pivotPosition:new s.Vector3,modelQuat:new s.Quaternion,moveImpulse:new s.Vector3,impulseCenter:new s.Vector3,movingDirection:new s.Vector3,moveAccNeeded:new s.Vector3,jumpVelocityVec:new s.Vector3,jumpDirection:new s.Vector3,currentVel:new s.Vector3,currentPos:new s.Vector3,dragForce:new s.Vector3,dragAngForce:new s.Vector3,wantToMoveVel:new s.Vector3,rejectVel:new s.Vector3,floatingForce:null,springDirVec:new s.Vector3,rayOrigin:new s.Vector3,characterMassForce:new s.Vector3,slopeAngle:null,actualSlopeNormal:new s.Vector3,actualSlopeAngle:null,actualSlopeNormalVec:new s.Vector3,floorNormal:new s.Vector3(0,1,0),slopeRayOriginRef:new s.Vector3,slopeRayorigin:new s.Vector3,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.type="character",this.name=e.name||"hero",e.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=a,this.height=r,this.mass=e.mass||.84,delete e.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.tmpV1=new s.Vector3,this.tmpV2=new s.Vector3,this.ease=new s.Vector3,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(e.angle||0)*o,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=e.ray||!1,this.callback=e.callback||function(){},e.callback&&delete e.callback,this.initPhysic(e)}setHeight(e){this.model&&this.model.setRealSize(e)}reSizePhysics(e){if(e===this.realHeight)return;this.realHeight=e,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let t=this.position.toArray();t[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let s=[this.radius,this.height-2*this.radius];this.phyData.pos=t,this.phyData.size=s,this.motor.post({m:"add",o:this.phyData})}initPhysic(e){e.size||(e.size=[this.radius,this.height-2*this.radius]),e.pos||(e.pos=[0,0,0]),e.pos[1]+=.5*this.height,this.useFloating&&(e.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.items.body.geometry({...e,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:e.size,pos:e.pos,type:"character",shapeType:e.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==e.friction?e.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:e.massInfo},e.mask&&(this.phyData.mask=e.mask),this.motor.items.character.addToWorld(this,e.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),e.gender?this.addModel(e):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(e){e.hit?(this.distance=e.distance,this.rayAngle=e.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(e){this.contact=e}showHelper(e){e?this.helper||(this.helper=new He(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=e)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Dl(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(e=!1){this.skeletonBody&&this.skeletonBody.isVisible(e),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:e,opacity:e?.8:1},!e),this.showHelper(e)}setMode(e){this.skeletonBody&&this.skeletonBody.setMode(e)}addModel(e){this.model=new Gr({type:e.gender,anim:void 0!==e.anim?e.anim:"idle",compact:!0,material:!e.noMat,morph:e.morph||!1,randomMorph:e.randomMorph||!1,randomSize:e.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:e.noLOD||!1}),this.add(this.model);let t=-.5*this.height;this.useFloating&&(t-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+t,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(e,t){this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.velocity.fromArray(e,t+8),this.angular.fromArray(e,t+11),this.fall=this.position.y<this.oy,this.floor=A.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const e=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let t=this.tmpV1.distanceTo(this.tmpV2)/e.zoom>3?0:1;this.model.setLevel(t)}set(e){e.morph&&this.model&&this.model.setMorph(e.morph,e.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper(),super.dispose()}onFrame(e,t){this.v,this.option}autoBalance(){const e=this.v,t=this.option,s=this.rotation;e.dragAngForce.set(-t.autoBalanceSpringK*s.x-this.angular.x*t.autoBalanceDampingC,-t.autoBalanceSpringK*s.y-this.angular.y*t.autoBalanceDampingOnY,-t.autoBalanceSpringK*s.z-this.angular.z*t.autoBalanceDampingC)}moveCharacter(e,t=0){const s=this.v,i=this.option,a=this.motor.getKey();this.motor.getAzimut(),s.currentPos.copy(this.position),s.slopeAngle=0,s.actualSlopeAngle<i.slopeMaxAngle&&Math.abs(s.slopeAngle)>.2&&Math.abs(s.slopeAngle)<i.slopeMaxAngle?s.movingDirection.set(0,Math.sin(s.slopeAngle),Math.cos(s.slopeAngle)):s.actualSlopeAngle>=i.slopeMaxAngle?s.movingDirection.set(0,Math.sin(s.slopeAngle)>0?0:Math.sin(s.slopeAngle),Math.sin(s.slopeAngle)>0?.1:1):s.movingDirection.set(0,0,1),s.movingDirection.applyAxisAngle({x:0,y:1,z:0},t),s.movingObjectVelocityInCharacterDir.copy(s.movingObjectVelocity).projectOnVector(s.movingDirection).multiply(s.movingDirection);const r=s.movingObjectVelocity.angleTo(s.movingDirection),o=s.currentVel.dot(s.movingDirection);s.wantToMoveVel.set(s.movingDirection.x*o,0,s.movingDirection.z*o),s.rejectVel.copy(s.currentVel).sub(s.wantToMoveVel),s.moveAccNeeded.set((s.movingDirection.x*(i.maxVelLimit*(this.running?i.sprintMult:1)+s.movingObjectVelocityInCharacterDir.x)-(s.currentVel.x-s.movingObjectVelocity.x*Math.sin(r)+s.rejectVel.x*(s.isOnMovingObject?0:i.rejectVelMult)))/i.accDeltaTime,0,(s.movingDirection.z*(i.maxVelLimit*(this.running?i.sprintMult:1)+s.movingObjectVelocityInCharacterDir.z)-(s.currentVel.z-s.movingObjectVelocity.z*Math.sin(r)+s.rejectVel.z*(s.isOnMovingObject?0:i.rejectVelMult)))/i.accDeltaTime);const n=s.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(t).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?s.moveImpulse.set(n.x*(s.canJump?1:i.airDragMultiplier),null===s.slopeAngle||0==s.slopeAngle?0:s.movingDirection.y*(s.movingDirection.y>0?i.slopeUpExtraForce:i.slopeDownExtraForce)*(this.running?i.sprintMult:1),n.z*(s.canJump?1:i.airDragMultiplier)):s.moveImpulse.set(n.x*i.turnVelMultiplier*(s.canJump?1:i.airDragMultiplier),null===s.slopeAngle||0==s.slopeAngle?0:s.movingDirection.y*i.turnVelMultiplier*(s.movingDirection.y>0?i.slopeUpExtraForce:i.slopeDownExtraForce)*(this.running?i.sprintMult:1),n.z*i.turnVelMultiplier*(s.canJump?1:i.airDragMultiplier)),s.impulseCenter.set(s.currentPos.x,s.currentPos.y+i.moveImpulsePointY,s.currentPos.z),s.currentVel.copy(this.velocity),a[4]&&s.canJump&&(s.jumpVelocityVec.set(s.currentVel.x,this.running?i.sprintJumpMult*i.jumpVel:i.jumpVel,s.currentVel.z),s.moveImpulse.y=s.jumpVelocityVec.y)}getFloating(){const e=this.v,t=this.option,s=t.springK*(t.floatingDis-this.distance)-this.velocity.y*t.dampingC;e.moveImpulse.y=s*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const e=this.motor.getKey(),t=this.motor.getAzimut(),s=this.motor.delta;let i=0!==e[7]?"run":"walk";0===e[0]&&0===e[1]&&(i="idle");let a=0!==e[0]&&0!==e[1]?this.diagonal:1;e[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===e[5]&&(this.toggle=!0),"walk"!==i&&"run"!==i||!this.crouch||(i="crouch"),1===e[6]&&(i="fight"),!this.jump&&e[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(i){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}this.moving=0!==e[0]||0!==e[1],this.running=0!==e[7],this.wantJump=0!==e[4];let o=A.unwrapRad(Math.atan2(e[0],e[1])+t);if(this.useImpulse)this.moving?this.moveCharacter(s,o):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*s;const r=1;let o=this.speed[i]*r;this.moving&&(this.rs=e[0]*o,this.ts=e[1]*o),0===e[0]&&0===e[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*a),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let n=this.vy-9.81;this.ease.y=n,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},t),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=t,"idle"!==i&&this.helper.setDirection(o)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(r,.75),"idle"!==i)){let e=A.unwrapRad(this.model.rotation.y),s=A.nearAngle(o,e),a=Math.abs(Math.floor((e-s)*math.todeg)/180);this.model.rotation.y="fight"===i?t+Math.PI:A.lerp(e,s,.2-.1*a),this.model.updateMatrix()}}}class Pl extends ae{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="character",this.num=v[this.type]}step(e,t){let s,i,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*this.num,i&&i.step(e,s)}add(e={}){this.setName(e);return new Ll(e,this.motor)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}class _l extends ae{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="terrain",this.num=v[this.type]}step(e,t){let s,i=this.list.length;for(;i--;)s=this.list[i],s.step()}add(e={}){this.setName(e),"JOLT"===this.engine&&(e.isAbsolute=!0,e.isTurned=!1),"PHYSX"===this.engine&&(e.isAbsolute=!0,e.isTurned=!0),"HAVOK"===this.engine&&(e.isAbsolute=!0,e.isTurned=!0,e.isReverse=!1),"OIMO"!==this.engine&&(e.zone=e.zone||.25);const t=new Vr(e);return dl.extendShader(t.material,t.material.onBeforeCompile),t.physicsUpdate=(e,t)=>{this.motor.flow.tmp.push({name:e,heightData:t})},this.addToWorld(t,e.id),this.motor.post({m:"add",o:Gl(t)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}const Gl=function(e){const t={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===this.engine?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===this.engine||"AMMO"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine?(t.type="terrain",t.size=e.sizeZ,t.sample=e.sampleZ,t.zone=e.zone,t.heightData=e.heightData):(t.type="mesh",t.v=A.getVertex(e.geometry,"OIMO"===this.engine),t.index="OIMO"===this.engine?null:A.getIndex(e.geometry)),t};class zl extends ae{constructor(e){super(),this.motor=motor,this.Utils=this.motor.utils,this.type="solver"}step(e,t){let s,i=this.list.length;for(;i--;)s=t+i*v[this.type],this.list[i].update(e,s)}add(e={}){this.setName(e);let t=new Ul(e);return this.addToWorld(t,e.id),this.motor.post({m:"add",o:e}),t}set(e={}){}}class Ul{constructor(e){this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(e){this.bones.push(e)}dispose(){this.motor.motor.remove(this.bones,!0)}update(e,t){if(!this.needData)return;let s,i,a=this.joints.length;for(;a--;)i=t+7*a,s=this.joints[a],s.data.target.x=e[i+0],s.data.target.y=e[i+1],s.data.target.z=e[i+2],s.data.target.rx=e[i+3],s.data.target.ry=e[i+4],s.data.target.rz=e[i+5],s.data.target.count=e[i+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,void 0!==e.rot1&&(e.quat1=A.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=A.quatFromEuler(e.rot2),delete e.rot2),"fixe"!==e.type&&this.joints.push(new Ol(e,this)),this.motor.post({m:"addSolverJoint",o:e})}driveJoints(e){let t,s,i=!1,a=this.joints.length,r=[];for(;a--;)t=this.joints[a],t.update(e),s=t.isDrive,t.nup&&r.push(t.nup),i=!!s||i;i?this.motor.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(!e)return;let s=this.joints.length;for(;s--;)this.joints[s].pose(void 0!==e[s]?e[s]:0,void 0!==t?t:this.speed);return new Promise((e=>this.resolve=e))}}class Ol{constructor(e,t){if(this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},e.limits&&(this.driveType=e.limits[0][0],this.min=e.limits[0][1],this.max=e.limits[0][2]),e.position&&(e.target=e.position),e.target){let t,s=e.target.length;for(;s--;)t=e.target[s],this.data.target[t[0]]=t[1]}}start(){}pose(e,t){this.target=A.clamp(e,this.min,this.max),this.current=A.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e*this.time;let t=this.tmp;t=t>1?1:t;let s=A.lerp(this.start,this.target,t);this.nup={name:this.name,drivesTarget:[[this.driveType,s]]},1===t&&(this.isDrive=!1)}else this.nup=null}}class Nl extends s.Mesh{constructor(e={}){super(new s.PlaneGeometry,new s.MeshBasicMaterial({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=e.nam||"text",this.canvas=null,this.w=e.w||0,this.h=e.h||0,this.weight=e.weight??700,this.font=e.font??"'Mulish', sans-serif",this.fontSize=e.fontSize??32,this.backgroundColor=e.backgroundColor??"#00000000",this.fontColor=e.fontColor??"#FFFFFF",this.material.alphaTest=.5,this.set(e.text),e.pos&&this.position.fromArray(e.pos),e.rot&&this.quaternion.fromArray(A.quatFromEuler(e.rot))}set(e){this.canvas||(this.canvas=document.createElement("canvas"));let t,i,a,r=this.canvas.getContext("2d");r.font=this.weight+" "+this.fontSize+"px "+this.font;let o=r.measureText(e);t=2**Math.ceil(Math.log2(o.width)),i=2**Math.ceil(Math.log2(r.measureText("M").width)),this.canvas.width=t,this.canvas.height=i,r.fillStyle=this.backgroundColor,r.fillRect(0,0,t,i),r.fillStyle=this.fontColor,r.font=this.weight+" "+this.fontSize+"px "+this.font,r.textAlign="center",r.textBaseline="middle",r.fillText(e,.5*t,.5*i),this.material.map=new s.CanvasTexture(this.canvas),0!==this.h?(a=this.h/i,this.scale.set(t*a,this.h,0)):0!==this.w?(a=this.w/i,this.scale.set(this.w,i*a,0)):this.scale.set(.025*t,.025*i,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let Vl=0;class ql{constructor(e={},t){this.motor=t,this.down=!1,this.time=e.time||250,this.p=e.pos||[0,0,0],this.type=e.type||"box",this.name=e.name||"button"+Vl++,this.pos=e.pos||[0,0,0],this.size=e.size||[1,1,1],this.radius=e.radius||0,this.axe=void 0!==e.axe?e.axe:1,this.fontSize=e.fontSize||.8,this.fontScale=e.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let s=this.size[this.axe]-2*this.radius;this.range=[this.origin-s,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},e.callback&&(this.callback=e.callback,delete e.callback),e.button=!0,e.pos=this.pos,e.material||(e.material="button"),e.kinematic=!0,e.mask=1,this.timeout=null,this.b=this.motor.add(e),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),e.text&&this.addText(e.text)}addText(e,t){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let s={text:e,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(s={text:e,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new Nl(s),this.b.add(this.txt)}action(e){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(e||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=A.lerp(this.value,this.target,this.speed),A.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class Hl{constructor(e={},t){this.motor=t,this.isCompound=!0,this.remplace=e.remplace||!1,this.init(e)}init(e={}){const t=e.intern||!1;let i=e.size||[5,3,8],a=e.pos||[0,2,0],r=e.wall||.1;void 0!==e.size[3]&&(r=e.size[3]),r<=0&&(r=.01);let o=.5*r,n=2*r;e.face||(e.face={});let l={up:1,down:1,left:1,right:1,front:1,back:1,...e.face};delete e.face;const h=[];t?(1===l.up&&h.push({pos:[0,.5*i[1]+o,0],size:[i[0]+n,r,i[2]+n]}),1===l.down&&h.push({pos:[0,-o-.5*i[1],0],size:[i[0]+n,r,i[2]+n]}),1===l.left&&h.push({pos:[-o-.5*i[0],0,0],size:[r,i[1],i[2]]}),1===l.right&&h.push({pos:[.5*i[0]+o,0,0],size:[r,i[1],i[2]]}),1===l.back&&h.push({pos:[0,0,-o-.5*i[2]],size:[i[0]+n,i[1],r]}),1===l.front&&h.push({pos:[0,0,.5*i[2]+o],size:[i[0]+n,i[1],r]})):(1===l.up&&h.push({pos:[0,.5*i[1]-o,0],size:[i[0],r,i[2]]}),1===l.down&&h.push({pos:[0,o-.5*i[1],0],size:[i[0],r,i[2]]}),1===l.left&&h.push({pos:[o-.5*i[0],0,0],size:[r,i[1]-n,i[2]]}),1===l.right&&h.push({pos:[.5*i[0]-o,0,0],size:[r,i[1]-n,i[2]]}),1===l.back&&h.push({pos:[0,0,o-.5*i[2]],size:[i[0]-n,i[1]-n,r]}),1===l.front&&h.push({pos:[0,0,.5*i[2]-o],size:[i[0]-n,i[1]-n,r]}));const c=[];let d,u,p=h.length,m=0;for(;p--;)u=h[m],d=this.isCompound?u.pos:A.addArray(a,u.pos),c.push({type:"box",size:u.size,pos:d,material:e.material}),m++;if(this.isCompound){let t=null;this.remplace&&(t=0===e.radius?new s.Mesh(new s.BoxGeometry(i[0],i[1],i[2])):new s.Mesh(new Qe(i[0],i[1],i[2],e.radius||o)),e.material&&"debug"===e.material&&(t=new eo(t,e.color),e.material="line")),this.motor.add({...e,mesh:t,shapes:c,type:"compound"})}else this.motor.add(c)}}class jl{constructor(e,t="drag",i){this.motor=i,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=t,this.option={},this.overObj=null,this.controler=e,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new s.Vector3,this.tmpPos=new s.Vector3,this.tmpD=new s.Vector3,this.mouse=new s.Vector2,this.oldMouse=new s.Vector2,this.raycast=new s.Raycaster,this.raycast.far=1e3,this.button=0,this.pos=new s.Vector3,this.velocity=new s.Vector3,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.helper=new Wl,this.dragPlane=new s.Mesh(new s.PlaneGeometry(1,1),this.motor.mat.get("hide")),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(e,t={}){e!==this.mode&&(this.mode=e,this.option=t,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(e){e?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(e){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(e){this.raycastTest=!1}controleChange(e){}getMouse(e){this.motor.viewSize?(this.mouse.x=e.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-e.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=e.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-e.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==e.pointerType?e.button:0}contextmenu(e){}mousedown(e){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(e),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(e){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.motor.mouseDown=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(e){if("drag"===this.mode)this.getMouse(e),this.needRay=!0}castray(){let e,t,s,i,a,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObject(this.dragPlane),e.length&&this.mouseDown&&this.moveSelect(e[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,e.length>0?(s=e[0].object,a=e[0].instanceId,void 0!==a?t=this.motor.byName(s.getByName(a)):s.parent!==this.motor.scene?(i=s.parent,t=i.parent!==this.motor.scene?i.parent:i):t=s,this.mouseDown2&&t.extra&&t.extra(t.name),r=t&&!t.isButton?this.select(t,e[0].point):this.actionButton(t,e[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.motor.mouseDown=!0,this.needRay=!0}blast(){let e=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let t=this.raycast.intersectObjects(this.motor.scene.children,!0);t.length>0?t[0].object.isButton?t[0].object.parent.userData.direct():e=t[0]:(t=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),t.length>0&&(e=t[0]));const s=this.option;e&&(this.motor.explosion(e.point,s.radius||3,s.power||.1),s.visible&&this.motor.addParticle({name:"blast",type:"cube",position:e.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",density:20,size:[.2],material:"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(e,t){if(this.buttonRef?this.buttonRef.name!==e.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=e):this.mouseDown&&(this.buttonRef=e),this.mouseDown&&this.buttonRef.userData.action){let e=t.point;this.buttonRef.userData.action(e)}return"pointer"}setOver(e){e&&(this.overObj&&e.name!==this.overObj.name&&this.resetOver(),this.overObj=e,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(e,t){if(this.mouseDown||this.setOver(e),!this.mouseDown||this.selected===e)return"grab";this.pz=0;let s=t,i=[0,0,0,1];this.selected=e,this.decal.copy(s).sub(this.selected.position),this.tmpPos.copy(s).sub(this.decal),this.angle=this.controler.getAzimuthalAngle();let a=this.selected.quaternion;i=[a._x,a._y,a._z,a._w],this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(s),this.dragPlane.position.y=0,this.helper.position.copy(s);let r=s.toArray(),o=!1;if(this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0}),this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let e=[-.1,.1,600,1],t=[-.1,.1,600,1],s="OIMO"===this.motor.engine||"RAPIER"===this.motor.engine||"JOLT"===this.motor.engine,a=0===this.selected.link?"fixe":"d6";"JOLT"===this.motor.engine&&(a="fixe");let n=[["x",...e],["y",...e],["z",...e],["rx",...t],["ry",...t],["rz",...t]];"HAVOK"===this.motor.engine&&(n=[["x",...e],["y",...e],["z",...e]]),"OIMO"===this.motor.engine&&(o=!0,a=0===this.selected.link?"fixe":"spherical",n=[["x",...e],["y",...e],["z",...e]]),"HAVOK"===this.motor.engine&&(o=!0,a=0===this.selected.link?"fixe":"spherical",n=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:r,quat:i,kinematic:!s},{name:"mouseJoint",type:"joint",mode:a,lm:n,sd:[4,1],autoDrive:!0,b1:o?this.selected.name:"mouse",b2:o?"mouse":this.selected.name,worldAnchor:r,visible:!1}])}return"grabbing"}moveSelect(e){if(null===this.selected)return;if(e&&this.tmpPos.copy(e).sub(this.decal),this.moveDeep){let e=this.selected.position.y,t=e-this.tmpPos.y;this.tmpPos.y=e,this.tmpD.set(0,0,t).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let t=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:t,reset:!0}):this.motor.change({name:"mouse",pos:e.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let e=this.motor.flow.key;if(0!==e[1]){let t=.1*e[1];this.dragPlane.translateZ(t),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class Wl extends s.Line{constructor(e={}){super(new s.BufferGeometry,this.motor.mat.get("line"));let t=.75;const i=[t,t,t,0,0,0];this.geometry.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new s.Float32BufferAttribute(i,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}class Kl{constructor(e){this.motor=e,this.convexBreaker=new ro,this.tmpI=new THREE.Vector3,this.tpos=new THREE.Vector3,this.tnormal=new THREE.Vector3,this.nDebris=0,this.maxDebris=300,this.tt=null}step(){let e;for(let t in this.motor.reflow.point)e=this.motor.reflow.point[t],0!==e.distance&&(this.makeBreak(e.b1,e.pos,e.normal,e.impulse,e.v1),this.makeBreak(e.b2,e.pos,e.normal,e.impulse,e.v2))}makeBreak(e,t,s,i,a){let r=this.motor.utils.byName(e);if(!r)return;if(!r.breakable)return;let o=r.breakOption;if(i<o[0])return;let n=this.convexBreaker.subdivideByImpact(r,this.tpos.fromArray(t),this.tnormal.fromArray(s),o[1],o[2]);if(n.length<1)return;o[3]-=1;const l={material:r.material,linearVelocity:[a[0],a[1],a[2]],angularVelocity:[a[3],a[4],a[5]],density:r.density};let h=[],c=n.length,A=0;for(;c--;)h.push(this.addDebris(n[A],o,l)),A++;this.tt=setTimeout((()=>{this.motor.remove(e),this.motor.add(h)}),0)}addDebris(e,t,s){let i=t[3]>0,a={...s,name:"debris_"+this.nDebris++,type:"convex",shape:e.geometry,pos:e.position.toArray(),quat:e.quaternion.toArray(),breakable:i,breakOption:t};return this.nDebris>this.maxDebris&&(this.nDebris=0),a}}new s.Vector3;const Jl=new s.Vector3,Yl=new s.Vector3,Xl=new s.Vector3,Zl=new s.Vector3,$l=new s.Vector3;class eh{constructor(e={},t){this.motor=t,this.name=e.name||"ppp",this.particles=[],this.density=.01,this.smoothingRadius=.2,this.speedOfSound=.1,this.viscosity=.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.tv=new s.Vector3,this.tv2=new s.Vector3}add(e){let t=this.motor.add({instance:this.name,type:"particle",flags:"noQuery",size:[.1],pSize:.03,pos:e,inertia:[0,0,0],mass:.001,restitution:0,friction:.5,damping:[.1,.1],material:"hide"});t.force=new s.Vector3,this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(e){let t=e.length;console.log(t);let s,i,a,r=[],o=0;for(;t--;)s=e[t],this.name,s[0],this.name,s[1],i=this.particles[s[0]].position,a=this.particles[s[1]].position,o=this.tv.copy(i).distanceTo(a),this.tv.copy(a).sub(i),r.push({type:"distance",helperSize:.03,b1:this.name+s[0],b2:this.name+s[1],limit:[.5*o,o],spring:[20,1],friction:0});this.motor.add(r)}getPosition(){let e,t,s=[],i=this.particles.length;for(;i--;)t=3*i,e=this.particles[i],s[t]=e.position.x,s[t+1]=e.position.y,s[t+2]=e.position.z;return s}getNeighbors(e,t){const s=this.particles.length,i=e.id,a=this.smoothingRadius*this.smoothingRadius;let r=0;for(let o=0;o!==s;o++){const s=this.particles[o];r=this.distance(s,e),i!==s.id&&r<a&&t.push(s)}}distance(e,t){const s=e.position.x-t.position.x,i=e.position.y-t.position.y,a=e.position.z-t.position.z;return s*s+i*i+a*a}w(e){const t=this.smoothingRadius;return 315/(64*Math.PI*t**9)*(t*t-e*e)**3}gradw(e,t){const s=e.length(),i=this.smoothingRadius;t.copy(e).multiplyScalar(945/(32*Math.PI*i**9)*(i*i-s*s)**2)}nablaw(e){const t=this.smoothingRadius;return 945/(32*Math.PI*t**9)*(t*t-e*e)*(7*e*e-3*t*t)}update(){const e=[],t=this.particles.length,s=this.speedOfSound,i=this.eps;let a,r=t;for(;r--;){const e=this.particles[r];e.force.set(0,0,0);const t=this.neighbors[r];t.length=0,this.getNeighbors(e,t),t.push(this.particles[r]);let i=0;for(a=t.length;a--;){const s=this.w(this.distance(e,t[a]));i+=t[a].mass*s}this.densities[r]=i,this.pressures[r]=s*s*(this.densities[r]-this.density)}const o=Jl,n=Yl,l=Xl,h=Zl,c=$l;for(r=t;r--;){const t=this.particles[r];let s,A;o.set(0,0,0),n.set(0,0,0);const d=this.neighbors[r];for(a=d.length;a--;){const e=d[a];h.copy(t.position).sub(e.position);const u=h.length();s=-e.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[a]/(this.densities[a]*this.densities[a]+i)),this.gradw(h,l),l.multiplyScalar(s),o.add(l),c.copy(e.velocity).sub(t.velocity),c.multiplyScalar(1/(1e-4+this.densities[r]*this.densities[a])*this.viscosity*e.mass),A=this.nablaw(u),c.multiplyScalar(A),n.add(c)}n.multiplyScalar(t.mass),o.multiplyScalar(t.mass),t.force.add(n),t.force.add(o),e.push({name:t.name,force:t.force.toArray()})}this.motor.change(e)}}const th=Math.PI/180,sh=[new s.Vector3(1,0,0),new s.Vector3(0,1,0),new s.Vector3(0,0,1)],ih=new s.Vector3,ah=new s.Vector3,rh=new s.Vector3,oh=new s.Vector3,nh=[],lh=[],hh=new s.Vector3,ch=new s.Vector3,Ah=new s.Vector3;new s.Matrix4;class dh{constructor(e={},t){this.motor=t,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=e.name||"car",this.mass=e.mass||1e3,this.size=e.size||[1.5,.7,3.8],this.pos=e.pos||[0,4,0],this.rot=e.rot||[0,0,0],this.friction=e.friction||.2,this.restitution=e.restitution||.3,this.massCenter=e.massCenter||[0,0,0],this.driveWheel=e.driveWheel||null;let i=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];e.shapeMesh&&(i=[{type:"convex",shape:e.shapeMesh.geometry,pos:e.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:i,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:e.bodyMesh||null,meshPos:e.meshPos||[0,-1.1,0],material:e.material,damping:[.05,.05],debug:!1}),this.body.inertia.set(283.33331298828125,333.33331298828125,83.33332824707031),this.vehicle=new uh({chassis:this.body});let a=e.wheelPosition||[.61,0,1.2];const r=[new s.Vector3(-a[0],a[1],-a[2]),new s.Vector3(a[0],a[1],-a[2]),new s.Vector3(-a[0],a[1],a[2]),new s.Vector3(a[0],a[1],a[2])],o={radius:e.wheelRadius||.31,directionLocal:new s.Vector3(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new s.Vector3(1,0,0),chassisConnectionPointLocal:new s.Vector3(1,1,0)};let n,l,h;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),r.forEach((e=>{o.chassisConnectionPointLocal.copy(e),this.vehicle.addWheel(o)}));let c=this.motor.getMat("debug");if(e.wheelMesh?(l=e.wheelMesh,h=e.wheelMesh2?e.wheelMesh2:null,e.material&&(c=e.material||c,l.material=c,h&&(h.material=c))):(n=new s.CylinderGeometry(o.radius,o.radius,e.wheelDepth||.2),n.rotateZ(.5*Math.PI),l=new s.Mesh(n,c),h=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[h||l.clone(),l,h?h.clone():l.clone(),l.clone()];let e=this.vehicle.wheelMeshes.length,t=0;for(;e--;)this.body.add(this.vehicle.wheelMeshes[t++])}else m.matrixAutoUpdate=!1,h&&(h.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(h||m.clone()),this.motor.add(m),this.motor.add(h?h.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let e=this.motor.getDelta();this.motor.getAzimut();let t=this.motor.getKey();this.tmp.forwardForce=t[1],this.tmp.steerDirection=-1*t[0],this.tmp.brakeForce=1===t[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let s=Math.abs(this.vehicle.currentVehicleSpeedKmHour);s=Math.min(s,this.maxSpeed),this.maxSpeed;const i=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(i,0),this.vehicle.applyEngineForce(i,1),this.vehicle.applyEngineForce(i,2),this.vehicle.applyEngineForce(i,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(e),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*th)}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.vehicle&&this.vehicle.setWheels(e,this.extra[e])}})}}class uh{constructor(e){this.chassisBody=e.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:0,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:2,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(e={}){let t=new gh(e),s=this.wheelInfos.length-1;t.chassisBody=this.chassisBody;let i=t.suspensionRestLength+t.radius;return t.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+s,begin:t.chassisConnectionPointLocal.toArray(),end:[t.chassisConnectionPointLocal.x,-i,t.chassisConnectionPointLocal.z],callback:function(e){t.castRay(e)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(t),s}setWheels(e,t){let s,i=this.wheelInfos.length;for(;i--;)s=this.wheelInfos[i],s[e]&&(s[e]=t)}setSteeringValue(e,t){this.wheelInfos[t].steering=e}applyEngineForce(e,t){this.wheelInfos[t].engineForce=e}setBrake(e,t){this.wheelInfos[t].brake=e}getVehicleAxisWorld(e,t){return t.set(0===e?1:0,1===e?1:0,2===e?1:0),kh(t,Ch(this.chassisBody,new s.Matrix4),t),t}updateVehicle(e){let t=this.wheelInfos,i=t.length,a=this.chassisBody,r=i;for(;r--;)this.updateWheelTransform(r);const o=vh(a,new s.Vector3),n=Qh(o,Ch(a,new s.Matrix4).invert(),new s.Vector3);this.currentVehicleSpeedKmHour=n.z;let l=new s.Vector3;this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(a.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(e);let h=new s.Vector3;for(new s.Vector3,r=0;r<i;r++){let s=t[r],i=s.suspensionForce;i>s.maxSuspensionForce&&(i=s.maxSuspensionForce),h.copy(s.raycastResult.hitNormalWorld).multiplyScalar(i*e),xh(a,h,s.raycastResult.hitPointWorld)}this.updateFriction(e);let c=new s.Vector3,A=new s.Vector3,d=new s.Vector3;for(r=0;r<i;r++){let s=t[r];Bh(a,s.chassisConnectionPointWorld,d);let i=1;if(1===this.indexUpAxis)i=-1;if(s.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,A);let t=Mh(A,s.raycastResult.hitNormalWorld);c.copy(s.raycastResult.hitNormalWorld).multiplyScalar(t),A.sub(c);let a=Mh(A,d);s.deltaRotation=i*a*e/s.radius}!s.sliding&&s.isInContact||0===s.engineForce||!s.useCustomSlidingRotationalSpeed||(s.deltaRotation=(s.engineForce>0?1:-1)*s.customSlidingRotationalSpeed*e),Math.abs(s.brake)>Math.abs(s.engineForce)&&(s.deltaRotation=0),s.rotation-=s.deltaRotation,s.deltaRotation*=.99}}updateSuspension(e){let t=this.chassisBody,s=bh(t),i=this.wheelInfos,a=i.length;for(let e=0;e<a;e++){let t=i[e];if(t.isInContact){let e,i=t.suspensionRestLength-t.suspensionLength;e=t.suspensionStiffness*i*t.clippedInvContactDotSuspension;let a,r=t.suspensionRelativeVelocity;a=r<0?t.dampingCompression:t.dampingRelaxation,e-=a*r,t.suspensionForce=e*s,t.suspensionForce<0&&(t.suspensionForce=0)}else t.suspensionForce=0}}updateFriction(e){let t,i,a,r=oh,o=this.wheelInfos,n=o.length,l=this.chassisBody,h=nh,c=lh;for(t=0;t<n;t++)if(i=o[t],a=i.raycastResult.body,i.sideImpulse=0,i.forwardImpulse=0,h[t]||(h[t]=new s.Vector3),c[t]||(c[t]=new s.Vector3),a){let e=c[t],s=this.getWheelTransformWorld(t);Qh(sh[this.indexRightAxis],s,e);let o=i.raycastResult.hitNormalWorld,n=Mh(e,o);r.copy(o).multiplyScalar(n),e.sub(r).normalize(),Sh(o,e,h[t]),h[t].normalize(),i.sideImpulse=Oh(l,i.raycastResult.hitPointWorld,a,i.raycastResult.hitPointWorld,e),i.sideImpulse*=1}for(this.sliding=!1,t=0;t<n;t++){i=o[t],a=i.raycastResult.body;let s=0;if(i.slipInfo=1,a){let r=0,o=i.brake?i.brake:r;s=Th(l,a,i.raycastResult.hitPointWorld,h[t],o),s+=i.engineForce*e;let n=o/s;i.slipInfo*=n}if(i.forwardImpulse=0,i.skidInfo=1,a){i.skidInfo=1;let t=i.suspensionForce*e*i.frictionSlip,a=t*t;i.forwardImpulse=s;let r=.5*i.forwardImpulse/i.forwardAcceleration,o=1*i.sideImpulse/i.sideAcceleration,n=r*r+o*o;if(i.sliding=!1,n>a){this.sliding=!0,i.sliding=!0;let e=t/Math.sqrt(n);i.skidInfo*=e}}}if(this.sliding)for(let e=0;e<n;e++)i=o[e],0!==i.sideImpulse&&i.skidInfo<1&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(t=0;t<n;t++){i=o[t];let e=new s.Vector3;if(e.copy(i.raycastResult.hitPointWorld).sub(wh(l,new s.Vector3)),0!==i.forwardImpulse){let e=new s.Vector3;e.copy(h[t]).multiplyScalar(i.forwardImpulse),xh(l,e,i.raycastResult.hitPointWorld)}if(0!==i.sideImpulse){a=i.raycastResult.body,(new s.Vector3).copy(i.raycastResult.hitPointWorld).sub(wh(a,new s.Vector3));let r=new s.Vector3;r.copy(c[t]).multiplyScalar(i.sideImpulse),Qh(e,Ch(l,new s.Matrix4).invert(),e),e["xyz"[this.indexUpAxis]]*=i.rollInfluence,Qh(e,Ch(l,new s.Matrix4),e),xh(l,r,wh(l,new s.Vector3).add(e)),r.multiplyScalar(-1),xh(a,r,i.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(e){const t=this.chassisBody.matrixWorld;kh(e.chassisConnectionPointLocal,t,e.chassisConnectionPointWorld),Qh(e.directionLocal,t,e.directionWorld)}updateWheelTransform(e){let t=hh,i=ch,a=Ah,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),t.copy(r.directionLocal).multiplyScalar(-1),i.copy(r.axleLocal),Sh(t,i,a),a.normalize(),i.normalize();let o=r.steering,n=new s.Quaternion;Rh(t,o,n);let l=new s.Quaternion;Rh(i,r.rotation,l);let h=r.quaternion;Ih(this.chassisBody,h),h.multiply(n).multiply(l).normalize();let c=r.position;c.copy(r.directionWorld),c.multiplyScalar(r.suspensionLength);let A=c.clone();c.add(r.chassisConnectionPointWorld),r.matrix.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.localWheel?(A.add(r.chassisConnectionPointLocal),this.wheelMeshes[e].quaternion.copy(n).multiply(l).normalize(),this.wheelMeshes[e].position.copy(A),this.brakeMeshs&&(2!==e&&3!==e||this.brakeMeshs[e].quaternion.copy(n).normalize(),this.brakeMeshs[e].position.copy(A),this.brakeMeshs[e].updateMatrix())):(this.wheelMeshes[e].position.copy(r.position),this.wheelMeshes[e].quaternion.copy(r.quaternion),this.wheelMeshes[e].updateMatrix())}getWheelTransformWorld(e){return this.wheelInfos[e].matrix}}var ph=new s.Vector3,mh=new s.Vector3;class gh{constructor(e){e=((e,t)=>{for(var s in e=e||{},t)s in e||(e[s]=t[s]);return e})(e,{chassisConnectionPointLocal:new s.Vector3,chassisConnectionPointWorld:new s.Vector3,directionLocal:new s.Vector3,directionWorld:new s.Vector3,axleLocal:new s.Vector3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointLocal.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionLocal.clone(),this.axleLocal=e.axleLocal.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.forwardAcceleration=e.forwardAcceleration,this.sideAcceleration=e.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new fh,this.position=(new s.Vector3).copy(this.chassisConnectionPointLocal),this.quaternion=new s.Quaternion,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new s.Matrix4}castRay(e){if(e.hit){this.isInContact=!0;let s=e.distance;this.raycastResult.hitPointWorld.fromArray(e.point),this.raycastResult.hitNormalWorld.fromArray(e.normal),this.raycastResult.body=this.motor.byName(e.body),this.suspensionLength=s-this.radius;let i=this.suspensionRestLength-this.maxSuspensionTravel,a=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<i&&(this.suspensionLength=i),this.suspensionLength>a&&(this.suspensionLength=a,this.raycastResult.reset());let r=Mh(this.raycastResult.hitNormalWorld,this.directionWorld);Bh(this.chassisBody,this.raycastResult.hitPointWorld,ph);var t=Mh(this.raycastResult.hitNormalWorld,ph);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/r;this.suspensionRelativeVelocity=t*e,this.clippedInvContactDotSuspension=e}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(e){let t=this.raycastResult;if(this.isInContact){let s=t.hitNormalWorld.dot(t.directionWorld);mh.copy(t.hitPointWorld).sub(e.position),Bh(e,mh,ph);let i=t.hitNormalWorld.dot(ph);if(s>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/s;this.suspensionRelativeVelocity=i*e,this.clippedInvContactDotSuspension=e}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.hitNormalWorld.copy(t.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class fh{constructor(){this.body=null,this.hitPointWorld=new s.Vector3,this.hitNormalWorld=new s.Vector3,this.directionWorld=new s.Vector3}reset(){this.body=null,this.hitPointWorld=new s.Vector3,this.hitNormalWorld=new s.Vector3,this.directionWorld=new s.Vector3}}const bh=e=>e.mass,yh=e=>e.mass>0?1/e.mass:0,wh=(e,t)=>t.copy(e.position),vh=(e,t)=>t.copy(e.velocity),Ch=(e,t)=>t.copy(e.matrixWorld),Ih=(e,t)=>t.copy(e.quaternion),xh=(e,t,s)=>{(void 0).motor.change({name:e.name,impulse:t.toArray(),impulseCenter:s.toArray()})},Bh=(e,t,s)=>(s.copy(t).sub(e.position),s.crossVectors(e.angular,s),s.add(e.velocity),s),Eh=(e,t)=>(t.copy(e.inertia),Qh(t,e.matrixWorld,t),t.x=t.x>0?1/t.x:0,t.y=t.y>0?1/t.y:0,t.z=t.z>0?1/t.z:0,t),Mh=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,Sh=(e,t,s)=>{const i=e.y*t.z-e.z*t.y,a=e.z*t.x-e.x*t.z,r=e.x*t.y-e.y*t.x;return s.set(i,a,r),s},kh=(e,t,s)=>{const i=e.x,a=e.y,r=e.z,o=t.elements,n=i*o[0]+a*o[4]+r*o[8]+o[12],l=i*o[1]+a*o[5]+r*o[9]+o[13],h=i*o[2]+a*o[6]+r*o[10]+o[14],c=1/(i*o[3]+a*o[7]+r*o[11]+o[15]);return s.x=n*c,s.y=l*c,s.z=h*c,s},Qh=(e,t,s)=>{const i=e.x,a=e.y,r=e.z,o=t.elements;return s.x=i*o[0]+a*o[4]+r*o[8],s.y=i*o[1]+a*o[5]+r*o[9],s.z=i*o[2]+a*o[6]+r*o[10],s},Rh=(e,t,s)=>{const i=Math.sin(t/2);return e.normalize(),s.w=Math.cos(t/2),s.x=e.x*i,s.y=e.y*i,s.z=e.z*i,s};function Th(e,t,s,i,a){var r=0,o=s,n=ih,l=ah,h=rh;Bh(e,o,n),Bh(t,o,l),h.copy(n).sub(l);return a<(r=-Mh(i,h)*(1/(_h(e,s,i)+_h(t,s,i))))&&(r=a),r<-a&&(r=-a),r}var Fh=new s.Vector3,Dh=new s.Vector3,Lh=new s.Vector3,Ph=new s.Vector3;function _h(e,t,i){var a=Fh,r=Dh,o=Lh,n=Ph;return a.copy(t).sub(wh(e,new s.Vector3)),Sh(a,i,r),n.copy(Eh(e,new s.Vector3)).multiply(r),Sh(n,a,o),yh(e)+Mh(i,o)}var Gh=new s.Vector3,zh=new s.Vector3,Uh=new s.Vector3;function Oh(e,t,s,i,a){if(a.lengthSq()>1.1)return 0;let r=Gh,o=zh,n=Uh;return Bh(e,t,r),Bh(s,i,o),n.copy(r).sub(o),-.1*Mh(a,n)*(1/(yh(e)+yh(s)))}const Nh={sunPosition:new s.Vector3(.27,1,.5),sunTop:new s.Vector3(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new s.Color(16777209).multiplyScalar(1),skyColor:new s.Color(4348022),fogColor:new s.Color(11253184),groundColor:new s.Color(8421504),sunColor:new s.Color(16777215).multiplyScalar(3)},Vh={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:Nh.sunPosition},sunTop:{value:Nh.sunTop},noiseMap:{value:Nh.noiseMap},mixRatio:{value:Nh.mixRatio},cloud_size:{value:Nh.cloud_size},cloud_covr:{value:Nh.cloud_covr},cloud_dens:{value:Nh.cloud_dens},cloud_dist:{value:Nh.cloud_dist},nightLuminosity:{value:Nh.nightLuminosity},haze:{value:Nh.haze},saturation:{value:Nh.saturation},SAMPLE:{value:Nh.SAMPLE},STEP:{value:Nh.STEP},fogy:{value:Nh.fogy},t:{value:1},fogColor:{value:Nh.fogColor},groundColor:{value:Nh.groundColor},cloudColor:{value:Nh.cloudColor},skyColor:{value:Nh.skyColor},sunColor:{value:Nh.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},qh=Math.PI/180;class Hh{constructor(e={}){this.mainScene=e.scene,this.renderer=e.renderer,this.usePrem=void 0!==e.usePmrem&&e.usePmrem,this.useBackground=void 0===e.useBackground||e.useBackground,this.envBlur=void 0!==e.envBlur?e.envBlur:0,this.callback=e.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new s.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader()),e.cube&&this.initCubeEnv(e),e.url&&this.load(e.url)}initCubeEnv(e={}){this.isCubeEnv=!0,this._quality=e.quality||1,this.scene=new s.Scene,e.color&&(this.scene.background=new s.Color(e.color)),this.target=new s.WebGLCubeRenderTarget(256*this._quality,{minFilter:s.LinearFilter,type:s.HalfFloatType,colorSpace:s.SRGBColorSpace,anisotropy:1}),this.camera=new s.CubeCamera(e.near||.1,e.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let e=new s.IcosahedronGeometry(20,1);const t=new s.ShaderMaterial(Vh);this.sky=new s.Mesh(e,t),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return Nh}setSkyOtion(e){if(!this.isSky)return;let t=this.sky.material.uniforms;for(let s in e)t[s]&&(t[s].value=e[s]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const e=this.renderer,t=e.toneMapping;e.toneMapping=s.NoToneMapping,this.camera.update(e,this.scene),e.toneMapping=t}load(e){switch(this.name=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),this.type=e.substring(e.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new Ba).load(e,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new Ea).load(e,this.end.bind(this),null,this.bug.bind(this));break;case"jpg":this.loader=new cn(this.renderer).load(e,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let e;switch(this.type){case"hdr":case"exr":e=this.loader,e.mapping=s.EquirectangularReflectionMapping;break;case"jpg":e=this.loader.renderTarget.texture,e.mapping=s.EquirectangularReflectionMapping}this.usePrem&&(e=this.pmremGenerator.fromEquirectangular(e).texture,this.pmremGenerator.dispose()),e.needsUpdate=!0;const t=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(t.background=e),this.envBlur&&(t.backgroundBlurriness=this.envBlur),t.environment=e,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(e){this.mainScene.environmentIntensity=e}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(e){this.mainScene.backgroundIntensity=e}get blur(){return this.mainScene.backgroundBlurriness}set blur(e){this.mainScene.backgroundBlurriness=e}rotate(e=0,t=0,s=0){0!==e&&(e*=qh),0!==t&&(t*=qh),0!==s&&(s*=qh),this.mainScene.environmentRotation.set(e,t,s),this.mainScene.backgroundRotation.set(e,t,s)}}class jh{constructor(e={},t){this.utils=t,this.id=0,this.type="autoRagdoll",this.name=e.name||this.type+this.id++;let s=this.utils.byName(this.name);s&&this.utils.remove(s),this._mode=e.mode||"follow",this._size=e.size||1,this._debug=e.debug||!1;const i=hs(e.model);let a;i.scale.set(1,1,1).multiplyScalar(this._size),e.pos&&i.position.fromArray(e.pos),i.raycast=function(){},i.name=this.name,i.traverse((t=>{t.isMesh&&(t.frustumCulled=!1),t.isSkinnedMesh&&(t.raycast=function(){},t.frustumCulled=!1,t.matrixAutoUpdate=!1,t.receiveShadow=!0,t.castShadow=!0,e.material&&(t.material=e.material),t.skeleton.resetScalling(),a=t.skeleton.bones)}));let r=e.mass||null;return this.skeletonBody=new Dl(i.name,i,a,r,e.option),this.debug=this._debug,this.mode=this._mode,i.add(this.skeletonBody),this.model=i,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(e){this._size=e,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(e){this._debug=e,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(e){this._mode=e,this.skeletonBody.setMode(this._mode)}}const Wh={PHY:"0.2.9",PHYSX:"5.06.00",HAVOK:"1.2.1",JOLT:"0.33.0",RAPIER:"0.14.0",OIMO:"1.2.4",AMMO:"3.2.6"};class Kh extends wl{constructor(e){super(e),this.type="solid"}step(){}}class Jh{constructor(e){this.map=new Map,this.motor=e}byName(e){return this.map.has(e)?this.map.get(e):null}add(e,t){if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else if(e.isButton)this.motor.scene.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(e);break;default:this.motor.scene.add(e)}e.isInstance&&e.refName!==e.name&&this.map.set(e.refName,e),this.map.set(e.name,e)}remove(e){e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.isInstance&&(e.refName!==e.name&&this.map.delete(e.refName),e.instance.remove(e.id)),this.map.delete(e.name)}noRay(e){e.isObject3D&&(e.raycast=()=>{},e.traverse((e=>{e.isObject3D&&(e.raycast=()=>{})})))}morph(e,t,s){e.morphTargetInfluences&&void 0!==e.morphTargetDictionary[t]&&(e.morphTargetInfluences[e.morphTargetDictionary[t]]=s)}toLocal(e,t,s=!1){s||e.sub(t.position);let i=t.quaternion;return e.applyQuaternion({x:-i._x,y:-i._y,z:-i._z,w:i._w}),e}quatLocal(e,t){t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new s.Quaternion).fromArray(e),a=t.quaternion.clone().invert();return i.premultiply(a),i.normalize().toArray()}axisLocal(e,t){t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new Matrix3).setFromMatrix4(t.matrixWorld);return(new s.Vector3).fromArray(e).applyMatrix3(i).toArray()}quatToAngular(e,t){t[0]*=-1,t[1]*=-1,t[2]*=-1;let i,a=t[0]*e[3]+t[3]*e[0]+t[1]*e[2]-t[2]*e[1],r=t[1]*e[3]+t[3]*e[1]+t[2]*e[0]-t[0]*e[2],o=t[2]*e[3]+t[3]*e[2]+t[0]*e[1]-t[1]*e[0],n=t[3]*e[3]-t[0]*e[0]-t[1]*e[1]-t[2]*e[2],l=2*Math.acos(n),h=Math.sqrt(1-n*n);i=h<.001?[0,0,0]:[a/h,r/h,o/h];(new s.Vector3).fromArray(i).multiplyScalar(l/1)}refAxis(e,t){let i=(new s.Vector3).fromArray(t),a=new s.Vector3(1,0,0),r=new s.Vector3(0,1,0);Math.abs(t[1])>.9999||a.copy(i).cross(r).normalize(),r.copy(a).cross(i).normalize(),e.makeBasis(a,r,i)}}const Yh=rl,Xh=rl.math,Zh=rl.pool,$h=class{constructor(e={}){this.geo=new nl,this.mat=new dl,this.math=A,this.pool=wr,this.version=Wh.PHY,this.Version=Wh,this.engine="",this.jointVisible=!1,this.utils=new Jh(this),this.viewSize=null,this.debug=!1,this.delta=0;const t=this;let i=null,a=null,r=null,o=!1,n=!1,l=!1,h=!0,c=!1,d=null,u=!1,p={t1:0,t2:0,t3:0,t4:0},m=null,g=null,f=null,b=!1,y=!0,w=null,v=null,x=0,B=0,E="",M=null,S=null,k=null;const Q=new pl,R=new ul(60),T={start:0,end:0,startTime:""};let F=()=>0,D=()=>{},L=()=>{},P=()=>{},_=[],G=[],z=[];const U={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let O=null,N={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0},point:{},velocity:{}};const V={};this.items=()=>V,this.scene=null,this.scenePlus=null,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let e,t,s;for(e in this.tmpMesh){if(s=this.tmpMesh[e],s.children)for(t in s.children)this.disposeMesh(s.children[t]);this.disposeMesh(s),s.parent&&s.parent.remove(s)}for(e in this.tmpMesh=[],this.tmpTex)this.tmpTex[e].dispose();this.tmpTex=[]},this.disposeMesh=e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()},this.setStep=e=>{L=e},this.debugMode=e=>{this.setDebugMode(e)},this.setDebugMode=e=>{this.debug=e},this.useRealLight=e=>{this.mat.useRealLight(e)},this.getSetting=()=>U,this.setGravity=e=>{e&&(U.gravity=e),this.post({m:"setGravity",o:{gravity:U.gravity}})},this.set=(e={})=>{U.fixe=void 0===e.fixe||e.fixe,U.full=void 0!==e.full&&e.full,U.gravity=e.gravity?e.gravity:[0,-9.81,0],U.substep=e.substep?e.substep:2,U.fps=e.fps?e.fps:60,e.key&&P(),V.body.setFull(U.full),this.initArray(U.full),B=0,l=o,h=!l,this.jointVisible=e.jointVisible||!1,h&&R.setFramerate(U.fps);const t={...U,ArPos:N,isTimeout:l,outsideStep:h};this.post({m:"set",o:t})},this.activeMouse=(e,t)=>{m||(m=new jl(e,t,this))},this.mouseMode=(e,t)=>{m&&m.setMode(e,t)},this.getTime=()=>ul.now(),this.readTime=e=>ul.format_time(e),this.startTime=()=>T.startTime,this.getTimeTest=()=>p,this.setMaxFps=e=>{},this.getMouse=()=>m?m.mouse:null,this.setMaxAnisotropy=e=>{wr.maxAnisotropy=e},this.setAddControl=e=>{P=e},this.setPrevUpdate=e=>{},this.setPostUpdate=e=>{L=null!==e?e:()=>{}},this.setAzimut=e=>{F=e},this.setRenderer=e=>{S=e,wr.renderer=S},this.setKey=(e,t)=>Q.setKey(e,t),this.getKey=()=>Q.key,this.getKey2=()=>Q.key2,this.getAzimut=()=>F(),this.setContent=e=>{u||(k=e,k.add(this.scene),k.add(this.scenePlus),u=!0)},this.message=e=>{let s=e.data;s.Ar&&(O=s.Ar),s.reflow&&(this.reflow=s.reflow,this.reflow.stat.delta&&(B+=this.reflow.stat.delta)),t[s.m](s.o)},this.post=(e,t=null,s=!1)=>{o?(e.o&&("solver"===e.o.type&&(s=!0),void 0!==e.o.solver&&(s=!0)),s?r.postMessage(e,t):"add"===e.m?this.flow.add.push(e.o):"remove"===e.m?this.flow.remove.push(e.o):r.postMessage(e,t)):g({data:e})},this.autoRagdoll=e=>{const t=new jh(e,this.utils);return this.scene.add(t.model),t},this.byName=e=>this.utils.byName(e),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=e=>{this.viewSize=e},this.init=(e={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,T.start=ul.now();const i=e.compact||!1;let l=document.location.href.replace(/\/[^/]*$/,"/"),h=l.split("/");l=h[0]+"//"+h[2]+"/","https://lo-th.github.io/"===l&&(l="https://lo-th.github.io/phy/");let c=e.path||"";c+=i?"compact/":"build/";let A=e.type||"PHYSX",d=A.toLowerCase(),u=d.charAt(0).toUpperCase()+d.slice(1);if(this.engine=A,this.initItems(),wr.materialRoot=this.mat.set,this.mat.initExtandShader(),e.callback&&(a=e.callback,delete e.callback),o=e.worker||!1,this.scene=new s.Group,this.scene.name="phy_scene",this.scenePlus=new s.Group,this.scenePlus.name="phy_scenePlus",e.scene&&(this.setContent(e.scene),delete e.scene),e.renderer&&(this.setRenderer(e.renderer),delete e.renderer),E=e.envmap||"",i)wr.load(l+c+u+".hex",(function(){t.onCompactDone(e)}));else if(o){r=new Worker(l+c+u+".min.js"),r.postMessage=r.webkitPostMessage||r.postMessage,r.onmessage=this.message;let t=new ArrayBuffer(1);r.postMessage({m:"test",ab:t},[t]),n=!t.byteLength,e.isBuffer=n,this.initPhysics(e)}else e.devMode?this.preLoad(u,e,l):this.preLoadMin(u,e,l)},this.onCompactDone=e=>{let t=this.engine.toLowerCase(),s=t.charAt(0).toUpperCase()+t.slice(1),i=wr.get(s,"H");if(o){let t;try{t=new Blob([i],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,t=new BlobBuilder,t.append(i),t=t.getBlob()}r=new Worker(URL.createObjectURL(t)),r.postMessage=r.webkitPostMessage||r.postMessage,r.onmessage=this.message;let s=new ArrayBuffer(1);r.postMessage({m:"test",ab:s},[s]),n=!s.byteLength,e.isBuffer=n,this.initPhysics(e)}else{let s=t.toUpperCase();"RAPIER"===s&&(s="RAPIER3D");let a=document.createElement("script");a.language="javascript",a.type="text/javascript",a.charset="utf-8",a.async=!0,a.innerHTML=i,document.getElementsByTagName("head")[0].appendChild(a),g=window[s].engine.message,e.message=this.message,this.initPhysics(e)}},this.loadWasmDirect=(e,t,s,i)=>{let a=document.createElement("script");a.src=i+e,document.body.appendChild(a),a.onload=()=>{this.preLoad(s,t,i)}},this.preLoadMin=(e,t,s)=>{let i=s+"build/"+e+".min.js",a=e.toUpperCase();"RAPIER"===a&&(a="RAPIER3D");var r=new XMLHttpRequest;r.open("GET",i),r.overrideMimeType("text/javascript"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status){let e=document.createElement("script");e.language="javascript",e.type="text/javascript",e.charset="utf-8",e.async=!0,e.innerHTML=r.responseText,document.getElementsByTagName("head")[0].appendChild(e),g=window[a].engine.message,t.message=this.message,this.initPhysics(t)}else console.error("Couldn't load ["+e+"] ["+r.status+"]")}.bind(this),r.send(null)},this.preLoad=async(e,t,s)=>{let i=s+"build/"+e+".module.js";t.devMode&&(i=s+"src/"+e+".js");let a=await import(i);g=a.engine.message,t.message=this.message,this.initPhysics(t)},this.initPhysics=e=>{""===E?(this.post({m:"init",o:e}),c=!0):this.preloadEnvmap(e)},this.addEnvmap=e=>(M||(M=new Hh({renderer:S,scene:k,...e})),M),this.preloadEnvmap=e=>{M=new Hh({url:E,renderer:S,scene:k,usePmrem:e.usePmrem,useBackground:void 0===e.useBackground||e.useBackground,envBlur:void 0!==e.envBlur?e.envBlur:0,callback:()=>{E="",this.initPhysics(e)}})},this.getPause=()=>b,this.pause=e=>{e!==b&&(b=e,b?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:b}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=e=>{if(y)return y=!1,void e();_=[],i=null,f&&f.resetAll(),m&&m.unSelect(),D=e,L=function(){},this.clearText(),this.clearParticleSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.garbage=[],null!==d&&(d=null),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset"})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=e=>{this.reset(e)},this.resetCallback=()=>{D()},this.dispose=()=>{this.reset((()=>{r&&(r.terminate(),r=null),u&&(this.scene.parent.remove(this.scene),this.scenePlus.parent.remove(this.scenePlus),u=!1)}))},this.ready=()=>{T.end=ul.now(),T.startTime=ul.format_time(T.end-T.start),console.log("%c"+this.engine+" %c"+Wh[this.engine]+"%c | "+(o?"Worker":"Direct")+" "+T.startTime,"font-size:16px","font-size:12px","font-size:12px"),a&&a()},this.start=(e={})=>{this.post({m:"start",o:e})},this.morph=(e,t,s)=>{this.utils.morph(e,t,s)},this.getFps=()=>this.reflow.stat.fps,this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>B,this.setDelta=e=>{R.delta=e},this.getDelta=()=>R.delta,this.getElapsedTime=()=>R.elapsedTime,this.doStep=e=>{c&&h&&R.up(e)&&this.post({m:"step",o:e})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=Q.update(),this.flow.current=null!==i?i.name:"",this.stepItems(),null!==d&&d.step(),null!==i&&i.move(),m&&m.step();let e=h?R.delta:this.delta;L(e),this.changes(this.flow.tmp),n?this.post({m:"poststep",flow:this.flow,Ar:O},[O.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(e=!1)=>{N={...C(this.engine,e)}},this.takeControl=(e=null)=>{this.control(e)},this.control=(e=null)=>{null!==i?null===e?(i.isPlayer&&(i.isPlayer=!1),i=null):e!==i.name&&(i=this.byName(e),i&&(i.isPlayer=!0)):null!==e&&(i=this.byName(e),i&&(i.isPlayer=!0))},this.getAllBody=e=>V.body.list,this.initItems=()=>{V.body=new wl(t),V.ray=new gl(t),V.joint=new Cl(t),V.solid=new Kh(t),V.contact=new Il(t),V.terrain=new _l(t),V.character=new Pl(t),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(V.vehicle=new Bl(t)),"PHYSX"===this.engine&&(V.solver=new zl(t))},this.getBodyRef=()=>V.body,this.clearBody=()=>{V.body.reset()},this.resetItems=()=>{Object.values(V).forEach((e=>e.reset()))},this.stepItems=()=>{Object.values(V).forEach((e=>e.step(O,N[e.type]))),this.upInstance(),this.upButton()},this.upInstance=()=>{Object.values(this.instanceMesh).forEach((e=>e.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((e=>e.dispose())),this.instanceMesh={}},this.adds=(e=[],t=!1)=>{let s=e.length,i=0;for(;s--;)this.add(e[i++],t)},this.add=(e={},t=!1)=>{if(e.isObject3D)return this.addDirect(e);if(e.constructor===Array)return this.adds(e,t);if("container"===e.type)return new Hl(e,this);void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box"),void 0!==e.mode&&(e.type="joint");let s=I(e);"joint"===s&&void 0===e.mode&&(e.mode=e.type,e.type="joint");let i=V[s].add(e);return this.garbage.push(i.name),i},this.addDirect=e=>(this.scenePlus.add(e),this.tmpMesh.push(e),e),this.removes=(e=[],t)=>{let s=e.length,i=0;for(;s--;)this.remove(e[i++],t)},this.remove=(e,t=!1)=>{if(e.constructor===Array)return this.removes(e,t);let s=this.byName(e);null!==s?"autoRagdoll"!==s.type?(s.extraRemove&&s.extraRemove(),V[s.type].clear(s),this.post({m:"remove",o:{name:e,type:s.type}},null,t)):this.utils.remove(s):this.instanceMesh[e]&&V.body.clearInstance(e)},this.changes=(e=[],t=!1)=>{let s=e.length,i=0;for(;s--;)this.changeOne(e[i++],t)},this.change=(e,t=!1)=>{t?e instanceof Array?this.changes(e,!0):this.changeOne(e,!0):e instanceof Array?this.flow.tmp.push(...e):this.flow.tmp.push(e)},this.changeOne=(e={},t=!1)=>{if(e.heightData)return;let s=this.byName(e.name);if(null===s)return null;let i=s.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=A.quatFromEuler(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=A.toLocalQuatArray(e.localRot,s),delete e.localRot),i){case"terrain":s=V.terrain.set(e,s),t=!1;break;case"ray":s=V.ray.set(e,s),t=!1;break;case"character":s=V.character.set(e,s);break;case"solid":s=V.solid.set(e,s);break;case"joint":s=V.joint.set(e,s);break;case"body":s.isKinematic&&V.body.set(e,s),s.actif&&!s.sleep||V.body.set(e,s),e.sleep&&V.body.set(e,s)}t&&this.post({m:"change",o:e},null,t)},this.setControl=e=>{f=e,F=f.getAzimuthalAngle},this.getCurrentCharacterPosition=()=>f.followGroup.position,this.getCamera=(e={})=>f.object,this.setCamera=(e={})=>{f.moveCam(e)},this.follow=(e="",t={})=>{let s=null;"string"==typeof e||e instanceof String?s=""===e?null:this.byName(e):e.isObject3D&&(s=e),null===s?f.resetFollow():f.startFollow(s,t)},this.setTimeout=(e,t=0,s=!1)=>{s?w=setTimeout(e,t):(v=e,x=t,w=setTimeout(v,x))},this.playtimout=()=>{null!==v&&(w=setTimeout(v,x))},this.pausetimout=()=>{null!==w&&clearTimeout(w)},this.cleartimout=(e,t)=>{null!==w&&(v=null,x=0,clearTimeout(w),w=null)},this.texture=(e={})=>wr.texture(e),this.getTexture=(e,t={})=>wr.getTexture(e,t),this.setExtendShader=e=>{this.mat.extendShader=e},this.addMaterial=(e,t)=>{this.mat.set(e,t)},this.directIntensity=e=>{},this.setEnvmapIntensity=e=>{},this.getMatRef=()=>this.mat,this.getMat=e=>this.mat.get(e),this.getMaterial=e=>this.mat.get(e),this.getMaterialList=()=>this.mat.getList(),this.material=(e={})=>this.mat.create(e),this.changeRenderMode=e=>this.mat.changeRenderMode(e),this.load=wr.load,this.get=wr.get,this.getGroup=wr.getGroup,this.getScript=wr.getScript,this.preload=(e,t)=>{_r.add(e,t)},this.applyMorph=(e,t=null,s=!0,i=!0)=>{wr.applyMorph(e,null,!0,!0)},this.getMesh=(e,t,s)=>{if(t){let t=wr.getMaterials(e);for(let e in t)this.addMaterial(t[e])}return wr.getMesh(e,s)},this.getGlb=(e,t,s)=>{if(t){let t=wr.getMaterials(e);for(let e in t)this.addMaterial(t[e])}return wr.getGLB(e,s)},this.getGlbMaterial=e=>{let t=wr.getMaterials(e);return this.mat.addToMat(t),t},this.poolDispose=()=>wr.dispose(),this.setDracoPath=e=>wr.dracoPath=e,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addParticleSolver=e=>{let t=new eh(e,this);return z.push(t),t},this.updateParticleSolver=()=>{let e=z.length;for(;e--;)z[e].update()},this.clearParticleSolver=()=>{z.length,z=[]},this.addRayCar=e=>new dh(e,this),this.addButton=e=>{let t=new ql(e,this);return _.push(t),t},this.upButton=e=>{for(const e in _)_[e].update()},this.addText=e=>{let t=new Nl(e);return e.parent?e.parent.add(t):this.scenePlus.add(t),G.push(t),t},this.clearText=()=>{let e=G.length;for(;e--;)G[e].dispose();G=[]},this.screenshot=()=>{var e=window.open("","");e.document.title="Screenshot",e.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var t=new Image;S.render(k,this.getCamera()),t.src=S.domElement.toDataURL(),e.document.body.appendChild(t)},this.addBreaker=()=>{null===d&&(d=new Kl(this))},this.explosion=(e=[0,0,0],t=10,i=1)=>{let a=[],r=new s.Vector3;e&&(e.isVector3?r.copy(e):r.fromArray(e));let o,n,l=new s.Vector3,h=V.body.list.length;for(;h--;)o=V.body.list[h],l.copy(o.position).sub(r),n=1-l.length()/t,o.isKinematic||n<0||(l.setLength(n),l.multiplyScalar(i),a.push({name:o.name,impulse:l.toArray(),wake:!0}));this.change(a)}}set onStep(e){this.setStep(e)}};e.math=Xh,e.phy=Yh,e.phy2=$h,e.pool=Zh}));
