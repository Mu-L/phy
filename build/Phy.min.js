!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three"),require("three/addons/loaders/GLTFLoader.js"),require("three/addons/loaders/FBXLoader.js"),require("three/addons/loaders/OBJLoader.js"),require("three/addons/loaders/STLLoader.js"),require("three/addons/loaders/RGBELoader.js"),require("three/addons/loaders/EXRLoader.js"),require("three/addons/libs/meshopt_decoder.module.js"),require("three/addons/loaders/UltraHDRLoader.js"),require("three/addons/loaders/KTX2Loader.js")):"function"==typeof define&&define.amd?define(["exports","three","three/addons/loaders/GLTFLoader.js","three/addons/loaders/FBXLoader.js","three/addons/loaders/OBJLoader.js","three/addons/loaders/STLLoader.js","three/addons/loaders/RGBELoader.js","three/addons/loaders/EXRLoader.js","three/addons/libs/meshopt_decoder.module.js","three/addons/loaders/UltraHDRLoader.js","three/addons/loaders/KTX2Loader.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PHY={},t.THREE,t.GLTFLoader_js,t.FBXLoader_js,t.OBJLoader_js,t.STLLoader_js,t.RGBELoader_js,t.EXRLoader_js,t.meshopt_decoder_module_js,null,t.KTX2Loader_js)}(this,(function(t,e,i,s,r,a,n,l,h,c,u){"use strict";var d="undefined"!=typeof document?document.currentScript:null;const p=Math.PI,f=p/180,g=180/p,y=Number.EPSILON,v=.5*p,b={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:t=>Math.pow(t,5),candelaToLumens:t=>4*t*Math.PI,lumensToCandela:t=>t/(4*Math.PI),todeg:g,torad:f,toFixed:(t,e=3)=>1*t.toFixed(e),toRound:(t,e=3)=>Math.trunc(t),clamp:(t,e=0,i=1)=>t=(t=t<e?e:t)>i?i:t,clampA:(t,e,i)=>Math.max(e,Math.min(i,t)),smoothstep:(t,e,i)=>t*(i=-2*(i=b.clamp(i))*i*i+3*i*i)+e*(1-i),remap:(t,e,i,s,r)=>s+(t-e)*(r-s)/(i-e),lerp:(t,e,i)=>(1-i)*t+i*e,damp:(t,e,i,s)=>b.lerp(t,e,1-Math.exp(-i*s)),nearAngle:(t,e,i=!1)=>e+Math.atan2(Math.sin(t-e),Math.cos(t-e))*(i?g:1),unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),nearEquals:(t,e,i=1e-4)=>Math.abs(t-e)<=i,autoSize:(t=[1,1,1],e="box")=>{1===t.length&&(t[1]=t[0]);let i=t[0],s=t[1];return"sphere"===e&&(t=[i,i,i]),"cylinder"!==e&&"wheel"!==e&&"capsule"!==e||(t=[i,s,i]),"cone"!==e&&"pyramid"!==e||(t=[i,s,i]),2===t.length&&(t[2]=t[0]),t},shuffle:t=>{let e=t.map((t=>({value:t,sort:Math.random()}))).sort(((t,e)=>t.sort-e.sort)).map((({value:t})=>t));return e},randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),randIntUnic:(t,e,i)=>{for(var s=[];s.length<i;){var r=b.randInt(t,e);-1===s.indexOf(r)&&s.push(r)}return s},fromTransform:(t,e,i,s=[0,0,0,1],r=!1)=>{let o=b.composeMatrixArray(t,e),a=b.composeMatrixArray(i,s);return r&&(o=b.invertMatrixArray(o)),o=b.multiplyMatrixArray(o,a),[o[12],o[13],o[14]]},fromTransformToQ:(t,e,i=!1)=>{let s=b.composeMatrixArray(t,e),r=b.decomposeFullMatrixArray(s).q;return i&&(r=b.quatInvert(r)),r},lerpTransform:(t,e,i)=>{let s=t[0],r=t[1],o=e[0],a=e[1];return o=b.lerpArray(s,o,i),a=b.slerpQuatArray(r,a,i),[o,a]},composeMatrixArray:(t,e,i=[1,1,1])=>{const s=e[0],r=e[1],o=e[2],a=e[3],n=s+s,l=r+r,h=o+o,c=s*n,u=s*l,d=s*h,p=r*l,m=r*h,f=o*h,g=a*n,y=a*l,v=a*h,b=i[0],w=i[1],x=i[2];return[(1-(p+f))*b,(u+v)*b,(d-y)*b,0,(u-v)*w,(1-(c+f))*w,(m+g)*w,0,(d+y)*x,(m-g)*x,(1-(c+p))*x,0,t[0],t[1],t[2],1]},multiplyMatrixArray:(t,e)=>{const i=t,s=e,r=[],o=i[0],a=i[4],n=i[8],l=i[12],h=i[1],c=i[5],u=i[9],d=i[13],p=i[2],m=i[6],f=i[10],g=i[14],y=i[3],v=i[7],b=i[11],w=i[15],x=s[0],M=s[4],S=s[8],k=s[12],A=s[1],T=s[5],P=s[9],C=s[13],z=s[2],R=s[6],E=s[10],_=s[14],L=s[3],V=s[7],B=s[11],I=s[15];return r[0]=o*x+a*A+n*z+l*L,r[4]=o*M+a*T+n*R+l*V,r[8]=o*S+a*P+n*E+l*B,r[12]=o*k+a*C+n*_+l*I,r[1]=h*x+c*A+u*z+d*L,r[5]=h*M+c*T+u*R+d*V,r[9]=h*S+c*P+u*E+d*B,r[13]=h*k+c*C+u*_+d*I,r[2]=p*x+m*A+f*z+g*L,r[6]=p*M+m*T+f*R+g*V,r[10]=p*S+m*P+f*E+g*B,r[14]=p*k+m*C+f*_+g*I,r[3]=y*x+v*A+b*z+w*L,r[7]=y*M+v*T+b*R+w*V,r[11]=y*S+v*P+b*E+w*B,r[15]=y*k+v*C+b*_+w*I,r},invertMatrixArray:t=>{const e=t,i=e[0],s=e[1],r=e[2],o=e[3],a=e[4],n=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],m=e[12],f=e[13],g=e[14],y=e[15],v=u*g*h-f*d*h+f*l*p-n*g*p-u*l*y+n*d*y,b=m*d*h-c*g*h-m*l*p+a*g*p+c*l*y-a*d*y,w=c*f*h-m*u*h+m*n*p-a*f*p-c*n*y+a*u*y,x=m*u*l-c*f*l-m*n*d+a*f*d+c*n*g-a*u*g,M=i*v+s*b+r*w+o*x;if(0===M)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const S=1/M;return e[0]=v*S,e[1]=(f*d*o-u*g*o-f*r*p+s*g*p+u*r*y-s*d*y)*S,e[2]=(n*g*o-f*l*o+f*r*h-s*g*h-n*r*y+s*l*y)*S,e[3]=(u*l*o-n*d*o-u*r*h+s*d*h+n*r*p-s*l*p)*S,e[4]=b*S,e[5]=(c*g*o-m*d*o+m*r*p-i*g*p-c*r*y+i*d*y)*S,e[6]=(m*l*o-a*g*o-m*r*h+i*g*h+a*r*y-i*l*y)*S,e[7]=(a*d*o-c*l*o+c*r*h-i*d*h-a*r*p+i*l*p)*S,e[8]=w*S,e[9]=(m*u*o-c*f*o-m*s*p+i*f*p+c*s*y-i*u*y)*S,e[10]=(a*f*o-m*n*o+m*s*h-i*f*h-a*s*y+i*n*y)*S,e[11]=(c*n*o-a*u*o-c*s*h+i*u*h+a*s*p-i*n*p)*S,e[12]=x*S,e[13]=(c*f*r-m*u*r+m*s*d-i*f*d-c*s*g+i*u*g)*S,e[14]=(m*n*r-a*f*r-m*s*l+i*f*l+a*s*g-i*n*g)*S,e[15]=(a*u*r-c*n*r+c*s*l-i*u*l-a*s*d+i*n*d)*S,e},matrixArrayDeterminant:t=>{const e=t,i=e[0],s=e[4],r=e[8],o=e[12],a=e[1],n=e[5],l=e[9],h=e[13],c=e[2],u=e[6],d=e[10],p=e[14];return e[3]*(+o*l*u-r*h*u-o*n*d+s*h*d+r*n*p-s*l*p)+e[7]*(+i*l*p-i*h*d+o*a*d-r*a*p+r*h*c-o*l*c)+e[11]*(+i*h*u-i*n*p-o*a*u+s*a*p+o*n*c-s*h*c)+e[15]*(-r*n*c-i*l*u+i*n*d+r*a*u-s*a*d+s*l*c)},decomposeMatrixArray:t=>[t[12],t[13],t[14]],decomposeFullMatrixArray:t=>{const e=t;let i=b.lengthArray([e[0],e[1],e[2]]);const s=b.lengthArray([e[4],e[5],e[6]]),r=b.lengthArray([e[8],e[9],e[10]]);b.matrixArrayDeterminant(t)<0&&(i=-i);let o=[...t];const a=1/i,n=1/s,l=1/r;o[0]*=a,o[1]*=a,o[2]*=a,o[4]*=n,o[5]*=n,o[6]*=n,o[8]*=l,o[9]*=l,o[10]*=l;let h=b.quatFromRotationMatrix(o);return{p:[t[12],t[13],t[14]],q:h,s:[i,s,r]}},applyTransformArray:(t,e,i,s=[1,1,1])=>{const r=b.composeMatrixArray(e,i,s),o=t[0],a=t[1],n=t[2],l=1/(r[3]*o+r[7]*a+r[11]*n+r[15]);return[(r[0]*o+r[4]*a+r[8]*n+r[12])*l,(r[1]*o+r[5]*a+r[9]*n+r[13])*l,(r[2]*o+r[6]*a+r[10]*n+r[14])*l]},slerpQuatArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=[...t];const r=t[0],o=t[1],a=t[2],n=t[3],l=e[0],h=e[1],c=e[2],u=e[3];let d=n*u+r*l+o*h+a*c;if(d<0?(s=[-l,-h,-c,-u],d=-d):s=[...e],d>=1)return t;const p=1-d*d;if(p<=y){const t=1-i;return s[3]=t*n+i*s[3],s[0]=t*r+i*s[0],s[1]=t*o+i*s[1],s[2]=t*a+i*s[2],b.quatNomalize(s)}const m=Math.sqrt(p),f=Math.atan2(m,d),g=Math.sin((1-i)*f)/m,v=Math.sin(i*f)/m;return s[3]=n*g+s[3]*v,s[0]=r*g+s[0]*v,s[1]=o*g+s[1]*v,s[2]=a*g+s[2]*v,s},toLocalQuatArray:(t=[0,0,0],e)=>{let i=b.quatFromEuler(t),s=b.quatInvert(e.quaternion.toArray());return b.quatMultiply(s,i)},quatFromRotationMatrix:t=>{let e=[0,0,0,1];const i=t,s=i[0],r=i[4],o=i[8],a=i[1],n=i[5],l=i[9],h=i[2],c=i[6],u=i[10],d=s+n+u;if(d>0){const t=.5/Math.sqrt(d+1);e[3]=.25/t,e[0]=(c-l)*t,e[1]=(o-h)*t,e[2]=(a-r)*t}else if(s>n&&s>u){const t=2*Math.sqrt(1+s-n-u);e[3]=(c-l)/t,e[0]=.25*t,e[1]=(r+a)/t,e[2]=(o+h)/t}else if(n>u){const t=2*Math.sqrt(1+n-s-u);e[3]=(o-h)/t,e[0]=(r+a)/t,e[1]=.25*t,e[2]=(l+c)/t}else{const t=2*Math.sqrt(1+u-s-n);e[3]=(a-r)/t,e[0]=(o+h)/t,e[1]=(l+c)/t,e[2]=.25*t}return e},quatFromEuler:(t=[0,0,0],e=!0)=>{const i=Math.cos,s=Math.sin,r=e?f:1,o=t[0]*r*.5,a=t[1]*r*.5,n=t[2]*r*.5,l=i(o),h=i(a),c=i(n),u=s(o),d=s(a),p=s(n);return[u*h*c+l*d*p,l*d*c-u*h*p,l*h*p+u*d*c,l*h*c-u*d*p]},quatFromAxis:(t=[0,0,0],e,i=!0)=>{const s=.5*e*(i?f:1),r=Math.sin(s);return[t[0]*r,t[1]*r,t[2]*r,Math.cos(s)]},quatNomalize:t=>{let e=b.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,b.scaleArray(t,e,4))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const i=t[0],s=t[1],r=t[2],o=t[3],a=e[0],n=e[1],l=e[2],h=e[3];return[i*h+o*a+s*l-r*n,s*h+o*n+r*a-i*l,r*h+o*l+i*n-s*a,o*h-i*a-s*n-r*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const i=Math.sqrt(1-t[3]*t[3]);return i<1e-4?[1,0,0]:[t[0]/i,t[1]/i,t[2]/i,e]},eulerFromMatrix:t=>{const e=t[0],i=t[4],s=t[8];t[1];const r=t[5],o=t[9];t[2];const a=t[6],n=t[10];let l=[0,0,0];return l[1]=Math.asin(b.clamp(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(-o,n),l[2]=Math.atan2(-i,e)):(l[0]=Math.atan2(a,r),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(b.clamp(b.dotArray(t,e),-1,1))),fixedArray:(t,e)=>{let i=t.length,s=[];for(;i--;)s[i]=b.toFixed(t[i],e);return s},getSize:t=>.001*t.byteLength+"kb",perpendicularArray:t=>{const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);let i=Math.acos(t[1]/e);const s=Math.atan2(t[2],t[0]);i>v?i-=v:i+=v;return[e*Math.sin(i)*Math.cos(s),e*Math.cos(i),e*Math.sin(i)*Math.sin(s)]},crossArray:(t,e)=>{const i=t[0],s=t[1],r=t[2],o=e[0],a=e[1],n=e[2];return[s*n-r*a,r*o-i*n,i*a-s*o]},applyQuaternion:(t,e)=>{const i=t[0],s=t[1],r=t[2],o=e[0],a=e[1],n=e[2],l=e[3],h=2*(a*r-n*s),c=2*(n*i-o*r),u=2*(o*s-a*i);return[i+l*h+a*u-n*c,s+l*c+n*h-o*u,r+l*u+o*c-a*h]},nullArray:(t,e,i)=>{let s=0;for(;i--;)s+=t[e+i];return s},equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},lerpArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=t.length,r=[];for(;s--;)r[s]=t[s],r[s]+=(e[s]-r[s])*i;return r},zeroArray:(t,e=0,i)=>{for(i=i??t.length;i--;)t[e+i]=0;return t},lengthArray:t=>{let e=t.length,i=0;for(;e--;)i+=t[e]*t[e];return Math.sqrt(i)},dotArray:(t,e)=>{let i=t.length,s=0;for(;i--;)s+=t[i]*e[i];return s},addArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]+e[i];return s},subArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]-e[i];return s},mulArray:(t,e,i)=>{if(e instanceof Array){let s=[];for(i=i??t.length;i--;)s[i]=t[i]*e[i];return s}return t.map((t=>t*e))},worldscale:(t,e)=>t.map((t=>t*e)),divArray:(t,e,i)=>b.mulArray(t,1/e,i),scaleArray:(t,e,i)=>b.mulArray(t,e,i),fillArray:(t,e,i=0,s)=>{for(s=s??t.length;s--;)e[i+s]=t[s]},copyArray:(t,e)=>{},cloneArray:t=>[...t],distanceArray:(t,e=[0,0,0])=>b.lengthArray(b.subArray(t,e)),normalizeArray:t=>b.divArray(t,b.lengthArray(t)||1),normalArray:(t,e=[0,0,0])=>b.normalizeArray(b.subArray(e,t)),getCenter:(t,e)=>(t.computeBoundingBox(),t.boundingBox.getCenter(e)),getVolume:(t,e,i=null)=>{let s=1,r=e;switch(t){case"sphere":s=4*Math.PI*r[0]*r[0]*r[0]/3;break;case"cone":s=Math.PI*r[0]*(.5*r[1])*2;break;case"box":s=.5*r[0]*8*(.5*r[1])*(.5*r[2]);break;case"cylinder":s=Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"capsule":s=4*Math.PI*r[0]*r[0]*r[0]/3+Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"convex":case"mesh":s=b.getConvexVolume(i)}return s},getConvexVolume:t=>{let e,i=t.length/3,s=[0,0,0],r=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>r[0]&&(r[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>r[1]&&(r[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>r[2]&&(r[2]=t[e+2]);let o=[r[0]-s[0],r[1]-s[1],r[2]-s[2]];return.5*o[0]*8*(.5*o[1])*(.5*o[2])},massFromDensity:(t,e)=>t*e,densityFromMass:(t,e)=>t/e,toNonIndexed:t=>t.index?t.clone().toNonIndexed():t,getIndex:(t,e)=>!t.index||e?null:t.index.array||null,getSameVertex:t=>{const e=t.getAttribute("position"),i=e.array,s=[],r=[],o={};new THREE.Vector3;let a,n=0;b.getHash(t);let l,h,c=!1,u=0;for(let t=0;t<e.count;t++){n=3*t,l={x:i[n],y:i[n+1],z:i[n+2],id:t},c=!1,a=s.length;for(let e=0;e<a;e++)h=s[e],l.x===h.x&&l.y===h.y&&l.z===h.z&&(c=!0,o[t]=h.id);c||(l.id=u++,s.push(l),r.push([l.x,l.y,l.z]))}return[r,o]},getVertex:(t,e)=>{let i=t.attributes.position.array;return e&&t.index&&(i=(t=t.clone().toNonIndexed()).attributes.position.array),i},getNormal:t=>t.attributes.normal.array,getFaces:t=>{let e=[];if(t.index){let i=t.getIndex();for(let t=0;t<i.count;t+=3)e.push([i.getX(t),i.getX(t+1),i.getX(t+2)])}else{let i=t.getAttribute("position").count;for(let t=0;t<i;t+=3)e.push([t,t+1,t+2])}return e},getConnectedFaces:t=>{const e=[];let i,s,r,o,a,n,l,h=t.length,c=h;for(;c--;)for(s=t[c],i=h;i--;)i!==c&&(r=t[i],o=s.filter((t=>r.includes(t))),o.length>1&&(l=[],a=[...s],n=a.indexOf(o[0]),a.splice(n,1),n=a.indexOf(o[1]),a.splice(n,1),l.push(a[0]),a=[...r],n=a.indexOf(o[0]),a.splice(n,1),n=a.indexOf(o[1]),a.splice(n,1),l.push(a[0]),e.push(l)));return e},reduce:t=>{},barycentric:(t,e)=>{},solve:(t,e)=>{},getHash:(t,e=1e-4)=>{e=Math.max(e,Number.EPSILON);const i={},s={},r=t.getAttribute("position"),o=r.count,a=r.array,n=.5*e,l=Math.log10(1/e),h=Math.pow(10,l),c=n*h;let u;for(let t=0;t<o;t++){u=3*t;let e=`${~~(a[u]*h+c)},${~~(a[u+1]*h+c)},${~~(a[u+2]*h+c)}`;i[e]?i[e].push(t):i[e]=[t]}let d=0;for(let t in i)s[d++]=i[t];return s}},w=b,x=new WeakMap;class M extends e.Loader{constructor(t){super(t),this.useLocal=!1,this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setUseLocal(t){return this.useLocal=t,this}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,i,s,r){const o=new e.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(t=>{this.parse(t,i,r)}),s,r)}parse(t,i,s){this.decodeDracoFile(t,i,null,null,e.SRGBColorSpace).catch(s)}decodeDracoFile(t,i,s,r,o=e.LinearSRGBColorSpace){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:r||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:o};return this.decodeGeometry(t,a).then(i)}decodeGeometry(t,e){const i=JSON.stringify(e);if(x.has(t)){const e=x.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const r=this.workerNextTaskID++,o=t.byteLength,a=this._getWorker(r,o).then((i=>(s=i,new Promise(((i,o)=>{s._callbacks[r]={resolve:i,reject:o},s.postMessage({type:"decode",id:r,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return a.catch((()=>!0)).then((()=>{s&&r&&this._releaseTask(s,r)})),x.set(t,{key:i,promise:a}),a}_createGeometry(t){const i=new e.BufferGeometry;t.index&&i.setIndex(new e.BufferAttribute(t.index.array,1));for(let s=0;s<t.attributes.length;s++){const r=t.attributes[s],o=r.name,a=r.array,n=r.itemSize,l=new e.BufferAttribute(a,n);"color"===o&&(this._assignVertexColorSpace(l,r.vertexColorSpace),l.normalized=a instanceof Float32Array==!1),i.setAttribute(o,l)}return i}_assignVertexColorSpace(t,i){if(i!==e.SRGBColorSpace)return;const s=new e.Color;for(let e=0,i=t.count;e<i;e++)s.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,s.r,s.g,s.b)}_loadLibrary(t,i){const s=new e.FileLoader(this.manager);return s.setPath(this.decoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_decoder.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),"text"))):t.push(this._loadLibrary("draco_decoder.js","text")):this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_wasm_wrapper.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),"text"))):t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(t).then((t=>{const e=t[0],i=S.toString(),s=["/* draco decoder */",e,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function S(){let t,e;function i(t,e,i,s,r,o){const a=o.num_components(),n=i.num_points()*a,l=n*r.BYTES_PER_ELEMENT,h=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,r),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(i,o,h,l,c);const u=new r(t.HEAPF32.buffer,c,n).slice();return t._free(c),{name:s,array:u,itemSize:a}}onmessage=function(s){const r=s.data;switch(r.type){case"init":t=r.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const s=r.buffer,o=r.taskConfig;e.then((t=>{const e=t.draco,a=new e.Decoder;try{const t=function(t,e,s,r){const o=r.attributeIDs,a=r.attributeTypes;let n,l;const h=e.GetEncodedGeometryType(s);if(h===t.TRIANGULAR_MESH)n=new t.Mesh,l=e.DecodeArrayToMesh(s,s.byteLength,n);else{if(h!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new t.PointCloud,l=e.DecodeArrayToPointCloud(s,s.byteLength,n)}if(!l.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const s in o){const l=self[a[s]];let h,u;if(r.useUniqueIDs)u=o[s],h=e.GetAttributeByUniqueId(n,u);else{if(u=e.GetAttributeId(n,t[o[s]]),-1===u)continue;h=e.GetAttribute(n,u)}const d=i(t,e,n,s,l,h);"color"===s&&(d.vertexColorSpace=r.vertexColorSpace),c.attributes.push(d)}h===t.TRIANGULAR_MESH&&(c.index=function(t,e,i){const s=i.num_faces(),r=3*s,o=4*r,a=t._malloc(o);e.GetTrianglesUInt32Array(i,o,a);const n=new Uint32Array(t.HEAPF32.buffer,a,r).slice();return t._free(a),{array:n,itemSize:1}}(t,e,n));return t.destroy(n),c}(e,a,new Int8Array(s),o),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:t},n)}catch(t){console.error(t),self.postMessage({type:"error",id:r.id,error:t.message})}finally{e.destroy(a)}}))}}}let k=0;class A extends u.KTX2Loader{constructor(t){super(t),this.useLocal=!1}setUseLocal(t){return this.useLocal=t,this}_loadLibrary(t,i){const s=new e.FileLoader(this.manager);return s.setPath(this.transcoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}init(){if(!this.transcoderPending){let t,e;this.useLocal?(this.transcoderPath="",t=this._loadLibrary(new URL("../build/basis/basis_transcoder.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),"text"),e=this._loadLibrary(new URL("../build/basis/basis_transcoder.wasm","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),"arraybuffer")):(t=this._loadLibrary("basis_transcoder.js","text"),e=this._loadLibrary("basis_transcoder.wasm","arraybuffer")),this.transcoderPending=Promise.all([t,e]).then((([t,e])=>{const i=A.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(A.EngineFormat),"let _EngineType = "+JSON.stringify(A.EngineType),"let _TranscoderFormat = "+JSON.stringify(A.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(A.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=e,this.workerPool.setWorkerCreator((()=>{const t=new Worker(this.workerSourceURL),e=this.transcoderBinary.slice(0);return t.postMessage({type:"init",config:this.workerConfig,transcoderBinary:e},[e]),t}))})),k>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),k++}return this.transcoderPending}}var T=function(){var t,e=0x10000000000000000,i=4294967295,s=2147483647;function r(t){var e=[];return e[t-1]=void 0,e}function o(t,e){return n(t[0]+e[0],t[1]+e[1])}function a(t,e){var i,s;return t[0]==e[0]&&t[1]==e[1]?0:(i=0>t[1],s=0>e[1],i&&!s?-1:!i&&s?1:function(t,e){return n(t[0]-e[0],t[1]-e[1])}(t,e)[1]<0?-1:1)}function n(t,s){var r,o;for(t%=e,s=(s%=e)-(r=s%I)+(o=Math.floor(t/I)*I),t=t-o+r;0>t;)t+=I,s-=I;for(;t>i;)t-=I,s+=I;for(s%=e;s>0x7fffffff00000000;)s-=e;for(;-0x10000000000000000>s;)s+=e;return[t,s]}function l(t){return t>=0?[t,0]:[t+I,-4294967296]}function h(t){return t[0]>=2147483648?~~Math.max(Math.min(t[0]-I,s),-2147483648):~~Math.max(Math.min(t[0],s),-2147483648)}function c(t){return t.cb>=t.O?-1:255&t.ab[t.cb++]}function u(t){var e=t.ab;return e.length=t.O,e}function d(t,e,s){var r,o,a,n,h="",u=[];for(o=0;5>o;++o){if(-1==(a=c(e)))throw Error("truncated input");u[o]=a<<24>>24}if(!function(t,e){var i,s,r,o,a,n,l;if(5>e.length)return 0;for(l=255&e[0],r=l%9,o=(n=~~(l/9))%5,a=~~(n/5),i=0,s=0;4>s;++s)i+=(255&e[1+s])<<8*s;return i>99999999||!function(t,e,i,s){if(e>8||i>4||s>4)return 0;k(t.k,i,e);var r=1<<s;return w(t.C,r),w(t.o,r),t.P=r-1,1}(t,r,o,a)?0:function(t,e){return 0>e?0:(t.z!=e&&(t.z=e,t.m=Math.max(t.z,1),m(t.b,Math.max(t.m,4096))),1)}(t,i)}(r=b({}),u))throw Error("corrupted input");for(o=0;64>o;o+=8){if(-1==(a=c(e)))throw Error("truncated input");1==(a=a.toString(16)).length&&(a="0"+a),h=a+""+h}/^0+$|^f+$/i.test(h)?t.N=F:(n=parseInt(h,16),t.N=n>i?F:l(n)),t.Q=function(t,e,i,s){return t.a.K=e,y(t.b),t.b.V=i,function(t){t.b.w=0,t.b.D=0,R(t.q),R(t.n),R(t.E),R(t.s),R(t.u),R(t.r),R(t.J),function(t){var e,i;for(i=1<<t.g+t.y,e=0;i>e;++e)R(t.F[e].v)}(t.k);for(var e=0;4>e;++e)R(t.j[e].B);S(t.C),S(t.o),R(t.t.B),function(t){t.p=0,t.i=-1;for(var e=0;5>e;++e)t.p=t.p<<8|c(t.K)}(t.a)}(t),t.f=0,t.l=0,t.T=0,t.R=0,t._=0,t.U=s,t.d=D,t.I=0,function(t,e){return t.h=e,t.bb=null,t.X=1,t}({},t)}(r,e,s,t.N)}function p(t,e){return t.S=function(t){return t.ab=r(32),t.O=0,t}({}),d(t,function(t,e){return t.ab=e,t.cb=0,t.O=e.length,t}({},e),t.S),t}function m(t,e){(null==t.x||t.c!=e)&&(t.x=r(e)),t.c=e,t.D=0,t.w=0}function f(t){var e=t.D-t.w;e&&(function(t,e,i,s){(function(t,e,i,s,r){for(var o=0;r>o;++o)i[s+o]=t[e+o]})(e,i,t.ab,t.O,s),t.O+=s}(t.V,t.x,t.w,e),t.D>=t.c&&(t.D=0),t.w=t.D)}function g(t,e){var i=t.D-e-1;return 0>i&&(i+=t.c),t.x[i]}function y(t){f(t),t.V=null}function v(t){if(!t.X)throw Error("bad state");if(t.bb)throw Error("No encoding");return function(t){var e=function(t){var e,i,s,r,n,c;if(c=h(t.d)&t.P,C(t.a,t.q,(t.f<<4)+c)){if(C(t.a,t.E,t.f))s=0,C(t.a,t.s,t.f)?(C(t.a,t.u,t.f)?(C(t.a,t.r,t.f)?(i=t._,t._=t.R):i=t.R,t.R=t.T):i=t.T,t.T=t.l,t.l=i):C(t.a,t.n,(t.f<<4)+c)||(t.f=7>t.f?9:11,s=1),s||(s=x(t.o,t.a,c)+2,t.f=7>t.f?8:11);else if(t._=t.R,t.R=t.T,t.T=t.l,s=2+x(t.C,t.a,c),t.f=7>t.f?7:10,n=P(t.j[function(t){return 4>(t-=2)?t:3}(s)],t.a),n>=4){if(r=(n>>1)-1,t.l=(2|1&n)<<r,14>n)t.l+=function(t,e,i,s){var r,o,a=1,n=0;for(o=0;s>o;++o)r=C(i,t,e+a),a<<=1,a+=r,n|=r<<o;return n}(t.J,t.l-n-1,t.a,r);else if(t.l+=z(t.a,r-4)<<4,t.l+=function(t,e){var i,s,r=1,o=0;for(s=0;t.A>s;++s)i=C(e,t.B,r),r<<=1,r+=i,o|=i<<s;return o}(t.t,t.a),0>t.l)return-1==t.l?1:-1}else t.l=n;if(a(l(t.l),t.d)>=0||t.l>=t.m)return-1;(function(t,e,i){var s=t.D-e-1;for(0>s&&(s+=t.c);0!=i;--i)s>=t.c&&(s=0),t.x[t.D++]=t.x[s++],t.D>=t.c&&f(t)})(t.b,t.l,s),t.d=o(t.d,l(s)),t.I=g(t.b,0)}else e=function(t,e,i){return t.F[((e&t.Y)<<t.g)+((255&i)>>>8-t.g)]}(t.k,h(t.d),t.I),t.I=7>t.f?function(t,e){var i=1;do{i=i<<1|C(e,t.v,i)}while(256>i);return i<<24>>24}(e,t.a):function(t,e,i){var s,r,o=1;do{if(r=i>>7&1,i<<=1,s=C(e,t.v,(1+r<<8)+o),o=o<<1|s,r!=s){for(;256>o;)o=o<<1|C(e,t.v,o);break}}while(256>o);return o<<24>>24}(e,t.a,g(t.b,t.l)),function(t,e){t.x[t.D++]=e,t.D>=t.c&&f(t)}(t.b,t.I),t.f=function(t){return 4>t?0:10>t?t-3:t-6}(t.f),t.d=o(t.d,O);return 0}(t.h);if(-1==e)throw Error("corrupted input");t.$=F,t.Z=t.h.d,(e||a(t.h.U,D)>=0&&a(t.h.d,t.h.U)>=0)&&(f(t.h.b),y(t.h.b),t.h.a.K=null,t.X=0)}(t),t.X}function b(t){t.b={},t.a={},t.q=r(192),t.E=r(12),t.s=r(12),t.u=r(12),t.r=r(12),t.n=r(192),t.j=r(4),t.J=r(114),t.t=T({},4),t.C=M({}),t.o=M({}),t.k={};for(var e=0;4>e;++e)t.j[e]=T({},6);return t}function w(t,e){for(;e>t.e;++t.e)t.G[t.e]=T({},3),t.H[t.e]=T({},3)}function x(t,e,i){return C(e,t.M,0)?8+(C(e,t.M,1)?8+P(t.L,e):P(t.H[i],e)):P(t.G[i],e)}function M(t){return t.M=r(2),t.G=r(16),t.H=r(16),t.L=T({},8),t.e=0,t}function S(t){R(t.M);for(var e=0;t.e>e;++e)R(t.G[e].B),R(t.H[e].B);R(t.L.B)}function k(t,e,i){var s,o;if(null==t.F||t.g!=i||t.y!=e)for(t.y=e,t.Y=(1<<e)-1,t.g=i,o=1<<t.g+t.y,t.F=r(o),s=0;o>s;++s)t.F[s]=A({})}function A(t){return t.v=r(768),t}function T(t,e){return t.A=e,t.B=r(1<<e),t}function P(t,e){var i,s=1;for(i=t.A;0!=i;--i)s=(s<<1)+C(e,t.B,s);return s-(1<<t.A)}function C(t,e,i){var s,r=e[i];return(-2147483648^(s=(t.i>>>11)*r))>(-2147483648^t.p)?(t.i=s,e[i]=r+(2048-r>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),0):(t.i-=s,t.p-=s,e[i]=r-(r>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),1)}function z(t,e){var i,s,r=0;for(i=e;0!=i;--i)t.i>>>=1,s=t.p-t.i>>>31,t.p-=t.i&s-1,r=r<<1|1-s,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8);return r}function R(t){for(var e=t.length-1;e>=0;--e)t[e]=1024}function E(t){for(var e,i,s,r=0,o=0,a=t.length,n=[],l=[];a>r;++r,++o){if(128&(e=255&t[r]))if(192==(224&e)){if(r+1>=a)return t;if(128!=(192&(i=255&t[++r])))return t;l[o]=(31&e)<<6|63&i}else{if(224!=(240&e))return t;if(r+2>=a)return t;if(128!=(192&(i=255&t[++r])))return t;if(128!=(192&(s=255&t[++r])))return t;l[o]=(15&e)<<12|(63&i)<<6|63&s}else{if(!e)return t;l[o]=e}16383==o&&(n.push(String.fromCharCode.apply(String,l)),o=-1)}return o>0&&(l.length=o,n.push(String.fromCharCode.apply(String,l))),n.join("")}function _(t){return t[1]+t[0]}var L=2,V=3,B="function"==typeof setImmediate?setImmediate:setTimeout,I=4294967296,F=[i,-4294967296],D=[0,0],O=[1,0];return{decompress:function(e,i,s){var r,o,a,n,l={},h=void 0===i&&void 0===s;if("function"!=typeof i&&(o=i,i=s=0),s=s||function(e){return void 0!==o?function(e,i){t({action:V,cbn:i,result:e})}(a?e:-1,o):void 0},i=i||function(e,i){return void 0!==o?t({action:L,cbn:o,result:e,error:i}):void 0},h){for(l.d=p({},e);v(l.d.Q););return E(u(l.d.S))}try{l.d=p({},e),n=_(l.d.N),a=n>-1,s(0)}catch(t){return i(null,t)}B((function t(){try{for(var e,o=0,h=(new Date).getTime();v(l.d.Q);)if(++o%1e3==0&&(new Date).getTime()-h>200)return a&&(r=_(l.d.Q.h.d)/n,s(r)),B(t,0),0;s(1),e=E(u(l.d.S)),B(i.bind(null,e),0)}catch(t){i(null,t)}}),0)}}}();const P={decompress:(t,e)=>{T.decompress(new Uint8Array(t),e)}};function C(t,i=!1){const s=null!==t[0].index,r=new Set(Object.keys(t[0].attributes)),o=new Set(Object.keys(t[0].morphAttributes)),a={},n={},l=t[0].morphTargetsRelative,h=new e.BufferGeometry;let c=0;for(let e=0;e<t.length;++e){const u=t[e];let d=0;if(s!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in u.attributes){if(!r.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[t]&&(a[t]=[]),a[t].push(u.attributes[t]),d++}if(d!==r.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". Make sure all geometries have the same number of attributes."),null;if(l!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in u.morphAttributes){if(!o.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===n[t]&&(n[t]=[]),n[t].push(u.morphAttributes[t])}if(i){let t;if(s)t=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". The geometry must have either an index or a position attribute"),null;t=u.attributes.position.count}h.addGroup(c,t,e),c+=t}}if(s){let e=0;const i=[];for(let s=0;s<t.length;++s){const r=t[s].index;for(let t=0;t<r.count;++t)i.push(r.getX(t)+e);e+=t[s].attributes.position.count}h.setIndex(i)}for(const t in a){const e=z(a[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;h.setAttribute(t,e)}for(const t in n){const e=n[t][0].length;if(0===e)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[t]=[];for(let i=0;i<e;++i){const e=[];for(let s=0;s<n[t].length;++s)e.push(n[t][s][i]);const s=z(e);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;h.morphAttributes[t].push(s)}}return h}function z(t){let i,s,r,o=-1,a=0;for(let e=0;e<t.length;++e){const n=t[e];if(void 0===i&&(i=n.array.constructor),i!==n.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===r&&(r=n.normalized),r!==n.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===o&&(o=n.gpuType),o!==n.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;a+=n.count*s}const n=new i(a),l=new e.BufferAttribute(n,s,r);let h=0;for(let e=0;e<t.length;++e){const i=t[e];if(i.isInterleavedBufferAttribute){const t=h/s;for(let e=0,r=i.count;e<r;e++)for(let r=0;r<s;r++){const s=i.getComponent(e,r);l.setComponent(e+t,r,s)}}else n.set(i.array,h);h+=i.count*s}return void 0!==o&&(l.gpuType=o),l}function R(t,i=1e-4){i=Math.max(i,Number.EPSILON);const s={},r=t.getIndex(),o=t.getAttribute("position"),a=r?r.count:o.count;let n=0;const l=Object.keys(t.attributes),h={},c={},u=[],d=["getX","getY","getZ","getW"],p=["setX","setY","setZ","setW"];for(let i=0,s=l.length;i<s;i++){const s=l[i],r=t.attributes[s];h[s]=new e.BufferAttribute(new r.array.constructor(r.count*r.itemSize),r.itemSize,r.normalized);const o=t.morphAttributes[s];o&&(c[s]=new e.BufferAttribute(new o.array.constructor(o.count*o.itemSize),o.itemSize,o.normalized))}const m=.5*i,f=Math.log10(1/i),g=Math.pow(10,f),y=m*g;for(let e=0;e<a;e++){const i=r?r.getX(e):e;let o="";for(let e=0,s=l.length;e<s;e++){const s=l[e],r=t.getAttribute(s),a=r.itemSize;for(let t=0;t<a;t++)o+=~~(r[d[t]](i)*g+y)+","}if(o in s)u.push(s[o]);else{for(let e=0,s=l.length;e<s;e++){const s=l[e],r=t.getAttribute(s),o=t.morphAttributes[s],a=r.itemSize,u=h[s],m=c[s];for(let t=0;t<a;t++){const e=d[t],s=p[t];if(u[s](n,r[e](i)),o)for(let t=0,r=o.length;t<r;t++)m[t][s](n,o[t][e](i))}}s[o]=n,u.push(n),n++}}const v=t.clone();for(const i in t.attributes){const t=h[i];if(v.setAttribute(i,new e.BufferAttribute(t.array.slice(0,n*t.itemSize),t.itemSize,t.normalized)),i in c)for(let t=0;t<c[i].length;t++){const s=c[i][t];v.morphAttributes[i][t]=new e.BufferAttribute(s.array.slice(0,n*s.itemSize),s.itemSize,s.normalized)}}return v.setIndex(u),v}const E={getMesh:(t,e)=>{let i={};if(e){let e=[],i=[],s={},r=[];t.traverse((t=>{if(t.isGroup){let o=E.groupToMesh(t);o&&(e.push(t),r.push(t.name),o.applyMatrix4(t.matrix),i.push(o),s[o.name]=i)}}));let o,a,n=e.length;for(;n--;)o=e[n].parent,a=o.name,o.remove(e[n]),-1!==r.indexOf(a)&&(o=s[a]),o.add(i[n])}return t.traverse((t=>{t.isMesh&&(i[t.name]=t)})),i},getGroup:(t,e,i)=>{const s={};return t.traverse((t=>{t.isGroup&&(s[t.name]=e?E.groupToMesh(t,mats):t)})),s},getMaterial:t=>{const e={};let i,s=[];return t.traverse((t=>{t.isMesh&&(i=t.material,-1===s.indexOf(i.name)&&(s.push(i.name),e[i.name]=i))})),e},groupToMesh:t=>{if(t.children[0].name!==t.name+"_1")return!1;if(!t.children[0].isMesh)return!1;let e=[],i=[],s=t.children.length;for(;s--;)i[s]=t.children[s].material,e[s]=t.children[s].geometry,e[s].group=s;let r=new THREE.Mesh(new C(e,!0),i);return r.name=t.name,r},symetric:t=>{t.isMesh&&(t=t.geometry);let e=t.attributes.uv.array,i=.5*e.length;for(;i--;)e[2*i]<0&&(e[2*i]*=-1);t.attributes.uv.needsUpdate=!0},uv2:t=>{t.isMesh&&(t=t.geometry),t.setAttribute("uv2",t.attributes.uv)},autoMorph:(t,i,s=!0,r=!1)=>{let o,a,n,l,h,c,u,d,p,m,f,g={},y=[];t.traverse((t=>{t.isMesh&&-1!==t.name.search("__M__")&&(g[t.name]=t.geometry,y.push(t))}));for(let t in g)if(o=t.substring(0,t.indexOf("__")),a=t.substring(t.lastIndexOf("__")+2),n=i[o],n)if(h=n.geometry,c=g[t],h.morphTargetsRelative=r,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],s&&(h.morphAttributes.normal=[]),n.morphTargetInfluences=[],n.morphTargetDictionary={}),l=h.morphAttributes.position.length,r){for(u=c.attributes.position.array.length,m=[];u--;)m[u]=c.attributes.position.array[u]-h.attributes.position.array[u];d=new e.Float32BufferAttribute(m,3)}else d=new e.Float32BufferAttribute(c.attributes.position.array,3);h.morphAttributes.position.push(d),s&&(p=new e.Float32BufferAttribute(c.attributes.normal.array,3),h.morphAttributes.normal.push(p)),n.morphTargetInfluences.push(0),n.morphTargetDictionary[a]=l}else console.warn("Morph "+a+" target is no good on "+n.name);for(g={},u=y.length;u--;)f=y[u],f.parent&&f.parent.remove(f),f.material&&f.material.dispose(),f.geometry&&f.geometry.dispose()}},_={manager:new e.LoadingManager,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./build/draco/",basisPath:"./build/basis/",useLocal:!1,formatGltf:{draco:!0,ktx2:!1,meshop:!1},setSupport:t=>{for(let e in t)_.formatGltf[e]&&(_.formatGltf[e]=t[e])},maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:t=>{},materialRoot:t=>{console.log(t)},setLoadEvent:(t,e)=>{_.onLoad=t,_.onEnd=e},prefix:t=>{let e="";switch(t){case"S":case"sound":case"mp3":case"wav":case"ogg":e="S_";break;case"I":case"image":case"jpg":case"png":e="I_";break;case"E":case"hdr":case"env":case"T":case"texture":e="T_";break;case"J":case"json":e="J_";break;case"JS":case"js":e="JS_";break;case"H":case"bin":case"hex":e="H_";break;case"O":case"object3d":e="O_";break;case"M":case"material":e="M_"}return e},dispose:()=>{_.data.forEach((function(t,e){(t.isMaterial||t.isTexture)&&(t.dispose(),_.data.delete(e)),t.isObject3D&&(t.traverse((function(t){t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose&&t.material.dispose())})),_.data.delete(e))}))},createElementNS:t=>document.createElementNS("http://www.w3.org/1999/xhtml",t),exist:(t,e="")=>!!_.get(t,e),delete:(t,e="")=>_.data.delete(_.prefix(e)+t),get:(t,e="")=>_.data.get(_.prefix(e)+t),set:(t,e,i="",s)=>{e?(e.isMaterial&&(i="material",e.name=t,_.materialRoot(e,s)),e.isTexture&&(i="texture"),e.isObject3D&&(i="object3d"),_.get(t,i)||_.data.set(_.prefix(i)+t,e)):console.log("Loading error on "+t)},getScript:t=>_.data.get(_.prefix("js")+t),getMaterials:t=>("string"==typeof t&&(t=_.get(t,"O")),E.getMaterial(t)),getGLB:(t,e)=>("string"==typeof t&&(t=_.get(t,"O")),t?(e&&E.getMesh(t,e),t):console.error("Not find Model ?")),getMesh:(t,e)=>("string"==typeof t&&(t=_.get(t,"O")),t?E.getMesh(t,e):console.error("Not find Model ?")),getGroup:(t,e,i)=>("string"==typeof t&&(t=_.get(t,"O")),E.getGroup(t,e,i)),applyMorph(t,e=null,i=!0,s=!0){let r;r=t.isObject3D?t:_.get(t,"O"),e||(e=_.getMesh(t)),r&&e&&E.autoMorph(r,e,i,s)},uv2(t){E.uv2(t)},symetric(t){E.symetric(t)},objectSpaceNormal(t){t.material.normalMapType=e.ObjectSpaceNormalMap},add:(t,e,i)=>{_.set(t,e,i),_.next()},getMaterial:t=>_.data.get("M_"+t),texture:(t={})=>{_.loaderMap||(_.loaderMap=new e.TextureLoader);let i=t.name||"";return t.url&&(i=-1!==t.url.lastIndexOf(".")?t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf(".")):t.url.substring(t.url.lastIndexOf("/")+1)),-1===i.search("_c")&&-1===i.search("_l")&&-1===i.search("_u")&&-1===i.search("_d")||(t.srgb=!0),_.exist(i,"texture")?_.get(i,"texture"):_.exist(i,"image")?_.getTexture(i,t):_.loaderMap.load(t.url,(function(e){return _.setTextureOption(e,t),_.data.set("T_"+i,e),t.callback&&t.callback(),e}))},getTexture:(t,i={})=>{t=(i.quality?i.quality+"k_":"")+t;let s=_.get(t,"texture");if(!s){let r=_.get(t,"image");if(!r)return null;s=new e.Texture(r),-1===t.search("_c")&&-1===t.search("_d")&&-1===t.search("_l")&&-1===t.search("_u")||(i.srgb=!0),_.data.set("T_"+t,s)}return _.setTextureOption(s,i),s},setTextureOption:(t,i={})=>{i.encoding&&(t.colorSpace=e.SRGBColorSpace),i.srgb&&(t.colorSpace=e.SRGBColorSpace),t.flipY=(void 0!==i.flipY||void 0!==i.flip)&&i.flipY,i.anisotropy&&(t.anisotropy="max"===i.anisotropy?_.maxAnisotropy:i.anisotropy),void 0!==i.generateMipmaps&&(t.generateMipmaps=i.generateMipmaps),i.repeat&&(t.repeat.fromArray(i.repeat),t.wrapS=t.wrapT=e.RepeatWrapping),i.center&&t.center.fromArray(i.center),i.offset&&t.offset.fromArray(i.offset),i.filter&&"near"===i.filter&&(t.minFilter=e.NearestFilter,t.magFilter=e.NearestFilter),i.channel&&(t.channel=i.channel),t.needsUpdate=!0},loadAsync:(t,e="",i="")=>new Promise(((s,r)=>{_.waiting=!0,_.load(t,(()=>{_.waiting=!1}),e,i)})),load:(t,e,i="",s="",r=0)=>{_.msg=s;let o=[],a=e||function(){},n=("undefined"==typeof performance?Date:performance).now();"string"==typeof t||t instanceof String?o.push(t):o=o.concat(t),_.tmp.push({urls:o,path:i,callback:a,start:n,quality:r}),_.inLoad||_.loadOne()},loadOne:()=>{_.inLoad=!0,_.onLoad();let t=_.tmp[0].path+_.tmp[0].urls[0],e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),i=t.substring(t.lastIndexOf(".")+1).toLowerCase();"jpg"!==i&&"png"!==i||(e=(_.tmp[0].quality?_.tmp[0].quality+"k_":"")+e),_.exist(e,i)?_.next():_.loading(t,e,i)},next:()=>{_.tmp[0].urls.shift(),0===_.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-_.tmp[0].start),_.tmp[0].callback(),_.tmp.shift(),_.tmp.length>0?_.loadOne():(_.inLoad=!1,_.clearDRACO(),_.clearKTX2(),_.onEnd())):_.loadOne()},loading:(t,e,i)=>{switch(_.log(_.msg),i){case"glb":case"gltf":_.load_GLTF(t,e);break;case"fbx":case"FBX":_.load_FBX(t,e);break;case"obj":_.load_OBJ(t,e);break;case"stl":_.load_STL(t,e);break;case"ktx2":_.load_KTX2(t,e);break;case"hdr":_.load_RGBE(t,e);break;case"exr":_.load_EXR(t,e);break;default:_.extand(t,e,i)}},extand:(t,e,i)=>{_.XHTTP||(_.XHTTP=new XMLHttpRequest);const s=_.XHTTP;switch(s.open("GET",t,!0),"json"===i&&s.overrideMimeType("application/json"),i){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":s.responseType="arraybuffer";break;case"jpg":case"png":s.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):_.direct(s.response,e,i))},"onprogress"in s&&(s.onprogress=function(t){}),s.send(null)},direct:(t,e,i)=>{switch(i){case"jpg":case"png":let s=_.createElementNS("img");s.onload=function(t){window.URL.revokeObjectURL(s.src),_.add(e,s,"image")},s.src=window.URL.createObjectURL(t);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(t.slice(0),(function(t){_.add(e,t,"sound")}),(function(t){console.error("decodeAudioData error",t)}));break;case"hex":case"bin":P.decompress(t,(t=>{_.add(e,t,i)}));break;case"wasm":_.add(e,new Uint8Array(t),i);break;case"json":_.add(e,JSON.parse(t),i);break;default:_.add(e,t,i)}},clearKTX2:()=>{_.KTX2&&(_.KTX2.dispose(),_.KTX2=null)},clearDRACO:()=>{_.dracoLoader&&(_.dracoLoader.dispose(),_.dracoLoader=null),_.GLTF&&(_.GLTF=null)},loaderDRACO:()=>{if(_.dracoLoader)return _.dracoLoader;if(!_.dracoLoaderType)if(navigator.userAgentData)_.dracoLoaderType="wasm";else{let t=navigator.userAgent.toLowerCase();_.dracoLoaderType=-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")?"js":"wasm"}return _.dracoLoader=(new M).setDecoderConfig({type:_.dracoLoaderType}).setDecoderPath(_.dracoPath).setUseLocal(_.useLocal),_.dracoLoader},loaderKTX2:()=>(_.KTX2||(_.KTX2=new A(_.manager).setTranscoderPath(_.basisPath).detectSupport(_.renderer).setUseLocal(_.useLocal)),_.KTX2),loaderGLTF:()=>(_.GLTF||(_.GLTF=new i.GLTFLoader(_.manager).setCrossOrigin("anonymous"),_.formatGltf.draco&&_.GLTF.setDRACOLoader(_.loaderDRACO()),_.formatGltf.ktx2&&_.GLTF.setKTX2Loader(_.loaderKTX2()),_.formatGltf.meshop&&_.GLTF.setMeshoptDecoder(h.MeshoptDecoder)),_.GLTF),loaderFBX:()=>(_.FBX||(_.FBX=new s.FBXLoader(_.manager)),_.FBX),loaderSTL:()=>(_.STL||(_.STL=new a.STLLoader(_.manager)),_.STL),loaderOBJ:()=>(_.OBJ||(_.OBJ=new r.OBJLoader(_.manager)),_.OBJ),loaderRGBE:()=>(_.RGBE||(_.RGBE=new n.RGBELoader(_.manager)),_.RGBE),loaderEXR:()=>(_.EXR||(_.EXR=new l.EXRLoader(_.manager)),_.EXR),load_GLTF:(t,i)=>{_.loaderGLTF().load(t,(function(t){const s=t.scene;if(t.animations){const i=t.animations,r=new e.AnimationMixer(t.scene);s.mixer=r,s.actions={};for(let t=0;t<i.length;t++){let e=i[t];s.actions[e.name]=r.clipAction(e)}s.play=t=>{s.actions[t]&&(s.actions[t].paused=!1,s.actions[t].time=0,s.actions[t].play())},s.pause=(t,e=!0)=>{s.actions[t]&&(s.actions[t].paused=e)}}_.add(i,s)}))},load_FBX:(t,e)=>{_.loaderFBX().load(t,(function(t){_.add(e,t)}))},load_OBJ:(t,e)=>{_.loaderOBJ().load(t,(function(t){_.add(e,t)}))},load_STL:(t,i)=>{_.loaderSTL().load(t,(function(t){let s=new e.Mesh(t);_.add(i,s)}))},load_KTX2:(t,e,i)=>{_.loaderKTX2().load(t,(function(t){return _.add(e,t),t}))},load_RGBE:(t,i)=>{_.loaderRGBE().load(t,(function(t){t.mapping=e.EquirectangularReflectionMapping,_.add(i,t)}))},load_EXR:(t,e,i)=>{_.loaderEXR().load(t,(function(t){return i&&i(t),t}))},direct_EXR:(t,e)=>{_.loaderEXR().parse(url,(function(t){return _.add(e,t),t}))}},L=["PHYSX","HAVOK"],V=4e3,B=1e3,I=4e3,F=100,D=100,O=50,N=20,U={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},q=function(t,e=!1){const i={};let s={body:V*(e?U.bodyFull:U.body),joint:B*U.joint,ray:F*U.ray,contact:I*U.contact,character:D*U.character};"PHYSX"!==t&&"AMMO"!==t||(s.vehicle=O*U.vehicle),"PHYSX"===t&&(s.solver=N*U.solver),"HAVOK"!==t&&"RAPIER"!==t&&"JOLT"!==t||(U.joint=0);let r=0;for(let t in s)i[t]=r,r+=s[t];return i.total=r,i};class j extends e.LineSegments{constructor(t,i=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),r=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],o=new e.BufferGeometry;o.setIndex(new e.BufferAttribute(s,1)),o.setAttribute("position",new e.Float32BufferAttribute(r,3)),o.setAttribute("color",new e.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(o,new e.LineBasicMaterial({color:i,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=t,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}dispose(){this.geometry.dispose(),this.material.dispose()}}let G=class{constructor(){this.geoN=0,this.geo={}}unic(t){this.geo["geo"+this.geoN++]=t}set(t){this.geo[t.name]=t}get(t,i={}){if(!this.geo[t]){let i;switch(t){case"plane":i=new e.PlaneGeometry(1,1),i.rotateX(.5*-Math.PI);break;case"box":i=new e.BoxGeometry(1,1,1);break;case"sphere":i=new e.SphereGeometry(1,16,12);break;case"cylinder":i=new e.CylinderGeometry(1,1,1,16);break;case"cone":i=new e.CylinderGeometry(.001,1,1,16);break;case"particle":i=new e.SphereGeometry(1,6,4);break;case"joint":i=(new j).geometry;break;default:return null}this.geo[t]=i}return this.geo[t]}dispose(){for(let t in this.geo)this.geo[t].isBufferGeometry?this.geo[t].dispose():console.log(this.geo[t]);this.geo={},this.geoN=0}};class W{constructor(t,i="rgb(69,69,69)",s="rgb(39,39,39)"){const r=document.createElement("canvas");r.width=r.height=128;const o=r.getContext("2d");if(o.fillStyle=i,o.fillRect(0,0,128,128),t){let e,r,a,n,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=t?"rgb(128,128,255)":i,u=t?"rgb(160,100,255)":s,d=t?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(o.strokeStyle=d,o.lineWidth=1,e=0;e<5;e++){n=o.createLinearGradient(0,h[e][0],0,h[e][1]),n.addColorStop(0,u),n.addColorStop(1,c),o.beginPath(),o.fillStyle=n,o.rect(l[e][0],l[e][1],32,64),o.fill();for(let t=0;t<8;t++)a=2*(Math.random()-.5),o.beginPath(),o.moveTo(l[e][0]+a+2+4*t,l[e][1]),o.lineTo(l[e][0]+a+2+4*t,l[e][1]+64),o.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],e=0;e<5;e++)for(n=o.createLinearGradient(h[e][0],0,h[e][1],0),n.addColorStop(0,c),n.addColorStop(1,u),o.beginPath(),o.fillStyle=n,o.rect(l[e][0],l[e][1],64,32),o.fill(),r=0;r<8;r++)a=2*(Math.random()-.5),o.beginPath(),o.moveTo(l[e][0],l[e][1]+a+2+4*r),o.lineTo(l[e][0]+64,l[e][1]+a+2+4*r),o.stroke()}else o.beginPath(),o.fillStyle=s,o.rect(0,0,32,64),o.rect(32,32,32,64),o.rect(64,64,32,64),o.rect(96,96,32,64),o.rect(96,-32,32,64),o.fill();const a=new e.CanvasTexture(r);return a.wrapS=a.wrapT=e.RepeatWrapping,a.repeat.x=a.repeat.y=60,t||(a.colorSpace=e.SRGBColorSpace),a}}class H extends e.MeshPhysicalMaterial{constructor(t){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new e.Color(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(t);let i=this;i.onBeforeCompile=function(t){for(let e in i.extra)t.uniforms[e]={value:i.extra[e]};t.fragmentShader=t.fragmentShader.replace("#include <common>",X.common),t.fragmentShader=t.fragmentShader.replace("#include <lights_fragment_begin>",i.replaceAll(Q,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",X.light)),i.userData.shader=t}}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.userData.shader&&(this.userData.shader.uniforms[t].value=this.extra[t])}})}replaceAll(t,e,i){return t.split(e).join(i)}}const X={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},Q="\n\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\n\tif ( material.iridescenceThickness == 0.0 ) {\n\n\t\tmaterial.iridescence = 0.0;\n\n\t} else {\n\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\n\t}\n\n\tif ( material.iridescence > 0.0 ) {\n\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\n\t}\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n\t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",Y={metalness:.1,roughness:.9},J={grey:new e.Color(.18,.18,.18),black:new e.Color(.039,.039,.039),body:new e.Color(13289155),sleep:new e.Color("hsl(33, 15%, 54%)"),solid:new e.Color(7105128),base:new e.Color(13224135),brick:new e.Color(.262,.095,.061),sand:new e.Color(.44,.386,.231),gold:new e.Color(.944,.776,.373),gold2:new e.Color(.998,.981,.751),titanium:new e.Color(.633,.578,.503),titaniumSpec:new e.Color(.728,.68,.55),chrome:new e.Color(.653,.65,.615),chromeSpec:new e.Color(.675,.72,.711),copper:new e.Color(.988,.688,.448),carPaint:new e.Color(.1037792,.59212029,.85064936),clay:new e.Color("hsl(12, 30%, 40%)"),clayWhite:new e.Color(11119017),concrete:new e.Color(.51,.51,.51),Raw_Fire:new e.Color("hsl(40, 18%, 54%)"),Raw_Buff:new e.Color("hsl(33, 15%, 54%)"),Raw_Terracotta:new e.Color("hsl(12, 30%, 40%)"),Raw_Porcelain:new e.Color("hsl(45, 15%, 90%)")},Z={No:e.NoBlending,Normal:e.NormalBlending,Additive:e.AdditiveBlending,Subtractive:e.SubtractiveBlending,Multiply:e.MultiplyBlending,Eadd:e.AddEquation,Esub:e.SubtractEquation,Erev:e.ReverseSubtractEquation,Emin:e.MinEquation,Emaw:e.MaxEquation,Fzero:e.ZeroFactor,Fone:e.OneFactor,Fcolor:e.SrcColorFactor,Fcolorm:e.OneMinusSrcColorFactor,Falpha:e.SrcAlphaFactor,Falpham:e.OneMinusSrcAlphaFactor,Fdstalpha:e.DstAlphaFactor,Fdstalpham:e.OneMinusDstAlphaFactor,Fdstcolor:e.DstColorFactor,Fdstcolorm:e.OneMinusDstColorFactor,Falphasaturate:e.SrcAlphaSaturateFactor,Front:e.FrontSide,Back:e.BackSide,Double:e.DoubleSide};let K=class{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.extendMat=!1,this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(t){this.renderMode.value=t}initExtandShader(){}useRealLight(t){}setColor(t){}set(t,e,i=null){i||(i=t.onBeforeCompile),this.mat[t.name]=t}extendShader(t,e=null){}addToTmp(t){this.TmpMat.push(t)}create(t){let i,s=null;if(t.isMaterial)i=t;else{let r=void 0!==t.type?t.type:"Standard";switch(t.type&&delete t.type,s=t.beforeCompile||null,t.beforeCompile&&delete t.beforeCompile,(t.thickness||t.sheen||t.clearcoat||t.transmission||t.specularColor)&&(r="Physical"),t.normalScale&&(t.normalScale.isVector2||(t.normalScale=(new e.Vector2).fromArray(t.normalScale))),t.side&&(t.side=this.findValue(t.side)),t.shadowSide&&(t.shadowSide=this.findValue(t.shadowSide)),t.blending&&(t.blending=this.findValue(t.blending)),t.blendEquation&&(t.blendEquation=this.findValue(t.blendEquation)),t.blendEquationAlpha&&(t.blendEquationAlpha=this.findValue(t.blendEquationAlpha)),t.blendSrc&&(t.blendSrc=this.findValue(t.blendSrc)),t.blendDst&&(t.blendDst=this.findValue(t.blendDst)),t.blendDstAlpha&&(t.blendDstAlpha=this.findValue(t.blendDstAlpha)),t.blendSrcAlpha&&(t.blendSrcAlpha=this.findValue(t.blendSrcAlpha)),t.clearcoatNormalScale&&(t.clearcoatNormalScale.isVector2||(t.clearcoatNormalScale=(new e.Vector2).fromArray(t.clearcoatNormalScale))),r=r.toLowerCase(),r){case"physical":i=new e.MeshPhysicalMaterial(t),i.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":i=new e.MeshPhongMaterial(t);break;case"lambert":i=new e.MeshLambertMaterial(t);break;case"basic":i=new e.MeshBasicMaterial(t);break;case"line":i=new e.LineBasicMaterial(t);break;case"toon":i=new e.MeshToonMaterial(t);break;case"shadow":i=new e.ShadowMaterial(t);break;case"sss":i=new H(t);break;default:i=new e.MeshStandardMaterial(t)}}return this.mat[i.name]?null:(this.set(i,!1,s),i)}findValue(t){return"string"===t?Z[t.charAt(0).toUpperCase()+t.slice(1)]:t}addToMat(t){if(this.isRealism)for(let i in t)t[i].shadowSide=e.DoubleSide,t[i].onBeforeCompile=function(e){EnhanceLighting(e,this.realismOption),t[i].userData.isRealism=!0,t[i].userData.shader=e};this.mat={...this.mat,...t}}changeType(){}directIntensity(t){for(let t in this.mat);}getList(){let t={...this.mat};const e=["line","debug","hide","svg"];let i=e.length;for(;i--;)delete t[e[i]];return t}get(t){if(!this.mat[t])switch(t){case"grey":this.create({name:"grey",color:J.grey,metalness:0,roughness:.5});break;case"black":this.create({name:"black",color:J.black,metalness:0,roughness:.5});break;case"body":this.create({name:"body",color:J.body,...Y});break;case"sleep":this.create({name:"sleep",color:J.sleep,...Y});break;case"solid":this.create({name:"solid",color:J.solid,...Y});break;case"base":this.create({name:"base",color:J.base,...Y});break;case"clay":this.create({name:"clay",color:J.clay,metalness:.1,roughness:.7});break;case"clayWhite":this.create({name:"clayWhite",color:J.clayWhite,metalness:.1,roughness:.7});break;case"concrete":this.create({name:"concrete",color:J.concrete,metalness:0,roughness:.9});break;case"brick":this.create({name:"brick",color:J.brick,metalness:0,roughness:.6});break;case"sand":this.create({name:"sand",color:J.sand,metalness:0,roughness:.9});break;case"chrome":this.create({name:"chrome",color:J.chrome,specularColor:J.chromeSpec,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:J.gold,specularColor:J.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:J.copper,metalness:1,roughness:.05});break;case"titanium":this.create({name:"titanium",color:J.titanium,metalness:1,roughness:0,specularColor:J.titaniumSpec});break;case"carPaint":this.create({name:"carPaint",color:J.carPaint,metalness:0,anisotropy:new e.Vector2(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new W,normalMap:new W(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...Y});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:e.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:16777215,alphaToCoverage:!0,transparent:!0,opacity:1,roughness:0,metalness:0,side:e.DoubleSide,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.05,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0,specularIntensity:1,specularColor:16777215});break;case"plexi":this.create({name:"plexi",blending:e.AdditiveBlending,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:e.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:e.AdditiveBlending,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:e.DoubleSide,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.create({name:"outline",color:16777215,type:"Basic",side:e.BackSide,toneMapped:!1,wireframe:!0,transparent:!0,opacity:.25});break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...Y});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:16776960,transparent:!0,opacity:.2});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:e.DoubleSide})}return this.mat[t]}dispose(){this.isRealism=!1;for(let t in this.mat)this.mat[t].dispose(),delete this.mat[t];let t=this.TmpMat.length;for(;t--;)this.TmpMat[t].dispose();this.TmpMat=[]}upShader(){let t=this.realismOption;for(let e in this.mat){const i=this.mat[e],s=i.userData.shader;for(let e in t)s&&void 0!==s.uniforms[e]&&(s.uniforms[e].value=t[e]),i[e]&&(i[e]=t[e])}}};class ${constructor(t=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(t),this.force=!1}up(t){let e=this.time;return this.unlimited&&(this.force=!0),e.now=void 0!==t?t:this.now(),e.delta=e.now-e.then,this.force&&(e.delta=e.interval,this.force=!1),!!(e.delta>=e.interval||this.unlimited)&&(e.then=this.unlimited?e.now:e.now-e.delta%e.interval,this.delta=.001*e.interval,this.elapsedTime+=this.delta,!0)}setFramerate(t){this.elapsedTime=0,this.framerate=t,this.unlimited=this.framerate<0,this.time.interval=1e3/t,60===t&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(t){return t>1e3?t/1e3+" sec":t+" ms"}}class tt{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new et(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(t){this.keyDown(t)}.bind(this),!1),document.addEventListener("keyup",function(t){this.keyUp(t)}.bind(this),!1)}setKey(t,e){this.key[t]=e}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=-1,i[0]=1;break;case 68:case 39:e[0]=1,i[1]=1;break;case 87:case 90:case 38:e[1]=-1;break;case 83:case 40:e[1]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}else switch(t.which){case 65:case 81:e[0]=-1,i[0]=1;break;case 68:e[0]=1,i[1]=1;break;case 87:case 90:e[1]=-1;break;case 83:e[1]=1;break;case 37:e[2]=-1,i[0]=1;break;case 39:e[2]=1,i[1]=1;break;case 38:e[3]=-1;break;case 40:e[3]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}this.gamepad.reset()}keyUp(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:case 39:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:case 38:e[1]=e[1]<0?0:e[1];break;case 83:case 40:e[1]=e[1]>0?0:e[1];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}else switch(t.which){case 65:case 81:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:e[1]=e[1]<0?0:e[1];break;case 83:e[1]=e[1]>0?0:e[1];break;case 37:e[2]=e[2]<0?0:e[2],i[0]=0;break;case 39:e[2]=e[2]>0?0:e[2],i[1]=0;break;case 38:e[3]=e[3]<0?0:e[3];break;case 40:e[3]=e[3]>0?0:e[3];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}}}class et{constructor(t){this.values=[],this.ready=0,this.key=t}update(){var t,e,i,s,r,o,a=this.fix,n=navigator.getGamepads();for(t=0;t<n.length;t++)if(o=n[t])if(i=o.axes.length,s=o.buttons.length){for(this.values[t]||(this.values[t]=[]),e=0;e<i;e++)r=a(o.axes[e],.08),0==this.ready&&0!==r&&(this.ready=1),this.values[t][e]=r;for(e=0;e<s;e++)r=a(o.buttons[e].value),0==this.ready&&0!==r&&(this.ready=1),this.values[t][i+e]=r}else this.values[t]&&(this.values[t]=null)}getValue(t){for(var e,i=19;i--;)e=this.values[t][i],0==this.ready&&0!==e&&(this.ready=1),this.key[i]=e}reset(){this.ready=0}fix(t,e){let i=Number(t.toString().substring(0,5));return e&&i<e&&i>-e&&(i=0),i}}class it{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.list=[],this.id=0}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let i=this.byName(t);return i?this.clear(i,e):-1}clear(t,e){let i=this.list.indexOf(t);return-1===i||e?this.list[i]=null:this.list.splice(i,1),this.dispose(t),i}dispose(t){null!==t&&this.Utils.remove(t)}add(t={}){}set(t={}){}step(t,e){}}class st extends it{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*U.ray,i.update(t,s,this.motor.reflow.ray[r]||null)}add(t={}){this.setName(t);let e=new rt(t,this.motor);return e.visible=void 0===t.visible||t.visible,this.addToWorld(e,t.id),t.parent&&"string"!=typeof t.parent&&(t.parent=t.parent.name),t.callback&&delete t.callback,this.motor.post({m:"add",o:t}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.setRay(t)}}class rt extends e.Line{constructor(t={},i){super(new e.BufferGeometry,i.getMat("line")),this.motor=i,this.Utils=this.motor.utils,this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=t.name,this.parentMesh=null,t.parent&&(this.parentMesh="string"==typeof t.parent?this.Utils.byName(t.parent):t.parent,this.data.parent=this.parentMesh),this.callback=t.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new e.Vector3,this.end=new e.Vector3(0,1,0),this.tmp=new e.Vector3,this.vnormal=new e.Vector3,this.vv1=new e.Vector3,this.vv2=new e.Vector3,this.fullDistance=0,this.setRay(t);this.geometry.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.noRotation=t.noRotation||!1,this.fakeMatrix=new e.Matrix4,this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(t){t.begin&&this.begin.fromArray(t.begin),t.end&&this.end.fromArray(t.end),this.fullDistance=this.begin.distanceTo(this.end)}update(t,e=0,i=null){if(this.data.hit=0!==t[e],this.data.body=i||"",this.data.distance=t[e+1],this.data.hit)this.local[0]=t[e+2],this.local[1]=t[e+3],this.local[2]=t[e+4],this.tmp.fromArray(t,e+5),this.vnormal.fromArray(t,e+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(w.angleTo(this.vv1.toArray(),this.data.normal)*g);else if(this.parentMesh){let t;t=this.noRotation?this.fakeMatrix.setPosition(this.parentMesh.position.x,this.parentMesh.position.y,this.parentMesh.position.z):this.parentMesh.matrixWorld,this.tmp.copy(this.begin).applyMatrix4(t).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(t),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let t=this.vertices.array,e=this.colors.array,i=this.local,s=this.data.hit,r=s?this.c2:this.c1,o=s?this.c3:this.c1;e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=o[0],e[7]=o[1],e[8]=o[2],t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}class ot extends e.InstancedMesh{constructor(t,i,s=0){super(t,i,s),this.matrixAutoUpdate=!1,this.tmpMatrix=new e.Matrix4,this.tmpQuat=new e.Quaternion,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.outline=null,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(t){this.overMaterial&&(this.outline||(this.outline=new e.Mesh(this.geometry,this.overMaterial)),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*t.idx),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=t.idx)}over(t){t&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!t&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}setColorAt(t,i){null===this.instanceColor&&(this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3)),i.isColor&&(i=i.toArray());let s=3*t;this.instanceColor.array[s]=i[0],this.instanceColor.array[s+1]=i[1],this.instanceColor.array[s+2]=i[2]}add(t,i=[0,0,0],s=[0,0,0,1],r=[1,1,1],o=null,a=null){3===s.length&&(s=this.tmpQuat.setFromEuler({_x:s[0],_y:s[1],_z:s[2],_order:"XYZ"},!1).toArray()),o&&(o.isColor&&(o=o.toArray()),null===this.instanceColor&&(this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(i,s,r,o,a),this.tmpElement.push(t)}slice(t,e,i){let s=new Float32Array(i-e);for(let r=0;r<e+i;++r)s[r]=t[e+r];return s}remove(t){if(!this.count)return;this.tmpElement.splice(t,1);let i=[...this.instanceMatrix.array];i.splice(16*t,16),this.instanceMatrix=new e.InstancedBufferAttribute(new Float32Array(i),16),null!==this.instanceColor&&(i=[...this.instanceColor.array],i.splice(3*t,3),this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(i),3)),null!==this.instanceUv&&(i=[...this.instanceUv.array],i.splice(2*t,2),this.instanceUv=new e.InstancedBufferAttribute(new Float32Array(i),2)),this.count--,this.reDistribute()}reDistribute(){let t=this.count;for(;t--;)this.tmpElement[t].idx=t}getIDName(t){return this.tmpElement[t].name}getBodyList(){let t=[],e=this.count;for(;e--;)t.push(this.tmpElement[e].name);return t}expand(t,i,s,r=[1,1,1],o){let a=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.instanceMatrix=new e.InstancedBufferAttribute(new Float32Array([...a,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(a=this.instanceColor.array,this.instanceColor=new e.InstancedBufferAttribute(new Float32Array([...a,...r]),3)),this.count++}setTransformAt(t,e,i,s){this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*t),this.needSphereUp=!0,this.outline&&this.currentOver===t&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(t){void 0!==t&&(this.isRay=t)}raycast(t,e){this.isRay&&(this.instanceMatrix.needsUpdate=!0,super.raycast(t,e))}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp&&this.computeBoundingSphere(),this.needSphereUp=!1,this.updateMatrix()}}class at{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=s}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}}class nt extends e.BufferGeometry{constructor(t=1,i=10,s=10,r=10,o=1){super(),this.type="SphereBox",this.name="SphereBox_"+t+"_"+i+"_"+s+"_"+r+"_"+o,t=t||1,i=Math.floor(i),s=Math.floor(s),r=Math.floor(r);let a,n=new e.BoxGeometry(1,1,1,i,s,r),l=new e.Vector3,h=new e.Vector3,c=n.attributes.position.array,u=n.attributes.normal.array;for(let e=0,i=n.attributes.position.count;e<i;e++)a=3*e,l.set(c[a],c[a+1],c[a+2]),h.copy(l).normalize(),l.lerp(h,o).multiplyScalar(t),c[a]=l.x,c[a+1]=l.y,c[a+2]=l.z,l.normalize(),u[a]=l.x,u[a+1]=l.y,u[a+2]=l.z;this.copy(n)}}class lt extends e.BufferGeometry{constructor(t=1,i=1,s=12,r=1){super(),this.type="CapsuleGeometry";let o=Math.PI,a=t/(2*t+i),n=1-2*a;s=Math.floor(s),r=Math.floor(r);let l=Math.floor(.5*s),h=2*Math.PI,c=.5*Math.PI,u=new e.CylinderGeometry(t,t,i,s,r,!0);pt(u,0,a,1,n);let d=new e.SphereGeometry(t,s,l,0,h,0,c);pt(d,0,1-a,1,a);let p=new e.SphereGeometry(t,s,l,0,h,c,c);pt(p,0,0,1,a);let m=(new e.Matrix4).makeRotationY(.5*-o),f=(new e.Matrix4).makeTranslation(0,.5*i,0),g=(new e.Matrix4).makeTranslation(0,.5*-i,0);u.applyMatrix4(m),d.applyMatrix4(f),p.applyMatrix4(g);let y=R(C([u,d,p]));this.copy(y)}}class ht extends e.BufferGeometry{constructor(t=1,i=.4,s=8,r=6,o=2*Math.PI,a=0,n=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:t,tube:i,radialSegments:s,tubularSegments:r,arc:o},s=Math.floor(s),r=Math.floor(r);const l=[],h=[],c=[],u=[],d=new e.Vector3,p=new e.Vector3,m=new e.Vector3;let f,g;for(f=0;f<=s;f++)for(g=0;g<=r;g++){const e=g/r*o,l=f/s*n+a;p.x=(t+i*Math.cos(l))*Math.cos(e),p.y=(t+i*Math.cos(l))*Math.sin(e),p.z=i*Math.sin(l),h.push(p.x,p.y,p.z),d.x=t*Math.cos(e),d.y=t*Math.sin(e),m.subVectors(p,d).normalize(),c.push(m.x,m.y,m.z),u.push(g/r),u.push(f/s)}for(f=1;f<=s;f++)for(g=1;g<=r;g++){const t=(r+1)*f+g-1,e=(r+1)*(f-1)+g-1,i=(r+1)*(f-1)+g,s=(r+1)*f+g;l.push(t,e,s),l.push(e,i,s)}this.setIndex(l),this.setAttribute("position",new e.Float32BufferAttribute(h,3)),this.setAttribute("normal",new e.Float32BufferAttribute(c,3)),this.setAttribute("uv",new e.Float32BufferAttribute(u,2))}}class ct extends e.BufferGeometry{constructor(t=1,i=1,s=1,r=.01,o=12,a=1,n=2){super(),this.type="ChamferCyl",o=Math.floor(o),a=Math.floor(a),n=Math.floor(n);let l=new e.Matrix4,h=new e.Matrix4,c=Math.PI,u=.5*c,d=2*c,p=r/s,m=1-2*p,f=new e.CylinderGeometry(t,i,s-2*r,o,a,!0,0);l.makeRotationY(u),f.applyMatrix4(l),pt(f,0,p,1,m);let g=new ht(t-r,r,n,o,d,0,u),y=new e.CircleGeometry(t-r,o);h.makeTranslation(0,0,r),y.applyMatrix4(h),pt(g,0,1-p,1,p);let v=C([g,y]);l.makeTranslation(0,0,.5*s-r),h.makeRotationX(-u),v.applyMatrix4(h.multiply(l)),g=new ht(i-r,r,n,o,d,0,u),y=new e.CircleGeometry(i-r,o),h.makeTranslation(0,0,r),y.applyMatrix4(h),pt(g,0,1-p,1,p,!0);let b=C([g,y]);l.makeTranslation(0,0,.5*s-r),h.makeRotationX(u),b.applyMatrix4(h.multiply(l));let w=R(C([v,f,b]));this.copy(w)}}class ut extends e.BufferGeometry{constructor(t=1,i=1,s=1,r=.01,o=1,a=1,n=1,l=2){super(),this.type="ChamferBox",o=Math.floor(o),a=Math.floor(a),n=Math.floor(n),l=Math.floor(l);let h=Math.PI,c=.5*h,u=2*r,d=.5*t,p=.5*i,m=.5*s,f=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4,v=r/t,b=1-2*v,w=r/i,x=1-2*v,M=r/s,S=1-2*M,k=new e.PlaneGeometry(t-u,i-u,o,a),A=new e.CylinderGeometry(r,r,t-u,l,o,!0,0,c),T=new e.CylinderGeometry(r,r,i-u,l,a,!0,0,c),P=new dt(r,l,l,0,c,0,-c),z=new dt(r,l,l,0,c,0,-c);pt(k,-v,w,b,x),pt(A,0,v,w,b),g.makeTranslation(0,p-r,0),f.makeRotationX(c),P.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-p+r,0),f.makeRotationX(c),y.makeRotationY(-c),z.applyMatrix4(g.multiply(f).multiply(y));let E=C([T,P,z]),_=E.clone();g.makeTranslation(d-r,0,-r),E.applyMatrix4(g),g.makeTranslation(-d+r,0,-r),f.makeRotationZ(h),_.applyMatrix4(g.multiply(f));let L=A.clone();f.makeRotationZ(c),g.makeTranslation(0,p-r,-r),A.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-p+r,-r),f.makeRotationZ(-c),L.applyMatrix4(g.multiply(f));let V=C([A,L,k,E,_]),B=V.clone();g.makeTranslation(0,0,m),V.applyMatrix4(g),g.makeTranslation(0,0,-m),f.makeRotationY(h),B.applyMatrix4(g.multiply(f)),k=new e.PlaneGeometry(s-u,i-u,n,a),A=new e.CylinderGeometry(r,r,s-u,l,n,!0,0,c),L=A.clone(),pt(k,-M,w,S,x),g.makeTranslation(0,-(p-r),-r,0),f.makeRotationZ(-c),A.applyMatrix4(g.multiply(f)),g.makeTranslation(0,p-r,-r,0),f.makeRotationZ(c),L.applyMatrix4(g.multiply(f));let I=C([A,L,k]),F=I.clone();g.makeTranslation(-d,0,0),f.makeRotationY(-c),I.applyMatrix4(g.multiply(f)),g.makeTranslation(d,0,0),f.makeRotationY(c),F.applyMatrix4(g.multiply(f)),k=new e.PlaneGeometry(t-u,s-u,o,n),pt(k,-v,M,b,S);let D=k.clone();g.makeTranslation(0,p,0),f.makeRotationX(-c),k.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-p,0),f.makeRotationX(c),D.applyMatrix4(g.multiply(f));let O=R(C([V,B,I,F,k,D]));mt(O,"box"),this.copy(O)}}class dt extends e.BufferGeometry{constructor(t=1,i=8,s=6,r=0,o=2*Math.PI,a=0,n=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:i,heightSegments:s,phiStart:r,phiLength:o,thetaStart:a,thetaLength:n},i=Math.floor(i),s=Math.floor(s);const l=Math.min(a+n,Math.PI);let h=0;const c=[],u=new e.Vector3,d=new e.Vector3,p=[],m=[],f=[],g=[];for(let e=0;e<=s;e++){const p=[],y=e/s;let v=0;0==e&&0==a?v=.5/i:e==s&&l==Math.PI&&(v=-.5/i);for(let e=0;e<=i;e++){const s=e/i;u.x=-t*Math.cos(r+s*o)*Math.sin(a+y*n),u.y=t*Math.cos(a+y*n),u.z=t*Math.sin(r+s*o)*Math.sin(a+y*n),m.push(u.x,u.y,u.z),d.copy(u).normalize(),f.push(d.x,d.y,d.z),g.push(s+v,1-y),p.push(h++)}c.push(p)}for(let t=0;t<s;t++)for(let e=0;e<i;e++){const i=c[t][e+1],r=c[t][e],o=c[t+1][e],n=c[t+1][e+1];(0!==t||a>0)&&p.push(i,r,n),(t!==s-1||l<Math.PI)&&p.push(r,o,n)}this.setIndex(p),this.setAttribute("position",new e.Float32BufferAttribute(m,3)),this.setAttribute("normal",new e.Float32BufferAttribute(f,3)),this.setAttribute("uv",new e.Float32BufferAttribute(g,2))}}function pt(t,e=0,i=0,s=1,r=1,o){let a=t.attributes.uv,n=a.array,l=a.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*s-e,n[h+1]=n[h+1]*r+i,o&&(n[h]=1-n[h],n[h+1]=1-n[h+1])}function mt(t,i="sphere",s,r=[0,0,0],o=[0,0,0,1],a){if(void 0===a&&(a=new e.Matrix4),a.compose({x:r[0],y:r[1],z:r[2]},{_x:o[0],_y:o[1],_z:o[2],_w:o[3]},{x:1,y:1,z:1}),void 0===s){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;s=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let n=new e.Box3(new e.Vector3(-s/2,-s/2,-s/2),new e.Vector3(s/2,s/2,s/2)),l=[];l.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new e.Float32BufferAttribute(l,2));let h,c,u,d,p,m=function(t,i,s){t.applyMatrix4(a),i.applyMatrix4(a),s.applyMatrix4(a);let r=1/(2*Math.PI),o=1/Math.PI;return t.normalize(),i.normalize(),s.normalize(),{uv0:new e.Vector2(.5-Math.atan(t.z,-t.x)*r,.5-Math.asin(t.y)*o),uv1:new e.Vector2(.5-Math.atan(i.z,-i.x)*r,.5-Math.asin(i.y)*o),uv2:new e.Vector2(.5-Math.atan(s.z,-s.x)*r,.5-Math.asin(s.y)*o)}},f=function(t,i,r){t.applyMatrix4(a),i.applyMatrix4(a),r.applyMatrix4(a);let o=new e.Vector3;o.crossVectors(i.clone().sub(t),i.clone().sub(r)).normalize(),o.x<0||o.y<0||o.z,o.x=Math.abs(o.x),o.y=Math.abs(o.y),o.z=Math.abs(o.z);let l=new e.Vector2,h=new e.Vector2,c=new e.Vector2,u=1/s;return o.y>o.x&&o.y>o.z?(l.set(t.x-n.min.x,n.max.z-t.z).multiplyScalar(u),h.set(i.x-n.min.x,n.max.z-i.z).multiplyScalar(u),c.set(r.x-n.min.x,n.max.z-r.z).multiplyScalar(u)):o.x>o.y&&o.x>o.z?(l.set(t.z-n.min.z,t.y-n.min.y).multiplyScalar(u),h.set(i.z-n.min.z,i.y-n.min.y).multiplyScalar(u),c.set(r.z-n.min.z,r.y-n.min.y).multiplyScalar(u)):o.z>o.y&&o.z>o.x&&(l.set(t.x-n.min.x,t.y-n.min.y).multiplyScalar(u),h.set(i.x-n.min.x,i.y-n.min.y).multiplyScalar(u),c.set(r.x-n.min.x,r.y-n.min.y).multiplyScalar(u)),{uv0:l,uv1:h,uv2:c}},g=new e.Vector3,y=new e.Vector3,v=new e.Vector3;new e.Vector3,new e.Vector3,new e.Vector3;const b=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(h=0;h<t.index.count;h+=3)c=t.index.getX(h+0),u=t.index.getX(h+1),d=t.index.getX(h+2),g.fromBufferAttribute(b,c),y.fromBufferAttribute(b,u),v.fromBufferAttribute(b,d),p="sphere"===i?m(g,y,v):f(g,y,v),l[2*c]=p.uv0.x,l[2*c+1]=p.uv0.y,l[2*u]=p.uv1.x,l[2*u+1]=p.uv1.y,l[2*d]=p.uv2.x,l[2*d+1]=p.uv2.y;else for(h=0;h<b.count;h+=3){g.fromBufferAttribute(b,h+0),y.fromBufferAttribute(b,h+1),v.fromBufferAttribute(b,h+2),p="sphere"===i?m(g,y,v):f(g,y,v);let t=h,e=h+1,s=h+2;l[2*t]=p.uv0.x,l[2*t+1]=p.uv0.y,l[2*e]=p.uv1.x,l[2*e+1]=p.uv1.y,l[2*s]=p.uv2.x,l[2*s+1]=p.uv2.y}t.attributes.uv.array=new Float32Array(l),t.attributes.uv.needsUpdate=!0}const ft=new e.Vector3,gt=new e.Line3,yt=new e.Plane,vt=new e.Vector3,bt=new e.Triangle;class wt{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new kt,this.unassigned=new kt,this.vertices=[]}setFromPoints(t){if(t.length>=4){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.vertices.push(new St(t[e]));this.compute()}return this}setFromObject(t){const i=[];return t.updateMatrixWorld(!0),t.traverse((function(t){const s=t.geometry;if(void 0!==s){const r=s.attributes.position;if(void 0!==r)for(let s=0,o=r.count;s<o;s++){const o=new e.Vector3;o.fromBufferAttribute(r,s).applyMatrix4(t.matrixWorld),i.push(o)}}})),this.setFromPoints(i)}containsPoint(t){const e=this.faces;for(let i=0,s=e.length;i<s;i++){if(e[i].distanceToPoint(t)>this.tolerance)return!1}return!0}intersectRay(t,e){const i=this.faces;let s=-1/0,r=1/0;for(let e=0,o=i.length;e<o;e++){const o=i[e],a=o.distanceToPoint(t.origin),n=o.normal.dot(t.direction);if(a>0&&n>=0)return null;const l=0!==n?-a/n:0;if(!(l<=0)&&(n>0?r=Math.min(l,r):s=Math.max(l,s),s>r))return null}return s!==-1/0?t.at(s,e):t.at(r,e),e}intersectsRay(t){return null!==this.intersectRay(t,ft)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this}removeVertexFromFace(t,e){return t===e.outside&&(null!==t.next&&t.next.face===e?e.outside=t.next:e.outside=null),this.assigned.remove(t),this}removeAllVerticesFromFace(t){if(null!==t.outside){const e=t.outside;let i=t.outside;for(;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}}deleteFaceVertices(t,e){const i=this.removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{let t=i;do{const i=t.next;e.distanceToPoint(t.point)>this.tolerance?this.addVertexToFace(t,e):this.unassigned.append(t),t=i}while(null!==t)}return this}resolveUnassignedPoints(t){if(!1===this.unassigned.isEmpty()){let e=this.unassigned.first();do{const i=e.next;let s=this.tolerance,r=null;for(let i=0;i<t.length;i++){const o=t[i];if(0===o.mark){const t=o.distanceToPoint(e.point);if(t>s&&(s=t,r=o),s>1e3*this.tolerance)break}}null!==r&&this.addVertexToFace(e,r),e=i}while(null!==e)}return this}computeExtremes(){const t=new e.Vector3,i=new e.Vector3,s=[],r=[];for(let t=0;t<3;t++)s[t]=r[t]=this.vertices[0];t.copy(this.vertices[0].point),i.copy(this.vertices[0].point);for(let e=0,o=this.vertices.length;e<o;e++){const o=this.vertices[e],a=o.point;for(let e=0;e<3;e++)a.getComponent(e)<t.getComponent(e)&&(t.setComponent(e,a.getComponent(e)),s[e]=o);for(let t=0;t<3;t++)a.getComponent(t)>i.getComponent(t)&&(i.setComponent(t,a.getComponent(t)),r[t]=o)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(t.x),Math.abs(i.x))+Math.max(Math.abs(t.y),Math.abs(i.y))+Math.max(Math.abs(t.z),Math.abs(i.z))),{min:s,max:r}}computeInitialHull(){const t=this.vertices,e=this.computeExtremes(),i=e.min,s=e.max;let r=0,o=0;for(let t=0;t<3;t++){const e=s[t].point.getComponent(t)-i[t].point.getComponent(t);e>r&&(r=e,o=t)}const a=i[o],n=s[o];let l,h;r=0,gt.set(a.point,n.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==a&&i!==n){gt.closestPointToPoint(i.point,!0,vt);const t=vt.distanceToSquared(i.point);t>r&&(r=t,l=i)}}r=-1,yt.setFromCoplanarPoints(a.point,n.point,l.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==a&&i!==n&&i!==l){const t=Math.abs(yt.distanceToPoint(i.point));t>r&&(r=t,h=i)}}const c=[];if(yt.distanceToPoint(h.point)<0){c.push(xt.create(a,n,l),xt.create(h,n,a),xt.create(h,l,n),xt.create(h,a,l));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge(e)),c[t+1].getEdge(1).setTwin(c[e+1].getEdge(0))}}else{c.push(xt.create(a,l,n),xt.create(h,a,n),xt.create(h,n,l),xt.create(h,l,a));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge((3-t)%3)),c[t+1].getEdge(0).setTwin(c[e+1].getEdge(1))}}for(let t=0;t<4;t++)this.faces.push(c[t]);for(let e=0,i=t.length;e<i;e++){const i=t[e];if(i!==a&&i!==n&&i!==l&&i!==h){r=this.tolerance;let t=null;for(let e=0;e<4;e++){const s=this.faces[e].distanceToPoint(i.point);s>r&&(r=s,t=this.faces[e])}null!==t&&this.addVertexToFace(i,t)}}return this}reindexFaces(){const t=[];for(let e=0;e<this.faces.length;e++){const i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let t,e=0;const i=this.assigned.first().face;let s=i.outside;do{const r=i.distanceToPoint(s.point);r>e&&(e=r,t=s),s=s.next}while(null!==s&&s.face===i);return t}}computeHorizon(t,e,i,s){let r;this.deleteFaceVertices(i),i.mark=1,r=null===e?e=i.getEdge(0):e.next;do{const e=r.twin,i=e.face;0===i.mark&&(i.distanceToPoint(t)>this.tolerance?this.computeHorizon(t,e,i,s):s.push(r)),r=r.next}while(r!==e);return this}addAdjoiningFace(t,e){const i=xt.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)}addNewFaces(t,e){this.newFaces=[];let i=null,s=null;for(let r=0;r<e.length;r++){const o=e[r],a=this.addAdjoiningFace(t,o);null===i?i=a:a.next.setTwin(s),this.newFaces.push(a.face),s=a}return i.next.setTwin(s),this}addVertexToHull(t){const e=[];return this.unassigned.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),this.addNewFaces(t,e),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let t;for(this.computeInitialHull();void 0!==(t=this.nextVertexToAdd());)this.addVertexToHull(t);return this.reindexFaces(),this.cleanup(),this}}class xt{constructor(){this.normal=new e.Vector3,this.midpoint=new e.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(t,e,i){const s=new xt,r=new Mt(t,s),o=new Mt(e,s),a=new Mt(i,s);return r.next=a.prev=o,o.next=r.prev=a,a.next=o.prev=r,s.edge=r,s.compute()}getEdge(t){let e=this.edge;for(;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e}compute(){const t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return bt.set(t.point,e.point,i.point),bt.getNormal(this.normal),bt.getMidpoint(this.midpoint),this.area=bt.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(t){return this.normal.dot(t)-this.constant}}class Mt{constructor(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1}lengthSquared(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1}setTwin(t){return this.twin=t,t.twin=this,this}}class St{constructor(t){this.point=t,this.prev=null,this.next=null,this.face=null}}class kt{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this}insertAfter(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this}append(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this}appendChain(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this}remove(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this}removeSubList(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this}isEmpty(){return null===this.head}}class At extends e.BufferGeometry{constructor(t=[]){super();const i=[],s=[],r=(new wt).setFromPoints(t).faces;for(let t=0;t<r.length;t++){const e=r[t];let o=e.edge;do{const t=o.head().point;i.push(t.x,t.y,t.z),s.push(e.normal.x,e.normal.y,e.normal.z),o=o.next}while(o!==e.edge)}this.setAttribute("position",new e.Float32BufferAttribute(i,3)),this.setAttribute("normal",new e.Float32BufferAttribute(s,3))}}class Tt extends e.Object3D{constructor(t,i,s,r,o=[0,1,0],a=[0,.5,0],n=!1){if(super(),!t)return;if(!i)return;const l=new e.BufferGeometry;let h=.5*i-t,c=12,u=.2*t,d=[];const p=[t,h,0,t,-h,0,-t,h,0,-t,-h,0,0,h,t-u,0,h,t+u];d.push(...o,...a,...o,...a,...a,...a),n&&(p.push(0,h,t,0,-h,t,0,h,-t,0,-h,-t),d.push(...o,...a,...o,...a));for(let e=0,i=1;e<c;e++,i++){const s=e/c*Math.PI*2,r=i/c*Math.PI*2;p.push(t*Math.cos(s),h,t*Math.sin(s),t*Math.cos(r),h,t*Math.sin(r),t*Math.cos(s),-h,t*Math.sin(s),t*Math.cos(r),-h,t*Math.sin(r)),d.push(...o,...o,...a,...a)}for(let e=0,i=1;e<c;e++,i++){const s=e/c*Math.PI*2,r=i/c*Math.PI*2;let l=i<=6?1:-1;p.push(t*Math.cos(s),h*l+t*Math.sin(s),0,t*Math.cos(r),h*l+t*Math.sin(r),0),1===l?d.push(...o,...o):d.push(...a,...a),n&&(p.push(0,h*l+t*Math.sin(s),t*Math.cos(s),0,h*l+t*Math.sin(r),t*Math.cos(r)),1===l?d.push(...o,...o):d.push(...a,...a))}if(l.setAttribute("position",new e.Float32BufferAttribute(p,3)),l.setAttribute("color",new e.Float32BufferAttribute(d,3)),l.computeBoundingSphere(),this.colors=l.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=l,this.cone=new e.LineSegments(l,r),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!s)return;const m=new e.BufferGeometry,f=[.5*u,-h,t-u,.5*u,-h,t+u,.5*-u,-h,t-u,.5*-u,-h,t+u,.5*u,-h,t-u,.5*-u,-h,t-u,.5*-u,-h,t+u,-u,-h,t+u,.5*u,-h,t+u,u,-h,t+u,-u,-h,t+u,0,-h,t+2*u,u,-h,t+u,0,-h,t+2*u];d=[];let g=f.length/3;for(;g--;)d.push(1,0,0);m.setAttribute("position",new e.Float32BufferAttribute(f,3)),m.setAttribute("color",new e.Float32BufferAttribute(d,3)),this.direction=new e.LineSegments(m,r),this.direction.raycast=function(){return!1},this.add(this.direction)}over(t){t?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(t){let e=this.colors.length;for(;e--;)this.colors[e]=t?1:this.colorsbase[e];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(t){this.direction&&(this.direction.rotation.y=t)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}let Pt=null,Ct=null;const zt=new e.Vector3(0,1,0),Rt=new e.Vector3(1,0,0),Et=new e.Vector3(0,0,1);class _t extends it{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,Pt=this.motor.geo,Ct=this.motor.mat,this.type="body",this.num=U[this.type],this.full=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(t){this.num=U[t?"bodyFull":"body"],this.full=t}step(t,e){const i=this.list;let s,r,o,a=i.length;for(;a--;)if(s=i[a],null!==s)if(r=e+a*this.num,s.actif){if(s.sleep=!(t[r]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.idx,s.sleep?J.sleep:J.body):(s.sleep||"sleep"!==s.material.name||(s.material=Ct.get("body")),s.sleep&&"body"===s.material.name&&(s.material=Ct.get("sleep")))),!s.sleep||s.isKinematic)if(s.position.fromArray(t,r+1),s.quaternion.fromArray(t,r+4),1!==this.motor.ws&&s.position.multiplyScalar(this.motor.uws),this.full?(s.velocity.fromArray(t,r+8),s.angular.fromArray(t,r+11)):s.getVelocity&&(o=this.motor.reflow.velocity[s.name],o&&(s.velocity.fromArray(o,0),s.angular.fromArray(o,3))),s.isInstance){if(s.speedMat){let e=.01*t[r];s.instance.setColorAt(s.idx,[e,e,e])}s.instance.setTransformAt(s.idx,s.position.toArray(),s.quaternion.toArray(),s.noScale?[1,1,1]:s.size),this.needMatrix&&s.matrixWorld.compose(s.position,s.quaternion,{x:1,y:1,z:1})}else s.auto||s.updateMatrix()}else s.actif=!0}geometry(t={},i=null,s=null){let r,o,a,n=t.size,l="",h=t.type,c=!1,u=!1,d=t.seg||16;const p="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(t.instance&&"compound"===h&&(h=t.shapes[0].type,n=t.shapes[0].size,t.translate=t.shapes[0].pos),"mesh"!==h&&"convex"!==h||(t.shape?t.shape.isMesh&&(t.shape=t.shape.geometry):t.mesh&&!t.v&&(t.shape=t.mesh.geometry)),t.radius&&("box"===h&&(h="ChamferBox"),"cylinder"===h&&(h="ChamferCyl")),t.geometry&&("convex"===h?t.shape=t.geometry:h="direct"),"PHYSX"===this.engine&&"cylinder"===t.type){let i=new e.CylinderGeometry(t.size[0],t.size[0],t.size[1],d,1);t.isWheel&&i.rotateZ(-v),t.v=w.getVertex(i),t.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===t.type){let i=new e.CylinderGeometry(0,t.size[0],t.size[1],d,1);t.v=w.getVertex(i),t.type="convex"}switch("stair"===t.type&&(t.type="box",h="box"),h){case"direct":r=t.geometry.clone(),t.size&&r.scale(t.size[0],t.size[1],t.size[2]),u=!0,c=!0;break;case"convex":if(t.v){if(t.nogeo)r=new e.BufferGeometry;else{let i=[];for(o=Math.floor(t.v.length/3);o--;)a=3*o,i.push(new e.Vector3(t.v[a],t.v[a+1],t.v[a+2]));r=new At(i)}u=!0,c=!0}if(t.shape){r=t.shape.clone(),t.size&&r.scale(t.size[0],t.size[0],t.size[0]),t.shapeScale&&r.scale(t.shapeScale[0],t.shapeScale[1],t.shapeScale[2]);let e=p?w.toNonIndexed(r):null;t.v=w.getVertex(e||r,p),t.index=w.getIndex(e||r,p),this.engine,u=!0,c=!0}r.boundingBox||r.computeBoundingBox();let i=r.boundingBox;t.boxSize=[-i.min.x+i.max.x,-i.min.y+i.max.y,-i.min.z+i.max.z];break;case"mesh":if(r=t.shape.clone(),t.size&&r.scale(t.size[0],t.size[0],t.size[0]),t.v=w.getVertex(r,p),t.index=w.getIndex(r,p),"PHYSX"===this.engine){let i=new e.Vector3;w.getCenter(r,i),t.massCenter||(t.massCenter=i.toArray())}u=!0,c=!0;break;case"customSphere":l="customSphere_"+n[0],r=Pt.get(l),r?l="":(r=new e.SphereGeometry(n[0],t.seg1||32,t.seg2||16),r.name=l),c=!0,t.type="sphere";break;case"highSphere":l="highSphere_"+n[0],r=Pt.get(l),r?l="":(r=new nt(n[0]),r.name=l),c=!0,t.type="sphere";break;case"capsule":l="capsule_"+n[0]+"_"+n[1]+"_"+d,r=Pt.get(l),r?l="":(r=new lt(n[0],n[1],d),r.name=l),c=!0;break;case"ChamferBox":l="ChamferBox_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+t.radius,r=Pt.get(l),r?l="":(r=new ut(n[0],n[1],n[2],t.radius),r.name=l),c=!0;break;case"ChamferCyl":l="ChamferCyl_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+t.radius+"_"+d,r=Pt.get(l),r?l="":(r=new ct(n[0],n[0],n[1],t.radius,d),r.name=l),c=!0;break;default:t.breakable?(r=Pt.get(h).clone(),r.scale(n[0],n[1],n[2]),u=!0,c=!0):r=Pt.get(h)}if(t.translate&&r.translate(t.translate[0],t.translate[1],t.translate[2]),t.shape&&delete t.shape,t.geometry&&delete t.geometry,(void 0===r.attributes.uv||t.autoUV)&&mt(r,"box",5,t.pos,t.quat),""!==l&&Pt.set(r),t.isWheel&&(r=r.clone(),r.rotateZ(-v),u=!0),u&&Pt.unic(r),null===i&&null===s)return r.noScale=c,r;t.meshRemplace&&t.debug&&(s=Ct.get("debug"));let m=new e.Mesh(r,s);if(t.button&&(m.isButton=!0),t.helper){let e=t.hcolor||[.3,.1,0],i=t.hcolor2||[.8,.2,0],s=new Tt(n[0],n[1]+2*n[0],!1,Ct.get("liner"),e,i,!0);m.add(s),m.userData.helper=s}t.localRot&&(t.localQuat=w.quatFromEuler(t.localRot)),t.localPos&&m.position.fromArray(t.localPos),t.localQuat&&m.quaternion.fromArray(t.localQuat),c||m.scale.fromArray(t.size),void 0!==t.ray&&(t.ray||(m.raycast=()=>{})),t.meshRemplace&&!t.debug||(i.add(m),m.userData.helper&&(i.over=t=>{m.userData.helper.over(t)}))}add(t={}){t.worldScale&&delete(t=this.scaler(t,t.worldScale)).worldScale;let i,s,r,o=0;if(t.instance||(r=this.setName(t)),t.type=void 0===t.type?"box":t.type,"plane"!==t.type||t.visible||(t.visible=!1),"stair"===t.type){let i=new e.Vector3(0,0,t.size[2]),s=new e.Vector3(0,.5*t.size[1],.5*t.size[2]),r=i.angleTo(s),o=i.distanceTo(s);t.rot=[r*g,0,0],t.size[1]*=t.div||.2,t.size[2]=2*o;let a=new e.Vector3(0,.5*-t.size[1],0);a.applyAxisAngle({x:1,y:0,z:0},r),t.pos[1]+=a.y,t.pos[2]+=a.z}if(t.massCenter&&-1===L.indexOf(this.engine))if("compound"!==t.type)t.shapes=[{type:t.type,pos:t.massCenter,size:t.size}],t.seg&&(t.shapes[0].seg=t.seg),t.radius&&(t.shapes[0].radius=t.radius),delete t.size,t.type="compound";else for(i=0;i<t.shapes.length;i++)s=t.shapes[i],s.pos?s.pos=w.addArray(s.pos,t.massCenter):s.pos=t.massCenter;void 0!==t.collision&&!1===t.collision&&("PHYSX"===this.engine&&(t.flags=0),"OIMO"===this.engine&&(t.mask=0)),t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=w.quatFromEuler(t.rot)),void 0!==t.meshRot&&(t.meshQuat=w.quatFromEuler(t.meshRot)),t.size=w.autoSize(t.size,t.type),t.meshScale&&(t.meshScale=w.autoSize(t.meshScale));let a,n=!1;!1===t.visible&&(t.material="hide"),void 0!==t.material?a=t.material.constructor===String?Ct.get(t.material):t.material:(n=!0,a=Ct.get(this.type),t.instance&&(a=Ct.get("base"))),t.unicMat&&(a=a.clone(),Ct.addToTmp(a));let l=t.instance?{}:new e.Object3D;if(t.mesh&&!t.instance){"terrain"===t.mesh.type&&(t.noClone=!0);let e=t.noClone?t.mesh:t.mesh.clone();if(e.position.fromArray(t.meshPos||[0,0,0]),t.meshQuat&&e.quaternion.fromArray(t.meshQuat),t.meshSize&&e.scale.set(1,1,1).multiplyScalar(t.meshSize),t.meshScale&&e.scale.fromArray(t.meshScale),!n&&(e.material=a,e.children&&!t.nofullmat))for(let t in e.children)e.children[t].material=a;this.motor.tmpMesh.push(e),t.meshRemplace=!0,l.add(e)}switch(t.type){case"null":break;case"compound":for(i=0;i<t.shapes.length;i++)s=t.shapes[i],s.type=void 0===s.type?"box":s.type,s.size=w.autoSize(s.size,s.type),s.pos&&(s.localPos=s.pos),void 0!==s.rot&&(s.quat=w.quatFromEuler(s.rot)),s.quat&&(s.localQuat=s.quat),s.debug=t.debug,s.meshRemplace=t.meshRemplace||!1,t.instance?"convex"===s.type&&(s.v=w.getVertex(s.shape,!1)):this.geometry(s,l,a),o+=w.getVolume(s.type,s.size,s.v);break;default:t.instance?"convex"===t.type&&(t.v=w.getVertex(t.shape,!1)):this.geometry(t,l,a),o=w.getVolume(t.type,t.size,t.v)}if(l.type=this.type,l.size=t.size,l.shapetype=t.type,l.isKinematic=t.kinematic||!1,l.link=0,l.meshSize=t.meshSize?t.meshSize:1,l.velocity=new e.Vector3,l.angular=new e.Vector3,l.sleep=t.sleep||!1,l.defMat=!1,t.button&&(l.isButton=!0),l.isRay=void 0===t.ray||t.ray,l.material&&n&&(l.defMat="body"===l.material.name),t.instance){l.isInstance=!0,l.instance=this.getInstance(t,a),l.instance.isRay=l.isRay,l.over=l.instance.over,l.isRay=!1,l.isOver=!1,l.speedMat=t.speedMat||!1,l.defMat="base"===l.instance.material.name,l.idx=l.instance.count,l.name=t.name?t.name:l.instance.name+l.idx,t.name=l.name,l.noScale=l.instance.noScale,t.sizeByInstance&&(l.noScale=!1);let i=t.color;l.defMat&&(i=t.sleep?J.sleep:J.body),l.instance.add(l,t.pos,t.quat,l.noScale?[1,1,1]:l.size,i),l.position=(new e.Vector3).fromArray(t.pos),l.quaternion=(new at).fromArray(t.quat),this.needMatrix&&(l.matrixWorld=new e.Matrix4),l.instance.v&&(t.v=l.instance.v),l.instance.index&&(t.index=l.instance.index),t.type=l.instance.type,l.actif=!1}else l.name=r,l.isRay||l.traverse((function(t){t.isObject3D&&(t.raycast=()=>{})})),t.renderOrder&&(l.renderOrder=t.renderOrder),void 0===t.visible&&(t.visible=!0),void 0===t.shadow&&(t.shadow=t.visible),l.dispose=function(){this.clearOutLine&&this.clearOutLine(),this.traverse((function(t){t.isMesh&&t.unic&&t.geometry.dispose()})),this.children=[]}.bind(l),l.visible=void 0===t.visible||t.visible,Object.defineProperty(l,"material",{get(){return this.children[0]?this.children[0].material:null},set(t){this.traverse((function(e){e.isMesh&&"outline"!==e.name&&(e.material=t)}))}}),Object.defineProperty(l,"castShadow",{get(){return!!this.children[0]&&this.children[0].castShadow},set(t){this.traverse((function(e){e.isMesh&&(e.castShadow=t)}))}}),Object.defineProperty(l,"receiveShadow",{get(){return!!this.children[0]&&this.children[0].receiveShadow},set(t){this.traverse((function(e){e.isMesh&&(e.receiveShadow=t)}))}}),l.receiveShadow=t.shadow,l.castShadow=t.shadow,this.motor.mouseActive&&(l.overMaterial=Ct.get("outline"),l.isOver=!1,l.addOutLine=function(){this.children[0].isMesh&&(this.outline=(new e.Mesh).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline))}.bind(l),l.clearOutLine=function(){this.outline&&(this.remove(this.outline),this.outline=null)}.bind(l),l.over=function(t){t&&!this.isOver&&this.addOutLine(),!t&&this.isOver&&this.clearOutLine(),this.isOver=t}.bind(l),l.select=function(t){}.bind(l)),this.set(t,l);if(t.breakable){let i=l,s=i.children[0];i.remove(s),l=s,l.position.copy(i.position),l.quaternion.copy(i.quaternion),l.name=r,l.type=this.type,l.breakable=!0,l.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1],l.ignore=t.ignore||[],l.size=t.size,l.shapetype=t.type,l.isKinematic=t.kinematic||!1,l.link=0,l.meshSize=t.meshSize?t.meshSize:1,l.velocity=new e.Vector3,l.angular=new e.Vector3,l.sleep=t.sleep||!1,l.defMat=!1,l.auto=t.auto||!1,l.auto?l.matrixAutoUpdate=!0:(l.matrixAutoUpdate=!1,l.updateMatrix())}if(l.mass=t.mass||0,l.density=t.density||0,l.density&&!l.mass?l.mass=w.massFromDensity(l.density,o):l.mass&&!l.density&&(l.density=w.densityFromMass(l.mass,o),"RAPIER"!==this.engine&&"OIMO"!==this.engine&&"PHYSX"!==this.engine||(t.density=l.density)),t.massInfo&&console.log("%c"+l.name+" %cdensity:"+l.density+" mass:"+l.mass,"font-size:16px","font-size:12px"),t.getVelocity&&(l.getVelocity=!0),this.addToWorld(l,t.id),t.onlyMakeMesh)return l;if(t.phySize&&(t.size=t.phySize),t.phyPos&&(t.pos=t.phyPos),t.rot&&delete t.rot,t.mesh&&delete t.mesh,t.meshRot&&delete t.meshRot,t.instance&&delete t.instance,t.material&&delete t.material,t.parent&&delete t.parent,t.solver&&"PHYSX"===this.engine){t.mass=l.mass;this.byName(t.solver).addBone(t.name)}if(t.sleep&&this.set(t,l),this.motor.post({m:"add",o:t}),t.breakable){this.motor.getBreaker().add(l)}return l}dispatchEvent(t,e,i){this.byName(t).dispatchEvent({type:e,data:i})}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.getVelocity&&(e.getVelocity=t.getVelocity),e.isInstance?(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),(t.pos||t.quat)&&e.instance.setTransformAt(e.idx,e.position.toArray(),e.quaternion.toArray(),e.noScale?[1,1,1]:e.size)):(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),e.auto=t.auto||!1,e.auto?e.matrixAutoUpdate=!0:(e.matrixAutoUpdate=!1,e.updateMatrix())))}getTransform(t){if("string"==typeof t&&(t=this.byName(o.name)),null===t)return;t.updateWorldMatrix(!0,!1);const e=t.matrixWorld.elements;return{position:t.position.clone(),up:zt.clone().set(e[4],e[5],e[6]).normalize(),right:Rt.clone().set(e[0],e[1],e[2]).normalize(),forward:Et.clone().set(e[8],e[9],e[10]).normalize()}}clearInstance(t){let e=this.motor.instanceMesh[t],i=e.getBodyList();this.motor.remove(i),e.dispose(),delete this.motor.instanceMesh[t]}getInstance(t,e){if(this.motor.instanceMesh[t.instance])return this.motor.instanceMesh[t.instance];(t={...t}).sizeByInstance&&(t.size=[1,1,1]);let i=this.geometry(t);t.mesh&&(!t.material&&t.mesh.material&&(e=t.mesh.material),i=t.mesh.isObject3D?t.mesh.geometry.clone():t.mesh.clone(),t.meshSize&&i.scale(t.meshSize,t.meshSize,t.meshSize),t.meshScale&&i.scale(t.meshScale[0],t.meshScale[1],t.meshScale[2]),i.noScale=!0);let s=new ot(i,e,0);return s.type=t.type,s.noScale=i.noScale,"convex"===s.type&&(s.v=t.v),t.index&&(s.index=t.index),s.receiveShadow=void 0===t.shadow||t.shadow,s.castShadow=void 0===t.shadow||t.shadow,this.motor.mouseActive&&(s.overMaterial=Ct.get("outline")),s.name=t.instance,this.motor.scene.add(s),this.motor.instanceMesh[t.instance]=s,s}scaler(t,e){if(t.size&&(t.size=math.worldscale(t.size,e)),t.pos&&(t.pos=math.worldscale(t.pos,e)),"convex"===t.type&&(t.shapeScale=[e,e,e]),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(i.size=math.scaleArray(i.size,e)),i.pos&&(i.pos=math.scaleArray(i.pos,e)),"convex"===i.type&&(i.shapeScale=[e,e,e])}return t.mesh&&(t.meshScale=[e,e,e]),t}}const Lt=e.SRGBColorSpace;class Vt extends e.Loader{constructor(t){super(t),this.defaultDPI=90,this.defaultUnit="px"}load(t,i,s,r){const o=this,a=new e.FileLoader(o.manager);a.setPath(o.path),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(t,(function(e){try{i(o.parse(e))}catch(e){r?r(e):console.error(e),o.manager.itemError(t)}}),s,r)}parse(t){const i=this;function s(t,e,i,s,o,a,n,l){if(0==e||0==i)return void t.lineTo(l.x,l.y);s=s*Math.PI/180,e=Math.abs(e),i=Math.abs(i);const h=(n.x-l.x)/2,c=(n.y-l.y)/2,u=Math.cos(s)*h+Math.sin(s)*c,d=-Math.sin(s)*h+Math.cos(s)*c;let p=e*e,m=i*i;const f=u*u,g=d*d,y=f/p+g/m;if(y>1){const t=Math.sqrt(y);p=(e*=t)*e,m=(i*=t)*i}const v=p*g+m*f,b=(p*m-v)/v;let w=Math.sqrt(Math.max(0,b));o===a&&(w=-w);const x=w*e*d/i,M=-w*i*u/e,S=Math.cos(s)*x-Math.sin(s)*M+(n.x+l.x)/2,k=Math.sin(s)*x+Math.cos(s)*M+(n.y+l.y)/2,A=r(1,0,(u-x)/e,(d-M)/i),T=r((u-x)/e,(d-M)/i,(-u-x)/e,(-d-M)/i)%(2*Math.PI);t.currentPath.absellipse(S,k,e,i,A,A+T,0===a,s)}function r(t,e,i,s){const r=t*i+e*s,o=Math.sqrt(t*t+e*e)*Math.sqrt(i*i+s*s);let a=Math.acos(Math.max(-1,Math.min(1,r/o)));return t*s-e*i<0&&(a=-a),a}function o(t,e){e=Object.assign({},e);let i={};if(t.hasAttribute("class")){const e=t.getAttribute("class").split(/\s/).filter(Boolean).map((t=>t.trim()));for(let t=0;t<e.length;t++)i=Object.assign(i,g["."+e[t]])}function s(s,r,o){void 0===o&&(o=function(t){return t.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),t}),t.hasAttribute(s)&&(e[r]=o(t.getAttribute(s))),i[s]&&(e[r]=o(i[s])),t.style&&""!==t.style[s]&&(e[r]=o(t.style[s]))}function r(t){return Math.max(0,Math.min(1,c(t)))}function o(t){return Math.max(0,c(t))}return t.hasAttribute("id")&&(i=Object.assign(i,g["#"+t.getAttribute("id")])),s("fill","fill"),s("fill-opacity","fillOpacity",r),s("fill-rule","fillRule"),s("opacity","opacity",r),s("stroke","stroke"),s("stroke-opacity","strokeOpacity",r),s("stroke-width","strokeWidth",o),s("stroke-linejoin","strokeLineJoin"),s("stroke-linecap","strokeLineCap"),s("stroke-miterlimit","strokeMiterLimit",o),s("visibility","visibility"),e}function a(t,e){return t-(e-t)}function n(t,e,i){if("string"!=typeof t)throw new TypeError("Invalid input: "+typeof t);const s={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let r=0,o=!0,a="",n="";const l=[];function h(t,e,i){const s=new SyntaxError('Unexpected character "'+t+'" at index '+e+".");throw s.partial=i,s}function c(){""!==a&&(""===n?l.push(Number(a)):l.push(Number(a)*Math.pow(10,Number(n)))),a="",n=""}let u;const d=t.length;for(let p=0;p<d;p++)if(u=t[p],Array.isArray(e)&&e.includes(l.length%i)&&s.FLAGS.test(u))r=1,a=u,c();else{if(0===r){if(s.WHITESPACE.test(u))continue;if(s.DIGIT.test(u)||s.SIGN.test(u)){r=1,a=u;continue}if(s.POINT.test(u)){r=2,a=u;continue}s.COMMA.test(u)&&(o&&h(u,p,l),o=!0)}if(1===r){if(s.DIGIT.test(u)){a+=u;continue}if(s.POINT.test(u)){a+=u,r=2;continue}if(s.EXP.test(u)){r=3;continue}s.SIGN.test(u)&&1===a.length&&s.SIGN.test(a[0])&&h(u,p,l)}if(2===r){if(s.DIGIT.test(u)){a+=u;continue}if(s.EXP.test(u)){r=3;continue}s.POINT.test(u)&&"."===a[a.length-1]&&h(u,p,l)}if(3===r){if(s.DIGIT.test(u)){n+=u;continue}if(s.SIGN.test(u)){if(""===n){n+=u;continue}1===n.length&&s.SIGN.test(n)&&h(u,p,l)}}s.WHITESPACE.test(u)?(c(),r=0,o=!1):s.COMMA.test(u)?(c(),r=0,o=!0):s.SIGN.test(u)?(c(),r=1,a=u):s.POINT.test(u)?(c(),r=2,a=u):h(u,p,l)}return c(),l}const l=["mm","cm","in","pt","pc","px"],h={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function c(t){let e,s="px";if("string"==typeof t||t instanceof String)for(let e=0,i=l.length;e<i;e++){const i=l[e];if(t.endsWith(i)){s=i,t=t.substring(0,t.length-i.length);break}}return"px"===s&&"px"!==i.defaultUnit?e=h.in[i.defaultUnit]/i.defaultDPI:(e=h[s][i.defaultUnit],e<0&&(e=h[s].in*i.defaultDPI)),e*parseFloat(t)}function u(t){const e=t.elements;return e[0]*e[4]-e[1]*e[3]<0}function d(t){const e=t.elements,i=e[0]*e[3]+e[1]*e[4];if(0===i)return!1;const s=p(t),r=m(t);return Math.abs(i/(s*r))>Number.EPSILON}function p(t){const e=t.elements;return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function m(t){const e=t.elements;return Math.sqrt(e[3]*e[3]+e[4]*e[4])}const f=[],g={},y=[],v=new e.Matrix3,b=new e.Matrix3,w=new e.Matrix3,x=new e.Matrix3,M=new e.Vector2,S=new e.Vector3,k=new e.Matrix3,A=(new DOMParser).parseFromString(t,"image/svg+xml");!function t(i,r){if(1!==i.nodeType)return;const l=function(t){if(!(t.hasAttribute("transform")||"use"===t.nodeName&&(t.hasAttribute("x")||t.hasAttribute("y"))))return null;const i=function(t){const i=new e.Matrix3,s=v;if("use"===t.nodeName&&(t.hasAttribute("x")||t.hasAttribute("y"))){const e=c(t.getAttribute("x")),s=c(t.getAttribute("y"));i.translate(e,s)}if(t.hasAttribute("transform")){const e=t.getAttribute("transform").split(")");for(let t=e.length-1;t>=0;t--){const r=e[t].trim();if(""===r)continue;const o=r.indexOf("("),a=r.length;if(o>0&&o<a){const t=r.slice(0,o),e=n(r.slice(o+1));switch(s.identity(),t){case"translate":if(e.length>=1){const t=e[0];let i=0;e.length>=2&&(i=e[1]),s.translate(t,i)}break;case"rotate":if(e.length>=1){let t=0,i=0,r=0;t=e[0]*Math.PI/180,e.length>=3&&(i=e[1],r=e[2]),b.makeTranslation(-i,-r),w.makeRotation(t),x.multiplyMatrices(w,b),b.makeTranslation(i,r),s.multiplyMatrices(b,x)}break;case"scale":if(e.length>=1){const t=e[0];let i=t;e.length>=2&&(i=e[1]),s.scale(t,i)}break;case"skewX":1===e.length&&s.set(1,Math.tan(e[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===e.length&&s.set(1,0,0,Math.tan(e[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===e.length&&s.set(e[0],e[2],e[4],e[1],e[3],e[5],0,0,1)}}i.premultiply(s)}}return i}(t);y.length>0&&i.premultiply(y[y.length-1]);return k.copy(i),y.push(i),i}(i);let h=!1,A=null;switch(i.nodeName){case"svg":case"g":r=o(i,r);break;case"style":!function(t){if(!t.sheet||!t.sheet.cssRules||!t.sheet.cssRules.length)return;for(let e=0;e<t.sheet.cssRules.length;e++){const i=t.sheet.cssRules[e];if(1!==i.type)continue;const s=i.selectorText.split(/,/gm).filter(Boolean).map((t=>t.trim()));for(let t=0;t<s.length;t++){const e=Object.fromEntries(Object.entries(i.style).filter((([,t])=>""!==t)));g[s[t]]=Object.assign(g[s[t]]||{},e)}}}(i);break;case"path":r=o(i,r),i.hasAttribute("d")&&(A=function(t){const i=new e.ShapePath,r=new e.Vector2,o=new e.Vector2,l=new e.Vector2;let h=!0,c=!1;const u=t.getAttribute("d");if(""===u||"none"===u)return null;const d=u.match(/[a-df-z][^a-df-z]*/gi);for(let t=0,e=d.length;t<e;t++){const e=d[t],u=e.charAt(0),p=e.slice(1).trim();let m;switch(!0===h&&(c=!0,h=!1),u){case"M":m=n(p);for(let t=0,e=m.length;t<e;t+=2)r.x=m[t+0],r.y=m[t+1],o.x=r.x,o.y=r.y,0===t?i.moveTo(r.x,r.y):i.lineTo(r.x,r.y),0===t&&l.copy(r);break;case"H":m=n(p);for(let t=0,e=m.length;t<e;t++)r.x=m[t],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"V":m=n(p);for(let t=0,e=m.length;t<e;t++)r.y=m[t],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"L":m=n(p);for(let t=0,e=m.length;t<e;t+=2)r.x=m[t+0],r.y=m[t+1],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"C":m=n(p);for(let t=0,e=m.length;t<e;t+=6)i.bezierCurveTo(m[t+0],m[t+1],m[t+2],m[t+3],m[t+4],m[t+5]),o.x=m[t+2],o.y=m[t+3],r.x=m[t+4],r.y=m[t+5],0===t&&!0===c&&l.copy(r);break;case"S":m=n(p);for(let t=0,e=m.length;t<e;t+=4)i.bezierCurveTo(a(r.x,o.x),a(r.y,o.y),m[t+0],m[t+1],m[t+2],m[t+3]),o.x=m[t+0],o.y=m[t+1],r.x=m[t+2],r.y=m[t+3],0===t&&!0===c&&l.copy(r);break;case"Q":m=n(p);for(let t=0,e=m.length;t<e;t+=4)i.quadraticCurveTo(m[t+0],m[t+1],m[t+2],m[t+3]),o.x=m[t+0],o.y=m[t+1],r.x=m[t+2],r.y=m[t+3],0===t&&!0===c&&l.copy(r);break;case"T":m=n(p);for(let t=0,e=m.length;t<e;t+=2){const e=a(r.x,o.x),s=a(r.y,o.y);i.quadraticCurveTo(e,s,m[t+0],m[t+1]),o.x=e,o.y=s,r.x=m[t+0],r.y=m[t+1],0===t&&!0===c&&l.copy(r)}break;case"A":m=n(p,[3,4],7);for(let t=0,e=m.length;t<e;t+=7){if(m[t+5]==r.x&&m[t+6]==r.y)continue;const e=r.clone();r.x=m[t+5],r.y=m[t+6],o.x=r.x,o.y=r.y,s(i,m[t],m[t+1],m[t+2],m[t+3],m[t+4],e,r),0===t&&!0===c&&l.copy(r)}break;case"m":m=n(p);for(let t=0,e=m.length;t<e;t+=2)r.x+=m[t+0],r.y+=m[t+1],o.x=r.x,o.y=r.y,0===t?i.moveTo(r.x,r.y):i.lineTo(r.x,r.y),0===t&&l.copy(r);break;case"h":m=n(p);for(let t=0,e=m.length;t<e;t++)r.x+=m[t],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"v":m=n(p);for(let t=0,e=m.length;t<e;t++)r.y+=m[t],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"l":m=n(p);for(let t=0,e=m.length;t<e;t+=2)r.x+=m[t+0],r.y+=m[t+1],o.x=r.x,o.y=r.y,i.lineTo(r.x,r.y),0===t&&!0===c&&l.copy(r);break;case"c":m=n(p);for(let t=0,e=m.length;t<e;t+=6)i.bezierCurveTo(r.x+m[t+0],r.y+m[t+1],r.x+m[t+2],r.y+m[t+3],r.x+m[t+4],r.y+m[t+5]),o.x=r.x+m[t+2],o.y=r.y+m[t+3],r.x+=m[t+4],r.y+=m[t+5],0===t&&!0===c&&l.copy(r);break;case"s":m=n(p);for(let t=0,e=m.length;t<e;t+=4)i.bezierCurveTo(a(r.x,o.x),a(r.y,o.y),r.x+m[t+0],r.y+m[t+1],r.x+m[t+2],r.y+m[t+3]),o.x=r.x+m[t+0],o.y=r.y+m[t+1],r.x+=m[t+2],r.y+=m[t+3],0===t&&!0===c&&l.copy(r);break;case"q":m=n(p);for(let t=0,e=m.length;t<e;t+=4)i.quadraticCurveTo(r.x+m[t+0],r.y+m[t+1],r.x+m[t+2],r.y+m[t+3]),o.x=r.x+m[t+0],o.y=r.y+m[t+1],r.x+=m[t+2],r.y+=m[t+3],0===t&&!0===c&&l.copy(r);break;case"t":m=n(p);for(let t=0,e=m.length;t<e;t+=2){const e=a(r.x,o.x),s=a(r.y,o.y);i.quadraticCurveTo(e,s,r.x+m[t+0],r.y+m[t+1]),o.x=e,o.y=s,r.x=r.x+m[t+0],r.y=r.y+m[t+1],0===t&&!0===c&&l.copy(r)}break;case"a":m=n(p,[3,4],7);for(let t=0,e=m.length;t<e;t+=7){if(0==m[t+5]&&0==m[t+6])continue;const e=r.clone();r.x+=m[t+5],r.y+=m[t+6],o.x=r.x,o.y=r.y,s(i,m[t],m[t+1],m[t+2],m[t+3],m[t+4],e,r),0===t&&!0===c&&l.copy(r)}break;case"Z":case"z":i.currentPath.autoClose=!0,i.currentPath.curves.length>0&&(r.copy(l),i.currentPath.currentPoint.copy(r),h=!0);break;default:console.warn(e)}c=!1}return i}(i));break;case"rect":r=o(i,r),A=function(t){const i=c(t.getAttribute("x")||0),s=c(t.getAttribute("y")||0),r=c(t.getAttribute("rx")||t.getAttribute("ry")||0),o=c(t.getAttribute("ry")||t.getAttribute("rx")||0),a=c(t.getAttribute("width")),n=c(t.getAttribute("height")),l=.448084975506,h=new e.ShapePath;h.moveTo(i+r,s),h.lineTo(i+a-r,s),(0!==r||0!==o)&&h.bezierCurveTo(i+a-r*l,s,i+a,s+o*l,i+a,s+o);h.lineTo(i+a,s+n-o),(0!==r||0!==o)&&h.bezierCurveTo(i+a,s+n-o*l,i+a-r*l,s+n,i+a-r,s+n);h.lineTo(i+r,s+n),(0!==r||0!==o)&&h.bezierCurveTo(i+r*l,s+n,i,s+n-o*l,i,s+n-o);h.lineTo(i,s+o),(0!==r||0!==o)&&h.bezierCurveTo(i,s+o*l,i+r*l,s,i+r,s);return h}(i);break;case"polygon":r=o(i,r),A=function(t){function i(t,e,i){const s=c(e),a=c(i);0===o?r.moveTo(s,a):r.lineTo(s,a),o++}const s=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,r=new e.ShapePath;let o=0;return t.getAttribute("points").replace(s,i),r.currentPath.autoClose=!0,r}(i);break;case"polyline":r=o(i,r),A=function(t){function i(t,e,i){const s=c(e),a=c(i);0===o?r.moveTo(s,a):r.lineTo(s,a),o++}const s=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,r=new e.ShapePath;let o=0;return t.getAttribute("points").replace(s,i),r.currentPath.autoClose=!1,r}(i);break;case"circle":r=o(i,r),A=function(t){const i=c(t.getAttribute("cx")||0),s=c(t.getAttribute("cy")||0),r=c(t.getAttribute("r")||0),o=new e.Path;o.absarc(i,s,r,0,2*Math.PI);const a=new e.ShapePath;return a.subPaths.push(o),a}(i);break;case"ellipse":r=o(i,r),A=function(t){const i=c(t.getAttribute("cx")||0),s=c(t.getAttribute("cy")||0),r=c(t.getAttribute("rx")||0),o=c(t.getAttribute("ry")||0),a=new e.Path;a.absellipse(i,s,r,o,0,2*Math.PI);const n=new e.ShapePath;return n.subPaths.push(a),n}(i);break;case"line":r=o(i,r),A=function(t){const i=c(t.getAttribute("x1")||0),s=c(t.getAttribute("y1")||0),r=c(t.getAttribute("x2")||0),o=c(t.getAttribute("y2")||0),a=new e.ShapePath;return a.moveTo(i,s),a.lineTo(r,o),a.currentPath.autoClose=!1,a}(i);break;case"defs":h=!0;break;case"use":r=o(i,r);const l=(i.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),u=i.viewportElement.getElementById(l);u?t(u,r):console.warn("SVGLoader: 'use node' references non-existent node id: "+l)}A&&(void 0!==r.fill&&"none"!==r.fill&&A.color.setStyle(r.fill,Lt),function(t,i){function s(t){S.set(t.x,t.y,1).applyMatrix3(i),t.set(S.x,S.y)}function r(t){const s=t.xRadius,r=t.yRadius,o=Math.cos(t.aRotation),a=Math.sin(t.aRotation),n=new e.Vector3(s*o,s*a,0),l=new e.Vector3(-r*a,r*o,0),h=n.applyMatrix3(i),c=l.applyMatrix3(i),d=v.set(h.x,c.x,0,h.y,c.y,0,0,0,1),p=b.copy(d).invert(),m=w.copy(p).transpose().multiply(p).elements,f=function(t,e,i){let s,r,o,a,n;const l=t+i,h=t-i,c=Math.sqrt(h*h+4*e*e);l>0?(s=.5*(l+c),n=1/s,r=t*n*i-e*n*e):l<0?r=.5*(l-c):(s=.5*c,r=-.5*c);o=h>0?h+c:h-c;Math.abs(o)>2*Math.abs(e)?(n=-2*e/o,a=1/Math.sqrt(1+n*n),o=n*a):0===Math.abs(e)?(o=1,a=0):(n=-.5*o/e,o=1/Math.sqrt(1+n*n),a=n*o);h>0&&(n=o,o=-a,a=n);return{rt1:s,rt2:r,cs:o,sn:a}}(m[0],m[1],m[4]),g=Math.sqrt(f.rt1),y=Math.sqrt(f.rt2);t.xRadius=1/g,t.yRadius=1/y,t.aRotation=Math.atan2(f.sn,f.cs);if(!((t.aEndAngle-t.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const s=b.set(g,0,0,0,y,0,0,0,1),r=w.set(f.cs,f.sn,0,-f.sn,f.cs,0,0,0,1),o=s.multiply(r).multiply(d),a=t=>{const{x:i,y:s}=new e.Vector3(Math.cos(t),Math.sin(t),0).applyMatrix3(o);return Math.atan2(s,i)};t.aStartAngle=a(t.aStartAngle),t.aEndAngle=a(t.aEndAngle),u(i)&&(t.aClockwise=!t.aClockwise)}}function o(t){const e=p(i),s=m(i);t.xRadius*=e,t.yRadius*=s;const r=e>Number.EPSILON?Math.atan2(i.elements[1],i.elements[0]):Math.atan2(-i.elements[3],i.elements[4]);t.aRotation+=r,u(i)&&(t.aStartAngle*=-1,t.aEndAngle*=-1,t.aClockwise=!t.aClockwise)}const a=t.subPaths;for(let t=0,e=a.length;t<e;t++){const e=a[t].curves;for(let t=0;t<e.length;t++){const a=e[t];a.isLineCurve?(s(a.v1),s(a.v2)):a.isCubicBezierCurve?(s(a.v0),s(a.v1),s(a.v2),s(a.v3)):a.isQuadraticBezierCurve?(s(a.v0),s(a.v1),s(a.v2)):a.isEllipseCurve&&(M.set(a.aX,a.aY),s(M),a.aX=M.x,a.aY=M.y,d(i)?r(a):o(a))}}}(A,k),f.push(A),A.userData={node:i,style:r});const T=i.childNodes;for(let e=0;e<T.length;e++){const i=T[e];h&&"style"!==i.nodeName&&"defs"!==i.nodeName||t(i,r)}l&&(y.pop(),y.length>0?k.copy(y[y.length-1]):k.identity())}(A.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:f,xml:A.documentElement}}static createShapes(t){const i=999999999,s=0,r=1,o=2,a=3,n=4,l=5,h=6,c={loc:s,t:0};function u(t,e,i,r){const a=t.x,n=e.x,l=i.x,h=r.x,u=t.y,p=e.y,m=i.y,f=r.y,g=(h-l)*(u-m)-(f-m)*(a-l),y=(f-m)*(n-a)-(h-l)*(p-u),v=g/y,b=((n-a)*(u-m)-(p-u)*(a-l))/y;if(0===y&&0!==g||v<=0||v>=1||b<0||b>1)return null;if(0===g&&0===y){for(let l=0;l<2;l++){if(d(0===l?i:r,t,e),c.loc==s){const t=0===l?i:r;return{x:t.x,y:t.y,t:c.t}}if(c.loc==o){return{x:+(a+c.t*(n-a)).toPrecision(10),y:+(u+c.t*(p-u)).toPrecision(10),t:c.t}}}return null}for(let o=0;o<2;o++)if(d(0===o?i:r,t,e),c.loc==s){const t=0===o?i:r;return{x:t.x,y:t.y,t:c.t}}return{x:+(a+v*(n-a)).toPrecision(10),y:+(u+v*(p-u)).toPrecision(10),t:v}}function d(t,e,i){const u=i.x-e.x,d=i.y-e.y,p=t.x-e.x,m=t.y-e.y,f=u*m-p*d;if(t.x===e.x&&t.y===e.y)return c.loc=s,void(c.t=0);if(t.x===i.x&&t.y===i.y)return c.loc=r,void(c.t=1);if(f<-Number.EPSILON)return void(c.loc=a);if(f>Number.EPSILON)return void(c.loc=n);if(u*p<0||d*m<0)return void(c.loc=l);if(Math.sqrt(u*u+d*d)<Math.sqrt(p*p+m*m))return void(c.loc=h);let g;g=0!==u?p/u:m/d,c.loc=o,c.t=g}function p(t,i,s){const r=new e.Vector2;i.getCenter(r);const o=[];return s.forEach((i=>{if(i.boundingBox.containsPoint(r)){const s=function(t,i){const s=[],r=[];for(let o=1;o<t.length;o++){const a=t[o-1],n=t[o];for(let t=1;t<i.length;t++){const o=u(a,n,i[t-1],i[t]);null!==o&&void 0===s.find((t=>t.t<=o.t+Number.EPSILON&&t.t>=o.t-Number.EPSILON))&&(s.push(o),r.push(new e.Vector2(o.x,o.y)))}}return r}(t,i.points);s.forEach((t=>{o.push({identifier:i.identifier,isCW:i.isCW,point:t})}))}})),o.sort(((t,e)=>t.point.x-e.point.x)),o}let m=i,f=-999999999,g=t.subPaths.map((t=>{const s=t.getPoints();let r=-999999999,o=i,a=-999999999,n=i;for(let t=0;t<s.length;t++){const e=s[t];e.y>r&&(r=e.y),e.y<o&&(o=e.y),e.x>a&&(a=e.x),e.x<n&&(n=e.x)}return f<=a&&(f=a+1),m>=n&&(m=n-1),{curves:t.curves,points:s,isCW:e.ShapeUtils.isClockWise(s),identifier:-1,boundingBox:new e.Box2(new e.Vector2(n,o),new e.Vector2(a,r))}}));g=g.filter((t=>t.points.length>1));for(let t=0;t<g.length;t++)g[t].identifier=t;const y=g.map((i=>function(t,i,s,r,o){null!=o&&""!==o||(o="nonzero");const a=new e.Vector2;t.boundingBox.getCenter(a);const n=p([new e.Vector2(s,a.y),new e.Vector2(r,a.y)],t.boundingBox,i);n.sort(((t,e)=>t.point.x-e.point.x));const l=[],h=[];n.forEach((e=>{e.identifier===t.identifier?l.push(e):h.push(e)}));const c=l[0].point.x,u=[];let d=0;for(;d<h.length&&h[d].point.x<c;)u.length>0&&u[u.length-1]===h[d].identifier?u.pop():u.push(h[d].identifier),d++;if(u.push(t.identifier),"evenodd"===o){const e=u.length%2==0,i=u[u.length-2];return{identifier:t.identifier,isHole:e,for:i}}if("nonzero"===o){let e=!0,s=null,r=null;for(let t=0;t<u.length;t++){const o=u[t];e?(r=i[o].isCW,e=!1,s=o):r!==i[o].isCW&&(r=i[o].isCW,e=!0)}return{identifier:t.identifier,isHole:e,for:s}}console.warn('fill-rule: "'+o+'" is currently not implemented.')}(i,g,m,f,t.userData?t.userData.style.fillRule:void 0))),v=[];return g.forEach((t=>{if(!y[t.identifier].isHole){const i=new e.Shape;i.curves=t.curves;const s=y.filter((e=>e.isHole&&e.for===t.identifier));s.forEach((t=>{const s=g[t.identifier],r=new e.Path;r.curves=s.curves,i.holes.push(r)})),v.push(i)}})),v}static getStrokeStyle(t,e,i,s,r){return{strokeColor:e=void 0!==e?e:"#000",strokeWidth:t=void 0!==t?t:1,strokeLineJoin:i=void 0!==i?i:"miter",strokeLineCap:s=void 0!==s?s:"butt",strokeMiterLimit:r=void 0!==r?r:4}}static pointsToStroke(t,i,s,r){const o=[],a=[],n=[];if(0===Vt.pointsToStrokeWithBuffers(t,i,s,r,o,a,n))return null;const l=new e.BufferGeometry;return l.setAttribute("position",new e.Float32BufferAttribute(o,3)),l.setAttribute("normal",new e.Float32BufferAttribute(a,3)),l.setAttribute("uv",new e.Float32BufferAttribute(n,2)),l}static pointsToStrokeWithBuffers(t,i,s,r,o,a,n,l){const h=new e.Vector2,c=new e.Vector2,u=new e.Vector2,d=new e.Vector2,p=new e.Vector2,m=new e.Vector2,f=new e.Vector2,g=new e.Vector2,y=new e.Vector2,v=new e.Vector2,b=new e.Vector2,w=new e.Vector2,x=new e.Vector2,M=new e.Vector2,S=new e.Vector2,k=new e.Vector2,A=new e.Vector2;s=void 0!==s?s:12,r=void 0!==r?r:.001,l=void 0!==l?l:0,t=function(t){let e=!1;for(let i=1,s=t.length-1;i<s;i++)if(t[i].distanceTo(t[i+1])<r){e=!0;break}if(!e)return t;const i=[];i.push(t[0]);for(let e=1,s=t.length-1;e<s;e++)t[e].distanceTo(t[e+1])>=r&&i.push(t[e]);return i.push(t[t.length-1]),i}(t);const T=t.length;if(T<2)return 0;const P=t[0].equals(t[T-1]);let C,z,R=t[0];const E=i.strokeWidth/2,_=1/(T-1);let L,V,B,I,F=0,D=!1,O=0,N=3*l,U=2*l;q(t[0],t[1],h).multiplyScalar(E),g.copy(t[0]).sub(h),y.copy(t[0]).add(h),v.copy(g),b.copy(y);for(let e=1;e<T;e++){C=t[e],z=e===T-1?P?t[1]:void 0:t[e+1];const s=h;if(q(R,C,s),u.copy(s).multiplyScalar(E),w.copy(C).sub(u),x.copy(C).add(u),L=F+_,V=!1,void 0!==z){q(C,z,c),u.copy(c).multiplyScalar(E),M.copy(C).sub(u),S.copy(C).add(u),B=!0,u.subVectors(z,R),s.dot(u)<0&&(B=!1),1===e&&(D=B),u.subVectors(z,C),u.normalize();const t=Math.abs(s.dot(u));if(t>Number.EPSILON){const e=E/t;u.multiplyScalar(-e),d.subVectors(C,R),p.copy(d).setLength(e).add(u),k.copy(p).negate();const s=p.length(),r=d.length();d.divideScalar(r),m.subVectors(z,C);const o=m.length();switch(m.divideScalar(o),d.dot(k)<r&&m.dot(k)<o&&(V=!0),A.copy(p).add(C),k.add(C),I=!1,V?B?(S.copy(k),x.copy(k)):(M.copy(k),w.copy(k)):W(),i.strokeLineJoin){case"bevel":H(B,V,L);break;case"round":X(B,V),B?G(C,w,M,L,0):G(C,S,x,L,1);break;default:const t=E*i.strokeMiterLimit/s;if(t<1){if("miter-clip"!==i.strokeLineJoin){H(B,V,L);break}X(B,V),B?(m.subVectors(A,w).multiplyScalar(t).add(w),f.subVectors(A,M).multiplyScalar(t).add(M),j(w,L,0),j(m,L,0),j(C,L,.5),j(C,L,.5),j(m,L,0),j(f,L,0),j(C,L,.5),j(f,L,0),j(M,L,0)):(m.subVectors(A,x).multiplyScalar(t).add(x),f.subVectors(A,S).multiplyScalar(t).add(S),j(x,L,1),j(m,L,1),j(C,L,.5),j(C,L,.5),j(m,L,1),j(f,L,1),j(C,L,.5),j(f,L,1),j(S,L,1))}else V?(B?(j(y,F,1),j(g,F,0),j(A,L,0),j(y,F,1),j(A,L,0),j(k,L,1)):(j(y,F,1),j(g,F,0),j(A,L,1),j(g,F,0),j(k,L,0),j(A,L,1)),B?M.copy(A):S.copy(A)):B?(j(w,L,0),j(A,L,0),j(C,L,.5),j(C,L,.5),j(A,L,0),j(M,L,0)):(j(x,L,1),j(A,L,1),j(C,L,.5),j(C,L,.5),j(A,L,1),j(S,L,1)),I=!0}}else W()}else W();P||e!==T-1||Q(t[0],v,b,B,!0,F),F=L,R=C,g.copy(M),y.copy(S)}if(P){if(V&&o){let t=A,e=k;D!==B&&(t=k,e=A),B?(I||D)&&(e.toArray(o,0),e.toArray(o,9),I&&t.toArray(o,3)):!I&&D||(e.toArray(o,3),e.toArray(o,9),I&&t.toArray(o,0))}}else Q(C,w,x,B,!1,L);return O;function q(t,e,i){return i.subVectors(e,t),i.set(-i.y,i.x).normalize()}function j(t,e,i){o&&(o[N]=t.x,o[N+1]=t.y,o[N+2]=0,a&&(a[N]=0,a[N+1]=0,a[N+2]=1),N+=3,n&&(n[U]=e,n[U+1]=i,U+=2)),O+=3}function G(t,e,i,r,o){h.copy(e).sub(t).normalize(),c.copy(i).sub(t).normalize();let a=Math.PI;const n=h.dot(c);Math.abs(n)<1&&(a=Math.abs(Math.acos(n))),a/=s,u.copy(e);for(let e=0,i=s-1;e<i;e++)d.copy(u).rotateAround(t,a),j(u,r,o),j(d,r,o),j(t,r,.5),u.copy(d);j(d,r,o),j(i,r,o),j(t,r,.5)}function W(){j(y,F,1),j(g,F,0),j(w,L,0),j(y,F,1),j(w,L,1),j(x,L,0)}function H(t,e,i){e?t?(j(y,F,1),j(g,F,0),j(w,L,0),j(y,F,1),j(w,L,0),j(k,L,1),j(w,i,0),j(M,i,0),j(k,i,.5)):(j(y,F,1),j(g,F,0),j(x,L,1),j(g,F,0),j(k,L,0),j(x,L,1),j(x,i,1),j(S,i,0),j(k,i,.5)):t?(j(w,i,0),j(M,i,0),j(C,i,.5)):(j(x,i,1),j(S,i,0),j(C,i,.5))}function X(t,e){e&&(t?(j(y,F,1),j(g,F,0),j(w,L,0),j(y,F,1),j(w,L,0),j(k,L,1),j(w,F,0),j(C,L,.5),j(k,L,1),j(C,L,.5),j(M,F,0),j(k,L,1)):(j(y,F,1),j(g,F,0),j(x,L,1),j(g,F,0),j(k,L,0),j(x,L,1),j(x,F,1),j(k,L,0),j(C,L,.5),j(C,L,.5),j(k,L,0),j(S,F,1)))}function Q(t,e,s,r,a,n){switch(i.strokeLineCap){case"round":a?G(t,s,e,n,.5):G(t,e,s,n,.5);break;case"square":if(a)h.subVectors(e,t),c.set(h.y,-h.x),u.addVectors(h,c).add(t),d.subVectors(c,h).add(t),r?(u.toArray(o,3),d.toArray(o,0),d.toArray(o,9)):(u.toArray(o,3),u.toArray(o,9),d.toArray(o,0));else{h.subVectors(s,t),c.set(h.y,-h.x),u.addVectors(h,c).add(t),d.subVectors(c,h).add(t);const e=o.length;r?(u.toArray(o,e-3),d.toArray(o,e-6),d.toArray(o,e-12)):(u.toArray(o,e-6),d.toArray(o,e-3),d.toArray(o,e-12))}}}}}class Bt extends e.Mesh{constructor(t,i={},s=null){if(super(),this.model=t,this.material=s,this.outMaterial=!!s,this.XML=new XMLSerializer,this.color=new e.Color,this.opacity=1,this.svgLoader=new Vt,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=i.size||1,this.scaler=1/this.size,!this.model)return;let r={radius:5,min:90,max:90,strokeSize:.25,...i};switch(this.model){case"angle":this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke;let t=Math.abs(r.min);this.add("path",{d:this.circle(0,0,r.radius,180,180+r.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,r.radius,180,180+r.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,r.radius,180-t,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,r.radius,180-t,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let e=.5*r.radius,i=r.max*this.scaler,s=r.min*this.scaler;this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.segment({x:-e,y:0},{x:e,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:i},{x:e,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:s},{x:e,y:s}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:s}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let o=.5*r.radius;this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-o},{x:0,y:o}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-o,y:0},{x:o,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(t={}){let e={};if("angle"===this.model){e={radius:5,min:-90,max:90,...t};let i=Math.abs(e.min);this.change("d",this.circle(0,0,e.radius,180,180+e.max,!0),0),this.change("d",this.circle(0,0,e.radius,180,180+e.max,!1,!1,.3),1),this.change("d",this.circle(0,0,e.radius,180-i,180,!0),2),this.change("d",this.circle(0,0,e.radius,180-i,180,!1,!1,.3,!0),3)}void 0!==t.wireframe&&(this.material.wireframe=t.wireframe),this.fill=void 0===e.fill||e.fill,this.stroke=void 0===e.stroke||e.stroke,this.toMesh()}set(t={},e){for(let i in t)e?e.setAttributeNS(null,i,t[i]):this.svg.setAttributeNS(null,i,t[i])}add(t,e={}){let i=document.createElementNS(this.base,t);this.set(e,i),this.svg.appendChild(i)}change(t,e,i){this.svg.childNodes[i].setAttributeNS(null,t,e)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(t,e,i,s){var r=(s-90)*Math.PI/180;return{x:t+i*Math.cos(r),y:e+i*Math.sin(r)}}circle(t,e,i,s=0,r=360,o=!1,a=!1,n=0,l=!1){0===s&&360===r&&(s=1e-4,a=!0);let h=this.polarToCartesian(t,e,i,r),c=this.polarToCartesian(t,e,i,s),u=r-s<=180?"0":"1",d=["M",h.x,h.y,"A",i,i,0,u,0,c.x,c.y];if(o&&d.push("L",t,e,"L",h.x,h.y),a&&d.push("Z"),0!==n){let o=this.polarToCartesian(t,e,i-n,l?s:r),a=this.polarToCartesian(t,e,i+n,l?s:r);d.push("M",o.x,o.y,"L",a.x,a.y)}return d.join(" ")}segment(t,e){return["M",t.x,t.y,"L",e.x,e.y].join(" ")}geomColor(t,i,s=1){let r=t.attributes.position.count,o=[];for(;r--;)o.push(i.r,i.g,i.b,s);t.setAttribute("color",new e.Float32BufferAttribute(o,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let t=[],i=0,s=1,r=this.svgLoader.parse(this.getString());for(const o of r.paths){const r=o.userData.style.fill;if(this.fill&&void 0!==r&&"none"!==r){this.color.setStyle(r),s=o.userData.style.fillOpacity,s<this.opacity&&(this.opacity=s);const a=Vt.createShapes(o);for(const r of a){const o=new e.ShapeGeometry(r);if(o){this.geomColor(o,this.color,s);let r=(new e.BufferGeometry).copy(o).toNonIndexed();r.translate(0,0,-i*this.layerUp),t.push(r),i++}}}const a=o.userData.style.stroke;if(this.stroke&&void 0!==a&&"none"!==a){this.color.setStyle(a),s=o.userData.style.strokeOpacity,s<this.opacity&&(this.opacity=s);for(const e of o.subPaths){const r=Vt.pointsToStroke(e.getPoints(),o.userData.style,6);r&&(this.geomColor(r,this.color,s),r.translate(0,0,-i*this.layerUp),t.push(r),i++)}}}return t}toMesh(){let t=this.size;this.geometry&&this.geometry.dispose();let i=this.toGeometry();i?(this.geometry=C(i),this.geometry.scale(t,-t,t),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new e.BufferGeometry,null===this.material&&(this.material=new e.MeshBasicMaterial({vertexColors:!0,transparent:1!==this.opacity,side:e.DoubleSide}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class It extends e.Object3D{constructor(t={},i){super(),this.motor=i,this.isJoint=!0,this.type="joint",this.mode=t.mode||"hinge",this.visible=void 0!==t.visible&&t.visible,this.mtx=new e.Matrix4,this.size=t.helperSize||.1,this.matrixAutoUpdate=!1;let s,r,o=this.motor.mat.get("line");switch(this.mode){case"prismatic":s=this.motor.mat.get("svg"),r={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(r.min=t.lm[0],r.max=t.lm[1]),this.m1=new Bt("liner",r,s),this.m2=new Bt("middle",r,s),this.m1.geometry.rotateY(90*w.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":s=this.motor.mat.get("svg"),r={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(r.min=t.lm[0],r.max=t.lm[1]),t.lmr&&(r.min=t.lmr[0],r.max=t.lmr[1]),this.m1=new Bt("angle",r,s),this.m2=new Bt("needle",r,s),this.add(this.m1),this.add(this.m2);break;default:const i=this.motor.geo.get("joint");let a=i.clone();a.scale(this.size,this.size,this.size),this.m1=new e.LineSegments(a,o),this.add(this.m1),a=i.clone(),a.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new e.LineSegments(a,o),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new e.Matrix4,this.mat2=new e.Matrix4,this.end=new e.Vector3;let a=new e.Quaternion;t.quat1&&this.mat1.makeRotationFromQuaternion(a.fromArray(t.quat1)),t.quat2&&this.mat2.makeRotationFromQuaternion(a.fromArray(t.quat2)),this.mat1.setPosition(t.pos1[0],t.pos1[1],t.pos1[2]),this.mat2.setPosition(t.pos2[0],t.pos2[1],t.pos2[2]);const n=new e.BufferGeometry;n.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,0,0],3)),n.setAttribute("color",new e.Float32BufferAttribute([1,0,0,1,0,0],3)),n.computeBoundingSphere(),this.m3=new e.LineSegments(n,o),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()))}updateFromPhy(t,e=0){this.visible&&(this.position.fromArray(t,e),this.quaternion.fromArray(t,e+3),this.updateMatrix(),this.m2.position.fromArray(t,e+7),this.m2.quaternion.fromArray(t,e+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Ft extends it{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new e.Vector3,this.v2=new e.Vector3}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*U.joint,16===U.joint?i.updateFromPhy(t,s):i.update()}add(t={}){let i,s=this.setName(t),r=null,o=null,a=!1;if(t.axis1||(t.axis1=[1,0,0]),t.axis2||(t.axis2=[1,0,0]),t.pos1||(t.pos1=[0,0,0]),t.pos2||(t.pos2=[0,0,0]),t.limit?t.lm=t.limit:t.lm&&(t.limit=t.lm),"universal"!==t.mode&&"dof"!==t.mode&&"d6"!==t.mode||(t.mode="generic"),"revolute"===t.mode&&(t.mode="hinge"),"slider"===t.mode&&(t.mode="cylindrical"),t.b1&&(i="string"==typeof t.b1,r=i?this.Utils.byName(t.b1):t.b1,i||(t.b1=t.b1.name),r&&r.link++),t.b2&&(i="string"==typeof t.b2,o=i?this.Utils.byName(t.b2):t.b2,i||(t.b2=t.b2.name),o&&o.link++),t.worldPos&&(t.worldAnchor=t.worldPos),t.worldAnchor&&(t.pos1=r?this.Utils.toLocal(this.v1.fromArray(t.worldAnchor),r).toArray():t.worldAnchor,t.pos2=o?this.Utils.toLocal(this.v2.fromArray(t.worldAnchor),o).toArray():t.worldAnchor,delete t.worldAnchor),t.worldAxis&&(t.axis1=r?this.Utils.toLocal(this.v1.fromArray(t.worldAxis),r,!0).toArray():t.worldAxis,t.axis2=o?this.Utils.toLocal(this.v2.fromArray(t.worldAxis),o,!0).toArray():t.worldAxis,a=!0,delete t.worldAxis),t.worldQuat&&(t.quat1=this.Utils.quatLocal(t.worldQuat,r),t.quat2=this.Utils.quatLocal(t.worldQuat,o),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(t.axis1=this.Utils.axisLocal(w.quatToAxis(t.worldQuat),r),t.axis2=this.Utils.axisLocal(w.quatToAxis(t.worldQuat),o)),delete t.worldQuat),void 0!==t.rot1&&(t.quat1=w.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=w.quatFromEuler(t.rot2),delete t.rot2),t.quat1||(t.quat1=(new e.Quaternion).setFromUnitVectors(new e.Vector3(1,0,0),(new e.Vector3).fromArray(t.axis1).normalize()).toArray()),t.quat2||(t.quat2=(new e.Quaternion).setFromUnitVectors(new e.Vector3(1,0,0),(new e.Vector3).fromArray(t.axis2).normalize()).toArray()),"AMMO"===this.engine&&a&&"hinge"===t.mode){let i=new e.Euler(0,-90*f,0),s=(new e.Quaternion).setFromEuler(i).toArray();t.quatX=s}t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=w.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot);let n=new It(t,this.motor);return n.name=s,n.body1=r,n.body2=o,void 0===t.visible&&(t.visible=this.motor.jointVisible||!1),this.set(t,n),this.addToWorld(n,t.id),this.motor.post({m:"add",o:t}),n}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&void 0!==t.visible&&(e.visible=t.visible)}}class Dt extends it{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="contact"}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*U.contact,i.update(t,s)}add(t={}){this.setName(t);let e=new Ot(t);return t.callback&&delete t.callback,this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}}class Ot{constructor(t={}){this.type="contact",this.name=t.name,this.callback=t.callback||function(){},this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.always=void 0===t.always||t.always,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}detectBody(){}update(t,e=0){this.data.hit=t[e]>0,this.simple||(this.data.point=[t[e+1],t[e+2],t[e+3]],this.data.normal=[t[e+4],t[e+5],t[e+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}let Nt=null;class Ut extends it{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.motor.geo,Nt=this.motor.mat,this.type="vehicle",this.num=U[this.type]}step(t,e){let i,s,r=this.list.length;for(;r--;)s=this.list[r],i=e+r*this.num,s.step(t,i)}add(t={}){this.setName(t);const e=new qt(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:e.o}),e}set(t={},e=null){null===e&&(e=this.byName(t.name))}}class qt extends e.Object3D{constructor(t,i){super(),this.motor=i,this.Utils=this.motor.utils,this.velocity=new e.Vector3,this.angular=new e.Vector3,t.extra&&(this.extra=t.extra,delete t.extra),this.type="vehicle",this.name=t.name||"car",this.isRay=t.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(t)}drive(){}raycast(){}init(t){this.mass=t.mass||2e3,this.model=null,this.size=t.size||[1.7,1,5],this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.maxSteering=t.maxSteering||24,this.incSteering=t.incSteering||2,this.s_travel=t.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=t.numWheel||4,this.radius=t.radius||.35,this.radiusBack=t.radiusBack||this.radius,this.deep=t.deep||.3,this.deepBack=t.deepBack||this.deep;let e=this.numWheel<4?1:2;if(t.wPos||(t.wPos=[.8,.1,1.4]),t.wPos){this.wPos=t.wPos;var i,s,r,o,a,n,l=t.wPos,h=[],c=1,u=0;l.length,l.length;for(let t=0;t<this.numWheel;t++)c=t%2==0?-1:1,s=Math.floor(.5*t),u=t>=e,0===(r=l[1])&&(r=u?this.radiusBack:this.radius),(o=l[0])instanceof Array&&(o=l[0][s]),a=u?-l[2]:l[2],l[2]instanceof Array&&(a=l[2][s]),i=[o*c,r,a],h.push(i);this.wheelsPosition=h,delete t.wPos}t.wheelsPosition&&(this.wheelsPosition=t.wheelsPosition);const d=t.meshScale||1,p=[];t.chassisShape?p.push({type:"convex",shape:t.chassisShape,size:[d],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):p.push({type:"box",size:this.size,pos:this.chassisPos});for(let i=0;i<this.numWheel;i++)i<e?p.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1}):p.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1});var m=Nt.get(t.debug?"debug":void 0===t.chassisMesh?"body":"hide");let f,g;for(let t=0;t<p.length;t++)f=p[t],f.pos&&(f.localPos=f.pos),f.size=w.autoSize(f.size,f.type),this.motor.getGeometryRef(f,this,m);if(t.chassisMesh&&(g=t.noClone?t.chassisMesh:t.chassisMesh.clone(),g.position.set(0,0,0),this.Utils.noRay(g),g.scale.set(d,d,d),this.children[0].add(g),this.model=g,delete t.chassisMesh),t.wheelMesh){for(let i=1;i<this.numWheel+1;i++)u=i>=e+1,g=t.wheelMeshBack&&u?t.wheelMeshBack.clone():t.wheelMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),2==i||4==i?g.scale.set(-d,d,d):g.scale.set(d,d,d),this.children[i].add(g);delete t.wheelMesh}if(t.suspensionMesh){this.suspensionMesh=[];for(let e=1;e<this.numWheel+1;e++)g=t.suspensionMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),g.position.x=0,2==e||4==e?g.scale.set(d,d,d):g.scale.set(-d,d,d),this.children[0].add(g),this.suspensionMesh.push(g);delete t.suspensionMesh}if(t.brakeMesh){this.brake=[];for(let e=1;e<this.numWheel+1;e++)u=e>2,g=t.brakeMeshBack&&u?t.brakeMeshBack.clone():t.brakeMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),n=t.brakeMeshBack||u?d:-d,2==e||4==e?g.scale.set(-d,d,n):g.scale.set(d,d,n),this.children[0].add(g),this.brake.push(g);delete t.brakeMesh}t.mass=this.mass,t.size=t.chassisShape?p[0].boxSize:this.size,t.numWheel=this.numWheel,t.wheelsPosition=this.wheelsPosition,t.radius=this.radius,t.radiusBack=this.radiusBack,t.deep=this.deep,t.deepBack=this.deepBack,t.chassisShape=p[0],t.maxSteering=this.maxSteering,t.incSteering=this.incSteering,t.s_travel=this.s_travel,t.massCenter=this.massCenter,t.chassisPos=this.chassisPos,this.o=t}set(t){t.name=this.name,this.motor.change(t)}respawn(t){(t=t||{}).respawn=!0,t.name=this.name,t.keepRotation&&(t.quat=this.quaternion.toArray()),this.motor.change(t)}move(){}dispose(){}step(t,e){if(!this.actif){if(0===t[e+0]+t[e+1]+t[e+2]+t[e+3]+t[e+4]+t[e+5]+t[e+6]+t[e+7])return;this.actif=!0}this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.updateMatrix();let i,s=this.numWheel+1,r=0,o=0,a=[],n=0;for(let l=0;l<s;l++)n=8*l+e,0===l&&(t[n],this.circum),1===l&&(r=t[n]),2===l&&(o=t[n]),i=this.children[l],i&&l>0&&(a[l-1]=this.wheelsPosition[l-1][1]-this.decaly-t[n+2],i.position.fromArray(t,n+1),i.quaternion.fromArray(t,n+4),this.rolling[l-1]=i.rotation.x,this.brake&&(this.brake[l-1].position.copy(i.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=t[n])));for(n=4;n--;)this.suspension[n]=w.clamp(a[n]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[n]>0?(this.Utils.morph(this.suspensionMesh[n].children[0],"low",this.suspension[n]),this.Utils.morph(this.suspensionMesh[n].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[n].children[0],"low",0),this.Utils.morph(this.suspensionMesh[n].children[0],"top",-this.suspension[n])));this.steering=Math.round(.5*(r+o)*g)/this.maxSteering}}const jt=new e.Matrix4,Gt=new e.Vector3,Wt=new e.Quaternion,Ht=new e.Vector3,Xt=new e.Matrix4,Qt=new e.Matrix4,Yt=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Jt extends e.Object3D{constructor(t,e,i,s,r=null,o={}){super(),this.motor=t,this.prefix=e||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=i,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=r,this.friction=.5,this.restitution=0,this.option=o,this.useDrive=void 0===o.useDrive||o.useDrive,this.showJoint=void 0!==o.showJoint&&o.showJoint,this.init()}setMass(t){if(t===this.mass)return;this.mass=t;const e=[];let i=this.nodes.length,s=this.mass/i;for(;i--;)e.push({name:this.nodes[i].name,mass:s});this.motor.change(e)}setMode(t){if(t===this.mode)return;this.mode=t;const e=[];let i,s="follow"===this.mode,r=this.nodes.length;for(;r--;)i=this.nodes[r],e.push({name:i.name,kinematic:s}),i.kinematic=s,i.bone.isPhysics=!s;this.motor.change(e)}freeBone(t){t.kinematic&&(t.cc++,20===t.cc&&(t.cc=0,t.kinematic=!1,t.bone.isPhysics=!0,this.motor.change({name:t.name,kinematic:!1})))}isVisible(t){let e=this.nameList.length;for(;e--;)this.motor.byName(this.nameList[e]).visible=t}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const t=[];let i=(new e.Matrix4).makeScale(this.scaler,this.scaler,this.scaler),s=new e.Vector3,r=new e.Vector3,o=new e.Quaternion,a=new e.Euler,n=new e.Matrix4,l=new e.Matrix4,h=new e.Matrix4;Xt.copy(this.model.matrixWorld).invert();let c=new e.Vector3,u=new e.Vector3,d=[1,1,1,1,1,1,1];this.option.sizer&&(d=this.option.sizer);let p,m,g,y,v,b,x,M,S,k,A,T,P,C=this.bones.length,z=0;for(this.mass&&(z=this.mass/C),p=0;p<C;p++)if(S=null,y=this.bones[p],m=y.name,v=y.parent,v){g=v.name,Qt.multiplyMatrices(Xt,y.matrixWorld),c.setFromMatrixPosition(Qt),Qt.multiplyMatrices(Xt,v.matrixWorld),u.setFromMatrixPosition(Qt),x=c.distanceTo(u),A=[0,0,.5*x],b=[x,1,1],M=null,k=!0,P=!1,"hip"===g&&"abdomen"===m&&(S="capsule",b=[x*d[0],.08],A=[0,0,-x*d[0]],M=[0,0,90]),"abdomen"===g&&"chest"===m&&(S="capsule",b=[.7*x*d[1],.08],A=[0,0,.5*-x-.06],M=[90,0,0]),"chest"===g&&"neck"===m&&(S="capsule",b=[.4*x*d[2],.04],A=[0,0,.5*-x-.02],M=[0,0,90]),"neck"===g&&"head"===m&&(S="capsule",b=[.06*d[3],x],A=[0,0,.5*-x],M=[90,0,0]),"head"===g&&"End_head"===m&&(S="capsule",b=[.1*d[4],x-.17],A=[0,.02,.5*-x+.02],M=[90,0,0]),"chest"===g&&"rBreast"===m&&"HAVOK"!==this.motor.engine&&(g="rBreast",v=y,S="sphere",b=[.065],A=[.065,0,0],this.breast=!0,P=!0),"chest"===g&&"lBreast"===m&&"HAVOK"!==this.motor.engine&&(g="lBreast",v=y,S="sphere",b=[.065],A=[.065,0,0],this.breast=!0,P=!0);let e=.04*d[5],p=x-e;if("lCollar"===g&&"lShldr"===m&&(S="capsule",b=[e,.3*x],A=[.6*x,0,0],M=[0,0,90]),"lShldr"===g&&"lForeArm"===m&&(S="capsule",b=[e,p],A=[.5*p,0,0],M=[0,0,90]),"lForeArm"===g&&"lHand"===m&&(S="capsule",b=[e,p],A=[.5*p,0,0],M=[0,0,90]),"lHand"===g&&"lMid1"===m&&(S="box",b=[2*x,.09,.05],A=[x,0,0]),"rCollar"===g&&"rShldr"===m&&(S="capsule",b=[e,.3*x],A=[.6*-x,0,0],M=[0,0,90]),"rShldr"===g&&"rForeArm"===m&&(S="capsule",b=[e,p],A=[.5*-p,0,0],M=[0,0,90]),"rForeArm"===g&&"rHand"===m&&(S="capsule",b=[e,p],A=[.5*-p,0,0],M=[0,0,90]),"rHand"===g&&"rMid1"===m&&(S="box",b=[2*x,.09,.05],A=[-x,0,0]),e=.06*d[6],p=x-e,"lThigh"===g&&(S="capsule",b=[e,x],M=[90,0,0],A=[0,0,.5*p]),"lShin"===g&&(S="capsule",b=[e,x],M=[90,0,0],A=[0,0,.5*p]),"lFoot"===g&&(S="capsule",b=[.05,x],A=[0,.5*x-.025,.04]),"rThigh"===g&&(S="capsule",b=[e,x],M=[90,0,0],A=[0,0,.5*p]),"rShin"===g&&(S="capsule",b=[e,x],M=[90,0,0],A=[0,0,.5*p]),"rFoot"===g&&(S="capsule",b=[.05,x],A=[0,.5*x-.025,.04]),e=.04,p=x-e,"rEar_0"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("rEar_0")),"rEar_1"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("rEar_1")),"rEar_2"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("rEar_2")),"rEar_3"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0]),"lEar_0"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("lEar_0")),"lEar_1"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("lEar_1")),"lEar_2"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0],Yt.push("lEar_2")),"lEar_3"===g&&(S="capsule",b=[e,x],M=[0,0,90],A=[.5*p,0,0]),this.withFinger&&("lHand"===g&&"lMid1"===m&&(S="box",b=[x,.09,.05],A=[.5*x,0,0]),"rHand"===g&&"rMid1"===m&&(S="box",b=[x,.09,.05],A=[.5*-x,0,0]),"rThumb1"===g&&"rThumb2"===m&&(S="capsule",b=[.02,x],M=[0,0,90]),"rThumb2"===g&&"rThumb3"===m&&(S="capsule",b=[.02,x],M=[0,0,90]),"rHand"===g&&"rMid1"===m&&(S="capsule",b=[.02,x],M=[0,0,90],A=[.6*-x,0,0]),"rMid1"===g&&"rMid2"===m&&(S="capsule",b=[.02,x],M=[0,0,90],A=[.6*-x,0,0]),"rMid2"===g&&"rMid3"===m&&(S="capsule",b=[.02,x],M=[0,0,90],A=[.6*-x,0,0])),null!==S){T=this.prefix+"_bone_"+g,l.makeTranslation(A[0],A[1],A[2]),M&&(h.makeRotationFromEuler(a.set(M[0]*f,M[1]*f,M[2]*f)),l.multiply(h)),v.updateWorldMatrix(!0,!1),Qt.multiplyMatrices(Xt,v.matrixWorld),n.copy(Qt),n.decompose(s,o,r),this.posRef[T]=s.toArray(),"lForeArm"!==g&&"rForeArm"!==g||(Wt.setFromAxisAngle({x:0,y:1,z:0},-90*f),o.multiply(Wt)),this.quatRef[T]=o.toArray(),n.multiplyMatrices(Qt,l),n.decompose(s,o,r),this.nameList.push(T);let e={name:T,friction:this.friction,restitution:this.restitution,type:S,size:w.scaleArray(b,this.scaler,3),pos:s.toArray(),quat:o.toArray(),kinematic:k,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==Yt.indexOf(g)&&(e.aggregate=this.prefix+"__Group",e.aggregateMax=21),e.mask=3;else{let t=3;"lForeArm"!==g&&"rForeArm"!==g&&"lShin"!==g&&"rShin"!==g||(t=35),"rEar_1"!==g&&"rEar_2"!==g&&"rEar_3"!==g&&"lEar_1"!==g&&"lEar_2"!==g&&"lEar_3"!==g||(t=35),"rEar_0"!==g&&"rEar_0"!==g||(t=0),e.group=32,e.mask=t}null!==this.mass?e.mass=z:e.density=1,t.push(e);let c=l.clone().invert().premultiply(i);this.nodes.push({name:T,kinematic:k,motion:P,bone:v,decal:l.clone(),decalinv:c,quat:o.toArray(),pos:s.toArray(),cc:0})}}this.motor.add(t),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(t){return-1!==this.nameList.indexOf(t)}addLink(){let t=[.05,1,0];"PHYSX"===this.motor.engine&&(t=[50,10,0,.5]);let e=2,i=.1,s=1e7,r=!1,o=this.prefix+"_bone_",a=[],n={type:"joint",mode:"d6",lm:[["ry",-180,180,...t],["rz",-180,180,...t]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(n.drives=[["rx",e,i,s,r],["ry",e,i,s,r],["rz",e,i,s,r]]);let l=[-.001,.001,100,.2,.5];a.push({...n,b1:o+"hip",b2:o+"abdomen",worldPos:this.posRef[o+"abdomen"],worldQuat:this.quatRef[o+"hip"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),a.push({...n,b1:o+"abdomen",b2:o+"chest",worldPos:this.posRef[o+"chest"],worldQuat:this.quatRef[o+"chest"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),a.push({...n,b1:o+"chest",b2:o+"neck",worldPos:this.posRef[o+"neck"],worldQuat:this.quatRef[o+"neck"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),a.push({...n,b1:o+"neck",b2:o+"head",worldPos:this.posRef[o+"head"],worldQuat:this.quatRef[o+"head"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),a.push({...n,b1:o+"chest",b2:o+"rCollar",worldPos:this.posRef[o+"rCollar"],worldQuat:this.quatRef[o+"rCollar"],mode:"fixe"}),a.push({...n,b1:o+"chest",b2:o+"lCollar",worldPos:this.posRef[o+"lCollar"],worldQuat:this.quatRef[o+"lCollar"],mode:"fixe"}),a.push({...n,b1:o+"rCollar",b2:o+"rShldr",worldPos:this.posRef[o+"rShldr"],worldQuat:this.quatRef[o+"rShldr"]}),a.push({...n,b1:o+"lCollar",b2:o+"lShldr",worldPos:this.posRef[o+"lShldr"],worldQuat:this.quatRef[o+"lShldr"]}),this.existe(o+"rForeArm")&&a.push({...n,b1:o+"rShldr",b2:o+"rForeArm",worldPos:this.posRef[o+"rForeArm"],worldQuat:this.quatRef[o+"rForeArm"],lm:[["rx",0,160,...t]]}),this.existe(o+"lForeArm")&&a.push({...n,b1:o+"lShldr",b2:o+"lForeArm",worldPos:this.posRef[o+"lForeArm"],worldQuat:this.quatRef[o+"lForeArm"],lm:[["rx",0,160,...t]]}),this.existe(o+"rHand")&&a.push({...n,b1:o+"rForeArm",b2:o+"rHand",worldPos:this.posRef[o+"rHand"],worldQuat:this.quatRef[o+"rHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),this.existe(o+"lHand")&&a.push({...n,b1:o+"lForeArm",b2:o+"lHand",worldPos:this.posRef[o+"lHand"],worldQuat:this.quatRef[o+"lHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),a.push({...n,b1:o+"hip",b2:o+"rThigh",worldPos:this.posRef[o+"rThigh"],worldQuat:this.quatRef[o+"rThigh"]}),a.push({...n,b1:o+"hip",b2:o+"lThigh",worldPos:this.posRef[o+"lThigh"],worldQuat:this.quatRef[o+"lThigh"]}),this.existe(o+"rShin")&&a.push({...n,b1:o+"rThigh",b2:o+"rShin",worldPos:this.posRef[o+"rShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[o+"rShin"]}),this.existe(o+"lShin")&&a.push({...n,b1:o+"lThigh",b2:o+"lShin",worldPos:this.posRef[o+"lShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[o+"lShin"]}),this.existe(o+"rFoot")&&a.push({...n,b1:o+"rShin",b2:o+"rFoot",worldPos:this.posRef[o+"rFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[o+"rFoot"]}),this.existe(o+"lFoot")&&a.push({...n,b1:o+"lShin",b2:o+"lFoot",worldPos:this.posRef[o+"lFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[o+"lFoot"]}),this.breast&&(this.existe(o+"rBreast")&&a.push({...n,b1:o+"chest",b2:o+"rBreast",worldPos:this.posRef[o+"rBreast"],worldQuat:this.quatRef[o+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(o+"lBreast")&&a.push({...n,b1:o+"chest",b2:o+"lBreast",worldPos:this.posRef[o+"lBreast"],worldQuat:this.quatRef[o+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(o+"lEar_0")&&a.push({...n,b1:o+"head",b2:o+"lEar_0",worldPos:this.posRef[o+"lEar_0"],worldQuat:this.quatRef[o+"lEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"lEar_1")&&a.push({...n,b1:o+"lEar_0",b2:o+"lEar_1",worldPos:this.posRef[o+"lEar_1"],worldQuat:this.quatRef[o+"lEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"lEar_2")&&a.push({...n,b1:o+"lEar_1",b2:o+"lEar_2",worldPos:this.posRef[o+"lEar_2"],worldQuat:this.quatRef[o+"lEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"lEar_3")&&a.push({...n,b1:o+"lEar_2",b2:o+"lEar_3",worldPos:this.posRef[o+"lEar_3"],worldQuat:this.quatRef[o+"lEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"rEar_0")&&a.push({...n,b1:o+"head",b2:o+"rEar_0",worldPos:this.posRef[o+"rEar_0"],worldQuat:this.quatRef[o+"rEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"rEar_1")&&a.push({...n,b1:o+"rEar_0",b2:o+"rEar_1",worldPos:this.posRef[o+"rEar_1"],worldQuat:this.quatRef[o+"rEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"rEar_2")&&a.push({...n,b1:o+"rEar_1",b2:o+"rEar_2",worldPos:this.posRef[o+"rEar_2"],worldQuat:this.quatRef[o+"rEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(o+"rEar_3")&&a.push({...n,b1:o+"rEar_2",b2:o+"rEar_3",worldPos:this.posRef[o+"rEar_3"],worldQuat:this.quatRef[o+"rEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]});let h=0;for(let t in a)a[t].name=this.prefix+"_joint_"+h,this.jointList.push(a[t].name),h++;this.motor.add(a)}updateMatrixWorld(t){if(!this.ready)return;let e=[];const i=this.nodes;let s,r,o,a=i.length,n=0;for(;a--;)s=i[n],r=s.bone,n++,s.kinematic?(jt.multiplyMatrices(r.matrixWorld,s.decal),jt.decompose(Gt,Wt,Ht),s.pos=Gt.toArray(),s.quat=Wt.toArray(),e.push({name:s.name,pos:s.pos,quat:s.quat}),s.motion&&this.freeBone(s)):(o=this.motor.byName(s.name),o&&(jt.copy(o.matrixWorld).multiply(s.decalinv),r.phyMtx.copy(jt),r.isPhysics=!0));0!==e.length&&this.motor.change(e,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}function Zt(t){const e=new Map,i=new Map,s=t.clone();return Kt(t,s,(function(t,s){e.set(s,t),i.set(t,s)})),s.traverse((function(t){if(!t.isSkinnedMesh)return;const s=t,r=e.get(t),o=r.skeleton.bones;s.skeleton=r.skeleton.clone(),s.bindMatrix.copy(r.bindMatrix),s.skeleton.bones=o.map((function(t){return i.get(t)})),s.bind(s.skeleton,s.bindMatrix)})),s}function Kt(t,e,i){i(t,e);for(let s=0;s<t.children.length;s++)Kt(t.children[s],e.children[s],i)}class $t{constructor(t,i){this.target=i||t,this.baseGeometry=t.geometry,this.geometry=this.target.geometry,this.V=[new e.Vector3,new e.Vector3,new e.Vector3],this.X=[new e.Vector4,new e.Vector4,new e.Matrix4],this.M=[new e.Vector3,new e.Vector3,new e.Vector3],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const t=this.geometry;let i=t.attributes.position.array.length;t.setAttribute("color",new e.Float32BufferAttribute(new Array(i).fill(0),3))}resetEdge(t){let e=t.length;for(;e--;)t[e]=0}getEdge(t,e,i=!1,s=!1){let r=t.attributes.position.array;const o=t.index.array;let a,n,l,h,c,u,d,p=this.V[0],m=this.V[1],f=this.V[2],g=0;for(s&&(r=this.getMorph()),i&&(r=this.getSkinned(r)),(i||s)&&this.resetEdge(e),a=this.indexLength;a--;)n=o[g],l=o[g+1],h=o[g+2],p.fromArray(r,3*n),m.fromArray(r,3*l),f.fromArray(r,3*h),c=p.distanceTo(m),u=p.distanceTo(f),d=m.distanceTo(f),e[n]+=.5*(c+u),e[l]+=.5*(c+d),e[h]+=.5*(u+d),g+=3}isZero(t){return 0===t.x&&0===t.y&&0===t.z}getMorph(){const t=this.target.morphTargetInfluences,e=this.geometry.morphAttributes.position,i=t.length,s=this.geometry.attributes.position.array;let r,o,a,n,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],u=this.M[2],d=this.geometry.morphTargetsRelative;for(o=l;o--;){for(r=3*o,c.fromArray(s,r),h.set(0,0,0),a=i;a--;)0!=t[a]&&(n=e[a].data?e[a].data.array:e[a].array,d?h.addScaledVector(u.fromArray(n,r),t[a]):h.addScaledVector(u.fromArray(n,r).sub(c),t[a]));c.add(h),c.toArray(this.back,r)}return this.back}getSkinned(t){const e=this.target.skeleton;e.boneMatrices;const i=this.geometry,s=i.attributes.skinIndex.array,r=i.attributes.skinWeight.array,o=this.target.bindMatrix,a=this.target.bindMatrixInverse;let n,l,h,c,u,d=this.V[0],p=this.V[1],m=this.V[2],f=this.X[0],g=this.X[1],y=this.X[2];for(n=i.attributes.position.count;n--;){for(u=3*n,f.fromArray(s,4*n),g.fromArray(r,4*n),d.fromArray(t,u).applyMatrix4(o),p.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=f.getComponent(l),y.multiplyMatrices(e.bones[h].matrixWorld,e.boneInverses[h]),p.addScaledVector(m.copy(d).applyMatrix4(y),c));p.applyMatrix4(a),p.toArray(this.back,u)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const t=this.geometry.attributes.color.array;let e,i,s,r=this.length;for(;r--;)e=this.originEdges[r],i=(e-this.targetEdges[r])/e+.5,s=3*r,t[s]=i>.5?2*(i-.5):0,t[s+1]=0,t[s+2]=i<.5?1-2*i:0;this.geometry.attributes.color.needsUpdate=!0}}class te extends e.Object3D{constructor(t,i){super(),this.isReady=!1,this.skeleton=i,this.bones=this.skeleton.bones,this.root=t,this.box=new e.BoxGeometry,this.mtxr=new e.Matrix4,this.mtx0=new e.Matrix4,this.mtx1=new e.Matrix4,this.mtx=new e.Matrix4,this.mtx2=new e.Matrix4,this.p=new e.Vector3,this.s=new e.Vector3,this.q=new e.Quaternion,this.e=new e.Euler,this.mat=new e.MeshBasicMaterial({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){if(!this.isReady)return;let e,i,s=this.children,r=s.length;for(this.mtxr.copy(this.root.matrixWorld).invert();r--;)e=s[r],i=e.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,i.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,e.userData.decal),this.mtx.decompose(this.p,this.q,this.s),e.position.copy(this.p),e.quaternion.copy(this.q),e.updateMatrix();super.updateMatrixWorld(t)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const t=this.bones;let i,s,r,o,a,n,l,h,c,u,d,p=new e.Vector3,m=new e.Vector3,f=t.length;for(i=0;i<f;i++)h=null,o=t[i],s=o.name,a=o.parent,a&&(r=a.name,p.setFromMatrixPosition(a.matrixWorld),m.setFromMatrixPosition(o.matrixWorld),l=p.distanceTo(m),c=[0,0,.5*l],n=[l,1,1],u=[0,0,0],d="_C","head"===r&&"End_head"===s&&(h="box",n=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===r&&"neck"===s&&(h="box",n=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===r&&(h="box",n=[.28,.24,l+.14],u[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===r&&(h="box",n=[.15,.15,l]),"lThigh"===r&&(h="box",n=[.15,.15,l]),"rShin"===r&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"lShin"===r&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"rShldr"===r&&(h="box",n=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===r&&(h="box",n=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===r&&(h="box",n=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===r&&(h="box",n=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(a,h,n,c,u,"_C"));this.isReady=!0}addMesh(t,i,s,r,o,a){this.mtx.makeTranslation(r[0],r[1],r[2]);var n=new e.Mesh(this.box,this.mat);n.scale.fromArray(s),n.userData.decal=this.mtx.clone(),n.userData.bone=t,n.userData.size=s,this.add(n)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const ee={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:1,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},ie={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:ee,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",roughness:.54,metalness:.14,normalScale:new e.Vector2(ee.normal,-ee.normal),wireframe:ee.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new e.Color(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new e.Vector2(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new e.Vector2(2,-2),clearcoat:.25},hair:{type:"Standard",color:ee.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:e.DoubleSide,emissive:ee.hair,emissiveIntensity:.5,transparent:!0,blending:e.CustomBlending,blendDst:e.ZeroFactor,blendDstAlpha:e.SrcAlphaFactor,alphaToCoverage:!0},hair_man:{type:"Standard",color:ee.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:e.DoubleSide,transparent:!0,blending:e.CustomBlending,blendDst:e.ZeroFactor,blendDstAlpha:e.SrcAlphaFactor,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:ee.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:e.DoubleSide,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(t={},e=!1)=>{if(!_.getMaterial(ie.materialRef))return;const i=ie.setting,s=ie.materials;let r,o=!1;for(let e in t)void 0!==i[e]&&i[e]!==t[e]&&(i[e]=t[e],o=!0);if(o)for(let i in s){r=_.getMaterial(i);for(let o in t)void 0!==r[o]&&(e&&s[i][o]?r[o]=s[i][o]:r[o]=t[o])}},applyMaterial:(t,e)=>{const i=!0,s=_.getMaterial("skin");//!Human.haveLOD;
t.traverse((t=>{if(t.isMesh)switch(t.name){case"body":case"Head":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=i;break;case"body_low":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=!1;break;case"crane":t.material=s,t.receiveShadow=!0,t.castShadow=!1,t.visible=!ie.haveHair;break;case"mouth":t.material=_.getMaterial("mouth")||s,t.receiveShadow=!0,t.castShadow=!1,t.visible=i,t.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":t.material=_.getMaterial("eyelash")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"tear":t.material=_.getMaterial("tear")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"eye_l":case"eye_r":t.material=_.getMaterial("eye")||s,t.receiveShadow=!1,t.castShadow=!1;break;case"eye_l_s":case"eye_r_s":t.material=_.getMaterial("sub_eye")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"hair":t.material=_.getMaterial("hair")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!ie.haveHair&&i;break;case"hair_man":t.material=_.getMaterial("hair_man")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!ie.haveHair&&i}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},se={wireframe:!1,normal:.25,hair:2433041},re={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:se,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new e.Vector2(se.normal,-se.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:se.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:se.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(t={},e=!1)=>{if(!_.getMaterial(re.materialRef))return;const i=Lee.materials;let s;for(let r in i){s=_.getMaterial(r);for(let o in t)void 0!==s[o]&&(e&&i[r][o]?s[o]=i[r][o]:s[o]=t[o])}},applyMaterial:(t,e)=>{const i=_.getMaterial(re.materialRef);t.traverse((t=>{if(t.isMesh)switch(t.name){case"body_low":t.material=i,t.receiveShadow=!0,t.castShadow=!0;break;case"hair_low":t.material=_.getMaterial("hair_low")||i,t.receiveShadow=!1,t.castShadow=!1;break;case"hair_low_2":t.material=_.getMaterial("hair_low_2")||i,t.receiveShadow=!1,t.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},oe={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},ae={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:oe,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"}},changeMaterial:(t,e=!1)=>{if(!_.getMaterial(ae.materialRef))return;const i=ae.materials;let s;for(let r in i){s=_.getMaterial(r);for(let o in t)void 0!==s[o]&&(e&&i[r][o]?s[o]=i[r][o]:s[o]=t[o]);s.needsUpdate=!0}},applyMaterial:(t,e)=>{const i=_.getMaterial(e);t.traverse((t=>{if(t.isMesh)switch(t.material=i,t.receiveShadow=!0,t.castShadow=!0,t.name){case"eva_2_head":case"eva_2_mach":t.visible="eva02"===e;break;case"eva_L_COLLAR":case"eva_R_COLLAR":t.visible="eva00"!==e;break;case"eva_HEAD":case"eva_MACHOIR":t.visible="eva01"===e;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":t.visible="eva00"===e;break;case"eva_0_CHEST2":t.visible="eva01"!==e}}))}},ne={metalness:.2,roughness:.8,wireframe:!1},le={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:ne,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:ne.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{if(!_.getMaterial(le.materialRef))return;const i=le.materials;let s;for(let r in i){s=_.getMaterial(r);for(let o in t)void 0!==s[o]&&(e&&i[r][o]?s[o]=i[r][o]:s[o]=t[o])}},applyMaterial:(t,e)=>{const i=_.getMaterial("lee_material");t.traverse((t=>{t.isMesh&&(t.material=i,t.receiveShadow=!0,t.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},he={metalness:.2,roughness:.8,wireframe:!1},ce={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:he,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:he.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{},applyMaterial:(t,e)=>{},adjustment:()=>[]},ue=1/30,de=Math.PI/180,pe=180/Math.PI,me=new e.Vector3,fe={tmp:[],model:[],avatar:null,callback:()=>{},add:(t,e)=>{fe.tmp=[...t],fe.callback=e,fe.tmp.length&&fe.loadOne()},loadOne:()=>{let t=fe.tmp[0];fe.avatar=new ge({type:t,callback:fe.next,morph:!0,isPreload:!0})},next:t=>{fe.avatar.dispose(),fe.tmp.shift(),0===fe.tmp.length?fe.callback():fe.loadOne()}};class ge extends e.Group{constructor(t={}){switch(super(),this.isPreload=t.isPreload||!1,this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.rootPath=t.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",this.callback=t.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=t.randomMorph||!1,this.randomSize=t.randomSize||!1,this.actionPose=null,this.model=t.type||"man",this.startAnimation=t.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=ce;break;case"lee":this.ref=le;break;case"man":case"woman":this.ref=ie;break;case"man_low":case"woman_low":this.ref=re;break;case"eva00":case"eva01":case"eva02":this.ref=ae}this.compact=void 0===t.compact||t.compact,this.haveMorph=void 0!==t.morph&&t.morph,this.fullMaterial=void 0===t.material||t.material,this.size=t.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,t.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new e.Quaternion).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new e.Vector3,this.eyeTarget=new e.Group,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new e.Matrix4,this.tmpQ=new e.Quaternion,this.setting={},this.root=_.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=Zt(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(t=0,e=1){return t+Math.random()*(e-t)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=_.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const t=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");_.load(this.ref.textures,this.loadModels.bind(this),t,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const t=this.ref.forceModel?this.ref.forceModel:this.model,e=[t+".glb"],i=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&e.push(t+"_morph.glb"),_.load(e,this.init.bind(this),i,"loading models...")}update(t){this.done&&this.mixer&&(this.mixer.update(t),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*t),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const t=this.n++;let e=0;t<=10&&(e=.1*t),t>10&&t<=20&&(e=1-.1*(t-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",e)}look(t){if(!this.isEyeMove)return;if(this.isPause)return;const e=window.mouse||{x:0,y:0};t>1&&(t=1),this.headBoneLook.lerp({x:-20*e.y*de,y:0,z:-20*e.x*de},t),this.eyeTarget.position.lerp({x:.5*e.x,y:1,z:.25*-e.y},t);let i=this.headBoneLook;this.tmpQ.setFromEuler({_x:i.x,_y:i.y,_z:i.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let s=this.bones.ER,r=this.bones.EL,o={x:0,y:0,z:1};this.tmpMtx.lookAt(r.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),o),r.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(s.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),o),s.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let t=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,t),this.lerp(1,1.04,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,t),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,t),this.lerp(1.04,1,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,t),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(t,e,i){this.position.set(t,e,i),this.updateMatrix()}setRotation(t,e,i,s){let r=this.lerp(this.rotation.y,e,s);this.rotation.set(t,r,i),this.updateMatrix()}lerp(t,e,i){return(1-i)*t+i*e}onReady(){}initMaterial(){if(_.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void _.set(this.ref.materialRef,new e.MeshStandardMaterial);let t,i,s;for(const r in this.ref.materials){s={...this.ref.materials[r]},i=s.type,delete s.type;for(const t in s)"envMapIntensity"!==t&&"normalMapType"!==t&&"aoMapIntensity"!==t&&"aoMapIntensity"!==t&&("map"!==t&&-1===t.search("Map")||(s[t]=_.getTexture(s[t],{quality:this.textureQuality})));"Basic"===i?t=new e.MeshBasicMaterial(s):"Standard"===i?t=new e.MeshStandardMaterial(s):"Physical"===i?t=new e.MeshPhysicalMaterial(s):"Sss"===i&&(t=new H(s)),t.name=r,_.set(r,t)}this.setting=this.ref.setting}setMaterial(t,e){let i=_.getMaterial(this.ref.materialRef);if(i)for(let e in t)void 0!==i[e]&&(i[e]=t[e])}setMaterialNormal(t){let e=_.getMaterial("skin");e&&(t<0&&(t=0),e.normalScale.set(t,-t))}getMaterial(t){return _.getMaterial(t)}init(){if(this.initMaterial(),!this.isClone){let t=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&_.getMesh(t,!0),this.root=_.get(t,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(t){t.raycast=function(){},t.isMesh&&(t.name===this.ref.skeletonRef&&(t.matrixAutoUpdate=!1,this.skeleton=t.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=t.geometry.boundingBox.max.y),"Head"===t.name&&(this.realSize=t.geometry.boundingBox.max.y),this.mesh[t.name]=t),t.isBone&&(this.bones[t.name]=t)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let t in this.mesh)this.mesh[t].isSkinnedMesh&&t!==this.ref.skeletonRef&&(this.mesh[t].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&_.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),_.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new e.AnimationMixer(this),0===_.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let t=_.clip.length;for(;t--;)this.addAction(_.clip[t]);this.start()}}setRealSize(t){this.realSize=t;let e=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(e)}setSize(t){this.size=t,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(t){this.bones.head.scale.set(1,1,1).multiplyScalar(t)}addTensionMap(){this.tension1=new $t(this.mesh.body),this.tension2=new $t(this.mesh.Head)}setBounding(t){for(let e in this.mesh)this.mesh[e].isMesh&&(this.mesh[e].geometry.boundingSphere.radius=t)}setLevel(t){this.haveLOD&&this.lod!==t&&(this.lod=t,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let t in this.mesh)this.mesh[t].visible=!1}setVisible(t,e){"string"==typeof t&&(t=[t]);let i,s=t.length;for(;s--;)i=t[s],this.mesh[i]&&(this.mesh[i].visible=e)}setMorph(t,e){e=e<0?0:e,this.haveMorph&&(this.morpher("eyelash",t,e),this.morpher("eyebrow",t,e),this.morpher("tear",t,e),this.morpher("mouth",t,e),this.morpher("body",t,e),this.morpher("Head",t,e),this.morpher("body_low",t,e))}morpher(t,e,i){this.mesh[t]&&this.mesh[t].morphTargetInfluences&&void 0!==this.mesh[t].morphTargetDictionary[e]&&(this.mesh[t].morphTargetInfluences[this.mesh[t].morphTargetDictionary[e]]=i)}lerp(t,e,i){return(1-i)*t+i*e}clone(t){return new this.constructor({type:t.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(t){if(!this.haveMorph)return;t&&(this.bodyMorph=t);let e=Number(this.bodyMorph[0]),i=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",i<0?-i:0),this.setMorph("LOW",i>=0?i:0),this.setMorph("BIG",e<0?-e:0),this.setMorph("MONSTER",e>=0?e:0);let s=.5*(e+1),r=1-.5*(i+1);this.setMaterialNormal(.5*(r+s))}setFaceMorph(t){if(!this.haveMorph)return;t&&(this.faceMorph=t);let e=Number(this.faceMorph[0]),i=Number(this.faceMorph[1]);this.setMorph("Shock",i<0?-i:0),this.setMorph("Frown",i>=0?i:0),this.setMorph("SmileOpen",e<0?-e:0),this.setMorph("Angry",e>=0?e:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new e.SkeletonHelper(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new te(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(t,e){t.matrix=e.matrixWorld,t.matrixAutoUpdate=!1}loadAnimationJson(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){let t=JSON.parse(i.responseText);this.urls=[];for(let e in t)"main"===e?this.urls.push(...t[e]):this.urls.push(...t[e].map((t=>e+"/"+t)));this.endCallback=e||function(){},this.loadOne()}}.bind(this),i.send()}loadOne(){let t=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+t+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(t="./assets/models/animations.bin"){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer";const s={animations:[]},r=this;i.onload=function(){P.decompress(i.response,(t=>{const i=JSON.parse(t);for(let t in i)s.animations.push(e.AnimationClip.parse(i[t]));r.applydAnimation(s),r.start()}))},i.send()}loadAnimationGlb(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));_.loaderGLTF().load(t,function(t){this.applydAnimation(t,i),e&&e()}.bind(this),null,e)}directGlb(t,e){_.loaderGLTF().parse(t,"",function(t){this.stop(),this.applydAnimation(t,e)}.bind(this))}loadAnimationFbx(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));_.loaderFBX().load(t,function(t){this.convertFbx(i,t.animations[0]),e&&e()}.bind(this),null,e)}directFbx(t,e){try{let i=_.loaderFBX().parse(t,"");this.convertFbx(e,i.animations[0],!0)}catch(t){console.error("bug",t)}}applydAnimation(t,e){let i=t.animations.length,s=!1;for(1===i&&(e&&(t.animations[0].name=e),s=!0);i--;)this.addClip(t.animations[i]),this.addAction(t.animations[i],s)}addClip(t,i=!1){i&&e.AnimationUtils.makeClipAdditive(t);let s=_.clip.length,r=-1;for(;s--;)_.clip[s].name===t.name&&(r=s);-1!==r&&_.clip.slice(r,1),_.clip.push(t)}addAction(t,e){const i=this.mixer.clipAction(t);i.frameMax=Math.round(30*t.duration),i.play(),i.enabled=!0,-1!==t.name.search("idle")&&(i.enabled=!0),"Jumping Up"===t.name&&(i.loop=LoopPingPong),this.actions.set(t.name,i),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(t=!1,e=!1){let i=[],s=0;if(e){let e=_.clip.length;for(;e--;)i[s]=t?_.clip[s].toJSON():_.clip[s],s++}else this.actions.forEach((function(e,r){i[s]=t?e._clip.toJSON():e._clip,s++}));return i}exportAnimationLzma(t){this.lzma||(this.lzma=new P(this.lzmaPath));const e=this.getAnimation(!0);this.lzma.compress(JSON.stringify(e),2,(function(e){if(t)t({name:"animations",data:new Uint8Array(e),type:"bin"});else{let t=document.createElement("a");t.style.display="none",document.body.appendChild(t),t.href=URL.createObjectURL(new Blob([new Uint8Array(e)],{type:"application/octet-stream"})),t.download="animations.bin",t.click()}}))}armAngle(){}autoToes(){if(!this.fixToe)return;let t=this.getRot("rFoot"),e=this.getRot("lFoot"),i=this.getWorldPos("hip"),s=this.getWorldPos("rToes"),r=this.getWorldPos("lToes");t[0]>0&&s.z-i.z<0?this.setRot("rToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("rToes",0,0,0),e[0]>0&&r.z-i.z<0?this.setRot("lToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(t,i,s){const r=Math.PI/180;let o=new e.Vector3,a=new e.Quaternion,n=(new e.Quaternion).setFromAxisAngle({x:1,y:0,z:0},90*r);const l=i.tracks,h=[];let c,u,d,p,m=l.length,f=0;for(;m--;){if(d=l[f],p=d.name.substring(0,d.name.lastIndexOf(".")),"hip.position"===d.name){let t=[];for(c=d.values.length/3;c--;)u=3*c,o.set(d.values[u],d.values[u+1],0).multiplyScalar(.01),o.toArray(t,u);h.push(new e.VectorKeyframeTrack(d.name,d.times,t))}else{let t=[];for(c=d.values.length/4;c--;)u=4*c,"hip"===p?a.set(d.values[u],d.values[u+1],d.values[u+2],d.values[u+3]).multiply(n):a.set(d.values[u],d.values[u+2],-d.values[u+1],d.values[u+3]),a.toArray(t,u);h.push(new e.QuaternionKeyframeTrack(d.name,d.times,t))}f++}let g=new e.AnimationClip(t,-1,h);g.duration=i.duration,this.stop(),this.addClip(g),this.addAction(g,s)}makePoseTrack(t,i,s=!1){const r=Math.PI/180;let o=new e.Quaternion;const a=i,n=[];let l,h,c,u,d=a.length,p=0;for(;d--;){u=a[d],u.name;let t=[],i=[];for(p=0,l=3;l--;)h=0,c=4*p,i.push(.03333333507180214*p),o.setFromEuler({_x:u.values[0]*r,_y:u.values[1]*r,_z:u.values[2]*r,_order:"XYZ"}),o.toArray(t,c),p++;n.push(new e.QuaternionKeyframeTrack(u.name+".quaternion",i,t))}let m=s?e.AdditiveAnimationBlendMode:e.NormalAnimationBlendMode,f=new e.AnimationClip(t,-1,n,m);f.duration=.10000000521540642;const g=this.mixer.clipAction(f);g.enabled=!0,g.setEffectiveTimeScale(1),g.setEffectiveWeight(1),g.play(),this.actionPose=g}prepareCrossFade(t,e,i){this.isPause=!1,this.unPause(),"idle"!==e._clip.name?this.executeCrossFade(t,e,i):this.synchronizeCrossFade(t,e,i)}synchronizeCrossFade(t,e,i){this.mixer.addEventListener("loop",(function r(o){o.action===t&&(s.mixer.removeEventListener("loop",r),s.executeCrossFade(t,e,i))}));const s=this}executeCrossFade(t,e,i,s=!0){this.setWeight(e,1),e.time=0,t.crossFadeTo(e,i,!0)}pause(){this.actions.forEach((function(t){t.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(t){t.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(t){t.play()}))}setTimescale(t){this.actions.forEach((function(e){e.setEffectiveTimeScale(t)}))}syncro(t){let e=this.getAction(t);if(!e)return;let i=e.time;this.actions.forEach((function(t){t.time=i}))}setWeight(t,e){t.enabled=!0,e<0&&(e=0),e>1&&(e=1),t.setEffectiveWeight(e)}getAnimInfo(t){let e=this.getAction(t);if(e)return{name:t,time:e.time,frame:Math.round(30*e.time),frameMax:e.frameMax,timeScale:e.timeScale}}getAction(t){return this.actions.get(t)}play(t,e=.5){let i=this.getAction(t);if(!i)return!1;if(this.current){if(this.current!==i){this.old=this.current,this.current=i;let s="idle"===this.current.getClip().name;s="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(t)?this.fixToe=!0:this.resetToes();let r=this.old.getEffectiveWeight(),o=this.current.getEffectiveWeight(),a=this.current.time;if(!s){let t=this.current.getClip().duration/this.old.getClip().duration;a=this.old.time*t}this.current.reset(),this.current.time=a,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(e,r,0),this.current._scheduleFading(e,o,1)):this.executeCrossFade(this.old,this.current,e)}}else this.stop(),this.current=i,i.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(t,e,i=1){let s=this.getAction(t);s&&(s.time=e*ue,s.setEffectiveWeight(i),s.play(),s.paused=!0,this.isPause=!0)}playOne(t,e=1){this.current&&(this.current.time=t*ue,this.current.setEffectiveWeight(e),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(t){t.setEffectiveWeight(0)}))}setRot(t,e,i,s){let r=this.bones[t];r&&(r.rotation.set(e*de,i*de,s*de,"XYZ"),r.updateMatrix())}setRot2(t,i,s,r){let o=this.bones[t];if(!o)return;let a=(new e.Quaternion).setFromEuler({_x:i*pe,_y:s*pe,_z:r*pe,_order:"XYZ"}).invert();o.quaternion.premultiply(a),o.updateMatrix()}getRot(t){let e=this.bones[t];if(!e)return;let i=e.rotation.toArray();return[Math.round(i[0]*pe),Math.round(i[1]*pe),Math.round(i[2]*pe)]}getWorldPos(t){let e=this.bones[t];if(e)return me.set(0,0,0),e.localToWorld(me),{x:me.x,y:me.y,z:me.z}}bodyMask(t={arm:!0,leg:!0,foot:!0,chest:!0}){let i=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const s=this.canvas.getContext("2d");s.fillStyle="#FFFFFF",s.fillRect(0,0,256,256),s.fillStyle="black",t.arm&&s.fillRect(196,112,59,46.5),t.leg&&s.fillRect(128,183.5,71.75,72.5),t.foot&&s.fillRect(817*i,205.5,51.5,50),t.chest&&(s.fillRect(120,144,75,40),s.fillRect(553*i,116.5,57,27.5),s.fillRect(533*i,531*i,5,45*i));let r=new Image;r.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new e.Texture(r),this.mask.flipY=!1,this.mask.needsUpdate=!0;const o=_.getMaterial("skin");o.alphaTest=.9,o.alphaMap=this.mask}zeroColor(t){t.isMesh&&(t=t.geometry);let i=t.attributes.position.array.length;t.setAttribute("color",new e.Float32BufferAttribute(new Array(i).fill(0),3))}}class ye extends e.Object3D{constructor(t={},i){super(),this.motor=i,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=t.useImpulse||!1,this.useFloating=t.floating||!1,this.waitRotation=!1;let s=.3,r=t.radius||.3,o=t.height||1.8;this.realHeight=o,this.useFloating&&(o-=s),this.option={debug:!1,capsuleHalfHeight:.5*o,capsuleRadius:r,floatHeight:s,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-o,z:0},rayHitForgiveness:.1,rayLength:r+2,rayDir:{x:0,y:-1,z:0},floatingDis:r+s+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:r-.03,slopeRayLength:r+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new e.Vector3,movingObjectVelocity:new e.Vector3,standingForcePoint:new e.Vector3,pivotPosition:new e.Vector3,modelQuat:new e.Quaternion,moveImpulse:new e.Vector3,impulseCenter:new e.Vector3,movingDirection:new e.Vector3,moveAccNeeded:new e.Vector3,jumpVelocityVec:new e.Vector3,jumpDirection:new e.Vector3,currentVel:new e.Vector3,currentPos:new e.Vector3,dragForce:new e.Vector3,dragAngForce:new e.Vector3,wantToMoveVel:new e.Vector3,rejectVel:new e.Vector3,floatingForce:null,springDirVec:new e.Vector3,rayOrigin:new e.Vector3,characterMassForce:new e.Vector3,slopeAngle:null,actualSlopeNormal:new e.Vector3,actualSlopeAngle:null,actualSlopeNormalVec:new e.Vector3,floorNormal:new e.Vector3(0,1,0),slopeRayOriginRef:new e.Vector3,slopeRayorigin:new e.Vector3,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.type="character",this.name=t.name||"hero",t.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=r,this.height=o,this.mass=t.mass||.84,delete t.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.velocity=new e.Vector3,this.angular=new e.Vector3,this.tmpV1=new e.Vector3,this.tmpV2=new e.Vector3,this.ease=new e.Vector3,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(t.angle||0)*f,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=t.ray||!1,this.callback=t.callback||function(){},t.callback&&delete t.callback,this.initPhysic(t)}setHeight(t){this.model&&this.model.setRealSize(t)}reSizePhysics(t){if(t===this.realHeight)return;this.realHeight=t,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let e=this.position.toArray();e[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let i=[this.radius,this.height-2*this.radius];this.phyData.pos=e,this.phyData.size=i,this.motor.post({m:"add",o:this.phyData})}initPhysic(t){t.size||(t.size=[this.radius,this.height-2*this.radius]),t.pos||(t.pos=[0,0,0]),t.pos[1]+=.5*this.height,this.useFloating&&(t.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.getGeometryRef({...t,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:t.size,pos:t.pos,type:"character",shapeType:t.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==t.friction?t.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:t.massInfo},t.mask&&(this.phyData.mask=t.mask),this.motor.getCharacterRef().addToWorld(this,t.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),t.gender?this.addModel(t):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(t){t.hit?(this.distance=t.distance,this.rayAngle=t.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(t){this.contact=t}showHelper(t){t?this.helper||(this.helper=new Tt(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=t)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Jt(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(t=!1){this.skeletonBody&&this.skeletonBody.isVisible(t),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:t,opacity:t?.8:1},!t),this.showHelper(t)}setMode(t){this.skeletonBody&&this.skeletonBody.setMode(t)}addModel(t){this.model=new ge({type:t.gender,anim:void 0!==t.anim?t.anim:"idle",compact:!0,material:!t.noMat,morph:t.morph||!1,randomMorph:t.randomMorph||!1,randomSize:t.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:t.noLOD||!1}),this.add(this.model);let e=-.5*this.height;this.useFloating&&(e-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+e,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(t,e){this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.velocity.fromArray(t,e+8),this.angular.fromArray(t,e+11),this.fall=this.position.y<this.oy,this.floor=w.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const t=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let e=this.tmpV1.distanceTo(this.tmpV2)/t.zoom>3?0:1;this.model.setLevel(e)}set(t){t.morph&&this.model&&this.model.setMorph(t.morph,t.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper()}onFrame(t,e){this.v,this.option}autoBalance(){const t=this.v,e=this.option,i=this.rotation;t.dragAngForce.set(-e.autoBalanceSpringK*i.x-this.angular.x*e.autoBalanceDampingC,-e.autoBalanceSpringK*i.y-this.angular.y*e.autoBalanceDampingOnY,-e.autoBalanceSpringK*i.z-this.angular.z*e.autoBalanceDampingC)}moveCharacter(t,e=0){const i=this.v,s=this.option,r=this.motor.getKey();this.motor.getAzimut(),i.currentPos.copy(this.position),i.slopeAngle=0,i.actualSlopeAngle<s.slopeMaxAngle&&Math.abs(i.slopeAngle)>.2&&Math.abs(i.slopeAngle)<s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle),Math.cos(i.slopeAngle)):i.actualSlopeAngle>=s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle)>0?0:Math.sin(i.slopeAngle),Math.sin(i.slopeAngle)>0?.1:1):i.movingDirection.set(0,0,1),i.movingDirection.applyAxisAngle({x:0,y:1,z:0},e),i.movingObjectVelocityInCharacterDir.copy(i.movingObjectVelocity).projectOnVector(i.movingDirection).multiply(i.movingDirection);const o=i.movingObjectVelocity.angleTo(i.movingDirection),a=i.currentVel.dot(i.movingDirection);i.wantToMoveVel.set(i.movingDirection.x*a,0,i.movingDirection.z*a),i.rejectVel.copy(i.currentVel).sub(i.wantToMoveVel),i.moveAccNeeded.set((i.movingDirection.x*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.x)-(i.currentVel.x-i.movingObjectVelocity.x*Math.sin(o)+i.rejectVel.x*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime,0,(i.movingDirection.z*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.z)-(i.currentVel.z-i.movingObjectVelocity.z*Math.sin(o)+i.rejectVel.z*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime);const n=i.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(e).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?i.moveImpulse.set(n.x*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*(i.canJump?1:s.airDragMultiplier)):i.moveImpulse.set(n.x*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*s.turnVelMultiplier*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier)),i.impulseCenter.set(i.currentPos.x,i.currentPos.y+s.moveImpulsePointY,i.currentPos.z),i.currentVel.copy(this.velocity),r[4]&&i.canJump&&(i.jumpVelocityVec.set(i.currentVel.x,this.running?s.sprintJumpMult*s.jumpVel:s.jumpVel,i.currentVel.z),i.moveImpulse.y=i.jumpVelocityVec.y)}getFloating(){const t=this.v,e=this.option,i=e.springK*(e.floatingDis-this.distance)-this.velocity.y*e.dampingC;t.moveImpulse.y=i*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const t=this.motor.getKey(),e=this.motor.getAzimut(),i=this.motor.delta;let s=0!==t[7]?"run":"walk";0===t[0]&&0===t[1]&&(s="idle");let r=0!==t[0]&&0!==t[1]?this.diagonal:1;t[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===t[5]&&(this.toggle=!0),"walk"!==s&&"run"!==s||!this.crouch||(s="crouch"),1===t[6]&&(s="fight"),!this.jump&&t[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let o="idle";switch(s){case"idle":o=this.crouch?"Crouch Idle":"idle";break;case"walk":o="Jog Forward";break;case"run":o="Standard Run";break;case"crouch":o="Crouch Walk";break;case"fight":o="Attack"}this.moving=0!==t[0]||0!==t[1],this.running=0!==t[7],this.wantJump=0!==t[4];let a=w.unwrapRad(Math.atan2(t[0],t[1])+e);if(this.useImpulse)this.moving?this.moveCharacter(i,a):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*i;const o=1;let a=this.speed[s]*o;this.moving&&(this.rs=t[0]*a,this.ts=t[1]*a),0===t[0]&&0===t[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*r),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let n=this.vy-9.81;this.ease.y=n,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},e),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=e,"idle"!==s&&this.helper.setDirection(a)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(o,.75),"idle"!==s)){let t=w.unwrapRad(this.model.rotation.y),i=w.nearAngle(a,t),r=Math.abs(Math.floor((t-i)*math.todeg)/180);this.model.rotation.y="fight"===s?e+Math.PI:w.lerp(t,i,.2-.1*r),this.model.updateMatrix()}}}class ve extends it{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="character",this.num=U[this.type]}step(t,e){let i,s,r=this.list.length;for(;r--;)s=this.list[r],i=e+r*this.num,s&&s.step(t,i)}add(t={}){this.setName(t);return new ye(t,this.motor)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const be={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),toFixed:(t,e=3)=>1*t.toFixed(e),int:t=>Math.floor(t),lerp:(t,e,i)=>(1-i)*t+i*e,clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),nearEquals:(t,e,i)=>Math.abs(t-e)<=i,lerpAr:(t,e,i,s)=>{let r=t.length;for(;r--;)t[r]=be.lerp(e[r],i[r],s)},unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),scaleArray:(t,e)=>{for(var i=t.length;i--;)t[i]*=e;return t},addArray:(t,e)=>{for(var i=[],s=t.length;s--;)i[s]=t[s]+e[s];return i},angleDistance:(t,e)=>{var i=(t-e+180)%360-180;return i<-180?i+360:i},tmpE:new e.Euler,tmpM:new e.Matrix4,tmpM2:new e.Matrix4,tmpV:new e.Vector3,tmpQ:new e.Quaternion,fromTransformToQ:(t,e,i)=>(i=i||!1,be.tmpM.compose(be.tmpV.fromArray(t),be.tmpQ.fromArray(e),{x:1,y:1,z:1}),be.tmpM.decompose(be.tmpV,be.tmpQ,{x:1,y:1,z:1}),i&&be.tmpQ.invert(),be.tmpQ.toArray()),fromTransform:(t,e,i,s,r)=>(r=r||!1,s=s||[0,0,0,1],be.tmpM.compose(be.tmpV.fromArray(t),be.tmpQ.fromArray(e),{x:1,y:1,z:1}),be.tmpM2.compose(be.tmpV.fromArray(i),be.tmpQ.fromArray(s),{x:1,y:1,z:1}),r?(be.tmpM.invert(),be.tmpM.multiply(be.tmpM2)):be.tmpM.multiply(be.tmpM2),be.tmpM.decompose(be.tmpV,be.tmpQ,{x:1,y:1,z:1}),be.tmpV.toArray()),arCopy:(t,e)=>{},axisToQuatArray:(t,e)=>(e=e||!1,be.tmpQ.setFromAxisAngle(be.tmpV.fromArray(t,1),e?t[0]*be.torad:t[0]).normalize().toArray()),toQuatArray:t=>be.tmpQ.setFromEuler(be.tmpE.fromArray(be.vectorad(t))).toArray(),vectorad:t=>{let e=3,i=[];for(;e--;)i[e]=t[e]*be.torad;return i[3]=t[3],i},rgbToHex:t=>"0x"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),hexToRgb:t=>[((t=Math.floor(t))>>16&255)/255,(t>>8&255)/255,(255&t)/255],htmlToHex:t=>t.toUpperCase().replace("#","0x"),hexToHtml:t=>"#"+("000000"+(t=void 0===t?0:t).toString(16)).substr(-6),rgbToHtml:t=>"#"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==be.perlin&&(be.perlin=null)},noise:(t,e)=>{null===be.perlin&&(be.perlin=new we);let i,s,r=(e=e||{}).level||[1,.2,.05],o=e.frequency||[.016,.05,.2],a=0,n=0;for(i=0;i<r.length;i++)s=o[i],a+=r[i]*(.5+.5*be.perlin.noise3d(t.x*s,t.y*s,t.z*s)),n+=r[i];return a/=n,a}};class we{constructor(t){null==t&&(t=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(e=0;e<512;e++)this.perm[e]=this.p[255&e];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}dot4(t,e,i,s,r){return t[0]*e+t[1]*i+t[2]*s+t[3]*r}noise(t,e){var i,s,r=(t+e)*(.5*(Math.sqrt(3)-1)),o=Math.floor(t+r),a=Math.floor(e+r),n=(3-Math.sqrt(3))/6,l=(o+a)*n,h=t-(o-l),c=e-(a-l);h>c?(i=1,s=0):(i=0,s=1);var u=h-i+n,d=c-s+n,p=h-1+2*n,m=c-1+2*n,f=255&o,g=255&a,y=this.perm[f+this.perm[g]]%12,v=this.perm[f+i+this.perm[g+s]]%12,b=this.perm[f+1+this.perm[g+1]]%12,w=.5-h*h-c*c,x=.5-u*u-d*d,M=.5-p*p-m*m;return 70*((w<0?0:(w*=w)*w*this.dot(this.grad3[y],h,c))+(x<0?0:(x*=x)*x*this.dot(this.grad3[v],u,d))+(M<0?0:(M*=M)*M*this.dot(this.grad3[b],p,m)))}noise3d(t,e,i){var s,r,o,a,n,l,h=(t+e+i)*(1/3),c=Math.floor(t+h),u=Math.floor(e+h),d=Math.floor(i+h),p=1/6,m=(c+u+d)*p,f=t-(c-m),g=e-(u-m),y=i-(d-m);f>=g?g>=y?(s=1,r=0,o=0,a=1,n=1,l=0):f>=y?(s=1,r=0,o=0,a=1,n=0,l=1):(s=0,r=0,o=1,a=1,n=0,l=1):g<y?(s=0,r=0,o=1,a=0,n=1,l=1):f<y?(s=0,r=1,o=0,a=0,n=1,l=1):(s=0,r=1,o=0,a=1,n=1,l=0);var v=f-s+p,b=g-r+p,w=y-o+p,x=f-a+2*p,M=g-n+2*p,S=y-l+2*p,k=f-1+.5,A=g-1+.5,T=y-1+.5,P=255&c,C=255&u,z=255&d,R=this.perm[P+this.perm[C+this.perm[z]]]%12,E=this.perm[P+s+this.perm[C+r+this.perm[z+o]]]%12,_=this.perm[P+a+this.perm[C+n+this.perm[z+l]]]%12,L=this.perm[P+1+this.perm[C+1+this.perm[z+1]]]%12,V=.6-f*f-g*g-y*y,B=.6-v*v-b*b-w*w,I=.6-x*x-M*M-S*S,F=.6-k*k-A*A-T*T;return 32*((V<0?0:(V*=V)*V*this.dot3(this.grad3[R],f,g,y))+(B<0?0:(B*=B)*B*this.dot3(this.grad3[E],v,b,w))+(I<0?0:(I*=I)*I*this.dot3(this.grad3[_],x,M,S))+(F<0?0:(F*=F)*F*this.dot3(this.grad3[L],k,A,T)))}noise4d(t,e,i,s){var r,o,a,n,l,h,c,u,d,p,m,f,g=this.grad4,y=this.simplex,v=this.perm,b=(Math.sqrt(5)-1)/4,w=(5-Math.sqrt(5))/20,x=(t+e+i+s)*b,M=Math.floor(t+x),S=Math.floor(e+x),k=Math.floor(i+x),A=Math.floor(s+x),T=(M+S+k+A)*w,P=t-(M-T),C=e-(S-T),z=i-(k-T),R=s-(A-T),E=(P>C?32:0)+(P>z?16:0)+(C>z?8:0)+(P>R?4:0)+(C>R?2:0)+(z>R?1:0),_=P-(r=y[E][0]>=3?1:0)+w,L=C-(o=y[E][1]>=3?1:0)+w,V=z-(a=y[E][2]>=3?1:0)+w,B=R-(n=y[E][3]>=3?1:0)+w,I=P-(l=y[E][0]>=2?1:0)+2*w,F=C-(h=y[E][1]>=2?1:0)+2*w,D=z-(c=y[E][2]>=2?1:0)+2*w,O=R-(u=y[E][3]>=2?1:0)+2*w,N=P-(d=y[E][0]>=1?1:0)+3*w,U=C-(p=y[E][1]>=1?1:0)+3*w,q=z-(m=y[E][2]>=1?1:0)+3*w,j=R-(f=y[E][3]>=1?1:0)+3*w,G=P-1+4*w,W=C-1+4*w,H=z-1+4*w,X=R-1+4*w,Q=255&M,Y=255&S,J=255&k,Z=255&A,K=v[Q+v[Y+v[J+v[Z]]]]%32,$=v[Q+r+v[Y+o+v[J+a+v[Z+n]]]]%32,tt=v[Q+l+v[Y+h+v[J+c+v[Z+u]]]]%32,et=v[Q+d+v[Y+p+v[J+m+v[Z+f]]]]%32,it=v[Q+1+v[Y+1+v[J+1+v[Z+1]]]]%32,st=.6-P*P-C*C-z*z-R*R,rt=.6-_*_-L*L-V*V-B*B,ot=.6-I*I-F*F-D*D-O*O,at=.6-N*N-U*U-q*q-j*j,nt=.6-G*G-W*W-H*H-X*X;return 27*((st<0?0:(st*=st)*st*this.dot4(g[K],P,C,z,R))+(rt<0?0:(rt*=rt)*rt*this.dot4(g[$],_,L,V,B))+(ot<0?0:(ot*=ot)*ot*this.dot4(g[tt],I,F,D,O))+(at<0?0:(at*=at)*at*this.dot4(g[et],N,U,q,j))+(nt<0?0:(nt*=nt)*nt*this.dot4(g[it],G,W,H,X)))}}class xe extends e.Mesh{constructor(t={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=t.name,this.folder=t.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=t.terrainType||"terrain",this.callback=t.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[t.uv||18,t.uv||18],this.sample=null==t.sample?[128,128]:t.sample,this.size=void 0===t.size?[100,30,100]:t.size;let i=this.sample[0]-1,s=this.sample[1]-1;this.rx=i/this.size[0],this.rz=s/this.size[2],this.zone=t.zone||1;let r=[this.size[0]/i,this.size[2]/s];this.sampleZ=[t.sample[0]*this.zone,t.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*r[0],t.size[1],(this.sampleZ[1]-1)*r[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:t.level||[1,.2,.05],frequency:t.frequency||[.016,.05,.2],expo:t.expo||1},this.isWater=t.water||!1,this.isIsland=t.island||!1,this.isBorder=!1,this.wantBorder=t.border||!1,this.isBottom=!1,this.wantBottom=t.bottom||!1,this.wantBorder=t.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=t.maxSpeed||.1,this.acc=null==t.acc?.01:t.acc,this.dec=null==t.dec?.01:t.dec,this.deep=null==t.deep?0:t.deep,this.ease=new e.Vector2,this.complexity=null==t.complexity?30:t.complexity,this.complexity2=null==t.complexity2?null:t.complexity2,this.local=new e.Vector3,t.local&&this.local.fromArray(t.local),this.pp=new e.Vector3,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=t.is64||!1,this.isTurn=t.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=t.isAbsolute||!1,this.isTurned=t.isTurned||!1,this.isReverse=t.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new e.PlaneGeometry(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-be.PI90),this.geometry.setAttribute("color",new e.BufferAttribute(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var o=new e.Quaternion(.5,.5,.1,.2);t.maplevels&&o.fromArray(t.maplevels);var a,n=Me,l=t.maps||["sand","grass3","rock"],h={};this.isWater&&(l=["water"]);for(let e in l)a=l[e],h[a+"_c"]=_.texture({url:this.folder+a+"_c.jpg",flip:!1,repeat:this.uvx,encoding:t.encoding||!0,callback:this.mapcallback.bind(this)}),h[a+"_n"]=_.texture({url:this.folder+a+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});h.noise=_.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=h,this.material=new e.MeshPhysicalMaterial({name:"terrain",vertexColors:!0,color:16777215,map:h[l[0]+"_c"],normalMap:h[l[0]+"_n"]}),void 0!==t.envmap&&(this.material.envMap=t.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=t.opacity||.4,this.material.side=e.DoubleSide,this.material.alphaMap=h[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=t.metalness||0,this.material.roughness=t.roughness||.3);var c=t.nScale||.5;if(this.material.normalScale.set(c,-c),this.isWater)this.material.onBeforeCompile=function(t){var e=t.fragmentShader;e=e.replace("#include <alphamap_fragment>",n.alphamap),t.fragmentShader=e};else{let t=this;this.material.onBeforeCompile=function(e){let i=e.uniforms;i.clevels={value:o},i.map1={value:h[l[1]+"_c"]},i.map2={value:h[l[2]+"_c"]},i.randomUv={value:1},i.normalMap1={value:h[l[1]+"_n"]},i.normalMap2={value:h[l[2]+"_n"]},i.noiseMap={value:h.noise},i.useNoiseMap={value:1},e.uniforms=i;let s=e.fragmentShader;s=s.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+Se+n.fragmentAdd),s=s.replace("#include <map_fragment>",n.map),s=s.replace("#include <normal_fragment_maps>",n.normal),s=s.replace("#include <color_fragment>",""),e.fragmentShader=s,t.material.userData.shader=e},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(t){this.userData.shader.uniforms.randomUv.value=t?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(t){this.userData.shader.uniforms.map1.value=t}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(t){this.userData.shader.uniforms.map2.value=t}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(t){this.userData.shader.uniforms.normalMap1.value=t}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(t){this.userData.shader.uniforms.normalMap2.value=t}})}t.debug&&this.debugZone(t),this.wantBorder&&this.addBorder(t),this.wantBottom&&this.addBottom(t),t.pos&&this.position.fromArray(t.pos),t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=be.toQuatArray(t.rot),delete t.rot),this.quaternion.fromArray(t.quat),t.decal&&(this.position.y+=t.decal),this.castShadow=!0,this.receiveShadow=!0,_.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let t=.5*(this.sample[0]-this.sampleZ[0]),e=.5*(this.sample[1]-this.sampleZ[1]),i=this.sample[0]*e+t,s=0;for(let e=0;e<this.lngZ;e++)s=Math.floor(e/this.sampleZ[0]),this.zid[i+e+s*(2*t)]=e}debugZone(t){this.geometryZ=new e.PlaneGeometry(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-be.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const i=new e.Mesh(this.geometryZ,new e.MeshBasicMaterial({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(i)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(t){var i=new e.PlaneGeometry(this.size[0],this.size[2],1,1);i.rotateX(be.PI90),this.bottomMesh=new e.Mesh(i,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(t){this.borderMaterial=new e.MeshStandardMaterial({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?t.opacity||.8:1,envMap:t.envmap||null});var i=new e.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),s=new e.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),r=new e.PlaneGeometry(this.size[2],2,this.sample[1]-1,1),o=new e.PlaneGeometry(this.size[2],2,this.sample[1]-1,1);i.translate(0,1,.5*this.size[2]),s.rotateY(-be.Pi),s.translate(0,1,.5*-this.size[2]),r.rotateY(-be.PI90),r.translate(.5*-this.size[0],1,0),o.rotateY(be.PI90),o.translate(.5*this.size[0],1,0),this.borderGeometry=R(C([i,s,r,o])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new e.BufferAttribute(this.borderColors,3)),this.borderMesh=new e.Mesh(this.borderGeometry,this.borderMaterial);for(var a,n,l=this.lng2;l--;)a=3*l,n=this.borderVertices[a+1]>0?this.findPoint(this.borderVertices[a],this.borderVertices[a+2]):-1,this.list[l]=n;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let t in this.txt)this.txt[t].dispose()}easing(t,e,i){if(0!==t[0]||0!==t[1]){var s=e||0;t[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=t[1]*this.acc,this.ease.x+=t[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,t[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),t[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(i))}}getTri(){return this.geometry}getHeight(t,e){return t*=this.rx,e*=this.rz,t+=.5*this.sample[0],e+=.5*this.sample[1],t=Math.floor(t),e=Math.floor(e),(this.isTurn?this.height[this.findId2(t,e)]:this.height[this.findId(t,e)])*this.size[1]+this.position.y}findIdZ(t,e){return t+e*this.sampleZ[1]}findId(t,e){return t+e*this.sample[1]}findId2(t,e){return e+-t*this.sample[0]||1}findPoint(t,e){for(var i,s=this.lng;s--;)if(i=3*s,this.vertices[i]===t&&this.vertices[i+2]===e)return s;return-1}getReverseID(){this.invId=[];let t,e,i=this.lngZ;const s=this.sampleZ[1]-1;for(this.sampleZ[0];i--;)t=i%this.sampleZ[0],e=Math.floor(i*this.ratioZ),this.isReverse&&(e=s-e),this.invId[i]=this.isTurned?this.lngZ-1-this.findIdZ(e,t):this.findIdZ(t,e)}set(t){t.ease&&this.easing(t.key,t.azimut),t.decal&&this.decal(t.decal,!0)}decal(t,e){this.local.x+=t[0],this.local.y+=t[1],this.local.z+=t[2],this.update(e)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let t={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(t),this.material.normalMap&&this.material.normalMap.offset.copy(t)}}distance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}clamp(t,e=0,i=1){return t=(t=t<e?e:t)>i?i:t}update(t){let e,i,s,r,o,a,n,l,h,c,u,d=this.pp,p=[1,1,1],m=this.lng;for(;m--;){if(e=3*m,i=m%this.sample[0],s=Math.floor(m*this.ratio),d.set(i+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),r=be.noise(d,this.data),this.isIsland){let t=1-this.distance({x:i,y:s},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));t*=4,t=this.clamp(t),r*=t}r=Math.pow(r,this.data.expo),r=this.clamp(r),"road"===this.ttype&&(l===s?r=1===i||2===i||29===i||30===i?h+.1:h:(l=s,h=r)),this.height[m]=r,c=r*this.size[1]+this.deep,this.vertices[e+1]=c,a=this.isAbsolute?r:r*this.size[1],void 0!==this.zid[m]&&(n=this.zid[m],o=this.changeId?this.invId[n]:n,this.heightData[o]=a,this.verticesZ&&(this.verticesZ[3*n+1]=c)),p=this.isWater?[r*this.colorBase.r,r*this.colorBase.g,r*this.colorBase.b]:[r,0,0],u=p[0],this.colors[e]=u,this.colors[e+1]=u,this.colors[e+2]=u}if(this.isBorder){let t,i=this.lng2;for(;i--;)e=3*i,-1!==this.list[i]?(t=this.height[this.list[i]],this.borderVertices[e+1]=t*this.size[1]+this.deep,u=be.clamp(t+.25,.25,1),this.borderColors[e]=u,this.borderColors[e+1]=u,this.borderColors[e+2]=u):(this.borderColors[e]=this.colorBase.r,this.borderColors[e+1]=this.colorBase.g,this.borderColors[e+2]=this.colorBase.b)}t?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(t){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const Me={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "},Se="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n";let ke=null;class Ae extends it{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,ke=this.motor.mat,this.type="terrain",this.num=U[this.type]}step(t,e){let i,s=this.list.length;for(;s--;)i=this.list[s],i.step()}add(t={}){this.setName(t),"JOLT"===this.engine&&(t.isAbsolute=!0,t.isTurned=!1),"PHYSX"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"HAVOK"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"OIMO"!==this.engine&&(t.zone=t.zone||.25);const e=new xe(t);return ke.extendShader(e.material,e.material.onBeforeCompile),e.physicsUpdate=(t,e)=>{this.motor.flow.tmp.push({name:t,heightData:e})},this.addToWorld(e,t.id),this.motor.post({m:"add",o:Te(e,this.engine)}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const Te=function(t,e){const i={name:t.name,type:t.type,pos:t.position.toArray(),quat:"PHYSX"===e?[0,0,0,1]:t.quaternion.toArray()};return"PHYSX"===e||"AMMO"===e||"HAVOK"===e||"JOLT"===e?(i.type="terrain",i.size=t.sizeZ,i.sample=t.sampleZ,i.zone=t.zone,i.heightData=t.heightData):(i.type="mesh",i.v=w.getVertex(t.geometry,"OIMO"===e),i.index="OIMO"===e?null:w.getIndex(t.geometry)),i};class Pe extends it{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="solver"}step(t,e){let i,s=this.list.length;for(;s--;)i=e+s*U[this.type],this.list[s].update(t,i)}add(t={}){this.setName(t);let e=new Ce(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}set(t={}){}}class Ce{constructor(t,e){this.motor=e,this.name=t.name,this.type="solver",this.needData=t.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(t){this.bones.push(t)}dispose(){this.motor.remove(this.bones,!0)}update(t,e){if(!this.needData)return;let i,s,r=this.joints.length;for(;r--;)s=e+7*r,i=this.joints[r],i.data.target.x=t[s+0],i.data.target.y=t[s+1],i.data.target.z=t[s+2],i.data.target.rx=t[s+3],i.data.target.ry=t[s+4],i.data.target.rz=t[s+5],i.data.target.count=t[s+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(t){this.jid=this.joints.length,t.name=t.name||this.name+"_Joint_"+this.jid,t.solver=this.name,void 0!==t.rot1&&(t.quat1=w.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=w.quatFromEuler(t.rot2),delete t.rot2),"fixe"!==t.type&&this.joints.push(new ze(t,this)),this.motor.post({m:"addSolverJoint",o:t})}driveJoints(t){let e,i,s=!1,r=this.joints.length,o=[];for(;r--;)e=this.joints[r],e.update(t),i=e.isDrive,e.nup&&o.push(e.nup),s=!!i||s;s?this.motor.change(o):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(t,e){if(!t)return;let i=this.joints.length;for(;i--;)this.joints[i].pose(void 0!==t[i]?t[i]:0,void 0!==e?e:this.speed);return new Promise((t=>this.resolve=t))}}class ze{constructor(t,e){if(this.name=t.name,this.solver=e,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},t.limits&&(this.driveType=t.limits[0][0],this.min=t.limits[0][1],this.max=t.limits[0][2]),t.position&&(t.target=t.position),t.target){let e,i=t.target.length;for(;i--;)e=t.target[i],this.data.target[e[0]]=e[1]}}start(){}pose(t,e){this.target=w.clamp(t,this.min,this.max),this.current=w.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=e,this.isDrive=!0)}update(t){if(this.isDrive){this.tmp+=t*this.time;let e=this.tmp;e=e>1?1:e;let i=w.lerp(this.start,this.target,e);this.nup={name:this.name,drivesTarget:[[this.driveType,i]]},1===e&&(this.isDrive=!1)}else this.nup=null}}class Re{constructor(t){this.map=new Map,this.motor=t,this.enginReady=["PHYSX","HAVOK","OIMO"],this.rc=this.refresh.bind(this)}reset(){this.map=new Map}step(){this.map.forEach(this.rc)}refresh(t,e){let i=this.motor.reflow.contact[e];if(void 0!==i)for(let e=0,s=i.length;e<s;e++)t.userData.collisionCallback?t.userData.collisionCallback(i[e]):t.dispatchEvent({type:"collision",data:i[e]})}isReady(){return-1!==this.enginReady.indexOf(this.motor.engine)}remove(t){this.isReady()&&this.map.has(t)&&(this.map.delete(t),this.motor.post({m:"removeCollision",o:{name:t}}))}add(t){if(!this.isReady())return;let e=t.name,i=this.motor.byName(e);null!==i&&(t.vs&&t.vs.constructor!==Array&&(t.vs=[t.vs]),t.ignore&&t.ignore.constructor!==Array&&(t.ignore=[t.ignore]),t.callback&&(i.userData.collisionCallback=t.callback,delete t.callback),this.map.set(e,i),this.motor.post({m:"addCollision",o:t}))}}class Ee extends e.Mesh{constructor(t={}){super(new e.PlaneGeometry,new e.MeshBasicMaterial({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=t.nam||"text",this.canvas=null,this.w=t.w||0,this.h=t.h||0,this.weight=t.weight??700,this.font=t.font??"'Mulish', sans-serif",this.fontSize=t.fontSize??32,this.backgroundColor=t.backgroundColor??"#00000000",this.fontColor=t.color??"#FFFFFF",this.material.alphaTest=.5,this.set(t.text),t.pos&&this.position.fromArray(t.pos),t.rot&&this.quaternion.fromArray(w.quatFromEuler(t.rot))}set(t){this.canvas||(this.canvas=document.createElement("canvas"));let i,s,r,o=this.canvas.getContext("2d");o.font=this.weight+" "+this.fontSize+"px "+this.font;let a=o.measureText(t);i=2**Math.ceil(Math.log2(a.width)),s=2**Math.ceil(Math.log2(o.measureText("M").width)),this.canvas.width=i,this.canvas.height=s,o.fillStyle=this.backgroundColor,o.fillRect(0,0,i,s),o.fillStyle=this.fontColor,o.font=this.weight+" "+this.fontSize+"px "+this.font,o.textAlign="center",o.textBaseline="middle",o.fillText(t,.5*i,.5*s),this.material.map=new e.CanvasTexture(this.canvas),0!==this.h?(r=this.h/s,this.scale.set(i*r,this.h,0)):0!==this.w?(r=this.w/s,this.scale.set(this.w,s*r,0)):this.scale.set(.025*i,.025*s,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let _e=0;class Le{constructor(t={},e){this.motor=e,this.down=!1,this.time=t.time||250,this.p=t.pos||[0,0,0],this.type=t.type||"box",this.name=t.name||"button"+_e++,this.pos=t.pos||[0,0,0],this.size=t.size||[1,1,1],this.radius=t.radius||0,this.axe=void 0!==t.axe?t.axe:1,this.fontSize=t.fontSize||.8,this.fontScale=t.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let i=this.size[this.axe]-2*this.radius;this.range=[this.origin-i,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},t.callback&&(this.callback=t.callback,delete t.callback),t.button=!0,t.pos=this.pos,t.material||(t.material="button"),t.kinematic=!0,t.mask=1,this.timeout=null,this.b=this.motor.add(t),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),t.text&&this.addText(t.text)}addText(t,e){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let i={text:t,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(i={text:t,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new Ee(i),this.b.add(this.txt)}action(t){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(t||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=w.lerp(this.value,this.target,this.speed),w.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}const Ve=new e.Box3;class Be extends e.LineSegments{constructor(t,i=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24);let o=new e.Color(i),a=[],n=8;for(;n--;)a.push(o.r,o.g,o.b);const l=new Float32Array(a),h=new e.BufferGeometry;h.setIndex(new e.BufferAttribute(s,1)),h.setAttribute("position",new e.BufferAttribute(r,3)),h.setAttribute("color",new e.BufferAttribute(l,3)),super(h,new e.LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Ve.setFromObject(this.object),Ve.isEmpty())return;const e=Ve.min,i=Ve.max,s=this.geometry.attributes.position,r=s.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=e.x,r[4]=i.y,r[5]=i.z,r[6]=e.x,r[7]=e.y,r[8]=i.z,r[9]=i.x,r[10]=e.y,r[11]=i.z,r[12]=i.x,r[13]=i.y,r[14]=e.z,r[15]=e.x,r[16]=i.y,r[17]=e.z,r[18]=e.x,r[19]=e.y,r[20]=e.z,r[21]=i.x,r[22]=e.y,r[23]=e.z,s.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Ie{constructor(t={},e){this.motor=e,this.isCompound=!0,this.remplace=t.remplace||!1,this.init(t)}init(t={}){const i=t.intern||!1;let s=t.size||[5,3,8],r=t.pos||[0,2,0],o=t.wall||.1;void 0!==t.size[3]&&(o=t.size[3]),o<=0&&(o=.01);let a=.5*o,n=2*o;t.face||(t.face={});let l={up:1,down:1,left:1,right:1,front:1,back:1,...t.face};delete t.face;const h=[];i?(1===l.up&&h.push({pos:[0,.5*s[1]+a,0],size:[s[0]+n,o,s[2]+n]}),1===l.down&&h.push({pos:[0,-a-.5*s[1],0],size:[s[0]+n,o,s[2]+n]}),1===l.left&&h.push({pos:[-a-.5*s[0],0,0],size:[o,s[1],s[2]]}),1===l.right&&h.push({pos:[.5*s[0]+a,0,0],size:[o,s[1],s[2]]}),1===l.back&&h.push({pos:[0,0,-a-.5*s[2]],size:[s[0]+n,s[1],o]}),1===l.front&&h.push({pos:[0,0,.5*s[2]+a],size:[s[0]+n,s[1],o]})):(1===l.up&&h.push({pos:[0,.5*s[1]-a,0],size:[s[0],o,s[2]]}),1===l.down&&h.push({pos:[0,a-.5*s[1],0],size:[s[0],o,s[2]]}),1===l.left&&h.push({pos:[a-.5*s[0],0,0],size:[o,s[1]-n,s[2]]}),1===l.right&&h.push({pos:[.5*s[0]-a,0,0],size:[o,s[1]-n,s[2]]}),1===l.back&&h.push({pos:[0,0,a-.5*s[2]],size:[s[0]-n,s[1]-n,o]}),1===l.front&&h.push({pos:[0,0,.5*s[2]-a],size:[s[0]-n,s[1]-n,o]}));const c=[];let u,d,p=h.length,m=0;for(;p--;)d=h[m],u=this.isCompound?d.pos:w.addArray(r,d.pos),c.push({type:"box",size:d.size,pos:u,material:t.material}),m++;if(this.isCompound){let i=null;this.remplace&&(i=0===t.radius?new e.Mesh(new e.BoxGeometry(s[0],s[1],s[2])):new e.Mesh(new ut(s[0],s[1],s[2],t.radius||a)),t.material&&"debug"===t.material&&(i=new Be(i,t.color),t.material="line"),i.raycast=()=>{}),this.motor.add({...t,mesh:i,shapes:c,type:"compound",ray:!1})}else this.motor.add(c)}}class Fe{constructor(t,i="drag",s){this.motor=s,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=i,this.option={},this.overObj=null,this.controler=t,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new e.Vector3,this.tmpPos=new e.Vector3,this.tmpD=new e.Vector3,this.mouse=new e.Vector2,this.oldMouse=new e.Vector2,this.raycast=new e.Raycaster,this.raycast.far=1e3,this.button=0,this.pos=new e.Vector3,this.velocity=new e.Vector3,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.floorDrag=2===this.button,this.helper=new De(this.motor),this.dragPlane=new e.Mesh(new e.PlaneGeometry(1,1),this.motor.mat.get("hide")),this.floorDrag&&this.dragPlane.geometry.rotateX(.5*-Math.PI),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.dragPlane.visible=!1,this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(t,e={}){t!==this.mode&&(this.mode=t,this.option=e,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(t){t?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(t){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(t){this.raycastTest=!1}controleChange(t){}getMouse(t){this.motor.viewSize?(this.mouse.x=t.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-t.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=t.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-t.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==t.pointerType?t.button:0}contextmenu(t){}mousedown(t){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(t),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(t){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(t){if("drag"===this.mode)this.getMouse(t),this.needRay=!0}castray(){let t,e,i,s,r,o="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObject(this.dragPlane),t.length&&this.mouseDown&&this.moveSelect(t[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,t.length>0?(i=t[0].object,i.isInstancedMesh?(r=t[0].instanceId,e=this.motor.byName(i.getIDName(r))):i.parent!==this.motor.scene?(s=i.parent,e=s.parent!==this.motor.scene?s.parent:s):e=i,this.mouseDown2&&e.extra&&e.extra(e.name),o=e&&!e.isButton?this.select(e,t[0].point):this.actionButton(e,t[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,o="auto",this.resetOver()),document.body.style.cursor=o}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.needRay=!0}blast(){let t=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let e=this.raycast.intersectObjects(this.motor.scene.children,!0);e.length>0?e[0].object.isButton?e[0].object.parent.userData.direct():t=e[0]:(e=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),e.length>0&&(t=e[0]));const i=this.option;t&&(this.motor.explosion(t.point,i.radius||3,i.power||.1),i.visible&&this.motor.addParticle({name:"blast",type:"cube",position:t.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){const t=this.option;this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(t.velocity||60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",mass:t.mass||10,size:[t.size||.2],material:t.mat||"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(t,e){if(this.buttonRef?this.buttonRef.name!==t.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=t):this.mouseDown&&(this.buttonRef=t),this.mouseDown&&this.buttonRef.userData.action){let t=e.point;this.buttonRef.userData.action(t)}return"pointer"}setOver(t){t&&(this.overObj&&t.name!==this.overObj.name&&this.resetOver(),this.overObj=t,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(t,e){if(this.mouseDown||this.setOver(t),!this.mouseDown||this.selected===t)return"grab";this.pz=0;let i=e,s=[0,0,0,1];this.selected=t,this.decal.copy(i).sub(this.selected.position),this.tmpPos.copy(i).sub(this.decal),this.angle=this.controler.getAzimuthalAngle(),s=this.selected.quaternion.toArray(),this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(i),this.helper.position.copy(i);let r=i.toArray(),o=!1;this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0});const a=this.motor.engine;if(this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let t=[-.1,.1,600,1],e=[-.1,.1,600,1],i="OIMO"===a||"RAPIER"===a||"JOLT"===a,n=0===this.selected.link?"fixe":"d6";"JOLT"===a&&(n="fixe");let l=[["x",...t],["y",...t],["z",...t],["rx",...e],["ry",...e],["rz",...e]];"HAVOK"===a&&(l=[["x",...t],["y",...t],["z",...t]]),"OIMO"===a&&(o=!0,n=0===this.selected.link?"fixe":"spherical",l=[["x",...t],["y",...t],["z",...t]]),"HAVOK"===a&&(n=0===this.selected.link?"fixe":"spherical",l=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:r,quat:s,kinematic:!i},{name:"mouseJoint",type:"joint",mode:n,lm:l,sd:[4,1],autoDrive:!0,b1:o?this.selected.name:"mouse",b2:o?"mouse":this.selected.name,worldAnchor:r,visible:!1}])}return"grabbing"}moveSelect(t){if(null===this.selected)return;if(t&&this.tmpPos.copy(t).sub(this.decal),this.moveDeep){let t=this.selected.position.y,e=t-this.tmpPos.y;this.tmpPos.y=t,this.tmpD.set(0,0,e).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let e=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:e,reset:!0}):this.motor.change({name:"mouse",pos:t.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let t=this.motor.flow.key;if(0!==t[1]){let e=.1*t[1];this.dragPlane.translateZ(e),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class De extends e.Line{constructor(t){super(new e.BufferGeometry,t.mat.get("line"));let i=.75;const s=[i,i,i,0,0,0];this.geometry.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute(s,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}function Oe(t,e,i,s){return function(t,e,i,s,r){let o=e.x-t.x,a=e.y-t.y,n=s.x-i.x,l=s.y-i.y;const h=We(t),c=We(i);if(h===c)return r;const u=We(e);if(u===c)return r;const d=We(s);if(h===d)return r;if(u===d)return r;let p=(t.x-i.x)*l-(t.y-i.y)*n,m=(e.x-i.x)*l-(e.y-i.y)*n,f=(i.x-t.x)*a-(i.y-t.y)*o,g=(s.x-t.x)*a-(s.y-t.y)*o;return(p>=0&&m<=0||p<=0&&m>=0)&&(f>=0&&g<=0||f<=0&&g>=0)}(t,e,i,s,!1)}function Ne(t,i,s,r){let o=0,a=new e.Vector3;return He(t)===He(i)||0===s.x&&0===s.y&&0===s.z?null:(o=((r.x-t.x)*s.x+(r.y-t.y)*s.y+(r.z-t.z)*s.z)/((i.x-t.x)*s.x+(i.y-t.y)*s.y+(i.z-t.z)*s.z),o<0||o>1?null:(a=new e.Vector3(t.x+(i.x-t.x)*o,t.y+(i.y-t.y)*o,t.z+(i.z-t.z)*o),{x:a,s:o}))}function Ue(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)<=0}function qe(t){return parseInt(Math.round(1e6*t))}function je(t,e=1e6){return Math.floor(t*e)}function Ge(t,e){return Math.round((t+e)*(t+e+1)*.5+e)}function We(t){return Ge(je(t.x),je(t.y))}function He(t){const e=je(t.x),i=je(t.y),s=je(t.z),r=(e+i)*(e+i+1)*.5+i;return(r+s)*(r+s+1)*.5+s}function Xe(t,e,i){return!(e.x*(t.x-i.x)+e.y*(t.y-i.y)+e.z*(t.z-i.z)<0)}class Qe{constructor(t=new e.Vector3,i=new e.Vector3,s=new e.Vector2){this.position=t,this.normal=i,this.uv=s}equals(t){return He(this.position)===He(t.position)}toString(){return`Position = ${this.position.x}, ${this.position.y}, ${this.position.z}, Normal = ${this.normal.x}, ${this.normal.y}, ${this.normal.z}, UV = ${this.uv.x}, ${this.uv.y}`}}class Ye{constructor(){this.vertices=[],this.cutVertices=[],this.triangles=[[],[]],this.constraints=[],this.indexMap=[],this.bounds=new e.Box3,this.vertexAdjacency=[],this.convextested=!1}static fromGeometry(t){const i=t.attributes.position.array,s=t.attributes.normal.array,r=t.attributes.uv.array,o=t.attributes.position.count;let a,n;const l=new Ye;for(let t=0;t<o;t++)a=3*t,n=2*t,l.vertices.push(new Qe(new e.Vector3(i[a],i[a+1],i[a+2]),new e.Vector3(s[a],s[a+1],s[a+2]),new e.Vector2(r[n],r[n+1])));return l.triangles=[[...t.index.array],[]],l.calculateBounds(),l}get size(){this.bounds||this.calculateBounds();let t=new e.Vector3;return this.bounds.getSize(t)}get convex(){return this.convextested||(this.cc=this.isConvex()),this.cc}get triangleCount(){return(this.triangles[0].length+this.triangles[1].length)/3}get vertexCount(){return this.vertices.length+this.cutVertices.length}addCutFaceVertex(t,e,i){const s=new Qe(t,e,i);this.vertices.push(s),this.cutVertices.push(s),this.vertexAdjacency.push(this.vertices.length-1)}addMappedVertex(t,e){this.vertices.push(t),this.indexMap[e]=this.vertices.length-1}addTriangle(t,e,i,s){this.triangles[s].push(t,e,i)}addMappedTriangle(t,e,i,s){this.triangles[s].push(this.indexMap[t],this.indexMap[e],this.indexMap[i])}weldCutFaceVertices(){const t=[],e=[],i=new Array(this.cutVertices.length);let s=0;const r=new Map;this.cutVertices.forEach(((o,a)=>{const n=function(t){let e=qe(t.x),i=qe(t.y),s=qe(t.z),r=(e+i)*(e+i+1)*.5+i;return(r+s)*(r+s+1)*.5+s}(o.position),l=r.get(n);void 0===l?(i[a]=s,r.set(n,s),t.push(this.cutVertices[a]),e.push(this.vertexAdjacency[a]),s++):i[a]=l}));for(let t=0;t<this.constraints.length;t++){const e=this.constraints[t];e.v1=i[e.v1],e.v2=i[e.v2]}this.cutVertices=t,this.vertexAdjacency=e}calculateBounds(){if(!this.vertices.length)return;let t=this.vertices[0].position.clone(),e=t.clone();this.vertices.forEach((i=>{t.x=Math.min(t.x,i.position.x),t.y=Math.min(t.y,i.position.y),t.z=Math.min(t.z,i.position.z),e.x=Math.max(e.x,i.position.x),e.y=Math.max(e.y,i.position.y),e.z=Math.max(e.z,i.position.z)})),this.bounds.set(t,e)}calculateBounds_(t=!1){null===this.bounds&&(this.bounds=new e.Box3);let i=this.vertices.length;t&&(i+=this.cutVertices.length);const s=[];let r=-1;for(const t of this.vertices)s[r++]=t.position;if(t)for(const t of this.cutVertices)s[r++]=t.position;this.bounds.setFromPoints(s)}toMesh(t,i=null,s=!0,r=0){const o=new e.Vector3,a=new e.Vector3;let n=this.toGeometry(s,r);n.boundingBox.getCenter(o),n.boundingBox.getSize(a),n.translate(-o.x,-o.y,-o.z),n.boundingSphere=new e.Sphere(new e.Vector3,.5*a.length());let l=t.material;i&&l.isMaterial&&(l=[t.material,i]);const h=new e.Mesh(n,l);return h.receiveShadow=t.receiveShadow,h.castShadow=t.castShadow,h.sizer=a.length(),o.applyQuaternion(t.quaternion),h.position.copy(t.position).add(o),h.quaternion.copy(t.quaternion),h.userData={origin:h.position.clone(),direction:o.normalize(),size:a},h}makeTrickness(t,e,i,s,r){let o,a=1-r,n=[...t],l=[...e],h=[...i],c=t.length/3,u=c;for(;u--;)o=3*u,n[o]*=a,n[o+1]*=a,n[o+2]*=a;let d=[];for(u=s.length;u--;)d[u]=s[u]+c;return[n,l,h,d]}toGeometry(t,i){let s;const r=new e.BufferGeometry;let o=[],a=[],n=[];if(this.vertices.forEach((t=>{o.push(t.position.x,t.position.y,t.position.z),a.push(t.normal.x,t.normal.y,t.normal.z),n.push(t.uv.x,t.uv.y)})),0!==i){let t=this.makeTrickness(o,a,n,this.triangles[0],i);o=o.concat(t[0]),a=a.concat(t[1]),n=n.concat(t[2]),s=t[3]}return t&&this.cutVertices.forEach((t=>{o.push(t.position.x,t.position.y,t.position.z),a.push(t.normal.x,t.normal.y,t.normal.z),n.push(t.uv.x,t.uv.y)})),r.addGroup(0,this.triangles[0].length,0),0!==i&&(r.addGroup(this.triangles[0].length,s.length,1),this.triangles[0]=this.triangles[0].concat(s)),t&&r.addGroup(this.triangles[0].length,this.triangles[1].length,1),r.setAttribute("position",new e.BufferAttribute(new Float32Array(o),3)),r.setAttribute("normal",new e.BufferAttribute(new Float32Array(a),3)),r.setAttribute("uv",new e.BufferAttribute(new Float32Array(n),2)),r.setIndex(new e.BufferAttribute(new Uint32Array(this.triangles.flat()),1)),r.computeBoundingBox(),r}isConvex(t=.001){this.convextested=!0;let i=0;const s=this.triangleCount,r=[...this.triangles[0],...this.triangles[1]],o=[...this.vertices,...this.cutVertices],a=o.length;if(0===s||0===a)return!1;const n=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,u=new e.Vector3;let d,p;for(let e=0;e<s;e++){i=3*e,u.copy(o[0].position),n.copy(o[r[i]].position),l.copy(o[r[i+1]].position),h.copy(o[r[i+2]].position),l.sub(n),h.sub(n),c.copy(l).cross(h).normalize(),d=u.sub(n).dot(c);for(let e=0;e<a;e++)if(p=u.copy(o[e].position).sub(n).dot(c),Math.abs(d)>t&&Math.abs(p)>t&&d*p<0)return!1}return!0}}class Je{constructor(t){this.parent=new Array(t),this.rank=new Array(t);for(let e=0;e<t;e++)this.parent[e]=e,this.rank[e]=1}find(t){return this.parent[t]!==t&&(this.parent[t]=this.find(this.parent[t])),this.parent[t]}union(t,e){const i=this.find(t),s=this.find(e);i!==s&&(this.rank[i]>this.rank[s]?this.parent[s]=i:this.rank[i]<this.rank[s]?this.parent[i]=s:(this.parent[s]=i,this.rank[i]+=1))}}let Ze=class{constructor(t,e,i,s,r){this.v1=t,this.v2=e,this.t1=void 0!==i?i:-1,this.t2=void 0!==s?s:-1,this.t1Edge=void 0!==r?r:0}equals(t){return this.v1===t.v1&&this.v2===t.v2||this.v1===t.v2&&this.v2===t.v1}toString(){return`Edge: T${this.t1}->T${this.t2} (V${this.v1}->V${this.v2})`}};class Ke{static getBinNumber(t,e,i){return t%2==0?t*i+e:(t+1)*i-e-1}static sort(t,e,i){if(i<=1)return t;e>t.length&&(e=t.length);const s=new Array(i).fill(0),r=new Array(t.length);for(let i=0;i<e;i++)s[t[i].bin]++;for(let t=1;t<i;t++)s[t]+=s[t-1];for(let i=e-1;i>=0;i--){const e=t[i].bin;s[e]--,r[s[e]]=t[i]}for(let i=e;i<r.length;i++)r[i]=t[i];return r}}let $e=class{constructor(t,e){this.index=t,this.coords=e,this.bin=0}toString(){return`${this.coords} -> ${this.bin}`}};const ti=-1;class ei{constructor(t,i){if(this.normalizationScaleFactor=1,this.N=t.length,this.N>=3){this.triangleCount=2*this.N+1,this.triangulation=Array.from({length:this.triangleCount},(()=>new Array(6).fill(0))),this.skipTriangle=new Array(this.triangleCount).fill(!1),this.points=new Array(this.N+3),this.normal=i.clone().normalize();let o=t[0].position.clone().sub(t[1].position).normalize(),a=this.normal.clone(),n=new e.Vector3;n.crossVectors(o,a).normalize();for(let i=0;i<this.N;i++){var s=t[i].position,r=new e.Vector2(s.dot(o),s.dot(n));this.points[i]=new $e(i,r)}}else this.triangleCount=0,this.triangulation=[],this.skipTriangle=[],this.points=[],this.normal=new e.Vector3}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.discardTrianglesWithSuperTriangleVertices();const t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||t.push(this.triangulation[e][0],this.triangulation[e][1],this.triangulation[e][2]);return t}normalizeCoordinates(){let t=Number.MAX_VALUE,i=Number.MIN_VALUE,s=Number.MAX_VALUE,r=Number.MIN_VALUE;for(let e=0;e<this.N;e++)t=Math.min(t,this.points[e].coords.x),i=Math.max(i,this.points[e].coords.x),s=Math.min(s,this.points[e].coords.y),r=Math.max(r,this.points[e].coords.y);const o=Math.max(i-t,r-s);for(let i=0;i<this.N;i++){var a=this.points[i],n=new e.Vector2((a.coords.x-t)/o,(a.coords.y-s)/o);this.points[i].coords=n}}sortPointsIntoBins(){const t=Math.round(Math.pow(this.N,.25)),e=t*t;for(let e=0;e<this.N;e++){var i=this.points[e];const s=Math.floor(.99*t*i.coords.y),r=Math.floor(.99*t*i.coords.x);i.bin=Ke.getBinNumber(s,r,t)}return Ke.sort(this.points,this.N,e)}computeTriangulation(){let t=0,e=0,i=this.sortPointsIntoBins();for(let s=0;s<this.N;s++){let r=i[s];if(!r)break;let o=0,a=!1;for(;!a&&!(o++>e||t===ti);){let i=this.points[this.triangulation[t][0]].coords,s=this.points[this.triangulation[t][1]].coords,o=this.points[this.triangulation[t][2]].coords;Ue(i,s,r.coords)?Ue(s,o,r.coords)?Ue(o,i,r.coords)?(this.insertPointIntoTriangle(r,t,e),e+=2,t=e,a=!0):t=this.triangulation[t][5]:t=this.triangulation[t][4]:t=this.triangulation[t][3]}}}addSuperTriangle(){this.points[this.N]=new $e(this.N,new e.Vector2(-100,-100)),this.points[this.N+1]=new $e(this.N+1,new e.Vector2(0,100)),this.points[this.N+2]=new $e(this.N+2,new e.Vector2(100,-100)),this.triangulation[0][0]=this.N,this.triangulation[0][1]=this.N+1,this.triangulation[0][2]=this.N+2,this.triangulation[0][3]=ti,this.triangulation[0][4]=ti,this.triangulation[0][5]=ti}insertPointIntoTriangle(t,e,i){const s=e,r=i+1,o=i+2;this.triangulation[r][0]=t.index,this.triangulation[r][1]=this.triangulation[e][1],this.triangulation[r][2]=this.triangulation[e][2],this.triangulation[r][3]=o,this.triangulation[r][4]=this.triangulation[e][4],this.triangulation[r][5]=s,this.triangulation[o][0]=t.index,this.triangulation[o][1]=this.triangulation[e][0],this.triangulation[o][2]=this.triangulation[e][1],this.triangulation[o][3]=s,this.triangulation[o][4]=this.triangulation[e][3],this.triangulation[o][5]=r,this.updateAdjacency(this.triangulation[e][3],e,o),this.updateAdjacency(this.triangulation[e][4],e,r),this.triangulation[s][1]=this.triangulation[e][2],this.triangulation[s][2]=this.triangulation[e][0],this.triangulation[s][0]=t.index,this.triangulation[s][4]=this.triangulation[e][5],this.triangulation[s][3]=r,this.triangulation[s][5]=o,this.restoreDelauneyTriangulation(t,s,r,o)}restoreDelauneyTriangulation(t,e,i,s){const r=[];for(r.push([e,this.triangulation[e][4]]),r.push([i,this.triangulation[i][4]]),r.push([s,this.triangulation[s][4]]);r.length>0;)if([e,i]=r.pop()??[ti,ti],i!==ti){const s=this.swapQuadDiagonalIfNeeded(t.index,e,i);null!==s&&(r.push([e,s.t3]),r.push([i,s.t4]))}}swapQuadDiagonalIfNeeded(t,e,i){let s=0,r=0,o=0,a=t,n=0,l=0;return this.triangulation[i][3]===e?(s=this.triangulation[i][1],r=this.triangulation[i][0],o=this.triangulation[i][2],n=this.triangulation[i][4],l=this.triangulation[i][5]):this.triangulation[i][4]===e?(s=this.triangulation[i][2],r=this.triangulation[i][1],o=this.triangulation[i][0],n=this.triangulation[i][5],l=this.triangulation[i][3]):(s=this.triangulation[i][0],r=this.triangulation[i][2],o=this.triangulation[i][1],n=this.triangulation[i][3],l=this.triangulation[i][4]),this.swapTest(this.points[s].coords,this.points[r].coords,this.points[o].coords,this.points[a].coords)?(this.updateAdjacency(n,i,e),this.updateAdjacency(this.triangulation[e][5],e,i),this.triangulation[e][0]=a,this.triangulation[e][1]=s,this.triangulation[e][2]=o,this.triangulation[i][0]=a,this.triangulation[i][1]=o,this.triangulation[i][2]=r,this.triangulation[i][3]=e,this.triangulation[i][4]=l,this.triangulation[i][5]=this.triangulation[e][5],this.triangulation[e][4]=n,this.triangulation[e][5]=i,{t3:n,t4:l}):null}discardTrianglesWithSuperTriangleVertices(){for(let t=0;t<this.triangleCount;t++)(this.triangleContainsVertex(t,this.N)||this.triangleContainsVertex(t,this.N+1)||this.triangleContainsVertex(t,this.N+2))&&(this.skipTriangle[t]=!0)}swapTest(t,e,i,s){const r=t.x-i.x,o=e.x-i.x,a=t.y-i.y,n=e.y-i.y,l=t.x-s.x,h=e.x-s.x,c=t.y-s.y,u=e.y-s.y,d=r*o+a*n,p=h*l+u*c;return!(d>=0&&p>=0)&&(d<0&&p<0||(r*n-o*a)*p+(h*c-l*u)*d<0)}triangleContainsVertex(t,e){return this.triangulation[t][0]===e||this.triangulation[t][1]===e||this.triangulation[t][2]===e}updateAdjacency(t,e,i){if(t===ti)return;const s=this.findSharedEdge(t,e);null!==s&&(this.triangulation[t][s]=i)}findSharedEdge(t,e){return t===ti?null:this.triangulation[t][3]===e?3:this.triangulation[t][4]===e?4:this.triangulation[t][5]===e?5:null}}let ii=class{constructor(t,e,i,s,r,o,a,n,l,h){this.q1=t,this.q2=e,this.q3=i,this.q4=s,this.t1=r,this.t2=o,this.t1L=a,this.t1R=n,this.t2L=l,this.t2R=h}toString(){return`T${this.t1}/T${this.t2} (V${this.q1},V${this.q2},V${this.q3},V${this.q4})`}};class si extends ei{edgeVertex1=[0,0,0,0,1,2];edgeVertex2=[0,0,0,1,2,0];oppositePoint=[0,0,0,2,0,1];nextEdge=[0,0,0,4,5,3];previousEdge=[0,0,0,5,3,4];constructor(t,e,i){super(t,i),this.constraints=e,this.vertexTriangles=[],this.visited=[]}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.constraints.length>0&&(this.applyConstraints(),this.discardTrianglesViolatingConstraints()),this.discardTrianglesWithSuperTriangleVertices();let t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||(t.push(this.triangulation[e][0]),t.push(this.triangulation[e][1]),t.push(this.triangulation[e][2]));return t}applyConstraints(){const t=this.triangulation.length;this.visited=new Array(t).fill(!1),this.vertexTriangles=new Array(this.N+3).fill(0);for(let e=0;e<t;e++)this.vertexTriangles[this.triangulation[e][0]]=e,this.vertexTriangles[this.triangulation[e][1]]=e,this.vertexTriangles[this.triangulation[e][2]]=e;for(let t of this.constraints){if(t.v1===t.v2)continue;const e=this.findIntersectingEdges(t,this.vertexTriangles);this.removeIntersectingEdges(t,e)}}findIntersectingEdges(t,e){const i=[],s=this.findStartingEdge(e,t);if(null===s)return i;i.push(s);let r=s.t1,o=s.t1Edge,a=r,n=!1;for(;!n;){a=r,r=this.triangulation[r][o];const e=this.points[t.v1].coords,s=this.points[t.v2].coords,h=this.points[this.triangulation[r][0]].coords,c=this.points[this.triangulation[r][1]].coords,u=this.points[this.triangulation[r][2]].coords;if(this.triangleContainsVertex(r,t.v2))n=!0;else if(this.triangulation[r][3]!==a&&Oe(e,s,h,c)){o=3;var l=new Ze(this.triangulation[r][0],this.triangulation[r][1],r,this.triangulation[r][3],o);i.push(l)}else if(this.triangulation[r][4]!==a&&Oe(e,s,c,u))o=4,l=new Ze(this.triangulation[r][1],this.triangulation[r][2],r,this.triangulation[r][4],o),i.push(l);else{if(this.triangulation[r][5]===a||!Oe(e,s,u,h)){console.warn("Failed to find final triangle, exiting early.");break}o=5,l=new Ze(this.triangulation[r][2],this.triangulation[r][0],r,this.triangulation[r][5],o),i.push(l)}}return i}findStartingEdge(t,e){let i,s,r,o=new Ze(-1,-1),a=e.v1,n=t[a],l=!1,h=null;for(this.visited.fill(!1);!h&&!l;){if(this.visited[n]=!0,this.triangleContainsConstraint(n,e))return null;if(h=this.edgeConstraintIntersectsTriangle(n,e),h)break;if(i=this.triangulation[n][3],s=this.triangulation[n][4],r=this.triangulation[n][5],-1!==i&&!this.visited[i]&&this.triangleContainsVertex(i,a))n=i;else if(-1!==s&&!this.visited[s]&&this.triangleContainsVertex(s,a))n=s;else{if(-1===r||this.visited[r]||!this.triangleContainsVertex(r,a)){l=!0;break}n=r}}if(h){const t=this.triangulation[n][this.edgeVertex1[h]],e=this.triangulation[n][this.edgeVertex2[h]],i=this.triangulation[n][h];return o=new Ze(t,e,n,i,h),o}return null}removeIntersectingEdges(t,e){let i,s=[],r=0;for(;e.length>0&&r<=e.length;){if(i=e.shift(),null==i)continue;let o=this.findQuadFromSharedEdge(i.t1,i.t1Edge);if(o)if(Oe(this.points[o.q4].coords,this.points[o.q3].coords,this.points[o.q1].coords,this.points[o.q2].coords)){this.swapQuadDiagonal(o,e,s,this.constraints);let i=new Ze(o.q3,o.q4,o.t1,o.t2,5);Oe(this.points[t.v1].coords,this.points[t.v2].coords,this.points[o.q3].coords,this.points[o.q4].coords)?e.push(i):(r=0,s.push(i))}else e.push(i);r++}s.length>0&&this.restoreConstrainedDelauneyTriangulation(t,s)}restoreConstrainedDelauneyTriangulation(t,e){let i=!0;for(;i;){i=!1;for(let s=0;s<e.length;s++){const r=e[s];if(r.equals(t))continue;let o=this.findQuadFromSharedEdge(r.t1,r.t1Edge);if(o&&this.swapTest(this.points[o.q1].coords,this.points[o.q2].coords,this.points[o.q3].coords,this.points[o.q4].coords)){this.swapQuadDiagonal(o,e,this.constraints,null);const t=o.q3,r=o.q4;e[s]=new Ze(t,r,o.t1,o.t2,5),i=!0}}}}discardTrianglesViolatingConstraints(){this.skipTriangle.fill(!0);let t=new Set;for(let e=0;e<this.constraints.length;e++){const i=this.constraints[e];t.add(Ge(i.v1,i.v2))}this.visited.fill(!1);let e,i,s,r,o,a,n=[];for(let l=0;l<this.triangleCount;l++)if(!this.visited[l]&&(e=this.triangulation[l][0],i=this.triangulation[l][1],s=this.triangulation[l][2],r=t.has(Ge(e,i)),o=t.has(Ge(i,s)),a=t.has(Ge(s,e)),r||o||a))for(this.skipTriangle[l]=!1,n=[],r||n.push(this.triangulation[l][3]),o||n.push(this.triangulation[l][4]),a||n.push(this.triangulation[l][5]);n.length>0;){const r=n.shift();-1===r||this.visited[r]||(this.skipTriangle[r]=!1,this.visited[r]=!0,e=this.triangulation[r][0],i=this.triangulation[r][1],s=this.triangulation[r][2],t.has(Ge(e,i))||n.push(this.triangulation[r][3]),t.has(Ge(i,s))||n.push(this.triangulation[r][4]),t.has(Ge(s,e))||n.push(this.triangulation[r][5]))}}triangleContainsConstraint(t,e){return!(t>=this.triangulation.length||this.triangulation[t][0]!==e.v1&&this.triangulation[t][1]!==e.v1&&this.triangulation[t][2]!==e.v1||this.triangulation[t][0]!==e.v2&&this.triangulation[t][1]!==e.v2&&this.triangulation[t][2]!==e.v2)}edgeConstraintIntersectsTriangle(t,e){const i=this.points[e.v1].coords,s=this.points[e.v2].coords,r=this.points[this.triangulation[t][0]].coords,o=this.points[this.triangulation[t][1]].coords,a=this.points[this.triangulation[t][2]].coords;return Oe(i,s,r,o)?3:Oe(i,s,o,a)?4:Oe(i,s,a,r)?5:null}findQuadFromSharedEdge(t,e){let i,s,r,o,a,n,l,h,c=this.triangulation[t][e],u=this.findSharedEdge(c,t);return u?(3===u?(s=this.triangulation[c][0],i=this.triangulation[c][1],r=this.triangulation[c][2]):4===u?(s=this.triangulation[c][1],i=this.triangulation[c][2],r=this.triangulation[c][0]):(s=this.triangulation[c][2],i=this.triangulation[c][0],r=this.triangulation[c][1]),o=this.triangulation[t][this.oppositePoint[e]],a=this.triangulation[t][this.previousEdge[e]],n=this.triangulation[t][this.nextEdge[e]],l=this.triangulation[c][this.nextEdge[u]],h=this.triangulation[c][this.previousEdge[u]],new ii(i,s,r,o,t,c,a,n,l,h)):null}swapQuadDiagonal(t,e,i,s){const r=t.t1,o=t.t2,a=t.t1R,n=t.t1L,l=t.t2R,h=t.t2L;this.triangulation[r][0]=t.q4,this.triangulation[r][1]=t.q1,this.triangulation[r][2]=t.q3,this.triangulation[o][0]=t.q4,this.triangulation[o][1]=t.q3,this.triangulation[o][2]=t.q2,this.triangulation[r][3]=n,this.triangulation[r][4]=h,this.triangulation[r][5]=o,this.triangulation[o][3]=r,this.triangulation[o][4]=l,this.triangulation[o][5]=a,this.updateAdjacency(h,o,r),this.updateAdjacency(a,r,o),this.updateEdgesAfterSwap(e,r,o,n,a,h,l),this.updateEdgesAfterSwap(i,r,o,n,a,h,l),this.updateEdgesAfterSwap(s,r,o,n,a,h,l),this.vertexTriangles[t.q1]=r,this.vertexTriangles[t.q2]=o}updateEdgesAfterSwap(t,e,i,s,r,o,a){if(t)for(let n of t)n.t1===e&&n.t2===r?(n.t1=i,n.t2=r,n.t1Edge=5):n.t1===e&&n.t2===s?n.t1Edge=3:n.t1===r&&n.t2===e?n.t2=i:n.t1===s&&n.t2===e||(n.t1===i&&n.t2===a?n.t1Edge=4:n.t1===i&&n.t2===o?(n.t1=e,n.t2=o,n.t1Edge=4):n.t1===a&&n.t2===i||n.t1===o&&n.t2===i&&(n.t2=e))}}function ri(t,i,s,r,o,a,n=!0){const l=new Ye,h=new Ye,c=new Array(t.vertexCount).fill(!1);for(let e=0;e<t.vertices.length;e++){var u=t.vertices[e];c[e]=Xe(u.position,i,s),(c[e]?l:h).addMappedVertex(u,e)}const d=t.vertices.length;for(let e=0;e<t.cutVertices.length;e++)u=t.cutVertices[e],c[e+d]=Xe(u.position,i,s),(c[e+d]?l:h).addMappedVertex(u,e+d);return oi(t,l,h,i,s,c,0),n&&oi(t,l,h,i,s,c,1),n&&function(t,i,s,r,o,a){t.weldCutFaceVertices();const n=s.clone().negate().normalize();if(t.cutVertices.length<3)return;const l=a?new ei(t.cutVertices,n):new si(t.cutVertices,t.constraints,n),h=l.triangulate();for(let a=0;a<t.cutVertices.length;a++){var c=t.cutVertices[a],u=l.points[a];const h=new e.Vector2(l.normalizationScaleFactor*u.coords.x*r.x+o.x,l.normalizationScaleFactor*u.coords.y*r.y+o.y),d=new Qe(c.position.clone(),n.clone(),h.clone()),p=new Qe(c.position.clone(),s.clone(),h.clone());t.cutVertices[a]=d,i.cutVertices[a]=p}let d=t.vertices.length,p=i.vertices.length;for(let e=0;e<h.length;e+=3)t.addTriangle(d+h[e],d+h[e+1],d+h[e+2],1),i.addTriangle(p+h[e],p+h[e+2],p+h[e+1],1)}(l,h,i,r,o,a),{topSlice:l,bottomSlice:h}}function oi(t,e,i,s,r,o,a){const n=t.triangles[a];let l,h,c;for(let u=0;u<n.length;u+=3)l=n[u],h=n[u+1],c=n[u+2],o[l]&&o[h]&&o[c]?e.addMappedTriangle(l,h,c,a):o[l]||o[h]||o[c]?o[h]&&o[c]&&!o[l]?ai(h,c,l,s,r,t,e,i,a,!0):o[c]&&o[l]&&!o[h]?ai(c,l,h,s,r,t,e,i,a,!0):o[l]&&o[h]&&!o[c]?ai(l,h,c,s,r,t,e,i,a,!0):o[h]||o[c]||!o[l]?o[c]||o[l]||!o[h]?o[l]||o[h]||!o[c]||ai(l,h,c,s,r,t,e,i,a,!1):ai(c,l,h,s,r,t,e,i,a,!1):ai(h,c,l,s,r,t,e,i,a,!1):i.addMappedTriangle(l,h,c,a)}function ai(t,i,s,r,o,a,n,l,h,c){let u=t<a.vertices.length?a.vertices[t]:a.cutVertices[t-a.vertices.length],d=i<a.vertices.length?a.vertices[i]:a.cutVertices[i-a.vertices.length],p=s<a.vertices.length?a.vertices[s]:a.cutVertices[s-a.vertices.length];const m=Ne(u.position,p.position,r,o),f=Ne(d.position,p.position,r,o);if(m&&f){const r=new e.Vector3(u.normal.x+m.s*(p.normal.x-u.normal.x),u.normal.y+m.s*(p.normal.y-u.normal.y),u.normal.z+m.s*(p.normal.z-u.normal.z)).normalize(),o=new e.Vector3(d.normal.x+f.s*(p.normal.x-d.normal.x),d.normal.y+f.s*(p.normal.y-d.normal.y),d.normal.z+f.s*(p.normal.z-d.normal.z)).normalize(),a=new e.Vector2(u.uv.x+m.s*(p.uv.x-u.uv.x),u.uv.y+m.s*(p.uv.y-u.uv.y)),g=new e.Vector2(d.uv.x+f.s*(p.uv.x-d.uv.x),d.uv.y+f.s*(p.uv.y-d.uv.y));n.addCutFaceVertex(m.x,r,a),n.addCutFaceVertex(f.x,o,g),l.addCutFaceVertex(m.x,r,a),l.addCutFaceVertex(f.x,o,g);const y=n.vertices.length-2,v=n.vertices.length-1,b=l.vertices.length-2,w=l.vertices.length-1;c?(n.addTriangle(v,y,n.indexMap[i],h),n.addTriangle(y,n.indexMap[t],n.indexMap[i],h),l.addTriangle(l.indexMap[s],b,w,h),n.constraints.push(new Ze(n.cutVertices.length-2,n.cutVertices.length-1)),l.constraints.push(new Ze(l.cutVertices.length-1,l.cutVertices.length-2))):(n.addTriangle(y,v,n.indexMap[s],h),l.addTriangle(l.indexMap[t],l.indexMap[i],b,h),l.addTriangle(l.indexMap[i],w,b,h),n.constraints.push(new Ze(n.cutVertices.length-1,n.cutVertices.length-2)),l.constraints.push(new Ze(l.cutVertices.length-2,l.cutVertices.length-1)))}}const ni={textureScale:new e.Vector2(1,1),textureOffset:new e.Vector2},li=new e.Vector3,hi=new e.Vector3,ci=new e.Vector3,ui=new e.Plane,di=new e.Plane;function pi(t){const e=new Je(t.vertexCount),i={},s=t.vertices.length,r=t.cutVertices.length,o=new Map;t.vertices.forEach(((t,i)=>{const s=He(t.position),r=o.get(s);void 0===r?o.set(s,i):e.union(r,i)}));for(let i=0;i<r;i++)e.union(t.vertexAdjacency[i],i+s);const a=t.triangles;for(let t=0;t<a.length;t++)for(let s=0;s<a[t].length;s+=3){const r=a[t][s],o=a[t][s+1],n=a[t][s+2];e.union(r,o),e.union(o,n);const l=e.find(r);i[l]||(i[l]=[[],[]]),i[l][t].push(r,o,n)}const n={},l=Array(t.vertexCount);for(let i=0;i<s;i++){const s=e.find(i);n[s]||(n[s]=new Ye),n[s].vertices.push(t.vertices[i]),l[i]=n[s].vertices.length-1}for(let i=0;i<r;i++){const r=e.find(i+s);n[r].cutVertices.push(t.cutVertices[i]),l[i+s]=n[r].vertices.length+n[r].cutVertices.length-1}for(const s of Object.keys(i)){let r=Number(s),o=e.parent[r];for(let e=0;e<t.triangles.length;e++)for(const t of i[r][e]){const i=l[t];n[o].triangles[e].push(i)}}return Object.values(n)}class mi{constructor(t){this.motor=t,this.tpos=new e.Vector3,this.tnormal=new e.Vector3,this.nDebris=0,this.maxDebris=1500,this.interneMat=this.motor.getMat("chrome"),this.tt=null}add(t,e=[]){let i=this,s=0;-1!==t.name.search("_debris_")&&(s=1e3),setTimeout((()=>{i.motor.addCollision({name:t.name,ignore:t.ignore}),t.addEventListener("collision",(t=>{let e=t.data;1===e.hit&&i.makeBreak(e.from,e.point,e.normal,e.impulse,e.v1)}))}),s)}makeBreak(t,i,s,r,o){let a=this.motor.byName(t);if(!a)return;if(!a.breakable)return;let n=a.breakOption;const l=void 0===n[4]||n[4];if(r<n[0])return;this.motor.removeCollision(t),this.motor.remove(t);const h=new e.Vector3;a.geometry.boundingBox.getSize(h);const c=h.length();let u=function(t,i,s,r,o,a){const n=[],l=t.matrixWorld.clone().invert(),h=t.position;i.applyMatrix4(l);const c=Ye.fromGeometry(t.geometry);let u=c.convex;li.addVectors(i,s),ui.setFromCoplanarPoints(i,h,li);const d=o+r;return function t(o,c,p,m){if(0===o.vertexCount)return;if(Math.random()<.05*m||m>d)return void n.push(o);let f=Math.PI,g=new e.Vector3;o.calculateBounds(),o.bounds.getCenter(g);let y=u;if(0===m)di.normal.copy(ui.normal),di.constant=ui.constant;else if(m<=r)f=(p-c)*(.2+.6*Math.random())+c,hi.copy(h).sub(i).applyAxisAngle(s,f).add(i),di.setFromCoplanarPoints(i,li,hi);else{let t=g.clone().applyMatrix4(l);f=(.5*(1&m)+.2*(2-Math.random()))*Math.PI,hi.copy(i).sub(t).applyAxisAngle(s,f).add(t),ci.copy(s).add(t),di.setFromCoplanarPoints(t,ci,hi)}const{topSlice:v,bottomSlice:b}=ri(o,di.normal,hi,ni.textureScale,ni.textureOffset,y,a);let w=v,x=b;y||(w=pi(v),x=pi(b)),w&&(w instanceof Array?w.length>0&&w.forEach((e=>{e.vertices.length>12&&t(e,c,f,m+1)})):t(w,c,f,m+1)),x&&(x instanceof Array?x.length>0&&x.forEach((e=>{e.vertices.length>12&&t(e,c,f,m+1)})):t(b,f,p,m+1))}(c,0,2*Math.PI,0),n}(a,this.tpos.fromArray(i),this.tnormal.fromArray(s),n[1],n[2],l),d=function(t,e,i,s=!0,r=0){const o=[];return t.map(((t,a)=>{o.push(t.toMesh(e,i,s,r))})),o}(u,a,this.interneMat,l,0);if(d.length<1)return;let p,m,f,g,y,v=[],b=d.length,w=0,x=[...a.ignore];for(;b--;)p=d[w],m=p.geometry.attributes.position.count,f=p.sizer/c,g={},y=[...n],y[3]=y[3]-1,f<.2&&(y[3]=0),p.sizer>.02&&m>6&&(this.nDebris++,g.name=t+"_debris_"+w,g.mass=a.mass*f,v.push(this.addDebris(p,y,g)),x.push(g.name)),w++;for(b=v.length;b--;)v[b].ignore=x;this.motor.add(v)}addDebris(t,e,i){let s=e[3]>0;return{...i,type:"convex",shape:t.geometry,material:t.material,pos:t.position.toArray(),quat:t.quaternion.toArray(),breakable:s,breakOption:e}}}const fi=new e.Vector3;new e.Vector3;const gi=new e.Vector3,yi=new e.Vector3,vi=new e.Vector3,bi=new e.Vector3,wi=new e.Vector3;class xi{constructor(t={},i){this.first=!0,this.debug=t.debug||!1,this.motor=i,this.name=t.name||"ppp",this.pMass=t.pMass||.01,this.vSize=t.vSize||.16,this.pSize=t.pSize||.02,this.particles=[],this.density=t.density||.01,this.smoothMulty=t.smoothMulty||1,this.smoothing=t.smoothing||.2,this.smoothing*=this.smoothMulty,this.speed=t.speed||.1,this.viscosity=t.viscosity||.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.maxDist=0,this.tv=new e.Vector3,this.tv2=new e.Vector3,t.mesh&&this.setMesh(t.mesh,t.crossEdge)}setMesh(t,e=!1){const i=[],s=[];this.mesh=t,this.geometry=t.geometry,this.geometry.getIndex();const r=this.geometry.getAttribute("position").array,o=w.getHash(this.geometry),a=w.getFaces(this.geometry),n=e?w.getConnectedFaces(a):null;let l,h,c,u,d,p;for(let t in o)l=o[t][0],h=3*l,fi.set(r[h],r[h+1],r[h+2]),this.mesh.localToWorld(fi),this.add(fi.toArray());for(let t=0;t<a.length;t++)c=a[t],u=this.getKey(o,c[0]),d=this.getKey(o,c[1]),p=this.getKey(o,c[2]),this.sameLink(i,u,d)||i.push([u,d]),this.sameLink(i,d,p)||i.push([d,p]),this.sameLink(i,p,u)||i.push([p,u]);if(this.connect(i),n){for(let t=0;t<n.length;t++)c=n[t],u=this.getKey(o,c[0]),d=this.getKey(o,c[1]),this.sameLink(i,u,d)||this.sameLink(s,u,d)||s.push([u,d]);this.connect(s,!0)}this.hash=o,this.mesh.position.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,phy.addDirect(this.mesh)}updateMesh(){if(!this.geometry)return;let t,e,i,s=this.hash,r=this.geometry.attributes.position.array,o=this.particles.length;for(;o--;)for(e=this.particles[o],i=s[o].length;i--;)t=3*s[o][i],r[t]=e.position.x,r[t+1]=e.position.y,r[t+2]=e.position.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.computeBoundingSphere()}add(t){let i=this.motor.add({instance:this.name,type:"particle",size:[this.vSize],pSize:this.pSize,pos:t,inertia:[0,0,0],mass:this.pMass,restitution:0,friction:.5,damping:[.2,.1],material:this.debug?"particle":"hide",shadow:!1,getVelocity:!0});this.first=!1,i.force=new e.Vector3,this.particles.push(i),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(t,e){let i,s,r,o=t.length,a=[],n=0;for(;o--;){if(i=t[o],this.name,i[0],this.name,i[1],s=this.particles[i[0]].position,r=this.particles[i[1]].position,n=this.tv.copy(s).distanceTo(r),e){if(n>this.maxDist)continue}else n>this.maxDist&&(this.maxDist=n);this.tv.copy(r).sub(s),a.push({type:"distance",helperSize:.03,b1:this.name+i[0],b2:this.name+i[1],limit:[.5*n,n],spring:[20,1],collision:!0,noPreProcess:!0,alway:!0})}this.motor.add(a)}getPosition(){let t,e,i=[],s=this.particles.length;for(;s--;)e=3*s,t=this.particles[s],i[e]=t.position.x,i[e+1]=t.position.y,i[e+2]=t.position.z;return i}getNeighbors(t,e){const i=this.particles.length,s=t.idx,r=this.smoothing*this.smoothing;let o=0;for(let a=0;a!==i;a++){const i=this.particles[a];o=this.distanceSq(i,t),s!==i.idx&&o<r&&e.push(i)}}distance(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,r=t.position.z-e.position.z;return Math.sqrt(i*i+s*s+r*r)}distanceSq(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,r=t.position.z-e.position.z;return i*i+s*s+r*r}w(t){const e=this.smoothing;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)}gradw(t,e){const i=t.length(),s=this.smoothing,r=945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-i*i,2);e.copy(t).multiplyScalar(r)}nablaw(t){const e=this.smoothing;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}getKey(t,e){let i;for(let s in t)if(i=t[s],-1!==i.indexOf(e))return s}sameLink(t,e,i){let s,r=t.length,o=!1;for(;r--;)s=t[r],e===i&&(o=!0),e===s[0]&&i===s[1]&&(o=!0),e===s[1]&&i===s[0]&&(o=!0);return o}update(){const t=[],e=this.particles.length,i=this.speed,s=this.eps;let r;for(let t=0;t!==e;t++){const e=this.particles[t];e.force.set(0,0,0);const s=this.neighbors[t];s.length=0,this.getNeighbors(e,s),s.push(this.particles[t]);let o=0;for(r=s.length;r--;){const t=this.w(this.distance(e,s[r]));o+=s[r].mass*t}this.densities[t]=o,this.pressures[t]=i*i*(this.densities[t]-this.density)}const o=gi,a=yi,n=vi,l=bi,h=wi;let c,u;for(let i=0;i!==e;i++){const e=this.particles[i];let r,d;o.set(0,0,0),a.set(0,0,0);const p=this.neighbors[i],m=p.length;for(let t=0;t!==m;t++)c=p[t],l.copy(e.position).sub(c.position),u=l.length(),r=-c.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+s)+this.pressures[t]/(this.densities[t]*this.densities[t]+s)),this.gradw(l,n),n.multiplyScalar(r),o.add(n),h.copy(c.velocity).sub(e.velocity),h.multiplyScalar(1/(1e-4+this.densities[i]*this.densities[t])*this.viscosity*c.mass),d=this.nablaw(u),h.multiplyScalar(d),a.add(h);a.multiplyScalar(e.mass),o.multiplyScalar(e.mass),e.force.add(a),e.force.add(o),t.push({name:e.name,force:e.force.toArray()})}this.motor.change(t),this.updateMesh()}}class Mi extends e.DataTextureLoader{constructor(t){super(t),this.type=e.HalfFloatType}parse(t){const i=function(t,e){switch(t){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(e||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(e||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(e||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(e||""))}},s=function(t,e,i){e=e||1024;let s=t.pos,r=-1,o=0,a="",n=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));for(;0>(r=n.indexOf("\n"))&&o<e&&s<t.byteLength;)a+=n,o+=n.length,s+=128,n+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));return-1<r&&(t.pos+=o+r+1,a+n.slice(0,r))},r=function(t,e,i,s){const r=t[e+3],o=Math.pow(2,r-128)/255;i[s+0]=t[e+0]*o,i[s+1]=t[e+1]*o,i[s+2]=t[e+2]*o,i[s+3]=1},o=function(t,i,s,r){const o=t[i+3],a=Math.pow(2,o-128)/255;s[r+0]=e.DataUtils.toHalfFloat(Math.min(t[i+0]*a,65504)),s[r+1]=e.DataUtils.toHalfFloat(Math.min(t[i+1]*a,65504)),s[r+2]=e.DataUtils.toHalfFloat(Math.min(t[i+2]*a,65504)),s[r+3]=e.DataUtils.toHalfFloat(1)},a=new Uint8Array(t);a.pos=0;const n=function(t){const e=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,o=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,n={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((t.pos>=t.byteLength||!(l=s(t)))&&i(1,"no header found"),(h=l.match(/^#\?(\S+)/))||i(3,"bad initial token"),n.valid|=1,n.programtype=h[1],n.string+=l+"\n";l=s(t),!1!==l;)if(n.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(e))&&(n.gamma=parseFloat(h[1])),(h=l.match(r))&&(n.exposure=parseFloat(h[1])),(h=l.match(o))&&(n.valid|=2,n.format=h[1]),(h=l.match(a))&&(n.valid|=4,n.height=parseInt(h[1],10),n.width=parseInt(h[2],10)),2&n.valid&&4&n.valid)break}else n.comments+=l+"\n";return 2&n.valid||i(3,"missing format specifier"),4&n.valid||i(3,"missing image size specifier"),n}(a),l=n.width,h=n.height,c=function(t,e,s){const r=e;if(r<8||r>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);r!==(t[2]<<8|t[3])&&i(3,"wrong scanline width");const o=new Uint8Array(4*e*s);o.length||i(4,"unable to allocate buffer space");let a=0,n=0;const l=4*r,h=new Uint8Array(4),c=new Uint8Array(l);let u=s;for(;u>0&&n<t.byteLength;){n+4>t.byteLength&&i(1),h[0]=t[n++],h[1]=t[n++],h[2]=t[n++],h[3]=t[n++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==r||i(3,"bad rgbe scanline format");let e,s=0;for(;s<l&&n<t.byteLength;){e=t[n++];const r=e>128;if(r&&(e-=128),(0===e||s+e>l)&&i(3,"bad scanline data"),r){const i=t[n++];for(let t=0;t<e;t++)c[s++]=i}else c.set(t.subarray(n,n+e),s),s+=e,n+=e}const d=r;for(let t=0;t<d;t++){let e=0;o[a]=c[t+e],e+=r,o[a+1]=c[t+e],e+=r,o[a+2]=c[t+e],e+=r,o[a+3]=c[t+e],a+=4}u--}return o}(a.subarray(a.pos),l,h);let u,d,p;switch(this.type){case e.FloatType:p=c.length/4;const t=new Float32Array(4*p);for(let e=0;e<p;e++)r(c,4*e,t,4*e);u=t,d=e.FloatType;break;case e.HalfFloatType:p=c.length/4;const i=new Uint16Array(4*p);for(let t=0;t<p;t++)o(c,4*t,i,4*t);u=i,d=e.HalfFloatType;break;default:throw new Error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:l,height:h,data:u,header:n.string,gamma:n.gamma,exposure:n.exposure,type:d}}setDataType(t){return this.type=t,this}load(t,i,s,r){return super.load(t,(function(t,s){switch(t.type){case e.FloatType:case e.HalfFloatType:t.colorSpace=e.LinearSRGBColorSpace,t.minFilter=e.LinearFilter,t.magFilter=e.LinearFilter,t.generateMipmaps=!1,t.flipY=!0}i&&i(t,s)}),s,r)}}
/*!
    fflate - fast JavaScript compression/decompression
    <https://101arrowz.github.io/fflate>
    Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
    version 0.6.9
    */var Si=function(t){return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};try{URL.revokeObjectURL(Si(""))}catch(t){Si=function(t){return"data:application/javascript;charset=UTF-8,"+encodeURI(t)}}var ki=Uint8Array,Ai=Uint16Array,Ti=Uint32Array,Pi=new ki([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ci=new ki([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),zi=new ki([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ri=function(t,e){for(var i=new Ai(31),s=0;s<31;++s)i[s]=e+=1<<t[s-1];var r=new Ti(i[30]);for(s=1;s<30;++s)for(var o=i[s];o<i[s+1];++o)r[o]=o-i[s]<<5|s;return[i,r]},Ei=Ri(Pi,2),_i=Ei[0],Li=Ei[1];_i[28]=258,Li[258]=28;for(var Vi=Ri(Ci,0)[0],Bi=new Ai(32768),Ii=0;Ii<32768;++Ii){var Fi=(43690&Ii)>>>1|(21845&Ii)<<1;Fi=(61680&(Fi=(52428&Fi)>>>2|(13107&Fi)<<2))>>>4|(3855&Fi)<<4,Bi[Ii]=((65280&Fi)>>>8|(255&Fi)<<8)>>>1}var Di=function(t,e,i){for(var s=t.length,r=0,o=new Ai(e);r<s;++r)++o[t[r]-1];var a,n=new Ai(e);for(r=0;r<e;++r)n[r]=n[r-1]+o[r-1]<<1;if(i){a=new Ai(1<<e);var l=15-e;for(r=0;r<s;++r)if(t[r])for(var h=r<<4|t[r],c=e-t[r],u=n[t[r]-1]++<<c,d=u|(1<<c)-1;u<=d;++u)a[Bi[u]>>>l]=h}else for(a=new Ai(s),r=0;r<s;++r)t[r]&&(a[r]=Bi[n[t[r]-1]++]>>>15-t[r]);return a},Oi=new ki(288);for(Ii=0;Ii<144;++Ii)Oi[Ii]=8;for(Ii=144;Ii<256;++Ii)Oi[Ii]=9;for(Ii=256;Ii<280;++Ii)Oi[Ii]=7;for(Ii=280;Ii<288;++Ii)Oi[Ii]=8;var Ni=new ki(32);for(Ii=0;Ii<32;++Ii)Ni[Ii]=5;var Ui=Di(Oi,9,1),qi=Di(Ni,5,1),ji=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},Gi=function(t,e,i){var s=e/8|0;return(t[s]|t[s+1]<<8)>>(7&e)&i},Wi=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(7&e)},Hi=function(t){return(t/8|0)+(7&t&&1)},Xi=function(t,e,i){var s=t.length;if(!s||i&&!i.l&&s<5)return e||new ki(0);var r=!e||i,o=!i||i.i;i||(i={}),e||(e=new ki(3*s));var a=function(t){var i=e.length;if(t>i){var s=new ki(Math.max(2*i,t));s.set(e),e=s}},n=i.f||0,l=i.p||0,h=i.b||0,c=i.l,u=i.d,d=i.m,p=i.n,m=8*s;do{if(!c){i.f=n=Gi(t,l,1);var f=Gi(t,l+1,3);if(l+=3,!f){var g=t[(P=Hi(l)+4)-4]|t[P-3]<<8,y=P+g;if(y>s){if(o)throw"unexpected EOF";break}r&&a(h+g),e.set(t.subarray(P,y),h),i.b=h+=g,i.p=l=8*y;continue}if(1==f)c=Ui,u=qi,d=9,p=5;else{if(2!=f)throw"invalid block type";var v=Gi(t,l,31)+257,b=Gi(t,l+10,15)+4,w=v+Gi(t,l+5,31)+1;l+=14;for(var x=new ki(w),M=new ki(19),S=0;S<b;++S)M[zi[S]]=Gi(t,l+3*S,7);l+=3*b;var k=ji(M),A=(1<<k)-1,T=Di(M,k,1);for(S=0;S<w;){var P,C=T[Gi(t,l,A)];if(l+=15&C,(P=C>>>4)<16)x[S++]=P;else{var z=0,R=0;for(16==P?(R=3+Gi(t,l,3),l+=2,z=x[S-1]):17==P?(R=3+Gi(t,l,7),l+=3):18==P&&(R=11+Gi(t,l,127),l+=7);R--;)x[S++]=z}}var E=x.subarray(0,v),_=x.subarray(v);d=ji(E),p=ji(_),c=Di(E,d,1),u=Di(_,p,1)}if(l>m){if(o)throw"unexpected EOF";break}}r&&a(h+131072);for(var L=(1<<d)-1,V=(1<<p)-1,B=l;;B=l){var I=(z=c[Wi(t,l)&L])>>>4;if((l+=15&z)>m){if(o)throw"unexpected EOF";break}if(!z)throw"invalid length/literal";if(I<256)e[h++]=I;else{if(256==I){B=l,c=null;break}var F=I-254;if(I>264){var D=Pi[S=I-257];F=Gi(t,l,(1<<D)-1)+_i[S],l+=D}var O=u[Wi(t,l)&V],N=O>>>4;if(!O)throw"invalid distance";l+=15&O;_=Vi[N];if(N>3){D=Ci[N];_+=Wi(t,l)&(1<<D)-1,l+=D}if(l>m){if(o)throw"unexpected EOF";break}r&&a(h+131072);for(var U=h+F;h<U;h+=4)e[h]=e[h-_],e[h+1]=e[h+1-_],e[h+2]=e[h+2-_],e[h+3]=e[h+3-_];h=U}}i.l=c,i.p=B,i.b=h,c&&(n=1,i.m=d,i.d=u,i.n=p)}while(!n);return h==e.length?e:function(t,e,i){(null==i||i>t.length)&&(i=t.length);var s=new(t instanceof Ai?Ai:t instanceof Ti?Ti:ki)(i-e);return s.set(t.subarray(e,i)),s}(e,0,h)},Qi=new ki(0);function Yi(t,e){return Xi((function(t){if(8!=(15&t[0])||t[0]>>>4>7||(t[0]<<8|t[1])%31)throw"invalid zlib data";if(32&t[1])throw"invalid zlib data: preset dictionaries not supported"}(t),t.subarray(2,-4)),e)}var Ji="undefined"!=typeof TextDecoder&&new TextDecoder;try{Ji.decode(Qi,{stream:!0})}catch(t){}class Zi extends e.DataTextureLoader{constructor(t){super(t),this.type=e.HalfFloatType}parse(t){const i=65536,s=14,r=65537,o=16384,a=Math.pow(2.7182818,2.2);const n={l:0,c:0,lc:0};function l(t,e,i,s,r){for(;i<t;)e=e<<8|q(s,r),i+=8;i-=t,n.l=e>>i&(1<<t)-1,n.c=e,n.lc=i}const h=new Array(59);function c(t,e,i,s,o,a){const c=e;let u=0,d=0;for(;s<=o;s++){if(c.value-e.value>i)return!1;l(6,u,d,t,c);const r=n.l;if(u=n.c,d=n.lc,a[s]=r,63==r){if(c.value-e.value>i)throw new Error("Something wrong with hufUnpackEncTable");l(8,u,d,t,c);let r=n.l+6;if(u=n.c,d=n.lc,s+r>o+1)throw new Error("Something wrong with hufUnpackEncTable");for(;r--;)a[s++]=0;s--}else if(r>=59){let t=r-59+2;if(s+t>o+1)throw new Error("Something wrong with hufUnpackEncTable");for(;t--;)a[s++]=0;s--}}!function(t){for(let t=0;t<=58;++t)h[t]=0;for(let e=0;e<r;++e)h[t[e]]+=1;let e=0;for(let t=58;t>0;--t){const i=e+h[t]>>1;h[t]=e,e=i}for(let e=0;e<r;++e){const i=t[e];i>0&&(t[e]=i|h[i]++<<6)}}(a)}function u(t){return 63&t}function d(t){return t>>6}const p={c:0,lc:0};function m(t,e,i,s){t=t<<8|q(i,s),e+=8,p.c=t,p.lc=e}const f={c:0,lc:0};function g(t,e,i,s,r,o,a,n,l){if(t==e){s<8&&(m(i,s,r,o),i=p.c,s=p.lc);let t=i>>(s-=8);if(t=new Uint8Array([t])[0],n.value+t>l)return!1;const e=a[n.value-1];for(;t-- >0;)a[n.value++]=e}else{if(!(n.value<l))return!1;a[n.value++]=t}f.c=i,f.lc=s}function y(t){return 65535&t}function v(t){const e=y(t);return e>32767?e-65536:e}const b={a:0,b:0};function w(t,e){const i=v(t),s=v(e),r=i+(1&s)+(s>>1),o=r,a=r-s;b.a=o,b.b=a}function x(t,e){const i=y(t),s=y(e),r=i-(s>>1)&65535,o=s+r-32768&65535;b.a=o,b.b=r}function M(t,e,i,s,r,o,a){const n=a<16384,l=i>r?r:i;let h,c,u=1;for(;u<=l;)u<<=1;for(u>>=1,h=u,u>>=1;u>=1;){c=0;const a=c+o*(r-h),l=o*u,d=o*h,p=s*u,m=s*h;let f,g,y,v;for(;c<=a;c+=d){let r=c;const o=c+s*(i-h);for(;r<=o;r+=m){const i=r+p,s=r+l,o=s+p;n?(w(t[r+e],t[s+e]),f=b.a,y=b.b,w(t[i+e],t[o+e]),g=b.a,v=b.b,w(f,g),t[r+e]=b.a,t[i+e]=b.b,w(y,v),t[s+e]=b.a,t[o+e]=b.b):(x(t[r+e],t[s+e]),f=b.a,y=b.b,x(t[i+e],t[o+e]),g=b.a,v=b.b,x(f,g),t[r+e]=b.a,t[i+e]=b.b,x(y,v),t[s+e]=b.a,t[o+e]=b.b)}if(i&u){const i=r+l;n?w(t[r+e],t[i+e]):x(t[r+e],t[i+e]),f=b.a,t[i+e]=b.b,t[r+e]=f}}if(r&u){let r=c;const o=c+s*(i-h);for(;r<=o;r+=m){const i=r+p;n?w(t[r+e],t[i+e]):x(t[r+e],t[i+e]),f=b.a,t[i+e]=b.b,t[r+e]=f}}h=u,u>>=1}return c}function S(t,e,i,a,n,l){const h=i.value,y=U(e,i),v=U(e,i);i.value+=4;const b=U(e,i);if(i.value+=4,y<0||y>=r||v<0||v>=r)throw new Error("Something wrong with HUF_ENCSIZE");const w=new Array(r),x=new Array(o);!function(t){for(let e=0;e<o;e++)t[e]={},t[e].len=0,t[e].lit=0,t[e].p=null}(x);if(c(t,i,a-(i.value-h),y,v,w),b>8*(a-(i.value-h)))throw new Error("Something wrong with hufUncompress");!function(t,e,i,r){for(;e<=i;e++){const i=d(t[e]),o=u(t[e]);if(i>>o)throw new Error("Invalid table entry");if(o>s){const t=r[i>>o-s];if(t.len)throw new Error("Invalid table entry");if(t.lit++,t.p){const e=t.p;t.p=new Array(t.lit);for(let i=0;i<t.lit-1;++i)t.p[i]=e[i]}else t.p=new Array(1);t.p[t.lit-1]=e}else if(o){let t=0;for(let a=1<<s-o;a>0;a--){const a=r[(i<<s-o)+t];if(a.len||a.p)throw new Error("Invalid table entry");a.len=o,a.lit=e,t++}}}}(w,y,v,x),function(t,e,i,r,o,a,n,l,h){let c=0,y=0;const v=n,b=Math.trunc(r.value+(o+7)/8);for(;r.value<b;)for(m(c,y,i,r),c=p.c,y=p.lc;y>=s;){const o=e[c>>y-s&16383];if(o.len)y-=o.len,g(o.lit,a,c,y,i,r,l,h,v),c=f.c,y=f.lc;else{if(!o.p)throw new Error("hufDecode issues");let e;for(e=0;e<o.lit;e++){const s=u(t[o.p[e]]);for(;y<s&&r.value<b;)m(c,y,i,r),c=p.c,y=p.lc;if(y>=s&&d(t[o.p[e]])==(c>>y-s&(1<<s)-1)){y-=s,g(o.p[e],a,c,y,i,r,l,h,v),c=f.c,y=f.lc;break}}if(e==o.lit)throw new Error("hufDecode issues")}}const w=8-o&7;for(c>>=w,y-=w;y>0;){const t=e[c<<s-y&16383];if(!t.len)throw new Error("hufDecode issues");y-=t.len,g(t.lit,a,c,y,i,r,l,h,v),c=f.c,y=f.lc}}(w,x,t,i,b,v,l,n,{value:0})}function k(t){for(let e=1;e<t.length;e++){const i=t[e-1]+t[e]-128;t[e]=i}}function A(t,e){let i=0,s=Math.floor((t.length+1)/2),r=0;const o=t.length-1;for(;!(r>o||(e[r++]=t[i++],r>o));)e[r++]=t[s++]}function T(t){let e=t.byteLength;const i=new Array;let s=0;const r=new DataView(t);for(;e>0;){const t=r.getInt8(s++);if(t<0){const o=-t;e-=o+1;for(let t=0;t<o;t++)i.push(r.getUint8(s++))}else{const o=t;e-=2;const a=r.getUint8(s++);for(let t=0;t<o+1;t++)i.push(a)}}return i}function P(t,e,i){let s,r=1;for(;r<64;)s=e[t.value],65280==s?r=64:s>>8==255?r+=255&s:(i[r]=s,r++),t.value++}function C(t,e){e[0]=X(t[0]),e[1]=X(t[1]),e[2]=X(t[5]),e[3]=X(t[6]),e[4]=X(t[14]),e[5]=X(t[15]),e[6]=X(t[27]),e[7]=X(t[28]),e[8]=X(t[2]),e[9]=X(t[4]),e[10]=X(t[7]),e[11]=X(t[13]),e[12]=X(t[16]),e[13]=X(t[26]),e[14]=X(t[29]),e[15]=X(t[42]),e[16]=X(t[3]),e[17]=X(t[8]),e[18]=X(t[12]),e[19]=X(t[17]),e[20]=X(t[25]),e[21]=X(t[30]),e[22]=X(t[41]),e[23]=X(t[43]),e[24]=X(t[9]),e[25]=X(t[11]),e[26]=X(t[18]),e[27]=X(t[24]),e[28]=X(t[31]),e[29]=X(t[40]),e[30]=X(t[44]),e[31]=X(t[53]),e[32]=X(t[10]),e[33]=X(t[19]),e[34]=X(t[23]),e[35]=X(t[32]),e[36]=X(t[39]),e[37]=X(t[45]),e[38]=X(t[52]),e[39]=X(t[54]),e[40]=X(t[20]),e[41]=X(t[22]),e[42]=X(t[33]),e[43]=X(t[38]),e[44]=X(t[46]),e[45]=X(t[51]),e[46]=X(t[55]),e[47]=X(t[60]),e[48]=X(t[21]),e[49]=X(t[34]),e[50]=X(t[37]),e[51]=X(t[47]),e[52]=X(t[50]),e[53]=X(t[56]),e[54]=X(t[59]),e[55]=X(t[61]),e[56]=X(t[35]),e[57]=X(t[36]),e[58]=X(t[48]),e[59]=X(t[49]),e[60]=X(t[57]),e[61]=X(t[58]),e[62]=X(t[62]),e[63]=X(t[63])}function z(t){const e=.5*Math.cos(.7853975),i=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),r=.5*Math.cos(3*3.14159/16),o=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),n=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),u=new Array(4);for(let d=0;d<8;++d){const p=8*d;l[0]=s*t[p+2],l[1]=a*t[p+2],l[2]=s*t[p+6],l[3]=a*t[p+6],h[0]=i*t[p+1]+r*t[p+3]+o*t[p+5]+n*t[p+7],h[1]=r*t[p+1]-n*t[p+3]-i*t[p+5]-o*t[p+7],h[2]=o*t[p+1]-i*t[p+3]+n*t[p+5]+r*t[p+7],h[3]=n*t[p+1]-o*t[p+3]+r*t[p+5]-i*t[p+7],c[0]=e*(t[p+0]+t[p+4]),c[3]=e*(t[p+0]-t[p+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],t[p+0]=u[0]+h[0],t[p+1]=u[1]+h[1],t[p+2]=u[2]+h[2],t[p+3]=u[3]+h[3],t[p+4]=u[3]-h[3],t[p+5]=u[2]-h[2],t[p+6]=u[1]-h[1],t[p+7]=u[0]-h[0]}for(let d=0;d<8;++d)l[0]=s*t[16+d],l[1]=a*t[16+d],l[2]=s*t[48+d],l[3]=a*t[48+d],h[0]=i*t[8+d]+r*t[24+d]+o*t[40+d]+n*t[56+d],h[1]=r*t[8+d]-n*t[24+d]-i*t[40+d]-o*t[56+d],h[2]=o*t[8+d]-i*t[24+d]+n*t[40+d]+r*t[56+d],h[3]=n*t[8+d]-o*t[24+d]+r*t[40+d]-i*t[56+d],c[0]=e*(t[d]+t[32+d]),c[3]=e*(t[d]-t[32+d]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],t[0+d]=u[0]+h[0],t[8+d]=u[1]+h[1],t[16+d]=u[2]+h[2],t[24+d]=u[3]+h[3],t[32+d]=u[3]-h[3],t[40+d]=u[2]-h[2],t[48+d]=u[1]-h[1],t[56+d]=u[0]-h[0]}function R(t){for(let e=0;e<64;++e){const i=t[0][e],s=t[1][e],r=t[2][e];t[0][e]=i+1.5747*r,t[1][e]=i-.1873*s-.4682*r,t[2][e]=i+1.8556*s}}function E(t,i,s){for(let r=0;r<64;++r)i[s+r]=e.DataUtils.toHalfFloat(_(t[r]))}function _(t){return t<=1?Math.sign(t)*Math.pow(Math.abs(t),2.2):Math.sign(t)*Math.pow(a,Math.abs(t)-1)}function L(t){return new DataView(t.array.buffer,t.offset.value,t.size)}function V(t){const e=t.viewer.buffer.slice(t.offset.value,t.offset.value+t.size),i=new Uint8Array(T(e)),s=new Uint8Array(i.length);return k(i),A(i,s),new DataView(s.buffer)}function B(t){const e=Yi(t.array.slice(t.offset.value,t.offset.value+t.size)),i=new Uint8Array(e.length);return k(e),A(e,i),new DataView(i.buffer)}function I(t){const e=t.viewer,s={value:t.offset.value},r=new Uint16Array(t.columns*t.lines*(t.inputChannels.length*t.type)),o=new Uint8Array(8192);let a=0;const n=new Array(t.inputChannels.length);for(let e=0,i=t.inputChannels.length;e<i;e++)n[e]={},n[e].start=a,n[e].end=n[e].start,n[e].nx=t.columns,n[e].ny=t.lines,n[e].size=t.type,a+=n[e].nx*n[e].ny*n[e].size;const l=Q(e,s),h=Q(e,s);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let t=0;t<h-l+1;t++)o[t+l]=j(e,s);const c=new Uint16Array(i),u=function(t,e){let s=0;for(let r=0;r<i;++r)(0==r||t[r>>3]&1<<(7&r))&&(e[s++]=r);const r=s-1;for(;s<i;)e[s++]=0;return r}(o,c),d=U(e,s);S(t.array,e,s,d,r,a);for(let e=0;e<t.inputChannels.length;++e){const t=n[e];for(let i=0;i<n[e].size;++i)M(r,t.start+i,t.nx,t.size,t.ny,t.nx*t.size,u)}!function(t,e,i){for(let s=0;s<i;++s)e[s]=t[e[s]]}(c,r,a);let p=0;const m=new Uint8Array(r.buffer.byteLength);for(let e=0;e<t.lines;e++)for(let e=0;e<t.inputChannels.length;e++){const t=n[e],i=t.nx*t.size,s=new Uint8Array(r.buffer,2*t.end,2*i);m.set(s,p),p+=2*i,t.end+=i}return new DataView(m.buffer)}function F(t){const e=Yi(t.array.slice(t.offset.value,t.offset.value+t.size)),i=t.inputChannels.length*t.lines*t.columns*t.totalBytes,s=new ArrayBuffer(i),r=new DataView(s);let o=0,a=0;const n=new Array(4);for(let i=0;i<t.lines;i++)for(let i=0;i<t.inputChannels.length;i++){let s=0;switch(t.inputChannels[i].pixelType){case 1:n[0]=o,n[1]=n[0]+t.columns,o=n[1]+t.columns;for(let i=0;i<t.columns;++i){s+=e[n[0]++]<<8|e[n[1]++],r.setUint16(a,s,!0),a+=2}break;case 2:n[0]=o,n[1]=n[0]+t.columns,n[2]=n[1]+t.columns,o=n[2]+t.columns;for(let i=0;i<t.columns;++i){s+=e[n[0]++]<<24|e[n[1]++]<<16|e[n[2]++]<<8,r.setUint32(a,s,!0),a+=4}}}return r}function D(t){const e=t.viewer,i={value:t.offset.value},s=new Uint8Array(t.columns*t.lines*(t.inputChannels.length*t.type*2)),r={version:G(e,i),unknownUncompressedSize:G(e,i),unknownCompressedSize:G(e,i),acCompressedSize:G(e,i),dcCompressedSize:G(e,i),rleCompressedSize:G(e,i),rleUncompressedSize:G(e,i),rleRawSize:G(e,i),totalAcUncompressedCount:G(e,i),totalDcUncompressedCount:G(e,i),acCompression:G(e,i)};if(r.version<2)throw new Error("EXRLoader.parse: "+rt.compression+" version "+r.version+" is unsupported");const o=new Array;let a=Q(e,i)-2;for(;a>0;){const t=O(e.buffer,i),s=j(e,i),r=s>>2&3,n=new Int8Array([(s>>4)-1])[0],l=j(e,i);o.push({name:t,index:n,type:l,compression:r}),a-=t.length+3}const n=rt.channels,l=new Array(t.inputChannels.length);for(let e=0;e<t.inputChannels.length;++e){const i=l[e]={},s=n[e];i.name=s.name,i.compression=0,i.decoded=!1,i.type=s.pixelType,i.pLinear=s.pLinear,i.width=t.columns,i.height=t.lines}const h={idx:new Array(3)};for(let e=0;e<t.inputChannels.length;++e){const t=l[e];for(let i=0;i<o.length;++i){const s=o[i];t.name==s.name&&(t.compression=s.compression,s.index>=0&&(h.idx[s.index]=e),t.offset=e)}}let c,u,d;if(r.acCompressedSize>0)switch(r.acCompression){case 0:c=new Uint16Array(r.totalAcUncompressedCount),S(t.array,e,i,r.acCompressedSize,c,r.totalAcUncompressedCount);break;case 1:const s=Yi(t.array.slice(i.value,i.value+r.totalAcUncompressedCount));c=new Uint16Array(s.buffer),i.value+=r.totalAcUncompressedCount}if(r.dcCompressedSize>0){const e={array:t.array,offset:i,size:r.dcCompressedSize};u=new Uint16Array(B(e).buffer),i.value+=r.dcCompressedSize}if(r.rleRawSize>0){d=T(Yi(t.array.slice(i.value,i.value+r.rleCompressedSize)).buffer),i.value+=r.rleCompressedSize}let p=0;const m=new Array(l.length);for(let t=0;t<m.length;++t)m[t]=new Array;for(let e=0;e<t.lines;++e)for(let e=0;e<l.length;++e)m[e].push(p),p+=l[e].width*t.type*2;!function(t,e,i,s,r,o){let a=new DataView(o.buffer);const n=i[t.idx[0]].width,l=i[t.idx[0]].height,h=Math.floor(n/8),c=Math.ceil(n/8),u=Math.ceil(l/8),d=n-8*(c-1),p=l-8*(u-1),m={value:0},f=new Array(3),g=new Array(3),y=new Array(3),v=new Array(3),b=new Array(3);for(let i=0;i<3;++i)b[i]=e[t.idx[i]],f[i]=i<1?0:f[i-1]+c*u,g[i]=new Float32Array(64),y[i]=new Uint16Array(64),v[i]=new Uint16Array(64*c);for(let e=0;e<u;++e){let o=8;e==u-1&&(o=p);let n=8;for(let t=0;t<c;++t){t==c-1&&(n=d);for(let t=0;t<3;++t)y[t].fill(0),y[t][0]=r[f[t]++],P(m,s,y[t]),C(y[t],g[t]),z(g[t]);R(g);for(let e=0;e<3;++e)E(g[e],v[e],64*t)}let l=0;for(let s=0;s<3;++s){const r=i[t.idx[s]].type;for(let t=8*e;t<8*e+o;++t){l=b[s][t];for(let e=0;e<h;++e){const i=64*e+8*(7&t);a.setUint16(l+0*r,v[s][i+0],!0),a.setUint16(l+2*r,v[s][i+1],!0),a.setUint16(l+4*r,v[s][i+2],!0),a.setUint16(l+6*r,v[s][i+3],!0),a.setUint16(l+8*r,v[s][i+4],!0),a.setUint16(l+10*r,v[s][i+5],!0),a.setUint16(l+12*r,v[s][i+6],!0),a.setUint16(l+14*r,v[s][i+7],!0),l+=16*r}}if(h!=c)for(let t=8*e;t<8*e+o;++t){const e=b[s][t]+8*h*2*r,i=64*h+8*(7&t);for(let t=0;t<n;++t)a.setUint16(e+2*t*r,v[s][i+t],!0)}}}const w=new Uint16Array(n);a=new DataView(o.buffer);for(let e=0;e<3;++e){i[t.idx[e]].decoded=!0;const s=i[t.idx[e]].type;if(2==i[e].type)for(let t=0;t<l;++t){const i=b[e][t];for(let t=0;t<n;++t)w[t]=a.getUint16(i+2*t*s,!0);for(let t=0;t<n;++t)a.setFloat32(i+2*t*s,X(w[t]),!0)}}}(h,m,l,c,u,s);for(let e=0;e<l.length;++e){const i=l[e];if(!i.decoded){if(2!==i.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let r=0,o=0;for(let a=0;a<t.lines;++a){let t=m[e][r];for(let e=0;e<i.width;++e){for(let e=0;e<2*i.type;++e)s[t++]=d[o+e*i.width*i.height];o++}r++}}}}return new DataView(s.buffer)}function O(t,e){const i=new Uint8Array(t);let s=0;for(;0!=i[e.value+s];)s+=1;const r=(new TextDecoder).decode(i.slice(e.value,e.value+s));return e.value=e.value+s+1,r}function N(t,e){const i=t.getInt32(e.value,!0);return e.value=e.value+4,i}function U(t,e){const i=t.getUint32(e.value,!0);return e.value=e.value+4,i}function q(t,e){const i=t[e.value];return e.value=e.value+1,i}function j(t,e){const i=t.getUint8(e.value);return e.value=e.value+1,i}const G=function(t,e){let i;return i="getBigInt64"in DataView.prototype?Number(t.getBigInt64(e.value,!0)):t.getUint32(e.value+4,!0)+Number(t.getUint32(e.value,!0)<<32),e.value+=8,i};function W(t,e){const i=t.getFloat32(e.value,!0);return e.value+=4,i}function H(t,i){return e.DataUtils.toHalfFloat(W(t,i))}function X(t){const e=(31744&t)>>10,i=1023&t;return(t>>15?-1:1)*(e?31===e?i?NaN:1/0:Math.pow(2,e-15)*(1+i/1024):i/1024*6103515625e-14)}function Q(t,e){const i=t.getUint16(e.value,!0);return e.value+=2,i}function Y(t,e){return X(Q(t,e))}function J(t,e,i,s,r){return"string"===s||"stringvector"===s||"iccProfile"===s?function(t,e,i){const s=(new TextDecoder).decode(new Uint8Array(t).slice(e.value,e.value+i));return e.value=e.value+i,s}(e,i,r):"chlist"===s?function(t,e,i,s){const r=i.value,o=[];for(;i.value<r+s-1;){const s=O(e,i),r=N(t,i),a=j(t,i);i.value+=3;const n=N(t,i),l=N(t,i);o.push({name:s,pixelType:r,pLinear:a,xSampling:n,ySampling:l})}return i.value+=1,o}(t,e,i,r):"chromaticities"===s?function(t,e){return{redX:W(t,e),redY:W(t,e),greenX:W(t,e),greenY:W(t,e),blueX:W(t,e),blueY:W(t,e),whiteX:W(t,e),whiteY:W(t,e)}}(t,i):"compression"===s?function(t,e){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][j(t,e)]}(t,i):"box2i"===s?function(t,e){return{xMin:N(t,e),yMin:N(t,e),xMax:N(t,e),yMax:N(t,e)}}(t,i):"envmap"===s?function(t,e){return["ENVMAP_LATLONG","ENVMAP_CUBE"][j(t,e)]}(t,i):"tiledesc"===s?function(t,e){const i=U(t,e),s=U(t,e),r=j(t,e);return{xSize:i,ySize:s,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&r],roundingMode:["ROUND_DOWN","ROUND_UP"][r>>4]}}(t,i):"lineOrder"===s?function(t,e){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][j(t,e)]}(t,i):"float"===s?W(t,i):"v2f"===s?function(t,e){return[W(t,e),W(t,e)]}(t,i):"v3f"===s?function(t,e){return[W(t,e),W(t,e),W(t,e)]}(t,i):"int"===s?N(t,i):"rational"===s?function(t,e){return[N(t,e),U(t,e)]}(t,i):"timecode"===s?function(t,e){return[U(t,e),U(t,e)]}(t,i):"preview"===s?(i.value+=r,"skipped"):void(i.value+=r)}function Z(t,e,i){let s=0;switch(t.levelMode){case"ONE_LEVEL":s=1;break;case"MIPMAP_LEVELS":s=function(t,e){const i=Math.log2(t);return"ROUND_DOWN"==e?Math.floor(i):Math.ceil(i)}(Math.max(e,i),t.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return s}function K(t,e,i,s){const r=new Array(t);for(let o=0;o<t;o++){const t=1<<o;let a=e/t|0;"ROUND_UP"==s&&a*t<e&&(a+=1);const n=Math.max(a,1);r[o]=(n+i-1)/i|0}return r}function $(){const t=this,e=t.offset,i={value:0};for(let s=0;s<t.tileCount;s++){const s=N(t.viewer,e),r=N(t.viewer,e);e.value+=8,t.size=U(t.viewer,e);const o=s*t.blockWidth,a=r*t.blockHeight;t.columns=o+t.blockWidth>t.width?t.width-o:t.blockWidth,t.lines=a+t.blockHeight>t.height?t.height-a:t.blockHeight;const n=t.columns*t.totalBytes,l=t.size<t.lines*n?t.uncompress(t):L(t);e.value+=t.size;for(let e=0;e<t.lines;e++){const s=e*t.columns*t.totalBytes;for(let r=0;r<t.inputChannels.length;r++){const n=rt.channels[r].name,h=t.channelByteOffsets[n]*t.columns,c=t.decodeChannels[n];if(void 0===c)continue;i.value=s+h;const u=(t.height-(1+a+e))*t.outLineWidth;for(let e=0;e<t.columns;e++){const s=u+(e+o)*t.outputChannels+c;t.byteArray[s]=t.getter(l,i)}}}}}function tt(){const t=this,e=t.offset,i={value:0};for(let s=0;s<t.height/t.blockHeight;s++){const r=N(t.viewer,e)-rt.dataWindow.yMin;t.size=U(t.viewer,e),t.lines=r+t.blockHeight>t.height?t.height-r:t.blockHeight;const o=t.columns*t.totalBytes,a=t.size<t.lines*o?t.uncompress(t):L(t);e.value+=t.size;for(let e=0;e<t.blockHeight;e++){const r=s*t.blockHeight,n=e+t.scanOrder(r);if(n>=t.height)continue;const l=e*o,h=(t.height-1-n)*t.outLineWidth;for(let e=0;e<t.inputChannels.length;e++){const s=rt.channels[e].name,r=t.channelByteOffsets[s]*t.columns,o=t.decodeChannels[s];if(void 0!==o){i.value=l+r;for(let e=0;e<t.columns;e++){const s=h+e*t.outputChannels+o;t.byteArray[s]=t.getter(a,i)}}}}}}const et={value:0},it=new DataView(t),st=new Uint8Array(t),rt=function(t,e,i){const s={};if(20000630!=t.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");s.version=t.getUint8(4);const r=t.getUint8(5);s.spec={singleTile:!!(2&r),longName:!!(4&r),deepFormat:!!(8&r),multiPart:!!(16&r)},i.value=8;let o=!0;for(;o;){const r=O(e,i);if(0==r)o=!1;else{const o=O(e,i),a=J(t,e,i,o,U(t,i));void 0===a?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${o}'.`):s[r]=a}}if(-7&r)throw console.error("THREE.EXRHeader:",s),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return s}(it,t,et),ot=function(t,i,s,r,o){const a={size:0,viewer:i,array:s,offset:r,width:t.dataWindow.xMax-t.dataWindow.xMin+1,height:t.dataWindow.yMax-t.dataWindow.yMin+1,inputChannels:t.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:e.LinearSRGBColorSpace};switch(t.compression){case"NO_COMPRESSION":a.blockHeight=1,a.uncompress=L;break;case"RLE_COMPRESSION":a.blockHeight=1,a.uncompress=V;break;case"ZIPS_COMPRESSION":a.blockHeight=1,a.uncompress=B;break;case"ZIP_COMPRESSION":a.blockHeight=16,a.uncompress=B;break;case"PIZ_COMPRESSION":a.blockHeight=32,a.uncompress=I;break;case"PXR24_COMPRESSION":a.blockHeight=16,a.uncompress=F;break;case"DWAA_COMPRESSION":a.blockHeight=32,a.uncompress=D;break;case"DWAB_COMPRESSION":a.blockHeight=256,a.uncompress=D;break;default:throw new Error("EXRLoader.parse: "+t.compression+" is unsupported")}const n={};for(const e of t.channels)switch(e.name){case"Y":case"R":case"G":case"B":case"A":n[e.name]=!0,a.type=e.pixelType}let l=!1;if(n.R&&n.G&&n.B)l=!n.A,a.outputChannels=4,a.decodeChannels={R:0,G:1,B:2,A:3};else{if(!n.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");a.outputChannels=1,a.decodeChannels={Y:0}}if(1==a.type)switch(o){case e.FloatType:a.getter=Y;break;case e.HalfFloatType:a.getter=Q}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+t.compression+".");switch(o){case e.FloatType:a.getter=W;break;case e.HalfFloatType:a.getter=H}}a.columns=a.width;const h=a.width*a.height*a.outputChannels;switch(o){case e.FloatType:a.byteArray=new Float32Array(h),l&&a.byteArray.fill(1,0,h);break;case e.HalfFloatType:a.byteArray=new Uint16Array(h),l&&a.byteArray.fill(15360,0,h);break;default:console.error("THREE.EXRLoader: unsupported type: ",o)}let c=0;for(const e of t.channels)void 0!==a.decodeChannels[e.name]&&(a.channelByteOffsets[e.name]=c),c+=2*e.pixelType;if(a.totalBytes=c,a.outLineWidth=a.width*a.outputChannels,"INCREASING_Y"===t.lineOrder?a.scanOrder=t=>t:a.scanOrder=t=>a.height-1-t,4==a.outputChannels?(a.format=e.RGBAFormat,a.colorSpace=e.LinearSRGBColorSpace):(a.format=e.RedFormat,a.colorSpace=e.NoColorSpace),t.spec.singleTile){a.blockHeight=t.tiles.ySize,a.blockWidth=t.tiles.xSize;const e=Z(t.tiles,a.width,a.height),s=K(e,a.width,t.tiles.xSize,t.tiles.roundingMode),o=K(e,a.height,t.tiles.ySize,t.tiles.roundingMode);a.tileCount=s[0]*o[0];for(let t=0;t<e;t++)for(let e=0;e<o[t];e++)for(let e=0;e<s[t];e++)G(i,r);a.decode=$.bind(a)}else{a.blockWidth=a.width;const t=Math.ceil(a.height/a.blockHeight);for(let e=0;e<t;e++)G(i,r);a.decode=tt.bind(a)}return a}(rt,it,st,et,this.type);return ot.decode(),{header:rt,width:ot.width,height:ot.height,data:ot.byteArray,format:ot.format,colorSpace:ot.colorSpace,type:this.type}}setDataType(t){return this.type=t,this}load(t,i,s,r){return super.load(t,(function(t,s){t.colorSpace=s.colorSpace,t.minFilter=e.LinearFilter,t.magFilter=e.LinearFilter,t.generateMipmaps=!1,t.flipY=!1,i&&i(t,s)}),s,r)}}const Ki={sunPosition:new e.Vector3(.27,1,.5),sunTop:new e.Vector3(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new e.Color(16777209).multiplyScalar(1),skyColor:new e.Color(4348022),fogColor:new e.Color(11253184),groundColor:new e.Color(8421504),sunColor:new e.Color(16777215).multiplyScalar(3)},$i={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:Ki.sunPosition},sunTop:{value:Ki.sunTop},noiseMap:{value:Ki.noiseMap},mixRatio:{value:Ki.mixRatio},cloud_size:{value:Ki.cloud_size},cloud_covr:{value:Ki.cloud_covr},cloud_dens:{value:Ki.cloud_dens},cloud_dist:{value:Ki.cloud_dist},nightLuminosity:{value:Ki.nightLuminosity},haze:{value:Ki.haze},saturation:{value:Ki.saturation},SAMPLE:{value:Ki.SAMPLE},STEP:{value:Ki.STEP},fogy:{value:Ki.fogy},t:{value:1},fogColor:{value:Ki.fogColor},groundColor:{value:Ki.groundColor},cloudColor:{value:Ki.cloudColor},skyColor:{value:Ki.skyColor},sunColor:{value:Ki.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},ts=Math.PI/180;class es{constructor(t={}){this.mainScene=t.scene,this.renderer=t.renderer,this.usePrem=void 0!==t.usePmrem&&t.usePmrem,this.useBackground=void 0===t.useBackground||t.useBackground,this.envBlur=void 0!==t.envBlur?t.envBlur:0,this.callback=t.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new e.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader()),t.cube&&this.initCubeEnv(t),t.url&&this.load(t.url)}initCubeEnv(t={}){this.isCubeEnv=!0,this._quality=t.quality||1,this.scene=new e.Scene,t.color&&(this.scene.background=new e.Color(t.color)),this.target=new e.WebGLCubeRenderTarget(256*this._quality,{minFilter:e.LinearFilter,type:e.HalfFloatType,colorSpace:e.SRGBColorSpace,anisotropy:1}),this.camera=new e.CubeCamera(t.near||.1,t.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let t=new e.IcosahedronGeometry(20,1);const i=new e.ShaderMaterial($i);this.sky=new e.Mesh(t,i),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return Ki}setSkyOtion(t){if(!this.isSky)return;let e=this.sky.material.uniforms;for(let i in t)e[i]&&(e[i].value=t[i]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const t=this.renderer,i=t.toneMapping;t.toneMapping=e.NoToneMapping,this.camera.update(t,this.scene),t.toneMapping=i}load(t){switch(this.name=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),this.type=t.substring(t.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new Mi).load(t,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new Zi).load(t,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let t;switch(this.type){case"hdr":case"exr":t=this.loader,t.mapping=e.EquirectangularReflectionMapping;break;case"jpg":t=this.loader.renderTarget.texture,t.mapping=e.EquirectangularReflectionMapping}this.usePrem&&(t=this.pmremGenerator.fromEquirectangular(t).texture,this.pmremGenerator.dispose()),t.needsUpdate=!0;const i=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(i.background=t),this.envBlur&&(i.backgroundBlurriness=this.envBlur),i.environment=t,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(t){this.mainScene.environmentIntensity=t}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(t){this.mainScene.backgroundIntensity=t}get blur(){return this.mainScene.backgroundBlurriness}set blur(t){this.mainScene.backgroundBlurriness=t}rotate(t=0,e=0,i=0){0!==t&&(t*=ts),0!==e&&(e*=ts),0!==i&&(i*=ts),this.mainScene.environmentRotation.set(t,e,i),this.mainScene.backgroundRotation.set(t,e,i)}}class is{constructor(t={},e){this.motor=e,this.utils=this.motor.utils,this.id=0,this.type="autoRagdoll",this.name=t.name||this.type+this.id++;let i=this.utils.byName(this.name);i&&this.utils.remove(i),this._mode=t.mode||"follow",this._size=t.size||1,this._debug=t.debug||!1;const s=Zt(t.model);let r;s.scale.set(1,1,1).multiplyScalar(this._size),t.pos&&s.position.fromArray(t.pos),s.raycast=function(){},s.name=this.name,s.traverse((e=>{e.isMesh&&(e.frustumCulled=!1),e.isSkinnedMesh&&(e.raycast=function(){},e.frustumCulled=!1,e.matrixAutoUpdate=!1,e.receiveShadow=!0,e.castShadow=!0,t.material&&(e.material=t.material),e.skeleton.resetScalling(),r=e.skeleton.bones)}));let o=t.mass||null;return this.skeletonBody=new Jt(this.motor,s.name,s,r,o,t.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),this.model=s,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(t){this._size=t,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(t){this._debug=t,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(t){this._mode=t,this.skeletonBody.setMode(this._mode)}}class ss extends e.LineSegments{constructor(t){super(),this.rayCount=0,this.ray=[],this.motor=t,this.maxVertices=1e4,this.currentVertex=0,this.geometry=new e.BufferGeometry,this.geometry.setAttribute("position",new e.Float32BufferAttribute(3*this.maxVertices,3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute(3*this.maxVertices,3)),this.positions=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material=new e.LineBasicMaterial({vertexColors:!0,toneMapped:!1,depthTest:!1,depthWrite:!1}),this.material.transparent=!0,this.renderOrder=3e4,this.frustumCulled=!1}DrawRay(t,i,s){s=new e.Color(s);let r=this.currentVertex,o=3*r;this.positions[o]=t.x,this.positions[o+1]=t.y,this.positions[o+2]=t.z,this.colors[o]=s.r,this.colors[o+1]=s.g,this.colors[o+2]=s.b,r++,o=3*r,this.positions[o]=t.x+i.x,this.positions[o+1]=t.y+i.y,this.positions[o+2]=t.z+i.z,this.colors[o]=s.r,this.colors[o+1]=s.g,this.colors[o+2]=s.b,this.currentVertex+=2}collapseBuffer(){let t=this.maxVertices,e=this.currentVertex,i=0;for(;t>=e;)i=3*t,this.positions[i]=0,this.positions[i+1]=0,this.positions[i+2]=0,this.colors[i]=0,this.colors[i+1]=0,this.colors[i+2]=0,t--}insertLine(t,e,i){let s=this.currentVertex,r=3*s;this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,s++,r=3*s,this.positions[r]=e.x,this.positions[r+1]=e.y,this.positions[r+2]=e.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,this.currentVertex+=2}draw(){this.collapseBuffer(),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.currentVertex=0}dispose(){this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}const rs=Math.PI/180,os=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)],as=new e.Vector3,ns=new e.Vector3,ls=new e.Vector3,hs=new e.Vector3,cs=[],us=[],ds=new e.Vector3,ps=new e.Vector3,ms=new e.Vector3;new e.Matrix4;class fs{constructor(t={},i){this.motor=i,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=t.name||"car",this.mass=t.mass||1e3,this.size=t.size||[1.5,.7,3.8],this.pos=t.pos||[0,4,0],this.rot=t.rot||[0,0,0],this.friction=t.friction||.2,this.restitution=t.restitution||.3,this.massCenter=t.massCenter||[0,0,0],this.driveWheel=t.driveWheel||null;let s=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];t.shapeMesh&&(s=[{type:"convex",shape:t.shapeMesh.geometry,pos:t.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:s,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:t.bodyMesh||null,meshPos:t.meshPos||[0,-1.1,0],material:t.material,damping:[.05,.05],debug:!1}),this.body.inertia=new e.Vector3(1.416666865348816,1.666666865348816,.416666716337204),this.vehicle=new gs({chassis:this.body},this.motor);let r=t.wheelPosition||[.61,0,1.2];const o=[new e.Vector3(-r[0],r[1],-r[2]),new e.Vector3(r[0],r[1],-r[2]),new e.Vector3(-r[0],r[1],r[2]),new e.Vector3(r[0],r[1],r[2])],a={radius:t.wheelRadius||.31,directionLocal:new e.Vector3(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new e.Vector3(1,0,0),chassisConnectionPointLocal:new e.Vector3(1,1,0)};let n,l,h;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),o.forEach((t=>{a.chassisConnectionPointLocal.copy(t),this.vehicle.addWheel(a)}));let c=this.motor.getMat("debug");if(t.wheelMesh?(l=t.wheelMesh,h=t.wheelMesh2?t.wheelMesh2:null,t.material&&(c=t.material||c,l.material=c,h&&(h.material=c))):(n=new e.CylinderGeometry(a.radius,a.radius,t.wheelDepth||.2),n.rotateZ(.5*Math.PI),l=new e.Mesh(n,c),h=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[h||l.clone(),l,h?h.clone():l.clone(),l.clone()];let t=this.vehicle.wheelMeshes.length,e=0;for(;t--;)this.body.add(this.vehicle.wheelMeshes[e++])}else m.matrixAutoUpdate=!1,h&&(h.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(h||m.clone()),this.motor.add(m),this.motor.add(h?h.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let t=this.motor.getDelta();this.motor.getAzimut();let e=this.motor.getKey();this.tmp.forwardForce=e[1],this.tmp.steerDirection=-1*e[0],this.tmp.brakeForce=1===e[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let i=Math.abs(this.vehicle.currentVehicleSpeedKmHour);i=Math.min(i,this.maxSpeed),this.maxSpeed;const s=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(s,0),this.vehicle.applyEngineForce(s,1),this.vehicle.applyEngineForce(s,2),this.vehicle.applyEngineForce(s,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(t),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*rs)}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.vehicle&&this.vehicle.setWheels(t,this.extra[t])}})}}class gs{constructor(t,e){this.motor=e,this.chassisBody=t.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:0,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:2,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(t={}){let e=new bs(t,this.motor),i=this.wheelInfos.length-1;e.chassisBody=this.chassisBody;let s=e.suspensionRestLength+e.radius;return e.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+i,begin:e.chassisConnectionPointLocal.toArray(),end:[e.chassisConnectionPointLocal.x,-s,e.chassisConnectionPointLocal.z],callback:function(t){e.castRay(t)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(e),i}setWheels(t,e){let i,s=this.wheelInfos.length;for(;s--;)i=this.wheelInfos[s],i[t]&&(i[t]=e)}setSteeringValue(t,e){this.wheelInfos[e].steering=t}applyEngineForce(t,e){this.wheelInfos[e].engineForce=t}setBrake(t,e){this.wheelInfos[e].brake=t}getVehicleAxisWorld(t,i){return i.set(0===t?1:0,1===t?1:0,2===t?1:0),_s(i,As(this.chassisBody,new e.Matrix4),i),i}updateVehicle(t){let i=this.wheelInfos,s=i.length,r=this.chassisBody,o=s;for(;o--;)this.updateWheelTransform(o);const a=ks(r,new e.Vector3),n=Ls(a,As(r,new e.Matrix4).invert(),new e.Vector3);this.currentVehicleSpeedKmHour=n.z;let l=new e.Vector3;this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(t);let h=new e.Vector3;for(new e.Vector3,o=0;o<s;o++){let e=i[o],s=e.suspensionForce;s>e.maxSuspensionForce&&(s=e.maxSuspensionForce),h.copy(e.raycastResult.hitNormalWorld).multiplyScalar(s*t),Ps(this.motor,r,h,e.raycastResult.hitPointWorld)}this.updateFriction(t);let c=new e.Vector3,u=new e.Vector3,d=new e.Vector3;for(o=0;o<s;o++){let e=i[o];Cs(r,e.chassisConnectionPointWorld,d);let s=1;if(1===this.indexUpAxis)s=-1;if(e.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);let i=Rs(u,e.raycastResult.hitNormalWorld);c.copy(e.raycastResult.hitNormalWorld).multiplyScalar(i),u.sub(c);let r=Rs(u,d);e.deltaRotation=s*r*t/e.radius}!e.sliding&&e.isInContact||0===e.engineForce||!e.useCustomSlidingRotationalSpeed||(e.deltaRotation=(e.engineForce>0?1:-1)*e.customSlidingRotationalSpeed*t),Math.abs(e.brake)>Math.abs(e.engineForce)&&(e.deltaRotation=0),e.rotation-=e.deltaRotation,e.deltaRotation*=.99}}updateSuspension(t){let e=this.chassisBody,i=xs(e),s=this.wheelInfos,r=s.length;for(let t=0;t<r;t++){let e=s[t];if(e.isInContact){let t,s=e.suspensionRestLength-e.suspensionLength;t=e.suspensionStiffness*s*e.clippedInvContactDotSuspension;let r,o=e.suspensionRelativeVelocity;r=o<0?e.dampingCompression:e.dampingRelaxation,t-=r*o,e.suspensionForce=t*i,e.suspensionForce<0&&(e.suspensionForce=0)}else e.suspensionForce=0}}updateFriction(t){let i,s,r,o=hs,a=this.wheelInfos,n=a.length,l=this.chassisBody,h=cs,c=us;for(i=0;i<n;i++)if(s=a[i],r=s.raycastResult.body,s.sideImpulse=0,s.forwardImpulse=0,h[i]||(h[i]=new e.Vector3),c[i]||(c[i]=new e.Vector3),r){let t=c[i],e=this.getWheelTransformWorld(i);Ls(os[this.indexRightAxis],e,t);let a=s.raycastResult.hitNormalWorld,n=Rs(t,a);o.copy(a).multiplyScalar(n),t.sub(o).normalize(),Es(a,t,h[i]),h[i].normalize(),s.sideImpulse=Gs(l,s.raycastResult.hitPointWorld,r,s.raycastResult.hitPointWorld,t),s.sideImpulse*=1}for(this.sliding=!1,i=0;i<n;i++){s=a[i],r=s.raycastResult.body;let e=0;if(s.slipInfo=1,r){let o=0,a=s.brake?s.brake:o;e=Bs(l,r,s.raycastResult.hitPointWorld,h[i],a),e+=s.engineForce*t;let n=a/e;s.slipInfo*=n}if(s.forwardImpulse=0,s.skidInfo=1,r){s.skidInfo=1;let i=s.suspensionForce*t*s.frictionSlip,r=i*i;s.forwardImpulse=e;let o=.5*s.forwardImpulse/s.forwardAcceleration,a=1*s.sideImpulse/s.sideAcceleration,n=o*o+a*a;if(s.sliding=!1,n>r){this.sliding=!0,s.sliding=!0;let t=i/Math.sqrt(n);s.skidInfo*=t}}}if(this.sliding)for(let t=0;t<n;t++)s=a[t],0!==s.sideImpulse&&s.skidInfo<1&&(s.forwardImpulse*=s.skidInfo,s.sideImpulse*=s.skidInfo);for(i=0;i<n;i++){s=a[i];let t=new e.Vector3;if(t.copy(s.raycastResult.hitPointWorld).sub(Ss(l,new e.Vector3)),0!==s.forwardImpulse){let t=new e.Vector3;t.copy(h[i]).multiplyScalar(s.forwardImpulse),Ps(this.motor,l,t,s.raycastResult.hitPointWorld)}if(0!==s.sideImpulse){r=s.raycastResult.body,(new e.Vector3).copy(s.raycastResult.hitPointWorld).sub(Ss(r,new e.Vector3));let o=new e.Vector3;o.copy(c[i]).multiplyScalar(s.sideImpulse),Ls(t,As(l,new e.Matrix4).invert(),t),t["xyz"[this.indexUpAxis]]*=s.rollInfluence,Ls(t,As(l,new e.Matrix4),t),Ps(this.motor,l,o,Ss(l,new e.Vector3).add(t)),o.multiplyScalar(-1),Ps(this.motor,r,o,s.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(t){const e=this.chassisBody.matrixWorld;_s(t.chassisConnectionPointLocal,e,t.chassisConnectionPointWorld),Ls(t.directionLocal,e,t.directionWorld)}updateWheelTransform(t){let i=ds,s=ps,r=ms,o=this.wheelInfos[t];this.updateWheelTransformWorld(o),i.copy(o.directionLocal).multiplyScalar(-1),s.copy(o.axleLocal),Es(i,s,r),r.normalize(),s.normalize();let a=o.steering,n=new e.Quaternion;Vs(i,a,n);let l=new e.Quaternion;Vs(s,o.rotation,l);let h=o.quaternion;Ts(this.chassisBody,h),h.multiply(n).multiply(l).normalize();let c=o.position;c.copy(o.directionWorld),c.multiplyScalar(o.suspensionLength);let u=c.clone();c.add(o.chassisConnectionPointWorld),o.matrix.compose(o.position,o.quaternion,{x:1,y:1,z:1}),this.localWheel?(u.add(o.chassisConnectionPointLocal),this.wheelMeshes[t].quaternion.copy(n).multiply(l).normalize(),this.wheelMeshes[t].position.copy(u),this.brakeMeshs&&(2!==t&&3!==t||this.brakeMeshs[t].quaternion.copy(n).normalize(),this.brakeMeshs[t].position.copy(u),this.brakeMeshs[t].updateMatrix())):(this.wheelMeshes[t].position.copy(o.position),this.wheelMeshes[t].quaternion.copy(o.quaternion),this.wheelMeshes[t].updateMatrix())}getWheelTransformWorld(t){return this.wheelInfos[t].matrix}}var ys=new e.Vector3,vs=new e.Vector3;class bs{constructor(t,i){this.motor=i,t=((t,e)=>{for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t})(t,{chassisConnectionPointLocal:new e.Vector3,chassisConnectionPointWorld:new e.Vector3,directionLocal:new e.Vector3,directionWorld:new e.Vector3,axleLocal:new e.Vector3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointLocal.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionLocal.clone(),this.axleLocal=t.axleLocal.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.forwardAcceleration=t.forwardAcceleration,this.sideAcceleration=t.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new ws,this.position=(new e.Vector3).copy(this.chassisConnectionPointLocal),this.quaternion=new e.Quaternion,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new e.Matrix4}castRay(t){if(t.hit){this.isInContact=!0;let i=t.distance;this.raycastResult.hitPointWorld.fromArray(t.point),this.raycastResult.hitNormalWorld.fromArray(t.normal),this.raycastResult.body=this.motor.byName(t.body),this.suspensionLength=i-this.radius;let s=this.suspensionRestLength-this.maxSuspensionTravel,r=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<s&&(this.suspensionLength=s),this.suspensionLength>r&&(this.suspensionLength=r,this.raycastResult.reset());let o=Rs(this.raycastResult.hitNormalWorld,this.directionWorld);Cs(this.chassisBody,this.raycastResult.hitPointWorld,ys);var e=Rs(this.raycastResult.hitNormalWorld,ys);if(o>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/o;this.suspensionRelativeVelocity=e*t,this.clippedInvContactDotSuspension=t}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(t){let e=this.raycastResult;if(this.isInContact){let i=e.hitNormalWorld.dot(e.directionWorld);vs.copy(e.hitPointWorld).sub(t.position),Cs(t,vs,ys);let s=e.hitNormalWorld.dot(ys);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/i;this.suspensionRelativeVelocity=s*t,this.clippedInvContactDotSuspension=t}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.hitNormalWorld.copy(e.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class ws{constructor(){this.body=null,this.hitPointWorld=new e.Vector3,this.hitNormalWorld=new e.Vector3,this.directionWorld=new e.Vector3}reset(){this.body=null,this.hitPointWorld=new e.Vector3,this.hitNormalWorld=new e.Vector3,this.directionWorld=new e.Vector3}}const xs=t=>t.mass,Ms=t=>t.mass>0?1/t.mass:0,Ss=(t,e)=>e.copy(t.position),ks=(t,e)=>e.copy(t.velocity),As=(t,e)=>e.copy(t.matrixWorld),Ts=(t,e)=>e.copy(t.quaternion),Ps=(t,e,i,s)=>{t.change({name:e.name,impulse:i.toArray(),impulseCenter:s.toArray()})},Cs=(t,e,i)=>(i.copy(e).sub(t.position),i.crossVectors(t.angular,i),i.add(t.velocity),i),zs=(t,e)=>(t.inertia&&e.copy(t.inertia),Ls(e,t.matrixWorld,e),e.x=e.x>0?1/e.x:0,e.y=e.y>0?1/e.y:0,e.z=e.z>0?1/e.z:0,e),Rs=(t,e)=>t.x*e.x+t.y*e.y+t.z*e.z,Es=(t,e,i)=>{const s=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,o=t.x*e.y-t.y*e.x;return i.set(s,r,o),i},_s=(t,e,i)=>{const s=t.x,r=t.y,o=t.z,a=e.elements,n=s*a[0]+r*a[4]+o*a[8]+a[12],l=s*a[1]+r*a[5]+o*a[9]+a[13],h=s*a[2]+r*a[6]+o*a[10]+a[14],c=1/(s*a[3]+r*a[7]+o*a[11]+a[15]);return i.x=n*c,i.y=l*c,i.z=h*c,i},Ls=(t,e,i)=>{const s=t.x,r=t.y,o=t.z,a=e.elements;return i.x=s*a[0]+r*a[4]+o*a[8],i.y=s*a[1]+r*a[5]+o*a[9],i.z=s*a[2]+r*a[6]+o*a[10],i},Vs=(t,e,i)=>{const s=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t.x*s,i.y=t.y*s,i.z=t.z*s,i};function Bs(t,e,i,s,r){var o=0,a=i,n=as,l=ns,h=ls;Cs(t,a,n),Cs(e,a,l),h.copy(n).sub(l);return r<(o=-Rs(s,h)*(1/(Ns(t,i,s)+Ns(e,i,s))))&&(o=r),o<-r&&(o=-r),o}var Is=new e.Vector3,Fs=new e.Vector3,Ds=new e.Vector3,Os=new e.Vector3;function Ns(t,i,s){var r=Is,o=Fs,a=Ds,n=Os;return r.copy(i).sub(Ss(t,new e.Vector3)),Es(r,s,o),n.copy(zs(t,new e.Vector3)).multiply(o),Es(n,r,a),Ms(t)+Rs(s,a)}var Us=new e.Vector3,qs=new e.Vector3,js=new e.Vector3;function Gs(t,e,i,s,r){if(r.lengthSq()>1.1)return 0;let o=Us,a=qs,n=js;return Cs(t,e,o),Cs(i,s,a),n.copy(o).sub(a),-.1*Rs(r,n)*(1/(Ms(t)+Ms(i)))}class Ws{constructor(t={},i){this.MoveSpeed=50,this.MaxSpeed=15,this.Drag=.98,this.SteerAngle=20,this.Traction=10,this.MoveForce=new e.Vector3(0,0,0),this.tt=new e.Vector3(0,0,0),this.v1=new e.Vector3(0,0,0),this.v2=new e.Vector3(0,0,0),this.motor=i,this.debug=this.motor.addDebuger(),this._reponsivness=500,this._throttleAmt=25,this._thottle=0,this._roll=0,this._pitch=0,this._yaw=0,this.init(t)}init(){this.car=new e.Mesh(new e.BoxGeometry(2,1,3),new e.MeshBasicMaterial({wireframe:!0})),this.car.position.y=.5,this.motor.add(this.car);let t=new e.AxesHelper;this.car.add(t)}update(t){this.updateCar(t)}updateCar(t){const e=this.motor.getKey(),i=this.motor.getTransform(this.car);this.tt.copy(i.forward).multiplyScalar(this.MoveSpeed*-e[1]*t),this.MoveForce.add(this.tt),this.car.position.add(this.MoveForce.clone().multiplyScalar(t));let s=-e[0],r=this.MoveForce.length();i.up.multiplyScalar(s*r*this.SteerAngle*t),this.car.rotation.y+=i.up.y*this.motor.math.torad,this.MoveForce.multiplyScalar(this.Drag),this.MoveForce.clampLength(0,this.MaxSpeed),r=this.MoveForce.length(),this.v1.copy(this.MoveForce).normalize().multiplyScalar(3),this.v2.copy(i.forward).multiplyScalar(3),this.debug.DrawRay(i.position,this.v1,"white"),this.debug.DrawRay(i.position,this.v2,"blue"),this.debug.DrawRay(i.position,i.right,"red"),this.v1.copy(this.MoveForce).normalize().lerp(i.forward,this.Traction*t),this.MoveForce.copy(this.v1).multiplyScalar(r)}fixedUpdate(t){const e=this.motor.getTransform(this.body);e.position.copy(this.body.position),e.forward.copy(this.forward).applyQuaternion(this.body.quaternion),e.right.copy(this.right).applyQuaternion(this.body.quaternion),e.up.copy(this.up).applyQuaternion(this.body.quaternion),e.thottle.copy(e.up),this.motor.change({name:this.body.name,impulse:e.thottle.multiplyScalar(this._thottle).toArray()}),this.debug.DrawRay(e.position,e.thottle,"red"),this.debug.DrawRay(e.position,e.forward,"yellow"),this.debug.DrawRay(e.position,e.right,"cyan"),this.debug.DrawRay(e.position,e.up,"green")}handleInputs(t){const e=this.motor.getKey();this._roll=e[0],this._pitch=e[1],e[4]?this._thottle+=t*this._throttleAmt:e[5]&&(this._thottle-=t*this._throttleAmt),this._thottle=this.motor.math.clamp(this._thottle,0,100)}}class Hs{constructor(t={},i){this.startPosition=t.pos||[0,0,0],this.model=t.model||null,this.debug=t.debug||!1,this.angle=0,this.speed=50,this.maxSpeed=20,this.drag=.98,this.steerAngle=5,this.traction=3,this.moveForce=new e.Vector3(0,0,0),this.side=0,this.onAir=!1,this.tt=new e.Vector3(0,0,0),this.v1=new e.Vector3(0,0,0),this.v2=new e.Vector3(0,0,0),this.floorNormal=new e.Vector3(0,0,0),this.up=new e.Vector3(0,1,0),this.decal=new e.Vector3(0,-.5,0),this.tmpQ1=new e.Quaternion,this.tmpQ2=new e.Quaternion,this.tmpQ3=new e.Quaternion,this.motor=i,this.angleS=0,this.debug&&(this.debuger=this.motor.addDebuger()),this.phyMove=!0,this.init(t)}setDebug(t){t&&(this.debug=t),this.sphere.visible=this.debug,this.ray.visible=this.debug}init(){this.radius=1,this.decal.y=-.5,this.radius=1.7,this.decal.y=-1.2;const t=this.motor.math;this.sphere=this.motor.add({type:"sphere",name:"baser",mass:1,size:[this.radius],pos:t.addArray(this.startPosition,[0,this.radius,0]),friction:.5,material:"debug",getVelocity:!0,visible:this.debug,shadow:!1,ray:!1});let i=this.rayHit.bind(this);if(this.ray=this.motor.add({name:"raySphere",type:"ray",begin:[0,0,0],end:[0,-(this.radius+1),0],visible:this.debug,parent:this.sphere,noRotation:!0,callback:i}),this.model){for(let t in this.model)this.model[t].receiveShadow=!0,this.model[t].castShadow=!0;this.car=this.model.body,this.w=[this.model.wheel_0,this.model.wheel_1,this.model.wheel_2,this.model.wheel_3,this.model.d_wheel]}else this.car=new e.Mesh(new e.BoxGeometry(1,.4,2),new e.MeshBasicMaterial({wireframe:!0})),this.addWheels();this.motor.add(this.car)}addWheels(){let t=new e.CylinderGeometry(.3,.3,.3,16);t.rotateZ(Math.PI/2);let i,s=new e.MeshBasicMaterial({wireframe:!0}),r=4,o=[.7,-.2,.7],a=[];for(;r--;)a[r]=new e.Mesh(t,s),i=[0===r||3===r?o[0]:-.7,o[1],r<2?o[2]:-.7],a[r].position.fromArray(i),this.car.add(a[r]);this.w=a}updateWheels(){this.motor.math;let t,e=4;this.tmpQ3.setFromAxisAngle({x:0,y:1,z:0},3*this.angleS);let i=this.sphere.velocity.length()*this.side,s={x:1,y:0,z:0};for(;e--;)t=this.w[e],e<2?t.quaternion.setFromAxisAngle(s,i).premultiply(this.tmpQ3):t.quaternion.setFromAxisAngle(s,i);this.w[4]&&(this.w[4].rotation.y=10*this.angleS)}rayHit(t){t.hit?this.floorNormal.fromArray(t.normal).normalize():this.floorNormal.set(0,0,0),this.onAir=!t.hit}update(t){const e=this.motor.getKey(),i=this.motor.math;this.phyMove&&this.car.position.copy(this.sphere.position).add(this.decal);const s=this.motor.getTransform(this.car);let r=-e[1]*this.speed*t;this.onAir&&(r=0),this.tt.copy(s.forward).multiplyScalar(r),this.moveForce.add(this.tt),this.phyMove||this.car.position.add(this.moveForce.clone().multiplyScalar(t)),this.tmpQ1.setFromUnitVectors(this.up,this.floorNormal),this.tmpQ2.slerp(this.tmpQ1,4*t);let o=this.moveForce.toArray();this.motor.change({name:this.sphere.name,linear:o,velocityOperation:"xz"}),this.chassis&&this.motor.change({name:this.chassis.name,quat:this.car.quaternion.toArray(),pos:this.car.position.toArray()});let a=-e[0],n=this.moveForce.length();this.angleS=a*this.steerAngle*i.torad,this.angle+=this.angleS*n*t,this.car.quaternion.setFromAxisAngle(this.up,this.angle).premultiply(this.tmpQ2),this.moveForce.multiplyScalar(this.drag),this.moveForce.clampLength(0,this.maxSpeed),n=this.moveForce.length(),this.v1.copy(this.moveForce).normalize().multiplyScalar(1),this.v2.copy(s.forward).multiplyScalar(1),this.debug&&(this.debuger.DrawRay(s.position,this.v1,"white"),this.debuger.DrawRay(s.position,this.v2,"blue")),this.v1.copy(this.moveForce).normalize().lerp(s.forward,this.traction*t),this.moveForce.copy(this.v1).multiplyScalar(n),this.side=this.moveForce.dot(s.forward)>0?-1:1,this.updateWheels()}}const Xs=new e.Matrix4,Qs=new e.Matrix4;new e.Vector3;let Ys=e.Skeleton.prototype;Ys.byName=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return this.bones[e];return null},Ys.getId=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return e;return null},Ys.setExtraRotation=function(t,i,s,r){(t.isBone?t:this.byName(t))&&e.MathUtils.DEG2RAD},Ys.setScalling=function(t,i,s,r){let o=t.isBone?t:this.byName(t);o&&(o.scalling=new e.Vector3(i,s,r))},Ys.resetScalling=function(t){this.pose(),this.scalled=!0;for(let t=0,i=this.bones.length;t<i;t++)this.bones[t].isPhysics=!1,this.bones[t].phyMtx=new e.Matrix4;t||this.applyScalling()},Ys.childScale=function(t,e){if(!this.scalled)return;t.scalling&&e.scale(t.scalling);let i,s=t.children.length,r=0;for(;s--;)i=t.children[r],r++,i.isBone,i.matrixWorld.multiplyMatrices(e,i.matrix)},Ys.applyScalling=function(t){let e,i,s,r=this.bones.length;for(i=0;i<r;i++)e=this.bones[i],s=e.parent||null,null!==s&&s.scalling&&"root"!==e.name&&(e.position.multiply(s.scalling),e.updateMatrixWorld(!0));this.calculateInverses()},Ys.update=function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;let r,o=t.length,a=0;for(;o--;){r=t[a];const s=r?r.isPhysics?r.phyMtx:r.matrixWorld:Qs;this.childScale(r,s),Xs.multiplyMatrices(s,e[a]),Xs.toArray(i,16*a),a++}null!==s&&(s.needsUpdate=!0)};const Js={getColor(t){let e=t.toString();e=e.substring(e.lastIndexOf(".")+1);let i,s=[255,255,255];switch(e){case"grass":s=[.223,.827,.325],i=[.741,.498,.258];break;case"dirt":s=[.741,.498,.258];break;case"leaves":s=[.152,.682,.376];break;case"sand":s=[.878,.819,.686];break;case"ice":s=[.65,.882,.96];break;case"stone":s=[.537,.64,.65];break;case"cobblestone":s=[.666,.647,.588];break;case"wood":s=[.603,.321,.152];break;case"snow":s=[.905,.976,1]}return i?[s[0],s[1],s[2],i[0],i[1],i[2]]:[s[0],s[1],s[2]]},fire:{type:"star",numParticles:20,position:[0,0,0],colors:[1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,.5,0,0,0,0],lifeTime:2,timeRange:2,startSize:.3,endSize:.9,velocity:[0,.8,0],velocityRange:[.15,.15,.15],gravity:[0,-.2,0],spinSpeedRange:4},smoke:{position:[-2,-.2,0],colors:[0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],numParticles:20,lifeTime:2,timeRange:2,startSize:.5,endSize:2,velocity:[0,1.6,0],velocityRange:[.2,0,.2],gravity:[0,-.25,0],spinSpeedRange:4,blending:"normal"},addBlock:{type:"cube",numParticles:30,lifeTime:1.5,endTime:1.5,startTime:0,startSize:.25,endSize:.5,sizeRange:.25,spinSpeedRange:2,radius:.25,velocity:[1,0,1],velocityRange:[.25,0,.25],acceleration:[1,0,1],accelerationRange:[.25,0,.25],gravity:[0,.05,0],tween:"outQuad",blending:"normal",alphaTest:.1},removeBlock:{type:"cube",lifeTime:1.5,endTime:1.5,startTime:0,startSize:.5,sizeRange:.25,endSize:.1,spinSpeedRange:2,accelerationRange:[.5,.5,.5],gravity:[0,-.1,0],tween:"outQuad",blending:"normal",alphaTest:.1},explosion:{colors:[1,0,0,0,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,.5,1,1,1,0],type:"cloud",radius:.5,radiusRange:.5,numParticles:400,positionRange:[2,1,2],lifeTime:3,endTime:4,lifeTimeRange:1,startTime:0,startSize:.1,endSize:2,sizeRange:1,accelerationRange:[1,.3,1],acceleration:[.8,.8,.8],gravity:[0,-.5,0],spinSpeedRange:2,luma:!1},playerMove:{trail:!0,colors:[1,1,1,1,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:1e3,positionRange:[.2,0,.2],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.1,0]},vehicleMove:{trail:!0,colors:[.5,.5,.5,.25,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:2e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.2,0]},vehicleTrack:{trail:!0,colors:[.2,.2,.2,.1,.2,.2,.2,0],type:"round2",blending:"normal",startSize:.3,endSize:.3,numParticles:4,maxParticles:2e3,position:[0,-.1,0],lifeTime:6,oriented:!0},underWater:{trail:!0,colors:[1,1,1,1,.5,.5,1,0],type:"bubble",blending:"normal",numParticles:1,maxParticles:1e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.1,endSize:.5,sizeRange:.05,velocity:[0,1,0],velocityRange:[1,0,1],acceleration:[.2,0,.2],gravity:[0,1,0]},bazookaFire:{trail:!0,colors:[1,0,0,1,1,1,0,.5,1,1,1,0],type:"round",numParticles:2,maxParticles:600,positionRange:[.1,.1,.1],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.1,velocityRange:[.6,.6,.6],gravity:[0,.1,0],luma:!1}},Zs=["pixel","basic","cube","cloud","round","round2","donut","bubble","smoke","circle","field","star","octo"];function Ks(){this.parent=null,this.position=[0,0,0],this.rotation=[0,0,0],this.name="default",this.type="round",this.tween="linear",this.trail=!1,this.model="",this.numParticles=1,this.maxParticles=0,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.endTime=-1,this.lifeTimeRange=0,this.sizeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.pposition=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.gravity=[0,0,0],this.oriented=!1,this.orientation=[0,0,0,1],this.colors=[1,1,1,1],this.blending="additive",this.radius=0,this.radiusPosition=!1,this.axis="Y",this.radiusRange=0,this.tmpRotation=null,this.alphaTest=0,this.renderOrder=0,this.luma=!0,this.depthWrite=!1,this.transparent=!0}const $s={torad:Math.PI/180,todeg:180/Math.PI,random:()=>Math.random(),rand:(t,e)=>t+$s.random()*(e-t),randInt:(t,e)=>t+Math.floor($s.random()*(e-t+1)),plusMinus:t=>($s.random()-.5)*t*2,plusMinusVector:t=>{const e=[];let i=t.length;for(;i--;)e.push($s.plusMinus(t[i]));return e},toTexture:t=>{let i=new e.Texture(t);return i.minFilter=e.LinearFilter,i.magFilter=e.LinearFilter,i.flipY=!1,i.colorSpace=e.SRGBColorSpace,i.needsUpdate=!0,i},createTextureFromFloats:(t,i,s,r)=>{let o=null;if(null==r){const r=new Uint8Array(s.length);let a;for(let t=0;t<s.length;t++)a=255*s[t],r[t]=a;return o=new e.DataTexture(r,t,i,e.RGBAFormat),o.minFilter=e.LinearFilter,o.magFilter=e.LinearFilter,o.needsUpdate=!0,o}return o=r,o}},tr=function(t){let e;switch(t){case"linear":e="float tween( float k ) { return k; }";break;case"inQuad":e="float tween( float k ) { return k * k; }";break;case"outQuad":e="float tween( float k ) { return k * ( 2.0 - k ); }";break;case"inOutQuad":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k;\n            return - 0.5 * ( --k * ( k - 2.0 ) - 1.0 ); \n        }";break;case"inCubic":e="float tween( float k ) { return k * k * k; }";break;case"outCubic":e="float tween( float k ) { return --k * k * k + 1.0; }";break;case"inOutCubic":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k + 2.0 ); \n        }";break;case"inQuart":e="float tween( float k ) { return k * k * k * k; }";break;case"outQuart":e="float tween( float k ) { return 1.0 - ( --k * k * k * k ); }";break;case"inOutQuart":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return 0.5 * k * k * k * k;\n\t\t\treturn - 0.5 * ( ( k -= 2.0 ) * k * k * k - 2.0 ); \n        }";break;case"inQuint":e="float tween( float k ) { return k * k * k * k * k; }";break;case"outQuint":e="float tween( float k ) { return --k * k * k * k * k + 1.0; }";break;case"inOutQuint":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k * k * k + 2.0 );\n        }";break;case"inSine":e="#define PI_90 1.570796326794896\n        float tween( float k ) { float j = k * PI_90; return 1.0 - cos( j ); }";break;case"outSine":e="#define PI_90 1.570796326794896\n\t\tfloat tween( float k ) { float j = k * PI_90; return sin( j ); }";break;case"inOutSine":e="#define M_PI 3.14159265358979323846\n\t\tfloat tween( float k ) { \n\t\t\tfloat j = k * M_PI; return 0.5 * (1.0-cos(j));\n        }";break;case"inExpo":e="float tween( float k ) { return k == 0.0 ? 0.0 : pow( 1024.0, k - 1.0 ); }";break;case"outExpo":e="float tween( float k ) { return k == 1.0 ? 1.0 : 1.0 - pow( 2.0, - 10.0 * k ); }";break;case"inOutExpo":e="float tween( float k ) { \n\t\t\tif ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * pow( 1024.0, k - 1.0 );\n\t\t    return 0.5 * ( - pow( 2.0, - 10.0 * ( k - 1.0 ) ) + 2.0 );\n        }";break;case"inCirc":e="float tween( float k ) { return 1.0 - sqrt( 1.0 - k * k ); }";break;case"outCirc":e="float tween( float k ) { return sqrt( 1.0 - ( --k * k ) ); }";break;case"inOutCirc":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return - 0.5 * ( sqrt( 1.0 - k * k ) - 1.0 );\n\t\t\treturn 0.5 * ( sqrt( 1.0 - ( k -= 2.0 ) * k ) + 1.0 ); \n        }";break;case"inElastic":e="#define TWO_PI 6.28318530717958647692\n        float tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return - ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t}";break;case"outElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1; \n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return ( a * pow( 2.0, - 10.0 * k) * sin( ( k - s ) * TWO_PI / p ) + 1.0 );\n\t\t}";break;case"inOutElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return - 0.5 * ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t    return a * pow( 2.0, -10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) * 0.5 + 1.0;\n\t\t}";break;case"inBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return k * k * ( ( s + 1.0 ) * k - s );\n\t\t}";break;case"outBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return --k * k * ( ( s + 1.0 ) * k + s ) + 1.0;\n\t\t}";break;case"inOutBack":e="float tween(float k) {\n\t\t    float s = 1.70158 * 1.525;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * ( k * k * ( ( s + 1.0 ) * k - s ) );\n\t\t    return 0.5 * ( ( k -= 2.0 ) * k * ( ( s + 1.0 ) * k + s ) + 2.0 );\n\t\t}";break;case"inBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat tween(float k) { return 1.0 - outBounce( 1.0 - k ); }";break;case"outBounce":e="float tween(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}";break;case"inOutBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat inBounce(float k) { return 1.0 - outBounce( 1.0 - k ); }\n\t\tfloat tween(float k) {\n\t\t    if ( k < 0.5 ) return inBounce( k * 2.0 ) * 0.5;\n\t\t    return outBounce( k * 2.0 - 1.0 ) * 0.5 + 0.5;\n\t\t}"}return e},er=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],ir=new Float32Array(28);class sr extends e.Points{constructor(t,e){super(),this.pe=t,this.count=0,this.color=null,this.texture=null,this.localTime=0,this.time=0,this.endTime=-1,this.num=0,this.matrixAutoUpdate=!1,this.frustumCulled=e.frustum||!1,this.receiveShadow=!1,this.castShadow=!1,this.birthIndex=0,this.luma=!0,e&&this.setParameters(e)}setParameters(t){this.validateParameters(t),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.name=t.name,this.isTrail=t.trail||!1,this.parameters=t;const e=this.isTrail?t.maxParticles:t.numParticles;this.allocateParticles_(e,t),this.isTrail||this.createParticles_(0,e,t),t.parent?t.parent.add(this):this.pe.scene?this.pe.scene.add(this):this.pe.add(this)}makeGeometry(t){this.geometry=t.oriented?new e.InstancedBufferGeometry:new e.BufferGeometry,this.isMesh=t.oriented}setColorRamp(t){const e=t.length/4;if(e%1!=0)throw"colorRamp must have multiple of 4 entries";this.color=$s.createTextureFromFloats(e,1,t)}validateParameters(t){var e=new Ks;for(let i in t)if(void 0===e[i])throw'unknown particle parameter "'+i+'"';for(let i in e)void 0===t[i]&&(t[i]=e[i])}perParticle(t,e){}birthParticles(t,e){var i=this.parameters.numParticles;this.parameters.pposition=t,this.parameters.startTime=this.time,this.endTime=this.time+this.parameters.lifeTime,e&&this.setColorRamp(e),this.createParticles_(this.birthIndex,i,this.parameters),this.birthIndex+=i,this.birthIndex+i>=this.parameters.maxParticles&&(this.birthIndex=0)}createParticles_(t,i,s){const r=$s.plusMinus,o=$s.plusMinusVector,a=this.interleavedBuffer.array;let n,l=i;for(;l--;){this.perParticle(l,s);let h=s.lifeTime+r(s.lifeTimeRange),c=null===s.startTime?l*s.lifeTime/i:s.startTime,u=s.frameStart+r(s.frameStartRange),d=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.pposition),(new e.Vector3).fromArray(o(s.positionRange))),p=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.velocity),(new e.Vector3).fromArray(o(s.velocityRange))),m=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.acceleration),(new e.Vector3).fromArray(o(s.accelerationRange))),f=(new e.Vector4).addVectors((new e.Vector4).fromArray(s.colorMult),(new e.Vector4).fromArray(o(s.colorMultRange))),g=s.spinStart+r(s.spinStartRange),y=s.spinSpeed+r(s.spinSpeedRange),v=s.startSize+r(s.sizeRange||s.startSizeRange),b=s.endSize+r(s.sizeRange||s.endSizeRange),w=(new e.Vector4).fromArray(s.orientation);if(s.positionRange[0],s.positionRange[1],s.positionRange[2],s.radius){let t=s.axis||"Y",i=$s.rand(0,2*Math.PI);s.tmpRotation=[90,-i*$s.todeg,90,"YXZ"];let o=s.radius+r(s.radiusRange),a=Math.cos(i),n=Math.sin(i),l=new e.Vector3;switch(t){case"X":l.y=a,l.z=n;break;case"Y":l.x=a,l.z=n;break;case"Z":l.x=a,l.y=n}switch(l.multiplyScalar(o),s.radiusPosition&&d.add(l),t){case"X":l.x=1;break;case"Y":l.y=1;break;case"Z":l.z=1}m.multiply(l),p.multiply(l)}s.tmpRotation&&(w=(new e.Quaternion).setFromEuler(new e.Euler(s.tmpRotation[0]*$s.torad,s.tmpRotation[1]*$s.torad,s.tmpRotation[2]*$s.torad,s.tmpRotation[3]))),n=0+28*l*4+28*t*4,a[0+n]=d.x,a[0+n+1]=d.y,a[0+n+2]=d.z,a[0+n+3]=c,a[4+n]=er[0][0],a[4+n+1]=er[0][1],a[4+n+2]=h,a[4+n+3]=u,a[8+n]=p.x,a[8+n+1]=p.y,a[8+n+2]=p.z,a[8+n+3]=v,a[12+n]=m.x,a[12+n+1]=m.y,a[12+n+2]=m.z,a[12+n+3]=b,a[16+n]=g,a[16+n+1]=y,a[16+n+2]=0,a[16+n+3]=0,a[20+n]=w.x,a[20+n+1]=w.y,a[20+n+2]=w.z,a[20+n+3]=w.w,a[24+n]=f.x,a[24+n+1]=f.y,a[24+n+2]=f.z,a[24+n+3]=f.w}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value.fromArray(s.worldVelocity),this.material.uniforms.gravity.value.fromArray(s.gravity),this.material.uniforms.timeRange.value=s.timeRange,this.material.uniforms.frameDuration.value=s.frameDuration,this.material.uniforms.numFrames.value=s.numFrames,this.material.uniforms.rampSampler.value=this.color,this.material.uniforms.colorSampler.value=this.texture,this.material.blending="normal"===s.blending?e.NormalBlending:e.AdditiveBlending,this.updateMatrix()}allocateParticles_(t,i){if(this.count!==t){if(i.oriented||(i.oriented=!1),i.position&&this.position.fromArray(i.position),i.rotation&&this.quaternion.setFromEuler(new e.Euler(i.rotation[0]*$s.torad,i.rotation[1]*$s.torad,i.rotation[2]*$s.torad)),this.setColorRamp(i.colors),this.pe.textures.has(i.type)||-1!==Zs.indexOf(i.type)&&this.pe.textures.make(i.type),this.texture=this.pe.textures.get(i.type),this.texture||console.log("this texture is undefined !!"),this.endTime=i.endTime||-1,this.luma=i.luma,this.makeGeometry(i),this.count=t,i.oriented){var s=new e.InterleavedBuffer(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8);this.geometry.setAttribute("position",new e.InterleavedBufferAttribute(s,3,0)),this.geometry.setAttribute("uv",new e.InterleavedBufferAttribute(s,2,4)),this.geometry.setIndex(new e.BufferAttribute(new Uint16Array([0,1,2,0,2,3]),1)),this.interleavedBuffer=new e.InstancedInterleavedBuffer(new Float32Array(t*ir.byteLength),28,1).setUsage(e.DynamicDrawUsage)}else this.interleavedBuffer=new e.InterleavedBuffer(new Float32Array(t*ir.byteLength),28).setUsage(e.DynamicDrawUsage);this.geometry.setAttribute("position",new e.InterleavedBufferAttribute(this.interleavedBuffer,3,0)),this.geometry.setAttribute("startTime",new e.InterleavedBufferAttribute(this.interleavedBuffer,1,3)),this.geometry.setAttribute("uvLifeTimeFrameStart",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,4)),this.geometry.setAttribute("velocityStartSize",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,8)),this.geometry.setAttribute("accelerationEndSize",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,12)),this.geometry.setAttribute("spinStartSpinSpeed",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,16)),this.geometry.setAttribute("orientation",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,20)),this.geometry.setAttribute("colorMult",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,24)),this.geometry.boundingSphere=new e.Sphere,this.geometry.boundingSphere.radius=3;let o=e.AdditiveBlending;switch(i.blending){case"sub":case"subtractive":o=e.SubtractiveBlending;break;case"multi":case"multiply":o=e.MultiplyBlending;break;case"normal":o=e.NormalBlending;break;default:o=e.AdditiveBlending}var r={worldVelocity:{value:new e.Vector3},gravity:{value:new e.Vector3},timeRange:{value:0},time:{value:0},timeOffset:{value:0},frameDuration:{value:0},numFrames:{value:0},rampSampler:{value:null},colorSampler:{value:null},scale:{value:.5*window.innerHeight},luma:{value:this.luma?this.pe.luminosity:1},alphaTest:{value:i.alphaTest}};this.material=new e.ShaderMaterial({defines:{USE_ORIENTATION:i.oriented},uniforms:r,vertexShader:tr(i.tween||"linear")+"\nprecision mediump float;\nprecision mediump int;\n\n#ifdef USE_ORIENTATION\n\t//uniform mat4 worldViewProjection;\n\t//uniform mat4 world;\n\tattribute vec3 offset;\n\tattribute vec4 orientation;\n#else\n    uniform float scale;\n#endif\n\nuniform vec3 worldVelocity;\nuniform vec3 gravity;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n//#include <clipping_planes_pars_vertex>\n\nvec3 lerp( vec3 a, vec3 b, float p ){ return a + (b - a) * p; }\n\nvoid main() \n{\n    float lifeTime = uvLifeTimeFrameStart.z;\n    float frameStart = uvLifeTimeFrameStart.w;\n    float startSize = velocityStartSize.w;\n\n    //vec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz, 0.0)).xyz + worldVelocity;\n\t//vec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz, 0.0)).xyz + gravity;\n\n    //vec3 velocity = velocityStartSize.xyz + worldVelocity;\n\t//vec3 acceleration = accelerationEndSize.xyz + gravity;\n\n\tvec3 velocity = velocityStartSize.xyz + (inverse(modelMatrix) * vec4(worldVelocity, 0.0)).xyz;\n\tvec3 acceleration = accelerationEndSize.xyz + (inverse(modelMatrix) * vec4(gravity, 0.0)).xyz;\n\n    float endSize = accelerationEndSize.w;\n    float spinStart = spinStartSpinSpeed.x;\n    float spinSpeed = spinStartSpinSpeed.y;\n\n    float localTime = mod((time - timeOffset - startTime), timeRange);\n    //localTime = tween( localTime );\n    float percentLife = localTime / lifeTime;\n    percentLife = tween( percentLife );\n\n    vec3 posEnd = velocity * lifeTime + acceleration * lifeTime * lifeTime;\n\n    float frame = mod(floor(localTime / frameDuration + frameStart), numFrames);\n    float uOffset = frame / numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n    outputTexcoord = vec2(u, uv.y + 0.5);\n    outputColorMult = colorMult;\n\n    float size = mix(startSize, endSize, percentLife);\n\tsize = (percentLife < 0. || percentLife > 1.0) ? 0.0 : size;\n\n\tfloat s = sin(spinStart + spinSpeed * localTime);\n\tfloat c = cos(spinStart + spinSpeed * localTime);\n\n    #ifdef USE_ORIENTATION\n\t\t\n\t\tvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., (uv.x * s - uv.y * c) * size, 1.);\n\t\t//vec3 center = velocity * localTime + acceleration * localTime * localTime + position + offset;\n\t\tvec3 center = (posEnd * percentLife) + position + offset;\n\n\t\tvec4 q2 = orientation + orientation;\n\t\tvec4 qx = orientation.xxxw * q2.xyzx;\n\t\tvec4 qy = orientation.xyyw * q2.xyzy;\n\t\tvec4 qz = orientation.xxzw * q2.xxzz;\n\n\t\tmat4 localMatrix = mat4(\n\t\t    (1.0 - qy.y) - qz.z,  qx.y + qz.w,  qx.z - qy.w, 0,\n\t\t    qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n\t\t    qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n\t\t    center.x, center.y, center.z, 1\n\t\t);\n\t\trotatedPoint = localMatrix * rotatedPoint;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n\n\t#else\n\n\t    //vec3 pos = position + velocity * localTime + acceleration * localTime * localTime;\n\n\t    vec3 pos = (posEnd * percentLife) + position;\n\t    \n\t    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );\n        //gl_PointSize = size * 1.5 * ( scale / length( mvPosition.xyz ) );\n        gl_PointSize = size * 1.5 * ( scale / - mvPosition.z );\n\n        mat2 r = mat2( c, -s, s, c);\n        r *= 0.5; r += 0.5;  r = r * 2.0 - 1.0;\n        rotationMtx = r;\n\n        gl_Position = projectionMatrix * mvPosition;\n\n\t#endif\n\n\toutputPercentLife = percentLife;\n\n\t#include <logdepthbuf_vertex>\n\t//#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nuniform float luma;\nuniform float alphaTest;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n//#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t//#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\n\tvec4 diffuseColor = texture2D( rampSampler, vec2(outputPercentLife, 0.5) ) * outputColorMult;\n\n    vec2 uv = vec2(0.0);\n    #ifdef USE_ORIENTATION\n        uv = outputTexcoord;\n\t#else\n\t    uv = gl_PointCoord;\n\t    uv -= 0.5; uv = uv * rotationMtx; uv += 0.5;\n\t#endif\n\n\t// texture\n\tdiffuseColor *= texture2D( colorSampler, uv );\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n\tdiffuseColor.rgb *= luma;\n\n\tgl_FragColor = diffuseColor; \n\t#include <fog_fragment>\n\n}\n",side:i.oriented?e.DoubleSide:e.FrontSide,blending:o,depthTest:!0,depthWrite:i.depthWrite,transparent:i.transparent,forceSinglePass:i.single||!1,fog:i.fog||!1}),this.renderOrder=i.renderOrder||0}}draw(t=0){if(!this.material.uniforms)return;const e=this.material.uniforms;this.time+=this.pe.delta,e.time.value=this.time,e.timeOffset.value=t,e.scale.value=this.pe.hscale,e.luma.value=this.luma?this.pe.luminosity:1,-1!==this.endTime&&this.time>=this.endTime&&this.pe.remove(this.name)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.material.dispose(),this.color.dispose()}raycast(){}clone(t){return void 0===t&&(t=this.pe.createEmitter(this.texture)),t.time=0,t.endTime=this.endTime,t.geometry=this.geometry,t.material=this.material.clone(),t.material.uniforms.rampSampler.value=this.color,t.material.uniforms.colorSampler.value=this.texture,super.copy(t),this.num++,t.name=this.name+this.num,t}}class rr extends Map{constructor(){super()}dispose(){this.forEach((t=>{t.dispose()})),this.clear()}add(t,e){this.has(t)||this.set(t,e)}make(t){if(!this.has(t)){let e=this["make"+t[0].toUpperCase()+t.substring(1)]();this.set(t,e)}}makePixel(){const t=[];for(let e=0;e<2;++e)for(let e=0;e<2;++e)t.push(1,1,1,1);return $s.createTextureFromFloats(2,2,t)}makeBasic(){const t=[0,.2,.7,1,.7,.2,0,0],e=[];for(let i=0;i<8;++i)for(let s=0;s<8;++s){let r=t[s]*t[i];e.push(r,r,r,1)}return $s.createTextureFromFloats(8,8,e)}makeCube(){let t=document.createElement("canvas");t.width=t.height=8;const e=t.getContext("2d");return e.fillStyle="rgba(255,255,255,1.0)",e.fillRect(2,2,4,4),$s.toTexture(t)}makeCloud(){let t=16,e=document.createElement("canvas");e.width=e.height=t;const i=e.getContext("2d");let s="rgba(255,255,255,1)",r="rgba(255,255,255,0)",o=i.createRadialGradient(8,6.4,0,8,6.4,6.4);return o.addColorStop(.3,s),o.addColorStop(1,r),i.fillStyle=o,i.fillRect(0,0,t,t),o=i.createRadialGradient(6.4,9.92,0,6.4,9.92,5.6),o.addColorStop(.3,s),o.addColorStop(1,r),i.fillStyle=o,i.fillRect(0,0,t,t),o=i.createRadialGradient(4.32,6.4,0,4.32,6.4,4.16),o.addColorStop(.2,s),o.addColorStop(1,r),i.fillStyle=o,i.fillRect(0,0,t,t),o=i.createRadialGradient(12.16,9.6,0,12.16,9.6,3.68),o.addColorStop(.2,s),o.addColorStop(1,r),i.fillStyle=o,i.fillRect(0,0,t,t),$s.toTexture(e)}makeRound(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.3,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),$s.toTexture(t)}makeRound2(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),$s.toTexture(t)}makeDonut(){let t=document.createElement("canvas");t.width=t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,0.1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.beginPath(),e.arc(16,16,16,0,2*Math.PI,!1),e.arc(16,16,8,0,2*Math.PI,!0),e.fill(),$s.toTexture(t)}makeBubble(){let t=document.createElement("canvas");t.width=t.height=64;let e="rgba(0,255,255,0)";const i=t.getContext("2d"),s=i.createRadialGradient(25.6,25.6,0,32,32,32);return s.addColorStop(.4,e),s.addColorStop(.9,"rgba(0,255,255,0.6)"),s.addColorStop(.99,"rgba(0,255,255,1)"),s.addColorStop(1,e),i.fillStyle=s,i.fillRect(0,0,64,64),i.fillStyle="rgba(255,255,255,1)",i.beginPath(),i.arc(44.8,25.6,8.96,0,2*Math.PI,!1),i.fill(),i.beginPath(),i.arc(12.8,41.6,3.2,0,2*Math.PI,!1),i.fill(),$s.toTexture(t)}makeSmoke(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");let i=new Image;i.src=or;let s=$s.toTexture(t);return i.onload=function(){e.drawImage(i,0,0),s.needsUpdate=!0},s}makeCircle(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");return e.strokeStyle="white",e.lineWidth=4,e.beginPath(),e.arc(32,32,30,0,2*Math.PI),e.stroke(),$s.toTexture(t)}makeField(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,0,64);return i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.8,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(24,0,16,64),$s.toTexture(t)}makeStar(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255,255,255,0.5)"),i.addColorStop(.5,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),e.fillStyle=i,this.star(e,32,6.4,32,32,3),this.star(e,32,25.6,32,32,3),$s.toTexture(t)}makeOcto(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(.4,"rgba(255,255,255,0.2)"),i.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=i,this.star(e,25.6,22.4,32,32,6),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=6,e.stroke(),$s.toTexture(t)}star(t,e,i,s,r,o){let a,n,l;t.beginPath(),t.moveTo(s+e,r);for(var h=1;h<=2*o;h++)h%2==0?(l=h*(2*Math.PI)/(2*o),a=s+e*Math.cos(l),n=r+e*Math.sin(l)):(l=h*(2*Math.PI)/(2*o),a=s+i*Math.cos(l),n=r+i*Math.sin(l)),t.lineTo(a,n);t.closePath(),t.fill()}}const or="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAPOklEQVR42rWb224dRRaGq\n7r30Tu2Y5MhmYsZRZqbeahBiCvgPnCBOCeAEEjcI/E2vAfiYqJJgIHE2/Y+Vk2tzf9Ji2XZDsmkpeXu3V1dXf9f61Sr2316wa3Wmj/++GO\nTrkkvSTo3aDKUdB999JHJoMlEYud72tk13ce53kmmX5PWNr///vvpgw8+yPfv30+llPzee+917Xd68ODBM4+/f1HwbYd04XhgouNqx3re0\nF3rc85DtUntmK6zk7G11XHh0fZns9nk1WqVjYR23J2ennZtn7788sv6UgkA/Hq97mzwbevbbwMzEMBJGPj290HnDrC2qe3IzrV7N2oXSR2\nZ2PN4dNbW972JjSOfnJx0o9EoDwaD+sUXX7w8Ah4+fJgbw7nWCphRztnkDzMr0Wwx8ISWVNvTXrNv14xI7u+4LmLpE82xbcd+A50nk0kdj\n8fJCHnzzTfTN998U18KAW+88UY+OjoypjsNdtTGMLQJYXYBDUjTjqC+nYD1XtVbu7Ht23lIsfPW936TiZ0HOP3YRLTNNKG2LW2aVp6dnqZ\n/vfZa/fbbb//vBJiDMcbtgTv71aDs2IMvkl4AbKDJ9tZW94w0k0nmcsOO7bp+j0TErO1nOgeRmIqZQ3UkNlOYp58eP0qL5bJ+99139YUJ+\nP77702l8ttvv51ff/31bjab5f39/a7h3wFv7GP7nfMPqC8qW5htAd8ToKTr+9pXAZ+atH72pCkFMtVmg48Ag55Rt9tt3pRSbx4epPv3H+T\nPP/+8mrP89NNPn48AA95sKw+Hw7xcLvPh4WG3t7eXmhb0+AER4L3/UOKdYFbbPQOs6xknh1MUMfQ71bkiDaO/KvFRZrsD1Hf1xmy2PTy8m\nc0pWli07cMPP4SEP0fAu+++m9ssAz5Pp1MzAXuone+c+mcAAEr9V+0xh5ns3druOe0ZVbv++zERoUdbpOreufZ6Bu1LbVsjoLTxFXtuKaV\nmF1v/NAE//PCDObtk4J8+fZru3LnTNfXPTc0MuBExMBNgxph5+YbeacN0Z+8pT2qqaIYBu6H7JtYmy/tLcJY7LfBaBpkci6zN76aSa3DC6\nbkJuHfvns18Oj8/z/P5PN29e7c3AizWNsmEJ0DrgcwMmnBDx5yHgJGAkzNwL2qfaEN/zvvzLHwBJlDYk1hJc5KN+Zl9wOPHj/Nbb72VF4t\nFMqfSJN26das7Pj7uBDzLAe5mzhwbaqvBzQAmQBBVNPO3mhziH3R96tp2uncm4N6nmPbZPWvA4hjdcRZwSLDUOX3yySfPRsBXX31l6tKSi\n3GaTmfN9g924Jsz9NmeATcbTnr4K03+0eS2AwEJaEMS+L/p2mmTousHTY5s77z/EBIEHFNgNrdEADcBbBXnye9nIoDts88+a1502Lz/yLx\n+3zIt4rl1aLO/51TxZpN/Nvm7wJ+LfYvtM9vL8++3xsf2WwNeYCYCuqd8YExYM6J1viOlJqSi8oRT38Y0BALIqdCCawkwtd85+G4X5bu+R\nX2lqR2q6LzrRMDvaqbO9PChG3wvMzlq+4NUKzNETnCg/ZA0mO51Du1Z2vBEAODxA7TBNOgju8VWtRUlJFxKQGtkM52hAG+q2TQQE2K+4vq\nrTf5CMqP9mFlxWeG+zW7F4THrzjG6sBjziixwC5PWbi3wtIWMVZOiBZT1h6ZU7a8mwICLva4dDGgjsH9tcstASI2P5KTMBI6lytPWybQaM\nFskaXZqO6e21nfVnri+lmrPlBsAyGSsxVYncGcysRVpsPcBkmrgyTad06xXEQD4rIXHrB0NmzCbNpA7Lvk4tt8Cf2gDx4sbcFP1LIIEaso\nCiDiv2L0SiIna9HZeA06ocq311EzA5RhbgTtX25Eky/aL4WlixxtpzPZSAnTB1H/MzMrmqmb9WECxa0LdDQjQAAa0IaZr1WbgR5yzKZKNk\nvtjCpgb8R1Vt/b4lTFaAilyxGM0Aa2wRZj8BqZxrQbsCViV0Pmr2ncCfSwSpiQ72DGgdT+eewx4BxBCmHnsH8FubdYP3RpiWWs9MVDSwCM\nIwDnqEUVttiKhxHDYB/CEExzPvpzbEbMPYInXhJ4Bh7oAMvAAQ2aIWbB1FD1Ybvt1hsBh0zM3tuzMp9CuyVIkFJMLBAC+2kSlDAl7YvUVN\n8PTkOWh5iP6Ql19Dc9XiaKHD+cK99LepcUrSYdPCmk096+UYJ0T1Ru+FVHjAgEsFSlJ5STV1AMkexJ+Q8bEgc8BTGJgYZZzJILjIPSJhi7\nl+akTohFDgV4TCgV+ASHyE7oeCCilsKQdNfDYsLdjzmGnFD1nzM4ldT7AebBe2OL5DgE7lR9MwfVXQypcHQlryZmZAATJB3Bf2tXbvXfFk\nzuwPmxBCFrRexAcR3XHriPweG/Yxy0z44B3oFJIhM4VwRYco/4mfyCg5ceoPwMO+zBoPDkq6BxbsN84o33s6wrANYIPYwF8hQyBXDkS5k1\nOjASIwkmTDnsC6DiWtHyUsGMywL1QAq9h9qNtR9WOYCIZRJN4Lap4If/HSZIuC/wTaQAEEA53aYiREDVggODdA7CZZXgu6ekYBGEngI4zG\nDeARo2IfiX5NNcdF8BpjwN8auC1xxkWHwW8BpD7Q0DvvHzPAJWCjmuq45zyGPWP6oq6M2gGGK6zlUsIyvE8M49msAc4CRAE1Fqf5Jznvk5\nwqQ/ggVRecTaAQTt8FMiJWj0DdKrvPLPi8JaiZvDg0TzYIhGAAwzgVxYeqf6wWML+2/kzTxraEwnABdgegIPg8SeszRvwvSb7So6IGBlwJ\ngK9Id3lAdFEop+4wkQAsXZkFmxeE7cR+FMtnObtvHOA9HExDCZMAEAhvFGYzJSuAE97rwXMmDAPfJv4yuwa71/DbBdWeZw3Mpg5A0rI08J\nnIQJ8kkQekDwBdnN0gjGx6STEf9oQCuNM9aFymzwBPO8a8EiJ4RIwqikMCH0ihcRpHULjBkyEQQiICYm30S4scGKGiCNMHrykwjj9egn91\n0tUv9qmWS/BZIonR9qw1OJnFRKgKnJKLIr0qgF4Aipg48tIVn+sA3CWGsAaH8IAQRM0KZKcaQRoSKgURoPTJLp4AjTjC6W+Oz8gItZMhpb\nHjgCpobSADVUfQgDnRcC+r+UxKzg8SQ5ZYQxxSNyKN4EMQHfORwQJx+da+xdMgCTIRw9INudv0sMGzpAECNaoBKtcFatBgMtBa6JfAVy0/\nwg67itLdaq6zt6XIc9Y6Fqv945FYZC2tKd/+7iiMhBIGJHrMzAqv8w8xRDqf0HVAZwlHPs4nJ2UeC2S4AlWZCHZWVzTZ5YJzBUeF/5ZBn4\n34FgOJw9A3GupiSovN0XGOFaBorML4FNMlIJEP1QFIprLhvhOe2npxNoqAXqiPs0kfm3X5+3KihenmL1JJCChyiEhwr4PAR8iBGSi/hFIu\nSZFjibC7EftoJK8dZ4dM4QYy/9/bccmv7XrLIm3XrtUbquxKlwbCdF2s3/1Hew8xvUcB891hOtIyPUJo7H/qBXYvG0DJT0PDbgRq7XATyy\nHCYUCbR0U8EJA1AJf0CgskTnHbwZ+hbevkflos5yL/dA+fB5nUlj+4tQE/D/SgCxCfpPtky1Gjaq75XD44tNXbgEQzSIukhJZWIjTyautB\nx8JiWbCfQKdEPry1R/z9E2eKuxx75oQKNL88hlJEADLvQMY1Tb7zC/k6RsHehVUGm3iOM58zBTZs3kNKgrLBXtX9Zd8vwJOoTApDK5jvRB\nt8olQVD1fDI3LYcBWsXzC93p6TcXD1hKWwcEfsOFf4nlAx3UGROeleXa3Cly68hd+jklZ+fsBHwngZFT5HgEYbXR8oj2VJexzKYJKzBdi3\nVHiNSQ60Q0AciYRspw/VcX5X/S8gZ4/17qAfs/1bsC/GYoEsF0sZjIb0aGFslTiCzBXmKiE05jxcR67DoAhwKktYZM3PQkT+K9kqDCdjBA\n5wY1ejvpMMPsPJXwqnAP4dEkeTgaI7fGd0MS9UCnGOKRAABJtPPgTzKtwLhCNZhnAx9qva7U6RZ3hH3SPOce5osJWDlFZoNOAK7Qggu/8C\nlBveW8oC6vKyLZ8RNUEMr3jZPMLGsBCRqWqJEDVacpCBc9fZX4qe9WO+3DoAv4katgFEwgLouioiMdJlTMADUO1J5KWib2Q6olgJgHgica\nBatY8YWu1/012fyo175y/8vn/mUUCCiWMg3+8cHlAICFUZtbrddJXoYWZ452/V2m7jr36d3GQo2tLvvKgYhPMASe6DuaysEovs45NKzWfE\nqIF/t9NfpYjJOwl7XdcXFgMeVOIBJydnSX77lY328CQWAcE4EbHzCzhaIEAIBQsmf1YzFyR4wsgaj4LobrIPB5ZUcSFQsBnbwYNF4uhK7T\nAenv0KLUvRJWKJr684CMEPl4sOL743Q7FCcJjfI3Fbw8Y4VU3ak07/JEnEfWXFLROmkl9IZVS7DtI+xTw0q/EsoGFiB9//DG1DyVT3/fVv\nSgZmWgg5Og4RpPs1G/DQH3CErw64NAA2s0hA63w4ZE+Q4EEKe5bwYrqG/jgBC9qgTeH27dvJ3VQmtqU4XDYt474jLWYkHqhjuTvfBjFmgF\nNCCqPFgAe/xBJAnwN959KqGgV/c5kmTjya78TjERgEsbccrWqv/z8c9o/OBjq32SSr7pCArNuh/xGRRXa8DPk9ZjAGWCYccwgRIu42oTA5\nN8UY4oQR0SxRMjVBNmuJ8Js5uuvv+7MFHwMj6s5acWaNl6FfbE01PgXCm9zpyVr7B+zCNEBcMUVY88k29A+VqbytRpwlXmEjxJZb7Px1ma\ntGUaVS9Zmx4EcoodpyRqtQGhLP8Gn4PBYB5yiBY6guNXnIgCTkJOsLv4jqOaaj5NM9LuSHOWUlyEk4jCLTMXab3B8OFIvgPR+QhKrwHGro\nSr8fFoAGd4HsF7Hthk49opG4OVjfZ/j0rZt2+y4DbSgVSEZox/fnzO9izMPcDAEAp6LDDSBZMMGvml+gvjrFzokS+uUk2lHVOfdrJO2bjY\n6NFEmJxIgwAvA/TMrYL2wQcALb1ETmDGfpDDzDPaSLLAivMtbrVZpcX6+y0G6JlnpbAAaS14cAzhsgYCXQAL7uK4v7C8T8gpy9fl8npeNh\nJZ71L7ryUYhwUsKx+T7L5WASAJSEUjBWfK7bQCOIGi/S1lLazadTtPBwUF955179r+A9g9QXq13MV2qXtvxM4Fn+x+D0fC1BkndygAAAAB\nJRU5ErkJggg==";class ar extends e.Group{constructor(t){super(),this.scene=t||null,this.isGl2=!0,this.emitters=new Map,this.textures=new rr,this.loader=null,this.now=0,this.last=0,this.delta=0,this.elapsed=0,this.num=0,this.hscale=.5*window.innerHeight,this.luminosity=1,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}updateMatrixWorld(t){super.updateMatrixWorld(t),null===this.scene&&this.update()}get(t){return this.emitters.has(t)?this.emitters.get(t):null}add(t,e){if(t.isPoints)return void super.add(t);t.name||(t.name="PP"+this.num++),this.remove(t.name),t.model&&Js[t.model]&&(t={...Js[t.model],...t});let i=new sr(this,t);return this.emitters.set(t.name,i),i}remove(t){if("string"==typeof t||t instanceof String){if(!this.emitters.has(t))return;this.emitters.get(t).dispose(),this.emitters.delete(t)}else if(t.isPoints)return void super.remove(t)}addTexture(t,i,s=!0){this.textures.has(t)?console.log("this name of texture is already take !"):"string"==typeof i?(this.loader||(this.loader=new e.TextureLoader),this.loader.load(i,(i=>{i.flipY=!1,s&&(i.colorSpace=e.SRGBColorSpace),this.textures.add(t,i)}))):i.isTexture&&(i.flipY=!1,this.textures.add(t,i))}load(t){const e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));var i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=JSON.parse(i.responseText);for(let e in t)this.add(t[e])}else console.error("Couldn't load ["+e+"] ["+i.status+"]")}.bind(this),i.send()}resize(t){this.hscale=.5*t}onresize(t){this.hscale=.5*t}loop(t){this.delta=t,this.emitters.forEach((t=>{t.draw()}))}update(t){this.now=void 0!==t?t:Date.now(),this.delta=.001*(this.now-this.last),this.elapsed+=this.delta,this.last=this.now,this.emitters.forEach((t=>{t.draw()}))}dispose(t=!0){this.emitters.forEach((t=>{t.dispose()})),this.emitters.clear(),t&&this.textures.dispose(),this.num=0}addBlock(t,e){let i=t[1]<=4?-2:0,s=Js.getColor(e),r=s[0],o=s[1],a=s[2];s.length>3&&(r=s[3],o=s[4],a=s[5]),t[0]+=.5,t[2]+=.5,this.add({position:t,colors:[r,o,a,1,r,o,a,0],renderOrder:i,...Js.addBlock})}delBlock(t,e){let i=t[1]<=4?-2:0,s=Js.getColor(e),r=s[0],o=s[1],a=s[2];t[0]+=.5,t[2]+=.5,t[1]+=.5;let n=30;s.length>3&&(n=20,this.add({position:[t[0],t[1]+.375,t[2]],positionRange:[.5,.25,.5],colors:[r,o,a,.5,r,o,a,0],numParticles:10,renderOrder:i,...Js.removeBlock}),r=s[3],o=s[4],a=s[5]),this.add({position:t,positionRange:[.5,.5,.5],colors:[r,o,a,.5,r,o,a,0],numParticles:n,renderOrder:i,...Js.removeBlock})}removePlayerTrail(t){this.remove("PlayerTrail_"+t)}onPlayerWalk(t,e,i){let s=this.get("PlayerTrail_"+e);null===s&&(s=this.addTrail({name:"PlayerTrail_"+e,...Js.playerMove}));let r=t.toArray();r[1]+=.2;let o=Js.getColor(i),a=[o[0],o[1],o[2],.75,o[0],o[1],o[2],0];o.length>3&&(a=[o[0],o[1],o[2],.75,o[3],o[4],o[5],0]),s.birthParticles(r,a)}onVehicleDrive(t,e){let i=this.get("VehicleTrail_"+e);null===i&&(i=this.addTrail({name:"VehicleTrail_"+e,...Js.vehicleMove})),i.birthParticles(t.toArray())}onBazookaFire(t,e){let i=this.get("BazookaTrail_"+e);null===i&&(i=this.addTrail({name:"BazookaTrail_"+e,...Js.bazookaFire})),i.birthParticles(t.toArray())}onExplosion(t){this.add({position:t.toArray(),...Js.explosion})}}new e.Vector3,new e.Vector3,new e.Mesh(new e.SphereGeometry(.03),new e.MeshBasicMaterial({transparent:!0})),new e.Vector3,new e.Vector3,new e.Mesh(new e.SphereGeometry(.03),new e.MeshBasicMaterial({transparent:!0})),new e.PlaneGeometry;new e.CylinderGeometry(1,1,1).rotateX(Math.PI/2),new e.Object3D,new e.Vector3,new e.Vector3,new e.Color("red");const nr={PHY:"0.5.0",PHYSX:"5.06.10",HAVOK:"1.2.1",JOLT:"0.36.0",RAPIER:"0.16.2",OIMO:"1.2.4",AMMO:"3.2.6"};class lr{constructor(t={}){this.noBuffer=!0,this.geo=new G,this.mat=new K,this.math=w,this.pool=_,this.version=nr.PHY,this.Version=nr,this.engine="",this.jointVisible=!1,this.utils=new cr(this),this.collision=new Re(this),this.viewSize=null,this.debug=!1,this.delta=0,this.debuger=null,this.mouseActive=!1;const i=this;let s=null,r=!1,o=!1,a=!1,n=null,l=null,h=null,c=!1,u=!1,p=!1,m=!0,f=!1,g=null,y=!1,v={t1:0,t2:0,t3:0,t4:0},b=null,x=null,M=null,S=!1,k=!0,A=null,T=null,P=0,C=0,z="",R=null,E=null,L=null;const V=new tt,B=new $(60),I={start:0,end:0,startTime:""};let F=()=>0,D=()=>{},O=()=>{},N=()=>{},U=[],j=[],W=[],H=null;const X={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let Q=null,Y={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0,delta:0,ms:0},point:{},contact:{},velocity:{}};const J={};this.scene=null,this.scenePlus=null,this.ws=1,this.uws=1,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let t,e,i;for(t in this.tmpMesh){if(i=this.tmpMesh[t],i.children)for(e in i.children)this.disposeMesh(i.children[e]);this.disposeMesh(i),i.parent&&i.parent.remove(i)}for(t in this.tmpMesh=[],this.tmpTex)this.tmpTex[t].dispose();this.tmpTex=[]},this.disposeMesh=t=>{t.geometry&&t.geometry.dispose(),t.dispose&&t.dispose()},this.setStep=t=>{O=t},this.debugMode=t=>{this.setDebugMode(t)},this.setDebugMode=t=>{this.debug=t},this.useRealLight=t=>{this.mat.useRealLight(t)},this.getSetting=()=>X,this.setGravity=t=>{t&&(X.gravity=t),this.post({m:"setGravity",o:{gravity:X.gravity}})},this.set=(t={})=>{X.fixe=void 0===t.fixe||t.fixe,X.full=void 0!==t.full&&t.full,X.gravity=t.gravity?t.gravity:[0,-9.81,0],X.substep=t.substep?t.substep:1,X.fps=t.fps?t.fps:60,this.ws=void 0!==t.worldScale?t.worldScale:1,this.uws=1/this.ws,t.key&&N(),J.body.setFull(X.full),this.initArray(X.full),C=0,p=c,m=!p,this.jointVisible=t.jointVisible||!1,m&&B.setFramerate(X.fps);const e={...X,ArPos:Y,isTimeout:p,outsideStep:m};this.post({m:"set",o:e})},this.activeMouse=(t,e)=>{b||(b=new Fe(t,e,this)),this.mouseActive=!0},this.mouseMode=(t,e)=>{b&&b.setMode(t,e)},this.getTime=()=>$.now(),this.readTime=t=>$.format_time(t),this.startTime=()=>I.startTime,this.getTimeTest=()=>v,this.setMaxFps=t=>{},this.getMouse=()=>b?b.mouse:null,this.setMaxAnisotropy=t=>{_.maxAnisotropy=t},this.setAddControl=t=>{N=t},this.setPrevUpdate=t=>{},this.setPostUpdate=t=>{O=null!==t?t:()=>{}},this.setAzimut=t=>{F=t},this.setRenderer=t=>{E=t,_.renderer=E},this.setKey=(t,e)=>V.setKey(t,e),this.getKey=()=>V.key,this.getKey2=()=>V.key2,this.getAzimut=()=>F(),this.setContent=t=>{y||(L=t,L.add(this.scene),L.add(this.scenePlus),y=!0)},this.message=t=>{let e=t.data;e.Ar&&(Q=e.Ar),e.reflow&&(this.reflow=e.reflow,this.reflow.stat.delta&&(C+=this.reflow.stat.delta)),i[e.m](e.o)},this.worldScaler=t=>{const e=this.ws;if(t.pos&&(t.pos=w.worldscale(t.pos,e)),t.localPos&&(t.localPos=w.worldscale(t.localPos,e)),t.massCenter&&(t.massCenter=w.worldscale(t.massCenter,e)),t.pos1&&(t.pos1=w.worldscale(t.pos1,e)),t.pos2&&(t.pos2=w.worldscale(t.pos2,e)),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(t.shapes[s].size=w.worldscale(i.size,e)),i.pos&&(t.shapes[s].pos=w.worldscale(i.pos,e)),i.v&&(t.shapes[s].v=w.worldscale(i.v,e))}else t.size&&(t.size=w.worldscale(t.size,e)),t.v&&(t.v=w.worldscale(t.v,e))},this.post=(t,e=null,i=!1)=>{1!==this.ws&&("add"!==t.m&&"change"!==t.m||this.worldScaler(t.o)),c?(t.o&&("solver"===t.o.type&&(i=!0),void 0!==t.o.solver&&(i=!0)),i?h.postMessage(t,e):"add"===t.m?this.flow.add.push(t.o):"remove"===t.m?this.flow.remove.push(t.o):h.postMessage(t,e)):x({data:t})},this.addDebuger=()=>{if(null===this.debuger)return this.debuger=new ss(this),this.scenePlus.add(this.debuger),this.debuger},this.removeDebuger=()=>{null!==this.debuger&&(this.debuger.dispose(),this.debuger=null)},this.vehicle=t=>{let e;switch(t.type){case"raycar":e=new fs(t,this);break;case"kart":e=new Hs(t,this);break;case"helico":e=new Ws(t,this)}return e},this.autoRagdoll=t=>{const e=new is(t,this);return this.scene.add(e.model),e},this.byName=t=>this.utils.byName(t),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=t=>{this.viewSize=t,s&&s.resize(this.viewSize.h)},this.init=(t={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,I.start=$.now();const s=t.compact||!1;let a=document.location.href.replace(/\/[^/]*$/,"/"),n=a.split("/");a=n[0]+"//"+n[2]+"/","https://lo-th.github.io/"===a&&(a="https://lo-th.github.io/phy/");let p=t.path||"";p+=s?"compact/":"build/";let m=t.type||"PHYSX",f=m.toLowerCase(),g=f.charAt(0).toUpperCase()+f.slice(1);if(this.engine=m.toUpperCase(),this.initItems(),_.materialRoot=this.mat.set.bind(this.mat),t.callback&&(l=t.callback,delete t.callback),c=t.worker||!1,this.scene=new e.Group,this.scene.name="phy_scene",this.scenePlus=new e.Group,this.scenePlus.name="phy_scenePlus",t.scene&&(this.setContent(t.scene),delete t.scene),t.renderer&&(this.setRenderer(t.renderer),delete t.renderer),z=t.envmap||"",o=!!t.useModule&&this.supportModuleWorker(),r=t.useLocal||!1,_.useLocal=r,s)r?o?_.load(new URL("../"+p+g+".module.hex","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),(function(){i.onCompactDone(t)})):_.load(new URL("../"+p+g+".hex","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),(function(){i.onCompactDone(t)})):o?_.load(a+p+g+".module.hex",(function(){i.onCompactDone(t)})):_.load(a+p+g+".hex",(function(){i.onCompactDone(t)}));else if(c){if(h=r?o?new Worker(new URL("./"+g+".module.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),{type:"module"}):new Worker(new URL("./"+g+".min.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:d&&"SCRIPT"===d.tagName.toUpperCase()&&d.src||new URL("Phy.min.js",document.baseURI).href),{type:"classic"}):o?new Worker(a+p+g+".module.js",{type:"module"}):new Worker(a+p+g+".min.js"),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),u=!e.byteLength,t.isBuffer=u}this.initPhysics(t)}else t.devMode?this.preLoad(g,t,a):this.preLoadMin(g,t,a)},this.supportModuleWorker=()=>{let t=!1;const e={get type(){t=!0}};try{new Worker("data:,",e).terminate()}finally{return t}},this.onCompactDone=t=>{let e=this.engine.toLowerCase(),i=e.charAt(0).toUpperCase()+e.slice(1),s=o?_.get(i+".module","H"):_.get(i,"H");if(c){let e;try{e=new Blob([s],{type:"application/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,e=new BlobBuilder,e.append(s),e=e.getBlob()}if(h=o?new Worker(URL.createObjectURL(e),{type:"module"}):new Worker(URL.createObjectURL(e)),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),u=!e.byteLength,t.isBuffer=u}this.initPhysics(t)}else{let i=e.toUpperCase(),r=document.createElement("script");r.language="javascript",r.type="text/javascript",r.charset="utf-8",r.async=!0,r.innerHTML=s,document.getElementsByTagName("head")[0].appendChild(r),x=window[i].engine.message,t.message=this.message,this.initPhysics(t)}},this.loadWasmDirect=(t,e,i,s)=>{let r=document.createElement("script");r.src=s+t,document.body.appendChild(r),r.onload=()=>{this.preLoad(i,e,s)}},this.preLoadMin=(t,e,i)=>{let s=i+"build/"+t+".min.js",r=t.toUpperCase();var o=new XMLHttpRequest;o.open("GET",s),o.overrideMimeType("text/javascript"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){let t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.charset="utf-8",t.async=!0,t.innerHTML=o.responseText,document.getElementsByTagName("head")[0].appendChild(t),x=window[r].engine.message,e.message=this.message,this.initPhysics(e)}else console.error("Couldn't load ["+t+"] ["+o.status+"]")}.bind(this),o.send(null)},this.preLoad=async(t,e,i)=>{let s=i+"build/"+t+".module.js";e.devMode&&(s=i+"src/"+t+".js");let r=await import(s);x=r.engine.message,e.message=this.message,this.initPhysics(e)},this.initPhysics=t=>{""===z?(this.post({m:"init",o:t}),f=!0):this.preloadEnvmap(t)},this.addEnvmap=t=>(R||(R=new es({renderer:E,scene:L,...t})),R),this.preloadEnvmap=t=>{R=new es({url:z,renderer:E,scene:L,usePmrem:t.usePmrem,useBackground:void 0===t.useBackground||t.useBackground,envBlur:void 0!==t.envBlur?t.envBlur:0,callback:()=>{z="",this.initPhysics(t)}})},this.getPause=()=>S,this.pause=t=>{t!==S&&(S=t,S?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:S}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=t=>{if(k)return k=!1,void t();U=[],n=null,a=!1,M&&M.resetAll(),b&&b.unSelect(),s&&(s.dispose(),s=null),D=t,O=function(){},this.collision.reset(),this.clearText(),this.clearSoftSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.garbage=[],H=null,null!==g&&(g=null),null!==this.debuger&&this.removeDebuger(),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset",o:{}})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=t=>{this.reset(t)},this.resetCallback=()=>{D()},this.dispose=()=>{this.reset((()=>{h&&(h.terminate(),h=null),y&&(i.scene.parent.remove(i.scene),i.scenePlus.parent.remove(i.scenePlus),y=!1)}))},this.ready=()=>{I.end=$.now(),I.startTime=$.format_time(I.end-I.start),console.log("%c"+this.engine+" %c"+nr[this.engine]+"%c | "+(o?"Module ":"")+(c?"Worker":"Direct")+" "+I.startTime,"font-size:16px","font-size:12px","font-size:12px"),l&&l()},this.start=(t={})=>{this.post({m:"start",o:t})},this.morph=(t,e,i)=>{this.utils.morph(t,e,i)},this.getFps=()=>this.reflow.stat.fps,this.getMs=()=>this.reflow.stat.ms.toFixed(1),this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>C,this.setDelta=t=>{B.delta=t},this.getDelta=()=>B.delta,this.getElapsedTime=()=>B.elapsedTime,this.doStep=t=>{f&&m&&B.up(t)&&this.post({m:"step",o:t})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=V.update(),this.flow.current=null!==n?n.name:"",this.stepItems(),this.collision.step(),b&&b.step(),null!==n&&n.move(),null!==this.debuger&&this.debuger.draw();let t=m?B.delta:this.delta;O(t),this.changes(this.flow.tmp),u?this.post({m:"poststep",flow:this.flow,Ar:Q},[Q.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(t=!1)=>{Y={...q(this.engine,t)}},this.takeControl=(t=null)=>{this.control(t)},this.control=(t=null)=>{null!==n?null===t?(n.isPlayer&&(n.isPlayer=!1),n=null):t!==n.name&&(n=this.byName(t),n&&(n.isPlayer=!0)):null!==t&&(n=this.byName(t),n&&(n.isPlayer=!0))},this.getAllBody=t=>J.body.list,this.activeContact=()=>{a||(a=!0,this.post({m:"activeContact",o:{}}))},this.addCollision=t=>{this.collision.add(t)},this.removeCollision=t=>{this.collision.remove(t)},this.initItems=()=>{J.body=new _t(i),J.ray=new st(i),J.joint=new Ft(i),J.solid=new hr(i),J.contact=new Dt(i),J.terrain=new Ae(i),J.character=new ve(i),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(J.vehicle=new Ut(i)),"PHYSX"===this.engine&&(J.solver=new Pe(i))},this.getBodyRef=()=>J.body,this.getCharacterRef=()=>J.character,this.getGeometryRef=(t,e,i)=>{J.body.geometry(t,e,i)},this.clearBody=()=>{J.body.reset()},this.resetItems=()=>{Object.values(J).forEach((t=>t.reset()))},this.stepItems=()=>{Object.values(J).forEach((t=>t.step(Q,Y[t.type]))),this.upInstance(),this.upButton()},this.getTransform=t=>J.body.getTransform(t),this.upInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.dispose())),this.instanceMesh={}},this.adds=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.add(t[s++],e)},this.add=(t={},e=!1)=>{if(t.isObject3D)return this.addDirect(t);if(t.constructor===Array)return this.adds(t,e);if("container"===t.type)return new Ie(t,this);void 0!==t.bounce&&(t.restitution=t.bounce),void 0===t.type&&(t.type="box"),void 0!==t.mode&&(t.type="joint");let i=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.mass||t.density||t.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return t.type}}(t);"joint"===i&&void 0===t.mode&&(t.mode=t.type,t.type="joint");let s=J[i].add(t);return this.garbage.push(s.name),s},this.addDirect=t=>(this.scenePlus.add(t),this.tmpMesh.push(t),t),this.removes=(t=[],e)=>{let i=t.length,s=0;for(;i--;)this.remove(t[s++],e)},this.remove=(t,e=!1)=>{if(t.constructor===Array)return this.removes(t,e);let i=this.byName(t);null!==i?(this.removeCollision(t),"autoRagdoll"!==i.type?(i.extraRemove&&i.extraRemove(),J[i.type].clear(i),this.post({m:"remove",o:{name:t,type:i.type}},null,e)):this.utils.remove(i)):this.instanceMesh[t]&&J.body.clearInstance(t)},this.changes=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.changeOne(t[s++],e)},this.change=(t,e=!1)=>{e?t instanceof Array?this.changes(t,!0):this.changeOne(t,!0):t instanceof Array?this.flow.tmp.push(...t):this.flow.tmp.push(t)},this.changeOne=(t={},e=!1)=>{if(t.heightData)return;let i=this.byName(t.name);if(null===i)return null;let s=i.type;switch(t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=w.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot),void 0!==t.rot&&(t.quat=w.quatFromEuler(t.rot),delete t.rot),void 0!==t.localRot&&(t.quat=w.toLocalQuatArray(t.localRot,i),delete t.localRot),s){case"terrain":i=J.terrain.set(t,i),e=!1;break;case"ray":i=J.ray.set(t,i),e=!1;break;case"character":i=J.character.set(t,i);break;case"solid":i=J.solid.set(t,i);break;case"joint":i=J.joint.set(t,i);break;case"body":i.isKinematic||(i.actif&&!i.sleep||J.body.set(t,i),t.sleep&&J.body.set(t,i))}e&&this.post({m:"change",o:t},null,e)},this.setControl=t=>{M=t,F=M.getAzimuthalAngle},this.getControl=()=>M,this.getCurrentCharacterPosition=()=>M.followGroup.position,this.getCamera=(t={})=>M.object,this.setCamera=(t={})=>{M.moveCam(t)},this.follow=(t="",e={})=>{let i=null;"string"==typeof t||t instanceof String?i=""===t?null:this.byName(t):t.isObject3D&&(i=t),null===i?M.resetFollow():M.startFollow(i,e)},this.setTimeout=(t,e=0,i=!1)=>{i?A=setTimeout(t,e):(T=t,P=e,A=setTimeout(T,P))},this.playtimout=()=>{null!==T&&(A=setTimeout(T,P))},this.pausetimout=()=>{null!==A&&clearTimeout(A)},this.cleartimout=(t,e)=>{null!==A&&(T=null,P=0,clearTimeout(A),A=null)},this.texture=(t={})=>_.texture(t),this.getTexture=(t,e={})=>_.getTexture(t,e),this.setExtendShader=t=>{this.mat.extendShader=t},this.addMaterial=(t,e)=>{this.mat.set(t,e)},this.directIntensity=t=>{},this.setEnvmapIntensity=t=>{},this.getMatRef=()=>this.mat,this.getMat=t=>this.mat.get(t),this.getMaterial=t=>this.mat.get(t),this.getMaterialList=()=>this.mat.getList(),this.material=(t={})=>this.mat.create(t),this.changeRenderMode=t=>this.mat.changeRenderMode(t),this.load=_.load,this.get=_.get,this.getGroup=_.getGroup,this.getScript=_.getScript,this.preload=(t,e)=>{fe.add(t,e)},this.applyMorph=(t,e=null,i=!0,s=!0)=>{_.applyMorph(t,null,!0,!0)},this.getMesh=(t,e,i)=>{if(e){let e=_.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return _.getMesh(t,i)},this.getGlb=(t,e,i)=>{if(e){let e=_.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return _.getGLB(t,i)},this.getGlbMaterial=t=>{let e=_.getMaterials(t);return this.mat.addToMat(e),e},this.poolDispose=()=>_.dispose(),this.setDracoPath=t=>_.dracoPath=t,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addSoftSolver=t=>{let e=new xi(t,this);return W.push(e),e},this.updateSoftSolver=()=>{let t=W.length;for(;t--;)W[t].update()},this.clearSoftSolver=()=>{W.length,W=[]},this.addButton=t=>{let e=new Le(t,this);return U.push(e),e},this.upButton=t=>{for(const t in U)U[t].update()},this.addText=t=>{let e=new Ee(t);return t.parent?t.parent.add(e):this.scenePlus.add(e),j.push(e),e},this.clearText=()=>{let t=j.length;for(;t--;)j[t].dispose();j=[]},this.screenshot=()=>{var t=window.open("","");t.document.title="Screenshot",t.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var e=new Image;E.render(L,this.getCamera()),e.src=E.domElement.toDataURL(),t.document.body.appendChild(e)},this.getBreaker=()=>(null!==g||(g=new mi(this)),g),this.setColorChecker=t=>{H=t},this.getColorChecker=()=>H,this.addWiggle=(t={})=>{},this.initParticleEngine=()=>{s||(s=new ar,this.scene.add(s))},this.addParticle=(t={})=>(null===s&&this.initParticleEngine(),s.add(t)),this.getParticle=t=>null===s?null:s.get(t),this.explosion=(t=[0,0,0],i=10,s=1)=>{let r=[],o=new e.Vector3;t&&(t.isVector3?o.copy(t):o.fromArray(t));let a,n,l=new e.Vector3,h=J.body.list.length;for(;h--;)a=J.body.list[h],l.copy(a.position).sub(o),n=1-l.length()/i,a.isKinematic||n<0||(l.setLength(n),l.multiplyScalar(s),r.push({name:a.name,impulse:l.toArray(),wake:!0}));this.change(r)}}set onStep(t){this.setStep(t)}}class hr extends _t{constructor(t){super(t),this.type="solid"}step(){}}class cr{constructor(t){this.map=new Map,this.motor=t}byName(t){return this.map.has(t)?this.map.get(t):null}add(t,e){if("contact"!==t.type&&!t.isInstance&&t.isObject3D)if(e)e.add(t);else if(t.isButton)this.motor.scene.add(t);else switch(t.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(t);break;default:this.motor.scene.add(t)}t.isInstance&&t.refName!==t.name&&this.map.set(t.refName,t),this.map.set(t.name,t)}remove(t){t.dispose&&t.dispose(),t.parent&&t.parent.remove(t),t.isInstance&&(t.refName!==t.name&&this.map.delete(t.refName),t.instance.remove(t.idx)),this.map.delete(t.name)}noRay(t){t.isObject3D&&(t.raycast=()=>{},t.traverse((t=>{t.isObject3D&&(t.raycast=()=>{})})))}morph(t,e,i){t.morphTargetInfluences&&void 0!==t.morphTargetDictionary[e]&&(t.morphTargetInfluences[t.morphTargetDictionary[e]]=i)}toLocal(t,e,i=!1){i||t.sub(e.position);let s=e.quaternion;return t.applyQuaternion({x:-s._x,y:-s._y,z:-s._z,w:s._w}),t}quatLocal(t,i){i.isObject3D&&i.updateWorldMatrix(!0,!1);let s=(new e.Quaternion).fromArray(t),r=i.quaternion.clone().invert();return s.premultiply(r),s.normalize().toArray()}axisLocal(t,i){i.isObject3D&&i.updateWorldMatrix(!0,!1);let s=(new e.Matrix3).setFromMatrix4(i.matrixWorld);return(new e.Vector3).fromArray(t).applyMatrix3(s).toArray()}quatToAngular(t,i){i[0]*=-1,i[1]*=-1,i[2]*=-1;let s,r=i[0]*t[3]+i[3]*t[0]+i[1]*t[2]-i[2]*t[1],o=i[1]*t[3]+i[3]*t[1]+i[2]*t[0]-i[0]*t[2],a=i[2]*t[3]+i[3]*t[2]+i[0]*t[1]-i[1]*t[0],n=i[3]*t[3]-i[0]*t[0]-i[1]*t[1]-i[2]*t[2],l=2*Math.acos(n),h=Math.sqrt(1-n*n);s=h<.001?[0,0,0]:[r/h,o/h,a/h];(new e.Vector3).fromArray(s).multiplyScalar(l/1)}refAxis(t,i){let s=(new e.Vector3).fromArray(i),r=new e.Vector3(1,0,0),o=new e.Vector3(0,1,0);Math.abs(i[1])>.9999||r.copy(s).cross(o).normalize(),o.copy(r).cross(s).normalize(),t.makeBasis(r,o,s)}}const ur=new lr,dr=lr,pr=w,mr=_;t.math=pr,t.phy=ur,t.phy2=dr,t.pool=mr}));
