import{Loader as t,FileLoader as e,SRGBColorSpace as i,LinearSRGBColorSpace as s,BufferGeometry as r,BufferAttribute as n,Color as a,Float32BufferAttribute as l,LoadingManager as h,EquirectangularReflectionMapping as c,Mesh as u,AnimationMixer as d,RepeatWrapping as p,NearestFilter as f,Texture as g,TextureLoader as y,ObjectSpaceNormalMap as v,LineSegments as w,LineBasicMaterial as b,SphereGeometry as x,CylinderGeometry as M,BoxGeometry as k,PlaneGeometry as S,CanvasTexture as A,MeshPhysicalMaterial as T,Vector2 as z,MeshStandardMaterial as P,ShadowMaterial as C,MeshToonMaterial as R,MeshBasicMaterial as E,MeshLambertMaterial as _,MeshPhongMaterial as L,DoubleSide as I,BackSide as O,FrontSide as D,SrcAlphaSaturateFactor as F,OneMinusDstColorFactor as B,DstColorFactor as N,OneMinusDstAlphaFactor as U,DstAlphaFactor as V,OneMinusSrcAlphaFactor as q,SrcAlphaFactor as W,OneMinusSrcColorFactor as j,SrcColorFactor as H,OneFactor as G,ZeroFactor as X,MaxEquation as Q,MinEquation as Y,ReverseSubtractEquation as J,SubtractEquation as Z,AddEquation as K,MultiplyBlending as $,SubtractiveBlending as tt,AdditiveBlending as et,NormalBlending as it,NoBlending as st,Line as rt,Vector3 as nt,Matrix4 as at,InstancedMesh as ot,Quaternion as lt,InstancedBufferAttribute as ht,CircleGeometry as ct,Box3 as ut,Line3 as dt,Plane as pt,Triangle as mt,Object3D as ft,Matrix3 as gt,Box2 as yt,ShapeUtils as vt,Shape as wt,Path as bt,ShapePath as xt,ShapeGeometry as Mt,Euler as kt,Vector4 as St,CustomBlending as At,Group as Tt,SkeletonHelper as zt,AnimationClip as Pt,AnimationUtils as Ct,VectorKeyframeTrack as Rt,QuaternionKeyframeTrack as Et,AdditiveAnimationBlendMode as _t,NormalAnimationBlendMode as Lt,Raycaster as It,Sphere as Ot,DataTextureLoader as Dt,HalfFloatType as Ft,FloatType as Bt,DataUtils as Nt,LinearFilter as Ut,RGBAFormat as Vt,RedFormat as qt,NoColorSpace as Wt,PMREMGenerator as jt,Scene as Ht,WebGLCubeRenderTarget as Gt,CubeCamera as Xt,IcosahedronGeometry as Qt,ShaderMaterial as Yt,NoToneMapping as Jt,AxesHelper as Zt,Skeleton as Kt,MathUtils as $t,Points as te,InstancedBufferGeometry as ee,InterleavedBuffer as ie,InterleavedBufferAttribute as se,InstancedInterleavedBuffer as re,DynamicDrawUsage as ne,DataTexture as ae}from"three";import{GLTFLoader as oe}from"three/addons/loaders/GLTFLoader.js";import{FBXLoader as le}from"three/addons/loaders/FBXLoader.js";import{OBJLoader as he}from"three/addons/loaders/OBJLoader.js";import{STLLoader as ce}from"three/addons/loaders/STLLoader.js";import{RGBELoader as ue}from"three/addons/loaders/RGBELoader.js";import{EXRLoader as de}from"three/addons/loaders/EXRLoader.js";import{MeshoptDecoder as pe}from"three/addons/libs/meshopt_decoder.module.js";import"three/addons/loaders/UltraHDRLoader.js";import{KTX2Loader as me}from"three/addons/loaders/KTX2Loader.js";const fe=Math.PI,ge=fe/180,ye=180/fe,ve=Number.EPSILON,we=.5*fe,be={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:t=>Math.pow(t,5),candelaToLumens:t=>4*t*Math.PI,lumensToCandela:t=>t/(4*Math.PI),todeg:ye,torad:ge,toFixed:(t,e=3)=>1*t.toFixed(e),toRound:(t,e=3)=>Math.trunc(t),clamp:(t,e=0,i=1)=>t=(t=t<e?e:t)>i?i:t,clampA:(t,e,i)=>Math.max(e,Math.min(i,t)),smoothstep:(t,e,i)=>t*(i=-2*(i=be.clamp(i))*i*i+3*i*i)+e*(1-i),remap:(t,e,i,s,r)=>s+(t-e)*(r-s)/(i-e),lerp:(t,e,i)=>(1-i)*t+i*e,damp:(t,e,i,s)=>be.lerp(t,e,1-Math.exp(-i*s)),nearAngle:(t,e,i=!1)=>e+Math.atan2(Math.sin(t-e),Math.cos(t-e))*(i?ye:1),unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),nearEquals:(t,e,i=1e-4)=>Math.abs(t-e)<=i,autoSize:(t=[1,1,1],e="box")=>{1===t.length&&(t[1]=t[0]);let i=t[0],s=t[1];return"sphere"===e&&(t=[i,i,i]),"cylinder"!==e&&"wheel"!==e&&"capsule"!==e||(t=[i,s,i]),"cone"!==e&&"pyramid"!==e||(t=[i,s,i]),2===t.length&&(t[2]=t[0]),t},shuffle:t=>{let e=t.map((t=>({value:t,sort:Math.random()}))).sort(((t,e)=>t.sort-e.sort)).map((({value:t})=>t));return e},randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),randIntUnic:(t,e,i)=>{for(var s=[];s.length<i;){var r=be.randInt(t,e);-1===s.indexOf(r)&&s.push(r)}return s},fromTransform:(t,e,i,s=[0,0,0,1],r=!1)=>{let n=be.composeMatrixArray(t,e),a=be.composeMatrixArray(i,s);return r&&(n=be.invertMatrixArray(n)),n=be.multiplyMatrixArray(n,a),[n[12],n[13],n[14]]},fromTransformToQ:(t,e,i=!1)=>{let s=be.composeMatrixArray(t,e),r=be.decomposeFullMatrixArray(s).q;return i&&(r=be.quatInvert(r)),r},lerpTransform:(t,e,i)=>{let s=t[0],r=t[1],n=e[0],a=e[1];return n=be.lerpArray(s,n,i),a=be.slerpQuatArray(r,a,i),[n,a]},composeMatrixArray:(t,e,i=[1,1,1])=>{const s=e[0],r=e[1],n=e[2],a=e[3],o=s+s,l=r+r,h=n+n,c=s*o,u=s*l,d=s*h,p=r*l,m=r*h,f=n*h,g=a*o,y=a*l,v=a*h,w=i[0],b=i[1],x=i[2];return[(1-(p+f))*w,(u+v)*w,(d-y)*w,0,(u-v)*b,(1-(c+f))*b,(m+g)*b,0,(d+y)*x,(m-g)*x,(1-(c+p))*x,0,t[0],t[1],t[2],1]},multiplyMatrixArray:(t,e)=>{const i=t,s=e,r=[],n=i[0],a=i[4],o=i[8],l=i[12],h=i[1],c=i[5],u=i[9],d=i[13],p=i[2],m=i[6],f=i[10],g=i[14],y=i[3],v=i[7],w=i[11],b=i[15],x=s[0],M=s[4],k=s[8],S=s[12],A=s[1],T=s[5],z=s[9],P=s[13],C=s[2],R=s[6],E=s[10],_=s[14],L=s[3],I=s[7],O=s[11],D=s[15];return r[0]=n*x+a*A+o*C+l*L,r[4]=n*M+a*T+o*R+l*I,r[8]=n*k+a*z+o*E+l*O,r[12]=n*S+a*P+o*_+l*D,r[1]=h*x+c*A+u*C+d*L,r[5]=h*M+c*T+u*R+d*I,r[9]=h*k+c*z+u*E+d*O,r[13]=h*S+c*P+u*_+d*D,r[2]=p*x+m*A+f*C+g*L,r[6]=p*M+m*T+f*R+g*I,r[10]=p*k+m*z+f*E+g*O,r[14]=p*S+m*P+f*_+g*D,r[3]=y*x+v*A+w*C+b*L,r[7]=y*M+v*T+w*R+b*I,r[11]=y*k+v*z+w*E+b*O,r[15]=y*S+v*P+w*_+b*D,r},invertMatrixArray:t=>{const e=t,i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],m=e[12],f=e[13],g=e[14],y=e[15],v=u*g*h-f*d*h+f*l*p-o*g*p-u*l*y+o*d*y,w=m*d*h-c*g*h-m*l*p+a*g*p+c*l*y-a*d*y,b=c*f*h-m*u*h+m*o*p-a*f*p-c*o*y+a*u*y,x=m*u*l-c*f*l-m*o*d+a*f*d+c*o*g-a*u*g,M=i*v+s*w+r*b+n*x;if(0===M)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const k=1/M;return e[0]=v*k,e[1]=(f*d*n-u*g*n-f*r*p+s*g*p+u*r*y-s*d*y)*k,e[2]=(o*g*n-f*l*n+f*r*h-s*g*h-o*r*y+s*l*y)*k,e[3]=(u*l*n-o*d*n-u*r*h+s*d*h+o*r*p-s*l*p)*k,e[4]=w*k,e[5]=(c*g*n-m*d*n+m*r*p-i*g*p-c*r*y+i*d*y)*k,e[6]=(m*l*n-a*g*n-m*r*h+i*g*h+a*r*y-i*l*y)*k,e[7]=(a*d*n-c*l*n+c*r*h-i*d*h-a*r*p+i*l*p)*k,e[8]=b*k,e[9]=(m*u*n-c*f*n-m*s*p+i*f*p+c*s*y-i*u*y)*k,e[10]=(a*f*n-m*o*n+m*s*h-i*f*h-a*s*y+i*o*y)*k,e[11]=(c*o*n-a*u*n-c*s*h+i*u*h+a*s*p-i*o*p)*k,e[12]=x*k,e[13]=(c*f*r-m*u*r+m*s*d-i*f*d-c*s*g+i*u*g)*k,e[14]=(m*o*r-a*f*r-m*s*l+i*f*l+a*s*g-i*o*g)*k,e[15]=(a*u*r-c*o*r+c*s*l-i*u*l-a*s*d+i*o*d)*k,e},matrixArrayDeterminant:t=>{const e=t,i=e[0],s=e[4],r=e[8],n=e[12],a=e[1],o=e[5],l=e[9],h=e[13],c=e[2],u=e[6],d=e[10],p=e[14];return e[3]*(+n*l*u-r*h*u-n*o*d+s*h*d+r*o*p-s*l*p)+e[7]*(+i*l*p-i*h*d+n*a*d-r*a*p+r*h*c-n*l*c)+e[11]*(+i*h*u-i*o*p-n*a*u+s*a*p+n*o*c-s*h*c)+e[15]*(-r*o*c-i*l*u+i*o*d+r*a*u-s*a*d+s*l*c)},decomposeMatrixArray:t=>[t[12],t[13],t[14]],decomposeFullMatrixArray:t=>{const e=t;let i=be.lengthArray([e[0],e[1],e[2]]);const s=be.lengthArray([e[4],e[5],e[6]]),r=be.lengthArray([e[8],e[9],e[10]]);be.matrixArrayDeterminant(t)<0&&(i=-i);let n=[...t];const a=1/i,o=1/s,l=1/r;n[0]*=a,n[1]*=a,n[2]*=a,n[4]*=o,n[5]*=o,n[6]*=o,n[8]*=l,n[9]*=l,n[10]*=l;let h=be.quatFromRotationMatrix(n);return{p:[t[12],t[13],t[14]],q:h,s:[i,s,r]}},applyTransformArray:(t,e,i,s=[1,1,1])=>{const r=be.composeMatrixArray(e,i,s),n=t[0],a=t[1],o=t[2],l=1/(r[3]*n+r[7]*a+r[11]*o+r[15]);return[(r[0]*n+r[4]*a+r[8]*o+r[12])*l,(r[1]*n+r[5]*a+r[9]*o+r[13])*l,(r[2]*n+r[6]*a+r[10]*o+r[14])*l]},slerpQuatArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=[...t];const r=t[0],n=t[1],a=t[2],o=t[3],l=e[0],h=e[1],c=e[2],u=e[3];let d=o*u+r*l+n*h+a*c;if(d<0?(s=[-l,-h,-c,-u],d=-d):s=[...e],d>=1)return t;const p=1-d*d;if(p<=ve){const t=1-i;return s[3]=t*o+i*s[3],s[0]=t*r+i*s[0],s[1]=t*n+i*s[1],s[2]=t*a+i*s[2],be.quatNomalize(s)}const m=Math.sqrt(p),f=Math.atan2(m,d),g=Math.sin((1-i)*f)/m,y=Math.sin(i*f)/m;return s[3]=o*g+s[3]*y,s[0]=r*g+s[0]*y,s[1]=n*g+s[1]*y,s[2]=a*g+s[2]*y,s},toLocalQuatArray:(t=[0,0,0],e)=>{let i=be.quatFromEuler(t),s=be.quatInvert(e.quaternion.toArray());return be.quatMultiply(s,i)},quatFromRotationMatrix:t=>{let e=[0,0,0,1];const i=t,s=i[0],r=i[4],n=i[8],a=i[1],o=i[5],l=i[9],h=i[2],c=i[6],u=i[10],d=s+o+u;if(d>0){const t=.5/Math.sqrt(d+1);e[3]=.25/t,e[0]=(c-l)*t,e[1]=(n-h)*t,e[2]=(a-r)*t}else if(s>o&&s>u){const t=2*Math.sqrt(1+s-o-u);e[3]=(c-l)/t,e[0]=.25*t,e[1]=(r+a)/t,e[2]=(n+h)/t}else if(o>u){const t=2*Math.sqrt(1+o-s-u);e[3]=(n-h)/t,e[0]=(r+a)/t,e[1]=.25*t,e[2]=(l+c)/t}else{const t=2*Math.sqrt(1+u-s-o);e[3]=(a-r)/t,e[0]=(n+h)/t,e[1]=(l+c)/t,e[2]=.25*t}return e},quatFromEuler:(t=[0,0,0],e=!0)=>{const i=Math.cos,s=Math.sin,r=e?ge:1,n=t[0]*r*.5,a=t[1]*r*.5,o=t[2]*r*.5,l=i(n),h=i(a),c=i(o),u=s(n),d=s(a),p=s(o);return[u*h*c+l*d*p,l*d*c-u*h*p,l*h*p+u*d*c,l*h*c-u*d*p]},quatFromAxis:(t=[0,0,0],e,i=!0)=>{const s=.5*e*(i?ge:1),r=Math.sin(s);return[t[0]*r,t[1]*r,t[2]*r,Math.cos(s)]},quatNomalize:t=>{let e=be.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,be.scaleArray(t,e,4))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const i=t[0],s=t[1],r=t[2],n=t[3],a=e[0],o=e[1],l=e[2],h=e[3];return[i*h+n*a+s*l-r*o,s*h+n*o+r*a-i*l,r*h+n*l+i*o-s*a,n*h-i*a-s*o-r*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const i=Math.sqrt(1-t[3]*t[3]);return i<1e-4?[1,0,0]:[t[0]/i,t[1]/i,t[2]/i,e]},eulerFromMatrix:t=>{const e=t[0],i=t[4],s=t[8];t[1];const r=t[5],n=t[9];t[2];const a=t[6],o=t[10];let l=[0,0,0];return l[1]=Math.asin(be.clamp(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(-n,o),l[2]=Math.atan2(-i,e)):(l[0]=Math.atan2(a,r),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(be.clamp(be.dotArray(t,e),-1,1))),fixedArray:(t,e)=>{let i=t.length,s=[];for(;i--;)s[i]=be.toFixed(t[i],e);return s},getSize:t=>.001*t.byteLength+"kb",perpendicularArray:t=>{const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);let i=Math.acos(t[1]/e);const s=Math.atan2(t[2],t[0]);i>we?i-=we:i+=we;return[e*Math.sin(i)*Math.cos(s),e*Math.cos(i),e*Math.sin(i)*Math.sin(s)]},crossArray:(t,e)=>{const i=t[0],s=t[1],r=t[2],n=e[0],a=e[1],o=e[2];return[s*o-r*a,r*n-i*o,i*a-s*n]},applyQuaternion:(t,e)=>{const i=t[0],s=t[1],r=t[2],n=e[0],a=e[1],o=e[2],l=e[3],h=2*(a*r-o*s),c=2*(o*i-n*r),u=2*(n*s-a*i);return[i+l*h+a*u-o*c,s+l*c+o*h-n*u,r+l*u+n*c-a*h]},nullArray:(t,e,i)=>{let s=0;for(;i--;)s+=t[e+i];return s},equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},lerpArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=t.length,r=[];for(;s--;)r[s]=t[s],r[s]+=(e[s]-r[s])*i;return r},zeroArray:(t,e=0,i)=>{for(i=i??t.length;i--;)t[e+i]=0;return t},lengthArray:t=>{let e=t.length,i=0;for(;e--;)i+=t[e]*t[e];return Math.sqrt(i)},dotArray:(t,e)=>{let i=t.length,s=0;for(;i--;)s+=t[i]*e[i];return s},addArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]+e[i];return s},subArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]-e[i];return s},mulArray:(t,e,i)=>{if(e instanceof Array){let s=[];for(i=i??t.length;i--;)s[i]=t[i]*e[i];return s}return t.map((t=>t*e))},worldscale:(t,e)=>t.map((t=>t*e)),divArray:(t,e,i)=>be.mulArray(t,1/e,i),scaleArray:(t,e,i)=>be.mulArray(t,e,i),fillArray:(t,e,i=0,s)=>{for(s=s??t.length;s--;)e[i+s]=t[s]},copyArray:(t,e)=>{},cloneArray:t=>[...t],distanceArray:(t,e=[0,0,0])=>be.lengthArray(be.subArray(t,e)),normalizeArray:t=>be.divArray(t,be.lengthArray(t)||1),normalArray:(t,e=[0,0,0])=>be.normalizeArray(be.subArray(e,t)),getCenter:(t,e)=>(t.computeBoundingBox(),t.boundingBox.getCenter(e)),getVolume:(t,e,i=null)=>{let s=1,r=e;switch(t){case"sphere":s=4*Math.PI*r[0]*r[0]*r[0]/3;break;case"cone":s=Math.PI*r[0]*(.5*r[1])*2;break;case"box":s=.5*r[0]*8*(.5*r[1])*(.5*r[2]);break;case"cylinder":s=Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"capsule":s=4*Math.PI*r[0]*r[0]*r[0]/3+Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"convex":case"mesh":s=be.getConvexVolume(i)}return s},getConvexVolume:t=>{let e,i=t.length/3,s=[0,0,0],r=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>r[0]&&(r[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>r[1]&&(r[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>r[2]&&(r[2]=t[e+2]);let n=[r[0]-s[0],r[1]-s[1],r[2]-s[2]];return.5*n[0]*8*(.5*n[1])*(.5*n[2])},massFromDensity:(t,e)=>t*e,densityFromMass:(t,e)=>t/e,toNonIndexed:t=>t.index?t.clone().toNonIndexed():t,getIndex:(t,e)=>!t.index||e?null:t.index.array||null,getSameVertex:t=>{const e=t.getAttribute("position"),i=e.array,s=[],r=[],n={};new THREE.Vector3;let a,o=0;be.getHash(t);let l,h,c=!1,u=0;for(let t=0;t<e.count;t++){o=3*t,l={x:i[o],y:i[o+1],z:i[o+2],id:t},c=!1,a=s.length;for(let e=0;e<a;e++)h=s[e],l.x===h.x&&l.y===h.y&&l.z===h.z&&(c=!0,n[t]=h.id);c||(l.id=u++,s.push(l),r.push([l.x,l.y,l.z]))}return[r,n]},getVertex:(t,e)=>{let i=t.attributes.position.array;return e&&t.index&&(i=(t=t.clone().toNonIndexed()).attributes.position.array),i},getNormal:t=>t.attributes.normal.array,getFaces:t=>{let e=[];if(t.index){let i=t.getIndex();for(let t=0;t<i.count;t+=3)e.push([i.getX(t),i.getX(t+1),i.getX(t+2)])}else{let i=t.getAttribute("position").count;for(let t=0;t<i;t+=3)e.push([t,t+1,t+2])}return e},getConnectedFaces:t=>{const e=[];let i,s,r,n,a,o,l,h=t.length,c=h;for(;c--;)for(s=t[c],i=h;i--;)i!==c&&(r=t[i],n=s.filter((t=>r.includes(t))),n.length>1&&(l=[],a=[...s],o=a.indexOf(n[0]),a.splice(o,1),o=a.indexOf(n[1]),a.splice(o,1),l.push(a[0]),a=[...r],o=a.indexOf(n[0]),a.splice(o,1),o=a.indexOf(n[1]),a.splice(o,1),l.push(a[0]),e.push(l)));return e},reduce:t=>{},barycentric:(t,e)=>{},solve:(t,e)=>{},getHash:(t,e=1e-4)=>{e=Math.max(e,Number.EPSILON);const i={},s={},r=t.getAttribute("position"),n=r.count,a=r.array,o=.5*e,l=Math.log10(1/e),h=Math.pow(10,l),c=o*h;let u;for(let t=0;t<n;t++){u=3*t;let e=`${~~(a[u]*h+c)},${~~(a[u+1]*h+c)},${~~(a[u+2]*h+c)}`;i[e]?i[e].push(t):i[e]=[t]}let d=0;for(let t in i)s[d++]=i[t];return s}},xe=be,Me=new WeakMap;class ke extends t{constructor(t){super(t),this.useLocal=!1,this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setUseLocal(t){return this.useLocal=t,this}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,i,s,r){const n=new e(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(t,(t=>{this.parse(t,i,r)}),s,r)}parse(t,e,s){this.decodeDracoFile(t,e,null,null,i).catch(s)}decodeDracoFile(t,e,i,r,n=s){const a={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:r||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:n};return this.decodeGeometry(t,a).then(e)}decodeGeometry(t,e){const i=JSON.stringify(e);if(Me.has(t)){const e=Me.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const r=this.workerNextTaskID++,n=t.byteLength,a=this._getWorker(r,n).then((i=>(s=i,new Promise(((i,n)=>{s._callbacks[r]={resolve:i,reject:n},s.postMessage({type:"decode",id:r,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return a.catch((()=>!0)).then((()=>{s&&r&&this._releaseTask(s,r)})),Me.set(t,{key:i,promise:a}),a}_createGeometry(t){const e=new r;t.index&&e.setIndex(new n(t.index.array,1));for(let i=0;i<t.attributes.length;i++){const s=t.attributes[i],r=s.name,a=s.array,o=s.itemSize,l=new n(a,o);"color"===r&&(this._assignVertexColorSpace(l,s.vertexColorSpace),l.normalized=a instanceof Float32Array==!1),e.setAttribute(r,l)}return e}_assignVertexColorSpace(t,e){if(e!==i)return;const s=new a;for(let e=0,i=t.count;e<i;e++)s.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,s.r,s.g,s.b)}_loadLibrary(t,i){const s=new e(this.manager);return s.setPath(this.decoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_decoder.js",import.meta.url),"text"))):t.push(this._loadLibrary("draco_decoder.js","text")):this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_wasm_wrapper.js",import.meta.url),"text"))):t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(t).then((t=>{const e=t[0],i=Se.toString(),s=["/* draco decoder */",e,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function Se(){let t,e;function i(t,e,i,s,r,n){const a=n.num_components(),o=i.num_points()*a,l=o*r.BYTES_PER_ELEMENT,h=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,r),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(i,n,h,l,c);const u=new r(t.HEAPF32.buffer,c,o).slice();return t._free(c),{name:s,array:u,itemSize:a}}onmessage=function(s){const r=s.data;switch(r.type){case"init":t=r.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const s=r.buffer,n=r.taskConfig;e.then((t=>{const e=t.draco,a=new e.Decoder;try{const t=function(t,e,s,r){const n=r.attributeIDs,a=r.attributeTypes;let o,l;const h=e.GetEncodedGeometryType(s);if(h===t.TRIANGULAR_MESH)o=new t.Mesh,l=e.DecodeArrayToMesh(s,s.byteLength,o);else{if(h!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new t.PointCloud,l=e.DecodeArrayToPointCloud(s,s.byteLength,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const s in n){const l=self[a[s]];let h,u;if(r.useUniqueIDs)u=n[s],h=e.GetAttributeByUniqueId(o,u);else{if(u=e.GetAttributeId(o,t[n[s]]),-1===u)continue;h=e.GetAttribute(o,u)}const d=i(t,e,o,s,l,h);"color"===s&&(d.vertexColorSpace=r.vertexColorSpace),c.attributes.push(d)}h===t.TRIANGULAR_MESH&&(c.index=function(t,e,i){const s=i.num_faces(),r=3*s,n=4*r,a=t._malloc(n);e.GetTrianglesUInt32Array(i,n,a);const o=new Uint32Array(t.HEAPF32.buffer,a,r).slice();return t._free(a),{array:o,itemSize:1}}(t,e,o));return t.destroy(o),c}(e,a,new Int8Array(s),n),o=t.attributes.map((t=>t.array.buffer));t.index&&o.push(t.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:t},o)}catch(t){console.error(t),self.postMessage({type:"error",id:r.id,error:t.message})}finally{e.destroy(a)}}))}}}let Ae=0;class Te extends me{constructor(t){super(t),this.useLocal=!1}setUseLocal(t){return this.useLocal=t,this}_loadLibrary(t,i){const s=new e(this.manager);return s.setPath(this.transcoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}init(){if(!this.transcoderPending){let t,e;this.useLocal?(this.transcoderPath="",t=this._loadLibrary(new URL("../build/basis/basis_transcoder.js",import.meta.url),"text"),e=this._loadLibrary(new URL("../build/basis/basis_transcoder.wasm",import.meta.url),"arraybuffer")):(t=this._loadLibrary("basis_transcoder.js","text"),e=this._loadLibrary("basis_transcoder.wasm","arraybuffer")),this.transcoderPending=Promise.all([t,e]).then((([t,e])=>{const i=Te.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(Te.EngineFormat),"let _EngineType = "+JSON.stringify(Te.EngineType),"let _TranscoderFormat = "+JSON.stringify(Te.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Te.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=e,this.workerPool.setWorkerCreator((()=>{const t=new Worker(this.workerSourceURL),e=this.transcoderBinary.slice(0);return t.postMessage({type:"init",config:this.workerConfig,transcoderBinary:e},[e]),t}))})),Ae>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Ae++}return this.transcoderPending}}var ze=function(){var t,e=0x10000000000000000,i=4294967295,s=2147483647;function r(t){var e=[];return e[t-1]=void 0,e}function n(t,e){return o(t[0]+e[0],t[1]+e[1])}function a(t,e){var i,s;return t[0]==e[0]&&t[1]==e[1]?0:(i=0>t[1],s=0>e[1],i&&!s?-1:!i&&s?1:function(t,e){return o(t[0]-e[0],t[1]-e[1])}(t,e)[1]<0?-1:1)}function o(t,s){var r,n;for(t%=e,s=(s%=e)-(r=s%D)+(n=Math.floor(t/D)*D),t=t-n+r;0>t;)t+=D,s-=D;for(;t>i;)t-=D,s+=D;for(s%=e;s>0x7fffffff00000000;)s-=e;for(;-0x10000000000000000>s;)s+=e;return[t,s]}function l(t){return t>=0?[t,0]:[t+D,-4294967296]}function h(t){return t[0]>=2147483648?~~Math.max(Math.min(t[0]-D,s),-2147483648):~~Math.max(Math.min(t[0],s),-2147483648)}function c(t){return t.cb>=t.O?-1:255&t.ab[t.cb++]}function u(t){var e=t.ab;return e.length=t.O,e}function d(t,e,s){var r,n,a,o,h="",u=[];for(n=0;5>n;++n){if(-1==(a=c(e)))throw Error("truncated input");u[n]=a<<24>>24}if(!function(t,e){var i,s,r,n,a,o,l;if(5>e.length)return 0;for(l=255&e[0],r=l%9,n=(o=~~(l/9))%5,a=~~(o/5),i=0,s=0;4>s;++s)i+=(255&e[1+s])<<8*s;return i>99999999||!function(t,e,i,s){if(e>8||i>4||s>4)return 0;S(t.k,i,e);var r=1<<s;return b(t.C,r),b(t.o,r),t.P=r-1,1}(t,r,n,a)?0:function(t,e){return 0>e?0:(t.z!=e&&(t.z=e,t.m=Math.max(t.z,1),m(t.b,Math.max(t.m,4096))),1)}(t,i)}(r=w({}),u))throw Error("corrupted input");for(n=0;64>n;n+=8){if(-1==(a=c(e)))throw Error("truncated input");1==(a=a.toString(16)).length&&(a="0"+a),h=a+""+h}/^0+$|^f+$/i.test(h)?t.N=F:(o=parseInt(h,16),t.N=o>i?F:l(o)),t.Q=function(t,e,i,s){return t.a.K=e,y(t.b),t.b.V=i,function(t){t.b.w=0,t.b.D=0,R(t.q),R(t.n),R(t.E),R(t.s),R(t.u),R(t.r),R(t.J),function(t){var e,i;for(i=1<<t.g+t.y,e=0;i>e;++e)R(t.F[e].v)}(t.k);for(var e=0;4>e;++e)R(t.j[e].B);k(t.C),k(t.o),R(t.t.B),function(t){t.p=0,t.i=-1;for(var e=0;5>e;++e)t.p=t.p<<8|c(t.K)}(t.a)}(t),t.f=0,t.l=0,t.T=0,t.R=0,t._=0,t.U=s,t.d=B,t.I=0,function(t,e){return t.h=e,t.bb=null,t.X=1,t}({},t)}(r,e,s,t.N)}function p(t,e){return t.S=function(t){return t.ab=r(32),t.O=0,t}({}),d(t,function(t,e){return t.ab=e,t.cb=0,t.O=e.length,t}({},e),t.S),t}function m(t,e){(null==t.x||t.c!=e)&&(t.x=r(e)),t.c=e,t.D=0,t.w=0}function f(t){var e=t.D-t.w;e&&(function(t,e,i,s){(function(t,e,i,s,r){for(var n=0;r>n;++n)i[s+n]=t[e+n]})(e,i,t.ab,t.O,s),t.O+=s}(t.V,t.x,t.w,e),t.D>=t.c&&(t.D=0),t.w=t.D)}function g(t,e){var i=t.D-e-1;return 0>i&&(i+=t.c),t.x[i]}function y(t){f(t),t.V=null}function v(t){if(!t.X)throw Error("bad state");if(t.bb)throw Error("No encoding");return function(t){var e=function(t){var e,i,s,r,o,c;if(c=h(t.d)&t.P,P(t.a,t.q,(t.f<<4)+c)){if(P(t.a,t.E,t.f))s=0,P(t.a,t.s,t.f)?(P(t.a,t.u,t.f)?(P(t.a,t.r,t.f)?(i=t._,t._=t.R):i=t.R,t.R=t.T):i=t.T,t.T=t.l,t.l=i):P(t.a,t.n,(t.f<<4)+c)||(t.f=7>t.f?9:11,s=1),s||(s=x(t.o,t.a,c)+2,t.f=7>t.f?8:11);else if(t._=t.R,t.R=t.T,t.T=t.l,s=2+x(t.C,t.a,c),t.f=7>t.f?7:10,o=z(t.j[function(t){return 4>(t-=2)?t:3}(s)],t.a),o>=4){if(r=(o>>1)-1,t.l=(2|1&o)<<r,14>o)t.l+=function(t,e,i,s){var r,n,a=1,o=0;for(n=0;s>n;++n)r=P(i,t,e+a),a<<=1,a+=r,o|=r<<n;return o}(t.J,t.l-o-1,t.a,r);else if(t.l+=C(t.a,r-4)<<4,t.l+=function(t,e){var i,s,r=1,n=0;for(s=0;t.A>s;++s)i=P(e,t.B,r),r<<=1,r+=i,n|=i<<s;return n}(t.t,t.a),0>t.l)return-1==t.l?1:-1}else t.l=o;if(a(l(t.l),t.d)>=0||t.l>=t.m)return-1;(function(t,e,i){var s=t.D-e-1;for(0>s&&(s+=t.c);0!=i;--i)s>=t.c&&(s=0),t.x[t.D++]=t.x[s++],t.D>=t.c&&f(t)})(t.b,t.l,s),t.d=n(t.d,l(s)),t.I=g(t.b,0)}else e=function(t,e,i){return t.F[((e&t.Y)<<t.g)+((255&i)>>>8-t.g)]}(t.k,h(t.d),t.I),t.I=7>t.f?function(t,e){var i=1;do{i=i<<1|P(e,t.v,i)}while(256>i);return i<<24>>24}(e,t.a):function(t,e,i){var s,r,n=1;do{if(r=i>>7&1,i<<=1,s=P(e,t.v,(1+r<<8)+n),n=n<<1|s,r!=s){for(;256>n;)n=n<<1|P(e,t.v,n);break}}while(256>n);return n<<24>>24}(e,t.a,g(t.b,t.l)),function(t,e){t.x[t.D++]=e,t.D>=t.c&&f(t)}(t.b,t.I),t.f=function(t){return 4>t?0:10>t?t-3:t-6}(t.f),t.d=n(t.d,N);return 0}(t.h);if(-1==e)throw Error("corrupted input");t.$=F,t.Z=t.h.d,(e||a(t.h.U,B)>=0&&a(t.h.d,t.h.U)>=0)&&(f(t.h.b),y(t.h.b),t.h.a.K=null,t.X=0)}(t),t.X}function w(t){t.b={},t.a={},t.q=r(192),t.E=r(12),t.s=r(12),t.u=r(12),t.r=r(12),t.n=r(192),t.j=r(4),t.J=r(114),t.t=T({},4),t.C=M({}),t.o=M({}),t.k={};for(var e=0;4>e;++e)t.j[e]=T({},6);return t}function b(t,e){for(;e>t.e;++t.e)t.G[t.e]=T({},3),t.H[t.e]=T({},3)}function x(t,e,i){return P(e,t.M,0)?8+(P(e,t.M,1)?8+z(t.L,e):z(t.H[i],e)):z(t.G[i],e)}function M(t){return t.M=r(2),t.G=r(16),t.H=r(16),t.L=T({},8),t.e=0,t}function k(t){R(t.M);for(var e=0;t.e>e;++e)R(t.G[e].B),R(t.H[e].B);R(t.L.B)}function S(t,e,i){var s,n;if(null==t.F||t.g!=i||t.y!=e)for(t.y=e,t.Y=(1<<e)-1,t.g=i,n=1<<t.g+t.y,t.F=r(n),s=0;n>s;++s)t.F[s]=A({})}function A(t){return t.v=r(768),t}function T(t,e){return t.A=e,t.B=r(1<<e),t}function z(t,e){var i,s=1;for(i=t.A;0!=i;--i)s=(s<<1)+P(e,t.B,s);return s-(1<<t.A)}function P(t,e,i){var s,r=e[i];return(-2147483648^(s=(t.i>>>11)*r))>(-2147483648^t.p)?(t.i=s,e[i]=r+(2048-r>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),0):(t.i-=s,t.p-=s,e[i]=r-(r>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),1)}function C(t,e){var i,s,r=0;for(i=e;0!=i;--i)t.i>>>=1,s=t.p-t.i>>>31,t.p-=t.i&s-1,r=r<<1|1-s,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8);return r}function R(t){for(var e=t.length-1;e>=0;--e)t[e]=1024}function E(t){for(var e,i,s,r=0,n=0,a=t.length,o=[],l=[];a>r;++r,++n){if(128&(e=255&t[r]))if(192==(224&e)){if(r+1>=a)return t;if(128!=(192&(i=255&t[++r])))return t;l[n]=(31&e)<<6|63&i}else{if(224!=(240&e))return t;if(r+2>=a)return t;if(128!=(192&(i=255&t[++r])))return t;if(128!=(192&(s=255&t[++r])))return t;l[n]=(15&e)<<12|(63&i)<<6|63&s}else{if(!e)return t;l[n]=e}16383==n&&(o.push(String.fromCharCode.apply(String,l)),n=-1)}return n>0&&(l.length=n,o.push(String.fromCharCode.apply(String,l))),o.join("")}function _(t){return t[1]+t[0]}var L=2,I=3,O="function"==typeof setImmediate?setImmediate:setTimeout,D=4294967296,F=[i,-4294967296],B=[0,0],N=[1,0];return{decompress:function(e,i,s){var r,n,a,o,l={},h=void 0===i&&void 0===s;if("function"!=typeof i&&(n=i,i=s=0),s=s||function(e){return void 0!==n?function(e,i){t({action:I,cbn:i,result:e})}(a?e:-1,n):void 0},i=i||function(e,i){return void 0!==n?t({action:L,cbn:n,result:e,error:i}):void 0},h){for(l.d=p({},e);v(l.d.Q););return E(u(l.d.S))}try{l.d=p({},e),o=_(l.d.N),a=o>-1,s(0)}catch(t){return i(null,t)}O((function t(){try{for(var e,n=0,h=(new Date).getTime();v(l.d.Q);)if(++n%1e3==0&&(new Date).getTime()-h>200)return a&&(r=_(l.d.Q.h.d)/o,s(r)),O(t,0),0;s(1),e=E(u(l.d.S)),O(i.bind(null,e),0)}catch(t){i(null,t)}}),0)}}}();const Pe={decompress:(t,e)=>{ze.decompress(new Uint8Array(t),e)}};function Ce(t,e=!1){const i=null!==t[0].index,s=new Set(Object.keys(t[0].attributes)),n=new Set(Object.keys(t[0].morphAttributes)),a={},o={},l=t[0].morphTargetsRelative,h=new r;let c=0;for(let r=0;r<t.length;++r){const u=t[r];let d=0;if(i!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in u.attributes){if(!s.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[t]&&(a[t]=[]),a[t].push(u.attributes[t]),d++}if(d!==s.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". Make sure all geometries have the same number of attributes."),null;if(l!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in u.morphAttributes){if(!n.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[t]&&(o[t]=[]),o[t].push(u.morphAttributes[t])}if(e){let t;if(i)t=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". The geometry must have either an index or a position attribute"),null;t=u.attributes.position.count}h.addGroup(c,t,r),c+=t}}if(i){let e=0;const i=[];for(let s=0;s<t.length;++s){const r=t[s].index;for(let t=0;t<r.count;++t)i.push(r.getX(t)+e);e+=t[s].attributes.position.count}h.setIndex(i)}for(const t in a){const e=Re(a[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;h.setAttribute(t,e)}for(const t in o){const e=o[t][0].length;if(0===e)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[t]=[];for(let i=0;i<e;++i){const e=[];for(let s=0;s<o[t].length;++s)e.push(o[t][s][i]);const s=Re(e);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;h.morphAttributes[t].push(s)}}return h}function Re(t){let e,i,s,r=-1,a=0;for(let n=0;n<t.length;++n){const o=t[n];if(void 0===e&&(e=o.array.constructor),e!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===i&&(i=o.itemSize),i!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===s&&(s=o.normalized),s!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=o.gpuType),r!==o.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;a+=o.count*i}const o=new e(a),l=new n(o,i,s);let h=0;for(let e=0;e<t.length;++e){const s=t[e];if(s.isInterleavedBufferAttribute){const t=h/i;for(let e=0,r=s.count;e<r;e++)for(let r=0;r<i;r++){const i=s.getComponent(e,r);l.setComponent(e+t,r,i)}}else o.set(s.array,h);h+=s.count*i}return void 0!==r&&(l.gpuType=r),l}function Ee(t,e=1e-4){e=Math.max(e,Number.EPSILON);const i={},s=t.getIndex(),r=t.getAttribute("position"),a=s?s.count:r.count;let o=0;const l=Object.keys(t.attributes),h={},c={},u=[],d=["getX","getY","getZ","getW"],p=["setX","setY","setZ","setW"];for(let e=0,i=l.length;e<i;e++){const i=l[e],s=t.attributes[i];h[i]=new n(new s.array.constructor(s.count*s.itemSize),s.itemSize,s.normalized);const r=t.morphAttributes[i];r&&(c[i]=new n(new r.array.constructor(r.count*r.itemSize),r.itemSize,r.normalized))}const m=.5*e,f=Math.log10(1/e),g=Math.pow(10,f),y=m*g;for(let e=0;e<a;e++){const r=s?s.getX(e):e;let n="";for(let e=0,i=l.length;e<i;e++){const i=l[e],s=t.getAttribute(i),a=s.itemSize;for(let t=0;t<a;t++)n+=~~(s[d[t]](r)*g+y)+","}if(n in i)u.push(i[n]);else{for(let e=0,i=l.length;e<i;e++){const i=l[e],s=t.getAttribute(i),n=t.morphAttributes[i],a=s.itemSize,u=h[i],m=c[i];for(let t=0;t<a;t++){const e=d[t],i=p[t];if(u[i](o,s[e](r)),n)for(let t=0,s=n.length;t<s;t++)m[t][i](o,n[t][e](r))}}i[n]=o,u.push(o),o++}}const v=t.clone();for(const e in t.attributes){const t=h[e];if(v.setAttribute(e,new n(t.array.slice(0,o*t.itemSize),t.itemSize,t.normalized)),e in c)for(let t=0;t<c[e].length;t++){const i=c[e][t];v.morphAttributes[e][t]=new n(i.array.slice(0,o*i.itemSize),i.itemSize,i.normalized)}}return v.setIndex(u),v}const _e={getMesh:(t,e)=>{let i={};if(e){let e=[],i=[],s={},r=[];t.traverse((t=>{if(t.isGroup){let n=_e.groupToMesh(t);n&&(e.push(t),r.push(t.name),n.applyMatrix4(t.matrix),i.push(n),s[n.name]=i)}}));let n,a,o=e.length;for(;o--;)n=e[o].parent,a=n.name,n.remove(e[o]),-1!==r.indexOf(a)&&(n=s[a]),n.add(i[o])}return t.traverse((t=>{t.isMesh&&(i[t.name]=t)})),i},getGroup:(t,e,i)=>{const s={};return t.traverse((t=>{t.isGroup&&(s[t.name]=e?_e.groupToMesh(t,mats):t)})),s},getMaterial:t=>{const e={};let i,s=[];return t.traverse((t=>{t.isMesh&&(i=t.material,-1===s.indexOf(i.name)&&(s.push(i.name),e[i.name]=i))})),e},groupToMesh:t=>{if(t.children[0].name!==t.name+"_1")return!1;if(!t.children[0].isMesh)return!1;let e=[],i=[],s=t.children.length;for(;s--;)i[s]=t.children[s].material,e[s]=t.children[s].geometry,e[s].group=s;let r=new THREE.Mesh(new Ce(e,!0),i);return r.name=t.name,r},symetric:t=>{t.isMesh&&(t=t.geometry);let e=t.attributes.uv.array,i=.5*e.length;for(;i--;)e[2*i]<0&&(e[2*i]*=-1);t.attributes.uv.needsUpdate=!0},uv2:t=>{t.isMesh&&(t=t.geometry),t.setAttribute("uv2",t.attributes.uv)},autoMorph:(t,e,i=!0,s=!1)=>{let r,n,a,o,h,c,u,d,p,m,f,g={},y=[];t.traverse((t=>{t.isMesh&&-1!==t.name.search("__M__")&&(g[t.name]=t.geometry,y.push(t))}));for(let t in g)if(r=t.substring(0,t.indexOf("__")),n=t.substring(t.lastIndexOf("__")+2),a=e[r],a)if(h=a.geometry,c=g[t],h.morphTargetsRelative=s,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],i&&(h.morphAttributes.normal=[]),a.morphTargetInfluences=[],a.morphTargetDictionary={}),o=h.morphAttributes.position.length,s){for(u=c.attributes.position.array.length,m=[];u--;)m[u]=c.attributes.position.array[u]-h.attributes.position.array[u];d=new l(m,3)}else d=new l(c.attributes.position.array,3);h.morphAttributes.position.push(d),i&&(p=new l(c.attributes.normal.array,3),h.morphAttributes.normal.push(p)),a.morphTargetInfluences.push(0),a.morphTargetDictionary[n]=o}else console.warn("Morph "+n+" target is no good on "+a.name);for(g={},u=y.length;u--;)f=y[u],f.parent&&f.parent.remove(f),f.material&&f.material.dispose(),f.geometry&&f.geometry.dispose()}},Le={manager:new h,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./build/draco/",basisPath:"./build/basis/",useLocal:!1,formatGltf:{draco:!0,ktx2:!1,meshop:!1},setSupport:t=>{for(let e in t)Le.formatGltf[e]&&(Le.formatGltf[e]=t[e])},maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:t=>{},materialRoot:t=>{console.log(t)},setLoadEvent:(t,e)=>{Le.onLoad=t,Le.onEnd=e},prefix:t=>{let e="";switch(t){case"S":case"sound":case"mp3":case"wav":case"ogg":e="S_";break;case"I":case"image":case"jpg":case"png":e="I_";break;case"E":case"hdr":case"env":case"T":case"texture":e="T_";break;case"J":case"json":e="J_";break;case"JS":case"js":e="JS_";break;case"H":case"bin":case"hex":e="H_";break;case"O":case"object3d":e="O_";break;case"M":case"material":e="M_"}return e},dispose:()=>{Le.data.forEach((function(t,e){(t.isMaterial||t.isTexture)&&(t.dispose(),Le.data.delete(e)),t.isObject3D&&(t.traverse((function(t){t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose&&t.material.dispose())})),Le.data.delete(e))}))},createElementNS:t=>document.createElementNS("http://www.w3.org/1999/xhtml",t),exist:(t,e="")=>!!Le.get(t,e),delete:(t,e="")=>Le.data.delete(Le.prefix(e)+t),get:(t,e="")=>Le.data.get(Le.prefix(e)+t),set:(t,e,i="",s)=>{e?(e.isMaterial&&(i="material",e.name=t,Le.materialRoot(e,s)),e.isTexture&&(i="texture"),e.isObject3D&&(i="object3d"),Le.get(t,i)||Le.data.set(Le.prefix(i)+t,e)):console.log("Loading error on "+t)},getScript:t=>Le.data.get(Le.prefix("js")+t),getMaterials:t=>("string"==typeof t&&(t=Le.get(t,"O")),_e.getMaterial(t)),getGLB:(t,e)=>("string"==typeof t&&(t=Le.get(t,"O")),t?(e&&_e.getMesh(t,e),t):console.error("Not find Model ?")),getMesh:(t,e)=>("string"==typeof t&&(t=Le.get(t,"O")),t?_e.getMesh(t,e):console.error("Not find Model ?")),getGroup:(t,e,i)=>("string"==typeof t&&(t=Le.get(t,"O")),_e.getGroup(t,e,i)),applyMorph(t,e=null,i=!0,s=!0){let r;r=t.isObject3D?t:Le.get(t,"O"),e||(e=Le.getMesh(t)),r&&e&&_e.autoMorph(r,e,i,s)},uv2(t){_e.uv2(t)},symetric(t){_e.symetric(t)},objectSpaceNormal(t){t.material.normalMapType=v},add:(t,e,i)=>{Le.set(t,e,i),Le.next()},getMaterial:t=>Le.data.get("M_"+t),texture:(t={})=>{Le.loaderMap||(Le.loaderMap=new y);let e=t.name||"";return t.url&&(e=-1!==t.url.lastIndexOf(".")?t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf(".")):t.url.substring(t.url.lastIndexOf("/")+1)),-1===e.search("_c")&&-1===e.search("_l")&&-1===e.search("_u")&&-1===e.search("_d")||(t.srgb=!0),Le.exist(e,"texture")?Le.get(e,"texture"):Le.exist(e,"image")?Le.getTexture(e,t):Le.loaderMap.load(t.url,(function(i){return Le.setTextureOption(i,t),Le.data.set("T_"+e,i),t.callback&&t.callback(),i}))},getTexture:(t,e={})=>{t=(e.quality?e.quality+"k_":"")+t;let i=Le.get(t,"texture");if(!i){let s=Le.get(t,"image");if(!s)return null;i=new g(s),-1===t.search("_c")&&-1===t.search("_d")&&-1===t.search("_l")&&-1===t.search("_u")||(e.srgb=!0),Le.data.set("T_"+t,i)}return Le.setTextureOption(i,e),i},setTextureOption:(t,e={})=>{e.encoding&&(t.colorSpace=i),e.srgb&&(t.colorSpace=i),t.flipY=(void 0!==e.flipY||void 0!==e.flip)&&e.flipY,e.anisotropy&&(t.anisotropy="max"===e.anisotropy?Le.maxAnisotropy:e.anisotropy),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),e.repeat&&(t.repeat.fromArray(e.repeat),t.wrapS=t.wrapT=p),e.center&&t.center.fromArray(e.center),e.offset&&t.offset.fromArray(e.offset),e.filter&&"near"===e.filter&&(t.minFilter=f,t.magFilter=f),e.channel&&(t.channel=e.channel),t.needsUpdate=!0},loadAsync:(t,e="",i="")=>new Promise(((s,r)=>{Le.waiting=!0,Le.load(t,(()=>{Le.waiting=!1}),e,i)})),load:(t,e,i="",s="",r=0)=>{Le.msg=s;let n=[],a=e||function(){},o=("undefined"==typeof performance?Date:performance).now();"string"==typeof t||t instanceof String?n.push(t):n=n.concat(t),Le.tmp.push({urls:n,path:i,callback:a,start:o,quality:r}),Le.inLoad||Le.loadOne()},loadOne:()=>{Le.inLoad=!0,Le.onLoad();let t=Le.tmp[0].path+Le.tmp[0].urls[0],e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),i=t.substring(t.lastIndexOf(".")+1).toLowerCase();"jpg"!==i&&"png"!==i||(e=(Le.tmp[0].quality?Le.tmp[0].quality+"k_":"")+e),Le.exist(e,i)?Le.next():Le.loading(t,e,i)},next:()=>{Le.tmp[0].urls.shift(),0===Le.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-Le.tmp[0].start),Le.tmp[0].callback(),Le.tmp.shift(),Le.tmp.length>0?Le.loadOne():(Le.inLoad=!1,Le.clearDRACO(),Le.clearKTX2(),Le.onEnd())):Le.loadOne()},loading:(t,e,i)=>{switch(Le.log(Le.msg),i){case"glb":case"gltf":Le.load_GLTF(t,e);break;case"fbx":case"FBX":Le.load_FBX(t,e);break;case"obj":Le.load_OBJ(t,e);break;case"stl":Le.load_STL(t,e);break;case"ktx2":Le.load_KTX2(t,e);break;case"hdr":Le.load_RGBE(t,e);break;case"exr":Le.load_EXR(t,e);break;default:Le.extand(t,e,i)}},extand:(t,e,i)=>{Le.XHTTP||(Le.XHTTP=new XMLHttpRequest);const s=Le.XHTTP;switch(s.open("GET",t,!0),"json"===i&&s.overrideMimeType("application/json"),i){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":s.responseType="arraybuffer";break;case"jpg":case"png":s.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):Le.direct(s.response,e,i))},"onprogress"in s&&(s.onprogress=function(t){}),s.send(null)},direct:(t,e,i)=>{switch(i){case"jpg":case"png":let s=Le.createElementNS("img");s.onload=function(t){window.URL.revokeObjectURL(s.src),Le.add(e,s,"image")},s.src=window.URL.createObjectURL(t);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(t.slice(0),(function(t){Le.add(e,t,"sound")}),(function(t){console.error("decodeAudioData error",t)}));break;case"hex":case"bin":Pe.decompress(t,(t=>{Le.add(e,t,i)}));break;case"wasm":Le.add(e,new Uint8Array(t),i);break;case"json":Le.add(e,JSON.parse(t),i);break;default:Le.add(e,t,i)}},clearKTX2:()=>{Le.KTX2&&(Le.KTX2.dispose(),Le.KTX2=null)},clearDRACO:()=>{Le.dracoLoader&&(Le.dracoLoader.dispose(),Le.dracoLoader=null),Le.GLTF&&(Le.GLTF=null)},loaderDRACO:()=>{if(Le.dracoLoader)return Le.dracoLoader;if(!Le.dracoLoaderType)if(navigator.userAgentData)Le.dracoLoaderType="wasm";else{let t=navigator.userAgent.toLowerCase();Le.dracoLoaderType=-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")?"js":"wasm"}return Le.dracoLoader=(new ke).setDecoderConfig({type:Le.dracoLoaderType}).setDecoderPath(Le.dracoPath).setUseLocal(Le.useLocal),Le.dracoLoader},loaderKTX2:()=>(Le.KTX2||(Le.KTX2=new Te(Le.manager).setTranscoderPath(Le.basisPath).detectSupport(Le.renderer).setUseLocal(Le.useLocal)),Le.KTX2),loaderGLTF:()=>(Le.GLTF||(Le.GLTF=new oe(Le.manager).setCrossOrigin("anonymous"),Le.formatGltf.draco&&Le.GLTF.setDRACOLoader(Le.loaderDRACO()),Le.formatGltf.ktx2&&Le.GLTF.setKTX2Loader(Le.loaderKTX2()),Le.formatGltf.meshop&&Le.GLTF.setMeshoptDecoder(pe)),Le.GLTF),loaderFBX:()=>(Le.FBX||(Le.FBX=new le(Le.manager)),Le.FBX),loaderSTL:()=>(Le.STL||(Le.STL=new ce(Le.manager)),Le.STL),loaderOBJ:()=>(Le.OBJ||(Le.OBJ=new he(Le.manager)),Le.OBJ),loaderRGBE:()=>(Le.RGBE||(Le.RGBE=new ue(Le.manager)),Le.RGBE),loaderEXR:()=>(Le.EXR||(Le.EXR=new de(Le.manager)),Le.EXR),load_GLTF:(t,e)=>{Le.loaderGLTF().load(t,(function(t){const i=t.scene;if(t.animations){const e=t.animations,s=new d(t.scene);i.mixer=s,i.actions={};for(let t=0;t<e.length;t++){let r=e[t];i.actions[r.name]=s.clipAction(r)}i.play=t=>{i.actions[t]&&(i.actions[t].paused=!1,i.actions[t].time=0,i.actions[t].play())},i.pause=(t,e=!0)=>{i.actions[t]&&(i.actions[t].paused=e)}}Le.add(e,i)}))},load_FBX:(t,e)=>{Le.loaderFBX().load(t,(function(t){Le.add(e,t)}))},load_OBJ:(t,e)=>{Le.loaderOBJ().load(t,(function(t){Le.add(e,t)}))},load_STL:(t,e)=>{Le.loaderSTL().load(t,(function(t){let i=new u(t);Le.add(e,i)}))},load_KTX2:(t,e,i)=>{Le.loaderKTX2().load(t,(function(t){return Le.add(e,t),t}))},load_RGBE:(t,e)=>{Le.loaderRGBE().load(t,(function(t){t.mapping=c,Le.add(e,t)}))},load_EXR:(t,e,i)=>{Le.loaderEXR().load(t,(function(t){return i&&i(t),t}))},direct_EXR:(t,e)=>{Le.loaderEXR().parse(url,(function(t){return Le.add(e,t),t}))}},Ie=["PHYSX","HAVOK"],Oe=4e3,De=1e3,Fe=4e3,Be=100,Ne=100,Ue=50,Ve=20,qe={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},We=function(t,e=!1){const i={};let s={body:Oe*(e?qe.bodyFull:qe.body),joint:De*qe.joint,ray:Be*qe.ray,contact:Fe*qe.contact,character:Ne*qe.character};"PHYSX"!==t&&"AMMO"!==t||(s.vehicle=Ue*qe.vehicle),"PHYSX"===t&&(s.solver=Ve*qe.solver),"HAVOK"!==t&&"RAPIER"!==t&&"JOLT"!==t||(qe.joint=0);let r=0;for(let t in s)i[t]=r,r+=s[t];return i.total=r,i};class je extends w{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),s=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],a=new r;a.setIndex(new n(i,1)),a.setAttribute("position",new l(s,3)),a.setAttribute("color",new l([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(a,new b({color:e,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=t,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}dispose(){this.geometry.dispose(),this.material.dispose()}}let He=class{constructor(){this.geoN=0,this.geo={}}unic(t){this.geo["geo"+this.geoN++]=t}set(t){this.geo[t.name]=t}get(t,e={}){if(!this.geo[t]){let e;switch(t){case"plane":e=new S(1,1),e.rotateX(.5*-Math.PI);break;case"box":e=new k(1,1,1);break;case"sphere":e=new x(1,16,12);break;case"cylinder":e=new M(1,1,1,16);break;case"cone":e=new M(.001,1,1,16);break;case"particle":e=new x(1,6,4);break;case"joint":e=(new je).geometry;break;default:return null}this.geo[t]=e}return this.geo[t]}dispose(){for(let t in this.geo)this.geo[t].isBufferGeometry?this.geo[t].dispose():console.log(this.geo[t]);this.geo={},this.geoN=0}};class Ge{constructor(t,e="rgb(69,69,69)",s="rgb(39,39,39)"){const r=document.createElement("canvas");r.width=r.height=128;const n=r.getContext("2d");if(n.fillStyle=e,n.fillRect(0,0,128,128),t){let i,r,a,o,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=t?"rgb(128,128,255)":e,u=t?"rgb(160,100,255)":s,d=t?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(n.strokeStyle=d,n.lineWidth=1,i=0;i<5;i++){o=n.createLinearGradient(0,h[i][0],0,h[i][1]),o.addColorStop(0,u),o.addColorStop(1,c),n.beginPath(),n.fillStyle=o,n.rect(l[i][0],l[i][1],32,64),n.fill();for(let t=0;t<8;t++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[i][0]+a+2+4*t,l[i][1]),n.lineTo(l[i][0]+a+2+4*t,l[i][1]+64),n.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],i=0;i<5;i++)for(o=n.createLinearGradient(h[i][0],0,h[i][1],0),o.addColorStop(0,c),o.addColorStop(1,u),n.beginPath(),n.fillStyle=o,n.rect(l[i][0],l[i][1],64,32),n.fill(),r=0;r<8;r++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[i][0],l[i][1]+a+2+4*r),n.lineTo(l[i][0]+64,l[i][1]+a+2+4*r),n.stroke()}else n.beginPath(),n.fillStyle=s,n.rect(0,0,32,64),n.rect(32,32,32,64),n.rect(64,64,32,64),n.rect(96,96,32,64),n.rect(96,-32,32,64),n.fill();const a=new A(r);return a.wrapS=a.wrapT=p,a.repeat.x=a.repeat.y=60,t||(a.colorSpace=i),a}}class Xe extends T{constructor(t){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new a(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(t);let e=this;e.onBeforeCompile=function(t){for(let i in e.extra)t.uniforms[i]={value:e.extra[i]};t.fragmentShader=t.fragmentShader.replace("#include <common>",Qe.common),t.fragmentShader=t.fragmentShader.replace("#include <lights_fragment_begin>",e.replaceAll(Ye,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",Qe.light)),e.userData.shader=t}}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.userData.shader&&(this.userData.shader.uniforms[t].value=this.extra[t])}})}replaceAll(t,e,i){return t.split(e).join(i)}}const Qe={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},Ye="\n\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\n\tif ( material.iridescenceThickness == 0.0 ) {\n\n\t\tmaterial.iridescence = 0.0;\n\n\t} else {\n\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\n\t}\n\n\tif ( material.iridescence > 0.0 ) {\n\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\n\t}\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n\t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",Je={metalness:.1,roughness:.9},Ze={grey:new a(.18,.18,.18),black:new a(.039,.039,.039),body:new a(13289155),sleep:new a("hsl(33, 15%, 54%)"),solid:new a(7105128),base:new a(13224135),brick:new a(.262,.095,.061),sand:new a(.44,.386,.231),gold:new a(.944,.776,.373),gold2:new a(.998,.981,.751),titanium:new a(.633,.578,.503),titaniumSpec:new a(.728,.68,.55),chrome:new a(.653,.65,.615),chromeSpec:new a(.675,.72,.711),copper:new a(.988,.688,.448),carPaint:new a(.1037792,.59212029,.85064936),clay:new a("hsl(12, 30%, 40%)"),clayWhite:new a(11119017),concrete:new a(.51,.51,.51),Raw_Fire:new a("hsl(40, 18%, 54%)"),Raw_Buff:new a("hsl(33, 15%, 54%)"),Raw_Terracotta:new a("hsl(12, 30%, 40%)"),Raw_Porcelain:new a("hsl(45, 15%, 90%)")},Ke={No:st,Normal:it,Additive:et,Subtractive:tt,Multiply:$,Eadd:K,Esub:Z,Erev:J,Emin:Y,Emaw:Q,Fzero:X,Fone:G,Fcolor:H,Fcolorm:j,Falpha:W,Falpham:q,Fdstalpha:V,Fdstalpham:U,Fdstcolor:N,Fdstcolorm:B,Falphasaturate:F,Front:D,Back:O,Double:I};let $e=class{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.extendMat=!1,this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(t){this.renderMode.value=t}initExtandShader(){}useRealLight(t){}setColor(t){}set(t,e,i=null){i||(i=t.onBeforeCompile),this.mat[t.name]=t}extendShader(t,e=null){}addToTmp(t){this.TmpMat.push(t)}create(t){let e,i=null;if(t.isMaterial)e=t;else{let s=void 0!==t.type?t.type:"Standard";switch(t.type&&delete t.type,i=t.beforeCompile||null,t.beforeCompile&&delete t.beforeCompile,(t.thickness||t.sheen||t.clearcoat||t.transmission||t.specularColor)&&(s="Physical"),t.normalScale&&(t.normalScale.isVector2||(t.normalScale=(new z).fromArray(t.normalScale))),t.side&&(t.side=this.findValue(t.side)),t.shadowSide&&(t.shadowSide=this.findValue(t.shadowSide)),t.blending&&(t.blending=this.findValue(t.blending)),t.blendEquation&&(t.blendEquation=this.findValue(t.blendEquation)),t.blendEquationAlpha&&(t.blendEquationAlpha=this.findValue(t.blendEquationAlpha)),t.blendSrc&&(t.blendSrc=this.findValue(t.blendSrc)),t.blendDst&&(t.blendDst=this.findValue(t.blendDst)),t.blendDstAlpha&&(t.blendDstAlpha=this.findValue(t.blendDstAlpha)),t.blendSrcAlpha&&(t.blendSrcAlpha=this.findValue(t.blendSrcAlpha)),t.clearcoatNormalScale&&(t.clearcoatNormalScale.isVector2||(t.clearcoatNormalScale=(new z).fromArray(t.clearcoatNormalScale))),s=s.toLowerCase(),s){case"physical":e=new T(t),e.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":e=new L(t);break;case"lambert":e=new _(t);break;case"basic":e=new E(t);break;case"line":e=new b(t);break;case"toon":e=new R(t);break;case"shadow":e=new C(t);break;case"sss":e=new Xe(t);break;default:e=new P(t)}}return this.mat[e.name]?null:(this.set(e,!1,i),e)}findValue(t){return"string"===t?Ke[t.charAt(0).toUpperCase()+t.slice(1)]:t}addToMat(t){if(this.isRealism)for(let e in t)t[e].shadowSide=I,t[e].onBeforeCompile=function(i){EnhanceLighting(i,this.realismOption),t[e].userData.isRealism=!0,t[e].userData.shader=i};this.mat={...this.mat,...t}}changeType(){}directIntensity(t){for(let t in this.mat);}getList(){let t={...this.mat};const e=["line","debug","hide","svg"];let i=e.length;for(;i--;)delete t[e[i]];return t}get(t){if(!this.mat[t])switch(t){case"grey":this.create({name:"grey",color:Ze.grey,metalness:0,roughness:.5});break;case"black":this.create({name:"black",color:Ze.black,metalness:0,roughness:.5});break;case"body":this.create({name:"body",color:Ze.body,...Je});break;case"sleep":this.create({name:"sleep",color:Ze.sleep,...Je});break;case"solid":this.create({name:"solid",color:Ze.solid,...Je});break;case"base":this.create({name:"base",color:Ze.base,...Je});break;case"clay":this.create({name:"clay",color:Ze.clay,metalness:.1,roughness:.7});break;case"clayWhite":this.create({name:"clayWhite",color:Ze.clayWhite,metalness:.1,roughness:.7});break;case"concrete":this.create({name:"concrete",color:Ze.concrete,metalness:0,roughness:.9});break;case"brick":this.create({name:"brick",color:Ze.brick,metalness:0,roughness:.6});break;case"sand":this.create({name:"sand",color:Ze.sand,metalness:0,roughness:.9});break;case"chrome":this.create({name:"chrome",color:Ze.chrome,specularColor:Ze.chromeSpec,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:Ze.gold,specularColor:Ze.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:Ze.copper,metalness:1,roughness:.05});break;case"titanium":this.create({name:"titanium",color:Ze.titanium,metalness:1,roughness:0,specularColor:Ze.titaniumSpec});break;case"carPaint":this.create({name:"carPaint",color:Ze.carPaint,metalness:0,anisotropy:new z(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new Ge,normalMap:new Ge(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...Je});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:I,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:16777215,alphaToCoverage:!0,transparent:!0,opacity:1,roughness:0,metalness:0,side:I,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.05,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0,specularIntensity:1,specularColor:16777215});break;case"plexi":this.create({name:"plexi",blending:et,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:I,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:et,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:I,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.create({name:"outline",color:16777215,type:"Basic",side:O,toneMapped:!1,wireframe:!0,transparent:!0,opacity:.25});break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...Je});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:16776960,transparent:!0,opacity:.2});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:I})}return this.mat[t]}dispose(){this.isRealism=!1;for(let t in this.mat)this.mat[t].dispose(),delete this.mat[t];let t=this.TmpMat.length;for(;t--;)this.TmpMat[t].dispose();this.TmpMat=[]}upShader(){let t=this.realismOption;for(let e in this.mat){const i=this.mat[e],s=i.userData.shader;for(let e in t)s&&void 0!==s.uniforms[e]&&(s.uniforms[e].value=t[e]),i[e]&&(i[e]=t[e])}}};class ti{constructor(t=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(t),this.force=!1}up(t){let e=this.time;return this.unlimited&&(this.force=!0),e.now=void 0!==t?t:this.now(),e.delta=e.now-e.then,this.force&&(e.delta=e.interval,this.force=!1),!!(e.delta>=e.interval||this.unlimited)&&(e.then=this.unlimited?e.now:e.now-e.delta%e.interval,this.delta=.001*e.interval,this.elapsedTime+=this.delta,!0)}setFramerate(t){this.elapsedTime=0,this.framerate=t,this.unlimited=this.framerate<0,this.time.interval=1e3/t,60===t&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(t){return t>1e3?t/1e3+" sec":t+" ms"}}class ei{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new ii(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(t){this.keyDown(t)}.bind(this),!1),document.addEventListener("keyup",function(t){this.keyUp(t)}.bind(this),!1)}setKey(t,e){this.key[t]=e}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=-1,i[0]=1;break;case 68:case 39:e[0]=1,i[1]=1;break;case 87:case 90:case 38:e[1]=-1;break;case 83:case 40:e[1]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}else switch(t.which){case 65:case 81:e[0]=-1,i[0]=1;break;case 68:e[0]=1,i[1]=1;break;case 87:case 90:e[1]=-1;break;case 83:e[1]=1;break;case 37:e[2]=-1,i[0]=1;break;case 39:e[2]=1,i[1]=1;break;case 38:e[3]=-1;break;case 40:e[3]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}this.gamepad.reset()}keyUp(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:case 39:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:case 38:e[1]=e[1]<0?0:e[1];break;case 83:case 40:e[1]=e[1]>0?0:e[1];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}else switch(t.which){case 65:case 81:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:e[1]=e[1]<0?0:e[1];break;case 83:e[1]=e[1]>0?0:e[1];break;case 37:e[2]=e[2]<0?0:e[2],i[0]=0;break;case 39:e[2]=e[2]>0?0:e[2],i[1]=0;break;case 38:e[3]=e[3]<0?0:e[3];break;case 40:e[3]=e[3]>0?0:e[3];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}}}class ii{constructor(t){this.values=[],this.ready=0,this.key=t}update(){var t,e,i,s,r,n,a=this.fix,o=navigator.getGamepads();for(t=0;t<o.length;t++)if(n=o[t])if(i=n.axes.length,s=n.buttons.length){for(this.values[t]||(this.values[t]=[]),e=0;e<i;e++)r=a(n.axes[e],.08),0==this.ready&&0!==r&&(this.ready=1),this.values[t][e]=r;for(e=0;e<s;e++)r=a(n.buttons[e].value),0==this.ready&&0!==r&&(this.ready=1),this.values[t][i+e]=r}else this.values[t]&&(this.values[t]=null)}getValue(t){for(var e,i=19;i--;)e=this.values[t][i],0==this.ready&&0!==e&&(this.ready=1),this.key[i]=e}reset(){this.ready=0}fix(t,e){let i=Number(t.toString().substring(0,5));return e&&i<e&&i>-e&&(i=0),i}}class si{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.list=[],this.id=0}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let i=this.byName(t);return i?this.clear(i,e):-1}clear(t,e){let i=this.list.indexOf(t);return-1===i||e?this.list[i]=null:this.list.splice(i,1),this.dispose(t),i}dispose(t){null!==t&&this.Utils.remove(t)}add(t={}){}set(t={}){}step(t,e){}}class ri extends si{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*qe.ray,i.update(t,s,this.motor.reflow.ray[r]||null)}add(t={}){this.setName(t);let e=new ni(t,this.motor);return e.visible=void 0===t.visible||t.visible,this.addToWorld(e,t.id),t.parent&&"string"!=typeof t.parent&&(t.parent=t.parent.name),t.callback&&delete t.callback,this.motor.post({m:"add",o:t}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.setRay(t)}}class ni extends rt{constructor(t={},e){super(new r,e.getMat("line")),this.motor=e,this.Utils=this.motor.utils,this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=t.name,this.parentMesh=null,t.parent&&(this.parentMesh="string"==typeof t.parent?this.Utils.byName(t.parent):t.parent,this.data.parent=this.parentMesh),this.callback=t.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new nt,this.end=new nt(0,1,0),this.tmp=new nt,this.vnormal=new nt,this.vv1=new nt,this.vv2=new nt,this.fullDistance=0,this.setRay(t);this.geometry.setAttribute("position",new l([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new l([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.noRotation=t.noRotation||!1,this.fakeMatrix=new at,this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(t){t.begin&&this.begin.fromArray(t.begin),t.end&&this.end.fromArray(t.end),this.fullDistance=this.begin.distanceTo(this.end)}update(t,e=0,i=null){if(this.data.hit=0!==t[e],this.data.body=i||"",this.data.distance=t[e+1],this.data.hit)this.local[0]=t[e+2],this.local[1]=t[e+3],this.local[2]=t[e+4],this.tmp.fromArray(t,e+5),this.vnormal.fromArray(t,e+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(xe.angleTo(this.vv1.toArray(),this.data.normal)*ye);else if(this.parentMesh){let t;t=this.noRotation?this.fakeMatrix.setPosition(this.parentMesh.position.x,this.parentMesh.position.y,this.parentMesh.position.z):this.parentMesh.matrixWorld,this.tmp.copy(this.begin).applyMatrix4(t).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(t),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let t=this.vertices.array,e=this.colors.array,i=this.local,s=this.data.hit,r=s?this.c2:this.c1,n=s?this.c3:this.c1;e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=n[0],e[7]=n[1],e[8]=n[2],t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}class ai extends ot{constructor(t,e,i=0){super(t,e,i),this.matrixAutoUpdate=!1,this.tmpMatrix=new at,this.tmpQuat=new lt,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.outline=null,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(t){this.overMaterial&&(this.outline||(this.outline=new u(this.geometry,this.overMaterial)),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*t.idx),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=t.idx)}over(t){t&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!t&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new ht(new Float32Array(3*this.instanceMatrix.count),3)),e.isColor&&(e=e.toArray());let i=3*t;this.instanceColor.array[i]=e[0],this.instanceColor.array[i+1]=e[1],this.instanceColor.array[i+2]=e[2]}add(t,e=[0,0,0],i=[0,0,0,1],s=[1,1,1],r=null,n=null){3===i.length&&(i=this.tmpQuat.setFromEuler({_x:i[0],_y:i[1],_z:i[2],_order:"XYZ"},!1).toArray()),r&&(r.isColor&&(r=r.toArray()),null===this.instanceColor&&(this.instanceColor=new ht(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(e,i,s,r,n),this.tmpElement.push(t)}slice(t,e,i){let s=new Float32Array(i-e);for(let r=0;r<e+i;++r)s[r]=t[e+r];return s}remove(t){if(!this.count)return;this.tmpElement.splice(t,1);let e=[...this.instanceMatrix.array];e.splice(16*t,16),this.instanceMatrix=new ht(new Float32Array(e),16),null!==this.instanceColor&&(e=[...this.instanceColor.array],e.splice(3*t,3),this.instanceColor=new ht(new Float32Array(e),3)),null!==this.instanceUv&&(e=[...this.instanceUv.array],e.splice(2*t,2),this.instanceUv=new ht(new Float32Array(e),2)),this.count--,this.reDistribute()}reDistribute(){let t=this.count;for(;t--;)this.tmpElement[t].idx=t}getIDName(t){return this.tmpElement[t].name}getBodyList(){let t=[],e=this.count;for(;e--;)t.push(this.tmpElement[e].name);return t}expand(t,e,i,s=[1,1,1],r){let n=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:e[0],_y:e[1],_z:e[2],_w:e[3]},{x:i[0],y:i[1],z:i[2]}),this.instanceMatrix=new ht(new Float32Array([...n,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(n=this.instanceColor.array,this.instanceColor=new ht(new Float32Array([...n,...s]),3)),this.count++}setTransformAt(t,e,i,s){this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*t),this.needSphereUp=!0,this.outline&&this.currentOver===t&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(t){void 0!==t&&(this.isRay=t)}raycast(t,e){this.isRay&&(this.instanceMatrix.needsUpdate=!0,super.raycast(t,e))}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp&&this.computeBoundingSphere(),this.needSphereUp=!1,this.updateMatrix()}}class oi{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=s}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}}class li extends r{constructor(t=1,e=10,i=10,s=10,r=1){super(),this.type="SphereBox",this.name="SphereBox_"+t+"_"+e+"_"+i+"_"+s+"_"+r,t=t||1,e=Math.floor(e),i=Math.floor(i),s=Math.floor(s);let n,a=new k(1,1,1,e,i,s),o=new nt,l=new nt,h=a.attributes.position.array,c=a.attributes.normal.array;for(let e=0,i=a.attributes.position.count;e<i;e++)n=3*e,o.set(h[n],h[n+1],h[n+2]),l.copy(o).normalize(),o.lerp(l,r).multiplyScalar(t),h[n]=o.x,h[n+1]=o.y,h[n+2]=o.z,o.normalize(),c[n]=o.x,c[n+1]=o.y,c[n+2]=o.z;this.copy(a)}}class hi extends r{constructor(t=1,e=1,i=12,s=1){super(),this.type="CapsuleGeometry";let r=Math.PI,n=t/(2*t+e),a=1-2*n;i=Math.floor(i),s=Math.floor(s);let o=Math.floor(.5*i),l=2*Math.PI,h=.5*Math.PI,c=new M(t,t,e,i,s,!0);mi(c,0,n,1,a);let u=new x(t,i,o,0,l,0,h);mi(u,0,1-n,1,n);let d=new x(t,i,o,0,l,h,h);mi(d,0,0,1,n);let p=(new at).makeRotationY(.5*-r),m=(new at).makeTranslation(0,.5*e,0),f=(new at).makeTranslation(0,.5*-e,0);c.applyMatrix4(p),u.applyMatrix4(m),d.applyMatrix4(f);let g=Ee(Ce([c,u,d]));this.copy(g)}}class ci extends r{constructor(t=1,e=.4,i=8,s=6,r=2*Math.PI,n=0,a=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:s,arc:r},i=Math.floor(i),s=Math.floor(s);const o=[],h=[],c=[],u=[],d=new nt,p=new nt,m=new nt;let f,g;for(f=0;f<=i;f++)for(g=0;g<=s;g++){const o=g/s*r,l=f/i*a+n;p.x=(t+e*Math.cos(l))*Math.cos(o),p.y=(t+e*Math.cos(l))*Math.sin(o),p.z=e*Math.sin(l),h.push(p.x,p.y,p.z),d.x=t*Math.cos(o),d.y=t*Math.sin(o),m.subVectors(p,d).normalize(),c.push(m.x,m.y,m.z),u.push(g/s),u.push(f/i)}for(f=1;f<=i;f++)for(g=1;g<=s;g++){const t=(s+1)*f+g-1,e=(s+1)*(f-1)+g-1,i=(s+1)*(f-1)+g,r=(s+1)*f+g;o.push(t,e,r),o.push(e,i,r)}this.setIndex(o),this.setAttribute("position",new l(h,3)),this.setAttribute("normal",new l(c,3)),this.setAttribute("uv",new l(u,2))}}class ui extends r{constructor(t=1,e=1,i=1,s=.01,r=12,n=1,a=2){super(),this.type="ChamferCyl",r=Math.floor(r),n=Math.floor(n),a=Math.floor(a);let o=new at,l=new at,h=Math.PI,c=.5*h,u=2*h,d=s/i,p=1-2*d,m=new M(t,e,i-2*s,r,n,!0,0);o.makeRotationY(c),m.applyMatrix4(o),mi(m,0,d,1,p);let f=new ci(t-s,s,a,r,u,0,c),g=new ct(t-s,r);l.makeTranslation(0,0,s),g.applyMatrix4(l),mi(f,0,1-d,1,d);let y=Ce([f,g]);o.makeTranslation(0,0,.5*i-s),l.makeRotationX(-c),y.applyMatrix4(l.multiply(o)),f=new ci(e-s,s,a,r,u,0,c),g=new ct(e-s,r),l.makeTranslation(0,0,s),g.applyMatrix4(l),mi(f,0,1-d,1,d,!0);let v=Ce([f,g]);o.makeTranslation(0,0,.5*i-s),l.makeRotationX(c),v.applyMatrix4(l.multiply(o));let w=Ee(Ce([y,m,v]));this.copy(w)}}class di extends r{constructor(t=1,e=1,i=1,s=.01,r=1,n=1,a=1,o=2){super(),this.type="ChamferBox",r=Math.floor(r),n=Math.floor(n),a=Math.floor(a),o=Math.floor(o);let l=Math.PI,h=.5*l,c=2*s,u=.5*t,d=.5*e,p=.5*i,m=new at,f=new at,g=new at,y=s/t,v=1-2*y,w=s/e,b=1-2*y,x=s/i,k=1-2*x,A=new S(t-c,e-c,r,n),T=new M(s,s,t-c,o,r,!0,0,h),z=new M(s,s,e-c,o,n,!0,0,h),P=new pi(s,o,o,0,h,0,-h),C=new pi(s,o,o,0,h,0,-h);mi(A,-y,w,v,b),mi(T,0,y,w,v),f.makeTranslation(0,d-s,0),m.makeRotationX(h),P.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-d+s,0),m.makeRotationX(h),g.makeRotationY(-h),C.applyMatrix4(f.multiply(m).multiply(g));let R=Ce([z,P,C]),E=R.clone();f.makeTranslation(u-s,0,-s),R.applyMatrix4(f),f.makeTranslation(-u+s,0,-s),m.makeRotationZ(l),E.applyMatrix4(f.multiply(m));let _=T.clone();m.makeRotationZ(h),f.makeTranslation(0,d-s,-s),T.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-d+s,-s),m.makeRotationZ(-h),_.applyMatrix4(f.multiply(m));let L=Ce([T,_,A,R,E]),I=L.clone();f.makeTranslation(0,0,p),L.applyMatrix4(f),f.makeTranslation(0,0,-p),m.makeRotationY(l),I.applyMatrix4(f.multiply(m)),A=new S(i-c,e-c,a,n),T=new M(s,s,i-c,o,a,!0,0,h),_=T.clone(),mi(A,-x,w,k,b),f.makeTranslation(0,-(d-s),-s,0),m.makeRotationZ(-h),T.applyMatrix4(f.multiply(m)),f.makeTranslation(0,d-s,-s,0),m.makeRotationZ(h),_.applyMatrix4(f.multiply(m));let O=Ce([T,_,A]),D=O.clone();f.makeTranslation(-u,0,0),m.makeRotationY(-h),O.applyMatrix4(f.multiply(m)),f.makeTranslation(u,0,0),m.makeRotationY(h),D.applyMatrix4(f.multiply(m)),A=new S(t-c,i-c,r,a),mi(A,-y,x,v,k);let F=A.clone();f.makeTranslation(0,d,0),m.makeRotationX(-h),A.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-d,0),m.makeRotationX(h),F.applyMatrix4(f.multiply(m));let B=Ee(Ce([L,I,O,D,A,F]));fi(B,"box"),this.copy(B)}}class pi extends r{constructor(t=1,e=8,i=6,s=0,r=2*Math.PI,n=0,a=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:s,phiLength:r,thetaStart:n,thetaLength:a},e=Math.floor(e),i=Math.floor(i);const o=Math.min(n+a,Math.PI);let h=0;const c=[],u=new nt,d=new nt,p=[],m=[],f=[],g=[];for(let l=0;l<=i;l++){const p=[],y=l/i;let v=0;0==l&&0==n?v=.5/e:l==i&&o==Math.PI&&(v=-.5/e);for(let i=0;i<=e;i++){const o=i/e;u.x=-t*Math.cos(s+o*r)*Math.sin(n+y*a),u.y=t*Math.cos(n+y*a),u.z=t*Math.sin(s+o*r)*Math.sin(n+y*a),m.push(u.x,u.y,u.z),d.copy(u).normalize(),f.push(d.x,d.y,d.z),g.push(o+v,1-y),p.push(h++)}c.push(p)}for(let t=0;t<i;t++)for(let s=0;s<e;s++){const e=c[t][s+1],r=c[t][s],a=c[t+1][s],l=c[t+1][s+1];(0!==t||n>0)&&p.push(e,r,l),(t!==i-1||o<Math.PI)&&p.push(r,a,l)}this.setIndex(p),this.setAttribute("position",new l(m,3)),this.setAttribute("normal",new l(f,3)),this.setAttribute("uv",new l(g,2))}}function mi(t,e=0,i=0,s=1,r=1,n){let a=t.attributes.uv,o=a.array,l=a.count,h=0;for(;l--;)h=2*l,o[h]=o[h]*s-e,o[h+1]=o[h+1]*r+i,n&&(o[h]=1-o[h],o[h+1]=1-o[h+1])}function fi(t,e="sphere",i,s=[0,0,0],r=[0,0,0,1],n){if(void 0===n&&(n=new at),n.compose({x:s[0],y:s[1],z:s[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;i=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let a=new ut(new nt(-i/2,-i/2,-i/2),new nt(i/2,i/2,i/2)),o=[];o.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new l(o,2));let h,c,u,d,p,m=function(t,e,i){t.applyMatrix4(n),e.applyMatrix4(n),i.applyMatrix4(n);let s=1/(2*Math.PI),r=1/Math.PI;return t.normalize(),e.normalize(),i.normalize(),{uv0:new z(.5-Math.atan(t.z,-t.x)*s,.5-Math.asin(t.y)*r),uv1:new z(.5-Math.atan(e.z,-e.x)*s,.5-Math.asin(e.y)*r),uv2:new z(.5-Math.atan(i.z,-i.x)*s,.5-Math.asin(i.y)*r)}},f=function(t,e,s){t.applyMatrix4(n),e.applyMatrix4(n),s.applyMatrix4(n);let r=new nt;r.crossVectors(e.clone().sub(t),e.clone().sub(s)).normalize(),r.x<0||r.y<0||r.z,r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);let o=new z,l=new z,h=new z,c=1/i;return r.y>r.x&&r.y>r.z?(o.set(t.x-a.min.x,a.max.z-t.z).multiplyScalar(c),l.set(e.x-a.min.x,a.max.z-e.z).multiplyScalar(c),h.set(s.x-a.min.x,a.max.z-s.z).multiplyScalar(c)):r.x>r.y&&r.x>r.z?(o.set(t.z-a.min.z,t.y-a.min.y).multiplyScalar(c),l.set(e.z-a.min.z,e.y-a.min.y).multiplyScalar(c),h.set(s.z-a.min.z,s.y-a.min.y).multiplyScalar(c)):r.z>r.y&&r.z>r.x&&(o.set(t.x-a.min.x,t.y-a.min.y).multiplyScalar(c),l.set(e.x-a.min.x,e.y-a.min.y).multiplyScalar(c),h.set(s.x-a.min.x,s.y-a.min.y).multiplyScalar(c)),{uv0:o,uv1:l,uv2:h}},g=new nt,y=new nt,v=new nt;new nt,new nt,new nt;const w=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(h=0;h<t.index.count;h+=3)c=t.index.getX(h+0),u=t.index.getX(h+1),d=t.index.getX(h+2),g.fromBufferAttribute(w,c),y.fromBufferAttribute(w,u),v.fromBufferAttribute(w,d),p="sphere"===e?m(g,y,v):f(g,y,v),o[2*c]=p.uv0.x,o[2*c+1]=p.uv0.y,o[2*u]=p.uv1.x,o[2*u+1]=p.uv1.y,o[2*d]=p.uv2.x,o[2*d+1]=p.uv2.y;else for(h=0;h<w.count;h+=3){g.fromBufferAttribute(w,h+0),y.fromBufferAttribute(w,h+1),v.fromBufferAttribute(w,h+2),p="sphere"===e?m(g,y,v):f(g,y,v);let t=h,i=h+1,s=h+2;o[2*t]=p.uv0.x,o[2*t+1]=p.uv0.y,o[2*i]=p.uv1.x,o[2*i+1]=p.uv1.y,o[2*s]=p.uv2.x,o[2*s+1]=p.uv2.y}t.attributes.uv.array=new Float32Array(o),t.attributes.uv.needsUpdate=!0}const gi=new nt,yi=new dt,vi=new pt,wi=new nt,bi=new mt;class xi{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new Ai,this.unassigned=new Ai,this.vertices=[]}setFromPoints(t){if(t.length>=4){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.vertices.push(new Si(t[e]));this.compute()}return this}setFromObject(t){const e=[];return t.updateMatrixWorld(!0),t.traverse((function(t){const i=t.geometry;if(void 0!==i){const s=i.attributes.position;if(void 0!==s)for(let i=0,r=s.count;i<r;i++){const r=new nt;r.fromBufferAttribute(s,i).applyMatrix4(t.matrixWorld),e.push(r)}}})),this.setFromPoints(e)}containsPoint(t){const e=this.faces;for(let i=0,s=e.length;i<s;i++){if(e[i].distanceToPoint(t)>this.tolerance)return!1}return!0}intersectRay(t,e){const i=this.faces;let s=-1/0,r=1/0;for(let e=0,n=i.length;e<n;e++){const n=i[e],a=n.distanceToPoint(t.origin),o=n.normal.dot(t.direction);if(a>0&&o>=0)return null;const l=0!==o?-a/o:0;if(!(l<=0)&&(o>0?r=Math.min(l,r):s=Math.max(l,s),s>r))return null}return s!==-1/0?t.at(s,e):t.at(r,e),e}intersectsRay(t){return null!==this.intersectRay(t,gi)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this}removeVertexFromFace(t,e){return t===e.outside&&(null!==t.next&&t.next.face===e?e.outside=t.next:e.outside=null),this.assigned.remove(t),this}removeAllVerticesFromFace(t){if(null!==t.outside){const e=t.outside;let i=t.outside;for(;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}}deleteFaceVertices(t,e){const i=this.removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{let t=i;do{const i=t.next;e.distanceToPoint(t.point)>this.tolerance?this.addVertexToFace(t,e):this.unassigned.append(t),t=i}while(null!==t)}return this}resolveUnassignedPoints(t){if(!1===this.unassigned.isEmpty()){let e=this.unassigned.first();do{const i=e.next;let s=this.tolerance,r=null;for(let i=0;i<t.length;i++){const n=t[i];if(0===n.mark){const t=n.distanceToPoint(e.point);if(t>s&&(s=t,r=n),s>1e3*this.tolerance)break}}null!==r&&this.addVertexToFace(e,r),e=i}while(null!==e)}return this}computeExtremes(){const t=new nt,e=new nt,i=[],s=[];for(let t=0;t<3;t++)i[t]=s[t]=this.vertices[0];t.copy(this.vertices[0].point),e.copy(this.vertices[0].point);for(let r=0,n=this.vertices.length;r<n;r++){const n=this.vertices[r],a=n.point;for(let e=0;e<3;e++)a.getComponent(e)<t.getComponent(e)&&(t.setComponent(e,a.getComponent(e)),i[e]=n);for(let t=0;t<3;t++)a.getComponent(t)>e.getComponent(t)&&(e.setComponent(t,a.getComponent(t)),s[t]=n)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(t.x),Math.abs(e.x))+Math.max(Math.abs(t.y),Math.abs(e.y))+Math.max(Math.abs(t.z),Math.abs(e.z))),{min:i,max:s}}computeInitialHull(){const t=this.vertices,e=this.computeExtremes(),i=e.min,s=e.max;let r=0,n=0;for(let t=0;t<3;t++){const e=s[t].point.getComponent(t)-i[t].point.getComponent(t);e>r&&(r=e,n=t)}const a=i[n],o=s[n];let l,h;r=0,yi.set(a.point,o.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==a&&i!==o){yi.closestPointToPoint(i.point,!0,wi);const t=wi.distanceToSquared(i.point);t>r&&(r=t,l=i)}}r=-1,vi.setFromCoplanarPoints(a.point,o.point,l.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==a&&i!==o&&i!==l){const t=Math.abs(vi.distanceToPoint(i.point));t>r&&(r=t,h=i)}}const c=[];if(vi.distanceToPoint(h.point)<0){c.push(Mi.create(a,o,l),Mi.create(h,o,a),Mi.create(h,l,o),Mi.create(h,a,l));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge(e)),c[t+1].getEdge(1).setTwin(c[e+1].getEdge(0))}}else{c.push(Mi.create(a,l,o),Mi.create(h,a,o),Mi.create(h,o,l),Mi.create(h,l,a));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge((3-t)%3)),c[t+1].getEdge(0).setTwin(c[e+1].getEdge(1))}}for(let t=0;t<4;t++)this.faces.push(c[t]);for(let e=0,i=t.length;e<i;e++){const i=t[e];if(i!==a&&i!==o&&i!==l&&i!==h){r=this.tolerance;let t=null;for(let e=0;e<4;e++){const s=this.faces[e].distanceToPoint(i.point);s>r&&(r=s,t=this.faces[e])}null!==t&&this.addVertexToFace(i,t)}}return this}reindexFaces(){const t=[];for(let e=0;e<this.faces.length;e++){const i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let t,e=0;const i=this.assigned.first().face;let s=i.outside;do{const r=i.distanceToPoint(s.point);r>e&&(e=r,t=s),s=s.next}while(null!==s&&s.face===i);return t}}computeHorizon(t,e,i,s){let r;this.deleteFaceVertices(i),i.mark=1,r=null===e?e=i.getEdge(0):e.next;do{const e=r.twin,i=e.face;0===i.mark&&(i.distanceToPoint(t)>this.tolerance?this.computeHorizon(t,e,i,s):s.push(r)),r=r.next}while(r!==e);return this}addAdjoiningFace(t,e){const i=Mi.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)}addNewFaces(t,e){this.newFaces=[];let i=null,s=null;for(let r=0;r<e.length;r++){const n=e[r],a=this.addAdjoiningFace(t,n);null===i?i=a:a.next.setTwin(s),this.newFaces.push(a.face),s=a}return i.next.setTwin(s),this}addVertexToHull(t){const e=[];return this.unassigned.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),this.addNewFaces(t,e),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let t;for(this.computeInitialHull();void 0!==(t=this.nextVertexToAdd());)this.addVertexToHull(t);return this.reindexFaces(),this.cleanup(),this}}class Mi{constructor(){this.normal=new nt,this.midpoint=new nt,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(t,e,i){const s=new Mi,r=new ki(t,s),n=new ki(e,s),a=new ki(i,s);return r.next=a.prev=n,n.next=r.prev=a,a.next=n.prev=r,s.edge=r,s.compute()}getEdge(t){let e=this.edge;for(;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e}compute(){const t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return bi.set(t.point,e.point,i.point),bi.getNormal(this.normal),bi.getMidpoint(this.midpoint),this.area=bi.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(t){return this.normal.dot(t)-this.constant}}class ki{constructor(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1}lengthSquared(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1}setTwin(t){return this.twin=t,t.twin=this,this}}class Si{constructor(t){this.point=t,this.prev=null,this.next=null,this.face=null}}class Ai{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this}insertAfter(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this}append(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this}appendChain(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this}remove(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this}removeSubList(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this}isEmpty(){return null===this.head}}class Ti extends r{constructor(t=[]){super();const e=[],i=[],s=(new xi).setFromPoints(t).faces;for(let t=0;t<s.length;t++){const r=s[t];let n=r.edge;do{const t=n.head().point;e.push(t.x,t.y,t.z),i.push(r.normal.x,r.normal.y,r.normal.z),n=n.next}while(n!==r.edge)}this.setAttribute("position",new l(e,3)),this.setAttribute("normal",new l(i,3))}}class zi extends ft{constructor(t,e,i,s,n=[0,1,0],a=[0,.5,0],o=!1){if(super(),!t)return;if(!e)return;const h=new r;let c=.5*e-t,u=12,d=.2*t,p=[];const m=[t,c,0,t,-c,0,-t,c,0,-t,-c,0,0,c,t-d,0,c,t+d];p.push(...n,...a,...n,...a,...a,...a),o&&(m.push(0,c,t,0,-c,t,0,c,-t,0,-c,-t),p.push(...n,...a,...n,...a));for(let e=0,i=1;e<u;e++,i++){const s=e/u*Math.PI*2,r=i/u*Math.PI*2;m.push(t*Math.cos(s),c,t*Math.sin(s),t*Math.cos(r),c,t*Math.sin(r),t*Math.cos(s),-c,t*Math.sin(s),t*Math.cos(r),-c,t*Math.sin(r)),p.push(...n,...n,...a,...a)}for(let e=0,i=1;e<u;e++,i++){const s=e/u*Math.PI*2,r=i/u*Math.PI*2;let l=i<=6?1:-1;m.push(t*Math.cos(s),c*l+t*Math.sin(s),0,t*Math.cos(r),c*l+t*Math.sin(r),0),1===l?p.push(...n,...n):p.push(...a,...a),o&&(m.push(0,c*l+t*Math.sin(s),t*Math.cos(s),0,c*l+t*Math.sin(r),t*Math.cos(r)),1===l?p.push(...n,...n):p.push(...a,...a))}if(h.setAttribute("position",new l(m,3)),h.setAttribute("color",new l(p,3)),h.computeBoundingSphere(),this.colors=h.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=h,this.cone=new w(h,s),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!i)return;const f=new r,g=[.5*d,-c,t-d,.5*d,-c,t+d,.5*-d,-c,t-d,.5*-d,-c,t+d,.5*d,-c,t-d,.5*-d,-c,t-d,.5*-d,-c,t+d,-d,-c,t+d,.5*d,-c,t+d,d,-c,t+d,-d,-c,t+d,0,-c,t+2*d,d,-c,t+d,0,-c,t+2*d];p=[];let y=g.length/3;for(;y--;)p.push(1,0,0);f.setAttribute("position",new l(g,3)),f.setAttribute("color",new l(p,3)),this.direction=new w(f,s),this.direction.raycast=function(){return!1},this.add(this.direction)}over(t){t?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(t){let e=this.colors.length;for(;e--;)this.colors[e]=t?1:this.colorsbase[e];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(t){this.direction&&(this.direction.rotation.y=t)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}let Pi=null,Ci=null;const Ri=new nt(0,1,0),Ei=new nt(1,0,0),_i=new nt(0,0,1);class Li extends si{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,Pi=this.motor.geo,Ci=this.motor.mat,this.type="body",this.num=qe[this.type],this.full=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(t){this.num=qe[t?"bodyFull":"body"],this.full=t}step(t,e){const i=this.list;let s,r,n,a=i.length;for(;a--;)if(s=i[a],null!==s)if(r=e+a*this.num,s.actif){if(s.sleep=!(t[r]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.idx,s.sleep?Ze.sleep:Ze.body):(s.sleep||"sleep"!==s.material.name||(s.material=Ci.get("body")),s.sleep&&"body"===s.material.name&&(s.material=Ci.get("sleep")))),!s.sleep||s.isKinematic)if(s.position.fromArray(t,r+1),s.quaternion.fromArray(t,r+4),1!==this.motor.ws&&s.position.multiplyScalar(this.motor.uws),this.full?(s.velocity.fromArray(t,r+8),s.angular.fromArray(t,r+11)):s.getVelocity&&(n=this.motor.reflow.velocity[s.name],n&&(s.velocity.fromArray(n,0),s.angular.fromArray(n,3))),s.isInstance){if(s.speedMat){let e=.01*t[r];s.instance.setColorAt(s.idx,[e,e,e])}s.instance.setTransformAt(s.idx,s.position.toArray(),s.quaternion.toArray(),s.noScale?[1,1,1]:s.size),this.needMatrix&&s.matrixWorld.compose(s.position,s.quaternion,{x:1,y:1,z:1})}else s.auto||s.updateMatrix()}else s.actif=!0}geometry(t={},e=null,i=null){let s,n,a,o=t.size,l="",h=t.type,c=!1,d=!1,p=t.seg||16;const m="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(t.instance&&"compound"===h&&(h=t.shapes[0].type,o=t.shapes[0].size,t.translate=t.shapes[0].pos),"mesh"!==h&&"convex"!==h||(t.shape?t.shape.isMesh&&(t.shape=t.shape.geometry):t.mesh&&!t.v&&(t.shape=t.mesh.geometry)),t.radius&&("box"===h&&(h="ChamferBox"),"cylinder"===h&&(h="ChamferCyl")),t.geometry&&("convex"===h?t.shape=t.geometry:h="direct"),"PHYSX"===this.engine&&"cylinder"===t.type){let e=new M(t.size[0],t.size[0],t.size[1],p,1);t.isWheel&&e.rotateZ(-we),t.v=xe.getVertex(e),t.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===t.type){let e=new M(0,t.size[0],t.size[1],p,1);t.v=xe.getVertex(e),t.type="convex"}switch("stair"===t.type&&(t.type="box",h="box"),h){case"direct":s=t.geometry.clone(),t.size&&s.scale(t.size[0],t.size[1],t.size[2]),d=!0,c=!0;break;case"convex":if(t.v){if(t.nogeo)s=new r;else{let e=[];for(n=Math.floor(t.v.length/3);n--;)a=3*n,e.push(new nt(t.v[a],t.v[a+1],t.v[a+2]));s=new Ti(e)}d=!0,c=!0}if(t.shape){s=t.shape.clone(),t.size&&s.scale(t.size[0],t.size[0],t.size[0]),t.shapeScale&&s.scale(t.shapeScale[0],t.shapeScale[1],t.shapeScale[2]);let e=m?xe.toNonIndexed(s):null;t.v=xe.getVertex(e||s,m),t.index=xe.getIndex(e||s,m),this.engine,d=!0,c=!0}s.boundingBox||s.computeBoundingBox();let e=s.boundingBox;t.boxSize=[-e.min.x+e.max.x,-e.min.y+e.max.y,-e.min.z+e.max.z];break;case"mesh":if(s=t.shape.clone(),t.size&&s.scale(t.size[0],t.size[0],t.size[0]),t.v=xe.getVertex(s,m),t.index=xe.getIndex(s,m),"PHYSX"===this.engine){let e=new nt;xe.getCenter(s,e),t.massCenter||(t.massCenter=e.toArray())}d=!0,c=!0;break;case"customSphere":l="customSphere_"+o[0],s=Pi.get(l),s?l="":(s=new x(o[0],t.seg1||32,t.seg2||16),s.name=l),c=!0,t.type="sphere";break;case"highSphere":l="highSphere_"+o[0],s=Pi.get(l),s?l="":(s=new li(o[0]),s.name=l),c=!0,t.type="sphere";break;case"capsule":l="capsule_"+o[0]+"_"+o[1]+"_"+p,s=Pi.get(l),s?l="":(s=new hi(o[0],o[1],p),s.name=l),c=!0;break;case"ChamferBox":l="ChamferBox_"+o[0]+"_"+o[1]+"_"+o[2]+"_"+t.radius,s=Pi.get(l),s?l="":(s=new di(o[0],o[1],o[2],t.radius),s.name=l),c=!0;break;case"ChamferCyl":l="ChamferCyl_"+o[0]+"_"+o[1]+"_"+o[2]+"_"+t.radius+"_"+p,s=Pi.get(l),s?l="":(s=new ui(o[0],o[0],o[1],t.radius,p),s.name=l),c=!0;break;default:t.breakable?(s=Pi.get(h).clone(),s.scale(o[0],o[1],o[2]),d=!0,c=!0):s=Pi.get(h)}if(t.translate&&s.translate(t.translate[0],t.translate[1],t.translate[2]),t.shape&&delete t.shape,t.geometry&&delete t.geometry,(void 0===s.attributes.uv||t.autoUV)&&fi(s,"box",5,t.pos,t.quat),""!==l&&Pi.set(s),t.isWheel&&(s=s.clone(),s.rotateZ(-we),d=!0),d&&Pi.unic(s),null===e&&null===i)return s.noScale=c,s;t.meshRemplace&&t.debug&&(i=Ci.get("debug"));let f=new u(s,i);if(t.button&&(f.isButton=!0),t.helper){let e=t.hcolor||[.3,.1,0],i=t.hcolor2||[.8,.2,0],s=new zi(o[0],o[1]+2*o[0],!1,Ci.get("liner"),e,i,!0);f.add(s),f.userData.helper=s}t.localRot&&(t.localQuat=xe.quatFromEuler(t.localRot)),t.localPos&&f.position.fromArray(t.localPos),t.localQuat&&f.quaternion.fromArray(t.localQuat),c||f.scale.fromArray(t.size),void 0!==t.ray&&(t.ray||(f.raycast=()=>{})),t.meshRemplace&&!t.debug||(e.add(f),f.userData.helper&&(e.over=t=>{f.userData.helper.over(t)}))}add(t={}){t.worldScale&&delete(t=this.scaler(t,t.worldScale)).worldScale;let e,i,s,r=0;if(t.instance||(s=this.setName(t)),t.type=void 0===t.type?"box":t.type,"plane"!==t.type||t.visible||(t.visible=!1),"stair"===t.type){let e=new nt(0,0,t.size[2]),i=new nt(0,.5*t.size[1],.5*t.size[2]),s=e.angleTo(i),r=e.distanceTo(i);t.rot=[s*ye,0,0],t.size[1]*=t.div||.2,t.size[2]=2*r;let n=new nt(0,.5*-t.size[1],0);n.applyAxisAngle({x:1,y:0,z:0},s),t.pos[1]+=n.y,t.pos[2]+=n.z}if(t.massCenter&&-1===Ie.indexOf(this.engine))if("compound"!==t.type)t.shapes=[{type:t.type,pos:t.massCenter,size:t.size}],t.seg&&(t.shapes[0].seg=t.seg),t.radius&&(t.shapes[0].radius=t.radius),delete t.size,t.type="compound";else for(e=0;e<t.shapes.length;e++)i=t.shapes[e],i.pos?i.pos=xe.addArray(i.pos,t.massCenter):i.pos=t.massCenter;void 0!==t.collision&&!1===t.collision&&("PHYSX"===this.engine&&(t.flags=0),"OIMO"===this.engine&&(t.mask=0)),t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=xe.quatFromEuler(t.rot)),void 0!==t.meshRot&&(t.meshQuat=xe.quatFromEuler(t.meshRot)),t.size=xe.autoSize(t.size,t.type),t.meshScale&&(t.meshScale=xe.autoSize(t.meshScale));let n,a=!1;!1===t.visible&&(t.material="hide"),void 0!==t.material?n=t.material.constructor===String?Ci.get(t.material):t.material:(a=!0,n=Ci.get(this.type),t.instance&&(n=Ci.get("base"))),t.unicMat&&(n=n.clone(),Ci.addToTmp(n));let o=t.instance?{}:new ft;if(t.mesh&&!t.instance){"terrain"===t.mesh.type&&(t.noClone=!0);let e=t.noClone?t.mesh:t.mesh.clone();if(e.position.fromArray(t.meshPos||[0,0,0]),t.meshQuat&&e.quaternion.fromArray(t.meshQuat),t.meshSize&&e.scale.set(1,1,1).multiplyScalar(t.meshSize),t.meshScale&&e.scale.fromArray(t.meshScale),!a&&(e.material=n,e.children&&!t.nofullmat))for(let t in e.children)e.children[t].material=n;this.motor.tmpMesh.push(e),t.meshRemplace=!0,o.add(e)}switch(t.type){case"null":break;case"compound":for(e=0;e<t.shapes.length;e++)i=t.shapes[e],i.type=void 0===i.type?"box":i.type,i.size=xe.autoSize(i.size,i.type),i.pos&&(i.localPos=i.pos),void 0!==i.rot&&(i.quat=xe.quatFromEuler(i.rot)),i.quat&&(i.localQuat=i.quat),i.debug=t.debug,i.meshRemplace=t.meshRemplace||!1,t.instance?"convex"===i.type&&(i.v=xe.getVertex(i.shape,!1)):this.geometry(i,o,n),r+=xe.getVolume(i.type,i.size,i.v);break;default:t.instance?"convex"===t.type&&(t.v=xe.getVertex(t.shape,!1)):this.geometry(t,o,n),r=xe.getVolume(t.type,t.size,t.v)}if(o.type=this.type,o.size=t.size,o.shapetype=t.type,o.isKinematic=t.kinematic||!1,o.link=0,o.meshSize=t.meshSize?t.meshSize:1,o.velocity=new nt,o.angular=new nt,o.sleep=t.sleep||!1,o.defMat=!1,t.button&&(o.isButton=!0),o.isRay=void 0===t.ray||t.ray,o.material&&a&&(o.defMat="body"===o.material.name),t.instance){o.isInstance=!0,o.instance=this.getInstance(t,n),o.instance.isRay=o.isRay,o.over=o.instance.over,o.isRay=!1,o.isOver=!1,o.speedMat=t.speedMat||!1,o.defMat="base"===o.instance.material.name,o.idx=o.instance.count,o.name=t.name?t.name:o.instance.name+o.idx,t.name=o.name,o.noScale=o.instance.noScale,t.sizeByInstance&&(o.noScale=!1);let e=t.color;o.defMat&&(e=t.sleep?Ze.sleep:Ze.body),o.instance.add(o,t.pos,t.quat,o.noScale?[1,1,1]:o.size,e),o.position=(new nt).fromArray(t.pos),o.quaternion=(new oi).fromArray(t.quat),this.needMatrix&&(o.matrixWorld=new at),o.instance.v&&(t.v=o.instance.v),o.instance.index&&(t.index=o.instance.index),t.type=o.instance.type,o.actif=!1}else o.name=s,o.isRay||o.traverse((function(t){t.isObject3D&&(t.raycast=()=>{})})),t.renderOrder&&(o.renderOrder=t.renderOrder),void 0===t.visible&&(t.visible=!0),void 0===t.shadow&&(t.shadow=t.visible),o.dispose=function(){this.clearOutLine&&this.clearOutLine(),this.traverse((function(t){t.isMesh&&t.unic&&t.geometry.dispose()})),this.children=[]}.bind(o),o.visible=void 0===t.visible||t.visible,Object.defineProperty(o,"material",{get(){return this.children[0]?this.children[0].material:null},set(t){this.traverse((function(e){e.isMesh&&"outline"!==e.name&&(e.material=t)}))}}),Object.defineProperty(o,"castShadow",{get(){return!!this.children[0]&&this.children[0].castShadow},set(t){this.traverse((function(e){e.isMesh&&(e.castShadow=t)}))}}),Object.defineProperty(o,"receiveShadow",{get(){return!!this.children[0]&&this.children[0].receiveShadow},set(t){this.traverse((function(e){e.isMesh&&(e.receiveShadow=t)}))}}),o.receiveShadow=t.shadow,o.castShadow=t.shadow,this.motor.mouseActive&&(o.overMaterial=Ci.get("outline"),o.isOver=!1,o.addOutLine=function(){this.children[0].isMesh&&(this.outline=(new u).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline))}.bind(o),o.clearOutLine=function(){this.outline&&(this.remove(this.outline),this.outline=null)}.bind(o),o.over=function(t){t&&!this.isOver&&this.addOutLine(),!t&&this.isOver&&this.clearOutLine(),this.isOver=t}.bind(o),o.select=function(t){}.bind(o)),this.set(t,o);if(t.breakable){let e=o,i=e.children[0];e.remove(i),o=i,o.position.copy(e.position),o.quaternion.copy(e.quaternion),o.name=s,o.type=this.type,o.breakable=!0,o.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1],o.ignore=t.ignore||[],o.size=t.size,o.shapetype=t.type,o.isKinematic=t.kinematic||!1,o.link=0,o.meshSize=t.meshSize?t.meshSize:1,o.velocity=new nt,o.angular=new nt,o.sleep=t.sleep||!1,o.defMat=!1,o.auto=t.auto||!1,o.auto?o.matrixAutoUpdate=!0:(o.matrixAutoUpdate=!1,o.updateMatrix())}if(o.mass=t.mass||0,o.density=t.density||0,o.density&&!o.mass?o.mass=xe.massFromDensity(o.density,r):o.mass&&!o.density&&(o.density=xe.densityFromMass(o.mass,r),"RAPIER"!==this.engine&&"OIMO"!==this.engine&&"PHYSX"!==this.engine||(t.density=o.density)),t.massInfo&&console.log("%c"+o.name+" %cdensity:"+o.density+" mass:"+o.mass,"font-size:16px","font-size:12px"),t.getVelocity&&(o.getVelocity=!0),this.addToWorld(o,t.id),t.onlyMakeMesh)return o;if(t.phySize&&(t.size=t.phySize),t.phyPos&&(t.pos=t.phyPos),t.rot&&delete t.rot,t.mesh&&delete t.mesh,t.meshRot&&delete t.meshRot,t.instance&&delete t.instance,t.material&&delete t.material,t.parent&&delete t.parent,t.solver&&"PHYSX"===this.engine){t.mass=o.mass;this.byName(t.solver).addBone(t.name)}if(t.sleep&&this.set(t,o),this.motor.post({m:"add",o:t}),t.breakable){this.motor.getBreaker().add(o)}return o}dispatchEvent(t,e,i){this.byName(t).dispatchEvent({type:e,data:i})}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.getVelocity&&(e.getVelocity=t.getVelocity),e.isInstance?(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),(t.pos||t.quat)&&e.instance.setTransformAt(e.idx,e.position.toArray(),e.quaternion.toArray(),e.noScale?[1,1,1]:e.size)):(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),e.auto=t.auto||!1,e.auto?e.matrixAutoUpdate=!0:(e.matrixAutoUpdate=!1,e.updateMatrix())))}getTransform(t){if("string"==typeof t&&(t=this.byName(o.name)),null===t)return;t.updateWorldMatrix(!0,!1);const e=t.matrixWorld.elements;return{position:t.position.clone(),up:Ri.clone().set(e[4],e[5],e[6]).normalize(),right:Ei.clone().set(e[0],e[1],e[2]).normalize(),forward:_i.clone().set(e[8],e[9],e[10]).normalize()}}clearInstance(t){let e=this.motor.instanceMesh[t],i=e.getBodyList();this.motor.remove(i),e.dispose(),delete this.motor.instanceMesh[t]}getInstance(t,e){if(this.motor.instanceMesh[t.instance])return this.motor.instanceMesh[t.instance];(t={...t}).sizeByInstance&&(t.size=[1,1,1]);let i=this.geometry(t);t.mesh&&(!t.material&&t.mesh.material&&(e=t.mesh.material),i=t.mesh.isObject3D?t.mesh.geometry.clone():t.mesh.clone(),t.meshSize&&i.scale(t.meshSize,t.meshSize,t.meshSize),t.meshScale&&i.scale(t.meshScale[0],t.meshScale[1],t.meshScale[2]),i.noScale=!0);let s=new ai(i,e,0);return s.type=t.type,s.noScale=i.noScale,"convex"===s.type&&(s.v=t.v),t.index&&(s.index=t.index),s.receiveShadow=void 0===t.shadow||t.shadow,s.castShadow=void 0===t.shadow||t.shadow,this.motor.mouseActive&&(s.overMaterial=Ci.get("outline")),s.name=t.instance,this.motor.scene.add(s),this.motor.instanceMesh[t.instance]=s,s}scaler(t,e){if(t.size&&(t.size=math.worldscale(t.size,e)),t.pos&&(t.pos=math.worldscale(t.pos,e)),"convex"===t.type&&(t.shapeScale=[e,e,e]),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(i.size=math.scaleArray(i.size,e)),i.pos&&(i.pos=math.scaleArray(i.pos,e)),"convex"===i.type&&(i.shapeScale=[e,e,e])}return t.mesh&&(t.meshScale=[e,e,e]),t}}const Ii=i;class Oi extends t{constructor(t){super(t),this.defaultDPI=90,this.defaultUnit="px"}load(t,i,s,r){const n=this,a=new e(n.manager);a.setPath(n.path),a.setRequestHeader(n.requestHeader),a.setWithCredentials(n.withCredentials),a.load(t,(function(e){try{i(n.parse(e))}catch(e){r?r(e):console.error(e),n.manager.itemError(t)}}),s,r)}parse(t){const e=this;function i(t,e,i,r,n,a,o,l){if(0==e||0==i)return void t.lineTo(l.x,l.y);r=r*Math.PI/180,e=Math.abs(e),i=Math.abs(i);const h=(o.x-l.x)/2,c=(o.y-l.y)/2,u=Math.cos(r)*h+Math.sin(r)*c,d=-Math.sin(r)*h+Math.cos(r)*c;let p=e*e,m=i*i;const f=u*u,g=d*d,y=f/p+g/m;if(y>1){const t=Math.sqrt(y);p=(e*=t)*e,m=(i*=t)*i}const v=p*g+m*f,w=(p*m-v)/v;let b=Math.sqrt(Math.max(0,w));n===a&&(b=-b);const x=b*e*d/i,M=-b*i*u/e,k=Math.cos(r)*x-Math.sin(r)*M+(o.x+l.x)/2,S=Math.sin(r)*x+Math.cos(r)*M+(o.y+l.y)/2,A=s(1,0,(u-x)/e,(d-M)/i),T=s((u-x)/e,(d-M)/i,(-u-x)/e,(-d-M)/i)%(2*Math.PI);t.currentPath.absellipse(k,S,e,i,A,A+T,0===a,r)}function s(t,e,i,s){const r=t*i+e*s,n=Math.sqrt(t*t+e*e)*Math.sqrt(i*i+s*s);let a=Math.acos(Math.max(-1,Math.min(1,r/n)));return t*s-e*i<0&&(a=-a),a}function r(t,e){e=Object.assign({},e);let i={};if(t.hasAttribute("class")){const e=t.getAttribute("class").split(/\s/).filter(Boolean).map((t=>t.trim()));for(let t=0;t<e.length;t++)i=Object.assign(i,f["."+e[t]])}function s(s,r,n){void 0===n&&(n=function(t){return t.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),t}),t.hasAttribute(s)&&(e[r]=n(t.getAttribute(s))),i[s]&&(e[r]=n(i[s])),t.style&&""!==t.style[s]&&(e[r]=n(t.style[s]))}function r(t){return Math.max(0,Math.min(1,h(t)))}function n(t){return Math.max(0,h(t))}return t.hasAttribute("id")&&(i=Object.assign(i,f["#"+t.getAttribute("id")])),s("fill","fill"),s("fill-opacity","fillOpacity",r),s("fill-rule","fillRule"),s("opacity","opacity",r),s("stroke","stroke"),s("stroke-opacity","strokeOpacity",r),s("stroke-width","strokeWidth",n),s("stroke-linejoin","strokeLineJoin"),s("stroke-linecap","strokeLineCap"),s("stroke-miterlimit","strokeMiterLimit",n),s("visibility","visibility"),e}function n(t,e){return t-(e-t)}function a(t,e,i){if("string"!=typeof t)throw new TypeError("Invalid input: "+typeof t);const s={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let r=0,n=!0,a="",o="";const l=[];function h(t,e,i){const s=new SyntaxError('Unexpected character "'+t+'" at index '+e+".");throw s.partial=i,s}function c(){""!==a&&(""===o?l.push(Number(a)):l.push(Number(a)*Math.pow(10,Number(o)))),a="",o=""}let u;const d=t.length;for(let p=0;p<d;p++)if(u=t[p],Array.isArray(e)&&e.includes(l.length%i)&&s.FLAGS.test(u))r=1,a=u,c();else{if(0===r){if(s.WHITESPACE.test(u))continue;if(s.DIGIT.test(u)||s.SIGN.test(u)){r=1,a=u;continue}if(s.POINT.test(u)){r=2,a=u;continue}s.COMMA.test(u)&&(n&&h(u,p,l),n=!0)}if(1===r){if(s.DIGIT.test(u)){a+=u;continue}if(s.POINT.test(u)){a+=u,r=2;continue}if(s.EXP.test(u)){r=3;continue}s.SIGN.test(u)&&1===a.length&&s.SIGN.test(a[0])&&h(u,p,l)}if(2===r){if(s.DIGIT.test(u)){a+=u;continue}if(s.EXP.test(u)){r=3;continue}s.POINT.test(u)&&"."===a[a.length-1]&&h(u,p,l)}if(3===r){if(s.DIGIT.test(u)){o+=u;continue}if(s.SIGN.test(u)){if(""===o){o+=u;continue}1===o.length&&s.SIGN.test(o)&&h(u,p,l)}}s.WHITESPACE.test(u)?(c(),r=0,n=!1):s.COMMA.test(u)?(c(),r=0,n=!0):s.SIGN.test(u)?(c(),r=1,a=u):s.POINT.test(u)?(c(),r=2,a=u):h(u,p,l)}return c(),l}const o=["mm","cm","in","pt","pc","px"],l={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function h(t){let i,s="px";if("string"==typeof t||t instanceof String)for(let e=0,i=o.length;e<i;e++){const i=o[e];if(t.endsWith(i)){s=i,t=t.substring(0,t.length-i.length);break}}return"px"===s&&"px"!==e.defaultUnit?i=l.in[e.defaultUnit]/e.defaultDPI:(i=l[s][e.defaultUnit],i<0&&(i=l[s].in*e.defaultDPI)),i*parseFloat(t)}function c(t){const e=t.elements;return e[0]*e[4]-e[1]*e[3]<0}function u(t){const e=t.elements,i=e[0]*e[3]+e[1]*e[4];if(0===i)return!1;const s=d(t),r=p(t);return Math.abs(i/(s*r))>Number.EPSILON}function d(t){const e=t.elements;return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function p(t){const e=t.elements;return Math.sqrt(e[3]*e[3]+e[4]*e[4])}const m=[],f={},g=[],y=new gt,v=new gt,w=new gt,b=new gt,x=new z,M=new nt,k=new gt,S=(new DOMParser).parseFromString(t,"image/svg+xml");!function t(e,s){if(1!==e.nodeType)return;const o=function(t){if(!(t.hasAttribute("transform")||"use"===t.nodeName&&(t.hasAttribute("x")||t.hasAttribute("y"))))return null;const e=function(t){const e=new gt,i=y;if("use"===t.nodeName&&(t.hasAttribute("x")||t.hasAttribute("y"))){const i=h(t.getAttribute("x")),s=h(t.getAttribute("y"));e.translate(i,s)}if(t.hasAttribute("transform")){const s=t.getAttribute("transform").split(")");for(let t=s.length-1;t>=0;t--){const r=s[t].trim();if(""===r)continue;const n=r.indexOf("("),o=r.length;if(n>0&&n<o){const t=r.slice(0,n),e=a(r.slice(n+1));switch(i.identity(),t){case"translate":if(e.length>=1){const t=e[0];let s=0;e.length>=2&&(s=e[1]),i.translate(t,s)}break;case"rotate":if(e.length>=1){let t=0,s=0,r=0;t=e[0]*Math.PI/180,e.length>=3&&(s=e[1],r=e[2]),v.makeTranslation(-s,-r),w.makeRotation(t),b.multiplyMatrices(w,v),v.makeTranslation(s,r),i.multiplyMatrices(v,b)}break;case"scale":if(e.length>=1){const t=e[0];let s=t;e.length>=2&&(s=e[1]),i.scale(t,s)}break;case"skewX":1===e.length&&i.set(1,Math.tan(e[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===e.length&&i.set(1,0,0,Math.tan(e[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===e.length&&i.set(e[0],e[2],e[4],e[1],e[3],e[5],0,0,1)}}e.premultiply(i)}}return e}(t);g.length>0&&e.premultiply(g[g.length-1]);return k.copy(e),g.push(e),e}(e);let l=!1,S=null;switch(e.nodeName){case"svg":case"g":s=r(e,s);break;case"style":!function(t){if(!t.sheet||!t.sheet.cssRules||!t.sheet.cssRules.length)return;for(let e=0;e<t.sheet.cssRules.length;e++){const i=t.sheet.cssRules[e];if(1!==i.type)continue;const s=i.selectorText.split(/,/gm).filter(Boolean).map((t=>t.trim()));for(let t=0;t<s.length;t++){const e=Object.fromEntries(Object.entries(i.style).filter((([,t])=>""!==t)));f[s[t]]=Object.assign(f[s[t]]||{},e)}}}(e);break;case"path":s=r(e,s),e.hasAttribute("d")&&(S=function(t){const e=new xt,s=new z,r=new z,o=new z;let l=!0,h=!1;const c=t.getAttribute("d");if(""===c||"none"===c)return null;const u=c.match(/[a-df-z][^a-df-z]*/gi);for(let t=0,c=u.length;t<c;t++){const c=u[t],d=c.charAt(0),p=c.slice(1).trim();let m;switch(!0===l&&(h=!0,l=!1),d){case"M":m=a(p);for(let t=0,i=m.length;t<i;t+=2)s.x=m[t+0],s.y=m[t+1],r.x=s.x,r.y=s.y,0===t?e.moveTo(s.x,s.y):e.lineTo(s.x,s.y),0===t&&o.copy(s);break;case"H":m=a(p);for(let t=0,i=m.length;t<i;t++)s.x=m[t],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"V":m=a(p);for(let t=0,i=m.length;t<i;t++)s.y=m[t],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"L":m=a(p);for(let t=0,i=m.length;t<i;t+=2)s.x=m[t+0],s.y=m[t+1],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"C":m=a(p);for(let t=0,i=m.length;t<i;t+=6)e.bezierCurveTo(m[t+0],m[t+1],m[t+2],m[t+3],m[t+4],m[t+5]),r.x=m[t+2],r.y=m[t+3],s.x=m[t+4],s.y=m[t+5],0===t&&!0===h&&o.copy(s);break;case"S":m=a(p);for(let t=0,i=m.length;t<i;t+=4)e.bezierCurveTo(n(s.x,r.x),n(s.y,r.y),m[t+0],m[t+1],m[t+2],m[t+3]),r.x=m[t+0],r.y=m[t+1],s.x=m[t+2],s.y=m[t+3],0===t&&!0===h&&o.copy(s);break;case"Q":m=a(p);for(let t=0,i=m.length;t<i;t+=4)e.quadraticCurveTo(m[t+0],m[t+1],m[t+2],m[t+3]),r.x=m[t+0],r.y=m[t+1],s.x=m[t+2],s.y=m[t+3],0===t&&!0===h&&o.copy(s);break;case"T":m=a(p);for(let t=0,i=m.length;t<i;t+=2){const i=n(s.x,r.x),a=n(s.y,r.y);e.quadraticCurveTo(i,a,m[t+0],m[t+1]),r.x=i,r.y=a,s.x=m[t+0],s.y=m[t+1],0===t&&!0===h&&o.copy(s)}break;case"A":m=a(p,[3,4],7);for(let t=0,n=m.length;t<n;t+=7){if(m[t+5]==s.x&&m[t+6]==s.y)continue;const n=s.clone();s.x=m[t+5],s.y=m[t+6],r.x=s.x,r.y=s.y,i(e,m[t],m[t+1],m[t+2],m[t+3],m[t+4],n,s),0===t&&!0===h&&o.copy(s)}break;case"m":m=a(p);for(let t=0,i=m.length;t<i;t+=2)s.x+=m[t+0],s.y+=m[t+1],r.x=s.x,r.y=s.y,0===t?e.moveTo(s.x,s.y):e.lineTo(s.x,s.y),0===t&&o.copy(s);break;case"h":m=a(p);for(let t=0,i=m.length;t<i;t++)s.x+=m[t],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"v":m=a(p);for(let t=0,i=m.length;t<i;t++)s.y+=m[t],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"l":m=a(p);for(let t=0,i=m.length;t<i;t+=2)s.x+=m[t+0],s.y+=m[t+1],r.x=s.x,r.y=s.y,e.lineTo(s.x,s.y),0===t&&!0===h&&o.copy(s);break;case"c":m=a(p);for(let t=0,i=m.length;t<i;t+=6)e.bezierCurveTo(s.x+m[t+0],s.y+m[t+1],s.x+m[t+2],s.y+m[t+3],s.x+m[t+4],s.y+m[t+5]),r.x=s.x+m[t+2],r.y=s.y+m[t+3],s.x+=m[t+4],s.y+=m[t+5],0===t&&!0===h&&o.copy(s);break;case"s":m=a(p);for(let t=0,i=m.length;t<i;t+=4)e.bezierCurveTo(n(s.x,r.x),n(s.y,r.y),s.x+m[t+0],s.y+m[t+1],s.x+m[t+2],s.y+m[t+3]),r.x=s.x+m[t+0],r.y=s.y+m[t+1],s.x+=m[t+2],s.y+=m[t+3],0===t&&!0===h&&o.copy(s);break;case"q":m=a(p);for(let t=0,i=m.length;t<i;t+=4)e.quadraticCurveTo(s.x+m[t+0],s.y+m[t+1],s.x+m[t+2],s.y+m[t+3]),r.x=s.x+m[t+0],r.y=s.y+m[t+1],s.x+=m[t+2],s.y+=m[t+3],0===t&&!0===h&&o.copy(s);break;case"t":m=a(p);for(let t=0,i=m.length;t<i;t+=2){const i=n(s.x,r.x),a=n(s.y,r.y);e.quadraticCurveTo(i,a,s.x+m[t+0],s.y+m[t+1]),r.x=i,r.y=a,s.x=s.x+m[t+0],s.y=s.y+m[t+1],0===t&&!0===h&&o.copy(s)}break;case"a":m=a(p,[3,4],7);for(let t=0,n=m.length;t<n;t+=7){if(0==m[t+5]&&0==m[t+6])continue;const n=s.clone();s.x+=m[t+5],s.y+=m[t+6],r.x=s.x,r.y=s.y,i(e,m[t],m[t+1],m[t+2],m[t+3],m[t+4],n,s),0===t&&!0===h&&o.copy(s)}break;case"Z":case"z":e.currentPath.autoClose=!0,e.currentPath.curves.length>0&&(s.copy(o),e.currentPath.currentPoint.copy(s),l=!0);break;default:console.warn(c)}h=!1}return e}(e));break;case"rect":s=r(e,s),S=function(t){const e=h(t.getAttribute("x")||0),i=h(t.getAttribute("y")||0),s=h(t.getAttribute("rx")||t.getAttribute("ry")||0),r=h(t.getAttribute("ry")||t.getAttribute("rx")||0),n=h(t.getAttribute("width")),a=h(t.getAttribute("height")),o=.448084975506,l=new xt;l.moveTo(e+s,i),l.lineTo(e+n-s,i),(0!==s||0!==r)&&l.bezierCurveTo(e+n-s*o,i,e+n,i+r*o,e+n,i+r);l.lineTo(e+n,i+a-r),(0!==s||0!==r)&&l.bezierCurveTo(e+n,i+a-r*o,e+n-s*o,i+a,e+n-s,i+a);l.lineTo(e+s,i+a),(0!==s||0!==r)&&l.bezierCurveTo(e+s*o,i+a,e,i+a-r*o,e,i+a-r);l.lineTo(e,i+r),(0!==s||0!==r)&&l.bezierCurveTo(e,i+r*o,e+s*o,i,e+s,i);return l}(e);break;case"polygon":s=r(e,s),S=function(t){function e(t,e,i){const n=h(e),a=h(i);0===r?s.moveTo(n,a):s.lineTo(n,a),r++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,s=new xt;let r=0;return t.getAttribute("points").replace(i,e),s.currentPath.autoClose=!0,s}(e);break;case"polyline":s=r(e,s),S=function(t){function e(t,e,i){const n=h(e),a=h(i);0===r?s.moveTo(n,a):s.lineTo(n,a),r++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,s=new xt;let r=0;return t.getAttribute("points").replace(i,e),s.currentPath.autoClose=!1,s}(e);break;case"circle":s=r(e,s),S=function(t){const e=h(t.getAttribute("cx")||0),i=h(t.getAttribute("cy")||0),s=h(t.getAttribute("r")||0),r=new bt;r.absarc(e,i,s,0,2*Math.PI);const n=new xt;return n.subPaths.push(r),n}(e);break;case"ellipse":s=r(e,s),S=function(t){const e=h(t.getAttribute("cx")||0),i=h(t.getAttribute("cy")||0),s=h(t.getAttribute("rx")||0),r=h(t.getAttribute("ry")||0),n=new bt;n.absellipse(e,i,s,r,0,2*Math.PI);const a=new xt;return a.subPaths.push(n),a}(e);break;case"line":s=r(e,s),S=function(t){const e=h(t.getAttribute("x1")||0),i=h(t.getAttribute("y1")||0),s=h(t.getAttribute("x2")||0),r=h(t.getAttribute("y2")||0),n=new xt;return n.moveTo(e,i),n.lineTo(s,r),n.currentPath.autoClose=!1,n}(e);break;case"defs":l=!0;break;case"use":s=r(e,s);const o=(e.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),c=e.viewportElement.getElementById(o);c?t(c,s):console.warn("SVGLoader: 'use node' references non-existent node id: "+o)}S&&(void 0!==s.fill&&"none"!==s.fill&&S.color.setStyle(s.fill,Ii),function(t,e){function i(t){M.set(t.x,t.y,1).applyMatrix3(e),t.set(M.x,M.y)}function s(t){const i=t.xRadius,s=t.yRadius,r=Math.cos(t.aRotation),n=Math.sin(t.aRotation),a=new nt(i*r,i*n,0),o=new nt(-s*n,s*r,0),l=a.applyMatrix3(e),h=o.applyMatrix3(e),u=y.set(l.x,h.x,0,l.y,h.y,0,0,0,1),d=v.copy(u).invert(),p=w.copy(d).transpose().multiply(d).elements,m=function(t,e,i){let s,r,n,a,o;const l=t+i,h=t-i,c=Math.sqrt(h*h+4*e*e);l>0?(s=.5*(l+c),o=1/s,r=t*o*i-e*o*e):l<0?r=.5*(l-c):(s=.5*c,r=-.5*c);n=h>0?h+c:h-c;Math.abs(n)>2*Math.abs(e)?(o=-2*e/n,a=1/Math.sqrt(1+o*o),n=o*a):0===Math.abs(e)?(n=1,a=0):(o=-.5*n/e,n=1/Math.sqrt(1+o*o),a=o*n);h>0&&(o=n,n=-a,a=o);return{rt1:s,rt2:r,cs:n,sn:a}}(p[0],p[1],p[4]),f=Math.sqrt(m.rt1),g=Math.sqrt(m.rt2);t.xRadius=1/f,t.yRadius=1/g,t.aRotation=Math.atan2(m.sn,m.cs);if(!((t.aEndAngle-t.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const i=v.set(f,0,0,0,g,0,0,0,1),s=w.set(m.cs,m.sn,0,-m.sn,m.cs,0,0,0,1),r=i.multiply(s).multiply(u),n=t=>{const{x:e,y:i}=new nt(Math.cos(t),Math.sin(t),0).applyMatrix3(r);return Math.atan2(i,e)};t.aStartAngle=n(t.aStartAngle),t.aEndAngle=n(t.aEndAngle),c(e)&&(t.aClockwise=!t.aClockwise)}}function r(t){const i=d(e),s=p(e);t.xRadius*=i,t.yRadius*=s;const r=i>Number.EPSILON?Math.atan2(e.elements[1],e.elements[0]):Math.atan2(-e.elements[3],e.elements[4]);t.aRotation+=r,c(e)&&(t.aStartAngle*=-1,t.aEndAngle*=-1,t.aClockwise=!t.aClockwise)}const n=t.subPaths;for(let t=0,a=n.length;t<a;t++){const a=n[t].curves;for(let t=0;t<a.length;t++){const n=a[t];n.isLineCurve?(i(n.v1),i(n.v2)):n.isCubicBezierCurve?(i(n.v0),i(n.v1),i(n.v2),i(n.v3)):n.isQuadraticBezierCurve?(i(n.v0),i(n.v1),i(n.v2)):n.isEllipseCurve&&(x.set(n.aX,n.aY),i(x),n.aX=x.x,n.aY=x.y,u(e)?s(n):r(n))}}}(S,k),m.push(S),S.userData={node:e,style:s});const A=e.childNodes;for(let e=0;e<A.length;e++){const i=A[e];l&&"style"!==i.nodeName&&"defs"!==i.nodeName||t(i,s)}o&&(g.pop(),g.length>0?k.copy(g[g.length-1]):k.identity())}(S.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:m,xml:S.documentElement}}static createShapes(t){const e=999999999,i=0,s=1,r=2,n=3,a=4,o=5,l=6,h={loc:i,t:0};function c(t,e,s,n){const a=t.x,o=e.x,l=s.x,c=n.x,d=t.y,p=e.y,m=s.y,f=n.y,g=(c-l)*(d-m)-(f-m)*(a-l),y=(f-m)*(o-a)-(c-l)*(p-d),v=g/y,w=((o-a)*(d-m)-(p-d)*(a-l))/y;if(0===y&&0!==g||v<=0||v>=1||w<0||w>1)return null;if(0===g&&0===y){for(let l=0;l<2;l++){if(u(0===l?s:n,t,e),h.loc==i){const t=0===l?s:n;return{x:t.x,y:t.y,t:h.t}}if(h.loc==r){return{x:+(a+h.t*(o-a)).toPrecision(10),y:+(d+h.t*(p-d)).toPrecision(10),t:h.t}}}return null}for(let r=0;r<2;r++)if(u(0===r?s:n,t,e),h.loc==i){const t=0===r?s:n;return{x:t.x,y:t.y,t:h.t}}return{x:+(a+v*(o-a)).toPrecision(10),y:+(d+v*(p-d)).toPrecision(10),t:v}}function u(t,e,c){const u=c.x-e.x,d=c.y-e.y,p=t.x-e.x,m=t.y-e.y,f=u*m-p*d;if(t.x===e.x&&t.y===e.y)return h.loc=i,void(h.t=0);if(t.x===c.x&&t.y===c.y)return h.loc=s,void(h.t=1);if(f<-Number.EPSILON)return void(h.loc=n);if(f>Number.EPSILON)return void(h.loc=a);if(u*p<0||d*m<0)return void(h.loc=o);if(Math.sqrt(u*u+d*d)<Math.sqrt(p*p+m*m))return void(h.loc=l);let g;g=0!==u?p/u:m/d,h.loc=r,h.t=g}function d(t,e,i){const s=new z;e.getCenter(s);const r=[];return i.forEach((e=>{if(e.boundingBox.containsPoint(s)){const i=function(t,e){const i=[],s=[];for(let r=1;r<t.length;r++){const n=t[r-1],a=t[r];for(let t=1;t<e.length;t++){const r=c(n,a,e[t-1],e[t]);null!==r&&void 0===i.find((t=>t.t<=r.t+Number.EPSILON&&t.t>=r.t-Number.EPSILON))&&(i.push(r),s.push(new z(r.x,r.y)))}}return s}(t,e.points);i.forEach((t=>{r.push({identifier:e.identifier,isCW:e.isCW,point:t})}))}})),r.sort(((t,e)=>t.point.x-e.point.x)),r}let p=e,m=-999999999,f=t.subPaths.map((t=>{const i=t.getPoints();let s=-999999999,r=e,n=-999999999,a=e;for(let t=0;t<i.length;t++){const e=i[t];e.y>s&&(s=e.y),e.y<r&&(r=e.y),e.x>n&&(n=e.x),e.x<a&&(a=e.x)}return m<=n&&(m=n+1),p>=a&&(p=a-1),{curves:t.curves,points:i,isCW:vt.isClockWise(i),identifier:-1,boundingBox:new yt(new z(a,r),new z(n,s))}}));f=f.filter((t=>t.points.length>1));for(let t=0;t<f.length;t++)f[t].identifier=t;const g=f.map((e=>function(t,e,i,s,r){null!=r&&""!==r||(r="nonzero");const n=new z;t.boundingBox.getCenter(n);const a=d([new z(i,n.y),new z(s,n.y)],t.boundingBox,e);a.sort(((t,e)=>t.point.x-e.point.x));const o=[],l=[];a.forEach((e=>{e.identifier===t.identifier?o.push(e):l.push(e)}));const h=o[0].point.x,c=[];let u=0;for(;u<l.length&&l[u].point.x<h;)c.length>0&&c[c.length-1]===l[u].identifier?c.pop():c.push(l[u].identifier),u++;if(c.push(t.identifier),"evenodd"===r){const e=c.length%2==0,i=c[c.length-2];return{identifier:t.identifier,isHole:e,for:i}}if("nonzero"===r){let i=!0,s=null,r=null;for(let t=0;t<c.length;t++){const n=c[t];i?(r=e[n].isCW,i=!1,s=n):r!==e[n].isCW&&(r=e[n].isCW,i=!0)}return{identifier:t.identifier,isHole:i,for:s}}console.warn('fill-rule: "'+r+'" is currently not implemented.')}(e,f,p,m,t.userData?t.userData.style.fillRule:void 0))),y=[];return f.forEach((t=>{if(!g[t.identifier].isHole){const e=new wt;e.curves=t.curves;const i=g.filter((e=>e.isHole&&e.for===t.identifier));i.forEach((t=>{const i=f[t.identifier],s=new bt;s.curves=i.curves,e.holes.push(s)})),y.push(e)}})),y}static getStrokeStyle(t,e,i,s,r){return{strokeColor:e=void 0!==e?e:"#000",strokeWidth:t=void 0!==t?t:1,strokeLineJoin:i=void 0!==i?i:"miter",strokeLineCap:s=void 0!==s?s:"butt",strokeMiterLimit:r=void 0!==r?r:4}}static pointsToStroke(t,e,i,s){const n=[],a=[],o=[];if(0===Oi.pointsToStrokeWithBuffers(t,e,i,s,n,a,o))return null;const h=new r;return h.setAttribute("position",new l(n,3)),h.setAttribute("normal",new l(a,3)),h.setAttribute("uv",new l(o,2)),h}static pointsToStrokeWithBuffers(t,e,i,s,r,n,a,o){const l=new z,h=new z,c=new z,u=new z,d=new z,p=new z,m=new z,f=new z,g=new z,y=new z,v=new z,w=new z,b=new z,x=new z,M=new z,k=new z,S=new z;i=void 0!==i?i:12,s=void 0!==s?s:.001,o=void 0!==o?o:0,t=function(t){let e=!1;for(let i=1,r=t.length-1;i<r;i++)if(t[i].distanceTo(t[i+1])<s){e=!0;break}if(!e)return t;const i=[];i.push(t[0]);for(let e=1,r=t.length-1;e<r;e++)t[e].distanceTo(t[e+1])>=s&&i.push(t[e]);return i.push(t[t.length-1]),i}(t);const A=t.length;if(A<2)return 0;const T=t[0].equals(t[A-1]);let P,C,R=t[0];const E=e.strokeWidth/2,_=1/(A-1);let L,I,O,D,F=0,B=!1,N=0,U=3*o,V=2*o;q(t[0],t[1],l).multiplyScalar(E),f.copy(t[0]).sub(l),g.copy(t[0]).add(l),y.copy(f),v.copy(g);for(let i=1;i<A;i++){P=t[i],C=i===A-1?T?t[1]:void 0:t[i+1];const s=l;if(q(R,P,s),c.copy(s).multiplyScalar(E),w.copy(P).sub(c),b.copy(P).add(c),L=F+_,I=!1,void 0!==C){q(P,C,h),c.copy(h).multiplyScalar(E),x.copy(P).sub(c),M.copy(P).add(c),O=!0,c.subVectors(C,R),s.dot(c)<0&&(O=!1),1===i&&(B=O),c.subVectors(C,P),c.normalize();const t=Math.abs(s.dot(c));if(t>Number.EPSILON){const i=E/t;c.multiplyScalar(-i),u.subVectors(P,R),d.copy(u).setLength(i).add(c),k.copy(d).negate();const s=d.length(),r=u.length();u.divideScalar(r),p.subVectors(C,P);const n=p.length();switch(p.divideScalar(n),u.dot(k)<r&&p.dot(k)<n&&(I=!0),S.copy(d).add(P),k.add(P),D=!1,I?O?(M.copy(k),b.copy(k)):(x.copy(k),w.copy(k)):H(),e.strokeLineJoin){case"bevel":G(O,I,L);break;case"round":X(O,I),O?j(P,w,x,L,0):j(P,M,b,L,1);break;default:const t=E*e.strokeMiterLimit/s;if(t<1){if("miter-clip"!==e.strokeLineJoin){G(O,I,L);break}X(O,I),O?(p.subVectors(S,w).multiplyScalar(t).add(w),m.subVectors(S,x).multiplyScalar(t).add(x),W(w,L,0),W(p,L,0),W(P,L,.5),W(P,L,.5),W(p,L,0),W(m,L,0),W(P,L,.5),W(m,L,0),W(x,L,0)):(p.subVectors(S,b).multiplyScalar(t).add(b),m.subVectors(S,M).multiplyScalar(t).add(M),W(b,L,1),W(p,L,1),W(P,L,.5),W(P,L,.5),W(p,L,1),W(m,L,1),W(P,L,.5),W(m,L,1),W(M,L,1))}else I?(O?(W(g,F,1),W(f,F,0),W(S,L,0),W(g,F,1),W(S,L,0),W(k,L,1)):(W(g,F,1),W(f,F,0),W(S,L,1),W(f,F,0),W(k,L,0),W(S,L,1)),O?x.copy(S):M.copy(S)):O?(W(w,L,0),W(S,L,0),W(P,L,.5),W(P,L,.5),W(S,L,0),W(x,L,0)):(W(b,L,1),W(S,L,1),W(P,L,.5),W(P,L,.5),W(S,L,1),W(M,L,1)),D=!0}}else H()}else H();T||i!==A-1||Q(t[0],y,v,O,!0,F),F=L,R=P,f.copy(x),g.copy(M)}if(T){if(I&&r){let t=S,e=k;B!==O&&(t=k,e=S),O?(D||B)&&(e.toArray(r,0),e.toArray(r,9),D&&t.toArray(r,3)):!D&&B||(e.toArray(r,3),e.toArray(r,9),D&&t.toArray(r,0))}}else Q(P,w,b,O,!1,L);return N;function q(t,e,i){return i.subVectors(e,t),i.set(-i.y,i.x).normalize()}function W(t,e,i){r&&(r[U]=t.x,r[U+1]=t.y,r[U+2]=0,n&&(n[U]=0,n[U+1]=0,n[U+2]=1),U+=3,a&&(a[V]=e,a[V+1]=i,V+=2)),N+=3}function j(t,e,s,r,n){l.copy(e).sub(t).normalize(),h.copy(s).sub(t).normalize();let a=Math.PI;const o=l.dot(h);Math.abs(o)<1&&(a=Math.abs(Math.acos(o))),a/=i,c.copy(e);for(let e=0,s=i-1;e<s;e++)u.copy(c).rotateAround(t,a),W(c,r,n),W(u,r,n),W(t,r,.5),c.copy(u);W(u,r,n),W(s,r,n),W(t,r,.5)}function H(){W(g,F,1),W(f,F,0),W(w,L,0),W(g,F,1),W(w,L,1),W(b,L,0)}function G(t,e,i){e?t?(W(g,F,1),W(f,F,0),W(w,L,0),W(g,F,1),W(w,L,0),W(k,L,1),W(w,i,0),W(x,i,0),W(k,i,.5)):(W(g,F,1),W(f,F,0),W(b,L,1),W(f,F,0),W(k,L,0),W(b,L,1),W(b,i,1),W(M,i,0),W(k,i,.5)):t?(W(w,i,0),W(x,i,0),W(P,i,.5)):(W(b,i,1),W(M,i,0),W(P,i,.5))}function X(t,e){e&&(t?(W(g,F,1),W(f,F,0),W(w,L,0),W(g,F,1),W(w,L,0),W(k,L,1),W(w,F,0),W(P,L,.5),W(k,L,1),W(P,L,.5),W(x,F,0),W(k,L,1)):(W(g,F,1),W(f,F,0),W(b,L,1),W(f,F,0),W(k,L,0),W(b,L,1),W(b,F,1),W(k,L,0),W(P,L,.5),W(P,L,.5),W(k,L,0),W(M,F,1)))}function Q(t,i,s,n,a,o){switch(e.strokeLineCap){case"round":a?j(t,s,i,o,.5):j(t,i,s,o,.5);break;case"square":if(a)l.subVectors(i,t),h.set(l.y,-l.x),c.addVectors(l,h).add(t),u.subVectors(h,l).add(t),n?(c.toArray(r,3),u.toArray(r,0),u.toArray(r,9)):(c.toArray(r,3),c.toArray(r,9),u.toArray(r,0));else{l.subVectors(s,t),h.set(l.y,-l.x),c.addVectors(l,h).add(t),u.subVectors(h,l).add(t);const e=r.length;n?(c.toArray(r,e-3),u.toArray(r,e-6),u.toArray(r,e-12)):(c.toArray(r,e-6),u.toArray(r,e-3),u.toArray(r,e-12))}}}}}class Di extends u{constructor(t,e={},i=null){if(super(),this.model=t,this.material=i,this.outMaterial=!!i,this.XML=new XMLSerializer,this.color=new a,this.opacity=1,this.svgLoader=new Oi,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=e.size||1,this.scaler=1/this.size,!this.model)return;let s={radius:5,min:90,max:90,strokeSize:.25,...e};switch(this.model){case"angle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke;let t=Math.abs(s.min);this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,s.radius,180-t,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180-t,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let e=.5*s.radius,i=s.max*this.scaler,r=s.min*this.scaler;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.segment({x:-e,y:0},{x:e,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:i},{x:e,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:r},{x:e,y:r}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:r}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let n=.5*s.radius;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-n},{x:0,y:n}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-n,y:0},{x:n,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(t={}){let e={};if("angle"===this.model){e={radius:5,min:-90,max:90,...t};let i=Math.abs(e.min);this.change("d",this.circle(0,0,e.radius,180,180+e.max,!0),0),this.change("d",this.circle(0,0,e.radius,180,180+e.max,!1,!1,.3),1),this.change("d",this.circle(0,0,e.radius,180-i,180,!0),2),this.change("d",this.circle(0,0,e.radius,180-i,180,!1,!1,.3,!0),3)}void 0!==t.wireframe&&(this.material.wireframe=t.wireframe),this.fill=void 0===e.fill||e.fill,this.stroke=void 0===e.stroke||e.stroke,this.toMesh()}set(t={},e){for(let i in t)e?e.setAttributeNS(null,i,t[i]):this.svg.setAttributeNS(null,i,t[i])}add(t,e={}){let i=document.createElementNS(this.base,t);this.set(e,i),this.svg.appendChild(i)}change(t,e,i){this.svg.childNodes[i].setAttributeNS(null,t,e)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(t,e,i,s){var r=(s-90)*Math.PI/180;return{x:t+i*Math.cos(r),y:e+i*Math.sin(r)}}circle(t,e,i,s=0,r=360,n=!1,a=!1,o=0,l=!1){0===s&&360===r&&(s=1e-4,a=!0);let h=this.polarToCartesian(t,e,i,r),c=this.polarToCartesian(t,e,i,s),u=r-s<=180?"0":"1",d=["M",h.x,h.y,"A",i,i,0,u,0,c.x,c.y];if(n&&d.push("L",t,e,"L",h.x,h.y),a&&d.push("Z"),0!==o){let n=this.polarToCartesian(t,e,i-o,l?s:r),a=this.polarToCartesian(t,e,i+o,l?s:r);d.push("M",n.x,n.y,"L",a.x,a.y)}return d.join(" ")}segment(t,e){return["M",t.x,t.y,"L",e.x,e.y].join(" ")}geomColor(t,e,i=1){let s=t.attributes.position.count,r=[];for(;s--;)r.push(e.r,e.g,e.b,i);t.setAttribute("color",new l(r,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let t=[],e=0,i=1,s=this.svgLoader.parse(this.getString());for(const n of s.paths){const s=n.userData.style.fill;if(this.fill&&void 0!==s&&"none"!==s){this.color.setStyle(s),i=n.userData.style.fillOpacity,i<this.opacity&&(this.opacity=i);const a=Oi.createShapes(n);for(const s of a){const n=new Mt(s);if(n){this.geomColor(n,this.color,i);let s=(new r).copy(n).toNonIndexed();s.translate(0,0,-e*this.layerUp),t.push(s),e++}}}const a=n.userData.style.stroke;if(this.stroke&&void 0!==a&&"none"!==a){this.color.setStyle(a),i=n.userData.style.strokeOpacity,i<this.opacity&&(this.opacity=i);for(const s of n.subPaths){const r=Oi.pointsToStroke(s.getPoints(),n.userData.style,6);r&&(this.geomColor(r,this.color,i),r.translate(0,0,-e*this.layerUp),t.push(r),e++)}}}return t}toMesh(){let t=this.size;this.geometry&&this.geometry.dispose();let e=this.toGeometry();e?(this.geometry=Ce(e),this.geometry.scale(t,-t,t),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new r,null===this.material&&(this.material=new E({vertexColors:!0,transparent:1!==this.opacity,side:I}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class Fi extends ft{constructor(t={},e){super(),this.motor=e,this.isJoint=!0,this.type="joint",this.mode=t.mode||"hinge",this.visible=void 0!==t.visible&&t.visible,this.mtx=new at,this.size=t.helperSize||.1,this.matrixAutoUpdate=!1;let i,s,n=this.motor.mat.get("line");switch(this.mode){case"prismatic":i=this.motor.mat.get("svg"),s={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(s.min=t.lm[0],s.max=t.lm[1]),this.m1=new Di("liner",s,i),this.m2=new Di("middle",s,i),this.m1.geometry.rotateY(90*xe.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":i=this.motor.mat.get("svg"),s={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(s.min=t.lm[0],s.max=t.lm[1]),t.lmr&&(s.min=t.lmr[0],s.max=t.lmr[1]),this.m1=new Di("angle",s,i),this.m2=new Di("needle",s,i),this.add(this.m1),this.add(this.m2);break;default:const e=this.motor.geo.get("joint");let r=e.clone();r.scale(this.size,this.size,this.size),this.m1=new w(r,n),this.add(this.m1),r=e.clone(),r.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new w(r,n),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new at,this.mat2=new at,this.end=new nt;let a=new lt;t.quat1&&this.mat1.makeRotationFromQuaternion(a.fromArray(t.quat1)),t.quat2&&this.mat2.makeRotationFromQuaternion(a.fromArray(t.quat2)),this.mat1.setPosition(t.pos1[0],t.pos1[1],t.pos1[2]),this.mat2.setPosition(t.pos2[0],t.pos2[1],t.pos2[2]);const o=new r;o.setAttribute("position",new l([0,0,0,0,0,0],3)),o.setAttribute("color",new l([1,0,0,1,0,0],3)),o.computeBoundingSphere(),this.m3=new w(o,n),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()))}updateFromPhy(t,e=0){this.visible&&(this.position.fromArray(t,e),this.quaternion.fromArray(t,e+3),this.updateMatrix(),this.m2.position.fromArray(t,e+7),this.m2.quaternion.fromArray(t,e+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Bi extends si{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new nt,this.v2=new nt}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*qe.joint,16===qe.joint?i.updateFromPhy(t,s):i.update()}add(t={}){let e,i=this.setName(t),s=null,r=null,n=!1;if(t.axis1||(t.axis1=[1,0,0]),t.axis2||(t.axis2=[1,0,0]),t.pos1||(t.pos1=[0,0,0]),t.pos2||(t.pos2=[0,0,0]),t.limit?t.lm=t.limit:t.lm&&(t.limit=t.lm),"universal"!==t.mode&&"dof"!==t.mode&&"d6"!==t.mode||(t.mode="generic"),"revolute"===t.mode&&(t.mode="hinge"),"slider"===t.mode&&(t.mode="cylindrical"),t.b1&&(e="string"==typeof t.b1,s=e?this.Utils.byName(t.b1):t.b1,e||(t.b1=t.b1.name),s&&s.link++),t.b2&&(e="string"==typeof t.b2,r=e?this.Utils.byName(t.b2):t.b2,e||(t.b2=t.b2.name),r&&r.link++),t.worldPos&&(t.worldAnchor=t.worldPos),t.worldAnchor&&(t.pos1=s?this.Utils.toLocal(this.v1.fromArray(t.worldAnchor),s).toArray():t.worldAnchor,t.pos2=r?this.Utils.toLocal(this.v2.fromArray(t.worldAnchor),r).toArray():t.worldAnchor,delete t.worldAnchor),t.worldAxis&&(t.axis1=s?this.Utils.toLocal(this.v1.fromArray(t.worldAxis),s,!0).toArray():t.worldAxis,t.axis2=r?this.Utils.toLocal(this.v2.fromArray(t.worldAxis),r,!0).toArray():t.worldAxis,n=!0,delete t.worldAxis),t.worldQuat&&(t.quat1=this.Utils.quatLocal(t.worldQuat,s),t.quat2=this.Utils.quatLocal(t.worldQuat,r),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(t.axis1=this.Utils.axisLocal(xe.quatToAxis(t.worldQuat),s),t.axis2=this.Utils.axisLocal(xe.quatToAxis(t.worldQuat),r)),delete t.worldQuat),void 0!==t.rot1&&(t.quat1=xe.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=xe.quatFromEuler(t.rot2),delete t.rot2),t.quat1||(t.quat1=(new lt).setFromUnitVectors(new nt(1,0,0),(new nt).fromArray(t.axis1).normalize()).toArray()),t.quat2||(t.quat2=(new lt).setFromUnitVectors(new nt(1,0,0),(new nt).fromArray(t.axis2).normalize()).toArray()),"AMMO"===this.engine&&n&&"hinge"===t.mode){let e=new kt(0,-90*ge,0),i=(new lt).setFromEuler(e).toArray();t.quatX=i}t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=xe.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot);let a=new Fi(t,this.motor);return a.name=i,a.body1=s,a.body2=r,void 0===t.visible&&(t.visible=this.motor.jointVisible||!1),this.set(t,a),this.addToWorld(a,t.id),this.motor.post({m:"add",o:t}),a}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&void 0!==t.visible&&(e.visible=t.visible)}}class Ni extends si{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="contact"}step(t,e){let i,s,r=this.list.length;for(;r--;)i=this.list[r],s=e+r*qe.contact,i.update(t,s)}add(t={}){this.setName(t);let e=new Ui(t);return t.callback&&delete t.callback,this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}}class Ui{constructor(t={}){this.type="contact",this.name=t.name,this.callback=t.callback||function(){},this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.always=void 0===t.always||t.always,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}detectBody(){}update(t,e=0){this.data.hit=t[e]>0,this.simple||(this.data.point=[t[e+1],t[e+2],t[e+3]],this.data.normal=[t[e+4],t[e+5],t[e+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}let Vi=null;class qi extends si{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.motor.geo,Vi=this.motor.mat,this.type="vehicle",this.num=qe[this.type]}step(t,e){let i,s,r=this.list.length;for(;r--;)s=this.list[r],i=e+r*this.num,s.step(t,i)}add(t={}){this.setName(t);const e=new Wi(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:e.o}),e}set(t={},e=null){null===e&&(e=this.byName(t.name))}}class Wi extends ft{constructor(t,e){super(),this.motor=e,this.Utils=this.motor.utils,this.velocity=new nt,this.angular=new nt,t.extra&&(this.extra=t.extra,delete t.extra),this.type="vehicle",this.name=t.name||"car",this.isRay=t.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(t)}drive(){}raycast(){}init(t){this.mass=t.mass||2e3,this.model=null,this.size=t.size||[1.7,1,5],this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.maxSteering=t.maxSteering||24,this.incSteering=t.incSteering||2,this.s_travel=t.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=t.numWheel||4,this.radius=t.radius||.35,this.radiusBack=t.radiusBack||this.radius,this.deep=t.deep||.3,this.deepBack=t.deepBack||this.deep;let e=this.numWheel<4?1:2;if(t.wPos||(t.wPos=[.8,.1,1.4]),t.wPos){this.wPos=t.wPos;var i,s,r,n,a,o,l=t.wPos,h=[],c=1,u=0;l.length,l.length;for(let t=0;t<this.numWheel;t++)c=t%2==0?-1:1,s=Math.floor(.5*t),u=t>=e,0===(r=l[1])&&(r=u?this.radiusBack:this.radius),(n=l[0])instanceof Array&&(n=l[0][s]),a=u?-l[2]:l[2],l[2]instanceof Array&&(a=l[2][s]),i=[n*c,r,a],h.push(i);this.wheelsPosition=h,delete t.wPos}t.wheelsPosition&&(this.wheelsPosition=t.wheelsPosition);const d=t.meshScale||1,p=[];t.chassisShape?p.push({type:"convex",shape:t.chassisShape,size:[d],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):p.push({type:"box",size:this.size,pos:this.chassisPos});for(let i=0;i<this.numWheel;i++)i<e?p.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1}):p.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1});var m=Vi.get(t.debug?"debug":void 0===t.chassisMesh?"body":"hide");let f,g;for(let t=0;t<p.length;t++)f=p[t],f.pos&&(f.localPos=f.pos),f.size=xe.autoSize(f.size,f.type),this.motor.getGeometryRef(f,this,m);if(t.chassisMesh&&(g=t.noClone?t.chassisMesh:t.chassisMesh.clone(),g.position.set(0,0,0),this.Utils.noRay(g),g.scale.set(d,d,d),this.children[0].add(g),this.model=g,delete t.chassisMesh),t.wheelMesh){for(let i=1;i<this.numWheel+1;i++)u=i>=e+1,g=t.wheelMeshBack&&u?t.wheelMeshBack.clone():t.wheelMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),2==i||4==i?g.scale.set(-d,d,d):g.scale.set(d,d,d),this.children[i].add(g);delete t.wheelMesh}if(t.suspensionMesh){this.suspensionMesh=[];for(let e=1;e<this.numWheel+1;e++)g=t.suspensionMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),g.position.x=0,2==e||4==e?g.scale.set(d,d,d):g.scale.set(-d,d,d),this.children[0].add(g),this.suspensionMesh.push(g);delete t.suspensionMesh}if(t.brakeMesh){this.brake=[];for(let e=1;e<this.numWheel+1;e++)u=e>2,g=t.brakeMeshBack&&u?t.brakeMeshBack.clone():t.brakeMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),o=t.brakeMeshBack||u?d:-d,2==e||4==e?g.scale.set(-d,d,o):g.scale.set(d,d,o),this.children[0].add(g),this.brake.push(g);delete t.brakeMesh}t.mass=this.mass,t.size=t.chassisShape?p[0].boxSize:this.size,t.numWheel=this.numWheel,t.wheelsPosition=this.wheelsPosition,t.radius=this.radius,t.radiusBack=this.radiusBack,t.deep=this.deep,t.deepBack=this.deepBack,t.chassisShape=p[0],t.maxSteering=this.maxSteering,t.incSteering=this.incSteering,t.s_travel=this.s_travel,t.massCenter=this.massCenter,t.chassisPos=this.chassisPos,this.o=t}set(t){t.name=this.name,this.motor.change(t)}respawn(t){(t=t||{}).respawn=!0,t.name=this.name,t.keepRotation&&(t.quat=this.quaternion.toArray()),this.motor.change(t)}move(){}dispose(){}step(t,e){if(!this.actif){if(0===t[e+0]+t[e+1]+t[e+2]+t[e+3]+t[e+4]+t[e+5]+t[e+6]+t[e+7])return;this.actif=!0}this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.updateMatrix();let i,s=this.numWheel+1,r=0,n=0,a=[],o=0;for(let l=0;l<s;l++)o=8*l+e,0===l&&(t[o],this.circum),1===l&&(r=t[o]),2===l&&(n=t[o]),i=this.children[l],i&&l>0&&(a[l-1]=this.wheelsPosition[l-1][1]-this.decaly-t[o+2],i.position.fromArray(t,o+1),i.quaternion.fromArray(t,o+4),this.rolling[l-1]=i.rotation.x,this.brake&&(this.brake[l-1].position.copy(i.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=t[o])));for(o=4;o--;)this.suspension[o]=xe.clamp(a[o]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[o]>0?(this.Utils.morph(this.suspensionMesh[o].children[0],"low",this.suspension[o]),this.Utils.morph(this.suspensionMesh[o].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[o].children[0],"low",0),this.Utils.morph(this.suspensionMesh[o].children[0],"top",-this.suspension[o])));this.steering=Math.round(.5*(r+n)*ye)/this.maxSteering}}const ji=new at,Hi=new nt,Gi=new lt,Xi=new nt,Qi=new at,Yi=new at,Ji=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Zi extends ft{constructor(t,e,i,s,r=null,n={}){super(),this.motor=t,this.prefix=e||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=i,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=r,this.friction=.5,this.restitution=0,this.option=n,this.useDrive=void 0===n.useDrive||n.useDrive,this.showJoint=void 0!==n.showJoint&&n.showJoint,this.init()}setMass(t){if(t===this.mass)return;this.mass=t;const e=[];let i=this.nodes.length,s=this.mass/i;for(;i--;)e.push({name:this.nodes[i].name,mass:s});this.motor.change(e)}setMode(t){if(t===this.mode)return;this.mode=t;const e=[];let i,s="follow"===this.mode,r=this.nodes.length;for(;r--;)i=this.nodes[r],e.push({name:i.name,kinematic:s}),i.kinematic=s,i.bone.isPhysics=!s;this.motor.change(e)}freeBone(t){t.kinematic&&(t.cc++,20===t.cc&&(t.cc=0,t.kinematic=!1,t.bone.isPhysics=!0,this.motor.change({name:t.name,kinematic:!1})))}isVisible(t){let e=this.nameList.length;for(;e--;)this.motor.byName(this.nameList[e]).visible=t}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const t=[];let e=(new at).makeScale(this.scaler,this.scaler,this.scaler),i=new nt,s=new nt,r=new lt,n=new kt,a=new at,o=new at,l=new at;Qi.copy(this.model.matrixWorld).invert();let h=new nt,c=new nt,u=[1,1,1,1,1,1,1];this.option.sizer&&(u=this.option.sizer);let d,p,m,f,g,y,v,w,b,x,M,k,S,A=this.bones.length,T=0;for(this.mass&&(T=this.mass/A),d=0;d<A;d++)if(b=null,f=this.bones[d],p=f.name,g=f.parent,g){m=g.name,Yi.multiplyMatrices(Qi,f.matrixWorld),h.setFromMatrixPosition(Yi),Yi.multiplyMatrices(Qi,g.matrixWorld),c.setFromMatrixPosition(Yi),v=h.distanceTo(c),M=[0,0,.5*v],y=[v,1,1],w=null,x=!0,S=!1,"hip"===m&&"abdomen"===p&&(b="capsule",y=[v*u[0],.08],M=[0,0,-v*u[0]],w=[0,0,90]),"abdomen"===m&&"chest"===p&&(b="capsule",y=[.7*v*u[1],.08],M=[0,0,.5*-v-.06],w=[90,0,0]),"chest"===m&&"neck"===p&&(b="capsule",y=[.4*v*u[2],.04],M=[0,0,.5*-v-.02],w=[0,0,90]),"neck"===m&&"head"===p&&(b="capsule",y=[.06*u[3],v],M=[0,0,.5*-v],w=[90,0,0]),"head"===m&&"End_head"===p&&(b="capsule",y=[.1*u[4],v-.17],M=[0,.02,.5*-v+.02],w=[90,0,0]),"chest"===m&&"rBreast"===p&&"HAVOK"!==this.motor.engine&&(m="rBreast",g=f,b="sphere",y=[.065],M=[.065,0,0],this.breast=!0,S=!0),"chest"===m&&"lBreast"===p&&"HAVOK"!==this.motor.engine&&(m="lBreast",g=f,b="sphere",y=[.065],M=[.065,0,0],this.breast=!0,S=!0);let d=.04*u[5],A=v-d;if("lCollar"===m&&"lShldr"===p&&(b="capsule",y=[d,.3*v],M=[.6*v,0,0],w=[0,0,90]),"lShldr"===m&&"lForeArm"===p&&(b="capsule",y=[d,A],M=[.5*A,0,0],w=[0,0,90]),"lForeArm"===m&&"lHand"===p&&(b="capsule",y=[d,A],M=[.5*A,0,0],w=[0,0,90]),"lHand"===m&&"lMid1"===p&&(b="box",y=[2*v,.09,.05],M=[v,0,0]),"rCollar"===m&&"rShldr"===p&&(b="capsule",y=[d,.3*v],M=[.6*-v,0,0],w=[0,0,90]),"rShldr"===m&&"rForeArm"===p&&(b="capsule",y=[d,A],M=[.5*-A,0,0],w=[0,0,90]),"rForeArm"===m&&"rHand"===p&&(b="capsule",y=[d,A],M=[.5*-A,0,0],w=[0,0,90]),"rHand"===m&&"rMid1"===p&&(b="box",y=[2*v,.09,.05],M=[-v,0,0]),d=.06*u[6],A=v-d,"lThigh"===m&&(b="capsule",y=[d,v],w=[90,0,0],M=[0,0,.5*A]),"lShin"===m&&(b="capsule",y=[d,v],w=[90,0,0],M=[0,0,.5*A]),"lFoot"===m&&(b="capsule",y=[.05,v],M=[0,.5*v-.025,.04]),"rThigh"===m&&(b="capsule",y=[d,v],w=[90,0,0],M=[0,0,.5*A]),"rShin"===m&&(b="capsule",y=[d,v],w=[90,0,0],M=[0,0,.5*A]),"rFoot"===m&&(b="capsule",y=[.05,v],M=[0,.5*v-.025,.04]),d=.04,A=v-d,"rEar_0"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("rEar_0")),"rEar_1"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("rEar_1")),"rEar_2"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("rEar_2")),"rEar_3"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0]),"lEar_0"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("lEar_0")),"lEar_1"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("lEar_1")),"lEar_2"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0],Ji.push("lEar_2")),"lEar_3"===m&&(b="capsule",y=[d,v],w=[0,0,90],M=[.5*A,0,0]),this.withFinger&&("lHand"===m&&"lMid1"===p&&(b="box",y=[v,.09,.05],M=[.5*v,0,0]),"rHand"===m&&"rMid1"===p&&(b="box",y=[v,.09,.05],M=[.5*-v,0,0]),"rThumb1"===m&&"rThumb2"===p&&(b="capsule",y=[.02,v],w=[0,0,90]),"rThumb2"===m&&"rThumb3"===p&&(b="capsule",y=[.02,v],w=[0,0,90]),"rHand"===m&&"rMid1"===p&&(b="capsule",y=[.02,v],w=[0,0,90],M=[.6*-v,0,0]),"rMid1"===m&&"rMid2"===p&&(b="capsule",y=[.02,v],w=[0,0,90],M=[.6*-v,0,0]),"rMid2"===m&&"rMid3"===p&&(b="capsule",y=[.02,v],w=[0,0,90],M=[.6*-v,0,0])),null!==b){k=this.prefix+"_bone_"+m,o.makeTranslation(M[0],M[1],M[2]),w&&(l.makeRotationFromEuler(n.set(w[0]*ge,w[1]*ge,w[2]*ge)),o.multiply(l)),g.updateWorldMatrix(!0,!1),Yi.multiplyMatrices(Qi,g.matrixWorld),a.copy(Yi),a.decompose(i,r,s),this.posRef[k]=i.toArray(),"lForeArm"!==m&&"rForeArm"!==m||(Gi.setFromAxisAngle({x:0,y:1,z:0},-90*ge),r.multiply(Gi)),this.quatRef[k]=r.toArray(),a.multiplyMatrices(Yi,o),a.decompose(i,r,s),this.nameList.push(k);let h={name:k,friction:this.friction,restitution:this.restitution,type:b,size:xe.scaleArray(y,this.scaler,3),pos:i.toArray(),quat:r.toArray(),kinematic:x,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==Ji.indexOf(m)&&(h.aggregate=this.prefix+"__Group",h.aggregateMax=21),h.mask=3;else{let t=3;"lForeArm"!==m&&"rForeArm"!==m&&"lShin"!==m&&"rShin"!==m||(t=35),"rEar_1"!==m&&"rEar_2"!==m&&"rEar_3"!==m&&"lEar_1"!==m&&"lEar_2"!==m&&"lEar_3"!==m||(t=35),"rEar_0"!==m&&"rEar_0"!==m||(t=0),h.group=32,h.mask=t}null!==this.mass?h.mass=T:h.density=1,t.push(h);let c=o.clone().invert().premultiply(e);this.nodes.push({name:k,kinematic:x,motion:S,bone:g,decal:o.clone(),decalinv:c,quat:r.toArray(),pos:i.toArray(),cc:0})}}this.motor.add(t),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(t){return-1!==this.nameList.indexOf(t)}addLink(){let t=[.05,1,0];"PHYSX"===this.motor.engine&&(t=[50,10,0,.5]);let e=2,i=.1,s=1e7,r=!1,n=this.prefix+"_bone_",a=[],o={type:"joint",mode:"d6",lm:[["ry",-180,180,...t],["rz",-180,180,...t]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(o.drives=[["rx",e,i,s,r],["ry",e,i,s,r],["rz",e,i,s,r]]);let l=[-.001,.001,100,.2,.5];a.push({...o,b1:n+"hip",b2:n+"abdomen",worldPos:this.posRef[n+"abdomen"],worldQuat:this.quatRef[n+"hip"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),a.push({...o,b1:n+"abdomen",b2:n+"chest",worldPos:this.posRef[n+"chest"],worldQuat:this.quatRef[n+"chest"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),a.push({...o,b1:n+"chest",b2:n+"neck",worldPos:this.posRef[n+"neck"],worldQuat:this.quatRef[n+"neck"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),a.push({...o,b1:n+"neck",b2:n+"head",worldPos:this.posRef[n+"head"],worldQuat:this.quatRef[n+"head"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),a.push({...o,b1:n+"chest",b2:n+"rCollar",worldPos:this.posRef[n+"rCollar"],worldQuat:this.quatRef[n+"rCollar"],mode:"fixe"}),a.push({...o,b1:n+"chest",b2:n+"lCollar",worldPos:this.posRef[n+"lCollar"],worldQuat:this.quatRef[n+"lCollar"],mode:"fixe"}),a.push({...o,b1:n+"rCollar",b2:n+"rShldr",worldPos:this.posRef[n+"rShldr"],worldQuat:this.quatRef[n+"rShldr"]}),a.push({...o,b1:n+"lCollar",b2:n+"lShldr",worldPos:this.posRef[n+"lShldr"],worldQuat:this.quatRef[n+"lShldr"]}),this.existe(n+"rForeArm")&&a.push({...o,b1:n+"rShldr",b2:n+"rForeArm",worldPos:this.posRef[n+"rForeArm"],worldQuat:this.quatRef[n+"rForeArm"],lm:[["rx",0,160,...t]]}),this.existe(n+"lForeArm")&&a.push({...o,b1:n+"lShldr",b2:n+"lForeArm",worldPos:this.posRef[n+"lForeArm"],worldQuat:this.quatRef[n+"lForeArm"],lm:[["rx",0,160,...t]]}),this.existe(n+"rHand")&&a.push({...o,b1:n+"rForeArm",b2:n+"rHand",worldPos:this.posRef[n+"rHand"],worldQuat:this.quatRef[n+"rHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),this.existe(n+"lHand")&&a.push({...o,b1:n+"lForeArm",b2:n+"lHand",worldPos:this.posRef[n+"lHand"],worldQuat:this.quatRef[n+"lHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),a.push({...o,b1:n+"hip",b2:n+"rThigh",worldPos:this.posRef[n+"rThigh"],worldQuat:this.quatRef[n+"rThigh"]}),a.push({...o,b1:n+"hip",b2:n+"lThigh",worldPos:this.posRef[n+"lThigh"],worldQuat:this.quatRef[n+"lThigh"]}),this.existe(n+"rShin")&&a.push({...o,b1:n+"rThigh",b2:n+"rShin",worldPos:this.posRef[n+"rShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[n+"rShin"]}),this.existe(n+"lShin")&&a.push({...o,b1:n+"lThigh",b2:n+"lShin",worldPos:this.posRef[n+"lShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[n+"lShin"]}),this.existe(n+"rFoot")&&a.push({...o,b1:n+"rShin",b2:n+"rFoot",worldPos:this.posRef[n+"rFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[n+"rFoot"]}),this.existe(n+"lFoot")&&a.push({...o,b1:n+"lShin",b2:n+"lFoot",worldPos:this.posRef[n+"lFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[n+"lFoot"]}),this.breast&&(this.existe(n+"rBreast")&&a.push({...o,b1:n+"chest",b2:n+"rBreast",worldPos:this.posRef[n+"rBreast"],worldQuat:this.quatRef[n+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(n+"lBreast")&&a.push({...o,b1:n+"chest",b2:n+"lBreast",worldPos:this.posRef[n+"lBreast"],worldQuat:this.quatRef[n+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(n+"lEar_0")&&a.push({...o,b1:n+"head",b2:n+"lEar_0",worldPos:this.posRef[n+"lEar_0"],worldQuat:this.quatRef[n+"lEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"lEar_1")&&a.push({...o,b1:n+"lEar_0",b2:n+"lEar_1",worldPos:this.posRef[n+"lEar_1"],worldQuat:this.quatRef[n+"lEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"lEar_2")&&a.push({...o,b1:n+"lEar_1",b2:n+"lEar_2",worldPos:this.posRef[n+"lEar_2"],worldQuat:this.quatRef[n+"lEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"lEar_3")&&a.push({...o,b1:n+"lEar_2",b2:n+"lEar_3",worldPos:this.posRef[n+"lEar_3"],worldQuat:this.quatRef[n+"lEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"rEar_0")&&a.push({...o,b1:n+"head",b2:n+"rEar_0",worldPos:this.posRef[n+"rEar_0"],worldQuat:this.quatRef[n+"rEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"rEar_1")&&a.push({...o,b1:n+"rEar_0",b2:n+"rEar_1",worldPos:this.posRef[n+"rEar_1"],worldQuat:this.quatRef[n+"rEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"rEar_2")&&a.push({...o,b1:n+"rEar_1",b2:n+"rEar_2",worldPos:this.posRef[n+"rEar_2"],worldQuat:this.quatRef[n+"rEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(n+"rEar_3")&&a.push({...o,b1:n+"rEar_2",b2:n+"rEar_3",worldPos:this.posRef[n+"rEar_3"],worldQuat:this.quatRef[n+"rEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]});let h=0;for(let t in a)a[t].name=this.prefix+"_joint_"+h,this.jointList.push(a[t].name),h++;this.motor.add(a)}updateMatrixWorld(t){if(!this.ready)return;let e=[];const i=this.nodes;let s,r,n,a=i.length,o=0;for(;a--;)s=i[o],r=s.bone,o++,s.kinematic?(ji.multiplyMatrices(r.matrixWorld,s.decal),ji.decompose(Hi,Gi,Xi),s.pos=Hi.toArray(),s.quat=Gi.toArray(),e.push({name:s.name,pos:s.pos,quat:s.quat}),s.motion&&this.freeBone(s)):(n=this.motor.byName(s.name),n&&(ji.copy(n.matrixWorld).multiply(s.decalinv),r.phyMtx.copy(ji),r.isPhysics=!0));0!==e.length&&this.motor.change(e,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}function Ki(t){const e=new Map,i=new Map,s=t.clone();return $i(t,s,(function(t,s){e.set(s,t),i.set(t,s)})),s.traverse((function(t){if(!t.isSkinnedMesh)return;const s=t,r=e.get(t),n=r.skeleton.bones;s.skeleton=r.skeleton.clone(),s.bindMatrix.copy(r.bindMatrix),s.skeleton.bones=n.map((function(t){return i.get(t)})),s.bind(s.skeleton,s.bindMatrix)})),s}function $i(t,e,i){i(t,e);for(let s=0;s<t.children.length;s++)$i(t.children[s],e.children[s],i)}class ts{constructor(t,e){this.target=e||t,this.baseGeometry=t.geometry,this.geometry=this.target.geometry,this.V=[new nt,new nt,new nt],this.X=[new St,new St,new at],this.M=[new nt,new nt,new nt],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const t=this.geometry;let e=t.attributes.position.array.length;t.setAttribute("color",new l(new Array(e).fill(0),3))}resetEdge(t){let e=t.length;for(;e--;)t[e]=0}getEdge(t,e,i=!1,s=!1){let r=t.attributes.position.array;const n=t.index.array;let a,o,l,h,c,u,d,p=this.V[0],m=this.V[1],f=this.V[2],g=0;for(s&&(r=this.getMorph()),i&&(r=this.getSkinned(r)),(i||s)&&this.resetEdge(e),a=this.indexLength;a--;)o=n[g],l=n[g+1],h=n[g+2],p.fromArray(r,3*o),m.fromArray(r,3*l),f.fromArray(r,3*h),c=p.distanceTo(m),u=p.distanceTo(f),d=m.distanceTo(f),e[o]+=.5*(c+u),e[l]+=.5*(c+d),e[h]+=.5*(u+d),g+=3}isZero(t){return 0===t.x&&0===t.y&&0===t.z}getMorph(){const t=this.target.morphTargetInfluences,e=this.geometry.morphAttributes.position,i=t.length,s=this.geometry.attributes.position.array;let r,n,a,o,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],u=this.M[2],d=this.geometry.morphTargetsRelative;for(n=l;n--;){for(r=3*n,c.fromArray(s,r),h.set(0,0,0),a=i;a--;)0!=t[a]&&(o=e[a].data?e[a].data.array:e[a].array,d?h.addScaledVector(u.fromArray(o,r),t[a]):h.addScaledVector(u.fromArray(o,r).sub(c),t[a]));c.add(h),c.toArray(this.back,r)}return this.back}getSkinned(t){const e=this.target.skeleton;e.boneMatrices;const i=this.geometry,s=i.attributes.skinIndex.array,r=i.attributes.skinWeight.array,n=this.target.bindMatrix,a=this.target.bindMatrixInverse;let o,l,h,c,u,d=this.V[0],p=this.V[1],m=this.V[2],f=this.X[0],g=this.X[1],y=this.X[2];for(o=i.attributes.position.count;o--;){for(u=3*o,f.fromArray(s,4*o),g.fromArray(r,4*o),d.fromArray(t,u).applyMatrix4(n),p.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=f.getComponent(l),y.multiplyMatrices(e.bones[h].matrixWorld,e.boneInverses[h]),p.addScaledVector(m.copy(d).applyMatrix4(y),c));p.applyMatrix4(a),p.toArray(this.back,u)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const t=this.geometry.attributes.color.array;let e,i,s,r=this.length;for(;r--;)e=this.originEdges[r],i=(e-this.targetEdges[r])/e+.5,s=3*r,t[s]=i>.5?2*(i-.5):0,t[s+1]=0,t[s+2]=i<.5?1-2*i:0;this.geometry.attributes.color.needsUpdate=!0}}class es extends ft{constructor(t,e){super(),this.isReady=!1,this.skeleton=e,this.bones=this.skeleton.bones,this.root=t,this.box=new k,this.mtxr=new at,this.mtx0=new at,this.mtx1=new at,this.mtx=new at,this.mtx2=new at,this.p=new nt,this.s=new nt,this.q=new lt,this.e=new kt,this.mat=new E({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){if(!this.isReady)return;let e,i,s=this.children,r=s.length;for(this.mtxr.copy(this.root.matrixWorld).invert();r--;)e=s[r],i=e.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,i.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,e.userData.decal),this.mtx.decompose(this.p,this.q,this.s),e.position.copy(this.p),e.quaternion.copy(this.q),e.updateMatrix();super.updateMatrixWorld(t)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const t=this.bones;let e,i,s,r,n,a,o,l,h,c,u,d=new nt,p=new nt,m=t.length;for(e=0;e<m;e++)l=null,r=t[e],i=r.name,n=r.parent,n&&(s=n.name,d.setFromMatrixPosition(n.matrixWorld),p.setFromMatrixPosition(r.matrixWorld),o=d.distanceTo(p),h=[0,0,.5*o],a=[o,1,1],c=[0,0,0],u="_C","head"===s&&"End_head"===i&&(l="box",a=[.16,.2,o],h=[0,.025,.5*-o]),"chest"===s&&"neck"===i&&(l="box",a=[.3,.28,o],h=[0,0,.5*-o]),"abdomen"===s&&(l="box",a=[.28,.24,o+.14],c[2]=0,h=[0,0,.5*-o],h[2]+=.07),"rThigh"===s&&(l="box",a=[.15,.15,o]),"lThigh"===s&&(l="box",a=[.15,.15,o]),"rShin"===s&&(l="box",a=[.12,.12,o+.1],h[2]+=.05),"lShin"===s&&(l="box",a=[.12,.12,o+.1],h[2]+=.05),"rShldr"===s&&(l="box",a=[o+.06,.12,.12],h[0]=.03-h[2],h[2]=0),"lShldr"===s&&(l="box",a=[o+.06,.12,.12],h[0]=h[2]-.03,h[2]=0),"rForeArm"===s&&(l="box",a=[o+.1,.1,.1],h[0]=-h[2]-.05,h[2]=0),"lForeArm"===s&&(l="box",a=[o+.1,.1,.1],h[0]=h[2]+.05,h[2]=0),null!==l&&this.addMesh(n,l,a,h,c,"_C"));this.isReady=!0}addMesh(t,e,i,s,r,n){this.mtx.makeTranslation(s[0],s[1],s[2]);var a=new u(this.box,this.mat);a.scale.fromArray(i),a.userData.decal=this.mtx.clone(),a.userData.bone=t,a.userData.size=i,this.add(a)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const is={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:1,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},ss={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:is,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",roughness:.54,metalness:.14,normalScale:new z(is.normal,-is.normal),wireframe:is.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new a(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new z(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new z(2,-2),clearcoat:.25},hair:{type:"Standard",color:is.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:I,emissive:is.hair,emissiveIntensity:.5,transparent:!0,blending:At,blendDst:X,blendDstAlpha:W,alphaToCoverage:!0},hair_man:{type:"Standard",color:is.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:I,transparent:!0,blending:At,blendDst:X,blendDstAlpha:W,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:is.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:I,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(t={},e=!1)=>{if(!Le.getMaterial(ss.materialRef))return;const i=ss.setting,s=ss.materials;let r,n=!1;for(let e in t)void 0!==i[e]&&i[e]!==t[e]&&(i[e]=t[e],n=!0);if(n)for(let i in s){r=Le.getMaterial(i);for(let n in t)void 0!==r[n]&&(e&&s[i][n]?r[n]=s[i][n]:r[n]=t[n])}},applyMaterial:(t,e)=>{const i=!0,s=Le.getMaterial("skin");//!Human.haveLOD;
t.traverse((t=>{if(t.isMesh)switch(t.name){case"body":case"Head":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=i;break;case"body_low":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=!1;break;case"crane":t.material=s,t.receiveShadow=!0,t.castShadow=!1,t.visible=!ss.haveHair;break;case"mouth":t.material=Le.getMaterial("mouth")||s,t.receiveShadow=!0,t.castShadow=!1,t.visible=i,t.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":t.material=Le.getMaterial("eyelash")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"tear":t.material=Le.getMaterial("tear")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"eye_l":case"eye_r":t.material=Le.getMaterial("eye")||s,t.receiveShadow=!1,t.castShadow=!1;break;case"eye_l_s":case"eye_r_s":t.material=Le.getMaterial("sub_eye")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"hair":t.material=Le.getMaterial("hair")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!ss.haveHair&&i;break;case"hair_man":t.material=Le.getMaterial("hair_man")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!ss.haveHair&&i}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},rs={wireframe:!1,normal:.25,hair:2433041},ns={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:rs,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new z(rs.normal,-rs.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:rs.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:rs.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(t={},e=!1)=>{if(!Le.getMaterial(ns.materialRef))return;const i=Lee.materials;let s;for(let r in i){s=Le.getMaterial(r);for(let n in t)void 0!==s[n]&&(e&&i[r][n]?s[n]=i[r][n]:s[n]=t[n])}},applyMaterial:(t,e)=>{const i=Le.getMaterial(ns.materialRef);t.traverse((t=>{if(t.isMesh)switch(t.name){case"body_low":t.material=i,t.receiveShadow=!0,t.castShadow=!0;break;case"hair_low":t.material=Le.getMaterial("hair_low")||i,t.receiveShadow=!1,t.castShadow=!1;break;case"hair_low_2":t.material=Le.getMaterial("hair_low_2")||i,t.receiveShadow=!1,t.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},as={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},os={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:as,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:as.roughness,metalness:as.metalness,wireframe:as.wireframe,clearcoat:as.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:as.roughness,metalness:as.metalness,wireframe:as.wireframe,clearcoat:as.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:as.roughness,metalness:as.metalness,wireframe:as.wireframe,clearcoat:as.clearcoat,aoMap:"eva_ao"}},changeMaterial:(t,e=!1)=>{if(!Le.getMaterial(os.materialRef))return;const i=os.materials;let s;for(let r in i){s=Le.getMaterial(r);for(let n in t)void 0!==s[n]&&(e&&i[r][n]?s[n]=i[r][n]:s[n]=t[n]);s.needsUpdate=!0}},applyMaterial:(t,e)=>{const i=Le.getMaterial(e);t.traverse((t=>{if(t.isMesh)switch(t.material=i,t.receiveShadow=!0,t.castShadow=!0,t.name){case"eva_2_head":case"eva_2_mach":t.visible="eva02"===e;break;case"eva_L_COLLAR":case"eva_R_COLLAR":t.visible="eva00"!==e;break;case"eva_HEAD":case"eva_MACHOIR":t.visible="eva01"===e;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":t.visible="eva00"===e;break;case"eva_0_CHEST2":t.visible="eva01"!==e}}))}},ls={metalness:.2,roughness:.8,wireframe:!1},hs={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:ls,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:ls.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{if(!Le.getMaterial(hs.materialRef))return;const i=hs.materials;let s;for(let r in i){s=Le.getMaterial(r);for(let n in t)void 0!==s[n]&&(e&&i[r][n]?s[n]=i[r][n]:s[n]=t[n])}},applyMaterial:(t,e)=>{const i=Le.getMaterial("lee_material");t.traverse((t=>{t.isMesh&&(t.material=i,t.receiveShadow=!0,t.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},cs={metalness:.2,roughness:.8,wireframe:!1},us={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:cs,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:cs.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{},applyMaterial:(t,e)=>{},adjustment:()=>[]},ds=1/30,ps=Math.PI/180,ms=180/Math.PI,fs=new nt,gs={tmp:[],model:[],avatar:null,callback:()=>{},add:(t,e)=>{gs.tmp=[...t],gs.callback=e,gs.tmp.length&&gs.loadOne()},loadOne:()=>{let t=gs.tmp[0];gs.avatar=new ys({type:t,callback:gs.next,morph:!0,isPreload:!0})},next:t=>{gs.avatar.dispose(),gs.tmp.shift(),0===gs.tmp.length?gs.callback():gs.loadOne()}};class ys extends Tt{constructor(t={}){switch(super(),this.isPreload=t.isPreload||!1,this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.rootPath=t.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",this.callback=t.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=t.randomMorph||!1,this.randomSize=t.randomSize||!1,this.actionPose=null,this.model=t.type||"man",this.startAnimation=t.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=us;break;case"lee":this.ref=hs;break;case"man":case"woman":this.ref=ss;break;case"man_low":case"woman_low":this.ref=ns;break;case"eva00":case"eva01":case"eva02":this.ref=os}this.compact=void 0===t.compact||t.compact,this.haveMorph=void 0!==t.morph&&t.morph,this.fullMaterial=void 0===t.material||t.material,this.size=t.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,t.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new lt).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new nt,this.eyeTarget=new Tt,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new at,this.tmpQ=new lt,this.setting={},this.root=Le.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=Ki(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(t=0,e=1){return t+Math.random()*(e-t)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=Le.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const t=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");Le.load(this.ref.textures,this.loadModels.bind(this),t,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const t=this.ref.forceModel?this.ref.forceModel:this.model,e=[t+".glb"],i=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&e.push(t+"_morph.glb"),Le.load(e,this.init.bind(this),i,"loading models...")}update(t){this.done&&this.mixer&&(this.mixer.update(t),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*t),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const t=this.n++;let e=0;t<=10&&(e=.1*t),t>10&&t<=20&&(e=1-.1*(t-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",e)}look(t){if(!this.isEyeMove)return;if(this.isPause)return;const e=window.mouse||{x:0,y:0};t>1&&(t=1),this.headBoneLook.lerp({x:-20*e.y*ps,y:0,z:-20*e.x*ps},t),this.eyeTarget.position.lerp({x:.5*e.x,y:1,z:.25*-e.y},t);let i=this.headBoneLook;this.tmpQ.setFromEuler({_x:i.x,_y:i.y,_z:i.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let s=this.bones.ER,r=this.bones.EL,n={x:0,y:0,z:1};this.tmpMtx.lookAt(r.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),n),r.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(s.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),n),s.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let t=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,t),this.lerp(1,1.04,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,t),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,t),this.lerp(1.04,1,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,t),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(t,e,i){this.position.set(t,e,i),this.updateMatrix()}setRotation(t,e,i,s){let r=this.lerp(this.rotation.y,e,s);this.rotation.set(t,r,i),this.updateMatrix()}lerp(t,e,i){return(1-i)*t+i*e}onReady(){}initMaterial(){if(Le.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void Le.set(this.ref.materialRef,new P);let t,e,i;for(const s in this.ref.materials){i={...this.ref.materials[s]},e=i.type,delete i.type;for(const t in i)"envMapIntensity"!==t&&"normalMapType"!==t&&"aoMapIntensity"!==t&&"aoMapIntensity"!==t&&("map"!==t&&-1===t.search("Map")||(i[t]=Le.getTexture(i[t],{quality:this.textureQuality})));"Basic"===e?t=new E(i):"Standard"===e?t=new P(i):"Physical"===e?t=new T(i):"Sss"===e&&(t=new Xe(i)),t.name=s,Le.set(s,t)}this.setting=this.ref.setting}setMaterial(t,e){let i=Le.getMaterial(this.ref.materialRef);if(i)for(let e in t)void 0!==i[e]&&(i[e]=t[e])}setMaterialNormal(t){let e=Le.getMaterial("skin");e&&(t<0&&(t=0),e.normalScale.set(t,-t))}getMaterial(t){return Le.getMaterial(t)}init(){if(this.initMaterial(),!this.isClone){let t=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&Le.getMesh(t,!0),this.root=Le.get(t,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(t){t.raycast=function(){},t.isMesh&&(t.name===this.ref.skeletonRef&&(t.matrixAutoUpdate=!1,this.skeleton=t.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=t.geometry.boundingBox.max.y),"Head"===t.name&&(this.realSize=t.geometry.boundingBox.max.y),this.mesh[t.name]=t),t.isBone&&(this.bones[t.name]=t)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let t in this.mesh)this.mesh[t].isSkinnedMesh&&t!==this.ref.skeletonRef&&(this.mesh[t].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&Le.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),Le.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new d(this),0===Le.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let t=Le.clip.length;for(;t--;)this.addAction(Le.clip[t]);this.start()}}setRealSize(t){this.realSize=t;let e=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(e)}setSize(t){this.size=t,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(t){this.bones.head.scale.set(1,1,1).multiplyScalar(t)}addTensionMap(){this.tension1=new ts(this.mesh.body),this.tension2=new ts(this.mesh.Head)}setBounding(t){for(let e in this.mesh)this.mesh[e].isMesh&&(this.mesh[e].geometry.boundingSphere.radius=t)}setLevel(t){this.haveLOD&&this.lod!==t&&(this.lod=t,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let t in this.mesh)this.mesh[t].visible=!1}setVisible(t,e){"string"==typeof t&&(t=[t]);let i,s=t.length;for(;s--;)i=t[s],this.mesh[i]&&(this.mesh[i].visible=e)}setMorph(t,e){e=e<0?0:e,this.haveMorph&&(this.morpher("eyelash",t,e),this.morpher("eyebrow",t,e),this.morpher("tear",t,e),this.morpher("mouth",t,e),this.morpher("body",t,e),this.morpher("Head",t,e),this.morpher("body_low",t,e))}morpher(t,e,i){this.mesh[t]&&this.mesh[t].morphTargetInfluences&&void 0!==this.mesh[t].morphTargetDictionary[e]&&(this.mesh[t].morphTargetInfluences[this.mesh[t].morphTargetDictionary[e]]=i)}lerp(t,e,i){return(1-i)*t+i*e}clone(t){return new this.constructor({type:t.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(t){if(!this.haveMorph)return;t&&(this.bodyMorph=t);let e=Number(this.bodyMorph[0]),i=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",i<0?-i:0),this.setMorph("LOW",i>=0?i:0),this.setMorph("BIG",e<0?-e:0),this.setMorph("MONSTER",e>=0?e:0);let s=.5*(e+1),r=1-.5*(i+1);this.setMaterialNormal(.5*(r+s))}setFaceMorph(t){if(!this.haveMorph)return;t&&(this.faceMorph=t);let e=Number(this.faceMorph[0]),i=Number(this.faceMorph[1]);this.setMorph("Shock",i<0?-i:0),this.setMorph("Frown",i>=0?i:0),this.setMorph("SmileOpen",e<0?-e:0),this.setMorph("Angry",e>=0?e:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new zt(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new es(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(t,e){t.matrix=e.matrixWorld,t.matrixAutoUpdate=!1}loadAnimationJson(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){let t=JSON.parse(i.responseText);this.urls=[];for(let e in t)"main"===e?this.urls.push(...t[e]):this.urls.push(...t[e].map((t=>e+"/"+t)));this.endCallback=e||function(){},this.loadOne()}}.bind(this),i.send()}loadOne(){let t=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+t+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(t="./assets/models/animations.bin"){var e=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer";const i={animations:[]},s=this;e.onload=function(){Pe.decompress(e.response,(t=>{const e=JSON.parse(t);for(let t in e)i.animations.push(Pt.parse(e[t]));s.applydAnimation(i),s.start()}))},e.send()}loadAnimationGlb(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));Le.loaderGLTF().load(t,function(t){this.applydAnimation(t,i),e&&e()}.bind(this),null,e)}directGlb(t,e){Le.loaderGLTF().parse(t,"",function(t){this.stop(),this.applydAnimation(t,e)}.bind(this))}loadAnimationFbx(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));Le.loaderFBX().load(t,function(t){this.convertFbx(i,t.animations[0]),e&&e()}.bind(this),null,e)}directFbx(t,e){try{let i=Le.loaderFBX().parse(t,"");this.convertFbx(e,i.animations[0],!0)}catch(t){console.error("bug",t)}}applydAnimation(t,e){let i=t.animations.length,s=!1;for(1===i&&(e&&(t.animations[0].name=e),s=!0);i--;)this.addClip(t.animations[i]),this.addAction(t.animations[i],s)}addClip(t,e=!1){e&&Ct.makeClipAdditive(t);let i=Le.clip.length,s=-1;for(;i--;)Le.clip[i].name===t.name&&(s=i);-1!==s&&Le.clip.slice(s,1),Le.clip.push(t)}addAction(t,e){const i=this.mixer.clipAction(t);i.frameMax=Math.round(30*t.duration),i.play(),i.enabled=!0,-1!==t.name.search("idle")&&(i.enabled=!0),"Jumping Up"===t.name&&(i.loop=LoopPingPong),this.actions.set(t.name,i),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(t=!1,e=!1){let i=[],s=0;if(e){let e=Le.clip.length;for(;e--;)i[s]=t?Le.clip[s].toJSON():Le.clip[s],s++}else this.actions.forEach((function(e,r){i[s]=t?e._clip.toJSON():e._clip,s++}));return i}exportAnimationLzma(t){this.lzma||(this.lzma=new Pe(this.lzmaPath));const e=this.getAnimation(!0);this.lzma.compress(JSON.stringify(e),2,(function(e){if(t)t({name:"animations",data:new Uint8Array(e),type:"bin"});else{let t=document.createElement("a");t.style.display="none",document.body.appendChild(t),t.href=URL.createObjectURL(new Blob([new Uint8Array(e)],{type:"application/octet-stream"})),t.download="animations.bin",t.click()}}))}armAngle(){}autoToes(){if(!this.fixToe)return;let t=this.getRot("rFoot"),e=this.getRot("lFoot"),i=this.getWorldPos("hip"),s=this.getWorldPos("rToes"),r=this.getWorldPos("lToes");t[0]>0&&s.z-i.z<0?this.setRot("rToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("rToes",0,0,0),e[0]>0&&r.z-i.z<0?this.setRot("lToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(t,e,i){const s=Math.PI/180;let r=new nt,n=new lt,a=(new lt).setFromAxisAngle({x:1,y:0,z:0},90*s);const o=e.tracks,l=[];let h,c,u,d,p=o.length,m=0;for(;p--;){if(u=o[m],d=u.name.substring(0,u.name.lastIndexOf(".")),"hip.position"===u.name){let t=[];for(h=u.values.length/3;h--;)c=3*h,r.set(u.values[c],u.values[c+1],0).multiplyScalar(.01),r.toArray(t,c);l.push(new Rt(u.name,u.times,t))}else{let t=[];for(h=u.values.length/4;h--;)c=4*h,"hip"===d?n.set(u.values[c],u.values[c+1],u.values[c+2],u.values[c+3]).multiply(a):n.set(u.values[c],u.values[c+2],-u.values[c+1],u.values[c+3]),n.toArray(t,c);l.push(new Et(u.name,u.times,t))}m++}let f=new Pt(t,-1,l);f.duration=e.duration,this.stop(),this.addClip(f),this.addAction(f,i)}makePoseTrack(t,e,i=!1){const s=Math.PI/180;let r=new lt;const n=e,a=[];let o,l,h,c,u=n.length,d=0;for(;u--;){c=n[u],c.name;let t=[],e=[];for(d=0,o=3;o--;)l=0,h=4*d,e.push(.03333333507180214*d),r.setFromEuler({_x:c.values[0]*s,_y:c.values[1]*s,_z:c.values[2]*s,_order:"XYZ"}),r.toArray(t,h),d++;a.push(new Et(c.name+".quaternion",e,t))}let p=new Pt(t,-1,a,i?_t:Lt);p.duration=.10000000521540642;const m=this.mixer.clipAction(p);m.enabled=!0,m.setEffectiveTimeScale(1),m.setEffectiveWeight(1),m.play(),this.actionPose=m}prepareCrossFade(t,e,i){this.isPause=!1,this.unPause(),"idle"!==e._clip.name?this.executeCrossFade(t,e,i):this.synchronizeCrossFade(t,e,i)}synchronizeCrossFade(t,e,i){this.mixer.addEventListener("loop",(function r(n){n.action===t&&(s.mixer.removeEventListener("loop",r),s.executeCrossFade(t,e,i))}));const s=this}executeCrossFade(t,e,i,s=!0){this.setWeight(e,1),e.time=0,t.crossFadeTo(e,i,!0)}pause(){this.actions.forEach((function(t){t.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(t){t.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(t){t.play()}))}setTimescale(t){this.actions.forEach((function(e){e.setEffectiveTimeScale(t)}))}syncro(t){let e=this.getAction(t);if(!e)return;let i=e.time;this.actions.forEach((function(t){t.time=i}))}setWeight(t,e){t.enabled=!0,e<0&&(e=0),e>1&&(e=1),t.setEffectiveWeight(e)}getAnimInfo(t){let e=this.getAction(t);if(e)return{name:t,time:e.time,frame:Math.round(30*e.time),frameMax:e.frameMax,timeScale:e.timeScale}}getAction(t){return this.actions.get(t)}play(t,e=.5){let i=this.getAction(t);if(!i)return!1;if(this.current){if(this.current!==i){this.old=this.current,this.current=i;let s="idle"===this.current.getClip().name;s="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(t)?this.fixToe=!0:this.resetToes();let r=this.old.getEffectiveWeight(),n=this.current.getEffectiveWeight(),a=this.current.time;if(!s){let t=this.current.getClip().duration/this.old.getClip().duration;a=this.old.time*t}this.current.reset(),this.current.time=a,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(e,r,0),this.current._scheduleFading(e,n,1)):this.executeCrossFade(this.old,this.current,e)}}else this.stop(),this.current=i,i.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(t,e,i=1){let s=this.getAction(t);s&&(s.time=e*ds,s.setEffectiveWeight(i),s.play(),s.paused=!0,this.isPause=!0)}playOne(t,e=1){this.current&&(this.current.time=t*ds,this.current.setEffectiveWeight(e),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(t){t.setEffectiveWeight(0)}))}setRot(t,e,i,s){let r=this.bones[t];r&&(r.rotation.set(e*ps,i*ps,s*ps,"XYZ"),r.updateMatrix())}setRot2(t,e,i,s){let r=this.bones[t];if(!r)return;let n=(new lt).setFromEuler({_x:e*ms,_y:i*ms,_z:s*ms,_order:"XYZ"}).invert();r.quaternion.premultiply(n),r.updateMatrix()}getRot(t){let e=this.bones[t];if(!e)return;let i=e.rotation.toArray();return[Math.round(i[0]*ms),Math.round(i[1]*ms),Math.round(i[2]*ms)]}getWorldPos(t){let e=this.bones[t];if(e)return fs.set(0,0,0),e.localToWorld(fs),{x:fs.x,y:fs.y,z:fs.z}}bodyMask(t={arm:!0,leg:!0,foot:!0,chest:!0}){let e=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const i=this.canvas.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,256,256),i.fillStyle="black",t.arm&&i.fillRect(196,112,59,46.5),t.leg&&i.fillRect(128,183.5,71.75,72.5),t.foot&&i.fillRect(817*e,205.5,51.5,50),t.chest&&(i.fillRect(120,144,75,40),i.fillRect(553*e,116.5,57,27.5),i.fillRect(533*e,531*e,5,45*e));let s=new Image;s.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new g(s),this.mask.flipY=!1,this.mask.needsUpdate=!0;const r=Le.getMaterial("skin");r.alphaTest=.9,r.alphaMap=this.mask}zeroColor(t){t.isMesh&&(t=t.geometry);let e=t.attributes.position.array.length;t.setAttribute("color",new l(new Array(e).fill(0),3))}}class vs extends ft{constructor(t={},e){super(),this.motor=e,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=t.useImpulse||!1,this.useFloating=t.floating||!1,this.waitRotation=!1;let i=.3,s=t.radius||.3,r=t.height||1.8;this.realHeight=r,this.useFloating&&(r-=i),this.option={debug:!1,capsuleHalfHeight:.5*r,capsuleRadius:s,floatHeight:i,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-r,z:0},rayHitForgiveness:.1,rayLength:s+2,rayDir:{x:0,y:-1,z:0},floatingDis:s+i+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:s-.03,slopeRayLength:s+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new nt,movingObjectVelocity:new nt,standingForcePoint:new nt,pivotPosition:new nt,modelQuat:new lt,moveImpulse:new nt,impulseCenter:new nt,movingDirection:new nt,moveAccNeeded:new nt,jumpVelocityVec:new nt,jumpDirection:new nt,currentVel:new nt,currentPos:new nt,dragForce:new nt,dragAngForce:new nt,wantToMoveVel:new nt,rejectVel:new nt,floatingForce:null,springDirVec:new nt,rayOrigin:new nt,characterMassForce:new nt,slopeAngle:null,actualSlopeNormal:new nt,actualSlopeAngle:null,actualSlopeNormalVec:new nt,floorNormal:new nt(0,1,0),slopeRayOriginRef:new nt,slopeRayorigin:new nt,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.type="character",this.name=t.name||"hero",t.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=s,this.height=r,this.mass=t.mass||.84,delete t.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.velocity=new nt,this.angular=new nt,this.tmpV1=new nt,this.tmpV2=new nt,this.ease=new nt,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(t.angle||0)*ge,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=t.ray||!1,this.callback=t.callback||function(){},t.callback&&delete t.callback,this.initPhysic(t)}setHeight(t){this.model&&this.model.setRealSize(t)}reSizePhysics(t){if(t===this.realHeight)return;this.realHeight=t,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let e=this.position.toArray();e[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let i=[this.radius,this.height-2*this.radius];this.phyData.pos=e,this.phyData.size=i,this.motor.post({m:"add",o:this.phyData})}initPhysic(t){t.size||(t.size=[this.radius,this.height-2*this.radius]),t.pos||(t.pos=[0,0,0]),t.pos[1]+=.5*this.height,this.useFloating&&(t.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.getGeometryRef({...t,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:t.size,pos:t.pos,type:"character",shapeType:t.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==t.friction?t.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:t.massInfo},t.mask&&(this.phyData.mask=t.mask),this.motor.getCharacterRef().addToWorld(this,t.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),t.gender?this.addModel(t):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(t){t.hit?(this.distance=t.distance,this.rayAngle=t.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(t){this.contact=t}showHelper(t){t?this.helper||(this.helper=new zi(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=t)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Zi(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(t=!1){this.skeletonBody&&this.skeletonBody.isVisible(t),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:t,opacity:t?.8:1},!t),this.showHelper(t)}setMode(t){this.skeletonBody&&this.skeletonBody.setMode(t)}addModel(t){this.model=new ys({type:t.gender,anim:void 0!==t.anim?t.anim:"idle",compact:!0,material:!t.noMat,morph:t.morph||!1,randomMorph:t.randomMorph||!1,randomSize:t.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:t.noLOD||!1}),this.add(this.model);let e=-.5*this.height;this.useFloating&&(e-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+e,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(t,e){this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.velocity.fromArray(t,e+8),this.angular.fromArray(t,e+11),this.fall=this.position.y<this.oy,this.floor=xe.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const t=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let e=this.tmpV1.distanceTo(this.tmpV2)/t.zoom>3?0:1;this.model.setLevel(e)}set(t){t.morph&&this.model&&this.model.setMorph(t.morph,t.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper()}onFrame(t,e){this.v,this.option}autoBalance(){const t=this.v,e=this.option,i=this.rotation;t.dragAngForce.set(-e.autoBalanceSpringK*i.x-this.angular.x*e.autoBalanceDampingC,-e.autoBalanceSpringK*i.y-this.angular.y*e.autoBalanceDampingOnY,-e.autoBalanceSpringK*i.z-this.angular.z*e.autoBalanceDampingC)}moveCharacter(t,e=0){const i=this.v,s=this.option,r=this.motor.getKey();this.motor.getAzimut(),i.currentPos.copy(this.position),i.slopeAngle=0,i.actualSlopeAngle<s.slopeMaxAngle&&Math.abs(i.slopeAngle)>.2&&Math.abs(i.slopeAngle)<s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle),Math.cos(i.slopeAngle)):i.actualSlopeAngle>=s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle)>0?0:Math.sin(i.slopeAngle),Math.sin(i.slopeAngle)>0?.1:1):i.movingDirection.set(0,0,1),i.movingDirection.applyAxisAngle({x:0,y:1,z:0},e),i.movingObjectVelocityInCharacterDir.copy(i.movingObjectVelocity).projectOnVector(i.movingDirection).multiply(i.movingDirection);const n=i.movingObjectVelocity.angleTo(i.movingDirection),a=i.currentVel.dot(i.movingDirection);i.wantToMoveVel.set(i.movingDirection.x*a,0,i.movingDirection.z*a),i.rejectVel.copy(i.currentVel).sub(i.wantToMoveVel),i.moveAccNeeded.set((i.movingDirection.x*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.x)-(i.currentVel.x-i.movingObjectVelocity.x*Math.sin(n)+i.rejectVel.x*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime,0,(i.movingDirection.z*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.z)-(i.currentVel.z-i.movingObjectVelocity.z*Math.sin(n)+i.rejectVel.z*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime);const o=i.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(e).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?i.moveImpulse.set(o.x*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),o.z*(i.canJump?1:s.airDragMultiplier)):i.moveImpulse.set(o.x*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*s.turnVelMultiplier*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),o.z*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier)),i.impulseCenter.set(i.currentPos.x,i.currentPos.y+s.moveImpulsePointY,i.currentPos.z),i.currentVel.copy(this.velocity),r[4]&&i.canJump&&(i.jumpVelocityVec.set(i.currentVel.x,this.running?s.sprintJumpMult*s.jumpVel:s.jumpVel,i.currentVel.z),i.moveImpulse.y=i.jumpVelocityVec.y)}getFloating(){const t=this.v,e=this.option,i=e.springK*(e.floatingDis-this.distance)-this.velocity.y*e.dampingC;t.moveImpulse.y=i*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const t=this.motor.getKey(),e=this.motor.getAzimut(),i=this.motor.delta;let s=0!==t[7]?"run":"walk";0===t[0]&&0===t[1]&&(s="idle");let r=0!==t[0]&&0!==t[1]?this.diagonal:1;t[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===t[5]&&(this.toggle=!0),"walk"!==s&&"run"!==s||!this.crouch||(s="crouch"),1===t[6]&&(s="fight"),!this.jump&&t[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let n="idle";switch(s){case"idle":n=this.crouch?"Crouch Idle":"idle";break;case"walk":n="Jog Forward";break;case"run":n="Standard Run";break;case"crouch":n="Crouch Walk";break;case"fight":n="Attack"}this.moving=0!==t[0]||0!==t[1],this.running=0!==t[7],this.wantJump=0!==t[4];let a=xe.unwrapRad(Math.atan2(t[0],t[1])+e);if(this.useImpulse)this.moving?this.moveCharacter(i,a):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*i;const n=1;let a=this.speed[s]*n;this.moving&&(this.rs=t[0]*a,this.ts=t[1]*a),0===t[0]&&0===t[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*r),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let o=this.vy-9.81;this.ease.y=o,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},e),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=e,"idle"!==s&&this.helper.setDirection(a)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(n,.75),"idle"!==s)){let t=xe.unwrapRad(this.model.rotation.y),i=xe.nearAngle(a,t),r=Math.abs(Math.floor((t-i)*math.todeg)/180);this.model.rotation.y="fight"===s?e+Math.PI:xe.lerp(t,i,.2-.1*r),this.model.updateMatrix()}}}class ws extends si{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="character",this.num=qe[this.type]}step(t,e){let i,s,r=this.list.length;for(;r--;)s=this.list[r],i=e+r*this.num,s&&s.step(t,i)}add(t={}){this.setName(t);return new vs(t,this.motor)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const bs={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),toFixed:(t,e=3)=>1*t.toFixed(e),int:t=>Math.floor(t),lerp:(t,e,i)=>(1-i)*t+i*e,clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),nearEquals:(t,e,i)=>Math.abs(t-e)<=i,lerpAr:(t,e,i,s)=>{let r=t.length;for(;r--;)t[r]=bs.lerp(e[r],i[r],s)},unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),scaleArray:(t,e)=>{for(var i=t.length;i--;)t[i]*=e;return t},addArray:(t,e)=>{for(var i=[],s=t.length;s--;)i[s]=t[s]+e[s];return i},angleDistance:(t,e)=>{var i=(t-e+180)%360-180;return i<-180?i+360:i},tmpE:new kt,tmpM:new at,tmpM2:new at,tmpV:new nt,tmpQ:new lt,fromTransformToQ:(t,e,i)=>(i=i||!1,bs.tmpM.compose(bs.tmpV.fromArray(t),bs.tmpQ.fromArray(e),{x:1,y:1,z:1}),bs.tmpM.decompose(bs.tmpV,bs.tmpQ,{x:1,y:1,z:1}),i&&bs.tmpQ.invert(),bs.tmpQ.toArray()),fromTransform:(t,e,i,s,r)=>(r=r||!1,s=s||[0,0,0,1],bs.tmpM.compose(bs.tmpV.fromArray(t),bs.tmpQ.fromArray(e),{x:1,y:1,z:1}),bs.tmpM2.compose(bs.tmpV.fromArray(i),bs.tmpQ.fromArray(s),{x:1,y:1,z:1}),r?(bs.tmpM.invert(),bs.tmpM.multiply(bs.tmpM2)):bs.tmpM.multiply(bs.tmpM2),bs.tmpM.decompose(bs.tmpV,bs.tmpQ,{x:1,y:1,z:1}),bs.tmpV.toArray()),arCopy:(t,e)=>{},axisToQuatArray:(t,e)=>(e=e||!1,bs.tmpQ.setFromAxisAngle(bs.tmpV.fromArray(t,1),e?t[0]*bs.torad:t[0]).normalize().toArray()),toQuatArray:t=>bs.tmpQ.setFromEuler(bs.tmpE.fromArray(bs.vectorad(t))).toArray(),vectorad:t=>{let e=3,i=[];for(;e--;)i[e]=t[e]*bs.torad;return i[3]=t[3],i},rgbToHex:t=>"0x"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),hexToRgb:t=>[((t=Math.floor(t))>>16&255)/255,(t>>8&255)/255,(255&t)/255],htmlToHex:t=>t.toUpperCase().replace("#","0x"),hexToHtml:t=>"#"+("000000"+(t=void 0===t?0:t).toString(16)).substr(-6),rgbToHtml:t=>"#"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==bs.perlin&&(bs.perlin=null)},noise:(t,e)=>{null===bs.perlin&&(bs.perlin=new xs);let i,s,r=(e=e||{}).level||[1,.2,.05],n=e.frequency||[.016,.05,.2],a=0,o=0;for(i=0;i<r.length;i++)s=n[i],a+=r[i]*(.5+.5*bs.perlin.noise3d(t.x*s,t.y*s,t.z*s)),o+=r[i];return a/=o,a}};class xs{constructor(t){null==t&&(t=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(e=0;e<512;e++)this.perm[e]=this.p[255&e];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}dot4(t,e,i,s,r){return t[0]*e+t[1]*i+t[2]*s+t[3]*r}noise(t,e){var i,s,r=(t+e)*(.5*(Math.sqrt(3)-1)),n=Math.floor(t+r),a=Math.floor(e+r),o=(3-Math.sqrt(3))/6,l=(n+a)*o,h=t-(n-l),c=e-(a-l);h>c?(i=1,s=0):(i=0,s=1);var u=h-i+o,d=c-s+o,p=h-1+2*o,m=c-1+2*o,f=255&n,g=255&a,y=this.perm[f+this.perm[g]]%12,v=this.perm[f+i+this.perm[g+s]]%12,w=this.perm[f+1+this.perm[g+1]]%12,b=.5-h*h-c*c,x=.5-u*u-d*d,M=.5-p*p-m*m;return 70*((b<0?0:(b*=b)*b*this.dot(this.grad3[y],h,c))+(x<0?0:(x*=x)*x*this.dot(this.grad3[v],u,d))+(M<0?0:(M*=M)*M*this.dot(this.grad3[w],p,m)))}noise3d(t,e,i){var s,r,n,a,o,l,h=(t+e+i)*(1/3),c=Math.floor(t+h),u=Math.floor(e+h),d=Math.floor(i+h),p=1/6,m=(c+u+d)*p,f=t-(c-m),g=e-(u-m),y=i-(d-m);f>=g?g>=y?(s=1,r=0,n=0,a=1,o=1,l=0):f>=y?(s=1,r=0,n=0,a=1,o=0,l=1):(s=0,r=0,n=1,a=1,o=0,l=1):g<y?(s=0,r=0,n=1,a=0,o=1,l=1):f<y?(s=0,r=1,n=0,a=0,o=1,l=1):(s=0,r=1,n=0,a=1,o=1,l=0);var v=f-s+p,w=g-r+p,b=y-n+p,x=f-a+2*p,M=g-o+2*p,k=y-l+2*p,S=f-1+.5,A=g-1+.5,T=y-1+.5,z=255&c,P=255&u,C=255&d,R=this.perm[z+this.perm[P+this.perm[C]]]%12,E=this.perm[z+s+this.perm[P+r+this.perm[C+n]]]%12,_=this.perm[z+a+this.perm[P+o+this.perm[C+l]]]%12,L=this.perm[z+1+this.perm[P+1+this.perm[C+1]]]%12,I=.6-f*f-g*g-y*y,O=.6-v*v-w*w-b*b,D=.6-x*x-M*M-k*k,F=.6-S*S-A*A-T*T;return 32*((I<0?0:(I*=I)*I*this.dot3(this.grad3[R],f,g,y))+(O<0?0:(O*=O)*O*this.dot3(this.grad3[E],v,w,b))+(D<0?0:(D*=D)*D*this.dot3(this.grad3[_],x,M,k))+(F<0?0:(F*=F)*F*this.dot3(this.grad3[L],S,A,T)))}noise4d(t,e,i,s){var r,n,a,o,l,h,c,u,d,p,m,f,g=this.grad4,y=this.simplex,v=this.perm,w=(Math.sqrt(5)-1)/4,b=(5-Math.sqrt(5))/20,x=(t+e+i+s)*w,M=Math.floor(t+x),k=Math.floor(e+x),S=Math.floor(i+x),A=Math.floor(s+x),T=(M+k+S+A)*b,z=t-(M-T),P=e-(k-T),C=i-(S-T),R=s-(A-T),E=(z>P?32:0)+(z>C?16:0)+(P>C?8:0)+(z>R?4:0)+(P>R?2:0)+(C>R?1:0),_=z-(r=y[E][0]>=3?1:0)+b,L=P-(n=y[E][1]>=3?1:0)+b,I=C-(a=y[E][2]>=3?1:0)+b,O=R-(o=y[E][3]>=3?1:0)+b,D=z-(l=y[E][0]>=2?1:0)+2*b,F=P-(h=y[E][1]>=2?1:0)+2*b,B=C-(c=y[E][2]>=2?1:0)+2*b,N=R-(u=y[E][3]>=2?1:0)+2*b,U=z-(d=y[E][0]>=1?1:0)+3*b,V=P-(p=y[E][1]>=1?1:0)+3*b,q=C-(m=y[E][2]>=1?1:0)+3*b,W=R-(f=y[E][3]>=1?1:0)+3*b,j=z-1+4*b,H=P-1+4*b,G=C-1+4*b,X=R-1+4*b,Q=255&M,Y=255&k,J=255&S,Z=255&A,K=v[Q+v[Y+v[J+v[Z]]]]%32,$=v[Q+r+v[Y+n+v[J+a+v[Z+o]]]]%32,tt=v[Q+l+v[Y+h+v[J+c+v[Z+u]]]]%32,et=v[Q+d+v[Y+p+v[J+m+v[Z+f]]]]%32,it=v[Q+1+v[Y+1+v[J+1+v[Z+1]]]]%32,st=.6-z*z-P*P-C*C-R*R,rt=.6-_*_-L*L-I*I-O*O,nt=.6-D*D-F*F-B*B-N*N,at=.6-U*U-V*V-q*q-W*W,ot=.6-j*j-H*H-G*G-X*X;return 27*((st<0?0:(st*=st)*st*this.dot4(g[K],z,P,C,R))+(rt<0?0:(rt*=rt)*rt*this.dot4(g[$],_,L,I,O))+(nt<0?0:(nt*=nt)*nt*this.dot4(g[tt],D,F,B,N))+(at<0?0:(at*=at)*at*this.dot4(g[et],U,V,q,W))+(ot<0?0:(ot*=ot)*ot*this.dot4(g[it],j,H,G,X)))}}class Ms extends u{constructor(t={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=t.name,this.folder=t.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=t.terrainType||"terrain",this.callback=t.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[t.uv||18,t.uv||18],this.sample=null==t.sample?[128,128]:t.sample,this.size=void 0===t.size?[100,30,100]:t.size;let e=this.sample[0]-1,i=this.sample[1]-1;this.rx=e/this.size[0],this.rz=i/this.size[2],this.zone=t.zone||1;let s=[this.size[0]/e,this.size[2]/i];this.sampleZ=[t.sample[0]*this.zone,t.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*s[0],t.size[1],(this.sampleZ[1]-1)*s[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:t.level||[1,.2,.05],frequency:t.frequency||[.016,.05,.2],expo:t.expo||1},this.isWater=t.water||!1,this.isIsland=t.island||!1,this.isBorder=!1,this.wantBorder=t.border||!1,this.isBottom=!1,this.wantBottom=t.bottom||!1,this.wantBorder=t.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=t.maxSpeed||.1,this.acc=null==t.acc?.01:t.acc,this.dec=null==t.dec?.01:t.dec,this.deep=null==t.deep?0:t.deep,this.ease=new z,this.complexity=null==t.complexity?30:t.complexity,this.complexity2=null==t.complexity2?null:t.complexity2,this.local=new nt,t.local&&this.local.fromArray(t.local),this.pp=new nt,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=t.is64||!1,this.isTurn=t.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=t.isAbsolute||!1,this.isTurned=t.isTurned||!1,this.isReverse=t.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new S(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-bs.PI90),this.geometry.setAttribute("color",new n(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var r=new lt(.5,.5,.1,.2);t.maplevels&&r.fromArray(t.maplevels);var a,o=ks,l=t.maps||["sand","grass3","rock"],h={};this.isWater&&(l=["water"]);for(let e in l)a=l[e],h[a+"_c"]=Le.texture({url:this.folder+a+"_c.jpg",flip:!1,repeat:this.uvx,encoding:t.encoding||!0,callback:this.mapcallback.bind(this)}),h[a+"_n"]=Le.texture({url:this.folder+a+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});h.noise=Le.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=h,this.material=new T({name:"terrain",vertexColors:!0,color:16777215,map:h[l[0]+"_c"],normalMap:h[l[0]+"_n"]}),void 0!==t.envmap&&(this.material.envMap=t.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=t.opacity||.4,this.material.side=I,this.material.alphaMap=h[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=t.metalness||0,this.material.roughness=t.roughness||.3);var c=t.nScale||.5;if(this.material.normalScale.set(c,-c),this.isWater)this.material.onBeforeCompile=function(t){var e=t.fragmentShader;e=e.replace("#include <alphamap_fragment>",o.alphamap),t.fragmentShader=e};else{let t=this;this.material.onBeforeCompile=function(e){let i=e.uniforms;i.clevels={value:r},i.map1={value:h[l[1]+"_c"]},i.map2={value:h[l[2]+"_c"]},i.randomUv={value:1},i.normalMap1={value:h[l[1]+"_n"]},i.normalMap2={value:h[l[2]+"_n"]},i.noiseMap={value:h.noise},i.useNoiseMap={value:1},e.uniforms=i;let s=e.fragmentShader;s=s.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+Ss+o.fragmentAdd),s=s.replace("#include <map_fragment>",o.map),s=s.replace("#include <normal_fragment_maps>",o.normal),s=s.replace("#include <color_fragment>",""),e.fragmentShader=s,t.material.userData.shader=e},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(t){this.userData.shader.uniforms.randomUv.value=t?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(t){this.userData.shader.uniforms.map1.value=t}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(t){this.userData.shader.uniforms.map2.value=t}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(t){this.userData.shader.uniforms.normalMap1.value=t}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(t){this.userData.shader.uniforms.normalMap2.value=t}})}t.debug&&this.debugZone(t),this.wantBorder&&this.addBorder(t),this.wantBottom&&this.addBottom(t),t.pos&&this.position.fromArray(t.pos),t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=bs.toQuatArray(t.rot),delete t.rot),this.quaternion.fromArray(t.quat),t.decal&&(this.position.y+=t.decal),this.castShadow=!0,this.receiveShadow=!0,Le.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let t=.5*(this.sample[0]-this.sampleZ[0]),e=.5*(this.sample[1]-this.sampleZ[1]),i=this.sample[0]*e+t,s=0;for(let e=0;e<this.lngZ;e++)s=Math.floor(e/this.sampleZ[0]),this.zid[i+e+s*(2*t)]=e}debugZone(t){this.geometryZ=new S(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-bs.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const e=new u(this.geometryZ,new E({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(e)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(t){var e=new S(this.size[0],this.size[2],1,1);e.rotateX(bs.PI90),this.bottomMesh=new u(e,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(t){this.borderMaterial=new P({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?t.opacity||.8:1,envMap:t.envmap||null});var e=new S(this.size[0],2,this.sample[0]-1,1),i=new S(this.size[0],2,this.sample[0]-1,1),s=new S(this.size[2],2,this.sample[1]-1,1),r=new S(this.size[2],2,this.sample[1]-1,1);e.translate(0,1,.5*this.size[2]),i.rotateY(-bs.Pi),i.translate(0,1,.5*-this.size[2]),s.rotateY(-bs.PI90),s.translate(.5*-this.size[0],1,0),r.rotateY(bs.PI90),r.translate(.5*this.size[0],1,0),this.borderGeometry=Ee(Ce([e,i,s,r])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new n(this.borderColors,3)),this.borderMesh=new u(this.borderGeometry,this.borderMaterial);for(var a,o,l=this.lng2;l--;)a=3*l,o=this.borderVertices[a+1]>0?this.findPoint(this.borderVertices[a],this.borderVertices[a+2]):-1,this.list[l]=o;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let t in this.txt)this.txt[t].dispose()}easing(t,e,i){if(0!==t[0]||0!==t[1]){var s=e||0;t[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=t[1]*this.acc,this.ease.x+=t[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,t[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),t[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(i))}}getTri(){return this.geometry}getHeight(t,e){return t*=this.rx,e*=this.rz,t+=.5*this.sample[0],e+=.5*this.sample[1],t=Math.floor(t),e=Math.floor(e),(this.isTurn?this.height[this.findId2(t,e)]:this.height[this.findId(t,e)])*this.size[1]+this.position.y}findIdZ(t,e){return t+e*this.sampleZ[1]}findId(t,e){return t+e*this.sample[1]}findId2(t,e){return e+-t*this.sample[0]||1}findPoint(t,e){for(var i,s=this.lng;s--;)if(i=3*s,this.vertices[i]===t&&this.vertices[i+2]===e)return s;return-1}getReverseID(){this.invId=[];let t,e,i=this.lngZ;const s=this.sampleZ[1]-1;for(this.sampleZ[0];i--;)t=i%this.sampleZ[0],e=Math.floor(i*this.ratioZ),this.isReverse&&(e=s-e),this.invId[i]=this.isTurned?this.lngZ-1-this.findIdZ(e,t):this.findIdZ(t,e)}set(t){t.ease&&this.easing(t.key,t.azimut),t.decal&&this.decal(t.decal,!0)}decal(t,e){this.local.x+=t[0],this.local.y+=t[1],this.local.z+=t[2],this.update(e)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let t={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(t),this.material.normalMap&&this.material.normalMap.offset.copy(t)}}distance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}clamp(t,e=0,i=1){return t=(t=t<e?e:t)>i?i:t}update(t){let e,i,s,r,n,a,o,l,h,c,u,d=this.pp,p=[1,1,1],m=this.lng;for(;m--;){if(e=3*m,i=m%this.sample[0],s=Math.floor(m*this.ratio),d.set(i+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),r=bs.noise(d,this.data),this.isIsland){let t=1-this.distance({x:i,y:s},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));t*=4,t=this.clamp(t),r*=t}r=Math.pow(r,this.data.expo),r=this.clamp(r),"road"===this.ttype&&(l===s?r=1===i||2===i||29===i||30===i?h+.1:h:(l=s,h=r)),this.height[m]=r,c=r*this.size[1]+this.deep,this.vertices[e+1]=c,a=this.isAbsolute?r:r*this.size[1],void 0!==this.zid[m]&&(o=this.zid[m],n=this.changeId?this.invId[o]:o,this.heightData[n]=a,this.verticesZ&&(this.verticesZ[3*o+1]=c)),p=this.isWater?[r*this.colorBase.r,r*this.colorBase.g,r*this.colorBase.b]:[r,0,0],u=p[0],this.colors[e]=u,this.colors[e+1]=u,this.colors[e+2]=u}if(this.isBorder){let t,i=this.lng2;for(;i--;)e=3*i,-1!==this.list[i]?(t=this.height[this.list[i]],this.borderVertices[e+1]=t*this.size[1]+this.deep,u=bs.clamp(t+.25,.25,1),this.borderColors[e]=u,this.borderColors[e+1]=u,this.borderColors[e+2]=u):(this.borderColors[e]=this.colorBase.r,this.borderColors[e+1]=this.colorBase.g,this.borderColors[e+2]=this.colorBase.b)}t?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(t){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const ks={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "},Ss="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n";let As=null;class Ts extends si{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,As=this.motor.mat,this.type="terrain",this.num=qe[this.type]}step(t,e){let i,s=this.list.length;for(;s--;)i=this.list[s],i.step()}add(t={}){this.setName(t),"JOLT"===this.engine&&(t.isAbsolute=!0,t.isTurned=!1),"PHYSX"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"HAVOK"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"OIMO"!==this.engine&&(t.zone=t.zone||.25);const e=new Ms(t);return As.extendShader(e.material,e.material.onBeforeCompile),e.physicsUpdate=(t,e)=>{this.motor.flow.tmp.push({name:t,heightData:e})},this.addToWorld(e,t.id),this.motor.post({m:"add",o:zs(e,this.engine)}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const zs=function(t,e){const i={name:t.name,type:t.type,pos:t.position.toArray(),quat:"PHYSX"===e?[0,0,0,1]:t.quaternion.toArray()};return"PHYSX"===e||"AMMO"===e||"HAVOK"===e||"JOLT"===e?(i.type="terrain",i.size=t.sizeZ,i.sample=t.sampleZ,i.zone=t.zone,i.heightData=t.heightData):(i.type="mesh",i.v=xe.getVertex(t.geometry,"OIMO"===e),i.index="OIMO"===e?null:xe.getIndex(t.geometry)),i};class Ps extends si{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="solver"}step(t,e){let i,s=this.list.length;for(;s--;)i=e+s*qe[this.type],this.list[s].update(t,i)}add(t={}){this.setName(t);let e=new Cs(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}set(t={}){}}class Cs{constructor(t,e){this.motor=e,this.name=t.name,this.type="solver",this.needData=t.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(t){this.bones.push(t)}dispose(){this.motor.remove(this.bones,!0)}update(t,e){if(!this.needData)return;let i,s,r=this.joints.length;for(;r--;)s=e+7*r,i=this.joints[r],i.data.target.x=t[s+0],i.data.target.y=t[s+1],i.data.target.z=t[s+2],i.data.target.rx=t[s+3],i.data.target.ry=t[s+4],i.data.target.rz=t[s+5],i.data.target.count=t[s+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(t){this.jid=this.joints.length,t.name=t.name||this.name+"_Joint_"+this.jid,t.solver=this.name,void 0!==t.rot1&&(t.quat1=xe.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=xe.quatFromEuler(t.rot2),delete t.rot2),"fixe"!==t.type&&this.joints.push(new Rs(t,this)),this.motor.post({m:"addSolverJoint",o:t})}driveJoints(t){let e,i,s=!1,r=this.joints.length,n=[];for(;r--;)e=this.joints[r],e.update(t),i=e.isDrive,e.nup&&n.push(e.nup),s=!!i||s;s?this.motor.change(n):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(t,e){if(!t)return;let i=this.joints.length;for(;i--;)this.joints[i].pose(void 0!==t[i]?t[i]:0,void 0!==e?e:this.speed);return new Promise((t=>this.resolve=t))}}class Rs{constructor(t,e){if(this.name=t.name,this.solver=e,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},t.limits&&(this.driveType=t.limits[0][0],this.min=t.limits[0][1],this.max=t.limits[0][2]),t.position&&(t.target=t.position),t.target){let e,i=t.target.length;for(;i--;)e=t.target[i],this.data.target[e[0]]=e[1]}}start(){}pose(t,e){this.target=xe.clamp(t,this.min,this.max),this.current=xe.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=e,this.isDrive=!0)}update(t){if(this.isDrive){this.tmp+=t*this.time;let e=this.tmp;e=e>1?1:e;let i=xe.lerp(this.start,this.target,e);this.nup={name:this.name,drivesTarget:[[this.driveType,i]]},1===e&&(this.isDrive=!1)}else this.nup=null}}class Es{constructor(t){this.map=new Map,this.motor=t,this.enginReady=["PHYSX","HAVOK","OIMO"],this.rc=this.refresh.bind(this)}reset(){this.map=new Map}step(){this.map.forEach(this.rc)}refresh(t,e){let i=this.motor.reflow.contact[e];if(void 0!==i)for(let e=0,s=i.length;e<s;e++)t.userData.collisionCallback?t.userData.collisionCallback(i[e]):t.dispatchEvent({type:"collision",data:i[e]})}isReady(){return-1!==this.enginReady.indexOf(this.motor.engine)}remove(t){this.isReady()&&this.map.has(t)&&(this.map.delete(t),this.motor.post({m:"removeCollision",o:{name:t}}))}add(t){if(!this.isReady())return;let e=t.name,i=this.motor.byName(e);null!==i&&(t.vs&&t.vs.constructor!==Array&&(t.vs=[t.vs]),t.ignore&&t.ignore.constructor!==Array&&(t.ignore=[t.ignore]),t.callback&&(i.userData.collisionCallback=t.callback,delete t.callback),this.map.set(e,i),this.motor.post({m:"addCollision",o:t}))}}class _s extends u{constructor(t={}){super(new S,new E({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=t.nam||"text",this.canvas=null,this.w=t.w||0,this.h=t.h||0,this.weight=t.weight??700,this.font=t.font??"'Mulish', sans-serif",this.fontSize=t.fontSize??32,this.backgroundColor=t.backgroundColor??"#00000000",this.fontColor=t.color??"#FFFFFF",this.material.alphaTest=.5,this.set(t.text),t.pos&&this.position.fromArray(t.pos),t.rot&&this.quaternion.fromArray(xe.quatFromEuler(t.rot))}set(t){this.canvas||(this.canvas=document.createElement("canvas"));let e,i,s,r=this.canvas.getContext("2d");r.font=this.weight+" "+this.fontSize+"px "+this.font;let n=r.measureText(t);e=2**Math.ceil(Math.log2(n.width)),i=2**Math.ceil(Math.log2(r.measureText("M").width)),this.canvas.width=e,this.canvas.height=i,r.fillStyle=this.backgroundColor,r.fillRect(0,0,e,i),r.fillStyle=this.fontColor,r.font=this.weight+" "+this.fontSize+"px "+this.font,r.textAlign="center",r.textBaseline="middle",r.fillText(t,.5*e,.5*i),this.material.map=new A(this.canvas),0!==this.h?(s=this.h/i,this.scale.set(e*s,this.h,0)):0!==this.w?(s=this.w/i,this.scale.set(this.w,i*s,0)):this.scale.set(.025*e,.025*i,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let Ls=0;class Is{constructor(t={},e){this.motor=e,this.down=!1,this.time=t.time||250,this.p=t.pos||[0,0,0],this.type=t.type||"box",this.name=t.name||"button"+Ls++,this.pos=t.pos||[0,0,0],this.size=t.size||[1,1,1],this.radius=t.radius||0,this.axe=void 0!==t.axe?t.axe:1,this.fontSize=t.fontSize||.8,this.fontScale=t.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let i=this.size[this.axe]-2*this.radius;this.range=[this.origin-i,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},t.callback&&(this.callback=t.callback,delete t.callback),t.button=!0,t.pos=this.pos,t.material||(t.material="button"),t.kinematic=!0,t.mask=1,this.timeout=null,this.b=this.motor.add(t),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),t.text&&this.addText(t.text)}addText(t,e){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let i={text:t,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(i={text:t,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new _s(i),this.b.add(this.txt)}action(t){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(t||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=xe.lerp(this.value,this.target,this.speed),xe.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}const Os=new ut;class Ds extends w{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),s=new Float32Array(24);let o=new a(e),l=[],h=8;for(;h--;)l.push(o.r,o.g,o.b);const c=new Float32Array(l),u=new r;u.setIndex(new n(i,1)),u.setAttribute("position",new n(s,3)),u.setAttribute("color",new n(c,3)),super(u,new b({vertexColors:!0,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Os.setFromObject(this.object),Os.isEmpty())return;const e=Os.min,i=Os.max,s=this.geometry.attributes.position,r=s.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=e.x,r[4]=i.y,r[5]=i.z,r[6]=e.x,r[7]=e.y,r[8]=i.z,r[9]=i.x,r[10]=e.y,r[11]=i.z,r[12]=i.x,r[13]=i.y,r[14]=e.z,r[15]=e.x,r[16]=i.y,r[17]=e.z,r[18]=e.x,r[19]=e.y,r[20]=e.z,r[21]=i.x,r[22]=e.y,r[23]=e.z,s.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Fs{constructor(t={},e){this.motor=e,this.isCompound=!0,this.remplace=t.remplace||!1,this.init(t)}init(t={}){const e=t.intern||!1;let i=t.size||[5,3,8],s=t.pos||[0,2,0],r=t.wall||.1;void 0!==t.size[3]&&(r=t.size[3]),r<=0&&(r=.01);let n=.5*r,a=2*r;t.face||(t.face={});let o={up:1,down:1,left:1,right:1,front:1,back:1,...t.face};delete t.face;const l=[];e?(1===o.up&&l.push({pos:[0,.5*i[1]+n,0],size:[i[0]+a,r,i[2]+a]}),1===o.down&&l.push({pos:[0,-n-.5*i[1],0],size:[i[0]+a,r,i[2]+a]}),1===o.left&&l.push({pos:[-n-.5*i[0],0,0],size:[r,i[1],i[2]]}),1===o.right&&l.push({pos:[.5*i[0]+n,0,0],size:[r,i[1],i[2]]}),1===o.back&&l.push({pos:[0,0,-n-.5*i[2]],size:[i[0]+a,i[1],r]}),1===o.front&&l.push({pos:[0,0,.5*i[2]+n],size:[i[0]+a,i[1],r]})):(1===o.up&&l.push({pos:[0,.5*i[1]-n,0],size:[i[0],r,i[2]]}),1===o.down&&l.push({pos:[0,n-.5*i[1],0],size:[i[0],r,i[2]]}),1===o.left&&l.push({pos:[n-.5*i[0],0,0],size:[r,i[1]-a,i[2]]}),1===o.right&&l.push({pos:[.5*i[0]-n,0,0],size:[r,i[1]-a,i[2]]}),1===o.back&&l.push({pos:[0,0,n-.5*i[2]],size:[i[0]-a,i[1]-a,r]}),1===o.front&&l.push({pos:[0,0,.5*i[2]-n],size:[i[0]-a,i[1]-a,r]}));const h=[];let c,d,p=l.length,m=0;for(;p--;)d=l[m],c=this.isCompound?d.pos:xe.addArray(s,d.pos),h.push({type:"box",size:d.size,pos:c,material:t.material}),m++;if(this.isCompound){let e=null;this.remplace&&(e=0===t.radius?new u(new k(i[0],i[1],i[2])):new u(new di(i[0],i[1],i[2],t.radius||n)),t.material&&"debug"===t.material&&(e=new Ds(e,t.color),t.material="line"),e.raycast=()=>{}),this.motor.add({...t,mesh:e,shapes:h,type:"compound",ray:!1})}else this.motor.add(h)}}class Bs{constructor(t,e="drag",i){this.motor=i,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=e,this.option={},this.overObj=null,this.controler=t,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new nt,this.tmpPos=new nt,this.tmpD=new nt,this.mouse=new z,this.oldMouse=new z,this.raycast=new It,this.raycast.far=1e3,this.button=0,this.pos=new nt,this.velocity=new nt,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.floorDrag=2===this.button,this.helper=new Ns(this.motor),this.dragPlane=new u(new S(1,1),this.motor.mat.get("hide")),this.floorDrag&&this.dragPlane.geometry.rotateX(.5*-Math.PI),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.dragPlane.visible=!1,this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(t,e={}){t!==this.mode&&(this.mode=t,this.option=e,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(t){t?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(t){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(t){this.raycastTest=!1}controleChange(t){}getMouse(t){this.motor.viewSize?(this.mouse.x=t.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-t.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=t.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-t.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==t.pointerType?t.button:0}contextmenu(t){}mousedown(t){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(t),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(t){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(t){if("drag"===this.mode)this.getMouse(t),this.needRay=!0}castray(){let t,e,i,s,r,n="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObject(this.dragPlane),t.length&&this.mouseDown&&this.moveSelect(t[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,t.length>0?(i=t[0].object,i.isInstancedMesh?(r=t[0].instanceId,e=this.motor.byName(i.getIDName(r))):i.parent!==this.motor.scene?(s=i.parent,e=s.parent!==this.motor.scene?s.parent:s):e=i,this.mouseDown2&&e.extra&&e.extra(e.name),n=e&&!e.isButton?this.select(e,t[0].point):this.actionButton(e,t[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,n="auto",this.resetOver()),document.body.style.cursor=n}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.needRay=!0}blast(){let t=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let e=this.raycast.intersectObjects(this.motor.scene.children,!0);e.length>0?e[0].object.isButton?e[0].object.parent.userData.direct():t=e[0]:(e=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),e.length>0&&(t=e[0]));const i=this.option;t&&(this.motor.explosion(t.point,i.radius||3,i.power||.1),i.visible&&this.motor.addParticle({name:"blast",type:"cube",position:t.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){const t=this.option;this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(t.velocity||60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",mass:t.mass||10,size:[t.size||.2],material:t.mat||"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(t,e){if(this.buttonRef?this.buttonRef.name!==t.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=t):this.mouseDown&&(this.buttonRef=t),this.mouseDown&&this.buttonRef.userData.action){let t=e.point;this.buttonRef.userData.action(t)}return"pointer"}setOver(t){t&&(this.overObj&&t.name!==this.overObj.name&&this.resetOver(),this.overObj=t,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(t,e){if(this.mouseDown||this.setOver(t),!this.mouseDown||this.selected===t)return"grab";this.pz=0;let i=e,s=[0,0,0,1];this.selected=t,this.decal.copy(i).sub(this.selected.position),this.tmpPos.copy(i).sub(this.decal),this.angle=this.controler.getAzimuthalAngle(),s=this.selected.quaternion.toArray(),this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(i),this.helper.position.copy(i);let r=i.toArray(),n=!1;this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0});const a=this.motor.engine;if(this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let t=[-.1,.1,600,1],e=[-.1,.1,600,1],i="OIMO"===a||"RAPIER"===a||"JOLT"===a,o=0===this.selected.link?"fixe":"d6";"JOLT"===a&&(o="fixe");let l=[["x",...t],["y",...t],["z",...t],["rx",...e],["ry",...e],["rz",...e]];"HAVOK"===a&&(l=[["x",...t],["y",...t],["z",...t]]),"OIMO"===a&&(n=!0,o=0===this.selected.link?"fixe":"spherical",l=[["x",...t],["y",...t],["z",...t]]),"HAVOK"===a&&(o=0===this.selected.link?"fixe":"spherical",l=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:r,quat:s,kinematic:!i},{name:"mouseJoint",type:"joint",mode:o,lm:l,sd:[4,1],autoDrive:!0,b1:n?this.selected.name:"mouse",b2:n?"mouse":this.selected.name,worldAnchor:r,visible:!1}])}return"grabbing"}moveSelect(t){if(null===this.selected)return;if(t&&this.tmpPos.copy(t).sub(this.decal),this.moveDeep){let t=this.selected.position.y,e=t-this.tmpPos.y;this.tmpPos.y=t,this.tmpD.set(0,0,e).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let e=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:e,reset:!0}):this.motor.change({name:"mouse",pos:t.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let t=this.motor.flow.key;if(0!==t[1]){let e=.1*t[1];this.dragPlane.translateZ(e),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class Ns extends rt{constructor(t){super(new r,t.mat.get("line"));let e=.75;const i=[e,e,e,0,0,0];this.geometry.setAttribute("position",new l([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new l(i,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}function Us(t,e,i,s){return function(t,e,i,s,r){let n=e.x-t.x,a=e.y-t.y,o=s.x-i.x,l=s.y-i.y;const h=Gs(t),c=Gs(i);if(h===c)return r;const u=Gs(e);if(u===c)return r;const d=Gs(s);if(h===d)return r;if(u===d)return r;let p=(t.x-i.x)*l-(t.y-i.y)*o,m=(e.x-i.x)*l-(e.y-i.y)*o,f=(i.x-t.x)*a-(i.y-t.y)*n,g=(s.x-t.x)*a-(s.y-t.y)*n;return(p>=0&&m<=0||p<=0&&m>=0)&&(f>=0&&g<=0||f<=0&&g>=0)}(t,e,i,s,!1)}function Vs(t,e,i,s){let r=0,n=new nt;return Xs(t)===Xs(e)||0===i.x&&0===i.y&&0===i.z?null:(r=((s.x-t.x)*i.x+(s.y-t.y)*i.y+(s.z-t.z)*i.z)/((e.x-t.x)*i.x+(e.y-t.y)*i.y+(e.z-t.z)*i.z),r<0||r>1?null:(n=new nt(t.x+(e.x-t.x)*r,t.y+(e.y-t.y)*r,t.z+(e.z-t.z)*r),{x:n,s:r}))}function qs(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)<=0}function Ws(t){return parseInt(Math.round(1e6*t))}function js(t,e=1e6){return Math.floor(t*e)}function Hs(t,e){return Math.round((t+e)*(t+e+1)*.5+e)}function Gs(t){return Hs(js(t.x),js(t.y))}function Xs(t){const e=js(t.x),i=js(t.y),s=js(t.z),r=(e+i)*(e+i+1)*.5+i;return(r+s)*(r+s+1)*.5+s}function Qs(t,e,i){return!(e.x*(t.x-i.x)+e.y*(t.y-i.y)+e.z*(t.z-i.z)<0)}class Ys{constructor(t=new nt,e=new nt,i=new z){this.position=t,this.normal=e,this.uv=i}equals(t){return Xs(this.position)===Xs(t.position)}toString(){return`Position = ${this.position.x}, ${this.position.y}, ${this.position.z}, Normal = ${this.normal.x}, ${this.normal.y}, ${this.normal.z}, UV = ${this.uv.x}, ${this.uv.y}`}}class Js{constructor(){this.vertices=[],this.cutVertices=[],this.triangles=[[],[]],this.constraints=[],this.indexMap=[],this.bounds=new ut,this.vertexAdjacency=[],this.convextested=!1}static fromGeometry(t){const e=t.attributes.position.array,i=t.attributes.normal.array,s=t.attributes.uv.array,r=t.attributes.position.count;let n,a;const o=new Js;for(let t=0;t<r;t++)n=3*t,a=2*t,o.vertices.push(new Ys(new nt(e[n],e[n+1],e[n+2]),new nt(i[n],i[n+1],i[n+2]),new z(s[a],s[a+1])));return o.triangles=[[...t.index.array],[]],o.calculateBounds(),o}get size(){this.bounds||this.calculateBounds();let t=new nt;return this.bounds.getSize(t)}get convex(){return this.convextested||(this.cc=this.isConvex()),this.cc}get triangleCount(){return(this.triangles[0].length+this.triangles[1].length)/3}get vertexCount(){return this.vertices.length+this.cutVertices.length}addCutFaceVertex(t,e,i){const s=new Ys(t,e,i);this.vertices.push(s),this.cutVertices.push(s),this.vertexAdjacency.push(this.vertices.length-1)}addMappedVertex(t,e){this.vertices.push(t),this.indexMap[e]=this.vertices.length-1}addTriangle(t,e,i,s){this.triangles[s].push(t,e,i)}addMappedTriangle(t,e,i,s){this.triangles[s].push(this.indexMap[t],this.indexMap[e],this.indexMap[i])}weldCutFaceVertices(){const t=[],e=[],i=new Array(this.cutVertices.length);let s=0;const r=new Map;this.cutVertices.forEach(((n,a)=>{const o=function(t){let e=Ws(t.x),i=Ws(t.y),s=Ws(t.z),r=(e+i)*(e+i+1)*.5+i;return(r+s)*(r+s+1)*.5+s}(n.position),l=r.get(o);void 0===l?(i[a]=s,r.set(o,s),t.push(this.cutVertices[a]),e.push(this.vertexAdjacency[a]),s++):i[a]=l}));for(let t=0;t<this.constraints.length;t++){const e=this.constraints[t];e.v1=i[e.v1],e.v2=i[e.v2]}this.cutVertices=t,this.vertexAdjacency=e}calculateBounds(){if(!this.vertices.length)return;let t=this.vertices[0].position.clone(),e=t.clone();this.vertices.forEach((i=>{t.x=Math.min(t.x,i.position.x),t.y=Math.min(t.y,i.position.y),t.z=Math.min(t.z,i.position.z),e.x=Math.max(e.x,i.position.x),e.y=Math.max(e.y,i.position.y),e.z=Math.max(e.z,i.position.z)})),this.bounds.set(t,e)}calculateBounds_(t=!1){null===this.bounds&&(this.bounds=new ut);let e=this.vertices.length;t&&(e+=this.cutVertices.length);const i=[];let s=-1;for(const t of this.vertices)i[s++]=t.position;if(t)for(const t of this.cutVertices)i[s++]=t.position;this.bounds.setFromPoints(i)}toMesh(t,e=null,i=!0,s=0){const r=new nt,n=new nt;let a=this.toGeometry(i,s);a.boundingBox.getCenter(r),a.boundingBox.getSize(n),a.translate(-r.x,-r.y,-r.z),a.boundingSphere=new Ot(new nt,.5*n.length());let o=t.material;e&&o.isMaterial&&(o=[t.material,e]);const l=new u(a,o);return l.receiveShadow=t.receiveShadow,l.castShadow=t.castShadow,l.sizer=n.length(),r.applyQuaternion(t.quaternion),l.position.copy(t.position).add(r),l.quaternion.copy(t.quaternion),l.userData={origin:l.position.clone(),direction:r.normalize(),size:n},l}makeTrickness(t,e,i,s,r){let n,a=1-r,o=[...t],l=[...e],h=[...i],c=t.length/3,u=c;for(;u--;)n=3*u,o[n]*=a,o[n+1]*=a,o[n+2]*=a;let d=[];for(u=s.length;u--;)d[u]=s[u]+c;return[o,l,h,d]}toGeometry(t,e){let i;const s=new r;let a=[],o=[],l=[];if(this.vertices.forEach((t=>{a.push(t.position.x,t.position.y,t.position.z),o.push(t.normal.x,t.normal.y,t.normal.z),l.push(t.uv.x,t.uv.y)})),0!==e){let t=this.makeTrickness(a,o,l,this.triangles[0],e);a=a.concat(t[0]),o=o.concat(t[1]),l=l.concat(t[2]),i=t[3]}return t&&this.cutVertices.forEach((t=>{a.push(t.position.x,t.position.y,t.position.z),o.push(t.normal.x,t.normal.y,t.normal.z),l.push(t.uv.x,t.uv.y)})),s.addGroup(0,this.triangles[0].length,0),0!==e&&(s.addGroup(this.triangles[0].length,i.length,1),this.triangles[0]=this.triangles[0].concat(i)),t&&s.addGroup(this.triangles[0].length,this.triangles[1].length,1),s.setAttribute("position",new n(new Float32Array(a),3)),s.setAttribute("normal",new n(new Float32Array(o),3)),s.setAttribute("uv",new n(new Float32Array(l),2)),s.setIndex(new n(new Uint32Array(this.triangles.flat()),1)),s.computeBoundingBox(),s}isConvex(t=.001){this.convextested=!0;let e=0;const i=this.triangleCount,s=[...this.triangles[0],...this.triangles[1]],r=[...this.vertices,...this.cutVertices],n=r.length;if(0===i||0===n)return!1;const a=new nt,o=new nt,l=new nt,h=new nt,c=new nt;let u,d;for(let p=0;p<i;p++){e=3*p,c.copy(r[0].position),a.copy(r[s[e]].position),o.copy(r[s[e+1]].position),l.copy(r[s[e+2]].position),o.sub(a),l.sub(a),h.copy(o).cross(l).normalize(),u=c.sub(a).dot(h);for(let e=0;e<n;e++)if(d=c.copy(r[e].position).sub(a).dot(h),Math.abs(u)>t&&Math.abs(d)>t&&u*d<0)return!1}return!0}}class Zs{constructor(t){this.parent=new Array(t),this.rank=new Array(t);for(let e=0;e<t;e++)this.parent[e]=e,this.rank[e]=1}find(t){return this.parent[t]!==t&&(this.parent[t]=this.find(this.parent[t])),this.parent[t]}union(t,e){const i=this.find(t),s=this.find(e);i!==s&&(this.rank[i]>this.rank[s]?this.parent[s]=i:this.rank[i]<this.rank[s]?this.parent[i]=s:(this.parent[s]=i,this.rank[i]+=1))}}let Ks=class{constructor(t,e,i,s,r){this.v1=t,this.v2=e,this.t1=void 0!==i?i:-1,this.t2=void 0!==s?s:-1,this.t1Edge=void 0!==r?r:0}equals(t){return this.v1===t.v1&&this.v2===t.v2||this.v1===t.v2&&this.v2===t.v1}toString(){return`Edge: T${this.t1}->T${this.t2} (V${this.v1}->V${this.v2})`}};class $s{static getBinNumber(t,e,i){return t%2==0?t*i+e:(t+1)*i-e-1}static sort(t,e,i){if(i<=1)return t;e>t.length&&(e=t.length);const s=new Array(i).fill(0),r=new Array(t.length);for(let i=0;i<e;i++)s[t[i].bin]++;for(let t=1;t<i;t++)s[t]+=s[t-1];for(let i=e-1;i>=0;i--){const e=t[i].bin;s[e]--,r[s[e]]=t[i]}for(let i=e;i<r.length;i++)r[i]=t[i];return r}}let tr=class{constructor(t,e){this.index=t,this.coords=e,this.bin=0}toString(){return`${this.coords} -> ${this.bin}`}};const er=-1;class ir{constructor(t,e){if(this.normalizationScaleFactor=1,this.N=t.length,this.N>=3){this.triangleCount=2*this.N+1,this.triangulation=Array.from({length:this.triangleCount},(()=>new Array(6).fill(0))),this.skipTriangle=new Array(this.triangleCount).fill(!1),this.points=new Array(this.N+3),this.normal=e.clone().normalize();let r=t[0].position.clone().sub(t[1].position).normalize(),n=this.normal.clone(),a=new nt;a.crossVectors(r,n).normalize();for(let e=0;e<this.N;e++){var i=t[e].position,s=new z(i.dot(r),i.dot(a));this.points[e]=new tr(e,s)}}else this.triangleCount=0,this.triangulation=[],this.skipTriangle=[],this.points=[],this.normal=new nt}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.discardTrianglesWithSuperTriangleVertices();const t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||t.push(this.triangulation[e][0],this.triangulation[e][1],this.triangulation[e][2]);return t}normalizeCoordinates(){let t=Number.MAX_VALUE,e=Number.MIN_VALUE,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let r=0;r<this.N;r++)t=Math.min(t,this.points[r].coords.x),e=Math.max(e,this.points[r].coords.x),i=Math.min(i,this.points[r].coords.y),s=Math.max(s,this.points[r].coords.y);const r=Math.max(e-t,s-i);for(let e=0;e<this.N;e++){var n=this.points[e],a=new z((n.coords.x-t)/r,(n.coords.y-i)/r);this.points[e].coords=a}}sortPointsIntoBins(){const t=Math.round(Math.pow(this.N,.25)),e=t*t;for(let e=0;e<this.N;e++){var i=this.points[e];const s=Math.floor(.99*t*i.coords.y),r=Math.floor(.99*t*i.coords.x);i.bin=$s.getBinNumber(s,r,t)}return $s.sort(this.points,this.N,e)}computeTriangulation(){let t=0,e=0,i=this.sortPointsIntoBins();for(let s=0;s<this.N;s++){let r=i[s];if(!r)break;let n=0,a=!1;for(;!a&&!(n++>e||t===er);){let i=this.points[this.triangulation[t][0]].coords,s=this.points[this.triangulation[t][1]].coords,n=this.points[this.triangulation[t][2]].coords;qs(i,s,r.coords)?qs(s,n,r.coords)?qs(n,i,r.coords)?(this.insertPointIntoTriangle(r,t,e),e+=2,t=e,a=!0):t=this.triangulation[t][5]:t=this.triangulation[t][4]:t=this.triangulation[t][3]}}}addSuperTriangle(){this.points[this.N]=new tr(this.N,new z(-100,-100)),this.points[this.N+1]=new tr(this.N+1,new z(0,100)),this.points[this.N+2]=new tr(this.N+2,new z(100,-100)),this.triangulation[0][0]=this.N,this.triangulation[0][1]=this.N+1,this.triangulation[0][2]=this.N+2,this.triangulation[0][3]=er,this.triangulation[0][4]=er,this.triangulation[0][5]=er}insertPointIntoTriangle(t,e,i){const s=e,r=i+1,n=i+2;this.triangulation[r][0]=t.index,this.triangulation[r][1]=this.triangulation[e][1],this.triangulation[r][2]=this.triangulation[e][2],this.triangulation[r][3]=n,this.triangulation[r][4]=this.triangulation[e][4],this.triangulation[r][5]=s,this.triangulation[n][0]=t.index,this.triangulation[n][1]=this.triangulation[e][0],this.triangulation[n][2]=this.triangulation[e][1],this.triangulation[n][3]=s,this.triangulation[n][4]=this.triangulation[e][3],this.triangulation[n][5]=r,this.updateAdjacency(this.triangulation[e][3],e,n),this.updateAdjacency(this.triangulation[e][4],e,r),this.triangulation[s][1]=this.triangulation[e][2],this.triangulation[s][2]=this.triangulation[e][0],this.triangulation[s][0]=t.index,this.triangulation[s][4]=this.triangulation[e][5],this.triangulation[s][3]=r,this.triangulation[s][5]=n,this.restoreDelauneyTriangulation(t,s,r,n)}restoreDelauneyTriangulation(t,e,i,s){const r=[];for(r.push([e,this.triangulation[e][4]]),r.push([i,this.triangulation[i][4]]),r.push([s,this.triangulation[s][4]]);r.length>0;)if([e,i]=r.pop()??[er,er],i!==er){const s=this.swapQuadDiagonalIfNeeded(t.index,e,i);null!==s&&(r.push([e,s.t3]),r.push([i,s.t4]))}}swapQuadDiagonalIfNeeded(t,e,i){let s=0,r=0,n=0,a=t,o=0,l=0;return this.triangulation[i][3]===e?(s=this.triangulation[i][1],r=this.triangulation[i][0],n=this.triangulation[i][2],o=this.triangulation[i][4],l=this.triangulation[i][5]):this.triangulation[i][4]===e?(s=this.triangulation[i][2],r=this.triangulation[i][1],n=this.triangulation[i][0],o=this.triangulation[i][5],l=this.triangulation[i][3]):(s=this.triangulation[i][0],r=this.triangulation[i][2],n=this.triangulation[i][1],o=this.triangulation[i][3],l=this.triangulation[i][4]),this.swapTest(this.points[s].coords,this.points[r].coords,this.points[n].coords,this.points[a].coords)?(this.updateAdjacency(o,i,e),this.updateAdjacency(this.triangulation[e][5],e,i),this.triangulation[e][0]=a,this.triangulation[e][1]=s,this.triangulation[e][2]=n,this.triangulation[i][0]=a,this.triangulation[i][1]=n,this.triangulation[i][2]=r,this.triangulation[i][3]=e,this.triangulation[i][4]=l,this.triangulation[i][5]=this.triangulation[e][5],this.triangulation[e][4]=o,this.triangulation[e][5]=i,{t3:o,t4:l}):null}discardTrianglesWithSuperTriangleVertices(){for(let t=0;t<this.triangleCount;t++)(this.triangleContainsVertex(t,this.N)||this.triangleContainsVertex(t,this.N+1)||this.triangleContainsVertex(t,this.N+2))&&(this.skipTriangle[t]=!0)}swapTest(t,e,i,s){const r=t.x-i.x,n=e.x-i.x,a=t.y-i.y,o=e.y-i.y,l=t.x-s.x,h=e.x-s.x,c=t.y-s.y,u=e.y-s.y,d=r*n+a*o,p=h*l+u*c;return!(d>=0&&p>=0)&&(d<0&&p<0||(r*o-n*a)*p+(h*c-l*u)*d<0)}triangleContainsVertex(t,e){return this.triangulation[t][0]===e||this.triangulation[t][1]===e||this.triangulation[t][2]===e}updateAdjacency(t,e,i){if(t===er)return;const s=this.findSharedEdge(t,e);null!==s&&(this.triangulation[t][s]=i)}findSharedEdge(t,e){return t===er?null:this.triangulation[t][3]===e?3:this.triangulation[t][4]===e?4:this.triangulation[t][5]===e?5:null}}let sr=class{constructor(t,e,i,s,r,n,a,o,l,h){this.q1=t,this.q2=e,this.q3=i,this.q4=s,this.t1=r,this.t2=n,this.t1L=a,this.t1R=o,this.t2L=l,this.t2R=h}toString(){return`T${this.t1}/T${this.t2} (V${this.q1},V${this.q2},V${this.q3},V${this.q4})`}};class rr extends ir{edgeVertex1=[0,0,0,0,1,2];edgeVertex2=[0,0,0,1,2,0];oppositePoint=[0,0,0,2,0,1];nextEdge=[0,0,0,4,5,3];previousEdge=[0,0,0,5,3,4];constructor(t,e,i){super(t,i),this.constraints=e,this.vertexTriangles=[],this.visited=[]}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.constraints.length>0&&(this.applyConstraints(),this.discardTrianglesViolatingConstraints()),this.discardTrianglesWithSuperTriangleVertices();let t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||(t.push(this.triangulation[e][0]),t.push(this.triangulation[e][1]),t.push(this.triangulation[e][2]));return t}applyConstraints(){const t=this.triangulation.length;this.visited=new Array(t).fill(!1),this.vertexTriangles=new Array(this.N+3).fill(0);for(let e=0;e<t;e++)this.vertexTriangles[this.triangulation[e][0]]=e,this.vertexTriangles[this.triangulation[e][1]]=e,this.vertexTriangles[this.triangulation[e][2]]=e;for(let t of this.constraints){if(t.v1===t.v2)continue;const e=this.findIntersectingEdges(t,this.vertexTriangles);this.removeIntersectingEdges(t,e)}}findIntersectingEdges(t,e){const i=[],s=this.findStartingEdge(e,t);if(null===s)return i;i.push(s);let r=s.t1,n=s.t1Edge,a=r,o=!1;for(;!o;){a=r,r=this.triangulation[r][n];const e=this.points[t.v1].coords,s=this.points[t.v2].coords,h=this.points[this.triangulation[r][0]].coords,c=this.points[this.triangulation[r][1]].coords,u=this.points[this.triangulation[r][2]].coords;if(this.triangleContainsVertex(r,t.v2))o=!0;else if(this.triangulation[r][3]!==a&&Us(e,s,h,c)){n=3;var l=new Ks(this.triangulation[r][0],this.triangulation[r][1],r,this.triangulation[r][3],n);i.push(l)}else if(this.triangulation[r][4]!==a&&Us(e,s,c,u))n=4,l=new Ks(this.triangulation[r][1],this.triangulation[r][2],r,this.triangulation[r][4],n),i.push(l);else{if(this.triangulation[r][5]===a||!Us(e,s,u,h)){console.warn("Failed to find final triangle, exiting early.");break}n=5,l=new Ks(this.triangulation[r][2],this.triangulation[r][0],r,this.triangulation[r][5],n),i.push(l)}}return i}findStartingEdge(t,e){let i,s,r,n=new Ks(-1,-1),a=e.v1,o=t[a],l=!1,h=null;for(this.visited.fill(!1);!h&&!l;){if(this.visited[o]=!0,this.triangleContainsConstraint(o,e))return null;if(h=this.edgeConstraintIntersectsTriangle(o,e),h)break;if(i=this.triangulation[o][3],s=this.triangulation[o][4],r=this.triangulation[o][5],-1!==i&&!this.visited[i]&&this.triangleContainsVertex(i,a))o=i;else if(-1!==s&&!this.visited[s]&&this.triangleContainsVertex(s,a))o=s;else{if(-1===r||this.visited[r]||!this.triangleContainsVertex(r,a)){l=!0;break}o=r}}if(h){const t=this.triangulation[o][this.edgeVertex1[h]],e=this.triangulation[o][this.edgeVertex2[h]],i=this.triangulation[o][h];return n=new Ks(t,e,o,i,h),n}return null}removeIntersectingEdges(t,e){let i,s=[],r=0;for(;e.length>0&&r<=e.length;){if(i=e.shift(),null==i)continue;let n=this.findQuadFromSharedEdge(i.t1,i.t1Edge);if(n)if(Us(this.points[n.q4].coords,this.points[n.q3].coords,this.points[n.q1].coords,this.points[n.q2].coords)){this.swapQuadDiagonal(n,e,s,this.constraints);let i=new Ks(n.q3,n.q4,n.t1,n.t2,5);Us(this.points[t.v1].coords,this.points[t.v2].coords,this.points[n.q3].coords,this.points[n.q4].coords)?e.push(i):(r=0,s.push(i))}else e.push(i);r++}s.length>0&&this.restoreConstrainedDelauneyTriangulation(t,s)}restoreConstrainedDelauneyTriangulation(t,e){let i=!0;for(;i;){i=!1;for(let s=0;s<e.length;s++){const r=e[s];if(r.equals(t))continue;let n=this.findQuadFromSharedEdge(r.t1,r.t1Edge);if(n&&this.swapTest(this.points[n.q1].coords,this.points[n.q2].coords,this.points[n.q3].coords,this.points[n.q4].coords)){this.swapQuadDiagonal(n,e,this.constraints,null);const t=n.q3,r=n.q4;e[s]=new Ks(t,r,n.t1,n.t2,5),i=!0}}}}discardTrianglesViolatingConstraints(){this.skipTriangle.fill(!0);let t=new Set;for(let e=0;e<this.constraints.length;e++){const i=this.constraints[e];t.add(Hs(i.v1,i.v2))}this.visited.fill(!1);let e,i,s,r,n,a,o=[];for(let l=0;l<this.triangleCount;l++)if(!this.visited[l]&&(e=this.triangulation[l][0],i=this.triangulation[l][1],s=this.triangulation[l][2],r=t.has(Hs(e,i)),n=t.has(Hs(i,s)),a=t.has(Hs(s,e)),r||n||a))for(this.skipTriangle[l]=!1,o=[],r||o.push(this.triangulation[l][3]),n||o.push(this.triangulation[l][4]),a||o.push(this.triangulation[l][5]);o.length>0;){const r=o.shift();-1===r||this.visited[r]||(this.skipTriangle[r]=!1,this.visited[r]=!0,e=this.triangulation[r][0],i=this.triangulation[r][1],s=this.triangulation[r][2],t.has(Hs(e,i))||o.push(this.triangulation[r][3]),t.has(Hs(i,s))||o.push(this.triangulation[r][4]),t.has(Hs(s,e))||o.push(this.triangulation[r][5]))}}triangleContainsConstraint(t,e){return!(t>=this.triangulation.length||this.triangulation[t][0]!==e.v1&&this.triangulation[t][1]!==e.v1&&this.triangulation[t][2]!==e.v1||this.triangulation[t][0]!==e.v2&&this.triangulation[t][1]!==e.v2&&this.triangulation[t][2]!==e.v2)}edgeConstraintIntersectsTriangle(t,e){const i=this.points[e.v1].coords,s=this.points[e.v2].coords,r=this.points[this.triangulation[t][0]].coords,n=this.points[this.triangulation[t][1]].coords,a=this.points[this.triangulation[t][2]].coords;return Us(i,s,r,n)?3:Us(i,s,n,a)?4:Us(i,s,a,r)?5:null}findQuadFromSharedEdge(t,e){let i,s,r,n,a,o,l,h,c=this.triangulation[t][e],u=this.findSharedEdge(c,t);return u?(3===u?(s=this.triangulation[c][0],i=this.triangulation[c][1],r=this.triangulation[c][2]):4===u?(s=this.triangulation[c][1],i=this.triangulation[c][2],r=this.triangulation[c][0]):(s=this.triangulation[c][2],i=this.triangulation[c][0],r=this.triangulation[c][1]),n=this.triangulation[t][this.oppositePoint[e]],a=this.triangulation[t][this.previousEdge[e]],o=this.triangulation[t][this.nextEdge[e]],l=this.triangulation[c][this.nextEdge[u]],h=this.triangulation[c][this.previousEdge[u]],new sr(i,s,r,n,t,c,a,o,l,h)):null}swapQuadDiagonal(t,e,i,s){const r=t.t1,n=t.t2,a=t.t1R,o=t.t1L,l=t.t2R,h=t.t2L;this.triangulation[r][0]=t.q4,this.triangulation[r][1]=t.q1,this.triangulation[r][2]=t.q3,this.triangulation[n][0]=t.q4,this.triangulation[n][1]=t.q3,this.triangulation[n][2]=t.q2,this.triangulation[r][3]=o,this.triangulation[r][4]=h,this.triangulation[r][5]=n,this.triangulation[n][3]=r,this.triangulation[n][4]=l,this.triangulation[n][5]=a,this.updateAdjacency(h,n,r),this.updateAdjacency(a,r,n),this.updateEdgesAfterSwap(e,r,n,o,a,h,l),this.updateEdgesAfterSwap(i,r,n,o,a,h,l),this.updateEdgesAfterSwap(s,r,n,o,a,h,l),this.vertexTriangles[t.q1]=r,this.vertexTriangles[t.q2]=n}updateEdgesAfterSwap(t,e,i,s,r,n,a){if(t)for(let o of t)o.t1===e&&o.t2===r?(o.t1=i,o.t2=r,o.t1Edge=5):o.t1===e&&o.t2===s?o.t1Edge=3:o.t1===r&&o.t2===e?o.t2=i:o.t1===s&&o.t2===e||(o.t1===i&&o.t2===a?o.t1Edge=4:o.t1===i&&o.t2===n?(o.t1=e,o.t2=n,o.t1Edge=4):o.t1===a&&o.t2===i||o.t1===n&&o.t2===i&&(o.t2=e))}}function nr(t,e,i,s,r,n,a=!0){const o=new Js,l=new Js,h=new Array(t.vertexCount).fill(!1);for(let s=0;s<t.vertices.length;s++){var c=t.vertices[s];h[s]=Qs(c.position,e,i),(h[s]?o:l).addMappedVertex(c,s)}const u=t.vertices.length;for(let s=0;s<t.cutVertices.length;s++)c=t.cutVertices[s],h[s+u]=Qs(c.position,e,i),(h[s+u]?o:l).addMappedVertex(c,s+u);return ar(t,o,l,e,i,h,0),a&&ar(t,o,l,e,i,h,1),a&&function(t,e,i,s,r,n){t.weldCutFaceVertices();const a=i.clone().negate().normalize();if(t.cutVertices.length<3)return;const o=n?new ir(t.cutVertices,a):new rr(t.cutVertices,t.constraints,a),l=o.triangulate();for(let n=0;n<t.cutVertices.length;n++){var h=t.cutVertices[n],c=o.points[n];const l=new z(o.normalizationScaleFactor*c.coords.x*s.x+r.x,o.normalizationScaleFactor*c.coords.y*s.y+r.y),u=new Ys(h.position.clone(),a.clone(),l.clone()),d=new Ys(h.position.clone(),i.clone(),l.clone());t.cutVertices[n]=u,e.cutVertices[n]=d}let u=t.vertices.length,d=e.vertices.length;for(let i=0;i<l.length;i+=3)t.addTriangle(u+l[i],u+l[i+1],u+l[i+2],1),e.addTriangle(d+l[i],d+l[i+2],d+l[i+1],1)}(o,l,e,s,r,n),{topSlice:o,bottomSlice:l}}function ar(t,e,i,s,r,n,a){const o=t.triangles[a];let l,h,c;for(let u=0;u<o.length;u+=3)l=o[u],h=o[u+1],c=o[u+2],n[l]&&n[h]&&n[c]?e.addMappedTriangle(l,h,c,a):n[l]||n[h]||n[c]?n[h]&&n[c]&&!n[l]?or(h,c,l,s,r,t,e,i,a,!0):n[c]&&n[l]&&!n[h]?or(c,l,h,s,r,t,e,i,a,!0):n[l]&&n[h]&&!n[c]?or(l,h,c,s,r,t,e,i,a,!0):n[h]||n[c]||!n[l]?n[c]||n[l]||!n[h]?n[l]||n[h]||!n[c]||or(l,h,c,s,r,t,e,i,a,!1):or(c,l,h,s,r,t,e,i,a,!1):or(h,c,l,s,r,t,e,i,a,!1):i.addMappedTriangle(l,h,c,a)}function or(t,e,i,s,r,n,a,o,l,h){let c=t<n.vertices.length?n.vertices[t]:n.cutVertices[t-n.vertices.length],u=e<n.vertices.length?n.vertices[e]:n.cutVertices[e-n.vertices.length],d=i<n.vertices.length?n.vertices[i]:n.cutVertices[i-n.vertices.length];const p=Vs(c.position,d.position,s,r),m=Vs(u.position,d.position,s,r);if(p&&m){const s=new nt(c.normal.x+p.s*(d.normal.x-c.normal.x),c.normal.y+p.s*(d.normal.y-c.normal.y),c.normal.z+p.s*(d.normal.z-c.normal.z)).normalize(),r=new nt(u.normal.x+m.s*(d.normal.x-u.normal.x),u.normal.y+m.s*(d.normal.y-u.normal.y),u.normal.z+m.s*(d.normal.z-u.normal.z)).normalize(),n=new z(c.uv.x+p.s*(d.uv.x-c.uv.x),c.uv.y+p.s*(d.uv.y-c.uv.y)),f=new z(u.uv.x+m.s*(d.uv.x-u.uv.x),u.uv.y+m.s*(d.uv.y-u.uv.y));a.addCutFaceVertex(p.x,s,n),a.addCutFaceVertex(m.x,r,f),o.addCutFaceVertex(p.x,s,n),o.addCutFaceVertex(m.x,r,f);const g=a.vertices.length-2,y=a.vertices.length-1,v=o.vertices.length-2,w=o.vertices.length-1;h?(a.addTriangle(y,g,a.indexMap[e],l),a.addTriangle(g,a.indexMap[t],a.indexMap[e],l),o.addTriangle(o.indexMap[i],v,w,l),a.constraints.push(new Ks(a.cutVertices.length-2,a.cutVertices.length-1)),o.constraints.push(new Ks(o.cutVertices.length-1,o.cutVertices.length-2))):(a.addTriangle(g,y,a.indexMap[i],l),o.addTriangle(o.indexMap[t],o.indexMap[e],v,l),o.addTriangle(o.indexMap[e],w,v,l),a.constraints.push(new Ks(a.cutVertices.length-1,a.cutVertices.length-2)),o.constraints.push(new Ks(o.cutVertices.length-2,o.cutVertices.length-1)))}}const lr={textureScale:new z(1,1),textureOffset:new z},hr=new nt,cr=new nt,ur=new nt,dr=new pt,pr=new pt;function mr(t){const e=new Zs(t.vertexCount),i={},s=t.vertices.length,r=t.cutVertices.length,n=new Map;t.vertices.forEach(((t,i)=>{const s=Xs(t.position),r=n.get(s);void 0===r?n.set(s,i):e.union(r,i)}));for(let i=0;i<r;i++)e.union(t.vertexAdjacency[i],i+s);const a=t.triangles;for(let t=0;t<a.length;t++)for(let s=0;s<a[t].length;s+=3){const r=a[t][s],n=a[t][s+1],o=a[t][s+2];e.union(r,n),e.union(n,o);const l=e.find(r);i[l]||(i[l]=[[],[]]),i[l][t].push(r,n,o)}const o={},l=Array(t.vertexCount);for(let i=0;i<s;i++){const s=e.find(i);o[s]||(o[s]=new Js),o[s].vertices.push(t.vertices[i]),l[i]=o[s].vertices.length-1}for(let i=0;i<r;i++){const r=e.find(i+s);o[r].cutVertices.push(t.cutVertices[i]),l[i+s]=o[r].vertices.length+o[r].cutVertices.length-1}for(const s of Object.keys(i)){let r=Number(s),n=e.parent[r];for(let e=0;e<t.triangles.length;e++)for(const t of i[r][e]){const i=l[t];o[n].triangles[e].push(i)}}return Object.values(o)}class fr{constructor(t){this.motor=t,this.tpos=new nt,this.tnormal=new nt,this.nDebris=0,this.maxDebris=1500,this.interneMat=this.motor.getMat("chrome"),this.tt=null}add(t,e=[]){let i=this,s=0;-1!==t.name.search("_debris_")&&(s=1e3),setTimeout((()=>{i.motor.addCollision({name:t.name,ignore:t.ignore}),t.addEventListener("collision",(t=>{let e=t.data;1===e.hit&&i.makeBreak(e.from,e.point,e.normal,e.impulse,e.v1)}))}),s)}makeBreak(t,e,i,s,r){let n=this.motor.byName(t);if(!n)return;if(!n.breakable)return;let a=n.breakOption;const o=void 0===a[4]||a[4];if(s<a[0])return;this.motor.removeCollision(t),this.motor.remove(t);const l=new nt;n.geometry.boundingBox.getSize(l);const h=l.length();let c=function(t,e,i,s,r,n){const a=[],o=t.matrixWorld.clone().invert(),l=t.position;e.applyMatrix4(o);const h=Js.fromGeometry(t.geometry);let c=h.convex;hr.addVectors(e,i),dr.setFromCoplanarPoints(e,l,hr);const u=r+s;return function t(r,h,d,p){if(0===r.vertexCount)return;if(Math.random()<.05*p||p>u)return void a.push(r);let m=Math.PI,f=new nt;r.calculateBounds(),r.bounds.getCenter(f);let g=c;if(0===p)pr.normal.copy(dr.normal),pr.constant=dr.constant;else if(p<=s)m=(d-h)*(.2+.6*Math.random())+h,cr.copy(l).sub(e).applyAxisAngle(i,m).add(e),pr.setFromCoplanarPoints(e,hr,cr);else{let t=f.clone().applyMatrix4(o);m=(.5*(1&p)+.2*(2-Math.random()))*Math.PI,cr.copy(e).sub(t).applyAxisAngle(i,m).add(t),ur.copy(i).add(t),pr.setFromCoplanarPoints(t,ur,cr)}const{topSlice:y,bottomSlice:v}=nr(r,pr.normal,cr,lr.textureScale,lr.textureOffset,g,n);let w=y,b=v;g||(w=mr(y),b=mr(v)),w&&(w instanceof Array?w.length>0&&w.forEach((e=>{e.vertices.length>12&&t(e,h,m,p+1)})):t(w,h,m,p+1)),b&&(b instanceof Array?b.length>0&&b.forEach((e=>{e.vertices.length>12&&t(e,h,m,p+1)})):t(v,m,d,p+1))}(h,0,2*Math.PI,0),a}(n,this.tpos.fromArray(e),this.tnormal.fromArray(i),a[1],a[2],o),u=function(t,e,i,s=!0,r=0){const n=[];return t.map(((t,a)=>{n.push(t.toMesh(e,i,s,r))})),n}(c,n,this.interneMat,o,0);if(u.length<1)return;let d,p,m,f,g,y=[],v=u.length,w=0,b=[...n.ignore];for(;v--;)d=u[w],p=d.geometry.attributes.position.count,m=d.sizer/h,f={},g=[...a],g[3]=g[3]-1,m<.2&&(g[3]=0),d.sizer>.02&&p>6&&(this.nDebris++,f.name=t+"_debris_"+w,f.mass=n.mass*m,y.push(this.addDebris(d,g,f)),b.push(f.name)),w++;for(v=y.length;v--;)y[v].ignore=b;this.motor.add(y)}addDebris(t,e,i){let s=e[3]>0;return{...i,type:"convex",shape:t.geometry,material:t.material,pos:t.position.toArray(),quat:t.quaternion.toArray(),breakable:s,breakOption:e}}}const gr=new nt;new nt;const yr=new nt,vr=new nt,wr=new nt,br=new nt,xr=new nt;class Mr{constructor(t={},e){this.first=!0,this.debug=t.debug||!1,this.motor=e,this.name=t.name||"ppp",this.pMass=t.pMass||.01,this.vSize=t.vSize||.16,this.pSize=t.pSize||.02,this.particles=[],this.density=t.density||.01,this.smoothMulty=t.smoothMulty||1,this.smoothing=t.smoothing||.2,this.smoothing*=this.smoothMulty,this.speed=t.speed||.1,this.viscosity=t.viscosity||.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.maxDist=0,this.tv=new nt,this.tv2=new nt,t.mesh&&this.setMesh(t.mesh,t.crossEdge)}setMesh(t,e=!1){const i=[],s=[];this.mesh=t,this.geometry=t.geometry,this.geometry.getIndex();const r=this.geometry.getAttribute("position").array,n=xe.getHash(this.geometry),a=xe.getFaces(this.geometry),o=e?xe.getConnectedFaces(a):null;let l,h,c,u,d,p;for(let t in n)l=n[t][0],h=3*l,gr.set(r[h],r[h+1],r[h+2]),this.mesh.localToWorld(gr),this.add(gr.toArray());for(let t=0;t<a.length;t++)c=a[t],u=this.getKey(n,c[0]),d=this.getKey(n,c[1]),p=this.getKey(n,c[2]),this.sameLink(i,u,d)||i.push([u,d]),this.sameLink(i,d,p)||i.push([d,p]),this.sameLink(i,p,u)||i.push([p,u]);if(this.connect(i),o){for(let t=0;t<o.length;t++)c=o[t],u=this.getKey(n,c[0]),d=this.getKey(n,c[1]),this.sameLink(i,u,d)||this.sameLink(s,u,d)||s.push([u,d]);this.connect(s,!0)}this.hash=n,this.mesh.position.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,phy.addDirect(this.mesh)}updateMesh(){if(!this.geometry)return;let t,e,i,s=this.hash,r=this.geometry.attributes.position.array,n=this.particles.length;for(;n--;)for(e=this.particles[n],i=s[n].length;i--;)t=3*s[n][i],r[t]=e.position.x,r[t+1]=e.position.y,r[t+2]=e.position.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.computeBoundingSphere()}add(t){let e=this.motor.add({instance:this.name,type:"particle",size:[this.vSize],pSize:this.pSize,pos:t,inertia:[0,0,0],mass:this.pMass,restitution:0,friction:.5,damping:[.2,.1],material:this.debug?"particle":"hide",shadow:!1,getVelocity:!0});this.first=!1,e.force=new nt,this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(t,e){let i,s,r,n=t.length,a=[],o=0;for(;n--;){if(i=t[n],this.name,i[0],this.name,i[1],s=this.particles[i[0]].position,r=this.particles[i[1]].position,o=this.tv.copy(s).distanceTo(r),e){if(o>this.maxDist)continue}else o>this.maxDist&&(this.maxDist=o);this.tv.copy(r).sub(s),a.push({type:"distance",helperSize:.03,b1:this.name+i[0],b2:this.name+i[1],limit:[.5*o,o],spring:[20,1],collision:!0,noPreProcess:!0,alway:!0})}this.motor.add(a)}getPosition(){let t,e,i=[],s=this.particles.length;for(;s--;)e=3*s,t=this.particles[s],i[e]=t.position.x,i[e+1]=t.position.y,i[e+2]=t.position.z;return i}getNeighbors(t,e){const i=this.particles.length,s=t.idx,r=this.smoothing*this.smoothing;let n=0;for(let a=0;a!==i;a++){const i=this.particles[a];n=this.distanceSq(i,t),s!==i.idx&&n<r&&e.push(i)}}distance(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,r=t.position.z-e.position.z;return Math.sqrt(i*i+s*s+r*r)}distanceSq(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,r=t.position.z-e.position.z;return i*i+s*s+r*r}w(t){const e=this.smoothing;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)}gradw(t,e){const i=t.length(),s=this.smoothing,r=945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-i*i,2);e.copy(t).multiplyScalar(r)}nablaw(t){const e=this.smoothing;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}getKey(t,e){let i;for(let s in t)if(i=t[s],-1!==i.indexOf(e))return s}sameLink(t,e,i){let s,r=t.length,n=!1;for(;r--;)s=t[r],e===i&&(n=!0),e===s[0]&&i===s[1]&&(n=!0),e===s[1]&&i===s[0]&&(n=!0);return n}update(){const t=[],e=this.particles.length,i=this.speed,s=this.eps;let r;for(let t=0;t!==e;t++){const e=this.particles[t];e.force.set(0,0,0);const s=this.neighbors[t];s.length=0,this.getNeighbors(e,s),s.push(this.particles[t]);let n=0;for(r=s.length;r--;){const t=this.w(this.distance(e,s[r]));n+=s[r].mass*t}this.densities[t]=n,this.pressures[t]=i*i*(this.densities[t]-this.density)}const n=yr,a=vr,o=wr,l=br,h=xr;let c,u;for(let i=0;i!==e;i++){const e=this.particles[i];let r,d;n.set(0,0,0),a.set(0,0,0);const p=this.neighbors[i],m=p.length;for(let t=0;t!==m;t++)c=p[t],l.copy(e.position).sub(c.position),u=l.length(),r=-c.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+s)+this.pressures[t]/(this.densities[t]*this.densities[t]+s)),this.gradw(l,o),o.multiplyScalar(r),n.add(o),h.copy(c.velocity).sub(e.velocity),h.multiplyScalar(1/(1e-4+this.densities[i]*this.densities[t])*this.viscosity*c.mass),d=this.nablaw(u),h.multiplyScalar(d),a.add(h);a.multiplyScalar(e.mass),n.multiplyScalar(e.mass),e.force.add(a),e.force.add(n),t.push({name:e.name,force:e.force.toArray()})}this.motor.change(t),this.updateMesh()}}class kr extends Dt{constructor(t){super(t),this.type=Ft}parse(t){const e=function(t,e){switch(t){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(e||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(e||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(e||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(e||""))}},i=function(t,e,i){e=e||1024;let s=t.pos,r=-1,n=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));for(;0>(r=o.indexOf("\n"))&&n<e&&s<t.byteLength;)a+=o,n+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));return-1<r&&(t.pos+=n+r+1,a+o.slice(0,r))},s=function(t,e,i,s){const r=t[e+3],n=Math.pow(2,r-128)/255;i[s+0]=t[e+0]*n,i[s+1]=t[e+1]*n,i[s+2]=t[e+2]*n,i[s+3]=1},r=function(t,e,i,s){const r=t[e+3],n=Math.pow(2,r-128)/255;i[s+0]=Nt.toHalfFloat(Math.min(t[e+0]*n,65504)),i[s+1]=Nt.toHalfFloat(Math.min(t[e+1]*n,65504)),i[s+2]=Nt.toHalfFloat(Math.min(t[e+2]*n,65504)),i[s+3]=Nt.toHalfFloat(1)},n=new Uint8Array(t);n.pos=0;const a=function(t){const s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((t.pos>=t.byteLength||!(l=i(t)))&&e(1,"no header found"),(h=l.match(/^#\?(\S+)/))||e(3,"bad initial token"),o.valid|=1,o.programtype=h[1],o.string+=l+"\n";l=i(t),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(s))&&(o.gamma=parseFloat(h[1])),(h=l.match(r))&&(o.exposure=parseFloat(h[1])),(h=l.match(n))&&(o.valid|=2,o.format=h[1]),(h=l.match(a))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||e(3,"missing format specifier"),4&o.valid||e(3,"missing image size specifier"),o}(n),o=a.width,l=a.height,h=function(t,i,s){const r=i;if(r<8||r>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);r!==(t[2]<<8|t[3])&&e(3,"wrong scanline width");const n=new Uint8Array(4*i*s);n.length||e(4,"unable to allocate buffer space");let a=0,o=0;const l=4*r,h=new Uint8Array(4),c=new Uint8Array(l);let u=s;for(;u>0&&o<t.byteLength;){o+4>t.byteLength&&e(1),h[0]=t[o++],h[1]=t[o++],h[2]=t[o++],h[3]=t[o++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==r||e(3,"bad rgbe scanline format");let i,s=0;for(;s<l&&o<t.byteLength;){i=t[o++];const r=i>128;if(r&&(i-=128),(0===i||s+i>l)&&e(3,"bad scanline data"),r){const e=t[o++];for(let t=0;t<i;t++)c[s++]=e}else c.set(t.subarray(o,o+i),s),s+=i,o+=i}const d=r;for(let t=0;t<d;t++){let e=0;n[a]=c[t+e],e+=r,n[a+1]=c[t+e],e+=r,n[a+2]=c[t+e],e+=r,n[a+3]=c[t+e],a+=4}u--}return n}(n.subarray(n.pos),o,l);let c,u,d;switch(this.type){case Bt:d=h.length/4;const t=new Float32Array(4*d);for(let e=0;e<d;e++)s(h,4*e,t,4*e);c=t,u=Bt;break;case Ft:d=h.length/4;const e=new Uint16Array(4*d);for(let t=0;t<d;t++)r(h,4*t,e,4*t);c=e,u=Ft;break;default:throw new Error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:o,height:l,data:c,header:a.string,gamma:a.gamma,exposure:a.exposure,type:u}}setDataType(t){return this.type=t,this}load(t,e,i,r){return super.load(t,(function(t,i){switch(t.type){case Bt:case Ft:t.colorSpace=s,t.minFilter=Ut,t.magFilter=Ut,t.generateMipmaps=!1,t.flipY=!0}e&&e(t,i)}),i,r)}}
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/var Sr=function(t){return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};try{URL.revokeObjectURL(Sr(""))}catch(t){Sr=function(t){return"data:application/javascript;charset=UTF-8,"+encodeURI(t)}}var Ar=Uint8Array,Tr=Uint16Array,zr=Uint32Array,Pr=new Ar([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Cr=new Ar([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Rr=new Ar([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Er=function(t,e){for(var i=new Tr(31),s=0;s<31;++s)i[s]=e+=1<<t[s-1];var r=new zr(i[30]);for(s=1;s<30;++s)for(var n=i[s];n<i[s+1];++n)r[n]=n-i[s]<<5|s;return[i,r]},_r=Er(Pr,2),Lr=_r[0],Ir=_r[1];Lr[28]=258,Ir[258]=28;for(var Or=Er(Cr,0)[0],Dr=new Tr(32768),Fr=0;Fr<32768;++Fr){var Br=(43690&Fr)>>>1|(21845&Fr)<<1;Br=(61680&(Br=(52428&Br)>>>2|(13107&Br)<<2))>>>4|(3855&Br)<<4,Dr[Fr]=((65280&Br)>>>8|(255&Br)<<8)>>>1}var Nr=function(t,e,i){for(var s=t.length,r=0,n=new Tr(e);r<s;++r)++n[t[r]-1];var a,o=new Tr(e);for(r=0;r<e;++r)o[r]=o[r-1]+n[r-1]<<1;if(i){a=new Tr(1<<e);var l=15-e;for(r=0;r<s;++r)if(t[r])for(var h=r<<4|t[r],c=e-t[r],u=o[t[r]-1]++<<c,d=u|(1<<c)-1;u<=d;++u)a[Dr[u]>>>l]=h}else for(a=new Tr(s),r=0;r<s;++r)t[r]&&(a[r]=Dr[o[t[r]-1]++]>>>15-t[r]);return a},Ur=new Ar(288);for(Fr=0;Fr<144;++Fr)Ur[Fr]=8;for(Fr=144;Fr<256;++Fr)Ur[Fr]=9;for(Fr=256;Fr<280;++Fr)Ur[Fr]=7;for(Fr=280;Fr<288;++Fr)Ur[Fr]=8;var Vr=new Ar(32);for(Fr=0;Fr<32;++Fr)Vr[Fr]=5;var qr=Nr(Ur,9,1),Wr=Nr(Vr,5,1),jr=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},Hr=function(t,e,i){var s=e/8|0;return(t[s]|t[s+1]<<8)>>(7&e)&i},Gr=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(7&e)},Xr=function(t){return(t/8|0)+(7&t&&1)},Qr=function(t,e,i){var s=t.length;if(!s||i&&!i.l&&s<5)return e||new Ar(0);var r=!e||i,n=!i||i.i;i||(i={}),e||(e=new Ar(3*s));var a=function(t){var i=e.length;if(t>i){var s=new Ar(Math.max(2*i,t));s.set(e),e=s}},o=i.f||0,l=i.p||0,h=i.b||0,c=i.l,u=i.d,d=i.m,p=i.n,m=8*s;do{if(!c){i.f=o=Hr(t,l,1);var f=Hr(t,l+1,3);if(l+=3,!f){var g=t[(z=Xr(l)+4)-4]|t[z-3]<<8,y=z+g;if(y>s){if(n)throw"unexpected EOF";break}r&&a(h+g),e.set(t.subarray(z,y),h),i.b=h+=g,i.p=l=8*y;continue}if(1==f)c=qr,u=Wr,d=9,p=5;else{if(2!=f)throw"invalid block type";var v=Hr(t,l,31)+257,w=Hr(t,l+10,15)+4,b=v+Hr(t,l+5,31)+1;l+=14;for(var x=new Ar(b),M=new Ar(19),k=0;k<w;++k)M[Rr[k]]=Hr(t,l+3*k,7);l+=3*w;var S=jr(M),A=(1<<S)-1,T=Nr(M,S,1);for(k=0;k<b;){var z,P=T[Hr(t,l,A)];if(l+=15&P,(z=P>>>4)<16)x[k++]=z;else{var C=0,R=0;for(16==z?(R=3+Hr(t,l,3),l+=2,C=x[k-1]):17==z?(R=3+Hr(t,l,7),l+=3):18==z&&(R=11+Hr(t,l,127),l+=7);R--;)x[k++]=C}}var E=x.subarray(0,v),_=x.subarray(v);d=jr(E),p=jr(_),c=Nr(E,d,1),u=Nr(_,p,1)}if(l>m){if(n)throw"unexpected EOF";break}}r&&a(h+131072);for(var L=(1<<d)-1,I=(1<<p)-1,O=l;;O=l){var D=(C=c[Gr(t,l)&L])>>>4;if((l+=15&C)>m){if(n)throw"unexpected EOF";break}if(!C)throw"invalid length/literal";if(D<256)e[h++]=D;else{if(256==D){O=l,c=null;break}var F=D-254;if(D>264){var B=Pr[k=D-257];F=Hr(t,l,(1<<B)-1)+Lr[k],l+=B}var N=u[Gr(t,l)&I],U=N>>>4;if(!N)throw"invalid distance";l+=15&N;_=Or[U];if(U>3){B=Cr[U];_+=Gr(t,l)&(1<<B)-1,l+=B}if(l>m){if(n)throw"unexpected EOF";break}r&&a(h+131072);for(var V=h+F;h<V;h+=4)e[h]=e[h-_],e[h+1]=e[h+1-_],e[h+2]=e[h+2-_],e[h+3]=e[h+3-_];h=V}}i.l=c,i.p=O,i.b=h,c&&(o=1,i.m=d,i.d=u,i.n=p)}while(!o);return h==e.length?e:function(t,e,i){(null==i||i>t.length)&&(i=t.length);var s=new(t instanceof Tr?Tr:t instanceof zr?zr:Ar)(i-e);return s.set(t.subarray(e,i)),s}(e,0,h)},Yr=new Ar(0);function Jr(t,e){return Qr((function(t){if(8!=(15&t[0])||t[0]>>>4>7||(t[0]<<8|t[1])%31)throw"invalid zlib data";if(32&t[1])throw"invalid zlib data: preset dictionaries not supported"}(t),t.subarray(2,-4)),e)}var Zr="undefined"!=typeof TextDecoder&&new TextDecoder;try{Zr.decode(Yr,{stream:!0})}catch(t){}class Kr extends Dt{constructor(t){super(t),this.type=Ft}parse(t){const e=65536,i=14,r=65537,n=16384,a=Math.pow(2.7182818,2.2);const o={l:0,c:0,lc:0};function l(t,e,i,s,r){for(;i<t;)e=e<<8|q(s,r),i+=8;i-=t,o.l=e>>i&(1<<t)-1,o.c=e,o.lc=i}const h=new Array(59);function c(t,e,i,s,n,a){const c=e;let u=0,d=0;for(;s<=n;s++){if(c.value-e.value>i)return!1;l(6,u,d,t,c);const r=o.l;if(u=o.c,d=o.lc,a[s]=r,63==r){if(c.value-e.value>i)throw new Error("Something wrong with hufUnpackEncTable");l(8,u,d,t,c);let r=o.l+6;if(u=o.c,d=o.lc,s+r>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;r--;)a[s++]=0;s--}else if(r>=59){let t=r-59+2;if(s+t>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;t--;)a[s++]=0;s--}}!function(t){for(let t=0;t<=58;++t)h[t]=0;for(let e=0;e<r;++e)h[t[e]]+=1;let e=0;for(let t=58;t>0;--t){const i=e+h[t]>>1;h[t]=e,e=i}for(let e=0;e<r;++e){const i=t[e];i>0&&(t[e]=i|h[i]++<<6)}}(a)}function u(t){return 63&t}function d(t){return t>>6}const p={c:0,lc:0};function m(t,e,i,s){t=t<<8|q(i,s),e+=8,p.c=t,p.lc=e}const f={c:0,lc:0};function g(t,e,i,s,r,n,a,o,l){if(t==e){s<8&&(m(i,s,r,n),i=p.c,s=p.lc);let t=i>>(s-=8);if(t=new Uint8Array([t])[0],o.value+t>l)return!1;const e=a[o.value-1];for(;t-- >0;)a[o.value++]=e}else{if(!(o.value<l))return!1;a[o.value++]=t}f.c=i,f.lc=s}function y(t){return 65535&t}function v(t){const e=y(t);return e>32767?e-65536:e}const w={a:0,b:0};function b(t,e){const i=v(t),s=v(e),r=i+(1&s)+(s>>1),n=r,a=r-s;w.a=n,w.b=a}function x(t,e){const i=y(t),s=y(e),r=i-(s>>1)&65535,n=s+r-32768&65535;w.a=n,w.b=r}function M(t,e,i,s,r,n,a){const o=a<16384,l=i>r?r:i;let h,c,u=1;for(;u<=l;)u<<=1;for(u>>=1,h=u,u>>=1;u>=1;){c=0;const a=c+n*(r-h),l=n*u,d=n*h,p=s*u,m=s*h;let f,g,y,v;for(;c<=a;c+=d){let r=c;const n=c+s*(i-h);for(;r<=n;r+=m){const i=r+p,s=r+l,n=s+p;o?(b(t[r+e],t[s+e]),f=w.a,y=w.b,b(t[i+e],t[n+e]),g=w.a,v=w.b,b(f,g),t[r+e]=w.a,t[i+e]=w.b,b(y,v),t[s+e]=w.a,t[n+e]=w.b):(x(t[r+e],t[s+e]),f=w.a,y=w.b,x(t[i+e],t[n+e]),g=w.a,v=w.b,x(f,g),t[r+e]=w.a,t[i+e]=w.b,x(y,v),t[s+e]=w.a,t[n+e]=w.b)}if(i&u){const i=r+l;o?b(t[r+e],t[i+e]):x(t[r+e],t[i+e]),f=w.a,t[i+e]=w.b,t[r+e]=f}}if(r&u){let r=c;const n=c+s*(i-h);for(;r<=n;r+=m){const i=r+p;o?b(t[r+e],t[i+e]):x(t[r+e],t[i+e]),f=w.a,t[i+e]=w.b,t[r+e]=f}}h=u,u>>=1}return c}function k(t,e,s,a,o,l){const h=s.value,y=V(e,s),v=V(e,s);s.value+=4;const w=V(e,s);if(s.value+=4,y<0||y>=r||v<0||v>=r)throw new Error("Something wrong with HUF_ENCSIZE");const b=new Array(r),x=new Array(n);!function(t){for(let e=0;e<n;e++)t[e]={},t[e].len=0,t[e].lit=0,t[e].p=null}(x);if(c(t,s,a-(s.value-h),y,v,b),w>8*(a-(s.value-h)))throw new Error("Something wrong with hufUncompress");!function(t,e,s,r){for(;e<=s;e++){const s=d(t[e]),n=u(t[e]);if(s>>n)throw new Error("Invalid table entry");if(n>i){const t=r[s>>n-i];if(t.len)throw new Error("Invalid table entry");if(t.lit++,t.p){const e=t.p;t.p=new Array(t.lit);for(let i=0;i<t.lit-1;++i)t.p[i]=e[i]}else t.p=new Array(1);t.p[t.lit-1]=e}else if(n){let t=0;for(let a=1<<i-n;a>0;a--){const a=r[(s<<i-n)+t];if(a.len||a.p)throw new Error("Invalid table entry");a.len=n,a.lit=e,t++}}}}(b,y,v,x),function(t,e,s,r,n,a,o,l,h){let c=0,y=0;const v=o,w=Math.trunc(r.value+(n+7)/8);for(;r.value<w;)for(m(c,y,s,r),c=p.c,y=p.lc;y>=i;){const n=e[c>>y-i&16383];if(n.len)y-=n.len,g(n.lit,a,c,y,s,r,l,h,v),c=f.c,y=f.lc;else{if(!n.p)throw new Error("hufDecode issues");let e;for(e=0;e<n.lit;e++){const i=u(t[n.p[e]]);for(;y<i&&r.value<w;)m(c,y,s,r),c=p.c,y=p.lc;if(y>=i&&d(t[n.p[e]])==(c>>y-i&(1<<i)-1)){y-=i,g(n.p[e],a,c,y,s,r,l,h,v),c=f.c,y=f.lc;break}}if(e==n.lit)throw new Error("hufDecode issues")}}const b=8-n&7;for(c>>=b,y-=b;y>0;){const t=e[c<<i-y&16383];if(!t.len)throw new Error("hufDecode issues");y-=t.len,g(t.lit,a,c,y,s,r,l,h,v),c=f.c,y=f.lc}}(b,x,t,s,w,v,l,o,{value:0})}function S(t){for(let e=1;e<t.length;e++){const i=t[e-1]+t[e]-128;t[e]=i}}function A(t,e){let i=0,s=Math.floor((t.length+1)/2),r=0;const n=t.length-1;for(;!(r>n||(e[r++]=t[i++],r>n));)e[r++]=t[s++]}function T(t){let e=t.byteLength;const i=new Array;let s=0;const r=new DataView(t);for(;e>0;){const t=r.getInt8(s++);if(t<0){const n=-t;e-=n+1;for(let t=0;t<n;t++)i.push(r.getUint8(s++))}else{const n=t;e-=2;const a=r.getUint8(s++);for(let t=0;t<n+1;t++)i.push(a)}}return i}function z(t,e,i){let s,r=1;for(;r<64;)s=e[t.value],65280==s?r=64:s>>8==255?r+=255&s:(i[r]=s,r++),t.value++}function P(t,e){e[0]=X(t[0]),e[1]=X(t[1]),e[2]=X(t[5]),e[3]=X(t[6]),e[4]=X(t[14]),e[5]=X(t[15]),e[6]=X(t[27]),e[7]=X(t[28]),e[8]=X(t[2]),e[9]=X(t[4]),e[10]=X(t[7]),e[11]=X(t[13]),e[12]=X(t[16]),e[13]=X(t[26]),e[14]=X(t[29]),e[15]=X(t[42]),e[16]=X(t[3]),e[17]=X(t[8]),e[18]=X(t[12]),e[19]=X(t[17]),e[20]=X(t[25]),e[21]=X(t[30]),e[22]=X(t[41]),e[23]=X(t[43]),e[24]=X(t[9]),e[25]=X(t[11]),e[26]=X(t[18]),e[27]=X(t[24]),e[28]=X(t[31]),e[29]=X(t[40]),e[30]=X(t[44]),e[31]=X(t[53]),e[32]=X(t[10]),e[33]=X(t[19]),e[34]=X(t[23]),e[35]=X(t[32]),e[36]=X(t[39]),e[37]=X(t[45]),e[38]=X(t[52]),e[39]=X(t[54]),e[40]=X(t[20]),e[41]=X(t[22]),e[42]=X(t[33]),e[43]=X(t[38]),e[44]=X(t[46]),e[45]=X(t[51]),e[46]=X(t[55]),e[47]=X(t[60]),e[48]=X(t[21]),e[49]=X(t[34]),e[50]=X(t[37]),e[51]=X(t[47]),e[52]=X(t[50]),e[53]=X(t[56]),e[54]=X(t[59]),e[55]=X(t[61]),e[56]=X(t[35]),e[57]=X(t[36]),e[58]=X(t[48]),e[59]=X(t[49]),e[60]=X(t[57]),e[61]=X(t[58]),e[62]=X(t[62]),e[63]=X(t[63])}function C(t){const e=.5*Math.cos(.7853975),i=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),r=.5*Math.cos(3*3.14159/16),n=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),u=new Array(4);for(let d=0;d<8;++d){const p=8*d;l[0]=s*t[p+2],l[1]=a*t[p+2],l[2]=s*t[p+6],l[3]=a*t[p+6],h[0]=i*t[p+1]+r*t[p+3]+n*t[p+5]+o*t[p+7],h[1]=r*t[p+1]-o*t[p+3]-i*t[p+5]-n*t[p+7],h[2]=n*t[p+1]-i*t[p+3]+o*t[p+5]+r*t[p+7],h[3]=o*t[p+1]-n*t[p+3]+r*t[p+5]-i*t[p+7],c[0]=e*(t[p+0]+t[p+4]),c[3]=e*(t[p+0]-t[p+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],t[p+0]=u[0]+h[0],t[p+1]=u[1]+h[1],t[p+2]=u[2]+h[2],t[p+3]=u[3]+h[3],t[p+4]=u[3]-h[3],t[p+5]=u[2]-h[2],t[p+6]=u[1]-h[1],t[p+7]=u[0]-h[0]}for(let d=0;d<8;++d)l[0]=s*t[16+d],l[1]=a*t[16+d],l[2]=s*t[48+d],l[3]=a*t[48+d],h[0]=i*t[8+d]+r*t[24+d]+n*t[40+d]+o*t[56+d],h[1]=r*t[8+d]-o*t[24+d]-i*t[40+d]-n*t[56+d],h[2]=n*t[8+d]-i*t[24+d]+o*t[40+d]+r*t[56+d],h[3]=o*t[8+d]-n*t[24+d]+r*t[40+d]-i*t[56+d],c[0]=e*(t[d]+t[32+d]),c[3]=e*(t[d]-t[32+d]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],t[0+d]=u[0]+h[0],t[8+d]=u[1]+h[1],t[16+d]=u[2]+h[2],t[24+d]=u[3]+h[3],t[32+d]=u[3]-h[3],t[40+d]=u[2]-h[2],t[48+d]=u[1]-h[1],t[56+d]=u[0]-h[0]}function R(t){for(let e=0;e<64;++e){const i=t[0][e],s=t[1][e],r=t[2][e];t[0][e]=i+1.5747*r,t[1][e]=i-.1873*s-.4682*r,t[2][e]=i+1.8556*s}}function E(t,e,i){for(let s=0;s<64;++s)e[i+s]=Nt.toHalfFloat(_(t[s]))}function _(t){return t<=1?Math.sign(t)*Math.pow(Math.abs(t),2.2):Math.sign(t)*Math.pow(a,Math.abs(t)-1)}function L(t){return new DataView(t.array.buffer,t.offset.value,t.size)}function I(t){const e=t.viewer.buffer.slice(t.offset.value,t.offset.value+t.size),i=new Uint8Array(T(e)),s=new Uint8Array(i.length);return S(i),A(i,s),new DataView(s.buffer)}function O(t){const e=Jr(t.array.slice(t.offset.value,t.offset.value+t.size)),i=new Uint8Array(e.length);return S(e),A(e,i),new DataView(i.buffer)}function D(t){const i=t.viewer,s={value:t.offset.value},r=new Uint16Array(t.columns*t.lines*(t.inputChannels.length*t.type)),n=new Uint8Array(8192);let a=0;const o=new Array(t.inputChannels.length);for(let e=0,i=t.inputChannels.length;e<i;e++)o[e]={},o[e].start=a,o[e].end=o[e].start,o[e].nx=t.columns,o[e].ny=t.lines,o[e].size=t.type,a+=o[e].nx*o[e].ny*o[e].size;const l=Q(i,s),h=Q(i,s);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let t=0;t<h-l+1;t++)n[t+l]=W(i,s);const c=new Uint16Array(e),u=function(t,i){let s=0;for(let r=0;r<e;++r)(0==r||t[r>>3]&1<<(7&r))&&(i[s++]=r);const r=s-1;for(;s<e;)i[s++]=0;return r}(n,c),d=V(i,s);k(t.array,i,s,d,r,a);for(let e=0;e<t.inputChannels.length;++e){const t=o[e];for(let i=0;i<o[e].size;++i)M(r,t.start+i,t.nx,t.size,t.ny,t.nx*t.size,u)}!function(t,e,i){for(let s=0;s<i;++s)e[s]=t[e[s]]}(c,r,a);let p=0;const m=new Uint8Array(r.buffer.byteLength);for(let e=0;e<t.lines;e++)for(let e=0;e<t.inputChannels.length;e++){const t=o[e],i=t.nx*t.size,s=new Uint8Array(r.buffer,2*t.end,2*i);m.set(s,p),p+=2*i,t.end+=i}return new DataView(m.buffer)}function F(t){const e=Jr(t.array.slice(t.offset.value,t.offset.value+t.size)),i=t.inputChannels.length*t.lines*t.columns*t.totalBytes,s=new ArrayBuffer(i),r=new DataView(s);let n=0,a=0;const o=new Array(4);for(let i=0;i<t.lines;i++)for(let i=0;i<t.inputChannels.length;i++){let s=0;switch(t.inputChannels[i].pixelType){case 1:o[0]=n,o[1]=o[0]+t.columns,n=o[1]+t.columns;for(let i=0;i<t.columns;++i){s+=e[o[0]++]<<8|e[o[1]++],r.setUint16(a,s,!0),a+=2}break;case 2:o[0]=n,o[1]=o[0]+t.columns,o[2]=o[1]+t.columns,n=o[2]+t.columns;for(let i=0;i<t.columns;++i){s+=e[o[0]++]<<24|e[o[1]++]<<16|e[o[2]++]<<8,r.setUint32(a,s,!0),a+=4}}}return r}function B(t){const e=t.viewer,i={value:t.offset.value},s=new Uint8Array(t.columns*t.lines*(t.inputChannels.length*t.type*2)),r={version:j(e,i),unknownUncompressedSize:j(e,i),unknownCompressedSize:j(e,i),acCompressedSize:j(e,i),dcCompressedSize:j(e,i),rleCompressedSize:j(e,i),rleUncompressedSize:j(e,i),rleRawSize:j(e,i),totalAcUncompressedCount:j(e,i),totalDcUncompressedCount:j(e,i),acCompression:j(e,i)};if(r.version<2)throw new Error("EXRLoader.parse: "+rt.compression+" version "+r.version+" is unsupported");const n=new Array;let a=Q(e,i)-2;for(;a>0;){const t=N(e.buffer,i),s=W(e,i),r=s>>2&3,o=new Int8Array([(s>>4)-1])[0],l=W(e,i);n.push({name:t,index:o,type:l,compression:r}),a-=t.length+3}const o=rt.channels,l=new Array(t.inputChannels.length);for(let e=0;e<t.inputChannels.length;++e){const i=l[e]={},s=o[e];i.name=s.name,i.compression=0,i.decoded=!1,i.type=s.pixelType,i.pLinear=s.pLinear,i.width=t.columns,i.height=t.lines}const h={idx:new Array(3)};for(let e=0;e<t.inputChannels.length;++e){const t=l[e];for(let i=0;i<n.length;++i){const s=n[i];t.name==s.name&&(t.compression=s.compression,s.index>=0&&(h.idx[s.index]=e),t.offset=e)}}let c,u,d;if(r.acCompressedSize>0)switch(r.acCompression){case 0:c=new Uint16Array(r.totalAcUncompressedCount),k(t.array,e,i,r.acCompressedSize,c,r.totalAcUncompressedCount);break;case 1:const s=Jr(t.array.slice(i.value,i.value+r.totalAcUncompressedCount));c=new Uint16Array(s.buffer),i.value+=r.totalAcUncompressedCount}if(r.dcCompressedSize>0){const e={array:t.array,offset:i,size:r.dcCompressedSize};u=new Uint16Array(O(e).buffer),i.value+=r.dcCompressedSize}if(r.rleRawSize>0){d=T(Jr(t.array.slice(i.value,i.value+r.rleCompressedSize)).buffer),i.value+=r.rleCompressedSize}let p=0;const m=new Array(l.length);for(let t=0;t<m.length;++t)m[t]=new Array;for(let e=0;e<t.lines;++e)for(let e=0;e<l.length;++e)m[e].push(p),p+=l[e].width*t.type*2;!function(t,e,i,s,r,n){let a=new DataView(n.buffer);const o=i[t.idx[0]].width,l=i[t.idx[0]].height,h=Math.floor(o/8),c=Math.ceil(o/8),u=Math.ceil(l/8),d=o-8*(c-1),p=l-8*(u-1),m={value:0},f=new Array(3),g=new Array(3),y=new Array(3),v=new Array(3),w=new Array(3);for(let i=0;i<3;++i)w[i]=e[t.idx[i]],f[i]=i<1?0:f[i-1]+c*u,g[i]=new Float32Array(64),y[i]=new Uint16Array(64),v[i]=new Uint16Array(64*c);for(let e=0;e<u;++e){let n=8;e==u-1&&(n=p);let o=8;for(let t=0;t<c;++t){t==c-1&&(o=d);for(let t=0;t<3;++t)y[t].fill(0),y[t][0]=r[f[t]++],z(m,s,y[t]),P(y[t],g[t]),C(g[t]);R(g);for(let e=0;e<3;++e)E(g[e],v[e],64*t)}let l=0;for(let s=0;s<3;++s){const r=i[t.idx[s]].type;for(let t=8*e;t<8*e+n;++t){l=w[s][t];for(let e=0;e<h;++e){const i=64*e+8*(7&t);a.setUint16(l+0*r,v[s][i+0],!0),a.setUint16(l+2*r,v[s][i+1],!0),a.setUint16(l+4*r,v[s][i+2],!0),a.setUint16(l+6*r,v[s][i+3],!0),a.setUint16(l+8*r,v[s][i+4],!0),a.setUint16(l+10*r,v[s][i+5],!0),a.setUint16(l+12*r,v[s][i+6],!0),a.setUint16(l+14*r,v[s][i+7],!0),l+=16*r}}if(h!=c)for(let t=8*e;t<8*e+n;++t){const e=w[s][t]+8*h*2*r,i=64*h+8*(7&t);for(let t=0;t<o;++t)a.setUint16(e+2*t*r,v[s][i+t],!0)}}}const b=new Uint16Array(o);a=new DataView(n.buffer);for(let e=0;e<3;++e){i[t.idx[e]].decoded=!0;const s=i[t.idx[e]].type;if(2==i[e].type)for(let t=0;t<l;++t){const i=w[e][t];for(let t=0;t<o;++t)b[t]=a.getUint16(i+2*t*s,!0);for(let t=0;t<o;++t)a.setFloat32(i+2*t*s,X(b[t]),!0)}}}(h,m,l,c,u,s);for(let e=0;e<l.length;++e){const i=l[e];if(!i.decoded){if(2!==i.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let r=0,n=0;for(let a=0;a<t.lines;++a){let t=m[e][r];for(let e=0;e<i.width;++e){for(let e=0;e<2*i.type;++e)s[t++]=d[n+e*i.width*i.height];n++}r++}}}}return new DataView(s.buffer)}function N(t,e){const i=new Uint8Array(t);let s=0;for(;0!=i[e.value+s];)s+=1;const r=(new TextDecoder).decode(i.slice(e.value,e.value+s));return e.value=e.value+s+1,r}function U(t,e){const i=t.getInt32(e.value,!0);return e.value=e.value+4,i}function V(t,e){const i=t.getUint32(e.value,!0);return e.value=e.value+4,i}function q(t,e){const i=t[e.value];return e.value=e.value+1,i}function W(t,e){const i=t.getUint8(e.value);return e.value=e.value+1,i}const j=function(t,e){let i;return i="getBigInt64"in DataView.prototype?Number(t.getBigInt64(e.value,!0)):t.getUint32(e.value+4,!0)+Number(t.getUint32(e.value,!0)<<32),e.value+=8,i};function H(t,e){const i=t.getFloat32(e.value,!0);return e.value+=4,i}function G(t,e){return Nt.toHalfFloat(H(t,e))}function X(t){const e=(31744&t)>>10,i=1023&t;return(t>>15?-1:1)*(e?31===e?i?NaN:1/0:Math.pow(2,e-15)*(1+i/1024):i/1024*6103515625e-14)}function Q(t,e){const i=t.getUint16(e.value,!0);return e.value+=2,i}function Y(t,e){return X(Q(t,e))}function J(t,e,i,s,r){return"string"===s||"stringvector"===s||"iccProfile"===s?function(t,e,i){const s=(new TextDecoder).decode(new Uint8Array(t).slice(e.value,e.value+i));return e.value=e.value+i,s}(e,i,r):"chlist"===s?function(t,e,i,s){const r=i.value,n=[];for(;i.value<r+s-1;){const s=N(e,i),r=U(t,i),a=W(t,i);i.value+=3;const o=U(t,i),l=U(t,i);n.push({name:s,pixelType:r,pLinear:a,xSampling:o,ySampling:l})}return i.value+=1,n}(t,e,i,r):"chromaticities"===s?function(t,e){return{redX:H(t,e),redY:H(t,e),greenX:H(t,e),greenY:H(t,e),blueX:H(t,e),blueY:H(t,e),whiteX:H(t,e),whiteY:H(t,e)}}(t,i):"compression"===s?function(t,e){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][W(t,e)]}(t,i):"box2i"===s?function(t,e){return{xMin:U(t,e),yMin:U(t,e),xMax:U(t,e),yMax:U(t,e)}}(t,i):"envmap"===s?function(t,e){return["ENVMAP_LATLONG","ENVMAP_CUBE"][W(t,e)]}(t,i):"tiledesc"===s?function(t,e){const i=V(t,e),s=V(t,e),r=W(t,e);return{xSize:i,ySize:s,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&r],roundingMode:["ROUND_DOWN","ROUND_UP"][r>>4]}}(t,i):"lineOrder"===s?function(t,e){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][W(t,e)]}(t,i):"float"===s?H(t,i):"v2f"===s?function(t,e){return[H(t,e),H(t,e)]}(t,i):"v3f"===s?function(t,e){return[H(t,e),H(t,e),H(t,e)]}(t,i):"int"===s?U(t,i):"rational"===s?function(t,e){return[U(t,e),V(t,e)]}(t,i):"timecode"===s?function(t,e){return[V(t,e),V(t,e)]}(t,i):"preview"===s?(i.value+=r,"skipped"):void(i.value+=r)}function Z(t,e,i){let s=0;switch(t.levelMode){case"ONE_LEVEL":s=1;break;case"MIPMAP_LEVELS":s=function(t,e){const i=Math.log2(t);return"ROUND_DOWN"==e?Math.floor(i):Math.ceil(i)}(Math.max(e,i),t.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return s}function K(t,e,i,s){const r=new Array(t);for(let n=0;n<t;n++){const t=1<<n;let a=e/t|0;"ROUND_UP"==s&&a*t<e&&(a+=1);const o=Math.max(a,1);r[n]=(o+i-1)/i|0}return r}function $(){const t=this,e=t.offset,i={value:0};for(let s=0;s<t.tileCount;s++){const s=U(t.viewer,e),r=U(t.viewer,e);e.value+=8,t.size=V(t.viewer,e);const n=s*t.blockWidth,a=r*t.blockHeight;t.columns=n+t.blockWidth>t.width?t.width-n:t.blockWidth,t.lines=a+t.blockHeight>t.height?t.height-a:t.blockHeight;const o=t.columns*t.totalBytes,l=t.size<t.lines*o?t.uncompress(t):L(t);e.value+=t.size;for(let e=0;e<t.lines;e++){const s=e*t.columns*t.totalBytes;for(let r=0;r<t.inputChannels.length;r++){const o=rt.channels[r].name,h=t.channelByteOffsets[o]*t.columns,c=t.decodeChannels[o];if(void 0===c)continue;i.value=s+h;const u=(t.height-(1+a+e))*t.outLineWidth;for(let e=0;e<t.columns;e++){const s=u+(e+n)*t.outputChannels+c;t.byteArray[s]=t.getter(l,i)}}}}}function tt(){const t=this,e=t.offset,i={value:0};for(let s=0;s<t.height/t.blockHeight;s++){const r=U(t.viewer,e)-rt.dataWindow.yMin;t.size=V(t.viewer,e),t.lines=r+t.blockHeight>t.height?t.height-r:t.blockHeight;const n=t.columns*t.totalBytes,a=t.size<t.lines*n?t.uncompress(t):L(t);e.value+=t.size;for(let e=0;e<t.blockHeight;e++){const r=s*t.blockHeight,o=e+t.scanOrder(r);if(o>=t.height)continue;const l=e*n,h=(t.height-1-o)*t.outLineWidth;for(let e=0;e<t.inputChannels.length;e++){const s=rt.channels[e].name,r=t.channelByteOffsets[s]*t.columns,n=t.decodeChannels[s];if(void 0!==n){i.value=l+r;for(let e=0;e<t.columns;e++){const s=h+e*t.outputChannels+n;t.byteArray[s]=t.getter(a,i)}}}}}}const et={value:0},it=new DataView(t),st=new Uint8Array(t),rt=function(t,e,i){const s={};if(20000630!=t.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");s.version=t.getUint8(4);const r=t.getUint8(5);s.spec={singleTile:!!(2&r),longName:!!(4&r),deepFormat:!!(8&r),multiPart:!!(16&r)},i.value=8;let n=!0;for(;n;){const r=N(e,i);if(0==r)n=!1;else{const n=N(e,i),a=J(t,e,i,n,V(t,i));void 0===a?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${n}'.`):s[r]=a}}if(-7&r)throw console.error("THREE.EXRHeader:",s),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return s}(it,t,et),nt=function(t,e,i,r,n){const a={size:0,viewer:e,array:i,offset:r,width:t.dataWindow.xMax-t.dataWindow.xMin+1,height:t.dataWindow.yMax-t.dataWindow.yMin+1,inputChannels:t.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:s};switch(t.compression){case"NO_COMPRESSION":a.blockHeight=1,a.uncompress=L;break;case"RLE_COMPRESSION":a.blockHeight=1,a.uncompress=I;break;case"ZIPS_COMPRESSION":a.blockHeight=1,a.uncompress=O;break;case"ZIP_COMPRESSION":a.blockHeight=16,a.uncompress=O;break;case"PIZ_COMPRESSION":a.blockHeight=32,a.uncompress=D;break;case"PXR24_COMPRESSION":a.blockHeight=16,a.uncompress=F;break;case"DWAA_COMPRESSION":a.blockHeight=32,a.uncompress=B;break;case"DWAB_COMPRESSION":a.blockHeight=256,a.uncompress=B;break;default:throw new Error("EXRLoader.parse: "+t.compression+" is unsupported")}const o={};for(const e of t.channels)switch(e.name){case"Y":case"R":case"G":case"B":case"A":o[e.name]=!0,a.type=e.pixelType}let l=!1;if(o.R&&o.G&&o.B)l=!o.A,a.outputChannels=4,a.decodeChannels={R:0,G:1,B:2,A:3};else{if(!o.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");a.outputChannels=1,a.decodeChannels={Y:0}}if(1==a.type)switch(n){case Bt:a.getter=Y;break;case Ft:a.getter=Q}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+t.compression+".");switch(n){case Bt:a.getter=H;break;case Ft:a.getter=G}}a.columns=a.width;const h=a.width*a.height*a.outputChannels;switch(n){case Bt:a.byteArray=new Float32Array(h),l&&a.byteArray.fill(1,0,h);break;case Ft:a.byteArray=new Uint16Array(h),l&&a.byteArray.fill(15360,0,h);break;default:console.error("THREE.EXRLoader: unsupported type: ",n)}let c=0;for(const e of t.channels)void 0!==a.decodeChannels[e.name]&&(a.channelByteOffsets[e.name]=c),c+=2*e.pixelType;if(a.totalBytes=c,a.outLineWidth=a.width*a.outputChannels,"INCREASING_Y"===t.lineOrder?a.scanOrder=t=>t:a.scanOrder=t=>a.height-1-t,4==a.outputChannels?(a.format=Vt,a.colorSpace=s):(a.format=qt,a.colorSpace=Wt),t.spec.singleTile){a.blockHeight=t.tiles.ySize,a.blockWidth=t.tiles.xSize;const i=Z(t.tiles,a.width,a.height),s=K(i,a.width,t.tiles.xSize,t.tiles.roundingMode),n=K(i,a.height,t.tiles.ySize,t.tiles.roundingMode);a.tileCount=s[0]*n[0];for(let t=0;t<i;t++)for(let i=0;i<n[t];i++)for(let i=0;i<s[t];i++)j(e,r);a.decode=$.bind(a)}else{a.blockWidth=a.width;const t=Math.ceil(a.height/a.blockHeight);for(let i=0;i<t;i++)j(e,r);a.decode=tt.bind(a)}return a}(rt,it,st,et,this.type);return nt.decode(),{header:rt,width:nt.width,height:nt.height,data:nt.byteArray,format:nt.format,colorSpace:nt.colorSpace,type:this.type}}setDataType(t){return this.type=t,this}load(t,e,i,s){return super.load(t,(function(t,i){t.colorSpace=i.colorSpace,t.minFilter=Ut,t.magFilter=Ut,t.generateMipmaps=!1,t.flipY=!1,e&&e(t,i)}),i,s)}}const $r={sunPosition:new nt(.27,1,.5),sunTop:new nt(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new a(16777209).multiplyScalar(1),skyColor:new a(4348022),fogColor:new a(11253184),groundColor:new a(8421504),sunColor:new a(16777215).multiplyScalar(3)},tn={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:$r.sunPosition},sunTop:{value:$r.sunTop},noiseMap:{value:$r.noiseMap},mixRatio:{value:$r.mixRatio},cloud_size:{value:$r.cloud_size},cloud_covr:{value:$r.cloud_covr},cloud_dens:{value:$r.cloud_dens},cloud_dist:{value:$r.cloud_dist},nightLuminosity:{value:$r.nightLuminosity},haze:{value:$r.haze},saturation:{value:$r.saturation},SAMPLE:{value:$r.SAMPLE},STEP:{value:$r.STEP},fogy:{value:$r.fogy},t:{value:1},fogColor:{value:$r.fogColor},groundColor:{value:$r.groundColor},cloudColor:{value:$r.cloudColor},skyColor:{value:$r.skyColor},sunColor:{value:$r.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},en=Math.PI/180;class sn{constructor(t={}){this.mainScene=t.scene,this.renderer=t.renderer,this.usePrem=void 0!==t.usePmrem&&t.usePmrem,this.useBackground=void 0===t.useBackground||t.useBackground,this.envBlur=void 0!==t.envBlur?t.envBlur:0,this.callback=t.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new jt(this.renderer),this.pmremGenerator.compileEquirectangularShader()),t.cube&&this.initCubeEnv(t),t.url&&this.load(t.url)}initCubeEnv(t={}){this.isCubeEnv=!0,this._quality=t.quality||1,this.scene=new Ht,t.color&&(this.scene.background=new a(t.color)),this.target=new Gt(256*this._quality,{minFilter:Ut,type:Ft,colorSpace:i,anisotropy:1}),this.camera=new Xt(t.near||.1,t.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let t=new Qt(20,1);const e=new Yt(tn);this.sky=new u(t,e),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return $r}setSkyOtion(t){if(!this.isSky)return;let e=this.sky.material.uniforms;for(let i in t)e[i]&&(e[i].value=t[i]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const t=this.renderer,e=t.toneMapping;t.toneMapping=Jt,this.camera.update(t,this.scene),t.toneMapping=e}load(t){switch(this.name=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),this.type=t.substring(t.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new kr).load(t,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new Kr).load(t,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let t;switch(this.type){case"hdr":case"exr":t=this.loader,t.mapping=c;break;case"jpg":t=this.loader.renderTarget.texture,t.mapping=c}this.usePrem&&(t=this.pmremGenerator.fromEquirectangular(t).texture,this.pmremGenerator.dispose()),t.needsUpdate=!0;const e=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(e.background=t),this.envBlur&&(e.backgroundBlurriness=this.envBlur),e.environment=t,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(t){this.mainScene.environmentIntensity=t}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(t){this.mainScene.backgroundIntensity=t}get blur(){return this.mainScene.backgroundBlurriness}set blur(t){this.mainScene.backgroundBlurriness=t}rotate(t=0,e=0,i=0){0!==t&&(t*=en),0!==e&&(e*=en),0!==i&&(i*=en),this.mainScene.environmentRotation.set(t,e,i),this.mainScene.backgroundRotation.set(t,e,i)}}class rn{constructor(t={},e){this.motor=e,this.utils=this.motor.utils,this.id=0,this.type="autoRagdoll",this.name=t.name||this.type+this.id++;let i=this.utils.byName(this.name);i&&this.utils.remove(i),this._mode=t.mode||"follow",this._size=t.size||1,this._debug=t.debug||!1;const s=Ki(t.model);let r;s.scale.set(1,1,1).multiplyScalar(this._size),t.pos&&s.position.fromArray(t.pos),s.raycast=function(){},s.name=this.name,s.traverse((e=>{e.isMesh&&(e.frustumCulled=!1),e.isSkinnedMesh&&(e.raycast=function(){},e.frustumCulled=!1,e.matrixAutoUpdate=!1,e.receiveShadow=!0,e.castShadow=!0,t.material&&(e.material=t.material),e.skeleton.resetScalling(),r=e.skeleton.bones)}));let n=t.mass||null;return this.skeletonBody=new Zi(this.motor,s.name,s,r,n,t.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),this.model=s,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(t){this._size=t,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(t){this._debug=t,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(t){this._mode=t,this.skeletonBody.setMode(this._mode)}}class nn extends w{constructor(t){super(),this.rayCount=0,this.ray=[],this.motor=t,this.maxVertices=1e4,this.currentVertex=0,this.geometry=new r,this.geometry.setAttribute("position",new l(3*this.maxVertices,3)),this.geometry.setAttribute("color",new l(3*this.maxVertices,3)),this.positions=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material=new b({vertexColors:!0,toneMapped:!1,depthTest:!1,depthWrite:!1}),this.material.transparent=!0,this.renderOrder=3e4,this.frustumCulled=!1}DrawRay(t,e,i){i=new a(i);let s=this.currentVertex,r=3*s;this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,s++,r=3*s,this.positions[r]=t.x+e.x,this.positions[r+1]=t.y+e.y,this.positions[r+2]=t.z+e.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,this.currentVertex+=2}collapseBuffer(){let t=this.maxVertices,e=this.currentVertex,i=0;for(;t>=e;)i=3*t,this.positions[i]=0,this.positions[i+1]=0,this.positions[i+2]=0,this.colors[i]=0,this.colors[i+1]=0,this.colors[i+2]=0,t--}insertLine(t,e,i){let s=this.currentVertex,r=3*s;this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,s++,r=3*s,this.positions[r]=e.x,this.positions[r+1]=e.y,this.positions[r+2]=e.z,this.colors[r]=i.r,this.colors[r+1]=i.g,this.colors[r+2]=i.b,this.currentVertex+=2}draw(){this.collapseBuffer(),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.currentVertex=0}dispose(){this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}const an=Math.PI/180,on=[new nt(1,0,0),new nt(0,1,0),new nt(0,0,1)],ln=new nt,hn=new nt,cn=new nt,un=new nt,dn=[],pn=[],mn=new nt,fn=new nt,gn=new nt;new at;class yn{constructor(t={},e){this.motor=e,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=t.name||"car",this.mass=t.mass||1e3,this.size=t.size||[1.5,.7,3.8],this.pos=t.pos||[0,4,0],this.rot=t.rot||[0,0,0],this.friction=t.friction||.2,this.restitution=t.restitution||.3,this.massCenter=t.massCenter||[0,0,0],this.driveWheel=t.driveWheel||null;let i=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];t.shapeMesh&&(i=[{type:"convex",shape:t.shapeMesh.geometry,pos:t.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:i,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:t.bodyMesh||null,meshPos:t.meshPos||[0,-1.1,0],material:t.material,damping:[.05,.05],debug:!1}),this.body.inertia=new nt(1.416666865348816,1.666666865348816,.416666716337204),this.vehicle=new vn({chassis:this.body},this.motor);let s=t.wheelPosition||[.61,0,1.2];const r=[new nt(-s[0],s[1],-s[2]),new nt(s[0],s[1],-s[2]),new nt(-s[0],s[1],s[2]),new nt(s[0],s[1],s[2])],n={radius:t.wheelRadius||.31,directionLocal:new nt(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new nt(1,0,0),chassisConnectionPointLocal:new nt(1,1,0)};let a,o,l;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),r.forEach((t=>{n.chassisConnectionPointLocal.copy(t),this.vehicle.addWheel(n)}));let h=this.motor.getMat("debug");if(t.wheelMesh?(o=t.wheelMesh,l=t.wheelMesh2?t.wheelMesh2:null,t.material&&(h=t.material||h,o.material=h,l&&(l.material=h))):(a=new M(n.radius,n.radius,t.wheelDepth||.2),a.rotateZ(.5*Math.PI),o=new u(a,h),l=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[l||o.clone(),o,l?l.clone():o.clone(),o.clone()];let t=this.vehicle.wheelMeshes.length,e=0;for(;t--;)this.body.add(this.vehicle.wheelMeshes[e++])}else m.matrixAutoUpdate=!1,l&&(l.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(l||m.clone()),this.motor.add(m),this.motor.add(l?l.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let t=this.motor.getDelta();this.motor.getAzimut();let e=this.motor.getKey();this.tmp.forwardForce=e[1],this.tmp.steerDirection=-1*e[0],this.tmp.brakeForce=1===e[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let i=Math.abs(this.vehicle.currentVehicleSpeedKmHour);i=Math.min(i,this.maxSpeed),this.maxSpeed;const s=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(s,0),this.vehicle.applyEngineForce(s,1),this.vehicle.applyEngineForce(s,2),this.vehicle.applyEngineForce(s,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(t),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*an)}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.vehicle&&this.vehicle.setWheels(t,this.extra[t])}})}}class vn{constructor(t,e){this.motor=e,this.chassisBody=t.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:0,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:2,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(t={}){let e=new xn(t,this.motor),i=this.wheelInfos.length-1;e.chassisBody=this.chassisBody;let s=e.suspensionRestLength+e.radius;return e.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+i,begin:e.chassisConnectionPointLocal.toArray(),end:[e.chassisConnectionPointLocal.x,-s,e.chassisConnectionPointLocal.z],callback:function(t){e.castRay(t)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(e),i}setWheels(t,e){let i,s=this.wheelInfos.length;for(;s--;)i=this.wheelInfos[s],i[t]&&(i[t]=e)}setSteeringValue(t,e){this.wheelInfos[e].steering=t}applyEngineForce(t,e){this.wheelInfos[e].engineForce=t}setBrake(t,e){this.wheelInfos[e].brake=t}getVehicleAxisWorld(t,e){return e.set(0===t?1:0,1===t?1:0,2===t?1:0),In(e,zn(this.chassisBody,new at),e),e}updateVehicle(t){let e=this.wheelInfos,i=e.length,s=this.chassisBody,r=i;for(;r--;)this.updateWheelTransform(r);const n=Tn(s,new nt),a=On(n,zn(s,new at).invert(),new nt);this.currentVehicleSpeedKmHour=a.z;let o=new nt;this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(t);let l=new nt;for(new nt,r=0;r<i;r++){let i=e[r],n=i.suspensionForce;n>i.maxSuspensionForce&&(n=i.maxSuspensionForce),l.copy(i.raycastResult.hitNormalWorld).multiplyScalar(n*t),Cn(this.motor,s,l,i.raycastResult.hitPointWorld)}this.updateFriction(t);let h=new nt,c=new nt,u=new nt;for(r=0;r<i;r++){let i=e[r];Rn(s,i.chassisConnectionPointWorld,u);let n=1;if(1===this.indexUpAxis)n=-1;if(i.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);let e=_n(c,i.raycastResult.hitNormalWorld);h.copy(i.raycastResult.hitNormalWorld).multiplyScalar(e),c.sub(h);let s=_n(c,u);i.deltaRotation=n*s*t/i.radius}!i.sliding&&i.isInContact||0===i.engineForce||!i.useCustomSlidingRotationalSpeed||(i.deltaRotation=(i.engineForce>0?1:-1)*i.customSlidingRotationalSpeed*t),Math.abs(i.brake)>Math.abs(i.engineForce)&&(i.deltaRotation=0),i.rotation-=i.deltaRotation,i.deltaRotation*=.99}}updateSuspension(t){let e=this.chassisBody,i=kn(e),s=this.wheelInfos,r=s.length;for(let t=0;t<r;t++){let e=s[t];if(e.isInContact){let t,s=e.suspensionRestLength-e.suspensionLength;t=e.suspensionStiffness*s*e.clippedInvContactDotSuspension;let r,n=e.suspensionRelativeVelocity;r=n<0?e.dampingCompression:e.dampingRelaxation,t-=r*n,e.suspensionForce=t*i,e.suspensionForce<0&&(e.suspensionForce=0)}else e.suspensionForce=0}}updateFriction(t){let e,i,s,r=un,n=this.wheelInfos,a=n.length,o=this.chassisBody,l=dn,h=pn;for(e=0;e<a;e++)if(i=n[e],s=i.raycastResult.body,i.sideImpulse=0,i.forwardImpulse=0,l[e]||(l[e]=new nt),h[e]||(h[e]=new nt),s){let t=h[e],n=this.getWheelTransformWorld(e);On(on[this.indexRightAxis],n,t);let a=i.raycastResult.hitNormalWorld,c=_n(t,a);r.copy(a).multiplyScalar(c),t.sub(r).normalize(),Ln(a,t,l[e]),l[e].normalize(),i.sideImpulse=Gn(o,i.raycastResult.hitPointWorld,s,i.raycastResult.hitPointWorld,t),i.sideImpulse*=1}for(this.sliding=!1,e=0;e<a;e++){i=n[e],s=i.raycastResult.body;let r=0;if(i.slipInfo=1,s){let n=0,a=i.brake?i.brake:n;r=Fn(o,s,i.raycastResult.hitPointWorld,l[e],a),r+=i.engineForce*t;let h=a/r;i.slipInfo*=h}if(i.forwardImpulse=0,i.skidInfo=1,s){i.skidInfo=1;let e=i.suspensionForce*t*i.frictionSlip,s=e*e;i.forwardImpulse=r;let n=.5*i.forwardImpulse/i.forwardAcceleration,a=1*i.sideImpulse/i.sideAcceleration,o=n*n+a*a;if(i.sliding=!1,o>s){this.sliding=!0,i.sliding=!0;let t=e/Math.sqrt(o);i.skidInfo*=t}}}if(this.sliding)for(let t=0;t<a;t++)i=n[t],0!==i.sideImpulse&&i.skidInfo<1&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(e=0;e<a;e++){i=n[e];let t=new nt;if(t.copy(i.raycastResult.hitPointWorld).sub(An(o,new nt)),0!==i.forwardImpulse){let t=new nt;t.copy(l[e]).multiplyScalar(i.forwardImpulse),Cn(this.motor,o,t,i.raycastResult.hitPointWorld)}if(0!==i.sideImpulse){s=i.raycastResult.body,(new nt).copy(i.raycastResult.hitPointWorld).sub(An(s,new nt));let r=new nt;r.copy(h[e]).multiplyScalar(i.sideImpulse),On(t,zn(o,new at).invert(),t),t["xyz"[this.indexUpAxis]]*=i.rollInfluence,On(t,zn(o,new at),t),Cn(this.motor,o,r,An(o,new nt).add(t)),r.multiplyScalar(-1),Cn(this.motor,s,r,i.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(t){const e=this.chassisBody.matrixWorld;In(t.chassisConnectionPointLocal,e,t.chassisConnectionPointWorld),On(t.directionLocal,e,t.directionWorld)}updateWheelTransform(t){let e=mn,i=fn,s=gn,r=this.wheelInfos[t];this.updateWheelTransformWorld(r),e.copy(r.directionLocal).multiplyScalar(-1),i.copy(r.axleLocal),Ln(e,i,s),s.normalize(),i.normalize();let n=r.steering,a=new lt;Dn(e,n,a);let o=new lt;Dn(i,r.rotation,o);let l=r.quaternion;Pn(this.chassisBody,l),l.multiply(a).multiply(o).normalize();let h=r.position;h.copy(r.directionWorld),h.multiplyScalar(r.suspensionLength);let c=h.clone();h.add(r.chassisConnectionPointWorld),r.matrix.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.localWheel?(c.add(r.chassisConnectionPointLocal),this.wheelMeshes[t].quaternion.copy(a).multiply(o).normalize(),this.wheelMeshes[t].position.copy(c),this.brakeMeshs&&(2!==t&&3!==t||this.brakeMeshs[t].quaternion.copy(a).normalize(),this.brakeMeshs[t].position.copy(c),this.brakeMeshs[t].updateMatrix())):(this.wheelMeshes[t].position.copy(r.position),this.wheelMeshes[t].quaternion.copy(r.quaternion),this.wheelMeshes[t].updateMatrix())}getWheelTransformWorld(t){return this.wheelInfos[t].matrix}}var wn=new nt,bn=new nt;class xn{constructor(t,e){this.motor=e,t=((t,e)=>{for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t})(t,{chassisConnectionPointLocal:new nt,chassisConnectionPointWorld:new nt,directionLocal:new nt,directionWorld:new nt,axleLocal:new nt,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointLocal.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionLocal.clone(),this.axleLocal=t.axleLocal.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.forwardAcceleration=t.forwardAcceleration,this.sideAcceleration=t.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Mn,this.position=(new nt).copy(this.chassisConnectionPointLocal),this.quaternion=new lt,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new at}castRay(t){if(t.hit){this.isInContact=!0;let i=t.distance;this.raycastResult.hitPointWorld.fromArray(t.point),this.raycastResult.hitNormalWorld.fromArray(t.normal),this.raycastResult.body=this.motor.byName(t.body),this.suspensionLength=i-this.radius;let s=this.suspensionRestLength-this.maxSuspensionTravel,r=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<s&&(this.suspensionLength=s),this.suspensionLength>r&&(this.suspensionLength=r,this.raycastResult.reset());let n=_n(this.raycastResult.hitNormalWorld,this.directionWorld);Rn(this.chassisBody,this.raycastResult.hitPointWorld,wn);var e=_n(this.raycastResult.hitNormalWorld,wn);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/n;this.suspensionRelativeVelocity=e*t,this.clippedInvContactDotSuspension=t}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(t){let e=this.raycastResult;if(this.isInContact){let i=e.hitNormalWorld.dot(e.directionWorld);bn.copy(e.hitPointWorld).sub(t.position),Rn(t,bn,wn);let s=e.hitNormalWorld.dot(wn);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/i;this.suspensionRelativeVelocity=s*t,this.clippedInvContactDotSuspension=t}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.hitNormalWorld.copy(e.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class Mn{constructor(){this.body=null,this.hitPointWorld=new nt,this.hitNormalWorld=new nt,this.directionWorld=new nt}reset(){this.body=null,this.hitPointWorld=new nt,this.hitNormalWorld=new nt,this.directionWorld=new nt}}const kn=t=>t.mass,Sn=t=>t.mass>0?1/t.mass:0,An=(t,e)=>e.copy(t.position),Tn=(t,e)=>e.copy(t.velocity),zn=(t,e)=>e.copy(t.matrixWorld),Pn=(t,e)=>e.copy(t.quaternion),Cn=(t,e,i,s)=>{t.change({name:e.name,impulse:i.toArray(),impulseCenter:s.toArray()})},Rn=(t,e,i)=>(i.copy(e).sub(t.position),i.crossVectors(t.angular,i),i.add(t.velocity),i),En=(t,e)=>(t.inertia&&e.copy(t.inertia),On(e,t.matrixWorld,e),e.x=e.x>0?1/e.x:0,e.y=e.y>0?1/e.y:0,e.z=e.z>0?1/e.z:0,e),_n=(t,e)=>t.x*e.x+t.y*e.y+t.z*e.z,Ln=(t,e,i)=>{const s=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,n=t.x*e.y-t.y*e.x;return i.set(s,r,n),i},In=(t,e,i)=>{const s=t.x,r=t.y,n=t.z,a=e.elements,o=s*a[0]+r*a[4]+n*a[8]+a[12],l=s*a[1]+r*a[5]+n*a[9]+a[13],h=s*a[2]+r*a[6]+n*a[10]+a[14],c=1/(s*a[3]+r*a[7]+n*a[11]+a[15]);return i.x=o*c,i.y=l*c,i.z=h*c,i},On=(t,e,i)=>{const s=t.x,r=t.y,n=t.z,a=e.elements;return i.x=s*a[0]+r*a[4]+n*a[8],i.y=s*a[1]+r*a[5]+n*a[9],i.z=s*a[2]+r*a[6]+n*a[10],i},Dn=(t,e,i)=>{const s=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t.x*s,i.y=t.y*s,i.z=t.z*s,i};function Fn(t,e,i,s,r){var n=0,a=i,o=ln,l=hn,h=cn;Rn(t,a,o),Rn(e,a,l),h.copy(o).sub(l);return r<(n=-_n(s,h)*(1/(qn(t,i,s)+qn(e,i,s))))&&(n=r),n<-r&&(n=-r),n}var Bn=new nt,Nn=new nt,Un=new nt,Vn=new nt;function qn(t,e,i){var s=Bn,r=Nn,n=Un,a=Vn;return s.copy(e).sub(An(t,new nt)),Ln(s,i,r),a.copy(En(t,new nt)).multiply(r),Ln(a,s,n),Sn(t)+_n(i,n)}var Wn=new nt,jn=new nt,Hn=new nt;function Gn(t,e,i,s,r){if(r.lengthSq()>1.1)return 0;let n=Wn,a=jn,o=Hn;return Rn(t,e,n),Rn(i,s,a),o.copy(n).sub(a),-.1*_n(r,o)*(1/(Sn(t)+Sn(i)))}class Xn{constructor(t={},e){this.MoveSpeed=50,this.MaxSpeed=15,this.Drag=.98,this.SteerAngle=20,this.Traction=10,this.MoveForce=new nt(0,0,0),this.tt=new nt(0,0,0),this.v1=new nt(0,0,0),this.v2=new nt(0,0,0),this.motor=e,this.debug=this.motor.addDebuger(),this._reponsivness=500,this._throttleAmt=25,this._thottle=0,this._roll=0,this._pitch=0,this._yaw=0,this.init(t)}init(){this.car=new u(new k(2,1,3),new E({wireframe:!0})),this.car.position.y=.5,this.motor.add(this.car);let t=new Zt;this.car.add(t)}update(t){this.updateCar(t)}updateCar(t){const e=this.motor.getKey(),i=this.motor.getTransform(this.car);this.tt.copy(i.forward).multiplyScalar(this.MoveSpeed*-e[1]*t),this.MoveForce.add(this.tt),this.car.position.add(this.MoveForce.clone().multiplyScalar(t));let s=-e[0],r=this.MoveForce.length();i.up.multiplyScalar(s*r*this.SteerAngle*t),this.car.rotation.y+=i.up.y*this.motor.math.torad,this.MoveForce.multiplyScalar(this.Drag),this.MoveForce.clampLength(0,this.MaxSpeed),r=this.MoveForce.length(),this.v1.copy(this.MoveForce).normalize().multiplyScalar(3),this.v2.copy(i.forward).multiplyScalar(3),this.debug.DrawRay(i.position,this.v1,"white"),this.debug.DrawRay(i.position,this.v2,"blue"),this.debug.DrawRay(i.position,i.right,"red"),this.v1.copy(this.MoveForce).normalize().lerp(i.forward,this.Traction*t),this.MoveForce.copy(this.v1).multiplyScalar(r)}fixedUpdate(t){const e=this.motor.getTransform(this.body);e.position.copy(this.body.position),e.forward.copy(this.forward).applyQuaternion(this.body.quaternion),e.right.copy(this.right).applyQuaternion(this.body.quaternion),e.up.copy(this.up).applyQuaternion(this.body.quaternion),e.thottle.copy(e.up),this.motor.change({name:this.body.name,impulse:e.thottle.multiplyScalar(this._thottle).toArray()}),this.debug.DrawRay(e.position,e.thottle,"red"),this.debug.DrawRay(e.position,e.forward,"yellow"),this.debug.DrawRay(e.position,e.right,"cyan"),this.debug.DrawRay(e.position,e.up,"green")}handleInputs(t){const e=this.motor.getKey();this._roll=e[0],this._pitch=e[1],e[4]?this._thottle+=t*this._throttleAmt:e[5]&&(this._thottle-=t*this._throttleAmt),this._thottle=this.motor.math.clamp(this._thottle,0,100)}}class Qn{constructor(t={},e){this.startPosition=t.pos||[0,0,0],this.model=t.model||null,this.debug=t.debug||!1,this.angle=0,this.speed=50,this.maxSpeed=20,this.drag=.98,this.steerAngle=5,this.traction=3,this.moveForce=new nt(0,0,0),this.side=0,this.onAir=!1,this.tt=new nt(0,0,0),this.v1=new nt(0,0,0),this.v2=new nt(0,0,0),this.floorNormal=new nt(0,0,0),this.up=new nt(0,1,0),this.decal=new nt(0,-.5,0),this.tmpQ1=new lt,this.tmpQ2=new lt,this.tmpQ3=new lt,this.motor=e,this.angleS=0,this.debug&&(this.debuger=this.motor.addDebuger()),this.phyMove=!0,this.init(t)}setDebug(t){t&&(this.debug=t),this.sphere.visible=this.debug,this.ray.visible=this.debug}init(){this.radius=1,this.decal.y=-.5,this.radius=1.7,this.decal.y=-1.2;const t=this.motor.math;this.sphere=this.motor.add({type:"sphere",name:"baser",mass:1,size:[this.radius],pos:t.addArray(this.startPosition,[0,this.radius,0]),friction:.5,material:"debug",getVelocity:!0,visible:this.debug,shadow:!1,ray:!1});let e=this.rayHit.bind(this);if(this.ray=this.motor.add({name:"raySphere",type:"ray",begin:[0,0,0],end:[0,-(this.radius+1),0],visible:this.debug,parent:this.sphere,noRotation:!0,callback:e}),this.model){for(let t in this.model)this.model[t].receiveShadow=!0,this.model[t].castShadow=!0;this.car=this.model.body,this.w=[this.model.wheel_0,this.model.wheel_1,this.model.wheel_2,this.model.wheel_3,this.model.d_wheel]}else this.car=new u(new k(1,.4,2),new E({wireframe:!0})),this.addWheels();this.motor.add(this.car)}addWheels(){let t=new M(.3,.3,.3,16);t.rotateZ(Math.PI/2);let e,i=new E({wireframe:!0}),s=4,r=[.7,-.2,.7],n=[];for(;s--;)n[s]=new u(t,i),e=[0===s||3===s?r[0]:-.7,r[1],s<2?r[2]:-.7],n[s].position.fromArray(e),this.car.add(n[s]);this.w=n}updateWheels(){this.motor.math;let t,e=4;this.tmpQ3.setFromAxisAngle({x:0,y:1,z:0},3*this.angleS);let i=this.sphere.velocity.length()*this.side,s={x:1,y:0,z:0};for(;e--;)t=this.w[e],e<2?t.quaternion.setFromAxisAngle(s,i).premultiply(this.tmpQ3):t.quaternion.setFromAxisAngle(s,i);this.w[4]&&(this.w[4].rotation.y=10*this.angleS)}rayHit(t){t.hit?this.floorNormal.fromArray(t.normal).normalize():this.floorNormal.set(0,0,0),this.onAir=!t.hit}update(t){const e=this.motor.getKey(),i=this.motor.math;this.phyMove&&this.car.position.copy(this.sphere.position).add(this.decal);const s=this.motor.getTransform(this.car);let r=-e[1]*this.speed*t;this.onAir&&(r=0),this.tt.copy(s.forward).multiplyScalar(r),this.moveForce.add(this.tt),this.phyMove||this.car.position.add(this.moveForce.clone().multiplyScalar(t)),this.tmpQ1.setFromUnitVectors(this.up,this.floorNormal),this.tmpQ2.slerp(this.tmpQ1,4*t);let n=this.moveForce.toArray();this.motor.change({name:this.sphere.name,linear:n,velocityOperation:"xz"}),this.chassis&&this.motor.change({name:this.chassis.name,quat:this.car.quaternion.toArray(),pos:this.car.position.toArray()});let a=-e[0],o=this.moveForce.length();this.angleS=a*this.steerAngle*i.torad,this.angle+=this.angleS*o*t,this.car.quaternion.setFromAxisAngle(this.up,this.angle).premultiply(this.tmpQ2),this.moveForce.multiplyScalar(this.drag),this.moveForce.clampLength(0,this.maxSpeed),o=this.moveForce.length(),this.v1.copy(this.moveForce).normalize().multiplyScalar(1),this.v2.copy(s.forward).multiplyScalar(1),this.debug&&(this.debuger.DrawRay(s.position,this.v1,"white"),this.debuger.DrawRay(s.position,this.v2,"blue")),this.v1.copy(this.moveForce).normalize().lerp(s.forward,this.traction*t),this.moveForce.copy(this.v1).multiplyScalar(o),this.side=this.moveForce.dot(s.forward)>0?-1:1,this.updateWheels()}}const Yn=new at,Jn=new at;new nt;let Zn=Kt.prototype;Zn.byName=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return this.bones[e];return null},Zn.getId=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return e;return null},Zn.setExtraRotation=function(t,e,i,s){(t.isBone?t:this.byName(t))&&$t.DEG2RAD},Zn.setScalling=function(t,e,i,s){let r=t.isBone?t:this.byName(t);r&&(r.scalling=new nt(e,i,s))},Zn.resetScalling=function(t){this.pose(),this.scalled=!0;for(let t=0,e=this.bones.length;t<e;t++)this.bones[t].isPhysics=!1,this.bones[t].phyMtx=new at;t||this.applyScalling()},Zn.childScale=function(t,e){if(!this.scalled)return;t.scalling&&e.scale(t.scalling);let i,s=t.children.length,r=0;for(;s--;)i=t.children[r],r++,i.isBone,i.matrixWorld.multiplyMatrices(e,i.matrix)},Zn.applyScalling=function(t){let e,i,s,r=this.bones.length;for(i=0;i<r;i++)e=this.bones[i],s=e.parent||null,null!==s&&s.scalling&&"root"!==e.name&&(e.position.multiply(s.scalling),e.updateMatrixWorld(!0));this.calculateInverses()},Zn.update=function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;let r,n=t.length,a=0;for(;n--;){r=t[a];const s=r?r.isPhysics?r.phyMtx:r.matrixWorld:Jn;this.childScale(r,s),Yn.multiplyMatrices(s,e[a]),Yn.toArray(i,16*a),a++}null!==s&&(s.needsUpdate=!0)};const Kn={getColor(t){let e=t.toString();e=e.substring(e.lastIndexOf(".")+1);let i,s=[255,255,255];switch(e){case"grass":s=[.223,.827,.325],i=[.741,.498,.258];break;case"dirt":s=[.741,.498,.258];break;case"leaves":s=[.152,.682,.376];break;case"sand":s=[.878,.819,.686];break;case"ice":s=[.65,.882,.96];break;case"stone":s=[.537,.64,.65];break;case"cobblestone":s=[.666,.647,.588];break;case"wood":s=[.603,.321,.152];break;case"snow":s=[.905,.976,1]}return i?[s[0],s[1],s[2],i[0],i[1],i[2]]:[s[0],s[1],s[2]]},fire:{type:"star",numParticles:20,position:[0,0,0],colors:[1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,.5,0,0,0,0],lifeTime:2,timeRange:2,startSize:.3,endSize:.9,velocity:[0,.8,0],velocityRange:[.15,.15,.15],gravity:[0,-.2,0],spinSpeedRange:4},smoke:{position:[-2,-.2,0],colors:[0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],numParticles:20,lifeTime:2,timeRange:2,startSize:.5,endSize:2,velocity:[0,1.6,0],velocityRange:[.2,0,.2],gravity:[0,-.25,0],spinSpeedRange:4,blending:"normal"},addBlock:{type:"cube",numParticles:30,lifeTime:1.5,endTime:1.5,startTime:0,startSize:.25,endSize:.5,sizeRange:.25,spinSpeedRange:2,radius:.25,velocity:[1,0,1],velocityRange:[.25,0,.25],acceleration:[1,0,1],accelerationRange:[.25,0,.25],gravity:[0,.05,0],tween:"outQuad",blending:"normal",alphaTest:.1},removeBlock:{type:"cube",lifeTime:1.5,endTime:1.5,startTime:0,startSize:.5,sizeRange:.25,endSize:.1,spinSpeedRange:2,accelerationRange:[.5,.5,.5],gravity:[0,-.1,0],tween:"outQuad",blending:"normal",alphaTest:.1},explosion:{colors:[1,0,0,0,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,.5,1,1,1,0],type:"cloud",radius:.5,radiusRange:.5,numParticles:400,positionRange:[2,1,2],lifeTime:3,endTime:4,lifeTimeRange:1,startTime:0,startSize:.1,endSize:2,sizeRange:1,accelerationRange:[1,.3,1],acceleration:[.8,.8,.8],gravity:[0,-.5,0],spinSpeedRange:2,luma:!1},playerMove:{trail:!0,colors:[1,1,1,1,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:1e3,positionRange:[.2,0,.2],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.1,0]},vehicleMove:{trail:!0,colors:[.5,.5,.5,.25,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:2e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.2,0]},vehicleTrack:{trail:!0,colors:[.2,.2,.2,.1,.2,.2,.2,0],type:"round2",blending:"normal",startSize:.3,endSize:.3,numParticles:4,maxParticles:2e3,position:[0,-.1,0],lifeTime:6,oriented:!0},underWater:{trail:!0,colors:[1,1,1,1,.5,.5,1,0],type:"bubble",blending:"normal",numParticles:1,maxParticles:1e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.1,endSize:.5,sizeRange:.05,velocity:[0,1,0],velocityRange:[1,0,1],acceleration:[.2,0,.2],gravity:[0,1,0]},bazookaFire:{trail:!0,colors:[1,0,0,1,1,1,0,.5,1,1,1,0],type:"round",numParticles:2,maxParticles:600,positionRange:[.1,.1,.1],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.1,velocityRange:[.6,.6,.6],gravity:[0,.1,0],luma:!1}},$n=["pixel","basic","cube","cloud","round","round2","donut","bubble","smoke","circle","field","star","octo"];function ta(){this.parent=null,this.position=[0,0,0],this.rotation=[0,0,0],this.name="default",this.type="round",this.tween="linear",this.trail=!1,this.model="",this.numParticles=1,this.maxParticles=0,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.endTime=-1,this.lifeTimeRange=0,this.sizeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.pposition=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.gravity=[0,0,0],this.oriented=!1,this.orientation=[0,0,0,1],this.colors=[1,1,1,1],this.blending="additive",this.radius=0,this.radiusPosition=!1,this.axis="Y",this.radiusRange=0,this.tmpRotation=null,this.alphaTest=0,this.renderOrder=0,this.luma=!0,this.depthWrite=!1,this.transparent=!0}const ea={torad:Math.PI/180,todeg:180/Math.PI,random:()=>Math.random(),rand:(t,e)=>t+ea.random()*(e-t),randInt:(t,e)=>t+Math.floor(ea.random()*(e-t+1)),plusMinus:t=>(ea.random()-.5)*t*2,plusMinusVector:t=>{const e=[];let i=t.length;for(;i--;)e.push(ea.plusMinus(t[i]));return e},toTexture:t=>{let e=new g(t);return e.minFilter=Ut,e.magFilter=Ut,e.flipY=!1,e.colorSpace=i,e.needsUpdate=!0,e},createTextureFromFloats:(t,e,i,s)=>{let r=null;if(null==s){const s=new Uint8Array(i.length);let n;for(let t=0;t<i.length;t++)n=255*i[t],s[t]=n;return r=new ae(s,t,e,Vt),r.minFilter=Ut,r.magFilter=Ut,r.needsUpdate=!0,r}return r=s,r}},ia=function(t){let e;switch(t){case"linear":e="float tween( float k ) { return k; }";break;case"inQuad":e="float tween( float k ) { return k * k; }";break;case"outQuad":e="float tween( float k ) { return k * ( 2.0 - k ); }";break;case"inOutQuad":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k;\n            return - 0.5 * ( --k * ( k - 2.0 ) - 1.0 ); \n        }";break;case"inCubic":e="float tween( float k ) { return k * k * k; }";break;case"outCubic":e="float tween( float k ) { return --k * k * k + 1.0; }";break;case"inOutCubic":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k + 2.0 ); \n        }";break;case"inQuart":e="float tween( float k ) { return k * k * k * k; }";break;case"outQuart":e="float tween( float k ) { return 1.0 - ( --k * k * k * k ); }";break;case"inOutQuart":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return 0.5 * k * k * k * k;\n\t\t\treturn - 0.5 * ( ( k -= 2.0 ) * k * k * k - 2.0 ); \n        }";break;case"inQuint":e="float tween( float k ) { return k * k * k * k * k; }";break;case"outQuint":e="float tween( float k ) { return --k * k * k * k * k + 1.0; }";break;case"inOutQuint":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k * k * k + 2.0 );\n        }";break;case"inSine":e="#define PI_90 1.570796326794896\n        float tween( float k ) { float j = k * PI_90; return 1.0 - cos( j ); }";break;case"outSine":e="#define PI_90 1.570796326794896\n\t\tfloat tween( float k ) { float j = k * PI_90; return sin( j ); }";break;case"inOutSine":e="#define M_PI 3.14159265358979323846\n\t\tfloat tween( float k ) { \n\t\t\tfloat j = k * M_PI; return 0.5 * (1.0-cos(j));\n        }";break;case"inExpo":e="float tween( float k ) { return k == 0.0 ? 0.0 : pow( 1024.0, k - 1.0 ); }";break;case"outExpo":e="float tween( float k ) { return k == 1.0 ? 1.0 : 1.0 - pow( 2.0, - 10.0 * k ); }";break;case"inOutExpo":e="float tween( float k ) { \n\t\t\tif ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * pow( 1024.0, k - 1.0 );\n\t\t    return 0.5 * ( - pow( 2.0, - 10.0 * ( k - 1.0 ) ) + 2.0 );\n        }";break;case"inCirc":e="float tween( float k ) { return 1.0 - sqrt( 1.0 - k * k ); }";break;case"outCirc":e="float tween( float k ) { return sqrt( 1.0 - ( --k * k ) ); }";break;case"inOutCirc":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return - 0.5 * ( sqrt( 1.0 - k * k ) - 1.0 );\n\t\t\treturn 0.5 * ( sqrt( 1.0 - ( k -= 2.0 ) * k ) + 1.0 ); \n        }";break;case"inElastic":e="#define TWO_PI 6.28318530717958647692\n        float tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return - ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t}";break;case"outElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1; \n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return ( a * pow( 2.0, - 10.0 * k) * sin( ( k - s ) * TWO_PI / p ) + 1.0 );\n\t\t}";break;case"inOutElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return - 0.5 * ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t    return a * pow( 2.0, -10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) * 0.5 + 1.0;\n\t\t}";break;case"inBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return k * k * ( ( s + 1.0 ) * k - s );\n\t\t}";break;case"outBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return --k * k * ( ( s + 1.0 ) * k + s ) + 1.0;\n\t\t}";break;case"inOutBack":e="float tween(float k) {\n\t\t    float s = 1.70158 * 1.525;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * ( k * k * ( ( s + 1.0 ) * k - s ) );\n\t\t    return 0.5 * ( ( k -= 2.0 ) * k * ( ( s + 1.0 ) * k + s ) + 2.0 );\n\t\t}";break;case"inBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat tween(float k) { return 1.0 - outBounce( 1.0 - k ); }";break;case"outBounce":e="float tween(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}";break;case"inOutBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat inBounce(float k) { return 1.0 - outBounce( 1.0 - k ); }\n\t\tfloat tween(float k) {\n\t\t    if ( k < 0.5 ) return inBounce( k * 2.0 ) * 0.5;\n\t\t    return outBounce( k * 2.0 - 1.0 ) * 0.5 + 0.5;\n\t\t}"}return e},sa=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],ra=new Float32Array(28);class na extends te{constructor(t,e){super(),this.pe=t,this.count=0,this.color=null,this.texture=null,this.localTime=0,this.time=0,this.endTime=-1,this.num=0,this.matrixAutoUpdate=!1,this.frustumCulled=e.frustum||!1,this.receiveShadow=!1,this.castShadow=!1,this.birthIndex=0,this.luma=!0,e&&this.setParameters(e)}setParameters(t){this.validateParameters(t),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.name=t.name,this.isTrail=t.trail||!1,this.parameters=t;const e=this.isTrail?t.maxParticles:t.numParticles;this.allocateParticles_(e,t),this.isTrail||this.createParticles_(0,e,t),t.parent?t.parent.add(this):this.pe.scene?this.pe.scene.add(this):this.pe.add(this)}makeGeometry(t){this.geometry=t.oriented?new ee:new r,this.isMesh=t.oriented}setColorRamp(t){const e=t.length/4;if(e%1!=0)throw"colorRamp must have multiple of 4 entries";this.color=ea.createTextureFromFloats(e,1,t)}validateParameters(t){var e=new ta;for(let i in t)if(void 0===e[i])throw'unknown particle parameter "'+i+'"';for(let i in e)void 0===t[i]&&(t[i]=e[i])}perParticle(t,e){}birthParticles(t,e){var i=this.parameters.numParticles;this.parameters.pposition=t,this.parameters.startTime=this.time,this.endTime=this.time+this.parameters.lifeTime,e&&this.setColorRamp(e),this.createParticles_(this.birthIndex,i,this.parameters),this.birthIndex+=i,this.birthIndex+i>=this.parameters.maxParticles&&(this.birthIndex=0)}createParticles_(t,e,i){const s=ea.plusMinus,r=ea.plusMinusVector,n=this.interleavedBuffer.array;let a,o=e;for(;o--;){this.perParticle(o,i);let l=i.lifeTime+s(i.lifeTimeRange),h=null===i.startTime?o*i.lifeTime/e:i.startTime,c=i.frameStart+s(i.frameStartRange),u=(new nt).addVectors((new nt).fromArray(i.pposition),(new nt).fromArray(r(i.positionRange))),d=(new nt).addVectors((new nt).fromArray(i.velocity),(new nt).fromArray(r(i.velocityRange))),p=(new nt).addVectors((new nt).fromArray(i.acceleration),(new nt).fromArray(r(i.accelerationRange))),m=(new St).addVectors((new St).fromArray(i.colorMult),(new St).fromArray(r(i.colorMultRange))),f=i.spinStart+s(i.spinStartRange),g=i.spinSpeed+s(i.spinSpeedRange),y=i.startSize+s(i.sizeRange||i.startSizeRange),v=i.endSize+s(i.sizeRange||i.endSizeRange),w=(new St).fromArray(i.orientation);if(i.positionRange[0],i.positionRange[1],i.positionRange[2],i.radius){let t=i.axis||"Y",e=ea.rand(0,2*Math.PI);i.tmpRotation=[90,-e*ea.todeg,90,"YXZ"];let r=i.radius+s(i.radiusRange),n=Math.cos(e),a=Math.sin(e),o=new nt;switch(t){case"X":o.y=n,o.z=a;break;case"Y":o.x=n,o.z=a;break;case"Z":o.x=n,o.y=a}switch(o.multiplyScalar(r),i.radiusPosition&&u.add(o),t){case"X":o.x=1;break;case"Y":o.y=1;break;case"Z":o.z=1}p.multiply(o),d.multiply(o)}i.tmpRotation&&(w=(new lt).setFromEuler(new kt(i.tmpRotation[0]*ea.torad,i.tmpRotation[1]*ea.torad,i.tmpRotation[2]*ea.torad,i.tmpRotation[3]))),a=0+28*o*4+28*t*4,n[0+a]=u.x,n[0+a+1]=u.y,n[0+a+2]=u.z,n[0+a+3]=h,n[4+a]=sa[0][0],n[4+a+1]=sa[0][1],n[4+a+2]=l,n[4+a+3]=c,n[8+a]=d.x,n[8+a+1]=d.y,n[8+a+2]=d.z,n[8+a+3]=y,n[12+a]=p.x,n[12+a+1]=p.y,n[12+a+2]=p.z,n[12+a+3]=v,n[16+a]=f,n[16+a+1]=g,n[16+a+2]=0,n[16+a+3]=0,n[20+a]=w.x,n[20+a+1]=w.y,n[20+a+2]=w.z,n[20+a+3]=w.w,n[24+a]=m.x,n[24+a+1]=m.y,n[24+a+2]=m.z,n[24+a+3]=m.w}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value.fromArray(i.worldVelocity),this.material.uniforms.gravity.value.fromArray(i.gravity),this.material.uniforms.timeRange.value=i.timeRange,this.material.uniforms.frameDuration.value=i.frameDuration,this.material.uniforms.numFrames.value=i.numFrames,this.material.uniforms.rampSampler.value=this.color,this.material.uniforms.colorSampler.value=this.texture,this.material.blending="normal"===i.blending?it:et,this.updateMatrix()}allocateParticles_(t,e){if(this.count!==t){if(e.oriented||(e.oriented=!1),e.position&&this.position.fromArray(e.position),e.rotation&&this.quaternion.setFromEuler(new kt(e.rotation[0]*ea.torad,e.rotation[1]*ea.torad,e.rotation[2]*ea.torad)),this.setColorRamp(e.colors),this.pe.textures.has(e.type)||-1!==$n.indexOf(e.type)&&this.pe.textures.make(e.type),this.texture=this.pe.textures.get(e.type),this.texture||console.log("this texture is undefined !!"),this.endTime=e.endTime||-1,this.luma=e.luma,this.makeGeometry(e),this.count=t,e.oriented){var i=new ie(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8);this.geometry.setAttribute("position",new se(i,3,0)),this.geometry.setAttribute("uv",new se(i,2,4)),this.geometry.setIndex(new n(new Uint16Array([0,1,2,0,2,3]),1)),this.interleavedBuffer=new re(new Float32Array(t*ra.byteLength),28,1).setUsage(ne)}else this.interleavedBuffer=new ie(new Float32Array(t*ra.byteLength),28).setUsage(ne);this.geometry.setAttribute("position",new se(this.interleavedBuffer,3,0)),this.geometry.setAttribute("startTime",new se(this.interleavedBuffer,1,3)),this.geometry.setAttribute("uvLifeTimeFrameStart",new se(this.interleavedBuffer,4,4)),this.geometry.setAttribute("velocityStartSize",new se(this.interleavedBuffer,4,8)),this.geometry.setAttribute("accelerationEndSize",new se(this.interleavedBuffer,4,12)),this.geometry.setAttribute("spinStartSpinSpeed",new se(this.interleavedBuffer,4,16)),this.geometry.setAttribute("orientation",new se(this.interleavedBuffer,4,20)),this.geometry.setAttribute("colorMult",new se(this.interleavedBuffer,4,24)),this.geometry.boundingSphere=new Ot,this.geometry.boundingSphere.radius=3;let r=et;switch(e.blending){case"sub":case"subtractive":r=tt;break;case"multi":case"multiply":r=$;break;case"normal":r=it;break;default:r=et}var s={worldVelocity:{value:new nt},gravity:{value:new nt},timeRange:{value:0},time:{value:0},timeOffset:{value:0},frameDuration:{value:0},numFrames:{value:0},rampSampler:{value:null},colorSampler:{value:null},scale:{value:.5*window.innerHeight},luma:{value:this.luma?this.pe.luminosity:1},alphaTest:{value:e.alphaTest}};this.material=new Yt({defines:{USE_ORIENTATION:e.oriented},uniforms:s,vertexShader:ia(e.tween||"linear")+"\nprecision mediump float;\nprecision mediump int;\n\n#ifdef USE_ORIENTATION\n\t//uniform mat4 worldViewProjection;\n\t//uniform mat4 world;\n\tattribute vec3 offset;\n\tattribute vec4 orientation;\n#else\n    uniform float scale;\n#endif\n\nuniform vec3 worldVelocity;\nuniform vec3 gravity;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n//#include <clipping_planes_pars_vertex>\n\nvec3 lerp( vec3 a, vec3 b, float p ){ return a + (b - a) * p; }\n\nvoid main() \n{\n    float lifeTime = uvLifeTimeFrameStart.z;\n    float frameStart = uvLifeTimeFrameStart.w;\n    float startSize = velocityStartSize.w;\n\n    //vec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz, 0.0)).xyz + worldVelocity;\n\t//vec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz, 0.0)).xyz + gravity;\n\n    //vec3 velocity = velocityStartSize.xyz + worldVelocity;\n\t//vec3 acceleration = accelerationEndSize.xyz + gravity;\n\n\tvec3 velocity = velocityStartSize.xyz + (inverse(modelMatrix) * vec4(worldVelocity, 0.0)).xyz;\n\tvec3 acceleration = accelerationEndSize.xyz + (inverse(modelMatrix) * vec4(gravity, 0.0)).xyz;\n\n    float endSize = accelerationEndSize.w;\n    float spinStart = spinStartSpinSpeed.x;\n    float spinSpeed = spinStartSpinSpeed.y;\n\n    float localTime = mod((time - timeOffset - startTime), timeRange);\n    //localTime = tween( localTime );\n    float percentLife = localTime / lifeTime;\n    percentLife = tween( percentLife );\n\n    vec3 posEnd = velocity * lifeTime + acceleration * lifeTime * lifeTime;\n\n    float frame = mod(floor(localTime / frameDuration + frameStart), numFrames);\n    float uOffset = frame / numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n    outputTexcoord = vec2(u, uv.y + 0.5);\n    outputColorMult = colorMult;\n\n    float size = mix(startSize, endSize, percentLife);\n\tsize = (percentLife < 0. || percentLife > 1.0) ? 0.0 : size;\n\n\tfloat s = sin(spinStart + spinSpeed * localTime);\n\tfloat c = cos(spinStart + spinSpeed * localTime);\n\n    #ifdef USE_ORIENTATION\n\t\t\n\t\tvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., (uv.x * s - uv.y * c) * size, 1.);\n\t\t//vec3 center = velocity * localTime + acceleration * localTime * localTime + position + offset;\n\t\tvec3 center = (posEnd * percentLife) + position + offset;\n\n\t\tvec4 q2 = orientation + orientation;\n\t\tvec4 qx = orientation.xxxw * q2.xyzx;\n\t\tvec4 qy = orientation.xyyw * q2.xyzy;\n\t\tvec4 qz = orientation.xxzw * q2.xxzz;\n\n\t\tmat4 localMatrix = mat4(\n\t\t    (1.0 - qy.y) - qz.z,  qx.y + qz.w,  qx.z - qy.w, 0,\n\t\t    qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n\t\t    qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n\t\t    center.x, center.y, center.z, 1\n\t\t);\n\t\trotatedPoint = localMatrix * rotatedPoint;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n\n\t#else\n\n\t    //vec3 pos = position + velocity * localTime + acceleration * localTime * localTime;\n\n\t    vec3 pos = (posEnd * percentLife) + position;\n\t    \n\t    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );\n        //gl_PointSize = size * 1.5 * ( scale / length( mvPosition.xyz ) );\n        gl_PointSize = size * 1.5 * ( scale / - mvPosition.z );\n\n        mat2 r = mat2( c, -s, s, c);\n        r *= 0.5; r += 0.5;  r = r * 2.0 - 1.0;\n        rotationMtx = r;\n\n        gl_Position = projectionMatrix * mvPosition;\n\n\t#endif\n\n\toutputPercentLife = percentLife;\n\n\t#include <logdepthbuf_vertex>\n\t//#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nuniform float luma;\nuniform float alphaTest;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n//#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t//#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\n\tvec4 diffuseColor = texture2D( rampSampler, vec2(outputPercentLife, 0.5) ) * outputColorMult;\n\n    vec2 uv = vec2(0.0);\n    #ifdef USE_ORIENTATION\n        uv = outputTexcoord;\n\t#else\n\t    uv = gl_PointCoord;\n\t    uv -= 0.5; uv = uv * rotationMtx; uv += 0.5;\n\t#endif\n\n\t// texture\n\tdiffuseColor *= texture2D( colorSampler, uv );\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n\tdiffuseColor.rgb *= luma;\n\n\tgl_FragColor = diffuseColor; \n\t#include <fog_fragment>\n\n}\n",side:e.oriented?I:D,blending:r,depthTest:!0,depthWrite:e.depthWrite,transparent:e.transparent,forceSinglePass:e.single||!1,fog:e.fog||!1}),this.renderOrder=e.renderOrder||0}}draw(t=0){if(!this.material.uniforms)return;const e=this.material.uniforms;this.time+=this.pe.delta,e.time.value=this.time,e.timeOffset.value=t,e.scale.value=this.pe.hscale,e.luma.value=this.luma?this.pe.luminosity:1,-1!==this.endTime&&this.time>=this.endTime&&this.pe.remove(this.name)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.material.dispose(),this.color.dispose()}raycast(){}clone(t){return void 0===t&&(t=this.pe.createEmitter(this.texture)),t.time=0,t.endTime=this.endTime,t.geometry=this.geometry,t.material=this.material.clone(),t.material.uniforms.rampSampler.value=this.color,t.material.uniforms.colorSampler.value=this.texture,super.copy(t),this.num++,t.name=this.name+this.num,t}}class aa extends Map{constructor(){super()}dispose(){this.forEach((t=>{t.dispose()})),this.clear()}add(t,e){this.has(t)||this.set(t,e)}make(t){if(!this.has(t)){let e=this["make"+t[0].toUpperCase()+t.substring(1)]();this.set(t,e)}}makePixel(){const t=[];for(let e=0;e<2;++e)for(let e=0;e<2;++e)t.push(1,1,1,1);return ea.createTextureFromFloats(2,2,t)}makeBasic(){const t=[0,.2,.7,1,.7,.2,0,0],e=[];for(let i=0;i<8;++i)for(let s=0;s<8;++s){let r=t[s]*t[i];e.push(r,r,r,1)}return ea.createTextureFromFloats(8,8,e)}makeCube(){let t=document.createElement("canvas");t.width=t.height=8;const e=t.getContext("2d");return e.fillStyle="rgba(255,255,255,1.0)",e.fillRect(2,2,4,4),ea.toTexture(t)}makeCloud(){let t=16,e=document.createElement("canvas");e.width=e.height=t;const i=e.getContext("2d");let s="rgba(255,255,255,1)",r="rgba(255,255,255,0)",n=i.createRadialGradient(8,6.4,0,8,6.4,6.4);return n.addColorStop(.3,s),n.addColorStop(1,r),i.fillStyle=n,i.fillRect(0,0,t,t),n=i.createRadialGradient(6.4,9.92,0,6.4,9.92,5.6),n.addColorStop(.3,s),n.addColorStop(1,r),i.fillStyle=n,i.fillRect(0,0,t,t),n=i.createRadialGradient(4.32,6.4,0,4.32,6.4,4.16),n.addColorStop(.2,s),n.addColorStop(1,r),i.fillStyle=n,i.fillRect(0,0,t,t),n=i.createRadialGradient(12.16,9.6,0,12.16,9.6,3.68),n.addColorStop(.2,s),n.addColorStop(1,r),i.fillStyle=n,i.fillRect(0,0,t,t),ea.toTexture(e)}makeRound(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.3,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),ea.toTexture(t)}makeRound2(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),ea.toTexture(t)}makeDonut(){let t=document.createElement("canvas");t.width=t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,0.1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.beginPath(),e.arc(16,16,16,0,2*Math.PI,!1),e.arc(16,16,8,0,2*Math.PI,!0),e.fill(),ea.toTexture(t)}makeBubble(){let t=document.createElement("canvas");t.width=t.height=64;let e="rgba(0,255,255,0)";const i=t.getContext("2d"),s=i.createRadialGradient(25.6,25.6,0,32,32,32);return s.addColorStop(.4,e),s.addColorStop(.9,"rgba(0,255,255,0.6)"),s.addColorStop(.99,"rgba(0,255,255,1)"),s.addColorStop(1,e),i.fillStyle=s,i.fillRect(0,0,64,64),i.fillStyle="rgba(255,255,255,1)",i.beginPath(),i.arc(44.8,25.6,8.96,0,2*Math.PI,!1),i.fill(),i.beginPath(),i.arc(12.8,41.6,3.2,0,2*Math.PI,!1),i.fill(),ea.toTexture(t)}makeSmoke(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");let i=new Image;i.src=oa;let s=ea.toTexture(t);return i.onload=function(){e.drawImage(i,0,0),s.needsUpdate=!0},s}makeCircle(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");return e.strokeStyle="white",e.lineWidth=4,e.beginPath(),e.arc(32,32,30,0,2*Math.PI),e.stroke(),ea.toTexture(t)}makeField(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,0,64);return i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.8,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(24,0,16,64),ea.toTexture(t)}makeStar(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255,255,255,0.5)"),i.addColorStop(.5,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),e.fillStyle=i,this.star(e,32,6.4,32,32,3),this.star(e,32,25.6,32,32,3),ea.toTexture(t)}makeOcto(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(.4,"rgba(255,255,255,0.2)"),i.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=i,this.star(e,25.6,22.4,32,32,6),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=6,e.stroke(),ea.toTexture(t)}star(t,e,i,s,r,n){let a,o,l;t.beginPath(),t.moveTo(s+e,r);for(var h=1;h<=2*n;h++)h%2==0?(l=h*(2*Math.PI)/(2*n),a=s+e*Math.cos(l),o=r+e*Math.sin(l)):(l=h*(2*Math.PI)/(2*n),a=s+i*Math.cos(l),o=r+i*Math.sin(l)),t.lineTo(a,o);t.closePath(),t.fill()}}const oa="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAPOklEQVR42rWb224dRRaGq\n7r30Tu2Y5MhmYsZRZqbeahBiCvgPnCBOCeAEEjcI/E2vAfiYqJJgIHE2/Y+Vk2tzf9Ji2XZDsmkpeXu3V1dXf9f61Sr2316wa3Wmj/++GO\nTrkkvSTo3aDKUdB999JHJoMlEYud72tk13ce53kmmX5PWNr///vvpgw8+yPfv30+llPzee+917Xd68ODBM4+/f1HwbYd04XhgouNqx3re0\nF3rc85DtUntmK6zk7G11XHh0fZns9nk1WqVjYR23J2ennZtn7788sv6UgkA/Hq97mzwbevbbwMzEMBJGPj290HnDrC2qe3IzrV7N2oXSR2\nZ2PN4dNbW972JjSOfnJx0o9EoDwaD+sUXX7w8Ah4+fJgbw7nWCphRztnkDzMr0Wwx8ISWVNvTXrNv14xI7u+4LmLpE82xbcd+A50nk0kdj\n8fJCHnzzTfTN998U18KAW+88UY+OjoypjsNdtTGMLQJYXYBDUjTjqC+nYD1XtVbu7Ht23lIsfPW936TiZ0HOP3YRLTNNKG2LW2aVp6dnqZ\n/vfZa/fbbb//vBJiDMcbtgTv71aDs2IMvkl4AbKDJ9tZW94w0k0nmcsOO7bp+j0TErO1nOgeRmIqZQ3UkNlOYp58eP0qL5bJ+99139YUJ+\nP77702l8ttvv51ff/31bjab5f39/a7h3wFv7GP7nfMPqC8qW5htAd8ToKTr+9pXAZ+atH72pCkFMtVmg48Ag55Rt9tt3pRSbx4epPv3H+T\nPP/+8mrP89NNPn48AA95sKw+Hw7xcLvPh4WG3t7eXmhb0+AER4L3/UOKdYFbbPQOs6xknh1MUMfQ71bkiDaO/KvFRZrsD1Hf1xmy2PTy8m\nc0pWli07cMPP4SEP0fAu+++m9ssAz5Pp1MzAXuone+c+mcAAEr9V+0xh5ns3druOe0ZVbv++zERoUdbpOreufZ6Bu1LbVsjoLTxFXtuKaV\nmF1v/NAE//PCDObtk4J8+fZru3LnTNfXPTc0MuBExMBNgxph5+YbeacN0Z+8pT2qqaIYBu6H7JtYmy/tLcJY7LfBaBpkci6zN76aSa3DC6\nbkJuHfvns18Oj8/z/P5PN29e7c3AizWNsmEJ0DrgcwMmnBDx5yHgJGAkzNwL2qfaEN/zvvzLHwBJlDYk1hJc5KN+Zl9wOPHj/Nbb72VF4t\nFMqfSJN26das7Pj7uBDzLAe5mzhwbaqvBzQAmQBBVNPO3mhziH3R96tp2uncm4N6nmPbZPWvA4hjdcRZwSLDUOX3yySfPRsBXX31l6tKSi\n3GaTmfN9g924Jsz9NmeATcbTnr4K03+0eS2AwEJaEMS+L/p2mmTousHTY5s77z/EBIEHFNgNrdEADcBbBXnye9nIoDts88+a1502Lz/yLx\n+3zIt4rl1aLO/51TxZpN/Nvm7wJ+LfYvtM9vL8++3xsf2WwNeYCYCuqd8YExYM6J1viOlJqSi8oRT38Y0BALIqdCCawkwtd85+G4X5bu+R\nX2lqR2q6LzrRMDvaqbO9PChG3wvMzlq+4NUKzNETnCg/ZA0mO51Du1Z2vBEAODxA7TBNOgju8VWtRUlJFxKQGtkM52hAG+q2TQQE2K+4vq\nrTf5CMqP9mFlxWeG+zW7F4THrzjG6sBjziixwC5PWbi3wtIWMVZOiBZT1h6ZU7a8mwICLva4dDGgjsH9tcstASI2P5KTMBI6lytPWybQaM\nFskaXZqO6e21nfVnri+lmrPlBsAyGSsxVYncGcysRVpsPcBkmrgyTad06xXEQD4rIXHrB0NmzCbNpA7Lvk4tt8Cf2gDx4sbcFP1LIIEaso\nCiDiv2L0SiIna9HZeA06ocq311EzA5RhbgTtX25Eky/aL4WlixxtpzPZSAnTB1H/MzMrmqmb9WECxa0LdDQjQAAa0IaZr1WbgR5yzKZKNk\nvtjCpgb8R1Vt/b4lTFaAilyxGM0Aa2wRZj8BqZxrQbsCViV0Pmr2ncCfSwSpiQ72DGgdT+eewx4BxBCmHnsH8FubdYP3RpiWWs9MVDSwCM\nIwDnqEUVttiKhxHDYB/CEExzPvpzbEbMPYInXhJ4Bh7oAMvAAQ2aIWbB1FD1Ybvt1hsBh0zM3tuzMp9CuyVIkFJMLBAC+2kSlDAl7YvUVN\n8PTkOWh5iP6Ql19Dc9XiaKHD+cK99LepcUrSYdPCmk096+UYJ0T1Ru+FVHjAgEsFSlJ5STV1AMkexJ+Q8bEgc8BTGJgYZZzJILjIPSJhi7\nl+akTohFDgV4TCgV+ASHyE7oeCCilsKQdNfDYsLdjzmGnFD1nzM4ldT7AebBe2OL5DgE7lR9MwfVXQypcHQlryZmZAATJB3Bf2tXbvXfFk\nzuwPmxBCFrRexAcR3XHriPweG/Yxy0z44B3oFJIhM4VwRYco/4mfyCg5ceoPwMO+zBoPDkq6BxbsN84o33s6wrANYIPYwF8hQyBXDkS5k1\nOjASIwkmTDnsC6DiWtHyUsGMywL1QAq9h9qNtR9WOYCIZRJN4Lap4If/HSZIuC/wTaQAEEA53aYiREDVggODdA7CZZXgu6ekYBGEngI4zG\nDeARo2IfiX5NNcdF8BpjwN8auC1xxkWHwW8BpD7Q0DvvHzPAJWCjmuq45zyGPWP6oq6M2gGGK6zlUsIyvE8M49msAc4CRAE1Fqf5Jznvk5\nwqQ/ggVRecTaAQTt8FMiJWj0DdKrvPLPi8JaiZvDg0TzYIhGAAwzgVxYeqf6wWML+2/kzTxraEwnABdgegIPg8SeszRvwvSb7So6IGBlwJ\ngK9Id3lAdFEop+4wkQAsXZkFmxeE7cR+FMtnObtvHOA9HExDCZMAEAhvFGYzJSuAE97rwXMmDAPfJv4yuwa71/DbBdWeZw3Mpg5A0rI08J\nnIQJ8kkQekDwBdnN0gjGx6STEf9oQCuNM9aFymzwBPO8a8EiJ4RIwqikMCH0ihcRpHULjBkyEQQiICYm30S4scGKGiCNMHrykwjj9egn91\n0tUv9qmWS/BZIonR9qw1OJnFRKgKnJKLIr0qgF4Aipg48tIVn+sA3CWGsAaH8IAQRM0KZKcaQRoSKgURoPTJLp4AjTjC6W+Oz8gItZMhpb\nHjgCpobSADVUfQgDnRcC+r+UxKzg8SQ5ZYQxxSNyKN4EMQHfORwQJx+da+xdMgCTIRw9INudv0sMGzpAECNaoBKtcFatBgMtBa6JfAVy0/\nwg67itLdaq6zt6XIc9Y6Fqv945FYZC2tKd/+7iiMhBIGJHrMzAqv8w8xRDqf0HVAZwlHPs4nJ2UeC2S4AlWZCHZWVzTZ5YJzBUeF/5ZBn4\n34FgOJw9A3GupiSovN0XGOFaBorML4FNMlIJEP1QFIprLhvhOe2npxNoqAXqiPs0kfm3X5+3KihenmL1JJCChyiEhwr4PAR8iBGSi/hFIu\nSZFjibC7EftoJK8dZ4dM4QYy/9/bccmv7XrLIm3XrtUbquxKlwbCdF2s3/1Hew8xvUcB891hOtIyPUJo7H/qBXYvG0DJT0PDbgRq7XATyy\nHCYUCbR0U8EJA1AJf0CgskTnHbwZ+hbevkflos5yL/dA+fB5nUlj+4tQE/D/SgCxCfpPtky1Gjaq75XD44tNXbgEQzSIukhJZWIjTyautB\nx8JiWbCfQKdEPry1R/z9E2eKuxx75oQKNL88hlJEADLvQMY1Tb7zC/k6RsHehVUGm3iOM58zBTZs3kNKgrLBXtX9Zd8vwJOoTApDK5jvRB\nt8olQVD1fDI3LYcBWsXzC93p6TcXD1hKWwcEfsOFf4nlAx3UGROeleXa3Cly68hd+jklZ+fsBHwngZFT5HgEYbXR8oj2VJexzKYJKzBdi3\nVHiNSQ60Q0AciYRspw/VcX5X/S8gZ4/17qAfs/1bsC/GYoEsF0sZjIb0aGFslTiCzBXmKiE05jxcR67DoAhwKktYZM3PQkT+K9kqDCdjBA\n5wY1ejvpMMPsPJXwqnAP4dEkeTgaI7fGd0MS9UCnGOKRAABJtPPgTzKtwLhCNZhnAx9qva7U6RZ3hH3SPOce5osJWDlFZoNOAK7Qggu/8C\nlBveW8oC6vKyLZ8RNUEMr3jZPMLGsBCRqWqJEDVacpCBc9fZX4qe9WO+3DoAv4katgFEwgLouioiMdJlTMADUO1J5KWib2Q6olgJgHgica\nBatY8YWu1/012fyo175y/8vn/mUUCCiWMg3+8cHlAICFUZtbrddJXoYWZ452/V2m7jr36d3GQo2tLvvKgYhPMASe6DuaysEovs45NKzWfE\nqIF/t9NfpYjJOwl7XdcXFgMeVOIBJydnSX77lY328CQWAcE4EbHzCzhaIEAIBQsmf1YzFyR4wsgaj4LobrIPB5ZUcSFQsBnbwYNF4uhK7T\nAenv0KLUvRJWKJr684CMEPl4sOL743Q7FCcJjfI3Fbw8Y4VU3ak07/JEnEfWXFLROmkl9IZVS7DtI+xTw0q/EsoGFiB9//DG1DyVT3/fVv\nSgZmWgg5Og4RpPs1G/DQH3CErw64NAA2s0hA63w4ZE+Q4EEKe5bwYrqG/jgBC9qgTeH27dvJ3VQmtqU4XDYt474jLWYkHqhjuTvfBjFmgF\nNCCqPFgAe/xBJAnwN959KqGgV/c5kmTjya78TjERgEsbccrWqv/z8c9o/OBjq32SSr7pCArNuh/xGRRXa8DPk9ZjAGWCYccwgRIu42oTA5\nN8UY4oQR0SxRMjVBNmuJ8Js5uuvv+7MFHwMj6s5acWaNl6FfbE01PgXCm9zpyVr7B+zCNEBcMUVY88k29A+VqbytRpwlXmEjxJZb7Px1ma\ntGUaVS9Zmx4EcoodpyRqtQGhLP8Gn4PBYB5yiBY6guNXnIgCTkJOsLv4jqOaaj5NM9LuSHOWUlyEk4jCLTMXab3B8OFIvgPR+QhKrwHGro\nSr8fFoAGd4HsF7Hthk49opG4OVjfZ/j0rZt2+y4DbSgVSEZox/fnzO9izMPcDAEAp6LDDSBZMMGvml+gvjrFzokS+uUk2lHVOfdrJO2bjY\n6NFEmJxIgwAvA/TMrYL2wQcALb1ETmDGfpDDzDPaSLLAivMtbrVZpcX6+y0G6JlnpbAAaS14cAzhsgYCXQAL7uK4v7C8T8gpy9fl8npeNh\nJZ71L7ryUYhwUsKx+T7L5WASAJSEUjBWfK7bQCOIGi/S1lLazadTtPBwUF955179r+A9g9QXq13MV2qXtvxM4Fn+x+D0fC1BkndygAAAAB\nJRU5ErkJggg==";class la extends Tt{constructor(t){super(),this.scene=t||null,this.isGl2=!0,this.emitters=new Map,this.textures=new aa,this.loader=null,this.now=0,this.last=0,this.delta=0,this.elapsed=0,this.num=0,this.hscale=.5*window.innerHeight,this.luminosity=1,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}updateMatrixWorld(t){super.updateMatrixWorld(t),null===this.scene&&this.update()}get(t){return this.emitters.has(t)?this.emitters.get(t):null}add(t,e){if(t.isPoints)return void super.add(t);t.name||(t.name="PP"+this.num++),this.remove(t.name),t.model&&Kn[t.model]&&(t={...Kn[t.model],...t});let i=new na(this,t);return this.emitters.set(t.name,i),i}remove(t){if("string"==typeof t||t instanceof String){if(!this.emitters.has(t))return;this.emitters.get(t).dispose(),this.emitters.delete(t)}else if(t.isPoints)return void super.remove(t)}addTexture(t,e,s=!0){this.textures.has(t)?console.log("this name of texture is already take !"):"string"==typeof e?(this.loader||(this.loader=new y),this.loader.load(e,(e=>{e.flipY=!1,s&&(e.colorSpace=i),this.textures.add(t,e)}))):e.isTexture&&(e.flipY=!1,this.textures.add(t,e))}load(t){const e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));var i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=JSON.parse(i.responseText);for(let e in t)this.add(t[e])}else console.error("Couldn't load ["+e+"] ["+i.status+"]")}.bind(this),i.send()}resize(t){this.hscale=.5*t}onresize(t){this.hscale=.5*t}loop(t){this.delta=t,this.emitters.forEach((t=>{t.draw()}))}update(t){this.now=void 0!==t?t:Date.now(),this.delta=.001*(this.now-this.last),this.elapsed+=this.delta,this.last=this.now,this.emitters.forEach((t=>{t.draw()}))}dispose(t=!0){this.emitters.forEach((t=>{t.dispose()})),this.emitters.clear(),t&&this.textures.dispose(),this.num=0}addBlock(t,e){let i=t[1]<=4?-2:0,s=Kn.getColor(e),r=s[0],n=s[1],a=s[2];s.length>3&&(r=s[3],n=s[4],a=s[5]),t[0]+=.5,t[2]+=.5,this.add({position:t,colors:[r,n,a,1,r,n,a,0],renderOrder:i,...Kn.addBlock})}delBlock(t,e){let i=t[1]<=4?-2:0,s=Kn.getColor(e),r=s[0],n=s[1],a=s[2];t[0]+=.5,t[2]+=.5,t[1]+=.5;let o=30;s.length>3&&(o=20,this.add({position:[t[0],t[1]+.375,t[2]],positionRange:[.5,.25,.5],colors:[r,n,a,.5,r,n,a,0],numParticles:10,renderOrder:i,...Kn.removeBlock}),r=s[3],n=s[4],a=s[5]),this.add({position:t,positionRange:[.5,.5,.5],colors:[r,n,a,.5,r,n,a,0],numParticles:o,renderOrder:i,...Kn.removeBlock})}removePlayerTrail(t){this.remove("PlayerTrail_"+t)}onPlayerWalk(t,e,i){let s=this.get("PlayerTrail_"+e);null===s&&(s=this.addTrail({name:"PlayerTrail_"+e,...Kn.playerMove}));let r=t.toArray();r[1]+=.2;let n=Kn.getColor(i),a=[n[0],n[1],n[2],.75,n[0],n[1],n[2],0];n.length>3&&(a=[n[0],n[1],n[2],.75,n[3],n[4],n[5],0]),s.birthParticles(r,a)}onVehicleDrive(t,e){let i=this.get("VehicleTrail_"+e);null===i&&(i=this.addTrail({name:"VehicleTrail_"+e,...Kn.vehicleMove})),i.birthParticles(t.toArray())}onBazookaFire(t,e){let i=this.get("BazookaTrail_"+e);null===i&&(i=this.addTrail({name:"BazookaTrail_"+e,...Kn.bazookaFire})),i.birthParticles(t.toArray())}onExplosion(t){this.add({position:t.toArray(),...Kn.explosion})}}new nt,new nt,new u(new x(.03),new E({transparent:!0})),new nt,new nt,new u(new x(.03),new E({transparent:!0})),new S;new M(1,1,1).rotateX(Math.PI/2),new ft,new nt,new nt,new a("red");const ha={PHY:"0.5.0",PHYSX:"5.06.10",HAVOK:"1.2.1",JOLT:"0.36.0",RAPIER:"0.16.2",OIMO:"1.2.4",AMMO:"3.2.6"};class ca{constructor(t={}){this.noBuffer=!0,this.geo=new He,this.mat=new $e,this.math=xe,this.pool=Le,this.version=ha.PHY,this.Version=ha,this.engine="",this.jointVisible=!1,this.utils=new da(this),this.collision=new Es(this),this.viewSize=null,this.debug=!1,this.delta=0,this.debuger=null,this.mouseActive=!1;const e=this;let i=null,s=!1,r=!1,n=!1,a=null,o=null,l=null,h=!1,c=!1,u=!1,d=!0,p=!1,m=null,f=!1,g={t1:0,t2:0,t3:0,t4:0},y=null,v=null,w=null,b=!1,x=!0,M=null,k=null,S=0,A=0,T="",z=null,P=null,C=null;const R=new ei,E=new ti(60),_={start:0,end:0,startTime:""};let L=()=>0,I=()=>{},O=()=>{},D=()=>{},F=[],B=[],N=[],U=null;const V={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let q=null,W={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0,delta:0,ms:0},point:{},contact:{},velocity:{}};const j={};this.scene=null,this.scenePlus=null,this.ws=1,this.uws=1,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let t,e,i;for(t in this.tmpMesh){if(i=this.tmpMesh[t],i.children)for(e in i.children)this.disposeMesh(i.children[e]);this.disposeMesh(i),i.parent&&i.parent.remove(i)}for(t in this.tmpMesh=[],this.tmpTex)this.tmpTex[t].dispose();this.tmpTex=[]},this.disposeMesh=t=>{t.geometry&&t.geometry.dispose(),t.dispose&&t.dispose()},this.setStep=t=>{O=t},this.debugMode=t=>{this.setDebugMode(t)},this.setDebugMode=t=>{this.debug=t},this.useRealLight=t=>{this.mat.useRealLight(t)},this.getSetting=()=>V,this.setGravity=t=>{t&&(V.gravity=t),this.post({m:"setGravity",o:{gravity:V.gravity}})},this.set=(t={})=>{V.fixe=void 0===t.fixe||t.fixe,V.full=void 0!==t.full&&t.full,V.gravity=t.gravity?t.gravity:[0,-9.81,0],V.substep=t.substep?t.substep:1,V.fps=t.fps?t.fps:60,this.ws=void 0!==t.worldScale?t.worldScale:1,this.uws=1/this.ws,t.key&&D(),j.body.setFull(V.full),this.initArray(V.full),A=0,u=h,d=!u,this.jointVisible=t.jointVisible||!1,d&&E.setFramerate(V.fps);const e={...V,ArPos:W,isTimeout:u,outsideStep:d};this.post({m:"set",o:e})},this.activeMouse=(t,e)=>{y||(y=new Bs(t,e,this)),this.mouseActive=!0},this.mouseMode=(t,e)=>{y&&y.setMode(t,e)},this.getTime=()=>ti.now(),this.readTime=t=>ti.format_time(t),this.startTime=()=>_.startTime,this.getTimeTest=()=>g,this.setMaxFps=t=>{},this.getMouse=()=>y?y.mouse:null,this.setMaxAnisotropy=t=>{Le.maxAnisotropy=t},this.setAddControl=t=>{D=t},this.setPrevUpdate=t=>{},this.setPostUpdate=t=>{O=null!==t?t:()=>{}},this.setAzimut=t=>{L=t},this.setRenderer=t=>{P=t,Le.renderer=P},this.setKey=(t,e)=>R.setKey(t,e),this.getKey=()=>R.key,this.getKey2=()=>R.key2,this.getAzimut=()=>L(),this.setContent=t=>{f||(C=t,C.add(this.scene),C.add(this.scenePlus),f=!0)},this.message=t=>{let i=t.data;i.Ar&&(q=i.Ar),i.reflow&&(this.reflow=i.reflow,this.reflow.stat.delta&&(A+=this.reflow.stat.delta)),e[i.m](i.o)},this.worldScaler=t=>{const e=this.ws;if(t.pos&&(t.pos=xe.worldscale(t.pos,e)),t.localPos&&(t.localPos=xe.worldscale(t.localPos,e)),t.massCenter&&(t.massCenter=xe.worldscale(t.massCenter,e)),t.pos1&&(t.pos1=xe.worldscale(t.pos1,e)),t.pos2&&(t.pos2=xe.worldscale(t.pos2,e)),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(t.shapes[s].size=xe.worldscale(i.size,e)),i.pos&&(t.shapes[s].pos=xe.worldscale(i.pos,e)),i.v&&(t.shapes[s].v=xe.worldscale(i.v,e))}else t.size&&(t.size=xe.worldscale(t.size,e)),t.v&&(t.v=xe.worldscale(t.v,e))},this.post=(t,e=null,i=!1)=>{1!==this.ws&&("add"!==t.m&&"change"!==t.m||this.worldScaler(t.o)),h?(t.o&&("solver"===t.o.type&&(i=!0),void 0!==t.o.solver&&(i=!0)),i?l.postMessage(t,e):"add"===t.m?this.flow.add.push(t.o):"remove"===t.m?this.flow.remove.push(t.o):l.postMessage(t,e)):v({data:t})},this.addDebuger=()=>{if(null===this.debuger)return this.debuger=new nn(this),this.scenePlus.add(this.debuger),this.debuger},this.removeDebuger=()=>{null!==this.debuger&&(this.debuger.dispose(),this.debuger=null)},this.vehicle=t=>{let e;switch(t.type){case"raycar":e=new yn(t,this);break;case"kart":e=new Qn(t,this);break;case"helico":e=new Xn(t,this)}return e},this.autoRagdoll=t=>{const e=new rn(t,this);return this.scene.add(e.model),e},this.byName=t=>this.utils.byName(t),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=t=>{this.viewSize=t,i&&i.resize(this.viewSize.h)},this.init=(t={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,_.start=ti.now();const i=t.compact||!1;let n=document.location.href.replace(/\/[^/]*$/,"/"),a=n.split("/");n=a[0]+"//"+a[2]+"/","https://lo-th.github.io/"===n&&(n="https://lo-th.github.io/phy/");let u=t.path||"";u+=i?"compact/":"build/";let d=t.type||"PHYSX",p=d.toLowerCase(),m=p.charAt(0).toUpperCase()+p.slice(1);if(this.engine=d.toUpperCase(),this.initItems(),Le.materialRoot=this.mat.set.bind(this.mat),t.callback&&(o=t.callback,delete t.callback),h=t.worker||!1,this.scene=new Tt,this.scene.name="phy_scene",this.scenePlus=new Tt,this.scenePlus.name="phy_scenePlus",t.scene&&(this.setContent(t.scene),delete t.scene),t.renderer&&(this.setRenderer(t.renderer),delete t.renderer),T=t.envmap||"",r=!!t.useModule&&this.supportModuleWorker(),s=t.useLocal||!1,Le.useLocal=s,i)s?r?Le.load(new URL("../"+u+m+".module.hex",import.meta.url),(function(){e.onCompactDone(t)})):Le.load(new URL("../"+u+m+".hex",import.meta.url),(function(){e.onCompactDone(t)})):r?Le.load(n+u+m+".module.hex",(function(){e.onCompactDone(t)})):Le.load(n+u+m+".hex",(function(){e.onCompactDone(t)}));else if(h){if(l=s?r?new Worker(new URL("./"+m+".module.js",import.meta.url),{type:"module"}):new Worker(new URL("./"+m+".min.js",import.meta.url),{type:"classic"}):r?new Worker(n+u+m+".module.js",{type:"module"}):new Worker(n+u+m+".min.js"),l.postMessage=l.webkitPostMessage||l.postMessage,l.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);l.postMessage({m:"test",ab:e},[e]),c=!e.byteLength,t.isBuffer=c}this.initPhysics(t)}else t.devMode?this.preLoad(m,t,n):this.preLoadMin(m,t,n)},this.supportModuleWorker=()=>{let t=!1;const e={get type(){t=!0}};try{new Worker("data:,",e).terminate()}finally{return t}},this.onCompactDone=t=>{let e=this.engine.toLowerCase(),i=e.charAt(0).toUpperCase()+e.slice(1),s=r?Le.get(i+".module","H"):Le.get(i,"H");if(h){let e;try{e=new Blob([s],{type:"application/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,e=new BlobBuilder,e.append(s),e=e.getBlob()}if(l=r?new Worker(URL.createObjectURL(e),{type:"module"}):new Worker(URL.createObjectURL(e)),l.postMessage=l.webkitPostMessage||l.postMessage,l.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);l.postMessage({m:"test",ab:e},[e]),c=!e.byteLength,t.isBuffer=c}this.initPhysics(t)}else{let i=e.toUpperCase(),r=document.createElement("script");r.language="javascript",r.type="text/javascript",r.charset="utf-8",r.async=!0,r.innerHTML=s,document.getElementsByTagName("head")[0].appendChild(r),v=window[i].engine.message,t.message=this.message,this.initPhysics(t)}},this.loadWasmDirect=(t,e,i,s)=>{let r=document.createElement("script");r.src=s+t,document.body.appendChild(r),r.onload=()=>{this.preLoad(i,e,s)}},this.preLoadMin=(t,e,i)=>{let s=i+"build/"+t+".min.js",r=t.toUpperCase();var n=new XMLHttpRequest;n.open("GET",s),n.overrideMimeType("text/javascript"),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status||0===n.status){let t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.charset="utf-8",t.async=!0,t.innerHTML=n.responseText,document.getElementsByTagName("head")[0].appendChild(t),v=window[r].engine.message,e.message=this.message,this.initPhysics(e)}else console.error("Couldn't load ["+t+"] ["+n.status+"]")}.bind(this),n.send(null)},this.preLoad=async(t,e,i)=>{let s=i+"build/"+t+".module.js";e.devMode&&(s=i+"src/"+t+".js");let r=await import(s);v=r.engine.message,e.message=this.message,this.initPhysics(e)},this.initPhysics=t=>{""===T?(this.post({m:"init",o:t}),p=!0):this.preloadEnvmap(t)},this.addEnvmap=t=>(z||(z=new sn({renderer:P,scene:C,...t})),z),this.preloadEnvmap=t=>{z=new sn({url:T,renderer:P,scene:C,usePmrem:t.usePmrem,useBackground:void 0===t.useBackground||t.useBackground,envBlur:void 0!==t.envBlur?t.envBlur:0,callback:()=>{T="",this.initPhysics(t)}})},this.getPause=()=>b,this.pause=t=>{t!==b&&(b=t,b?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:b}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=t=>{if(x)return x=!1,void t();F=[],a=null,n=!1,w&&w.resetAll(),y&&y.unSelect(),i&&(i.dispose(),i=null),I=t,O=function(){},this.collision.reset(),this.clearText(),this.clearSoftSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.garbage=[],U=null,null!==m&&(m=null),null!==this.debuger&&this.removeDebuger(),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset",o:{}})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=t=>{this.reset(t)},this.resetCallback=()=>{I()},this.dispose=()=>{this.reset((()=>{l&&(l.terminate(),l=null),f&&(e.scene.parent.remove(e.scene),e.scenePlus.parent.remove(e.scenePlus),f=!1)}))},this.ready=()=>{_.end=ti.now(),_.startTime=ti.format_time(_.end-_.start),console.log("%c"+this.engine+" %c"+ha[this.engine]+"%c | "+(r?"Module ":"")+(h?"Worker":"Direct")+" "+_.startTime,"font-size:16px","font-size:12px","font-size:12px"),o&&o()},this.start=(t={})=>{this.post({m:"start",o:t})},this.morph=(t,e,i)=>{this.utils.morph(t,e,i)},this.getFps=()=>this.reflow.stat.fps,this.getMs=()=>this.reflow.stat.ms.toFixed(1),this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>A,this.setDelta=t=>{E.delta=t},this.getDelta=()=>E.delta,this.getElapsedTime=()=>E.elapsedTime,this.doStep=t=>{p&&d&&E.up(t)&&this.post({m:"step",o:t})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=R.update(),this.flow.current=null!==a?a.name:"",this.stepItems(),this.collision.step(),y&&y.step(),null!==a&&a.move(),null!==this.debuger&&this.debuger.draw();let t=d?E.delta:this.delta;O(t),this.changes(this.flow.tmp),c?this.post({m:"poststep",flow:this.flow,Ar:q},[q.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(t=!1)=>{W={...We(this.engine,t)}},this.takeControl=(t=null)=>{this.control(t)},this.control=(t=null)=>{null!==a?null===t?(a.isPlayer&&(a.isPlayer=!1),a=null):t!==a.name&&(a=this.byName(t),a&&(a.isPlayer=!0)):null!==t&&(a=this.byName(t),a&&(a.isPlayer=!0))},this.getAllBody=t=>j.body.list,this.activeContact=()=>{n||(n=!0,this.post({m:"activeContact",o:{}}))},this.addCollision=t=>{this.collision.add(t)},this.removeCollision=t=>{this.collision.remove(t)},this.initItems=()=>{j.body=new Li(e),j.ray=new ri(e),j.joint=new Bi(e),j.solid=new ua(e),j.contact=new Ni(e),j.terrain=new Ts(e),j.character=new ws(e),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(j.vehicle=new qi(e)),"PHYSX"===this.engine&&(j.solver=new Ps(e))},this.getBodyRef=()=>j.body,this.getCharacterRef=()=>j.character,this.getGeometryRef=(t,e,i)=>{j.body.geometry(t,e,i)},this.clearBody=()=>{j.body.reset()},this.resetItems=()=>{Object.values(j).forEach((t=>t.reset()))},this.stepItems=()=>{Object.values(j).forEach((t=>t.step(q,W[t.type]))),this.upInstance(),this.upButton()},this.getTransform=t=>j.body.getTransform(t),this.upInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.dispose())),this.instanceMesh={}},this.adds=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.add(t[s++],e)},this.add=(t={},e=!1)=>{if(t.isObject3D)return this.addDirect(t);if(t.constructor===Array)return this.adds(t,e);if("container"===t.type)return new Fs(t,this);void 0!==t.bounce&&(t.restitution=t.bounce),void 0===t.type&&(t.type="box"),void 0!==t.mode&&(t.type="joint");let i=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.mass||t.density||t.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return t.type}}(t);"joint"===i&&void 0===t.mode&&(t.mode=t.type,t.type="joint");let s=j[i].add(t);return this.garbage.push(s.name),s},this.addDirect=t=>(this.scenePlus.add(t),this.tmpMesh.push(t),t),this.removes=(t=[],e)=>{let i=t.length,s=0;for(;i--;)this.remove(t[s++],e)},this.remove=(t,e=!1)=>{if(t.constructor===Array)return this.removes(t,e);let i=this.byName(t);null!==i?(this.removeCollision(t),"autoRagdoll"!==i.type?(i.extraRemove&&i.extraRemove(),j[i.type].clear(i),this.post({m:"remove",o:{name:t,type:i.type}},null,e)):this.utils.remove(i)):this.instanceMesh[t]&&j.body.clearInstance(t)},this.changes=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.changeOne(t[s++],e)},this.change=(t,e=!1)=>{e?t instanceof Array?this.changes(t,!0):this.changeOne(t,!0):t instanceof Array?this.flow.tmp.push(...t):this.flow.tmp.push(t)},this.changeOne=(t={},e=!1)=>{if(t.heightData)return;let i=this.byName(t.name);if(null===i)return null;let s=i.type;switch(t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=xe.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot),void 0!==t.rot&&(t.quat=xe.quatFromEuler(t.rot),delete t.rot),void 0!==t.localRot&&(t.quat=xe.toLocalQuatArray(t.localRot,i),delete t.localRot),s){case"terrain":i=j.terrain.set(t,i),e=!1;break;case"ray":i=j.ray.set(t,i),e=!1;break;case"character":i=j.character.set(t,i);break;case"solid":i=j.solid.set(t,i);break;case"joint":i=j.joint.set(t,i);break;case"body":i.isKinematic||(i.actif&&!i.sleep||j.body.set(t,i),t.sleep&&j.body.set(t,i))}e&&this.post({m:"change",o:t},null,e)},this.setControl=t=>{w=t,L=w.getAzimuthalAngle},this.getControl=()=>w,this.getCurrentCharacterPosition=()=>w.followGroup.position,this.getCamera=(t={})=>w.object,this.setCamera=(t={})=>{w.moveCam(t)},this.follow=(t="",e={})=>{let i=null;"string"==typeof t||t instanceof String?i=""===t?null:this.byName(t):t.isObject3D&&(i=t),null===i?w.resetFollow():w.startFollow(i,e)},this.setTimeout=(t,e=0,i=!1)=>{i?M=setTimeout(t,e):(k=t,S=e,M=setTimeout(k,S))},this.playtimout=()=>{null!==k&&(M=setTimeout(k,S))},this.pausetimout=()=>{null!==M&&clearTimeout(M)},this.cleartimout=(t,e)=>{null!==M&&(k=null,S=0,clearTimeout(M),M=null)},this.texture=(t={})=>Le.texture(t),this.getTexture=(t,e={})=>Le.getTexture(t,e),this.setExtendShader=t=>{this.mat.extendShader=t},this.addMaterial=(t,e)=>{this.mat.set(t,e)},this.directIntensity=t=>{},this.setEnvmapIntensity=t=>{},this.getMatRef=()=>this.mat,this.getMat=t=>this.mat.get(t),this.getMaterial=t=>this.mat.get(t),this.getMaterialList=()=>this.mat.getList(),this.material=(t={})=>this.mat.create(t),this.changeRenderMode=t=>this.mat.changeRenderMode(t),this.load=Le.load,this.get=Le.get,this.getGroup=Le.getGroup,this.getScript=Le.getScript,this.preload=(t,e)=>{gs.add(t,e)},this.applyMorph=(t,e=null,i=!0,s=!0)=>{Le.applyMorph(t,null,!0,!0)},this.getMesh=(t,e,i)=>{if(e){let e=Le.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return Le.getMesh(t,i)},this.getGlb=(t,e,i)=>{if(e){let e=Le.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return Le.getGLB(t,i)},this.getGlbMaterial=t=>{let e=Le.getMaterials(t);return this.mat.addToMat(e),e},this.poolDispose=()=>Le.dispose(),this.setDracoPath=t=>Le.dracoPath=t,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addSoftSolver=t=>{let e=new Mr(t,this);return N.push(e),e},this.updateSoftSolver=()=>{let t=N.length;for(;t--;)N[t].update()},this.clearSoftSolver=()=>{N.length,N=[]},this.addButton=t=>{let e=new Is(t,this);return F.push(e),e},this.upButton=t=>{for(const t in F)F[t].update()},this.addText=t=>{let e=new _s(t);return t.parent?t.parent.add(e):this.scenePlus.add(e),B.push(e),e},this.clearText=()=>{let t=B.length;for(;t--;)B[t].dispose();B=[]},this.screenshot=()=>{var t=window.open("","");t.document.title="Screenshot",t.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var e=new Image;P.render(C,this.getCamera()),e.src=P.domElement.toDataURL(),t.document.body.appendChild(e)},this.getBreaker=()=>(null!==m||(m=new fr(this)),m),this.setColorChecker=t=>{U=t},this.getColorChecker=()=>U,this.addWiggle=(t={})=>{},this.initParticleEngine=()=>{i||(i=new la,this.scene.add(i))},this.addParticle=(t={})=>(null===i&&this.initParticleEngine(),i.add(t)),this.getParticle=t=>null===i?null:i.get(t),this.explosion=(t=[0,0,0],e=10,i=1)=>{let s=[],r=new nt;t&&(t.isVector3?r.copy(t):r.fromArray(t));let n,a,o=new nt,l=j.body.list.length;for(;l--;)n=j.body.list[l],o.copy(n.position).sub(r),a=1-o.length()/e,n.isKinematic||a<0||(o.setLength(a),o.multiplyScalar(i),s.push({name:n.name,impulse:o.toArray(),wake:!0}));this.change(s)}}set onStep(t){this.setStep(t)}}class ua extends Li{constructor(t){super(t),this.type="solid"}step(){}}class da{constructor(t){this.map=new Map,this.motor=t}byName(t){return this.map.has(t)?this.map.get(t):null}add(t,e){if("contact"!==t.type&&!t.isInstance&&t.isObject3D)if(e)e.add(t);else if(t.isButton)this.motor.scene.add(t);else switch(t.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(t);break;default:this.motor.scene.add(t)}t.isInstance&&t.refName!==t.name&&this.map.set(t.refName,t),this.map.set(t.name,t)}remove(t){t.dispose&&t.dispose(),t.parent&&t.parent.remove(t),t.isInstance&&(t.refName!==t.name&&this.map.delete(t.refName),t.instance.remove(t.idx)),this.map.delete(t.name)}noRay(t){t.isObject3D&&(t.raycast=()=>{},t.traverse((t=>{t.isObject3D&&(t.raycast=()=>{})})))}morph(t,e,i){t.morphTargetInfluences&&void 0!==t.morphTargetDictionary[e]&&(t.morphTargetInfluences[t.morphTargetDictionary[e]]=i)}toLocal(t,e,i=!1){i||t.sub(e.position);let s=e.quaternion;return t.applyQuaternion({x:-s._x,y:-s._y,z:-s._z,w:s._w}),t}quatLocal(t,e){e.isObject3D&&e.updateWorldMatrix(!0,!1);let i=(new lt).fromArray(t),s=e.quaternion.clone().invert();return i.premultiply(s),i.normalize().toArray()}axisLocal(t,e){e.isObject3D&&e.updateWorldMatrix(!0,!1);let i=(new gt).setFromMatrix4(e.matrixWorld);return(new nt).fromArray(t).applyMatrix3(i).toArray()}quatToAngular(t,e){e[0]*=-1,e[1]*=-1,e[2]*=-1;let i,s=e[0]*t[3]+e[3]*t[0]+e[1]*t[2]-e[2]*t[1],r=e[1]*t[3]+e[3]*t[1]+e[2]*t[0]-e[0]*t[2],n=e[2]*t[3]+e[3]*t[2]+e[0]*t[1]-e[1]*t[0],a=e[3]*t[3]-e[0]*t[0]-e[1]*t[1]-e[2]*t[2],o=2*Math.acos(a),l=Math.sqrt(1-a*a);i=l<.001?[0,0,0]:[s/l,r/l,n/l];(new nt).fromArray(i).multiplyScalar(o/1)}refAxis(t,e){let i=(new nt).fromArray(e),s=new nt(1,0,0),r=new nt(0,1,0);Math.abs(e[1])>.9999||s.copy(i).cross(r).normalize(),r.copy(s).cross(i).normalize(),t.makeBasis(s,r,i)}}const pa=new ca,ma=ca,fa=xe,ga=Le;export{fa as math,pa as phy,ma as phy2,ga as pool};
