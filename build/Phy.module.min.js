/**
 * @license
 * Copyright 2010-2025 Phy.js Authors
 * SPDX-License-Identifier: MIT
 */
import{LineSegments as e,BufferGeometry as t,BufferAttribute as i,Float32BufferAttribute as s,LineBasicMaterial as a,SphereGeometry as r,CylinderGeometry as n,BoxGeometry as l,PlaneGeometry as h,CanvasTexture as c,RepeatWrapping as A,SRGBColorSpace as u,MeshPhysicalMaterial as d,Color as p,Vector2 as g,MeshStandardMaterial as f,ShadowMaterial as b,MeshToonMaterial as y,MeshBasicMaterial as w,MeshLambertMaterial as I,MeshPhongMaterial as E,DoubleSide as C,BackSide as v,FrontSide as B,SrcAlphaSaturateFactor as x,OneMinusDstColorFactor as k,DstColorFactor as Q,OneMinusDstAlphaFactor as S,DstAlphaFactor as M,OneMinusSrcAlphaFactor as R,SrcAlphaFactor as D,OneMinusSrcColorFactor as T,SrcColorFactor as F,OneFactor as L,ZeroFactor as P,MaxEquation as _,MinEquation as z,ReverseSubtractEquation as U,SubtractEquation as N,AddEquation as G,MultiplyBlending as O,SubtractiveBlending as q,AdditiveBlending as j,NormalBlending as H,NoBlending as V,Line as K,Vector3 as W,Matrix4 as J,InstancedMesh as X,Quaternion as Y,Mesh as Z,InstancedBufferAttribute as $,CircleGeometry as ee,Box3 as te,Object3D as ie,Line3 as se,Plane as ae,Triangle as re,Loader as ne,FileLoader as oe,Matrix3 as le,Box2 as he,ShapeUtils as ce,Shape as Ae,Path as ue,ShapePath as de,ShapeGeometry as pe,Euler as ge,TrianglesDrawMode as me,TriangleFanDrawMode as fe,TriangleStripDrawMode as be,LoaderUtils as ye,LinearSRGBColorSpace as we,SpotLight as Ie,PointLight as Ee,DirectionalLight as Ce,TextureLoader as ve,ImageBitmapLoader as Be,InterleavedBuffer as xe,InterleavedBufferAttribute as ke,LinearMipmapLinearFilter as Qe,NearestMipmapLinearFilter as Se,LinearMipmapNearestFilter as Me,NearestMipmapNearestFilter as Re,LinearFilter as De,NearestFilter as Te,MirroredRepeatWrapping as Fe,ClampToEdgeWrapping as Le,PointsMaterial as Pe,Material as _e,PropertyBinding as ze,SkinnedMesh as Ue,LineLoop as Ne,Points as Ge,Group as Oe,PerspectiveCamera as qe,MathUtils as je,OrthographicCamera as He,Skeleton as Ve,AnimationClip as Ke,Bone as We,InterpolateDiscrete as Je,InterpolateLinear as Xe,Texture as Ye,VectorKeyframeTrack as Ze,NumberKeyframeTrack as $e,QuaternionKeyframeTrack as et,ColorManagement as tt,Interpolant as it,Sphere as st,Vector4 as at,Curve as rt,EquirectangularReflectionMapping as nt,AmbientLight as ot,Uint16BufferAttribute as lt,DataTextureLoader as ht,HalfFloatType as ct,FloatType as At,DataUtils as ut,RGBAFormat as dt,RedFormat as pt,NoColorSpace as gt,DataTexture as mt,UVMapping as ft,LinearMipMapLinearFilter as bt,RGBA_S3TC_DXT1_Format as yt,RGB_PVRTC_4BPPV1_Format as wt,RGB_ETC2_Format as It,RGB_ETC1_Format as Et,RGBA_S3TC_DXT5_Format as Ct,RGBA_PVRTC_4BPPV1_Format as vt,RGBA_ETC2_EAC_Format as Bt,RGBA_BPTC_Format as xt,RGB_BPTC_UNSIGNED_Format as kt,RGBA_ASTC_4x4_Format as Qt,UnsignedByteType as St,CompressedCubeTexture as Mt,CompressedArrayTexture as Rt,CompressedTexture as Dt,RGBA_S3TC_DXT3_Format as Tt,RGB_S3TC_DXT1_Format as Ft,RGBA_ASTC_6x6_Format as Lt,RGFormat as Pt,Data3DTexture as _t,LoadingManager as zt,AnimationMixer as Ut,ObjectSpaceNormalMap as Nt,CustomBlending as Gt,SkeletonHelper as Ot,AnimationUtils as qt,AdditiveAnimationBlendMode as jt,NormalAnimationBlendMode as Ht,Raycaster as Vt,PMREMGenerator as Kt,Scene as Wt,WebGLCubeRenderTarget as Jt,CubeCamera as Xt,IcosahedronGeometry as Yt,ShaderMaterial as Zt,NoToneMapping as $t,AxesHelper as ei,InstancedBufferGeometry as ti,InstancedInterleavedBuffer as ii,DynamicDrawUsage as si}from"three";const ai=Math.PI,ri=ai/180,ni=180/ai,oi=Number.EPSILON,li=.5*ai,hi={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:e=>Math.pow(e,5),candelaToLumens:e=>4*e*Math.PI,lumensToCandela:e=>e/(4*Math.PI),todeg:ni,torad:ri,toFixed:(e,t=3)=>1*e.toFixed(t),toRound:(e,t=3)=>Math.trunc(e),clamp:(e,t=0,i=1)=>e=(e=e<t?t:e)>i?i:e,clampA:(e,t,i)=>Math.max(t,Math.min(i,e)),smoothstep:(e,t,i)=>e*(i=-2*(i=hi.clamp(i))*i*i+3*i*i)+t*(1-i),remap:(e,t,i,s,a)=>s+(e-t)*(a-s)/(i-t),lerp:(e,t,i)=>(1-i)*e+i*t,damp:(e,t,i,s)=>hi.lerp(e,t,1-Math.exp(-i*s)),nearAngle:(e,t,i=!1)=>t+Math.atan2(Math.sin(e-t),Math.cos(e-t))*(i?ni:1),unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),nearEquals:(e,t,i=1e-4)=>Math.abs(e-t)<=i,autoSize:(e=[1,1,1],t="box")=>{1===e.length&&(e[1]=e[0]);let i=e[0],s=e[1];return"sphere"===t&&(e=[i,i,i]),"cylinder"!==t&&"wheel"!==t&&"capsule"!==t||(e=[i,s,i]),"cone"!==t&&"pyramid"!==t||(e=[i,s,i]),2===e.length&&(e[2]=e[0]),e},shuffle:e=>{let t=e.map((e=>({value:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({value:e})=>e));return t},randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),randIntUnic:(e,t,i)=>{for(var s=[];s.length<i;){var a=hi.randInt(e,t);-1===s.indexOf(a)&&s.push(a)}return s},fromTransform:(e,t,i,s=[0,0,0,1],a=!1)=>{let r=hi.composeMatrixArray(e,t),n=hi.composeMatrixArray(i,s);return a&&(r=hi.invertMatrixArray(r)),r=hi.multiplyMatrixArray(r,n),[r[12],r[13],r[14]]},fromTransformToQ:(e,t,i=!1)=>{let s=hi.composeMatrixArray(e,t),a=hi.decomposeFullMatrixArray(s).q;return i&&(a=hi.quatInvert(a)),a},lerpTransform:(e,t,i)=>{let s=e[0],a=e[1],r=t[0],n=t[1];return r=hi.lerpArray(s,r,i),n=hi.slerpQuatArray(a,n,i),[r,n]},composeMatrixArray:(e,t,i=[1,1,1])=>{const s=t[0],a=t[1],r=t[2],n=t[3],o=s+s,l=a+a,h=r+r,c=s*o,A=s*l,u=s*h,d=a*l,p=a*h,g=r*h,m=n*o,f=n*l,b=n*h,y=i[0],w=i[1],I=i[2];return[(1-(d+g))*y,(A+b)*y,(u-f)*y,0,(A-b)*w,(1-(c+g))*w,(p+m)*w,0,(u+f)*I,(p-m)*I,(1-(c+d))*I,0,e[0],e[1],e[2],1]},multiplyMatrixArray:(e,t)=>{const i=e,s=t,a=[],r=i[0],n=i[4],o=i[8],l=i[12],h=i[1],c=i[5],A=i[9],u=i[13],d=i[2],p=i[6],g=i[10],m=i[14],f=i[3],b=i[7],y=i[11],w=i[15],I=s[0],E=s[4],C=s[8],v=s[12],B=s[1],x=s[5],k=s[9],Q=s[13],S=s[2],M=s[6],R=s[10],D=s[14],T=s[3],F=s[7],L=s[11],P=s[15];return a[0]=r*I+n*B+o*S+l*T,a[4]=r*E+n*x+o*M+l*F,a[8]=r*C+n*k+o*R+l*L,a[12]=r*v+n*Q+o*D+l*P,a[1]=h*I+c*B+A*S+u*T,a[5]=h*E+c*x+A*M+u*F,a[9]=h*C+c*k+A*R+u*L,a[13]=h*v+c*Q+A*D+u*P,a[2]=d*I+p*B+g*S+m*T,a[6]=d*E+p*x+g*M+m*F,a[10]=d*C+p*k+g*R+m*L,a[14]=d*v+p*Q+g*D+m*P,a[3]=f*I+b*B+y*S+w*T,a[7]=f*E+b*x+y*M+w*F,a[11]=f*C+b*k+y*R+w*L,a[15]=f*v+b*Q+y*D+w*P,a},invertMatrixArray:e=>{const t=e,i=t[0],s=t[1],a=t[2],r=t[3],n=t[4],o=t[5],l=t[6],h=t[7],c=t[8],A=t[9],u=t[10],d=t[11],p=t[12],g=t[13],m=t[14],f=t[15],b=A*m*h-g*u*h+g*l*d-o*m*d-A*l*f+o*u*f,y=p*u*h-c*m*h-p*l*d+n*m*d+c*l*f-n*u*f,w=c*g*h-p*A*h+p*o*d-n*g*d-c*o*f+n*A*f,I=p*A*l-c*g*l-p*o*u+n*g*u+c*o*m-n*A*m,E=i*b+s*y+a*w+r*I;if(0===E)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const C=1/E;return t[0]=b*C,t[1]=(g*u*r-A*m*r-g*a*d+s*m*d+A*a*f-s*u*f)*C,t[2]=(o*m*r-g*l*r+g*a*h-s*m*h-o*a*f+s*l*f)*C,t[3]=(A*l*r-o*u*r-A*a*h+s*u*h+o*a*d-s*l*d)*C,t[4]=y*C,t[5]=(c*m*r-p*u*r+p*a*d-i*m*d-c*a*f+i*u*f)*C,t[6]=(p*l*r-n*m*r-p*a*h+i*m*h+n*a*f-i*l*f)*C,t[7]=(n*u*r-c*l*r+c*a*h-i*u*h-n*a*d+i*l*d)*C,t[8]=w*C,t[9]=(p*A*r-c*g*r-p*s*d+i*g*d+c*s*f-i*A*f)*C,t[10]=(n*g*r-p*o*r+p*s*h-i*g*h-n*s*f+i*o*f)*C,t[11]=(c*o*r-n*A*r-c*s*h+i*A*h+n*s*d-i*o*d)*C,t[12]=I*C,t[13]=(c*g*a-p*A*a+p*s*u-i*g*u-c*s*m+i*A*m)*C,t[14]=(p*o*a-n*g*a-p*s*l+i*g*l+n*s*m-i*o*m)*C,t[15]=(n*A*a-c*o*a+c*s*l-i*A*l-n*s*u+i*o*u)*C,t},matrixArrayDeterminant:e=>{const t=e,i=t[0],s=t[4],a=t[8],r=t[12],n=t[1],o=t[5],l=t[9],h=t[13],c=t[2],A=t[6],u=t[10],d=t[14];return t[3]*(+r*l*A-a*h*A-r*o*u+s*h*u+a*o*d-s*l*d)+t[7]*(+i*l*d-i*h*u+r*n*u-a*n*d+a*h*c-r*l*c)+t[11]*(+i*h*A-i*o*d-r*n*A+s*n*d+r*o*c-s*h*c)+t[15]*(-a*o*c-i*l*A+i*o*u+a*n*A-s*n*u+s*l*c)},decomposeMatrixArray:e=>[e[12],e[13],e[14]],decomposeFullMatrixArray:e=>{const t=e;let i=hi.lengthArray([t[0],t[1],t[2]]);const s=hi.lengthArray([t[4],t[5],t[6]]),a=hi.lengthArray([t[8],t[9],t[10]]);hi.matrixArrayDeterminant(e)<0&&(i=-i);let r=[...e];const n=1/i,o=1/s,l=1/a;r[0]*=n,r[1]*=n,r[2]*=n,r[4]*=o,r[5]*=o,r[6]*=o,r[8]*=l,r[9]*=l,r[10]*=l;let h=hi.quatFromRotationMatrix(r);return{p:[e[12],e[13],e[14]],q:h,s:[i,s,a]}},applyTransformArray:(e,t,i,s=[1,1,1])=>{const a=hi.composeMatrixArray(t,i,s),r=e[0],n=e[1],o=e[2],l=1/(a[3]*r+a[7]*n+a[11]*o+a[15]);return[(a[0]*r+a[4]*n+a[8]*o+a[12])*l,(a[1]*r+a[5]*n+a[9]*o+a[13])*l,(a[2]*r+a[6]*n+a[10]*o+a[14])*l]},slerpQuatArray:(e,t,i)=>{if(0===i)return e;if(1===i)return t;let s=[...e];const a=e[0],r=e[1],n=e[2],o=e[3],l=t[0],h=t[1],c=t[2],A=t[3];let u=o*A+a*l+r*h+n*c;if(u<0?(s=[-l,-h,-c,-A],u=-u):s=[...t],u>=1)return e;const d=1-u*u;if(d<=oi){const e=1-i;return s[3]=e*o+i*s[3],s[0]=e*a+i*s[0],s[1]=e*r+i*s[1],s[2]=e*n+i*s[2],hi.quatNomalize(s)}const p=Math.sqrt(d),g=Math.atan2(p,u),m=Math.sin((1-i)*g)/p,f=Math.sin(i*g)/p;return s[3]=o*m+s[3]*f,s[0]=a*m+s[0]*f,s[1]=r*m+s[1]*f,s[2]=n*m+s[2]*f,s},toLocalQuatArray:(e=[0,0,0],t)=>{let i=hi.quatFromEuler(e),s=hi.quatInvert(t.quaternion.toArray());return hi.quatMultiply(s,i)},quatFromRotationMatrix:e=>{let t=[0,0,0,1];const i=e,s=i[0],a=i[4],r=i[8],n=i[1],o=i[5],l=i[9],h=i[2],c=i[6],A=i[10],u=s+o+A;if(u>0){const e=.5/Math.sqrt(u+1);t[3]=.25/e,t[0]=(c-l)*e,t[1]=(r-h)*e,t[2]=(n-a)*e}else if(s>o&&s>A){const e=2*Math.sqrt(1+s-o-A);t[3]=(c-l)/e,t[0]=.25*e,t[1]=(a+n)/e,t[2]=(r+h)/e}else if(o>A){const e=2*Math.sqrt(1+o-s-A);t[3]=(r-h)/e,t[0]=(a+n)/e,t[1]=.25*e,t[2]=(l+c)/e}else{const e=2*Math.sqrt(1+A-s-o);t[3]=(n-a)/e,t[0]=(r+h)/e,t[1]=(l+c)/e,t[2]=.25*e}return t},quatFromEuler:(e=[0,0,0],t=!0)=>{const i=Math.cos,s=Math.sin,a=t?ri:1,r=e[0]*a*.5,n=e[1]*a*.5,o=e[2]*a*.5,l=i(r),h=i(n),c=i(o),A=s(r),u=s(n),d=s(o);return[A*h*c+l*u*d,l*u*c-A*h*d,l*h*d+A*u*c,l*h*c-A*u*d]},quatFromAxis:(e=[0,0,0],t,i=!0)=>{const s=.5*t*(i?ri:1),a=Math.sin(s);return[e[0]*a,e[1]*a,e[2]*a,Math.cos(s)]},quatNomalize:e=>{let t=hi.lengthArray(e);return 0===t?[0,0,0,1]:(t=1/t,hi.scaleArray(e,t,4))},quatInvert:e=>[-e[0],-e[1],-e[2],e[3]],quatMultiply:(e,t)=>{const i=e[0],s=e[1],a=e[2],r=e[3],n=t[0],o=t[1],l=t[2],h=t[3];return[i*h+r*n+s*l-a*o,s*h+r*o+a*n-i*l,a*h+r*l+i*o-s*n,r*h-i*n-s*o-a*l]},quatToAxis:e=>{let t=2*Math.acos(e[3]);const i=Math.sqrt(1-e[3]*e[3]);return i<1e-4?[1,0,0]:[e[0]/i,e[1]/i,e[2]/i,t]},eulerFromMatrix:e=>{const t=e[0],i=e[4],s=e[8];e[1];const a=e[5],r=e[9];e[2];const n=e[6],o=e[10];let l=[0,0,0];return l[1]=Math.asin(hi.clamp(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(-r,o),l[2]=Math.atan2(-i,t)):(l[0]=Math.atan2(n,a),l[2]=0),l},angleTo:(e,t)=>2*Math.acos(Math.abs(hi.clamp(hi.dotArray(e,t),-1,1))),fixedArray:(e,t)=>{let i=e.length,s=[];for(;i--;)s[i]=hi.toFixed(e[i],t);return s},getSize:e=>.001*e.byteLength+"kb",perpendicularArray:e=>{const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);let i=Math.acos(e[1]/t);const s=Math.atan2(e[2],e[0]);i>li?i-=li:i+=li;return[t*Math.sin(i)*Math.cos(s),t*Math.cos(i),t*Math.sin(i)*Math.sin(s)]},crossArray:(e,t)=>{const i=e[0],s=e[1],a=e[2],r=t[0],n=t[1],o=t[2];return[s*o-a*n,a*r-i*o,i*n-s*r]},applyQuaternion:(e,t)=>{const i=e[0],s=e[1],a=e[2],r=t[0],n=t[1],o=t[2],l=t[3],h=2*(n*a-o*s),c=2*(o*i-r*a),A=2*(r*s-n*i);return[i+l*h+n*A-o*c,s+l*c+o*h-r*A,a+l*A+r*c-n*h]},nullArray:(e,t,i)=>{let s=0;for(;i--;)s+=e[t+i];return s},equalArray:(e,t)=>{let i=e.length;for(;i--;)if(e[i]!==t[i])return!1;return!0},lerpArray:(e,t,i)=>{if(0===i)return e;if(1===i)return t;let s=e.length,a=[];for(;s--;)a[s]=e[s],a[s]+=(t[s]-a[s])*i;return a},zeroArray:(e,t=0,i)=>{for(i=i??e.length;i--;)e[t+i]=0;return e},lengthArray:e=>{let t=e.length,i=0;for(;t--;)i+=e[t]*e[t];return Math.sqrt(i)},dotArray:(e,t)=>{let i=e.length,s=0;for(;i--;)s+=e[i]*t[i];return s},addArray:(e,t,i)=>{i=i??e.length;let s=[];for(;i--;)s[i]=e[i]+t[i];return s},subArray:(e,t,i)=>{i=i??e.length;let s=[];for(;i--;)s[i]=e[i]-t[i];return s},mulArray:(e,t,i)=>{if(t instanceof Array){let s=[];for(i=i??e.length;i--;)s[i]=e[i]*t[i];return s}return e.map((e=>e*t))},worldscale:(e,t)=>e.map((e=>e*t)),divArray:(e,t,i)=>hi.mulArray(e,1/t,i),scaleArray:(e,t,i)=>hi.mulArray(e,t,i),fillArray:(e,t,i=0,s)=>{for(s=s??e.length;s--;)t[i+s]=e[s]},copyArray:(e,t)=>{},cloneArray:e=>[...e],distanceArray:(e,t=[0,0,0])=>hi.lengthArray(hi.subArray(e,t)),normalizeArray:e=>hi.divArray(e,hi.lengthArray(e)||1),normalArray:(e,t=[0,0,0])=>hi.normalizeArray(hi.subArray(t,e)),getCenter:(e,t)=>(e.computeBoundingBox(),e.boundingBox.getCenter(t)),getVolume:(e,t,i=null)=>{let s=1,a=t;switch(e){case"sphere":s=4*Math.PI*a[0]*a[0]*a[0]/3;break;case"cone":s=Math.PI*a[0]*(.5*a[1])*2;break;case"box":s=.5*a[0]*8*(.5*a[1])*(.5*a[2]);break;case"cylinder":s=Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"capsule":s=4*Math.PI*a[0]*a[0]*a[0]/3+Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"convex":case"mesh":s=hi.getConvexVolume(i)}return s},getConvexVolume:e=>{let t,i=e.length/3,s=[0,0,0],a=[0,0,0];for(;i--;)t=3*i,e[t]<s[0]?s[0]=e[t]:e[t]>a[0]&&(a[0]=e[t]),e[t+1]<s[1]?s[1]=e[t+1]:e[t+1]>a[1]&&(a[1]=e[t+1]),e[t+2]<s[2]?s[2]=e[t+2]:e[t+2]>a[2]&&(a[2]=e[t+2]);let r=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])},massFromDensity:(e,t)=>e*t,densityFromMass:(e,t)=>e/t,toNonIndexed:e=>e.index?e.clone().toNonIndexed():e,getIndex:(e,t)=>!e.index||t?null:e.index.array||null,getSameVertex:e=>{const t=e.getAttribute("position"),i=t.array,s=[],a=[],r={};new THREE.Vector3;let n,o=0;hi.getHash(e);let l,h,c=!1,A=0;for(let e=0;e<t.count;e++){o=3*e,l={x:i[o],y:i[o+1],z:i[o+2],id:e},c=!1,n=s.length;for(let t=0;t<n;t++)h=s[t],l.x===h.x&&l.y===h.y&&l.z===h.z&&(c=!0,r[e]=h.id);c||(l.id=A++,s.push(l),a.push([l.x,l.y,l.z]))}return[a,r]},getVertex:(e,t)=>{let i=e.attributes.position.array;return t&&e.index&&(i=(e=e.clone().toNonIndexed()).attributes.position.array),i},getNormal:e=>e.attributes.normal.array,getFaces:e=>{let t=[];if(e.index){let i=e.getIndex();for(let e=0;e<i.count;e+=3)t.push([i.getX(e),i.getX(e+1),i.getX(e+2)])}else{let i=e.getAttribute("position").count;for(let e=0;e<i;e+=3)t.push([e,e+1,e+2])}return t},getConnectedFaces:e=>{const t=[];let i,s,a,r,n,o,l,h=e.length,c=h;for(;c--;)for(s=e[c],i=h;i--;)i!==c&&(a=e[i],r=s.filter((e=>a.includes(e))),r.length>1&&(l=[],n=[...s],o=n.indexOf(r[0]),n.splice(o,1),o=n.indexOf(r[1]),n.splice(o,1),l.push(n[0]),n=[...a],o=n.indexOf(r[0]),n.splice(o,1),o=n.indexOf(r[1]),n.splice(o,1),l.push(n[0]),t.push(l)));return t},reduce:e=>{},barycentric:(e,t)=>{},solve:(e,t)=>{},getHash:(e,t=1e-4)=>{t=Math.max(t,Number.EPSILON);const i={},s={},a=e.getAttribute("position"),r=a.count,n=a.array,o=.5*t,l=Math.log10(1/t),h=Math.pow(10,l),c=o*h;let A;for(let e=0;e<r;e++){A=3*e;let t=`${~~(n[A]*h+c)},${~~(n[A+1]*h+c)},${~~(n[A+2]*h+c)}`;i[t]?i[t].push(e):i[t]=[e]}let u=0;for(let e in i)s[u++]=i[e];return s}},ci=hi,Ai=["PHYSX","HAVOK"],ui=4e3,di=1e3,pi=4e3,gi=100,mi=100,fi=50,bi=20,yi={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},wi=function(e,t=!1){const i={};let s={body:ui*(t?yi.bodyFull:yi.body),joint:di*yi.joint,ray:gi*yi.ray,contact:pi*yi.contact,character:mi*yi.character};"PHYSX"!==e&&"AMMO"!==e||(s.vehicle=fi*yi.vehicle),"PHYSX"===e&&(s.solver=bi*yi.solver),"HAVOK"!==e&&"RAPIER"!==e&&"JOLT"!==e||(yi.joint=0);let a=0;for(let e in s)i[e]=a,a+=s[e];return i.total=a,i};class Ii extends e{constructor(e,r=16776960){const n=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),o=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],l=new t;l.setIndex(new i(n,1)),l.setAttribute("position",new s(o,3)),l.setAttribute("color",new s([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(l,new a({color:r,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=e,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}let Ei=class{constructor(){this.geoN=0,this.geo={}}unic(e){this.geo["geo"+this.geoN++]=e}set(e){this.geo[e.name]=e}get(e,t={}){if(!this.geo[e]){let t;switch(e){case"plane":t=new h(1,1),t.rotateX(.5*-Math.PI);break;case"box":t=new l(1,1,1);break;case"sphere":t=new r(1,16,12);break;case"cylinder":t=new n(1,1,1,16);break;case"cone":t=new n(.001,1,1,16);break;case"particle":t=new r(1,6,4);break;case"joint":t=(new Ii).geometry;break;default:return null}this.geo[e]=t}return this.geo[e]}dispose(){for(let e in this.geo)this.geo[e].isBufferGeometry?this.geo[e].dispose():console.log(this.geo[e]);this.geo={},this.geoN=0}};class Ci{constructor(e,t="rgb(69,69,69)",i="rgb(39,39,39)"){const s=document.createElement("canvas");s.width=s.height=128;const a=s.getContext("2d");if(a.fillStyle=t,a.fillRect(0,0,128,128),e){let s,r,n,o,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=e?"rgb(128,128,255)":t,A=e?"rgb(160,100,255)":i,u=e?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(a.strokeStyle=u,a.lineWidth=1,s=0;s<5;s++){o=a.createLinearGradient(0,h[s][0],0,h[s][1]),o.addColorStop(0,A),o.addColorStop(1,c),a.beginPath(),a.fillStyle=o,a.rect(l[s][0],l[s][1],32,64),a.fill();for(let e=0;e<8;e++)n=2*(Math.random()-.5),a.beginPath(),a.moveTo(l[s][0]+n+2+4*e,l[s][1]),a.lineTo(l[s][0]+n+2+4*e,l[s][1]+64),a.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],s=0;s<5;s++)for(o=a.createLinearGradient(h[s][0],0,h[s][1],0),o.addColorStop(0,c),o.addColorStop(1,A),a.beginPath(),a.fillStyle=o,a.rect(l[s][0],l[s][1],64,32),a.fill(),r=0;r<8;r++)n=2*(Math.random()-.5),a.beginPath(),a.moveTo(l[s][0],l[s][1]+n+2+4*r),a.lineTo(l[s][0]+64,l[s][1]+n+2+4*r),a.stroke()}else a.beginPath(),a.fillStyle=i,a.rect(0,0,32,64),a.rect(32,32,32,64),a.rect(64,64,32,64),a.rect(96,96,32,64),a.rect(96,-32,32,64),a.fill();const r=new c(s);return r.wrapS=r.wrapT=A,r.repeat.x=r.repeat.y=60,e||(r.colorSpace=u),r}}class vi extends d{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new p(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(e);let t=this;t.onBeforeCompile=function(e){for(let i in t.extra)e.uniforms[i]={value:t.extra[i]};e.fragmentShader=e.fragmentShader.replace("#include <common>",Bi.common),e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",t.replaceAll(xi,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",Bi.light)),t.userData.shader=e}}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.userData.shader&&(this.userData.shader.uniforms[e].value=this.extra[e])}})}replaceAll(e,t,i){return e.split(t).join(i)}}const Bi={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},xi="\n\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\n\tif ( material.iridescenceThickness == 0.0 ) {\n\n\t\tmaterial.iridescence = 0.0;\n\n\t} else {\n\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\n\t}\n\n\tif ( material.iridescence > 0.0 ) {\n\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\n\t}\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n\t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",ki={metalness:.1,roughness:.9},Qi={grey:new p(.18,.18,.18),black:new p(.039,.039,.039),body:new p(13289155),sleep:new p("hsl(33, 15%, 54%)"),solid:new p(7105128),base:new p(13224135),brick:new p(.262,.095,.061),sand:new p(.44,.386,.231),gold:new p(.944,.776,.373),gold2:new p(.998,.981,.751),titanium:new p(.633,.578,.503),titaniumSpec:new p(.728,.68,.55),chrome:new p(.653,.65,.615),chromeSpec:new p(.675,.72,.711),copper:new p(.988,.688,.448),carPaint:new p(.1037792,.59212029,.85064936),clay:new p("hsl(12, 30%, 40%)"),clayWhite:new p(11119017),concrete:new p(.51,.51,.51),Raw_Fire:new p("hsl(40, 18%, 54%)"),Raw_Buff:new p("hsl(33, 15%, 54%)"),Raw_Terracotta:new p("hsl(12, 30%, 40%)"),Raw_Porcelain:new p("hsl(45, 15%, 90%)")},Si={No:V,Normal:H,Additive:j,Subtractive:q,Multiply:O,Eadd:G,Esub:N,Erev:U,Emin:z,Emaw:_,Fzero:P,Fone:L,Fcolor:F,Fcolorm:T,Falpha:D,Falpham:R,Fdstalpha:M,Fdstalpham:S,Fdstcolor:Q,Fdstcolorm:k,Falphasaturate:x,Front:B,Back:v,Double:C};let Mi=class{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.extendMat=!1,this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(e){this.renderMode.value=e}initExtandShader(){}useRealLight(e){}setColor(e){}set(e,t,i=null){i||(i=e.onBeforeCompile),this.mat[e.name]=e}extendShader(e,t=null){}addToTmp(e){this.TmpMat.push(e)}create(e){let t,i=null;if(e.isMaterial)t=e;else{let s=void 0!==e.type?e.type:"Standard";switch(e.type&&delete e.type,i=e.beforeCompile||null,e.beforeCompile&&delete e.beforeCompile,(e.thickness||e.sheen||e.clearcoat||e.transmission||e.specularColor)&&(s="Physical"),e.normalScale&&(e.normalScale.isVector2||(e.normalScale=(new g).fromArray(e.normalScale))),e.side&&(e.side=this.findValue(e.side)),e.shadowSide&&(e.shadowSide=this.findValue(e.shadowSide)),e.blending&&(e.blending=this.findValue(e.blending)),e.blendEquation&&(e.blendEquation=this.findValue(e.blendEquation)),e.blendEquationAlpha&&(e.blendEquationAlpha=this.findValue(e.blendEquationAlpha)),e.blendSrc&&(e.blendSrc=this.findValue(e.blendSrc)),e.blendDst&&(e.blendDst=this.findValue(e.blendDst)),e.blendDstAlpha&&(e.blendDstAlpha=this.findValue(e.blendDstAlpha)),e.blendSrcAlpha&&(e.blendSrcAlpha=this.findValue(e.blendSrcAlpha)),e.clearcoatNormalScale&&(e.clearcoatNormalScale.isVector2||(e.clearcoatNormalScale=(new g).fromArray(e.clearcoatNormalScale))),s=s.toLowerCase(),s){case"physical":t=new d(e),t.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":t=new E(e);break;case"lambert":t=new I(e);break;case"basic":t=new w(e);break;case"line":t=new a(e);break;case"toon":t=new y(e);break;case"shadow":t=new b(e);break;case"sss":t=new vi(e);break;default:t=new f(e)}}return this.mat[t.name]?null:(this.set(t,!1,i),t)}findValue(e){return"string"===e?Si[e.charAt(0).toUpperCase()+e.slice(1)]:e}addToMat(e){if(this.isRealism)for(let t in e)e[t].onBeforeCompile=function(i){EnhanceLighting(i,this.realismOption),e[t].userData.isRealism=!0,e[t].userData.shader=i};this.mat={...this.mat,...e}}changeType(){}directIntensity(e){for(let e in this.mat);}getList(){let e={...this.mat};const t=["line","debug","hide","svg"];let i=t.length;for(;i--;)delete e[t[i]];return e}get(e){if(!this.mat[e])switch(e){case"grey":this.create({name:"grey",color:Qi.grey,metalness:0,roughness:.5});break;case"black":this.create({name:"black",color:Qi.black,metalness:0,roughness:.5});break;case"body":this.create({name:"body",color:Qi.body,...ki});break;case"sleep":this.create({name:"sleep",color:Qi.sleep,...ki});break;case"solid":this.create({name:"solid",color:Qi.solid,...ki});break;case"base":this.create({name:"base",color:Qi.base,...ki});break;case"clay":this.create({name:"clay",color:Qi.clay,metalness:.1,roughness:.7});break;case"clayWhite":this.create({name:"clayWhite",color:Qi.clayWhite,metalness:.1,roughness:.7});break;case"concrete":this.create({name:"concrete",color:Qi.concrete,metalness:0,roughness:.9});break;case"brick":this.create({name:"brick",color:Qi.brick,metalness:0,roughness:.6});break;case"sand":this.create({name:"sand",color:Qi.sand,metalness:0,roughness:.9});break;case"chrome":this.create({name:"chrome",color:Qi.chrome,specularColor:Qi.chromeSpec,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:Qi.gold,specularColor:Qi.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:Qi.copper,metalness:1,roughness:.05});break;case"titanium":this.create({name:"titanium",color:Qi.titanium,metalness:1,roughness:0,specularColor:Qi.titaniumSpec});break;case"carPaint":this.create({name:"carPaint",color:Qi.carPaint,metalness:0,anisotropy:new g(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new Ci,normalMap:new Ci(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...ki});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:C,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:16777215,alphaToCoverage:!0,transparent:!0,opacity:1,roughness:0,metalness:0,side:C,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.05,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0,specularIntensity:1,specularColor:16777215});break;case"plexi":this.create({name:"plexi",blending:j,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:C,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:j,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:C,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.create({name:"outline",color:16777215,type:"Basic",side:v,toneMapped:!1,wireframe:!0,transparent:!0,opacity:.25});break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...ki});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:16776960,transparent:!0,opacity:.2});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:C})}return this.mat[e]}dispose(){this.isRealism=!1;for(let e in this.mat)this.mat[e].dispose(),delete this.mat[e];let e=this.TmpMat.length;for(;e--;)this.TmpMat[e].dispose();this.TmpMat=[]}upShader(){let e=this.realismOption;for(let t in this.mat){const i=this.mat[t],s=i.userData.shader;for(let t in e)s&&void 0!==s.uniforms[t]&&(s.uniforms[t].value=e[t]),i[t]&&(i[t]=e[t])}}};class Ri{constructor(e=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(e),this.force=!1}up(e){let t=this.time;return this.unlimited&&(this.force=!0),t.now=void 0!==e?e:this.now(),t.delta=t.now-t.then,this.force&&(t.delta=t.interval,this.force=!1),!!(t.delta>=t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.interval,this.elapsedTime+=this.delta,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e,60===e&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(e){return e>1e3?e/1e3+" sec":e+" ms"}}class Di{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new Ti(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}setKey(e,t){this.key[e]=t}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,i=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,i[0]=1;break;case 68:case 39:t[0]=1,i[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,i[0]=1;break;case 68:t[0]=1,i[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,i[0]=1;break;case 39:t[2]=1,i[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,i=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],i[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],i[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],i[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],i[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],i[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],i[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}}}class Ti{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,i,s,a,r,n=this.fix,o=navigator.getGamepads();for(e=0;e<o.length;e++)if(r=o[e])if(i=r.axes.length,s=r.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<i;t++)a=n(r.axes[t],.08),0==this.ready&&0!==a&&(this.ready=1),this.values[e][t]=a;for(t=0;t<s;t++)a=n(r.buttons[t].value),0==this.ready&&0!==a&&(this.ready=1),this.values[e][i+t]=a}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,i=19;i--;)t=this.values[e][i],0==this.ready&&0!==t&&(this.ready=1),this.key[i]=t}reset(){this.ready=0}fix(e,t){let i=Number(e.toString().substring(0,5));return t&&i<t&&i>-t&&(i=0),i}}class Fi{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.list=[],this.id=0}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let i=this.byName(e);return i?this.clear(i,t):-1}clear(e,t){let i=this.list.indexOf(e);return-1===i||t?this.list[i]=null:this.list.splice(i,1),this.dispose(e),i}dispose(e){null!==e&&this.Utils.remove(e)}add(e={}){}set(e={}){}step(e,t){}}class Li extends Fi{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(e,t){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*yi.ray,i.update(e,s,this.motor.reflow.ray[a]||null)}add(e={}){this.setName(e);let t=new Pi(e,this.motor);return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&"string"!=typeof e.parent&&(e.parent=e.parent.name),e.callback&&delete e.callback,this.motor.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.setRay(e)}}class Pi extends K{constructor(e={},i){super(new t,i.getMat("line")),this.motor=i,this.Utils=this.motor.utils,this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=e.name,this.parentMesh=null,e.parent&&(this.parentMesh="string"==typeof e.parent?this.Utils.byName(e.parent):e.parent,this.data.parent=this.parentMesh),this.callback=e.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new W,this.end=new W(0,1,0),this.tmp=new W,this.vnormal=new W,this.vv1=new W,this.vv2=new W,this.fullDistance=0,this.setRay(e);this.geometry.setAttribute("position",new s([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new s([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.noRotation=e.noRotation||!1,this.fakeMatrix=new J,this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(e){e.begin&&this.begin.fromArray(e.begin),e.end&&this.end.fromArray(e.end),this.fullDistance=this.begin.distanceTo(this.end)}update(e,t=0,i=null){if(this.data.hit=0!==e[t],this.data.body=i||"",this.data.distance=e[t+1],this.data.hit)this.local[0]=e[t+2],this.local[1]=e[t+3],this.local[2]=e[t+4],this.tmp.fromArray(e,t+5),this.vnormal.fromArray(e,t+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(ci.angleTo(this.vv1.toArray(),this.data.normal)*ni);else if(this.parentMesh){let e;e=this.noRotation?this.fakeMatrix.setPosition(this.parentMesh.position.x,this.parentMesh.position.y,this.parentMesh.position.z):this.parentMesh.matrixWorld,this.tmp.copy(this.begin).applyMatrix4(e).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(e),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let e=this.vertices.array,t=this.colors.array,i=this.local,s=this.data.hit,a=s?this.c2:this.c1,r=s?this.c3:this.c1;t[3]=a[0],t[4]=a[1],t[5]=a[2],t[6]=r[0],t[7]=r[1],t[8]=r[2],e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}class _i extends X{constructor(e,t,i=0){super(e,t,i),this.matrixAutoUpdate=!1,this.tmpMatrix=new J,this.tmpQuat=new Y,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.outline=null,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(e){this.overMaterial&&(this.outline||(this.outline=new Z(this.geometry,this.overMaterial)),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e.idx),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=e.idx)}over(e){e&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!e&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new $(new Float32Array(3*this.instanceMatrix.count),3)),t.isColor&&(t=t.toArray());let i=3*e;this.instanceColor.array[i]=t[0],this.instanceColor.array[i+1]=t[1],this.instanceColor.array[i+2]=t[2]}add(e,t=[0,0,0],i=[0,0,0,1],s=[1,1,1],a=null,r=null){3===i.length&&(i=this.tmpQuat.setFromEuler({_x:i[0],_y:i[1],_z:i[2],_order:"XYZ"},!1).toArray()),a&&(a.isColor&&(a=a.toArray()),null===this.instanceColor&&(this.instanceColor=new $(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(t,i,s,a,r),this.tmpElement.push(e)}slice(e,t,i){let s=new Float32Array(i-t);for(let a=0;a<t+i;++a)s[a]=e[t+a];return s}remove(e){if(!this.count)return;this.tmpElement.splice(e,1);let t=[...this.instanceMatrix.array];t.splice(16*e,16),this.instanceMatrix=new $(new Float32Array(t),16),null!==this.instanceColor&&(t=[...this.instanceColor.array],t.splice(3*e,3),this.instanceColor=new $(new Float32Array(t),3)),null!==this.instanceUv&&(t=[...this.instanceUv.array],t.splice(2*e,2),this.instanceUv=new $(new Float32Array(t),2)),this.count--,this.reDistribute()}reDistribute(){let e=this.count;for(;e--;)this.tmpElement[e].idx=e}getIDName(e){return this.tmpElement[e].name}getBodyList(){let e=[],t=this.count;for(;t--;)e.push(this.tmpElement[t].name);return e}expand(e,t,i,s=[1,1,1],a){let r=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:t[0],_y:t[1],_z:t[2],_w:t[3]},{x:i[0],y:i[1],z:i[2]}),this.instanceMatrix=new $(new Float32Array([...r,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(r=this.instanceColor.array,this.instanceColor=new $(new Float32Array([...r,...s]),3)),this.count++}setTransformAt(e,t,i,s){this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*e),this.needSphereUp=!0,this.outline&&this.currentOver===e&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(e){void 0!==e&&(this.isRay=e)}raycast(e,t){this.isRay&&(this.instanceMatrix.needsUpdate=!0,super.raycast(e,t))}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp&&this.computeBoundingSphere(),this.needSphereUp=!1,this.updateMatrix()}}class zi{constructor(e=0,t=0,i=0,s=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=s}set(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}}function Ui(e,i=!1){const s=null!==e[0].index,a=new Set(Object.keys(e[0].attributes)),r=new Set(Object.keys(e[0].morphAttributes)),n={},o={},l=e[0].morphTargetsRelative,h=new t;let c=0;for(let t=0;t<e.length;++t){const A=e[t];let u=0;if(s!==(null!==A.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in A.attributes){if(!a.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===n[e]&&(n[e]=[]),n[e].push(A.attributes[e]),u++}if(u!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". Make sure all geometries have the same number of attributes."),null;if(l!==A.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in A.morphAttributes){if(!r.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[e]&&(o[e]=[]),o[e].push(A.morphAttributes[e])}if(i){let e;if(s)e=A.index.count;else{if(void 0===A.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". The geometry must have either an index or a position attribute"),null;e=A.attributes.position.count}h.addGroup(c,e,t),c+=e}}if(s){let t=0;const i=[];for(let s=0;s<e.length;++s){const a=e[s].index;for(let e=0;e<a.count;++e)i.push(a.getX(e)+t);t+=e[s].attributes.position.count}h.setIndex(i)}for(const e in n){const t=Ni(n[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;h.setAttribute(e,t)}for(const e in o){const t=o[e][0].length;if(0===t)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[e]=[];for(let i=0;i<t;++i){const t=[];for(let s=0;s<o[e].length;++s)t.push(o[e][s][i]);const s=Ni(t);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;h.morphAttributes[e].push(s)}}return h}function Ni(e){let t,s,a,r=-1,n=0;for(let i=0;i<e.length;++i){const o=e[i];if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=o.itemSize),s!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===a&&(a=o.normalized),a!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=o.gpuType),r!==o.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;n+=o.count*s}const o=new t(n),l=new i(o,s,a);let h=0;for(let t=0;t<e.length;++t){const i=e[t];if(i.isInterleavedBufferAttribute){const e=h/s;for(let t=0,a=i.count;t<a;t++)for(let a=0;a<s;a++){const s=i.getComponent(t,a);l.setComponent(t+e,a,s)}}else o.set(i.array,h);h+=i.count*s}return void 0!==r&&(l.gpuType=r),l}function Gi(e,t=1e-4){t=Math.max(t,Number.EPSILON);const i={},s=e.getIndex(),a=e.getAttribute("position"),r=s?s.count:a.count;let n=0;const o=Object.keys(e.attributes),l={},h={},c=[],A=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"];for(let t=0,i=o.length;t<i;t++){const i=o[t],s=e.attributes[i];l[i]=new s.constructor(new s.array.constructor(s.count*s.itemSize),s.itemSize,s.normalized);const a=e.morphAttributes[i];a&&(h[i]||(h[i]=[]),a.forEach(((e,t)=>{const s=new e.array.constructor(e.count*e.itemSize);h[i][t]=new e.constructor(s,e.itemSize,e.normalized)})))}const d=.5*t,p=Math.log10(1/t),g=Math.pow(10,p),m=d*g;for(let t=0;t<r;t++){const a=s?s.getX(t):t;let r="";for(let t=0,i=o.length;t<i;t++){const i=o[t],s=e.getAttribute(i),n=s.itemSize;for(let e=0;e<n;e++)r+=~~(s[A[e]](a)*g+m)+","}if(r in i)c.push(i[r]);else{for(let t=0,i=o.length;t<i;t++){const i=o[t],s=e.getAttribute(i),r=e.morphAttributes[i],c=s.itemSize,d=l[i],p=h[i];for(let e=0;e<c;e++){const t=A[e],i=u[e];if(d[i](n,s[t](a)),r)for(let e=0,s=r.length;e<s;e++)p[e][i](n,r[e][t](a))}}i[r]=n,c.push(n),n++}}const f=e.clone();for(const t in e.attributes){const e=l[t];if(f.setAttribute(t,new e.constructor(e.array.slice(0,n*e.itemSize),e.itemSize,e.normalized)),t in h)for(let e=0;e<h[t].length;e++){const i=h[t][e];f.morphAttributes[t][e]=new i.constructor(i.array.slice(0,n*i.itemSize),i.itemSize,i.normalized)}}return f.setIndex(c),f}class Oi extends t{constructor(e=1,t=10,i=10,s=10,a=1){super(),this.type="SphereBox",this.name="SphereBox_"+e+"_"+t+"_"+i+"_"+s+"_"+a,e=e||1,t=Math.floor(t),i=Math.floor(i),s=Math.floor(s);let r,n=new l(1,1,1,t,i,s),o=new W,h=new W,c=n.attributes.position.array,A=n.attributes.normal.array;for(let t=0,i=n.attributes.position.count;t<i;t++)r=3*t,o.set(c[r],c[r+1],c[r+2]),h.copy(o).normalize(),o.lerp(h,a).multiplyScalar(e),c[r]=o.x,c[r+1]=o.y,c[r+2]=o.z,o.normalize(),A[r]=o.x,A[r+1]=o.y,A[r+2]=o.z;this.copy(n)}}class qi extends t{constructor(e=1,t=1,i=12,s=1){super(),this.type="CapsuleGeometry";let a=Math.PI,o=e/(2*e+t),l=1-2*o;i=Math.floor(i),s=Math.floor(s);let h=Math.floor(.5*i),c=2*Math.PI,A=.5*Math.PI,u=new n(e,e,t,i,s,!0);Wi(u,0,o,1,l);let d=new r(e,i,h,0,c,0,A);Wi(d,0,1-o,1,o);let p=new r(e,i,h,0,c,A,A);Wi(p,0,0,1,o);let g=(new J).makeRotationY(.5*-a),m=(new J).makeTranslation(0,.5*t,0),f=(new J).makeTranslation(0,.5*-t,0);u.applyMatrix4(g),d.applyMatrix4(m),p.applyMatrix4(f);let b=Gi(Ui([u,d,p]));this.copy(b)}}class ji extends t{constructor(e=1,t=.4,i=8,a=6,r=2*Math.PI,n=0,o=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:a,arc:r},i=Math.floor(i),a=Math.floor(a);const l=[],h=[],c=[],A=[],u=new W,d=new W,p=new W;let g,m;for(g=0;g<=i;g++)for(m=0;m<=a;m++){const s=m/a*r,l=g/i*o+n;d.x=(e+t*Math.cos(l))*Math.cos(s),d.y=(e+t*Math.cos(l))*Math.sin(s),d.z=t*Math.sin(l),h.push(d.x,d.y,d.z),u.x=e*Math.cos(s),u.y=e*Math.sin(s),p.subVectors(d,u).normalize(),c.push(p.x,p.y,p.z),A.push(m/a),A.push(g/i)}for(g=1;g<=i;g++)for(m=1;m<=a;m++){const e=(a+1)*g+m-1,t=(a+1)*(g-1)+m-1,i=(a+1)*(g-1)+m,s=(a+1)*g+m;l.push(e,t,s),l.push(t,i,s)}this.setIndex(l),this.setAttribute("position",new s(h,3)),this.setAttribute("normal",new s(c,3)),this.setAttribute("uv",new s(A,2))}}class Hi extends t{constructor(e=1,t=1,i=1,s=.01,a=12,r=1,o=2){super(),this.type="ChamferCyl",a=Math.floor(a),r=Math.floor(r),o=Math.floor(o);let l=new J,h=new J,c=Math.PI,A=.5*c,u=2*c,d=s/i,p=1-2*d,g=new n(e,t,i-2*s,a,r,!0,0);l.makeRotationY(A),g.applyMatrix4(l),Wi(g,0,d,1,p);let m=new ji(e-s,s,o,a,u,0,A),f=new ee(e-s,a);h.makeTranslation(0,0,s),f.applyMatrix4(h),Wi(m,0,1-d,1,d);let b=Ui([m,f]);l.makeTranslation(0,0,.5*i-s),h.makeRotationX(-A),b.applyMatrix4(h.multiply(l)),m=new ji(t-s,s,o,a,u,0,A),f=new ee(t-s,a),h.makeTranslation(0,0,s),f.applyMatrix4(h),Wi(m,0,1-d,1,d,!0);let y=Ui([m,f]);l.makeTranslation(0,0,.5*i-s),h.makeRotationX(A),y.applyMatrix4(h.multiply(l));let w=Gi(Ui([b,g,y]));this.copy(w)}}let Vi=class extends t{constructor(e=1,t=1,i=1,s=.01,a=1,r=1,o=1,l=2){super(),this.type="ChamferBox",a=Math.floor(a),r=Math.floor(r),o=Math.floor(o),l=Math.floor(l);let c=Math.PI,A=.5*c,u=2*s,d=.5*e,p=.5*t,g=.5*i,m=new J,f=new J,b=new J,y=s/e,w=1-2*y,I=s/t,E=1-2*y,C=s/i,v=1-2*C,B=new h(e-u,t-u,a,r),x=new n(s,s,e-u,l,a,!0,0,A),k=new n(s,s,t-u,l,r,!0,0,A),Q=new Ki(s,l,l,0,A,0,-A),S=new Ki(s,l,l,0,A,0,-A);Wi(B,-y,I,w,E),Wi(x,0,y,I,w),f.makeTranslation(0,p-s,0),m.makeRotationX(A),Q.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-p+s,0),m.makeRotationX(A),b.makeRotationY(-A),S.applyMatrix4(f.multiply(m).multiply(b));let M=Ui([k,Q,S]),R=M.clone();f.makeTranslation(d-s,0,-s),M.applyMatrix4(f),f.makeTranslation(-d+s,0,-s),m.makeRotationZ(c),R.applyMatrix4(f.multiply(m));let D=x.clone();m.makeRotationZ(A),f.makeTranslation(0,p-s,-s),x.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-p+s,-s),m.makeRotationZ(-A),D.applyMatrix4(f.multiply(m));let T=Ui([x,D,B,M,R]),F=T.clone();f.makeTranslation(0,0,g),T.applyMatrix4(f),f.makeTranslation(0,0,-g),m.makeRotationY(c),F.applyMatrix4(f.multiply(m)),B=new h(i-u,t-u,o,r),x=new n(s,s,i-u,l,o,!0,0,A),D=x.clone(),Wi(B,-C,I,v,E),f.makeTranslation(0,-(p-s),-s,0),m.makeRotationZ(-A),x.applyMatrix4(f.multiply(m)),f.makeTranslation(0,p-s,-s,0),m.makeRotationZ(A),D.applyMatrix4(f.multiply(m));let L=Ui([x,D,B]),P=L.clone();f.makeTranslation(-d,0,0),m.makeRotationY(-A),L.applyMatrix4(f.multiply(m)),f.makeTranslation(d,0,0),m.makeRotationY(A),P.applyMatrix4(f.multiply(m)),B=new h(e-u,i-u,a,o),Wi(B,-y,C,w,v);let _=B.clone();f.makeTranslation(0,p,0),m.makeRotationX(-A),B.applyMatrix4(f.multiply(m)),f.makeTranslation(0,-p,0),m.makeRotationX(A),_.applyMatrix4(f.multiply(m));let z=Gi(Ui([T,F,L,P,B,_]));Ji(z,"box"),this.copy(z)}},Ki=class extends t{constructor(e=1,t=8,i=6,a=0,r=2*Math.PI,n=0,o=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:a,phiLength:r,thetaStart:n,thetaLength:o},t=Math.floor(t),i=Math.floor(i);const l=Math.min(n+o,Math.PI);let h=0;const c=[],A=new W,u=new W,d=[],p=[],g=[],m=[];for(let s=0;s<=i;s++){const d=[],f=s/i;let b=0;0==s&&0==n?b=.5/t:s==i&&l==Math.PI&&(b=-.5/t);for(let i=0;i<=t;i++){const s=i/t;A.x=-e*Math.cos(a+s*r)*Math.sin(n+f*o),A.y=e*Math.cos(n+f*o),A.z=e*Math.sin(a+s*r)*Math.sin(n+f*o),p.push(A.x,A.y,A.z),u.copy(A).normalize(),g.push(u.x,u.y,u.z),m.push(s+b,1-f),d.push(h++)}c.push(d)}for(let e=0;e<i;e++)for(let s=0;s<t;s++){const t=c[e][s+1],a=c[e][s],r=c[e+1][s],o=c[e+1][s+1];(0!==e||n>0)&&d.push(t,a,o),(e!==i-1||l<Math.PI)&&d.push(a,r,o)}this.setIndex(d),this.setAttribute("position",new s(p,3)),this.setAttribute("normal",new s(g,3)),this.setAttribute("uv",new s(m,2))}};function Wi(e,t=0,i=0,s=1,a=1,r){let n=e.attributes.uv,o=n.array,l=n.count,h=0;for(;l--;)h=2*l,o[h]=o[h]*s-t,o[h+1]=o[h+1]*a+i,r&&(o[h]=1-o[h],o[h+1]=1-o[h+1])}function Ji(e,t="sphere",i,a=[0,0,0],r=[0,0,0,1],n){if(void 0===n&&(n=new J),n.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){e.boundingBox||e.computeBoundingBox();let t=e.boundingBox;i=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z)}let o=new te(new W(-i/2,-i/2,-i/2),new W(i/2,i/2,i/2)),l=[];l.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.setAttribute("uv",new s(l,2));let h,c,A,u,d,p=function(e,t,i){e.applyMatrix4(n),t.applyMatrix4(n),i.applyMatrix4(n);let s=1/(2*Math.PI),a=1/Math.PI;return e.normalize(),t.normalize(),i.normalize(),{uv0:new g(.5-Math.atan(e.z,-e.x)*s,.5-Math.asin(e.y)*a),uv1:new g(.5-Math.atan(t.z,-t.x)*s,.5-Math.asin(t.y)*a),uv2:new g(.5-Math.atan(i.z,-i.x)*s,.5-Math.asin(i.y)*a)}},m=function(e,t,s){e.applyMatrix4(n),t.applyMatrix4(n),s.applyMatrix4(n);let a=new W;a.crossVectors(t.clone().sub(e),t.clone().sub(s)).normalize(),a.x<0||a.y<0||a.z,a.x=Math.abs(a.x),a.y=Math.abs(a.y),a.z=Math.abs(a.z);let r=new g,l=new g,h=new g,c=1/i;return a.y>a.x&&a.y>a.z?(r.set(e.x-o.min.x,o.max.z-e.z).multiplyScalar(c),l.set(t.x-o.min.x,o.max.z-t.z).multiplyScalar(c),h.set(s.x-o.min.x,o.max.z-s.z).multiplyScalar(c)):a.x>a.y&&a.x>a.z?(r.set(e.z-o.min.z,e.y-o.min.y).multiplyScalar(c),l.set(t.z-o.min.z,t.y-o.min.y).multiplyScalar(c),h.set(s.z-o.min.z,s.y-o.min.y).multiplyScalar(c)):a.z>a.y&&a.z>a.x&&(r.set(e.x-o.min.x,e.y-o.min.y).multiplyScalar(c),l.set(t.x-o.min.x,t.y-o.min.y).multiplyScalar(c),h.set(s.x-o.min.x,s.y-o.min.y).multiplyScalar(c)),{uv0:r,uv1:l,uv2:h}},f=new W,b=new W,y=new W;new W,new W,new W;const w=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(h=0;h<e.index.count;h+=3)c=e.index.getX(h+0),A=e.index.getX(h+1),u=e.index.getX(h+2),f.fromBufferAttribute(w,c),b.fromBufferAttribute(w,A),y.fromBufferAttribute(w,u),d="sphere"===t?p(f,b,y):m(f,b,y),l[2*c]=d.uv0.x,l[2*c+1]=d.uv0.y,l[2*A]=d.uv1.x,l[2*A+1]=d.uv1.y,l[2*u]=d.uv2.x,l[2*u+1]=d.uv2.y;else for(h=0;h<w.count;h+=3){f.fromBufferAttribute(w,h+0),b.fromBufferAttribute(w,h+1),y.fromBufferAttribute(w,h+2),d="sphere"===t?p(f,b,y):m(f,b,y);let e=h,i=h+1,s=h+2;l[2*e]=d.uv0.x,l[2*e+1]=d.uv0.y,l[2*i]=d.uv1.x,l[2*i+1]=d.uv1.y,l[2*s]=d.uv2.x,l[2*s+1]=d.uv2.y}e.attributes.uv.array=new Float32Array(l),e.attributes.uv.needsUpdate=!0}class Xi extends ie{constructor(i,a,r,n,o=[0,1,0],l=[0,.5,0],h=!1){if(super(),!i)return;if(!a)return;const c=new t;let A=.5*a-i,u=12,d=.2*i,p=[];const g=[i,A,0,i,-A,0,-i,A,0,-i,-A,0,0,A,i-d,0,A,i+d];p.push(...o,...l,...o,...l,...l,...l),h&&(g.push(0,A,i,0,-A,i,0,A,-i,0,-A,-i),p.push(...o,...l,...o,...l));for(let e=0,t=1;e<u;e++,t++){const s=e/u*Math.PI*2,a=t/u*Math.PI*2;g.push(i*Math.cos(s),A,i*Math.sin(s),i*Math.cos(a),A,i*Math.sin(a),i*Math.cos(s),-A,i*Math.sin(s),i*Math.cos(a),-A,i*Math.sin(a)),p.push(...o,...o,...l,...l)}for(let e=0,t=1;e<u;e++,t++){const s=e/u*Math.PI*2,a=t/u*Math.PI*2;let r=t<=6?1:-1;g.push(i*Math.cos(s),A*r+i*Math.sin(s),0,i*Math.cos(a),A*r+i*Math.sin(a),0),1===r?p.push(...o,...o):p.push(...l,...l),h&&(g.push(0,A*r+i*Math.sin(s),i*Math.cos(s),0,A*r+i*Math.sin(a),i*Math.cos(a)),1===r?p.push(...o,...o):p.push(...l,...l))}if(c.setAttribute("position",new s(g,3)),c.setAttribute("color",new s(p,3)),c.computeBoundingSphere(),this.colors=c.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=c,this.cone=new e(c,n),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!r)return;const m=new t,f=[.5*d,-A,i-d,.5*d,-A,i+d,.5*-d,-A,i-d,.5*-d,-A,i+d,.5*d,-A,i-d,.5*-d,-A,i-d,.5*-d,-A,i+d,-d,-A,i+d,.5*d,-A,i+d,d,-A,i+d,-d,-A,i+d,0,-A,i+2*d,d,-A,i+d,0,-A,i+2*d];p=[];let b=f.length/3;for(;b--;)p.push(1,0,0);m.setAttribute("position",new s(f,3)),m.setAttribute("color",new s(p,3)),this.direction=new e(m,n),this.direction.raycast=function(){return!1},this.add(this.direction)}over(e){e?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(e){let t=this.colors.length;for(;t--;)this.colors[t]=e?1:this.colorsbase[t];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(e){this.direction&&(this.direction.rotation.y=e)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}const Yi=new W,Zi=new se,$i=new ae,es=new W,ts=new re;class is{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new ns,this.unassigned=new ns,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.vertices.push(new rs(e[t]));this._compute()}return this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const i=e.geometry;if(void 0!==i){const s=i.attributes.position;if(void 0!==s)for(let i=0,a=s.count;i<a;i++){const a=new W;a.fromBufferAttribute(s,i).applyMatrix4(e.matrixWorld),t.push(a)}}})),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let i=0,s=t.length;i<s;i++){if(t[i].distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){const i=this.faces;let s=-1/0,a=1/0;for(let t=0,r=i.length;t<r;t++){const r=i[t],n=r.distanceToPoint(e.origin),o=r.normal.dot(e.direction);if(n>0&&o>=0)return null;const l=0!==o?-n/o:0;if(!(l<=0)&&(o>0?a=Math.min(l,a):s=Math.max(l,s),s>a))return null}return s!==-1/0?e.at(s,t):e.at(a,t),t}intersectsRay(e){return null!==this.intersectRay(e,Yi)}makeEmpty(){return this.faces=[],this.vertices=[],this}_addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}_removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}_removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let i=e.outside;for(;null!==i.next&&i.next.face===e;)i=i.next;return this.assigned.removeSubList(t,i),t.prev=i.next=null,e.outside=null,t}}_deleteFaceVertices(e,t){const i=this._removeAllVerticesFromFace(e);if(void 0!==i)if(void 0===t)this.unassigned.appendChain(i);else{let e=i;do{const i=e.next;t.distanceToPoint(e.point)>this.tolerance?this._addVertexToFace(e,t):this.unassigned.append(e),e=i}while(null!==e)}return this}_resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const i=t.next;let s=this.tolerance,a=null;for(let i=0;i<e.length;i++){const r=e[i];if(0===r.mark){const e=r.distanceToPoint(t.point);if(e>s&&(s=e,a=r),s>1e3*this.tolerance)break}}null!==a&&this._addVertexToFace(t,a),t=i}while(null!==t)}return this}_computeExtremes(){const e=new W,t=new W,i=[],s=[];for(let e=0;e<3;e++)i[e]=s[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let a=0,r=this.vertices.length;a<r;a++){const r=this.vertices[a],n=r.point;for(let t=0;t<3;t++)n.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,n.getComponent(t)),i[t]=r);for(let e=0;e<3;e++)n.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,n.getComponent(e)),s[e]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:i,max:s}}_computeInitialHull(){const e=this.vertices,t=this._computeExtremes(),i=t.min,s=t.max;let a=0,r=0;for(let e=0;e<3;e++){const t=s[e].point.getComponent(e)-i[e].point.getComponent(e);t>a&&(a=t,r=e)}const n=i[r],o=s[r];let l,h;a=0,Zi.set(n.point,o.point);for(let t=0,i=this.vertices.length;t<i;t++){const i=e[t];if(i!==n&&i!==o){Zi.closestPointToPoint(i.point,!0,es);const e=es.distanceToSquared(i.point);e>a&&(a=e,l=i)}}a=-1,$i.setFromCoplanarPoints(n.point,o.point,l.point);for(let t=0,i=this.vertices.length;t<i;t++){const i=e[t];if(i!==n&&i!==o&&i!==l){const e=Math.abs($i.distanceToPoint(i.point));e>a&&(a=e,h=i)}}const c=[];if($i.distanceToPoint(h.point)<0){c.push(ss.create(n,o,l),ss.create(h,o,n),ss.create(h,l,o),ss.create(h,n,l));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge(t)),c[e+1].getEdge(1).setTwin(c[t+1].getEdge(0))}}else{c.push(ss.create(n,l,o),ss.create(h,n,o),ss.create(h,o,l),ss.create(h,l,n));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge((3-e)%3)),c[e+1].getEdge(0).setTwin(c[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(c[e]);for(let t=0,i=e.length;t<i;t++){const i=e[t];if(i!==n&&i!==o&&i!==l&&i!==h){a=this.tolerance;let e=null;for(let t=0;t<4;t++){const s=this.faces[t].distanceToPoint(i.point);s>a&&(a=s,e=this.faces[t])}null!==e&&this._addVertexToFace(i,e)}}return this}_reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const i=this.faces[t];0===i.mark&&e.push(i)}return this.faces=e,this}_nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const i=this.assigned.first().face;let s=i.outside;do{const a=i.distanceToPoint(s.point);a>t&&(t=a,e=s),s=s.next}while(null!==s&&s.face===i);return e}}_computeHorizon(e,t,i,s){let a;this._deleteFaceVertices(i),i.mark=1,a=null===t?t=i.getEdge(0):t.next;do{const t=a.twin,i=t.face;0===i.mark&&(i.distanceToPoint(e)>this.tolerance?this._computeHorizon(e,t,i,s):s.push(a)),a=a.next}while(a!==t);return this}_addAdjoiningFace(e,t){const i=ss.create(e,t.tail(),t.head());return this.faces.push(i),i.getEdge(-1).setTwin(t.twin),i.getEdge(0)}_addNewFaces(e,t){this.newFaces=[];let i=null,s=null;for(let a=0;a<t.length;a++){const r=t[a],n=this._addAdjoiningFace(e,r);null===i?i=n:n.next.setTwin(s),this.newFaces.push(n.face),s=n}return i.next.setTwin(s),this}_addVertexToHull(e){const t=[];return this.unassigned.clear(),this._removeVertexFromFace(e,e.face),this._computeHorizon(e.point,null,e.face,t),this._addNewFaces(e,t),this._resolveUnassignedPoints(this.newFaces),this}_cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}_compute(){let e;for(this._computeInitialHull();void 0!==(e=this._nextVertexToAdd());)this._addVertexToHull(e);return this._reindexFaces(),this._cleanup(),this}}class ss{constructor(){this.normal=new W,this.midpoint=new W,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,i){const s=new ss,a=new as(e,s),r=new as(t,s),n=new as(i,s);return a.next=n.prev=r,r.next=a.prev=n,n.next=r.prev=a,s.edge=a,s.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),i=this.edge.next.head();return ts.set(e.point,t.point,i.point),ts.getNormal(this.normal),ts.getMidpoint(this.midpoint),this.area=ts.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class as{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class rs{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class ns{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class os extends t{constructor(e=[]){super();const t=[],i=[],a=(new is).setFromPoints(e).faces;for(let e=0;e<a.length;e++){const s=a[e];let r=s.edge;do{const e=r.head().point;t.push(e.x,e.y,e.z),i.push(s.normal.x,s.normal.y,s.normal.z),r=r.next}while(r!==s.edge)}this.setAttribute("position",new s(t,3)),this.setAttribute("normal",new s(i,3))}}let ls=null,hs=null;const cs=new W(0,1,0),As=new W(1,0,0),us=new W(0,0,1);class ds extends Fi{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,ls=this.motor.geo,hs=this.motor.mat,this.type="body",this.num=yi[this.type],this.full=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(e){this.num=yi[e?"bodyFull":"body"],this.full=e}step(e,t){const i=this.list;let s,a,r,n=i.length;for(;n--;)if(s=i[n],null!==s)if(a=t+n*this.num,s.actif){if(s.sleep=!(e[a]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.idx,s.sleep?Qi.sleep:Qi.body):(s.sleep||"sleep"!==s.material.name||(s.material=hs.get("body")),s.sleep&&"body"===s.material.name&&(s.material=hs.get("sleep")))),!s.sleep||s.isKinematic)if(s.position.fromArray(e,a+1),s.quaternion.fromArray(e,a+4),1!==this.motor.ws&&s.position.multiplyScalar(this.motor.uws),this.full?(s.velocity.fromArray(e,a+8),s.angular.fromArray(e,a+11)):s.getVelocity&&(r=this.motor.reflow.velocity[s.name],r&&(s.velocity.fromArray(r,0),s.angular.fromArray(r,3))),s.isInstance){if(s.speedMat){let t=.01*e[a];s.instance.setColorAt(s.idx,[t,t,t])}s.instance.setTransformAt(s.idx,s.position.toArray(),s.quaternion.toArray(),s.noScale?[1,1,1]:s.size),this.needMatrix&&s.matrixWorld.compose(s.position,s.quaternion,{x:1,y:1,z:1})}else s.auto||s.updateMatrix()}else s.actif=!0}geometry(e={},i=null,s=null){let a,o,l,h=e.size,c="",A=e.type,u=!1,d=!1,p=e.seg||16;const g="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(e.instance&&"compound"===A&&(A=e.shapes[0].type,h=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==A&&"convex"!==A||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&("box"===A&&(A="ChamferBox"),"cylinder"===A&&(A="ChamferCyl")),e.geometry&&("convex"===A?e.shape=e.geometry:A="direct"),"PHYSX"===this.engine&&"cylinder"===e.type){let t=new n(e.size[0],e.size[0],e.size[1],p,1);e.isWheel&&t.rotateZ(-li),e.v=ci.getVertex(t),e.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===e.type){let t=new n(0,e.size[0],e.size[1],p,1);e.v=ci.getVertex(t),e.type="convex"}switch("stair"===e.type&&(e.type="box",A="box"),A){case"direct":a=e.geometry.clone(),e.size&&a.scale(e.size[0],e.size[1],e.size[2]),d=!0,u=!0;break;case"convex":if(e.v){if(e.nogeo)a=new t;else{let t=[];for(o=Math.floor(e.v.length/3);o--;)l=3*o,t.push(new W(e.v[l],e.v[l+1],e.v[l+2]));a=new os(t)}d=!0,u=!0}if(e.shape){a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.shapeScale&&a.scale(e.shapeScale[0],e.shapeScale[1],e.shapeScale[2]);let t=g?ci.toNonIndexed(a):null;e.v=ci.getVertex(t||a,g),e.index=ci.getIndex(t||a,g),this.engine,d=!0,u=!0}a.boundingBox||a.computeBoundingBox();let i=a.boundingBox;e.boxSize=[-i.min.x+i.max.x,-i.min.y+i.max.y,-i.min.z+i.max.z];break;case"mesh":if(a=e.shape.clone(),e.size&&a.scale(e.size[0],e.size[0],e.size[0]),e.v=ci.getVertex(a,g),e.index=ci.getIndex(a,g),"PHYSX"===this.engine){let t=new W;ci.getCenter(a,t),e.massCenter||(e.massCenter=t.toArray())}d=!0,u=!0;break;case"customSphere":c="customSphere_"+h[0],a=ls.get(c),a?c="":(a=new r(h[0],e.seg1||32,e.seg2||16),a.name=c),u=!0,e.type="sphere";break;case"highSphere":c="highSphere_"+h[0],a=ls.get(c),a?c="":(a=new Oi(h[0]),a.name=c),u=!0,e.type="sphere";break;case"capsule":c="capsule_"+h[0]+"_"+h[1]+"_"+p,a=ls.get(c),a?c="":(a=new qi(h[0],h[1],p),a.name=c),u=!0;break;case"ChamferBox":c="ChamferBox_"+h[0]+"_"+h[1]+"_"+h[2]+"_"+e.radius,a=ls.get(c),a?c="":(a=new Vi(h[0],h[1],h[2],e.radius),a.name=c),u=!0;break;case"ChamferCyl":c="ChamferCyl_"+h[0]+"_"+h[1]+"_"+h[2]+"_"+e.radius+"_"+p,a=ls.get(c),a?c="":(a=new Hi(h[0],h[0],h[1],e.radius,p),a.name=c),u=!0;break;default:e.breakable?(a=ls.get(A).clone(),a.scale(h[0],h[1],h[2]),d=!0,u=!0):a=ls.get(A)}if(e.translate&&a.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,(void 0===a.attributes.uv||e.autoUV)&&Ji(a,"box",5,e.pos,e.quat),""!==c&&ls.set(a),e.isWheel&&(a=a.clone(),a.rotateZ(-li),d=!0),d&&ls.unic(a),null===i&&null===s)return a.noScale=u,a;e.meshRemplace&&e.debug&&(s=hs.get("debug"));let m=new Z(a,s);if(e.button&&(m.isButton=!0),e.helper){let t=e.hcolor||[.3,.1,0],i=e.hcolor2||[.8,.2,0],s=new Xi(h[0],h[1]+2*h[0],!1,hs.get("liner"),t,i,!0);m.add(s),m.userData.helper=s}e.localRot&&(e.localQuat=ci.quatFromEuler(e.localRot)),e.localPos&&m.position.fromArray(e.localPos),e.localQuat&&m.quaternion.fromArray(e.localQuat),u||m.scale.fromArray(e.size),void 0!==e.ray&&(e.ray||(m.raycast=()=>{})),e.meshRemplace&&!e.debug||(i.add(m),m.userData.helper&&(i.over=e=>{m.userData.helper.over(e)}))}add(e={}){e.worldScale&&delete(e=this.scaler(e,e.worldScale)).worldScale;let t,i,s,a=0;if(e.instance||(s=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),"stair"===e.type){let t=new W(0,0,e.size[2]),i=new W(0,.5*e.size[1],.5*e.size[2]),s=t.angleTo(i),a=t.distanceTo(i);e.rot=[s*ni,0,0],e.size[1]*=e.div||.2,e.size[2]=2*a;let r=new W(0,.5*-e.size[1],0);r.applyAxisAngle({x:1,y:0,z:0},s),e.pos[1]+=r.y,e.pos[2]+=r.z}if(e.massCenter&&-1===Ai.indexOf(this.engine))if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.pos?i.pos=ci.addArray(i.pos,e.massCenter):i.pos=e.massCenter;void 0!==e.collision&&!1===e.collision&&("PHYSX"===this.engine&&(e.flags=0),"OIMO"===this.engine&&(e.mask=0)),e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=ci.quatFromEuler(e.rot)),void 0!==e.meshRot&&(e.meshQuat=ci.quatFromEuler(e.meshRot)),e.size=ci.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=ci.autoSize(e.meshScale));let r,n=!1;!1===e.visible&&(e.material="hide"),void 0!==e.material?r=e.material.constructor===String?hs.get(e.material):e.material:(n=!0,r=hs.get(this.type),e.instance&&(r=hs.get("base"))),e.unicMat&&(r=r.clone(),hs.addToTmp(r));let o=e.instance?{}:new ie;if(e.mesh&&!e.instance){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();if(t.position.fromArray(e.meshPos||[0,0,0]),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),!n&&(t.material=r,t.children&&!e.nofullmat))for(let e in t.children)t.children[e].material=r;this.motor.tmpMesh.push(t),e.meshRemplace=!0,o.add(t)}switch(e.type){case"null":break;case"compound":for(t=0;t<e.shapes.length;t++)i=e.shapes[t],i.type=void 0===i.type?"box":i.type,i.size=ci.autoSize(i.size,i.type),i.pos&&(i.localPos=i.pos),void 0!==i.rot&&(i.quat=ci.quatFromEuler(i.rot)),i.quat&&(i.localQuat=i.quat),i.debug=e.debug,i.meshRemplace=e.meshRemplace||!1,e.instance?"convex"===i.type&&(i.v=ci.getVertex(i.shape,!1)):this.geometry(i,o,r),a+=ci.getVolume(i.type,i.size,i.v);break;default:e.instance?"convex"===e.type&&(e.v=ci.getVertex(e.shape,!1)):this.geometry(e,o,r),a=ci.getVolume(e.type,e.size,e.v)}if(o.type=this.type,o.size=e.size,o.shapetype=e.type,o.isKinematic=e.kinematic||!1,o.link=0,o.meshSize=e.meshSize?e.meshSize:1,o.velocity=new W,o.angular=new W,o.sleep=e.sleep||!1,o.defMat=!1,e.button&&(o.isButton=!0),o.isRay=void 0===e.ray||e.ray,o.material&&n&&(o.defMat="body"===o.material.name),e.instance){o.isInstance=!0,o.instance=this.getInstance(e,r),o.instance.isRay=o.isRay,o.over=o.instance.over,o.isRay=!1,o.isOver=!1,o.speedMat=e.speedMat||!1,o.defMat="base"===o.instance.material.name,o.idx=o.instance.count,o.name=e.name?e.name:o.instance.name+o.idx,e.name=o.name,o.noScale=o.instance.noScale,e.sizeByInstance&&(o.noScale=!1);let t=e.color;o.defMat&&(t=e.sleep?Qi.sleep:Qi.body),o.instance.add(o,e.pos,e.quat,o.noScale?[1,1,1]:o.size,t),o.position=(new W).fromArray(e.pos),o.quaternion=(new zi).fromArray(e.quat),this.needMatrix&&(o.matrixWorld=new J),o.instance.v&&(e.v=o.instance.v),o.instance.index&&(e.index=o.instance.index),e.type=o.instance.type,o.actif=!1}else o.name=s,o.isRay||o.traverse((function(e){e.isObject3D&&(e.raycast=()=>{})})),e.renderOrder&&(o.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),o.dispose=function(){this.clearOutLine&&this.clearOutLine(),this.traverse((function(e){e.isMesh&&e.unic&&e.geometry.dispose()})),this.children=[]}.bind(o),o.visible=void 0===e.visible||e.visible,Object.defineProperty(o,"material",{get(){return this.children[0]?this.children[0].material:null},set(e){this.traverse((function(t){t.isMesh&&"outline"!==t.name&&(t.material=e)}))}}),Object.defineProperty(o,"castShadow",{get(){return!!this.children[0]&&this.children[0].castShadow},set(e){this.traverse((function(t){t.isMesh&&(t.castShadow=e)}))}}),Object.defineProperty(o,"receiveShadow",{get(){return!!this.children[0]&&this.children[0].receiveShadow},set(e){this.traverse((function(t){t.isMesh&&(t.receiveShadow=e)}))}}),o.receiveShadow=e.shadow,o.castShadow=e.shadow,this.motor.mouseActive&&(o.overMaterial=hs.get("outline"),o.isOver=!1,o.addOutLine=function(){this.children[0].isMesh&&(this.outline=(new Z).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline))}.bind(o),o.clearOutLine=function(){this.outline&&(this.remove(this.outline),this.outline=null)}.bind(o),o.over=function(e){e&&!this.isOver&&this.addOutLine(),!e&&this.isOver&&this.clearOutLine(),this.isOver=e}.bind(o),o.select=function(e){}.bind(o)),this.set(e,o);if(e.breakable){let t=o,i=t.children[0];t.remove(i),o=i,o.position.copy(t.position),o.quaternion.copy(t.quaternion),o.name=s,o.type=this.type,o.breakable=!0,o.breakOption=void 0!==e.breakOption?e.breakOption:[250,1,2,1],o.ignore=e.ignore||[],o.size=e.size,o.shapetype=e.type,o.isKinematic=e.kinematic||!1,o.link=0,o.meshSize=e.meshSize?e.meshSize:1,o.velocity=new W,o.angular=new W,o.sleep=e.sleep||!1,o.defMat=!1,o.auto=e.auto||!1,o.auto?o.matrixAutoUpdate=!0:(o.matrixAutoUpdate=!1,o.updateMatrix())}if(o.mass=e.mass||0,o.density=e.density||0,o.density&&!o.mass?o.mass=ci.massFromDensity(o.density,a):o.mass&&!o.density&&(o.density=ci.densityFromMass(o.mass,a),"RAPIER"!==this.engine&&"OIMO"!==this.engine&&"PHYSX"!==this.engine||(e.density=o.density)),e.massInfo&&console.log("%c"+o.name+" %cdensity:"+o.density+" mass:"+o.mass,"font-size:16px","font-size:12px"),e.getVelocity&&(o.getVelocity=!0),this.addToWorld(o,e.id),e.onlyMakeMesh)return o;if(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),e.rot&&delete e.rot,e.mesh&&delete e.mesh,e.meshRot&&delete e.meshRot,e.instance&&delete e.instance,e.material&&delete e.material,e.parent&&delete e.parent,e.solver&&"PHYSX"===this.engine){e.mass=o.mass;this.byName(e.solver).addBone(e.name)}if(e.sleep&&this.set(e,o),this.motor.post({m:"add",o:e}),e.breakable){this.motor.getBreaker().add(o)}return o}dispatchEvent(e,t,i){this.byName(e).dispatchEvent({type:t,data:i})}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(void 0!==e.getVelocity&&(t.getVelocity=e.getVelocity),t.isInstance?(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),(e.pos||e.quat)&&t.instance.setTransformAt(t.idx,t.position.toArray(),t.quaternion.toArray(),t.noScale?[1,1,1]:t.size)):(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix())))}getTransform(e){if("string"==typeof e&&(e=this.byName(o.name)),null===e)return;e.updateWorldMatrix(!0,!1);const t=e.matrixWorld.elements;return{position:e.position.clone(),up:cs.clone().set(t[4],t[5],t[6]).normalize(),right:As.clone().set(t[0],t[1],t[2]).normalize(),forward:us.clone().set(t[8],t[9],t[10]).normalize()}}clearInstance(e){let t=this.motor.instanceMesh[e],i=t.getBodyList();this.motor.remove(i),t.dispose(),delete this.motor.instanceMesh[e]}getInstance(e,t){if(this.motor.instanceMesh[e.instance])return this.motor.instanceMesh[e.instance];(e={...e}).sizeByInstance&&(e.size=[1,1,1]);let i=this.geometry(e);e.mesh&&(!e.material&&e.mesh.material&&(t=e.mesh.material),i=e.mesh.isObject3D?e.mesh.geometry.clone():e.mesh.clone(),e.meshSize&&i.scale(e.meshSize,e.meshSize,e.meshSize),e.meshScale&&i.scale(e.meshScale[0],e.meshScale[1],e.meshScale[2]),i.noScale=!0);let s=new _i(i,t,0);return s.type=e.type,s.noScale=i.noScale,"convex"===s.type&&(s.v=e.v),e.index&&(s.index=e.index),s.receiveShadow=void 0===e.shadow||e.shadow,s.castShadow=void 0===e.shadow||e.shadow,this.motor.mouseActive&&(s.overMaterial=hs.get("outline")),s.name=e.instance,this.motor.scene.add(s),this.motor.instanceMesh[e.instance]=s,s}scaler(e,t){if(e.size&&(e.size=math.worldscale(e.size,t)),e.pos&&(e.pos=math.worldscale(e.pos,t)),"convex"===e.type&&(e.shapeScale=[t,t,t]),e.shapes){let i,s=e.shapes.length;for(;s--;)i=e.shapes[s],i.size&&(i.size=math.scaleArray(i.size,t)),i.pos&&(i.pos=math.scaleArray(i.pos,t)),"convex"===i.type&&(i.shapeScale=[t,t,t])}return e.mesh&&(e.meshScale=[t,t,t]),e}}function ps(e,i=!1){const s=null!==e[0].index,a=new Set(Object.keys(e[0].attributes)),r=new Set(Object.keys(e[0].morphAttributes)),n={},o={},l=e[0].morphTargetsRelative,h=new t;let c=0;for(let t=0;t<e.length;++t){const A=e[t];let u=0;if(s!==(null!==A.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in A.attributes){if(!a.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===n[e]&&(n[e]=[]),n[e].push(A.attributes[e]),u++}if(u!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". Make sure all geometries have the same number of attributes."),null;if(l!==A.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in A.morphAttributes){if(!r.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[e]&&(o[e]=[]),o[e].push(A.morphAttributes[e])}if(i){let e;if(s)e=A.index.count;else{if(void 0===A.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". The geometry must have either an index or a position attribute"),null;e=A.attributes.position.count}h.addGroup(c,e,t),c+=e}}if(s){let t=0;const i=[];for(let s=0;s<e.length;++s){const a=e[s].index;for(let e=0;e<a.count;++e)i.push(a.getX(e)+t);t+=e[s].attributes.position.count}h.setIndex(i)}for(const e in n){const t=gs(n[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;h.setAttribute(e,t)}for(const e in o){const t=o[e][0].length;if(0===t)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[e]=[];for(let i=0;i<t;++i){const t=[];for(let s=0;s<o[e].length;++s)t.push(o[e][s][i]);const s=gs(t);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;h.morphAttributes[e].push(s)}}return h}function gs(e){let t,s,a,r=-1,n=0;for(let i=0;i<e.length;++i){const o=e[i];if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=o.itemSize),s!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===a&&(a=o.normalized),a!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=o.gpuType),r!==o.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;n+=o.count*s}const o=new t(n),l=new i(o,s,a);let h=0;for(let t=0;t<e.length;++t){const i=e[t];if(i.isInterleavedBufferAttribute){const e=h/s;for(let t=0,a=i.count;t<a;t++)for(let a=0;a<s;a++){const s=i.getComponent(t,a);l.setComponent(t+e,a,s)}}else o.set(i.array,h);h+=i.count*s}return void 0!==r&&(l.gpuType=r),l}function ms(e,t=1e-4){t=Math.max(t,Number.EPSILON);const s={},a=e.getIndex(),r=e.getAttribute("position"),n=a?a.count:r.count;let o=0;const l=Object.keys(e.attributes),h={},c={},A=[],u=["getX","getY","getZ","getW"],d=["setX","setY","setZ","setW"];for(let t=0,s=l.length;t<s;t++){const s=l[t],a=e.attributes[s];h[s]=new i(new a.array.constructor(a.count*a.itemSize),a.itemSize,a.normalized);const r=e.morphAttributes[s];r&&(c[s]=new i(new r.array.constructor(r.count*r.itemSize),r.itemSize,r.normalized))}const p=.5*t,g=Math.log10(1/t),m=Math.pow(10,g),f=p*m;for(let t=0;t<n;t++){const i=a?a.getX(t):t;let r="";for(let t=0,s=l.length;t<s;t++){const s=l[t],a=e.getAttribute(s),n=a.itemSize;for(let e=0;e<n;e++)r+=~~(a[u[e]](i)*m+f)+","}if(r in s)A.push(s[r]);else{for(let t=0,s=l.length;t<s;t++){const s=l[t],a=e.getAttribute(s),r=e.morphAttributes[s],n=a.itemSize,A=h[s],p=c[s];for(let e=0;e<n;e++){const t=u[e],s=d[e];if(A[s](o,a[t](i)),r)for(let e=0,a=r.length;e<a;e++)p[e][s](o,r[e][t](i))}}s[r]=o,A.push(o),o++}}const b=e.clone();for(const t in e.attributes){const e=h[t];if(b.setAttribute(t,new i(e.array.slice(0,o*e.itemSize),e.itemSize,e.normalized)),t in c)for(let e=0;e<c[t].length;e++){const s=c[t][e];b.morphAttributes[t][e]=new i(s.array.slice(0,o*s.itemSize),s.itemSize,s.normalized)}}return b.setIndex(A),b}const fs=u;class bs extends ne{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,i,s){const a=this,r=new oe(a.manager);r.setPath(a.path),r.setRequestHeader(a.requestHeader),r.setWithCredentials(a.withCredentials),r.load(e,(function(i){try{t(a.parse(i))}catch(t){s?s(t):console.error(t),a.manager.itemError(e)}}),i,s)}parse(e){const t=this;function i(e,t,i,a,r,n,o,l){if(0==t||0==i)return void e.lineTo(l.x,l.y);a=a*Math.PI/180,t=Math.abs(t),i=Math.abs(i);const h=(o.x-l.x)/2,c=(o.y-l.y)/2,A=Math.cos(a)*h+Math.sin(a)*c,u=-Math.sin(a)*h+Math.cos(a)*c;let d=t*t,p=i*i;const g=A*A,m=u*u,f=g/d+m/p;if(f>1){const e=Math.sqrt(f);d=(t*=e)*t,p=(i*=e)*i}const b=d*m+p*g,y=(d*p-b)/b;let w=Math.sqrt(Math.max(0,y));r===n&&(w=-w);const I=w*t*u/i,E=-w*i*A/t,C=Math.cos(a)*I-Math.sin(a)*E+(o.x+l.x)/2,v=Math.sin(a)*I+Math.cos(a)*E+(o.y+l.y)/2,B=s(1,0,(A-I)/t,(u-E)/i),x=s((A-I)/t,(u-E)/i,(-A-I)/t,(-u-E)/i)%(2*Math.PI);e.currentPath.absellipse(C,v,t,i,B,B+x,0===n,a)}function s(e,t,i,s){const a=e*i+t*s,r=Math.sqrt(e*e+t*t)*Math.sqrt(i*i+s*s);let n=Math.acos(Math.max(-1,Math.min(1,a/r)));return e*s-t*i<0&&(n=-n),n}function a(e,t){t=Object.assign({},t);let i={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)i=Object.assign(i,m["."+t[e]])}function s(s,a,r){void 0===r&&(r=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(s)&&(t[a]=r(e.getAttribute(s))),i[s]&&(t[a]=r(i[s])),e.style&&""!==e.style[s]&&(t[a]=r(e.style[s]))}function a(e){return Math.max(0,Math.min(1,h(e)))}function r(e){return Math.max(0,h(e))}return e.hasAttribute("id")&&(i=Object.assign(i,m["#"+e.getAttribute("id")])),s("fill","fill"),s("fill-opacity","fillOpacity",a),s("fill-rule","fillRule"),s("opacity","opacity",a),s("stroke","stroke"),s("stroke-opacity","strokeOpacity",a),s("stroke-width","strokeWidth",r),s("stroke-linejoin","strokeLineJoin"),s("stroke-linecap","strokeLineCap"),s("stroke-miterlimit","strokeMiterLimit",r),s("visibility","visibility"),t}function r(e,t){return e-(t-e)}function n(e,t,i){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const s={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let a=0,r=!0,n="",o="";const l=[];function h(e,t,i){const s=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw s.partial=i,s}function c(){""!==n&&(""===o?l.push(Number(n)):l.push(Number(n)*Math.pow(10,Number(o)))),n="",o=""}let A;const u=e.length;for(let d=0;d<u;d++)if(A=e[d],Array.isArray(t)&&t.includes(l.length%i)&&s.FLAGS.test(A))a=1,n=A,c();else{if(0===a){if(s.WHITESPACE.test(A))continue;if(s.DIGIT.test(A)||s.SIGN.test(A)){a=1,n=A;continue}if(s.POINT.test(A)){a=2,n=A;continue}s.COMMA.test(A)&&(r&&h(A,d,l),r=!0)}if(1===a){if(s.DIGIT.test(A)){n+=A;continue}if(s.POINT.test(A)){n+=A,a=2;continue}if(s.EXP.test(A)){a=3;continue}s.SIGN.test(A)&&1===n.length&&s.SIGN.test(n[0])&&h(A,d,l)}if(2===a){if(s.DIGIT.test(A)){n+=A;continue}if(s.EXP.test(A)){a=3;continue}s.POINT.test(A)&&"."===n[n.length-1]&&h(A,d,l)}if(3===a){if(s.DIGIT.test(A)){o+=A;continue}if(s.SIGN.test(A)){if(""===o){o+=A;continue}1===o.length&&s.SIGN.test(o)&&h(A,d,l)}}s.WHITESPACE.test(A)?(c(),a=0,r=!1):s.COMMA.test(A)?(c(),a=0,r=!0):s.SIGN.test(A)?(c(),a=1,n=A):s.POINT.test(A)?(c(),a=2,n=A):h(A,d,l)}return c(),l}const o=["mm","cm","in","pt","pc","px"],l={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function h(e){let i,s="px";if("string"==typeof e||e instanceof String)for(let t=0,i=o.length;t<i;t++){const i=o[t];if(e.endsWith(i)){s=i,e=e.substring(0,e.length-i.length);break}}return"px"===s&&"px"!==t.defaultUnit?i=l.in[t.defaultUnit]/t.defaultDPI:(i=l[s][t.defaultUnit],i<0&&(i=l[s].in*t.defaultDPI)),i*parseFloat(e)}function c(e){const t=e.elements;return t[0]*t[4]-t[1]*t[3]<0}function A(e){const t=e.elements,i=t[0]*t[3]+t[1]*t[4];if(0===i)return!1;const s=u(e),a=d(e);return Math.abs(i/(s*a))>Number.EPSILON}function u(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function d(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const p=[],m={},f=[],b=new le,y=new le,w=new le,I=new le,E=new g,C=new W,v=new le,B=(new DOMParser).parseFromString(e,"image/svg+xml");!function e(t,s){if(1!==t.nodeType)return;const o=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new le,i=b;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const i=h(e.getAttribute("x")),s=h(e.getAttribute("y"));t.translate(i,s)}if(e.hasAttribute("transform")){const s=e.getAttribute("transform").split(")");for(let e=s.length-1;e>=0;e--){const a=s[e].trim();if(""===a)continue;const r=a.indexOf("("),o=a.length;if(r>0&&r<o){const e=a.slice(0,r),t=n(a.slice(r+1));switch(i.identity(),e){case"translate":if(t.length>=1){const e=t[0];let s=0;t.length>=2&&(s=t[1]),i.translate(e,s)}break;case"rotate":if(t.length>=1){let e=0,s=0,a=0;e=t[0]*Math.PI/180,t.length>=3&&(s=t[1],a=t[2]),y.makeTranslation(-s,-a),w.makeRotation(e),I.multiplyMatrices(w,y),y.makeTranslation(s,a),i.multiplyMatrices(y,I)}break;case"scale":if(t.length>=1){const e=t[0];let s=e;t.length>=2&&(s=t[1]),i.scale(e,s)}break;case"skewX":1===t.length&&i.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&i.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&i.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(i)}}return t}(e);f.length>0&&t.premultiply(f[f.length-1]);return v.copy(t),f.push(t),t}(t);let l=!1,B=null;switch(t.nodeName){case"svg":case"g":s=a(t,s);break;case"style":!function(e){if(!e.sheet||!e.sheet.cssRules||!e.sheet.cssRules.length)return;for(let t=0;t<e.sheet.cssRules.length;t++){const i=e.sheet.cssRules[t];if(1!==i.type)continue;const s=i.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<s.length;e++){const t=Object.fromEntries(Object.entries(i.style).filter((([,e])=>""!==e)));m[s[e]]=Object.assign(m[s[e]]||{},t)}}}(t);break;case"path":s=a(t,s),t.hasAttribute("d")&&(B=function(e){const t=new de,s=new g,a=new g,o=new g;let l=!0,h=!1;const c=e.getAttribute("d");if(""===c||"none"===c)return null;const A=c.match(/[a-df-z][^a-df-z]*/gi);for(let e=0,c=A.length;e<c;e++){const c=A[e],u=c.charAt(0),d=c.slice(1).trim();let p;switch(!0===l&&(h=!0,l=!1),u){case"M":p=n(d);for(let e=0,i=p.length;e<i;e+=2)s.x=p[e+0],s.y=p[e+1],a.x=s.x,a.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&o.copy(s);break;case"H":p=n(d);for(let e=0,i=p.length;e<i;e++)s.x=p[e],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"V":p=n(d);for(let e=0,i=p.length;e<i;e++)s.y=p[e],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"L":p=n(d);for(let e=0,i=p.length;e<i;e+=2)s.x=p[e+0],s.y=p[e+1],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"C":p=n(d);for(let e=0,i=p.length;e<i;e+=6)t.bezierCurveTo(p[e+0],p[e+1],p[e+2],p[e+3],p[e+4],p[e+5]),a.x=p[e+2],a.y=p[e+3],s.x=p[e+4],s.y=p[e+5],0===e&&!0===h&&o.copy(s);break;case"S":p=n(d);for(let e=0,i=p.length;e<i;e+=4)t.bezierCurveTo(r(s.x,a.x),r(s.y,a.y),p[e+0],p[e+1],p[e+2],p[e+3]),a.x=p[e+0],a.y=p[e+1],s.x=p[e+2],s.y=p[e+3],0===e&&!0===h&&o.copy(s);break;case"Q":p=n(d);for(let e=0,i=p.length;e<i;e+=4)t.quadraticCurveTo(p[e+0],p[e+1],p[e+2],p[e+3]),a.x=p[e+0],a.y=p[e+1],s.x=p[e+2],s.y=p[e+3],0===e&&!0===h&&o.copy(s);break;case"T":p=n(d);for(let e=0,i=p.length;e<i;e+=2){const i=r(s.x,a.x),n=r(s.y,a.y);t.quadraticCurveTo(i,n,p[e+0],p[e+1]),a.x=i,a.y=n,s.x=p[e+0],s.y=p[e+1],0===e&&!0===h&&o.copy(s)}break;case"A":p=n(d,[3,4],7);for(let e=0,r=p.length;e<r;e+=7){if(p[e+5]==s.x&&p[e+6]==s.y)continue;const r=s.clone();s.x=p[e+5],s.y=p[e+6],a.x=s.x,a.y=s.y,i(t,p[e],p[e+1],p[e+2],p[e+3],p[e+4],r,s),0===e&&!0===h&&o.copy(s)}break;case"m":p=n(d);for(let e=0,i=p.length;e<i;e+=2)s.x+=p[e+0],s.y+=p[e+1],a.x=s.x,a.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&o.copy(s);break;case"h":p=n(d);for(let e=0,i=p.length;e<i;e++)s.x+=p[e],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"v":p=n(d);for(let e=0,i=p.length;e<i;e++)s.y+=p[e],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"l":p=n(d);for(let e=0,i=p.length;e<i;e+=2)s.x+=p[e+0],s.y+=p[e+1],a.x=s.x,a.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&o.copy(s);break;case"c":p=n(d);for(let e=0,i=p.length;e<i;e+=6)t.bezierCurveTo(s.x+p[e+0],s.y+p[e+1],s.x+p[e+2],s.y+p[e+3],s.x+p[e+4],s.y+p[e+5]),a.x=s.x+p[e+2],a.y=s.y+p[e+3],s.x+=p[e+4],s.y+=p[e+5],0===e&&!0===h&&o.copy(s);break;case"s":p=n(d);for(let e=0,i=p.length;e<i;e+=4)t.bezierCurveTo(r(s.x,a.x),r(s.y,a.y),s.x+p[e+0],s.y+p[e+1],s.x+p[e+2],s.y+p[e+3]),a.x=s.x+p[e+0],a.y=s.y+p[e+1],s.x+=p[e+2],s.y+=p[e+3],0===e&&!0===h&&o.copy(s);break;case"q":p=n(d);for(let e=0,i=p.length;e<i;e+=4)t.quadraticCurveTo(s.x+p[e+0],s.y+p[e+1],s.x+p[e+2],s.y+p[e+3]),a.x=s.x+p[e+0],a.y=s.y+p[e+1],s.x+=p[e+2],s.y+=p[e+3],0===e&&!0===h&&o.copy(s);break;case"t":p=n(d);for(let e=0,i=p.length;e<i;e+=2){const i=r(s.x,a.x),n=r(s.y,a.y);t.quadraticCurveTo(i,n,s.x+p[e+0],s.y+p[e+1]),a.x=i,a.y=n,s.x=s.x+p[e+0],s.y=s.y+p[e+1],0===e&&!0===h&&o.copy(s)}break;case"a":p=n(d,[3,4],7);for(let e=0,r=p.length;e<r;e+=7){if(0==p[e+5]&&0==p[e+6])continue;const r=s.clone();s.x+=p[e+5],s.y+=p[e+6],a.x=s.x,a.y=s.y,i(t,p[e],p[e+1],p[e+2],p[e+3],p[e+4],r,s),0===e&&!0===h&&o.copy(s)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(s.copy(o),t.currentPath.currentPoint.copy(s),l=!0);break;default:console.warn(c)}h=!1}return t}(t));break;case"rect":s=a(t,s),B=function(e){const t=h(e.getAttribute("x")||0),i=h(e.getAttribute("y")||0),s=h(e.getAttribute("rx")||e.getAttribute("ry")||0),a=h(e.getAttribute("ry")||e.getAttribute("rx")||0),r=h(e.getAttribute("width")),n=h(e.getAttribute("height")),o=.448084975506,l=new de;l.moveTo(t+s,i),l.lineTo(t+r-s,i),(0!==s||0!==a)&&l.bezierCurveTo(t+r-s*o,i,t+r,i+a*o,t+r,i+a);l.lineTo(t+r,i+n-a),(0!==s||0!==a)&&l.bezierCurveTo(t+r,i+n-a*o,t+r-s*o,i+n,t+r-s,i+n);l.lineTo(t+s,i+n),(0!==s||0!==a)&&l.bezierCurveTo(t+s*o,i+n,t,i+n-a*o,t,i+n-a);l.lineTo(t,i+a),(0!==s||0!==a)&&l.bezierCurveTo(t,i+a*o,t+s*o,i,t+s,i);return l}(t);break;case"polygon":s=a(t,s),B=function(e){function t(e,t,i){const r=h(t),n=h(i);0===a?s.moveTo(r,n):s.lineTo(r,n),a++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,s=new de;let a=0;return e.getAttribute("points").replace(i,t),s.currentPath.autoClose=!0,s}(t);break;case"polyline":s=a(t,s),B=function(e){function t(e,t,i){const r=h(t),n=h(i);0===a?s.moveTo(r,n):s.lineTo(r,n),a++}const i=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,s=new de;let a=0;return e.getAttribute("points").replace(i,t),s.currentPath.autoClose=!1,s}(t);break;case"circle":s=a(t,s),B=function(e){const t=h(e.getAttribute("cx")||0),i=h(e.getAttribute("cy")||0),s=h(e.getAttribute("r")||0),a=new ue;a.absarc(t,i,s,0,2*Math.PI);const r=new de;return r.subPaths.push(a),r}(t);break;case"ellipse":s=a(t,s),B=function(e){const t=h(e.getAttribute("cx")||0),i=h(e.getAttribute("cy")||0),s=h(e.getAttribute("rx")||0),a=h(e.getAttribute("ry")||0),r=new ue;r.absellipse(t,i,s,a,0,2*Math.PI);const n=new de;return n.subPaths.push(r),n}(t);break;case"line":s=a(t,s),B=function(e){const t=h(e.getAttribute("x1")||0),i=h(e.getAttribute("y1")||0),s=h(e.getAttribute("x2")||0),a=h(e.getAttribute("y2")||0),r=new de;return r.moveTo(t,i),r.lineTo(s,a),r.currentPath.autoClose=!1,r}(t);break;case"defs":l=!0;break;case"use":s=a(t,s);const o=(t.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),c=t.viewportElement.getElementById(o);c?e(c,s):console.warn("SVGLoader: 'use node' references non-existent node id: "+o)}B&&(void 0!==s.fill&&"none"!==s.fill&&B.color.setStyle(s.fill,fs),function(e,t){function i(e){C.set(e.x,e.y,1).applyMatrix3(t),e.set(C.x,C.y)}function s(e){const i=e.xRadius,s=e.yRadius,a=Math.cos(e.aRotation),r=Math.sin(e.aRotation),n=new W(i*a,i*r,0),o=new W(-s*r,s*a,0),l=n.applyMatrix3(t),h=o.applyMatrix3(t),A=b.set(l.x,h.x,0,l.y,h.y,0,0,0,1),u=y.copy(A).invert(),d=w.copy(u).transpose().multiply(u).elements,p=function(e,t,i){let s,a,r,n,o;const l=e+i,h=e-i,c=Math.sqrt(h*h+4*t*t);l>0?(s=.5*(l+c),o=1/s,a=e*o*i-t*o*t):l<0?a=.5*(l-c):(s=.5*c,a=-.5*c);r=h>0?h+c:h-c;Math.abs(r)>2*Math.abs(t)?(o=-2*t/r,n=1/Math.sqrt(1+o*o),r=o*n):0===Math.abs(t)?(r=1,n=0):(o=-.5*r/t,r=1/Math.sqrt(1+o*o),n=o*r);h>0&&(o=r,r=-n,n=o);return{rt1:s,rt2:a,cs:r,sn:n}}(d[0],d[1],d[4]),g=Math.sqrt(p.rt1),m=Math.sqrt(p.rt2);e.xRadius=1/g,e.yRadius=1/m,e.aRotation=Math.atan2(p.sn,p.cs);if(!((e.aEndAngle-e.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const i=y.set(g,0,0,0,m,0,0,0,1),s=w.set(p.cs,p.sn,0,-p.sn,p.cs,0,0,0,1),a=i.multiply(s).multiply(A),r=e=>{const{x:t,y:i}=new W(Math.cos(e),Math.sin(e),0).applyMatrix3(a);return Math.atan2(i,t)};e.aStartAngle=r(e.aStartAngle),e.aEndAngle=r(e.aEndAngle),c(t)&&(e.aClockwise=!e.aClockwise)}}function a(e){const i=u(t),s=d(t);e.xRadius*=i,e.yRadius*=s;const a=i>Number.EPSILON?Math.atan2(t.elements[1],t.elements[0]):Math.atan2(-t.elements[3],t.elements[4]);e.aRotation+=a,c(t)&&(e.aStartAngle*=-1,e.aEndAngle*=-1,e.aClockwise=!e.aClockwise)}const r=e.subPaths;for(let e=0,n=r.length;e<n;e++){const n=r[e].curves;for(let e=0;e<n.length;e++){const r=n[e];r.isLineCurve?(i(r.v1),i(r.v2)):r.isCubicBezierCurve?(i(r.v0),i(r.v1),i(r.v2),i(r.v3)):r.isQuadraticBezierCurve?(i(r.v0),i(r.v1),i(r.v2)):r.isEllipseCurve&&(E.set(r.aX,r.aY),i(E),r.aX=E.x,r.aY=E.y,A(t)?s(r):a(r))}}}(B,v),p.push(B),B.userData={node:t,style:s});const x=t.childNodes;for(let t=0;t<x.length;t++){const i=x[t];l&&"style"!==i.nodeName&&"defs"!==i.nodeName||e(i,s)}o&&(f.pop(),f.length>0?v.copy(f[f.length-1]):v.identity())}(B.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:p,xml:B.documentElement}}static createShapes(e){const t=999999999,i=0,s=1,a=2,r=3,n=4,o=5,l=6,h={loc:i,t:0};function c(e,t,s,r){const n=e.x,o=t.x,l=s.x,c=r.x,u=e.y,d=t.y,p=s.y,g=r.y,m=(c-l)*(u-p)-(g-p)*(n-l),f=(g-p)*(o-n)-(c-l)*(d-u),b=m/f,y=((o-n)*(u-p)-(d-u)*(n-l))/f;if(0===f&&0!==m||b<=0||b>=1||y<0||y>1)return null;if(0===m&&0===f){for(let l=0;l<2;l++){if(A(0===l?s:r,e,t),h.loc==i){const e=0===l?s:r;return{x:e.x,y:e.y,t:h.t}}if(h.loc==a){return{x:+(n+h.t*(o-n)).toPrecision(10),y:+(u+h.t*(d-u)).toPrecision(10),t:h.t}}}return null}for(let a=0;a<2;a++)if(A(0===a?s:r,e,t),h.loc==i){const e=0===a?s:r;return{x:e.x,y:e.y,t:h.t}}return{x:+(n+b*(o-n)).toPrecision(10),y:+(u+b*(d-u)).toPrecision(10),t:b}}function A(e,t,c){const A=c.x-t.x,u=c.y-t.y,d=e.x-t.x,p=e.y-t.y,g=A*p-d*u;if(e.x===t.x&&e.y===t.y)return h.loc=i,void(h.t=0);if(e.x===c.x&&e.y===c.y)return h.loc=s,void(h.t=1);if(g<-Number.EPSILON)return void(h.loc=r);if(g>Number.EPSILON)return void(h.loc=n);if(A*d<0||u*p<0)return void(h.loc=o);if(Math.sqrt(A*A+u*u)<Math.sqrt(d*d+p*p))return void(h.loc=l);let m;m=0!==A?d/A:p/u,h.loc=a,h.t=m}function u(e,t,i){const s=new g;t.getCenter(s);const a=[];return i.forEach((t=>{if(t.boundingBox.containsPoint(s)){const i=function(e,t){const i=[],s=[];for(let a=1;a<e.length;a++){const r=e[a-1],n=e[a];for(let e=1;e<t.length;e++){const a=c(r,n,t[e-1],t[e]);null!==a&&void 0===i.find((e=>e.t<=a.t+Number.EPSILON&&e.t>=a.t-Number.EPSILON))&&(i.push(a),s.push(new g(a.x,a.y)))}}return s}(e,t.points);i.forEach((e=>{a.push({identifier:t.identifier,isCW:t.isCW,point:e})}))}})),a.sort(((e,t)=>e.point.x-t.point.x)),a}let d=t,p=-999999999,m=e.subPaths.map((e=>{const i=e.getPoints();let s=-999999999,a=t,r=-999999999,n=t;for(let e=0;e<i.length;e++){const t=i[e];t.y>s&&(s=t.y),t.y<a&&(a=t.y),t.x>r&&(r=t.x),t.x<n&&(n=t.x)}return p<=r&&(p=r+1),d>=n&&(d=n-1),{curves:e.curves,points:i,isCW:ce.isClockWise(i),identifier:-1,boundingBox:new he(new g(n,a),new g(r,s))}}));m=m.filter((e=>e.points.length>1));for(let e=0;e<m.length;e++)m[e].identifier=e;const f=m.map((t=>function(e,t,i,s,a){null!=a&&""!==a||(a="nonzero");const r=new g;e.boundingBox.getCenter(r);const n=u([new g(i,r.y),new g(s,r.y)],e.boundingBox,t);n.sort(((e,t)=>e.point.x-t.point.x));const o=[],l=[];n.forEach((t=>{t.identifier===e.identifier?o.push(t):l.push(t)}));const h=o[0].point.x,c=[];let A=0;for(;A<l.length&&l[A].point.x<h;)c.length>0&&c[c.length-1]===l[A].identifier?c.pop():c.push(l[A].identifier),A++;if(c.push(e.identifier),"evenodd"===a){const t=c.length%2==0,i=c[c.length-2];return{identifier:e.identifier,isHole:t,for:i}}if("nonzero"===a){let i=!0,s=null,a=null;for(let e=0;e<c.length;e++){const r=c[e];i?(a=t[r].isCW,i=!1,s=r):a!==t[r].isCW&&(a=t[r].isCW,i=!0)}return{identifier:e.identifier,isHole:i,for:s}}console.warn('fill-rule: "'+a+'" is currently not implemented.')}(t,m,d,p,e.userData?e.userData.style.fillRule:void 0))),b=[];return m.forEach((e=>{if(!f[e.identifier].isHole){const t=new Ae;t.curves=e.curves;const i=f.filter((t=>t.isHole&&t.for===e.identifier));i.forEach((e=>{const i=m[e.identifier],s=new ue;s.curves=i.curves,t.holes.push(s)})),b.push(t)}})),b}static getStrokeStyle(e,t,i,s,a){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:i=void 0!==i?i:"miter",strokeLineCap:s=void 0!==s?s:"butt",strokeMiterLimit:a=void 0!==a?a:4}}static pointsToStroke(e,i,a,r){const n=[],o=[],l=[];if(0===bs.pointsToStrokeWithBuffers(e,i,a,r,n,o,l))return null;const h=new t;return h.setAttribute("position",new s(n,3)),h.setAttribute("normal",new s(o,3)),h.setAttribute("uv",new s(l,2)),h}static pointsToStrokeWithBuffers(e,t,i,s,a,r,n,o){const l=new g,h=new g,c=new g,A=new g,u=new g,d=new g,p=new g,m=new g,f=new g,b=new g,y=new g,w=new g,I=new g,E=new g,C=new g,v=new g,B=new g;i=void 0!==i?i:12,s=void 0!==s?s:.001,o=void 0!==o?o:0,e=function(e){let t=!1;for(let i=1,a=e.length-1;i<a;i++)if(e[i].distanceTo(e[i+1])<s){t=!0;break}if(!t)return e;const i=[];i.push(e[0]);for(let t=1,a=e.length-1;t<a;t++)e[t].distanceTo(e[t+1])>=s&&i.push(e[t]);return i.push(e[e.length-1]),i}(e);const x=e.length;if(x<2)return 0;const k=e[0].equals(e[x-1]);let Q,S,M=e[0];const R=t.strokeWidth/2,D=1/(x-1);let T,F,L,P,_=0,z=!1,U=0,N=3*o,G=2*o;O(e[0],e[1],l).multiplyScalar(R),m.copy(e[0]).sub(l),f.copy(e[0]).add(l),b.copy(m),y.copy(f);for(let i=1;i<x;i++){Q=e[i],S=i===x-1?k?e[1]:void 0:e[i+1];const s=l;if(O(M,Q,s),c.copy(s).multiplyScalar(R),w.copy(Q).sub(c),I.copy(Q).add(c),T=_+D,F=!1,void 0!==S){O(Q,S,h),c.copy(h).multiplyScalar(R),E.copy(Q).sub(c),C.copy(Q).add(c),L=!0,c.subVectors(S,M),s.dot(c)<0&&(L=!1),1===i&&(z=L),c.subVectors(S,Q),c.normalize();const e=Math.abs(s.dot(c));if(e>Number.EPSILON){const i=R/e;c.multiplyScalar(-i),A.subVectors(Q,M),u.copy(A).setLength(i).add(c),v.copy(u).negate();const s=u.length(),a=A.length();A.divideScalar(a),d.subVectors(S,Q);const r=d.length();switch(d.divideScalar(r),A.dot(v)<a&&d.dot(v)<r&&(F=!0),B.copy(u).add(Q),v.add(Q),P=!1,F?L?(C.copy(v),I.copy(v)):(E.copy(v),w.copy(v)):H(),t.strokeLineJoin){case"bevel":V(L,F,T);break;case"round":K(L,F),L?j(Q,w,E,T,0):j(Q,C,I,T,1);break;default:const e=R*t.strokeMiterLimit/s;if(e<1){if("miter-clip"!==t.strokeLineJoin){V(L,F,T);break}K(L,F),L?(d.subVectors(B,w).multiplyScalar(e).add(w),p.subVectors(B,E).multiplyScalar(e).add(E),q(w,T,0),q(d,T,0),q(Q,T,.5),q(Q,T,.5),q(d,T,0),q(p,T,0),q(Q,T,.5),q(p,T,0),q(E,T,0)):(d.subVectors(B,I).multiplyScalar(e).add(I),p.subVectors(B,C).multiplyScalar(e).add(C),q(I,T,1),q(d,T,1),q(Q,T,.5),q(Q,T,.5),q(d,T,1),q(p,T,1),q(Q,T,.5),q(p,T,1),q(C,T,1))}else F?(L?(q(f,_,1),q(m,_,0),q(B,T,0),q(f,_,1),q(B,T,0),q(v,T,1)):(q(f,_,1),q(m,_,0),q(B,T,1),q(m,_,0),q(v,T,0),q(B,T,1)),L?E.copy(B):C.copy(B)):L?(q(w,T,0),q(B,T,0),q(Q,T,.5),q(Q,T,.5),q(B,T,0),q(E,T,0)):(q(I,T,1),q(B,T,1),q(Q,T,.5),q(Q,T,.5),q(B,T,1),q(C,T,1)),P=!0}}else H()}else H();k||i!==x-1||W(e[0],b,y,L,!0,_),_=T,M=Q,m.copy(E),f.copy(C)}if(k){if(F&&a){let e=B,t=v;z!==L&&(e=v,t=B),L?(P||z)&&(t.toArray(a,0),t.toArray(a,9),P&&e.toArray(a,3)):!P&&z||(t.toArray(a,3),t.toArray(a,9),P&&e.toArray(a,0))}}else W(Q,w,I,L,!1,T);return U;function O(e,t,i){return i.subVectors(t,e),i.set(-i.y,i.x).normalize()}function q(e,t,i){a&&(a[N]=e.x,a[N+1]=e.y,a[N+2]=0,r&&(r[N]=0,r[N+1]=0,r[N+2]=1),N+=3,n&&(n[G]=t,n[G+1]=i,G+=2)),U+=3}function j(e,t,s,a,r){l.copy(t).sub(e).normalize(),h.copy(s).sub(e).normalize();let n=Math.PI;const o=l.dot(h);Math.abs(o)<1&&(n=Math.abs(Math.acos(o))),n/=i,c.copy(t);for(let t=0,s=i-1;t<s;t++)A.copy(c).rotateAround(e,n),q(c,a,r),q(A,a,r),q(e,a,.5),c.copy(A);q(A,a,r),q(s,a,r),q(e,a,.5)}function H(){q(f,_,1),q(m,_,0),q(w,T,0),q(f,_,1),q(w,T,1),q(I,T,0)}function V(e,t,i){t?e?(q(f,_,1),q(m,_,0),q(w,T,0),q(f,_,1),q(w,T,0),q(v,T,1),q(w,i,0),q(E,i,0),q(v,i,.5)):(q(f,_,1),q(m,_,0),q(I,T,1),q(m,_,0),q(v,T,0),q(I,T,1),q(I,i,1),q(C,i,0),q(v,i,.5)):e?(q(w,i,0),q(E,i,0),q(Q,i,.5)):(q(I,i,1),q(C,i,0),q(Q,i,.5))}function K(e,t){t&&(e?(q(f,_,1),q(m,_,0),q(w,T,0),q(f,_,1),q(w,T,0),q(v,T,1),q(w,_,0),q(Q,T,.5),q(v,T,1),q(Q,T,.5),q(E,_,0),q(v,T,1)):(q(f,_,1),q(m,_,0),q(I,T,1),q(m,_,0),q(v,T,0),q(I,T,1),q(I,_,1),q(v,T,0),q(Q,T,.5),q(Q,T,.5),q(v,T,0),q(C,_,1)))}function W(e,i,s,r,n,o){switch(t.strokeLineCap){case"round":n?j(e,s,i,o,.5):j(e,i,s,o,.5);break;case"square":if(n)l.subVectors(i,e),h.set(l.y,-l.x),c.addVectors(l,h).add(e),A.subVectors(h,l).add(e),r?(c.toArray(a,3),A.toArray(a,0),A.toArray(a,9)):(c.toArray(a,3),c.toArray(a,9),A.toArray(a,0));else{l.subVectors(s,e),h.set(l.y,-l.x),c.addVectors(l,h).add(e),A.subVectors(h,l).add(e);const t=a.length;r?(c.toArray(a,t-3),A.toArray(a,t-6),A.toArray(a,t-12)):(c.toArray(a,t-6),A.toArray(a,t-3),A.toArray(a,t-12))}}}}}class ys extends Z{constructor(e,t={},i=null){if(super(),this.model=e,this.material=i,this.outMaterial=!!i,this.XML=new XMLSerializer,this.color=new p,this.opacity=1,this.svgLoader=new bs,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=t.size||1,this.scaler=1/this.size,!this.model)return;let s={radius:5,min:90,max:90,strokeSize:.25,...t};switch(this.model){case"angle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke;let e=Math.abs(s.min);this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,s.radius,180-e,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180-e,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let t=.5*s.radius,i=s.max*this.scaler,a=s.min*this.scaler;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.segment({x:-t,y:0},{x:t,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-t,y:i},{x:t,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-t,y:a},{x:t,y:a}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:a}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let r=.5*s.radius;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-r},{x:0,y:r}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-r,y:0},{x:r,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(e={}){let t={};if("angle"===this.model){t={radius:5,min:-90,max:90,...e};let i=Math.abs(t.min);this.change("d",this.circle(0,0,t.radius,180,180+t.max,!0),0),this.change("d",this.circle(0,0,t.radius,180,180+t.max,!1,!1,.3),1),this.change("d",this.circle(0,0,t.radius,180-i,180,!0),2),this.change("d",this.circle(0,0,t.radius,180-i,180,!1,!1,.3,!0),3)}void 0!==e.wireframe&&(this.material.wireframe=e.wireframe),this.fill=void 0===t.fill||t.fill,this.stroke=void 0===t.stroke||t.stroke,this.toMesh()}set(e={},t){for(let i in e)t?t.setAttributeNS(null,i,e[i]):this.svg.setAttributeNS(null,i,e[i])}add(e,t={}){let i=document.createElementNS(this.base,e);this.set(t,i),this.svg.appendChild(i)}change(e,t,i){this.svg.childNodes[i].setAttributeNS(null,e,t)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(e,t,i,s){var a=(s-90)*Math.PI/180;return{x:e+i*Math.cos(a),y:t+i*Math.sin(a)}}circle(e,t,i,s=0,a=360,r=!1,n=!1,o=0,l=!1){0===s&&360===a&&(s=1e-4,n=!0);let h=this.polarToCartesian(e,t,i,a),c=this.polarToCartesian(e,t,i,s),A=a-s<=180?"0":"1",u=["M",h.x,h.y,"A",i,i,0,A,0,c.x,c.y];if(r&&u.push("L",e,t,"L",h.x,h.y),n&&u.push("Z"),0!==o){let r=this.polarToCartesian(e,t,i-o,l?s:a),n=this.polarToCartesian(e,t,i+o,l?s:a);u.push("M",r.x,r.y,"L",n.x,n.y)}return u.join(" ")}segment(e,t){return["M",e.x,e.y,"L",t.x,t.y].join(" ")}geomColor(e,t,i=1){let a=e.attributes.position.count,r=[];for(;a--;)r.push(t.r,t.g,t.b,i);e.setAttribute("color",new s(r,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let e=[],i=0,s=1,a=this.svgLoader.parse(this.getString());for(const r of a.paths){const a=r.userData.style.fill;if(this.fill&&void 0!==a&&"none"!==a){this.color.setStyle(a),s=r.userData.style.fillOpacity,s<this.opacity&&(this.opacity=s);const n=bs.createShapes(r);for(const a of n){const r=new pe(a);if(r){this.geomColor(r,this.color,s);let a=(new t).copy(r).toNonIndexed();a.translate(0,0,-i*this.layerUp),e.push(a),i++}}}const n=r.userData.style.stroke;if(this.stroke&&void 0!==n&&"none"!==n){this.color.setStyle(n),s=r.userData.style.strokeOpacity,s<this.opacity&&(this.opacity=s);for(const t of r.subPaths){const a=bs.pointsToStroke(t.getPoints(),r.userData.style,6);a&&(this.geomColor(a,this.color,s),a.translate(0,0,-i*this.layerUp),e.push(a),i++)}}}return e}toMesh(){let e=this.size;this.geometry&&this.geometry.dispose();let i=this.toGeometry();i?(this.geometry=ps(i),this.geometry.scale(e,-e,e),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new t,null===this.material&&(this.material=new w({vertexColors:!0,transparent:1!==this.opacity,side:C}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class ws extends ie{constructor(i={},a){super(),this.motor=a,this.isJoint=!0,this.type="joint",this.mode=i.mode||"hinge",this.visible=void 0!==i.visible&&i.visible,this.mtx=new J,this.size=i.helperSize||.1,this.matrixAutoUpdate=!1;let r,n,o=this.motor.mat.get("line");switch(this.mode){case"prismatic":r=this.motor.mat.get("svg"),n={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},i.lm&&(n.min=i.lm[0],n.max=i.lm[1]),this.m1=new ys("liner",n,r),this.m2=new ys("middle",n,r),this.m1.geometry.rotateY(90*ci.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":r=this.motor.mat.get("svg"),n={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},i.lm&&(n.min=i.lm[0],n.max=i.lm[1]),i.lmr&&(n.min=i.lmr[0],n.max=i.lmr[1]),this.m1=new ys("angle",n,r),this.m2=new ys("needle",n,r),this.add(this.m1),this.add(this.m2);break;default:const t=this.motor.geo.get("joint");let s=t.clone();s.scale(this.size,this.size,this.size),this.m1=new e(s,o),this.add(this.m1),s=t.clone(),s.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new e(s,o),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new J,this.mat2=new J,this.end=new W;let l=new Y;i.quat1&&this.mat1.makeRotationFromQuaternion(l.fromArray(i.quat1)),i.quat2&&this.mat2.makeRotationFromQuaternion(l.fromArray(i.quat2)),this.mat1.setPosition(i.pos1[0],i.pos1[1],i.pos1[2]),this.mat2.setPosition(i.pos2[0],i.pos2[1],i.pos2[2]);const h=new t;h.setAttribute("position",new s([0,0,0,0,0,0],3)),h.setAttribute("color",new s([1,0,0,1,0,0],3)),h.computeBoundingSphere(),this.m3=new e(h,o),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()))}updateFromPhy(e,t=0){this.visible&&(this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Is extends Fi{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new W,this.v2=new W}step(e,t){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*yi.joint,16===yi.joint?i.updateFromPhy(e,s):i.update()}add(e={}){let t,i=this.setName(e),s=null,a=null,r=!1;if(e.axis1||(e.axis1=[1,0,0]),e.axis2||(e.axis2=[1,0,0]),e.pos1||(e.pos1=[0,0,0]),e.pos2||(e.pos2=[0,0,0]),e.limit?e.lm=e.limit:e.lm&&(e.limit=e.lm),"universal"!==e.mode&&"dof"!==e.mode&&"d6"!==e.mode||(e.mode="generic"),"revolute"===e.mode&&(e.mode="hinge"),"slider"===e.mode&&(e.mode="cylindrical"),e.b1&&(t="string"==typeof e.b1,s=t?this.Utils.byName(e.b1):e.b1,t||(e.b1=e.b1.name),s&&s.link++),e.b2&&(t="string"==typeof e.b2,a=t?this.Utils.byName(e.b2):e.b2,t||(e.b2=e.b2.name),a&&a.link++),e.worldPos&&(e.worldAnchor=e.worldPos),e.worldAnchor&&(e.pos1=s?this.Utils.toLocal(this.v1.fromArray(e.worldAnchor),s).toArray():e.worldAnchor,e.pos2=a?this.Utils.toLocal(this.v2.fromArray(e.worldAnchor),a).toArray():e.worldAnchor,delete e.worldAnchor),e.worldAxis&&(e.axis1=s?this.Utils.toLocal(this.v1.fromArray(e.worldAxis),s,!0).toArray():e.worldAxis,e.axis2=a?this.Utils.toLocal(this.v2.fromArray(e.worldAxis),a,!0).toArray():e.worldAxis,r=!0,delete e.worldAxis),e.worldQuat&&(e.quat1=this.Utils.quatLocal(e.worldQuat,s),e.quat2=this.Utils.quatLocal(e.worldQuat,a),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(e.axis1=this.Utils.axisLocal(ci.quatToAxis(e.worldQuat),s),e.axis2=this.Utils.axisLocal(ci.quatToAxis(e.worldQuat),a)),delete e.worldQuat),void 0!==e.rot1&&(e.quat1=ci.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=ci.quatFromEuler(e.rot2),delete e.rot2),e.quat1||(e.quat1=(new Y).setFromUnitVectors(new W(1,0,0),(new W).fromArray(e.axis1).normalize()).toArray()),e.quat2||(e.quat2=(new Y).setFromUnitVectors(new W(1,0,0),(new W).fromArray(e.axis2).normalize()).toArray()),"AMMO"===this.engine&&r&&"hinge"===e.mode){let t=new ge(0,-90*ri,0),i=(new Y).setFromEuler(t).toArray();e.quatX=i}e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=ci.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot);let n=new ws(e,this.motor);return n.name=i,n.body1=s,n.body2=a,void 0===e.visible&&(e.visible=this.motor.jointVisible||!1),this.set(e,n),this.addToWorld(n,e.id),this.motor.post({m:"add",o:e}),n}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&void 0!==e.visible&&(t.visible=e.visible)}}class Es extends Fi{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="contact"}step(e,t){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=t+a*yi.contact,i.update(e,s)}add(e={}){this.setName(e);let t=new Cs(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),this.motor.post({m:"add",o:e}),t}}class Cs{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}detectBody(){}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}let vs=null;class Bs extends Fi{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.motor.geo,vs=this.motor.mat,this.type="vehicle",this.num=yi[this.type]}step(e,t){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*this.num,s.step(e,i)}add(e={}){this.setName(e);const t=new xs(e,this.motor);return this.addToWorld(t,e.id),this.motor.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}class xs extends ie{constructor(e,t){super(),this.motor=t,this.Utils=this.motor.utils,this.velocity=new W,this.angular=new W,e.extra&&(this.extra=e.extra,delete e.extra),this.type="vehicle",this.name=e.name||"car",this.isRay=e.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(e)}drive(){}raycast(){}init(e){this.mass=e.mass||2e3,this.model=null,this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.maxSteering=e.maxSteering||24,this.incSteering=e.incSteering||2,this.s_travel=e.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep;let t=this.numWheel<4?1:2;if(e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){this.wPos=e.wPos;var i,s,a,r,n,o,l=e.wPos,h=[],c=1,A=0;l.length,l.length;for(let e=0;e<this.numWheel;e++)c=e%2==0?-1:1,s=Math.floor(.5*e),A=e>=t,0===(a=l[1])&&(a=A?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][s]),n=A?-l[2]:l[2],l[2]instanceof Array&&(n=l[2][s]),i=[r*c,a,n],h.push(i);this.wheelsPosition=h,delete e.wPos}e.wheelsPosition&&(this.wheelsPosition=e.wheelsPosition);const u=e.meshScale||1,d=[];e.chassisShape?d.push({type:"convex",shape:e.chassisShape,size:[u],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):d.push({type:"box",size:this.size,pos:this.chassisPos});for(let i=0;i<this.numWheel;i++)i<t?d.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1}):d.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1});var p=vs.get(e.debug?"debug":void 0===e.chassisMesh?"body":"hide");let g,m;for(let e=0;e<d.length;e++)g=d[e],g.pos&&(g.localPos=g.pos),g.size=ci.autoSize(g.size,g.type),this.motor.getGeometryRef(g,this,p);if(e.chassisMesh&&(m=e.noClone?e.chassisMesh:e.chassisMesh.clone(),m.position.set(0,0,0),this.Utils.noRay(m),m.scale.set(u,u,u),this.children[0].add(m),this.model=m,delete e.chassisMesh),e.wheelMesh){for(let i=1;i<this.numWheel+1;i++)A=i>=t+1,m=e.wheelMeshBack&&A?e.wheelMeshBack.clone():e.wheelMesh.clone(),this.Utils.noRay(m),m.position.set(0,0,0),2==i||4==i?m.scale.set(-u,u,u):m.scale.set(u,u,u),this.children[i].add(m);delete e.wheelMesh}if(e.suspensionMesh){this.suspensionMesh=[];for(let t=1;t<this.numWheel+1;t++)m=e.suspensionMesh.clone(),this.Utils.noRay(m),m.position.set(0,0,0),m.position.fromArray(this.wheelsPosition[t-1]),m.position.x=0,2==t||4==t?m.scale.set(u,u,u):m.scale.set(-u,u,u),this.children[0].add(m),this.suspensionMesh.push(m);delete e.suspensionMesh}if(e.brakeMesh){this.brake=[];for(let t=1;t<this.numWheel+1;t++)A=t>2,m=e.brakeMeshBack&&A?e.brakeMeshBack.clone():e.brakeMesh.clone(),this.Utils.noRay(m),m.position.set(0,0,0),m.position.fromArray(this.wheelsPosition[t-1]),o=e.brakeMeshBack||A?u:-u,2==t||4==t?m.scale.set(-u,u,o):m.scale.set(u,u,o),this.children[0].add(m),this.brake.push(m);delete e.brakeMesh}e.mass=this.mass,e.size=e.chassisShape?d[0].boxSize:this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=d[0],e.maxSteering=this.maxSteering,e.incSteering=this.incSteering,e.s_travel=this.s_travel,e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}set(e){e.name=this.name,this.motor.change(e)}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.quaternion.toArray()),this.motor.change(e)}move(){}dispose(){}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.updateMatrix();let i,s=this.numWheel+1,a=0,r=0,n=[],o=0;for(let l=0;l<s;l++)o=8*l+t,0===l&&(e[o],this.circum),1===l&&(a=e[o]),2===l&&(r=e[o]),i=this.children[l],i&&l>0&&(n[l-1]=this.wheelsPosition[l-1][1]-this.decaly-e[o+2],i.position.fromArray(e,o+1),i.quaternion.fromArray(e,o+4),this.rolling[l-1]=i.rotation.x,this.brake&&(this.brake[l-1].position.copy(i.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=e[o])));for(o=4;o--;)this.suspension[o]=ci.clamp(n[o]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[o]>0?(this.Utils.morph(this.suspensionMesh[o].children[0],"low",this.suspension[o]),this.Utils.morph(this.suspensionMesh[o].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[o].children[0],"low",0),this.Utils.morph(this.suspensionMesh[o].children[0],"top",-this.suspension[o])));this.steering=Math.round(.5*(a+r)*ni)/this.maxSteering}}const ks=new J,Qs=new W,Ss=new Y,Ms=new W,Rs=new J,Ds=new J,Ts=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Fs extends ie{constructor(e,t,i,s,a=null,r={}){super(),this.motor=e,this.prefix=t||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=i,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=a,this.friction=.5,this.restitution=0,this.option=r,this.useDrive=void 0===r.useDrive||r.useDrive,this.showJoint=void 0!==r.showJoint&&r.showJoint,this.init()}setMass(e){if(e===this.mass)return;this.mass=e;const t=[];let i=this.nodes.length,s=this.mass/i;for(;i--;)t.push({name:this.nodes[i].name,mass:s});this.motor.change(t)}setMode(e){if(e===this.mode)return;this.mode=e;const t=[];let i,s="follow"===this.mode,a=this.nodes.length;for(;a--;)i=this.nodes[a],t.push({name:i.name,kinematic:s}),i.kinematic=s,i.bone.isPhysics=!s;this.motor.change(t)}freeBone(e){e.kinematic&&(e.cc++,20===e.cc&&(e.cc=0,e.kinematic=!1,e.bone.isPhysics=!0,this.motor.change({name:e.name,kinematic:!1})))}isVisible(e){let t=this.nameList.length;for(;t--;)this.motor.byName(this.nameList[t]).visible=e}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const e=[];let t=(new J).makeScale(this.scaler,this.scaler,this.scaler),i=new W,s=new W,a=new Y,r=new ge,n=new J,o=new J,l=new J;Rs.copy(this.model.matrixWorld).invert();let h=new W,c=new W,A=[1,1,1,1,1,1,1];this.option.sizer&&(A=this.option.sizer);let u,d,p,g,m,f,b,y,w,I,E,C,v,B=this.bones.length,x=0;for(this.mass&&(x=this.mass/B),u=0;u<B;u++)if(w=null,g=this.bones[u],d=g.name,m=g.parent,m){p=m.name,Ds.multiplyMatrices(Rs,g.matrixWorld),h.setFromMatrixPosition(Ds),Ds.multiplyMatrices(Rs,m.matrixWorld),c.setFromMatrixPosition(Ds),b=h.distanceTo(c),E=[0,0,.5*b],f=[b,1,1],y=null,I=!0,v=!1,"hip"===p&&"abdomen"===d&&(w="capsule",f=[b*A[0],.08],E=[0,0,-b*A[0]],y=[0,0,90]),"abdomen"===p&&"chest"===d&&(w="capsule",f=[.7*b*A[1],.08],E=[0,0,.5*-b-.06],y=[90,0,0]),"chest"===p&&"neck"===d&&(w="capsule",f=[.4*b*A[2],.04],E=[0,0,.5*-b-.02],y=[0,0,90]),"neck"===p&&"head"===d&&(w="capsule",f=[.06*A[3],b],E=[0,0,.5*-b],y=[90,0,0]),"head"===p&&"End_head"===d&&(w="capsule",f=[.1*A[4],b-.17],E=[0,.02,.5*-b+.02],y=[90,0,0]),"chest"===p&&"rBreast"===d&&"HAVOK"!==this.motor.engine&&(p="rBreast",m=g,w="sphere",f=[.065],E=[.065,0,0],this.breast=!0,v=!0),"chest"===p&&"lBreast"===d&&"HAVOK"!==this.motor.engine&&(p="lBreast",m=g,w="sphere",f=[.065],E=[.065,0,0],this.breast=!0,v=!0);let u=.04*A[5],B=b-u;if("lCollar"===p&&"lShldr"===d&&(w="capsule",f=[u,.3*b],E=[.6*b,0,0],y=[0,0,90]),"lShldr"===p&&"lForeArm"===d&&(w="capsule",f=[u,B],E=[.5*B,0,0],y=[0,0,90]),"lForeArm"===p&&"lHand"===d&&(w="capsule",f=[u,B],E=[.5*B,0,0],y=[0,0,90]),"lHand"===p&&"lMid1"===d&&(w="box",f=[2*b,.09,.05],E=[b,0,0]),"rCollar"===p&&"rShldr"===d&&(w="capsule",f=[u,.3*b],E=[.6*-b,0,0],y=[0,0,90]),"rShldr"===p&&"rForeArm"===d&&(w="capsule",f=[u,B],E=[.5*-B,0,0],y=[0,0,90]),"rForeArm"===p&&"rHand"===d&&(w="capsule",f=[u,B],E=[.5*-B,0,0],y=[0,0,90]),"rHand"===p&&"rMid1"===d&&(w="box",f=[2*b,.09,.05],E=[-b,0,0]),u=.06*A[6],B=b-u,"lThigh"===p&&(w="capsule",f=[u,b],y=[90,0,0],E=[0,0,.5*B]),"lShin"===p&&(w="capsule",f=[u,b],y=[90,0,0],E=[0,0,.5*B]),"lFoot"===p&&(w="capsule",f=[.05,b],E=[0,.5*b-.025,.04]),"rThigh"===p&&(w="capsule",f=[u,b],y=[90,0,0],E=[0,0,.5*B]),"rShin"===p&&(w="capsule",f=[u,b],y=[90,0,0],E=[0,0,.5*B]),"rFoot"===p&&(w="capsule",f=[.05,b],E=[0,.5*b-.025,.04]),u=.04,B=b-u,"rEar_0"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("rEar_0")),"rEar_1"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("rEar_1")),"rEar_2"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("rEar_2")),"rEar_3"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0]),"lEar_0"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("lEar_0")),"lEar_1"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("lEar_1")),"lEar_2"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0],Ts.push("lEar_2")),"lEar_3"===p&&(w="capsule",f=[u,b],y=[0,0,90],E=[.5*B,0,0]),this.withFinger&&("lHand"===p&&"lMid1"===d&&(w="box",f=[b,.09,.05],E=[.5*b,0,0]),"rHand"===p&&"rMid1"===d&&(w="box",f=[b,.09,.05],E=[.5*-b,0,0]),"rThumb1"===p&&"rThumb2"===d&&(w="capsule",f=[.02,b],y=[0,0,90]),"rThumb2"===p&&"rThumb3"===d&&(w="capsule",f=[.02,b],y=[0,0,90]),"rHand"===p&&"rMid1"===d&&(w="capsule",f=[.02,b],y=[0,0,90],E=[.6*-b,0,0]),"rMid1"===p&&"rMid2"===d&&(w="capsule",f=[.02,b],y=[0,0,90],E=[.6*-b,0,0]),"rMid2"===p&&"rMid3"===d&&(w="capsule",f=[.02,b],y=[0,0,90],E=[.6*-b,0,0])),null!==w){C=this.prefix+"_bone_"+p,o.makeTranslation(E[0],E[1],E[2]),y&&(l.makeRotationFromEuler(r.set(y[0]*ri,y[1]*ri,y[2]*ri)),o.multiply(l)),m.updateWorldMatrix(!0,!1),Ds.multiplyMatrices(Rs,m.matrixWorld),n.copy(Ds),n.decompose(i,a,s),this.posRef[C]=i.toArray(),"lForeArm"!==p&&"rForeArm"!==p||(Ss.setFromAxisAngle({x:0,y:1,z:0},-90*ri),a.multiply(Ss)),this.quatRef[C]=a.toArray(),n.multiplyMatrices(Ds,o),n.decompose(i,a,s),this.nameList.push(C);let h={name:C,friction:this.friction,restitution:this.restitution,type:w,size:ci.scaleArray(f,this.scaler,3),pos:i.toArray(),quat:a.toArray(),kinematic:I,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==Ts.indexOf(p)&&(h.aggregate=this.prefix+"__Group",h.aggregateMax=21),h.mask=3;else{let e=3;"lForeArm"!==p&&"rForeArm"!==p&&"lShin"!==p&&"rShin"!==p||(e=35),"rEar_1"!==p&&"rEar_2"!==p&&"rEar_3"!==p&&"lEar_1"!==p&&"lEar_2"!==p&&"lEar_3"!==p||(e=35),"rEar_0"!==p&&"rEar_0"!==p||(e=0),h.group=32,h.mask=e}null!==this.mass?h.mass=x:h.density=1,e.push(h);let c=o.clone().invert().premultiply(t);this.nodes.push({name:C,kinematic:I,motion:v,bone:m,decal:o.clone(),decalinv:c,quat:a.toArray(),pos:i.toArray(),cc:0})}}this.motor.add(e),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(e){return-1!==this.nameList.indexOf(e)}addLink(){let e=[.05,1,0];"PHYSX"===this.motor.engine&&(e=[50,10,0,.5]);let t=2,i=.1,s=1e7,a=!1,r=this.prefix+"_bone_",n=[],o={type:"joint",mode:"d6",lm:[["ry",-180,180,...e],["rz",-180,180,...e]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(o.drives=[["rx",t,i,s,a],["ry",t,i,s,a],["rz",t,i,s,a]]);let l=[-.001,.001,100,.2,.5];n.push({...o,b1:r+"hip",b2:r+"abdomen",worldPos:this.posRef[r+"abdomen"],worldQuat:this.quatRef[r+"hip"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),n.push({...o,b1:r+"abdomen",b2:r+"chest",worldPos:this.posRef[r+"chest"],worldQuat:this.quatRef[r+"chest"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),n.push({...o,b1:r+"chest",b2:r+"neck",worldPos:this.posRef[r+"neck"],worldQuat:this.quatRef[r+"neck"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),n.push({...o,b1:r+"neck",b2:r+"head",worldPos:this.posRef[r+"head"],worldQuat:this.quatRef[r+"head"],lm:[["rx",0,30,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),n.push({...o,b1:r+"chest",b2:r+"rCollar",worldPos:this.posRef[r+"rCollar"],worldQuat:this.quatRef[r+"rCollar"],mode:"fixe"}),n.push({...o,b1:r+"chest",b2:r+"lCollar",worldPos:this.posRef[r+"lCollar"],worldQuat:this.quatRef[r+"lCollar"],mode:"fixe"}),n.push({...o,b1:r+"rCollar",b2:r+"rShldr",worldPos:this.posRef[r+"rShldr"],worldQuat:this.quatRef[r+"rShldr"]}),n.push({...o,b1:r+"lCollar",b2:r+"lShldr",worldPos:this.posRef[r+"lShldr"],worldQuat:this.quatRef[r+"lShldr"]}),this.existe(r+"rForeArm")&&n.push({...o,b1:r+"rShldr",b2:r+"rForeArm",worldPos:this.posRef[r+"rForeArm"],worldQuat:this.quatRef[r+"rForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"lForeArm")&&n.push({...o,b1:r+"lShldr",b2:r+"lForeArm",worldPos:this.posRef[r+"lForeArm"],worldQuat:this.quatRef[r+"lForeArm"],lm:[["rx",0,160,...e]]}),this.existe(r+"rHand")&&n.push({...o,b1:r+"rForeArm",b2:r+"rHand",worldPos:this.posRef[r+"rHand"],worldQuat:this.quatRef[r+"rHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),this.existe(r+"lHand")&&n.push({...o,b1:r+"lForeArm",b2:r+"lHand",worldPos:this.posRef[r+"lHand"],worldQuat:this.quatRef[r+"lHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),n.push({...o,b1:r+"hip",b2:r+"rThigh",worldPos:this.posRef[r+"rThigh"],worldQuat:this.quatRef[r+"rThigh"]}),n.push({...o,b1:r+"hip",b2:r+"lThigh",worldPos:this.posRef[r+"lThigh"],worldQuat:this.quatRef[r+"lThigh"]}),this.existe(r+"rShin")&&n.push({...o,b1:r+"rThigh",b2:r+"rShin",worldPos:this.posRef[r+"rShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"rShin"]}),this.existe(r+"lShin")&&n.push({...o,b1:r+"lThigh",b2:r+"lShin",worldPos:this.posRef[r+"lShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[r+"lShin"]}),this.existe(r+"rFoot")&&n.push({...o,b1:r+"rShin",b2:r+"rFoot",worldPos:this.posRef[r+"rFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"rFoot"]}),this.existe(r+"lFoot")&&n.push({...o,b1:r+"lShin",b2:r+"lFoot",worldPos:this.posRef[r+"lFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[r+"lFoot"]}),this.breast&&(this.existe(r+"rBreast")&&n.push({...o,b1:r+"chest",b2:r+"rBreast",worldPos:this.posRef[r+"rBreast"],worldQuat:this.quatRef[r+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(r+"lBreast")&&n.push({...o,b1:r+"chest",b2:r+"lBreast",worldPos:this.posRef[r+"lBreast"],worldQuat:this.quatRef[r+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(r+"lEar_0")&&n.push({...o,b1:r+"head",b2:r+"lEar_0",worldPos:this.posRef[r+"lEar_0"],worldQuat:this.quatRef[r+"lEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_1")&&n.push({...o,b1:r+"lEar_0",b2:r+"lEar_1",worldPos:this.posRef[r+"lEar_1"],worldQuat:this.quatRef[r+"lEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_2")&&n.push({...o,b1:r+"lEar_1",b2:r+"lEar_2",worldPos:this.posRef[r+"lEar_2"],worldQuat:this.quatRef[r+"lEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"lEar_3")&&n.push({...o,b1:r+"lEar_2",b2:r+"lEar_3",worldPos:this.posRef[r+"lEar_3"],worldQuat:this.quatRef[r+"lEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_0")&&n.push({...o,b1:r+"head",b2:r+"rEar_0",worldPos:this.posRef[r+"rEar_0"],worldQuat:this.quatRef[r+"rEar_0"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_1")&&n.push({...o,b1:r+"rEar_0",b2:r+"rEar_1",worldPos:this.posRef[r+"rEar_1"],worldQuat:this.quatRef[r+"rEar_1"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_2")&&n.push({...o,b1:r+"rEar_1",b2:r+"rEar_2",worldPos:this.posRef[r+"rEar_2"],worldQuat:this.quatRef[r+"rEar_2"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]}),this.existe(r+"rEar_3")&&n.push({...o,b1:r+"rEar_2",b2:r+"rEar_3",worldPos:this.posRef[r+"rEar_3"],worldQuat:this.quatRef[r+"rEar_3"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]]});let h=0;for(let e in n)n[e].name=this.prefix+"_joint_"+h,this.jointList.push(n[e].name),h++;this.motor.add(n)}updateMatrixWorld(e){if(!this.ready)return;let t=[];const i=this.nodes;let s,a,r,n=i.length,o=0;for(;n--;)s=i[o],a=s.bone,o++,s.kinematic?(ks.multiplyMatrices(a.matrixWorld,s.decal),ks.decompose(Qs,Ss,Ms),s.pos=Qs.toArray(),s.quat=Ss.toArray(),t.push({name:s.name,pos:s.pos,quat:s.quat}),s.motion&&this.freeBone(s)):(r=this.motor.byName(s.name),r&&(ks.copy(r.matrixWorld).multiply(s.decalinv),a.phyMtx.copy(ks),a.isPhysics=!0));0!==t.length&&this.motor.change(t,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}function Ls(e){const t=new Map,i=new Map,s=e.clone();return Ps(e,s,(function(e,s){t.set(s,e),i.set(e,s)})),s.traverse((function(e){if(!e.isSkinnedMesh)return;const s=e,a=t.get(e),r=a.skeleton.bones;s.skeleton=a.skeleton.clone(),s.bindMatrix.copy(a.bindMatrix),s.skeleton.bones=r.map((function(e){return i.get(e)})),s.bind(s.skeleton,s.bindMatrix)})),s}function Ps(e,t,i){i(e,t);for(let s=0;s<e.children.length;s++)Ps(e.children[s],t.children[s],i)}function _s(e,t){if(t===me)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===fe||t===be){let i=e.getIndex();if(null===i){const t=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const s=i.count-2,a=[];if(t===fe)for(let e=1;e<=s;e++)a.push(i.getX(0)),a.push(i.getX(e)),a.push(i.getX(e+1));else for(let e=0;e<s;e++)e%2==0?(a.push(i.getX(e)),a.push(i.getX(e+1)),a.push(i.getX(e+2))):(a.push(i.getX(e+2)),a.push(i.getX(e+1)),a.push(i.getX(e)));a.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=e.clone();return r.setIndex(a),r.clearGroups(),r}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class zs extends ne{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new js(e)})),this.register((function(e){return new Hs(e)})),this.register((function(e){return new ea(e)})),this.register((function(e){return new ta(e)})),this.register((function(e){return new ia(e)})),this.register((function(e){return new Ks(e)})),this.register((function(e){return new Ws(e)})),this.register((function(e){return new Js(e)})),this.register((function(e){return new Xs(e)})),this.register((function(e){return new qs(e)})),this.register((function(e){return new Ys(e)})),this.register((function(e){return new Vs(e)})),this.register((function(e){return new $s(e)})),this.register((function(e){return new Zs(e)})),this.register((function(e){return new Gs(e)})),this.register((function(e){return new sa(e)})),this.register((function(e){return new aa(e)}))}load(e,t,i,s){const a=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const t=ye.extractUrlBase(e);r=ye.resolveURL(t,this.path)}else r=ye.extractUrlBase(e);this.manager.itemStart(e);const n=function(t){s?s(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},o=new oe(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(i){try{a.parse(i,r,(function(i){t(i),a.manager.itemEnd(e)}),n)}catch(e){n(e)}}),i,n)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let a;const r={},n={},o=new TextDecoder;if("string"==typeof e)a=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===ra){try{r[Ns.KHR_BINARY_GLTF]=new la(e)}catch(e){return void(s&&s(e))}a=JSON.parse(r[Ns.KHR_BINARY_GLTF].content)}else a=JSON.parse(o.decode(e))}else a=e;if(void 0===a.asset||a.asset.version[0]<2)return void(s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Ta(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),n[t.name]=t,r[t.name]=!0}if(a.extensionsUsed)for(let e=0;e<a.extensionsUsed.length;++e){const t=a.extensionsUsed[e],i=a.extensionsRequired||[];switch(t){case Ns.KHR_MATERIALS_UNLIT:r[t]=new Os;break;case Ns.KHR_DRACO_MESH_COMPRESSION:r[t]=new ha(a,this.dracoLoader);break;case Ns.KHR_TEXTURE_TRANSFORM:r[t]=new ca;break;case Ns.KHR_MESH_QUANTIZATION:r[t]=new Aa;break;default:i.indexOf(t)>=0&&void 0===n[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(r),l.setPlugins(n),l.parse(i,s)}parseAsync(e,t){const i=this;return new Promise((function(s,a){i.parse(e,t,s,a)}))}}function Us(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Ns={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Gs{constructor(e){this.parser=e,this.name=Ns.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const s=t[i];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const a=t.json,r=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e];let n;const o=new p(16777215);void 0!==r.color&&o.setRGB(r.color[0],r.color[1],r.color[2],we);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":n=new Ce(o),n.target.position.set(0,0,-1),n.add(n.target);break;case"point":n=new Ee(o),n.distance=l;break;case"spot":n=new Ie(o),n.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,n.angle=r.spot.outerConeAngle,n.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,n.target.position.set(0,0,-1),n.add(n.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return n.position.set(0,0,0),ka(n,r),void 0!==r.intensity&&(n.intensity=r.intensity),n.name=t.createUniqueName(r.name||"light_"+e),s=Promise.resolve(n),t.cache.add(i,s),s}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,s=i.json.nodes[e],a=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return i._getNodeRef(t.cache,a,e)}))}}class Os{constructor(){this.name=Ns.KHR_MATERIALS_UNLIT}getMaterialType(){return w}extendParams(e,t,i){const s=[];e.color=new p(1,1,1),e.opacity=1;const a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){const t=a.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],we),e.opacity=t[3]}void 0!==a.baseColorTexture&&s.push(i.assignTexture(e,"map",a.baseColorTexture,u))}return Promise.all(s)}}class qs{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=i.extensions[this.name].emissiveStrength;return void 0!==s&&(t.emissiveIntensity=s),Promise.resolve()}}class js{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new g(e,e)}return Promise.all(a)}}class Hs{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=i.extensions[this.name];return t.dispersion=void 0!==s.dispersion?s.dispersion:0,Promise.resolve()}}class Vs{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&a.push(i.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&a.push(i.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(a)}}class Ks{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[];t.sheenColor=new p(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=s.extensions[this.name];if(void 0!==r.sheenColorFactor){const e=r.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],we)}return void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&a.push(i.assignTexture(t,"sheenColorMap",r.sheenColorTexture,u)),void 0!==r.sheenRoughnessTexture&&a.push(i.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(a)}}class Ws{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)}}class Js{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&a.push(i.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const n=r.attenuationColor||[1,1,1];return t.attenuationColor=(new p).setRGB(n[0],n[1],n[2],we),Promise.all(a)}}class Xs{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=i.extensions[this.name];return t.ior=void 0!==s.ior?s.ior:1.5,Promise.resolve()}}class Ys{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&a.push(i.assignTexture(t,"specularIntensityMap",r.specularTexture));const n=r.specularColorFactor||[1,1,1];return t.specularColor=(new p).setRGB(n[0],n[1],n[2],we),void 0!==r.specularColorTexture&&a.push(i.assignTexture(t,"specularColorMap",r.specularColorTexture,u)),Promise.all(a)}}class Zs{constructor(e){this.parser=e,this.name=Ns.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&a.push(i.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(a)}}class $s{constructor(e){this.parser=e,this.name=Ns.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?d:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const a=[],r=s.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&a.push(i.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(a)}}class ea{constructor(e){this.parser=e,this.name=Ns.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const a=s.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,a.source,r)}}class ta{constructor(e){this.parser=e,this.name=Ns.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,i=this.parser,s=i.json,a=s.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],n=s.images[r.source];let o=i.textureLoader;if(n.uri){const e=i.options.manager.getHandler(n.uri);null!==e&&(o=e)}return i.loadTextureImage(e,r.source,o)}}class ia{constructor(e){this.parser=e,this.name=Ns.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,i=this.parser,s=i.json,a=s.textures[e];if(!a.extensions||!a.extensions[t])return null;const r=a.extensions[t],n=s.images[r.source];let o=i.textureLoader;if(n.uri){const e=i.options.manager.getHandler(n.uri);null!==e&&(o=e)}return i.loadTextureImage(e,r.source,o)}}class sa{constructor(e){this.name=Ns.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],s=this.parser.getDependency("buffer",e.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then((function(t){const i=e.byteOffset||0,s=e.byteLength||0,r=e.count,n=e.byteStride,o=new Uint8Array(t,i,s);return a.decodeGltfBufferAsync?a.decodeGltfBufferAsync(r,n,o,e.mode,e.filter).then((function(e){return e.buffer})):a.ready.then((function(){const t=new ArrayBuffer(r*n);return a.decodeGltfBuffer(new Uint8Array(t),r,n,o,e.mode,e.filter),t}))}))}return null}}class aa{constructor(e){this.name=Ns.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const s=t.meshes[i.mesh];for(const e of s.primitives)if(e.mode!==ga.TRIANGLES&&e.mode!==ga.TRIANGLE_STRIP&&e.mode!==ga.TRIANGLE_FAN&&void 0!==e.mode)return null;const a=i.extensions[this.name].attributes,r=[],n={};for(const e in a)r.push(this.parser.getDependency("accessor",a[e]).then((t=>(n[e]=t,n[e]))));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then((e=>{const t=e.pop(),i=t.isGroup?t.children:[t],s=e[0].count,a=[];for(const e of i){const t=new J,i=new W,r=new Y,o=new W(1,1,1),l=new X(e.geometry,e.material,s);for(let e=0;e<s;e++)n.TRANSLATION&&i.fromBufferAttribute(n.TRANSLATION,e),n.ROTATION&&r.fromBufferAttribute(n.ROTATION,e),n.SCALE&&o.fromBufferAttribute(n.SCALE,e),l.setMatrixAt(e,t.compose(i,r,o));for(const t in n)if("_COLOR_0"===t){const e=n[t];l.instanceColor=new $(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,n[t]);ie.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),a.push(l)}return t.isGroup?(t.clear(),t.add(...a),t):a[0]})))}}const ra="glTF",na=1313821514,oa=5130562;class la{constructor(e){this.name=Ns.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ra)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,a=new DataView(e,12);let r=0;for(;r<s;){const t=a.getUint32(r,!0);r+=4;const s=a.getUint32(r,!0);if(r+=4,s===na){const s=new Uint8Array(e,12+r,t);this.content=i.decode(s)}else if(s===oa){const i=12+r;this.body=e.slice(i,i+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class ha{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Ns.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,n={},o={},l={};for(const e in r){const t=wa[e]||e.toLowerCase();n[t]=r[e]}for(const t in e.attributes){const s=wa[t]||t.toLowerCase();if(void 0!==r[t]){const a=i.accessors[e.attributes[t]],r=ma[a.componentType];l[s]=r.name,o[s]=!0===a.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t,i){s.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=e.attributes[t],s=o[t];void 0!==s&&(i.normalized=s)}t(e)}),n,l,we,i)}))}))}}class ca{constructor(){this.name=Ns.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Aa{constructor(){this.name=Ns.KHR_MESH_QUANTIZATION}}class ua extends it{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,a=e*s*3+s;for(let e=0;e!==s;e++)t[e]=i[a+e];return t}interpolate_(e,t,i,s){const a=this.resultBuffer,r=this.sampleValues,n=this.valueSize,o=2*n,l=3*n,h=s-t,c=(i-t)/h,A=c*c,u=A*c,d=e*l,p=d-l,g=-2*u+3*A,m=u-A,f=1-g,b=m-A+c;for(let e=0;e!==n;e++){const t=r[p+e+n],i=r[p+e+o]*h,s=r[d+e+n],l=r[d+e]*h;a[e]=f*t+b*i+g*s+m*l}return a}}const da=new Y;class pa extends ua{interpolate_(e,t,i,s){const a=super.interpolate_(e,t,i,s);return da.fromArray(a).normalize().toArray(a),a}}const ga={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ma={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},fa={9728:Te,9729:De,9984:Re,9985:Me,9986:Se,9987:Qe},ba={33071:Le,33648:Fe,10497:A},ya={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},wa={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ia={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ea={CUBICSPLINE:void 0,LINEAR:Xe,STEP:Je},Ca="OPAQUE",va="MASK",Ba="BLEND";function xa(e,t,i){for(const s in i.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=i.extensions[s])}function ka(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Qa(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,s=t.weights.length;i<s;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,s=i.length;t<s;t++)e.morphTargetDictionary[i[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Sa(e){let t;const i=e.extensions&&e.extensions[Ns.KHR_DRACO_MESH_COMPRESSION];if(t=i?"draco:"+i.bufferView+":"+i.indices+":"+Ma(i.attributes):e.indices+":"+Ma(e.attributes)+":"+e.mode,void 0!==e.targets)for(let i=0,s=e.targets.length;i<s;i++)t+=":"+Ma(e.targets[i]);return t}function Ma(e){let t="";const i=Object.keys(e).sort();for(let s=0,a=i.length;s<a;s++)t+=i[s]+":"+e[i[s]]+";";return t}function Ra(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Da=new J;class Ta{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Us,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=-1,a=!1,r=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;i=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);s=i&&t?parseInt(t[1],10):-1,a=e.indexOf("Firefox")>-1,r=a?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||i&&s<17||a&&r<98?this.textureLoader=new ve(this.options.manager):this.textureLoader=new Be(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new oe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,a=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const r={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:i,userData:{}};return xa(a,r,s),ka(r,s),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let i=0,s=t.length;i<s;i++){const s=t[i].joints;for(let t=0,i=s.length;t<i;t++)e[s[t]].isBone=!0}for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0!==s.mesh&&(this._addNodeRef(this.meshCache,s.mesh),void 0!==s.skin&&(i[s.mesh].isSkinnedMesh=!0)),void 0!==s.camera&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),a=(e,t)=>{const i=this.associations.get(e);null!=i&&this.associations.set(t,i);for(const[i,s]of e.children.entries())a(s,t.children[i])};return a(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const a=e(t[s]);a&&i.push(a)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":s=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":s=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)})),!s)throw new Error("Unknown type: "+e)}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return i.getDependency(e,s)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Ns.KHR_BINARY_GLTF].body);const s=this.options;return new Promise((function(e,a){i.load(ye.resolveURL(t.uri,s.path),e,void 0,(function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+i)}))}loadAccessor(e){const t=this,s=this.json,a=this.json.accessors[e];if(void 0===a.bufferView&&void 0===a.sparse){const e=ya[a.type],t=ma[a.componentType],s=!0===a.normalized,r=new t(a.count*e);return Promise.resolve(new i(r,e,s))}const r=[];return void 0!==a.bufferView?r.push(this.getDependency("bufferView",a.bufferView)):r.push(null),void 0!==a.sparse&&(r.push(this.getDependency("bufferView",a.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",a.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],n=ya[a.type],o=ma[a.componentType],l=o.BYTES_PER_ELEMENT,h=l*n,c=a.byteOffset||0,A=void 0!==a.bufferView?s.bufferViews[a.bufferView].byteStride:void 0,u=!0===a.normalized;let d,p;if(A&&A!==h){const e=Math.floor(c/A),i="InterleavedBuffer:"+a.bufferView+":"+a.componentType+":"+e+":"+a.count;let s=t.cache.get(i);s||(d=new o(r,e*A,a.count*A/l),s=new xe(d,A/l),t.cache.add(i,s)),p=new ke(s,n,c%A/l,u)}else d=null===r?new o(a.count*n):new o(r,c,a.count*n),p=new i(d,n,u);if(void 0!==a.sparse){const t=ya.SCALAR,s=ma[a.sparse.indices.componentType],l=a.sparse.indices.byteOffset||0,h=a.sparse.values.byteOffset||0,c=new s(e[1],l,a.sparse.count*t),A=new o(e[2],h,a.sparse.count*n);null!==r&&(p=new i(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(p.setX(t,A[e*n]),n>=2&&p.setY(t,A[e*n+1]),n>=3&&p.setZ(t,A[e*n+2]),n>=4&&p.setW(t,A[e*n+3]),n>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=u}return p}))}loadTexture(e){const t=this.json,i=this.options,s=t.textures[e].source,a=t.images[s];let r=this.textureLoader;if(a.uri){const e=i.manager.getHandler(a.uri);null!==e&&(r=e)}return this.loadTextureImage(e,s,r)}loadTextureImage(e,t,i){const s=this,a=this.json,r=a.textures[e],n=a.images[t],o=(n.uri||n.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,i).then((function(t){t.flipY=!1,t.name=r.name||n.name||"",""===t.name&&"string"==typeof n.uri&&!1===n.uri.startsWith("data:image/")&&(t.name=n.uri);const i=(a.samplers||{})[r.sampler]||{};return t.magFilter=fa[i.magFilter]||De,t.minFilter=fa[i.minFilter]||Qe,t.wrapS=ba[i.wrapS]||A,t.wrapT=ba[i.wrapT]||A,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==Te&&t.minFilter!==De,s.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[o]=l,l}loadImageSource(e,t){const i=this,s=this.json,a=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const r=s.images[e],n=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(void 0!==r.bufferView)o=i.getDependency("bufferView",r.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:r.mimeType});return o=n.createObjectURL(t),o}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(o).then((function(e){return new Promise((function(i,s){let r=i;!0===t.isImageBitmapLoader&&(r=function(e){const t=new Ye(e);t.needsUpdate=!0,i(t)}),t.load(ye.resolveURL(e,a.path),r,void 0,s)}))})).then((function(e){var t;return!0===l&&n.revokeObjectURL(o),ka(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),e}));return this.sourceCache[e]=h,h}assignTexture(e,t,i,s){const a=this;return this.getDependency("texture",i.index).then((function(r){if(!r)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((r=r.clone()).channel=i.texCoord),a.extensions[Ns.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[Ns.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=a.associations.get(r);r=a.extensions[Ns.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),a.associations.set(r,t)}}return void 0!==s&&(r.colorSpace=s),e[t]=r,r}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new Pe,_e.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new a,_e.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(e,t)),i=t}if(s||r||n){let e="ClonedMaterial:"+i.uuid+":";s&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),s&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}e.material=i}getMaterialType(){return f}loadMaterial(e){const t=this,i=this.json,s=this.extensions,a=i.materials[e];let r;const n={},o=[];if((a.extensions||{})[Ns.KHR_MATERIALS_UNLIT]){const e=s[Ns.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),o.push(e.extendParams(n,a,t))}else{const i=a.pbrMetallicRoughness||{};if(n.color=new p(1,1,1),n.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;n.color.setRGB(e[0],e[1],e[2],we),n.opacity=e[3]}void 0!==i.baseColorTexture&&o.push(t.assignTexture(n,"map",i.baseColorTexture,u)),n.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,n.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(o.push(t.assignTexture(n,"metalnessMap",i.metallicRoughnessTexture)),o.push(t.assignTexture(n,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),o.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,n)}))))}!0===a.doubleSided&&(n.side=C);const l=a.alphaMode||Ca;if(l===Ba?(n.transparent=!0,n.depthWrite=!1):(n.transparent=!1,l===va&&(n.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&r!==w&&(o.push(t.assignTexture(n,"normalMap",a.normalTexture)),n.normalScale=new g(1,1),void 0!==a.normalTexture.scale)){const e=a.normalTexture.scale;n.normalScale.set(e,e)}if(void 0!==a.occlusionTexture&&r!==w&&(o.push(t.assignTexture(n,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(n.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&r!==w){const e=a.emissiveFactor;n.emissive=(new p).setRGB(e[0],e[1],e[2],we)}return void 0!==a.emissiveTexture&&r!==w&&o.push(t.assignTexture(n,"emissiveMap",a.emissiveTexture,u)),Promise.all(o).then((function(){const i=new r(n);return a.name&&(i.name=a.name),ka(i,a),t.associations.set(i,{materials:e}),a.extensions&&xa(s,i,a),i}))}createUniqueName(e){const t=ze.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const i=this,s=this.extensions,a=this.primitiveCache;function r(e){return s[Ns.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,i).then((function(t){return Fa(t,e,i)}))}const n=[];for(let s=0,o=e.length;s<o;s++){const o=e[s],l=Sa(o),h=a[l];if(h)n.push(h.promise);else{let e;e=o.extensions&&o.extensions[Ns.KHR_DRACO_MESH_COMPRESSION]?r(o):Fa(new t,o,i),a[l]={primitive:o,promise:e},n.push(e)}}return Promise.all(n)}loadMesh(t){const i=this,s=this.json,a=this.extensions,r=s.meshes[t],n=r.primitives,o=[];for(let e=0,t=n.length;e<t;e++){const t=void 0===n[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new f({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:B})),l.DefaultMaterial):this.getDependency("material",n[e].material);o.push(t)}var l;return o.push(i.loadGeometries(n)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),l=s[s.length-1],h=[];for(let s=0,c=l.length;s<c;s++){const c=l[s],A=n[s];let u;const d=o[s];if(A.mode===ga.TRIANGLES||A.mode===ga.TRIANGLE_STRIP||A.mode===ga.TRIANGLE_FAN||void 0===A.mode)u=!0===r.isSkinnedMesh?new Ue(c,d):new Z(c,d),!0===u.isSkinnedMesh&&u.normalizeSkinWeights(),A.mode===ga.TRIANGLE_STRIP?u.geometry=_s(u.geometry,be):A.mode===ga.TRIANGLE_FAN&&(u.geometry=_s(u.geometry,fe));else if(A.mode===ga.LINES)u=new e(c,d);else if(A.mode===ga.LINE_STRIP)u=new K(c,d);else if(A.mode===ga.LINE_LOOP)u=new Ne(c,d);else{if(A.mode!==ga.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+A.mode);u=new Ge(c,d)}Object.keys(u.geometry.morphAttributes).length>0&&Qa(u,r),u.name=i.createUniqueName(r.name||"mesh_"+t),ka(u,r),A.extensions&&xa(a,u,A),i.assignFinalMaterial(u),h.push(u)}for(let e=0,s=h.length;e<s;e++)i.associations.set(h[e],{meshes:t,primitives:e});if(1===h.length)return r.extensions&&xa(a,h[0],r),h[0];const c=new Oe;r.extensions&&xa(a,c,r),i.associations.set(c,{meshes:t});for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c}))}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(s)return"perspective"===i.type?t=new qe(je.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===i.type&&(t=new He(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),ka(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],i=[];for(let e=0,s=t.joints.length;e<s;e++)i.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then((function(e){const i=e.pop(),s=e,a=[],r=[];for(let e=0,n=s.length;e<n;e++){const n=s[e];if(n){a.push(n);const t=new J;null!==i&&t.fromArray(i.array,16*e),r.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new Ve(a,r)}))}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],a=s.name?s.name:"animation_"+e,r=[],n=[],o=[],l=[],h=[];for(let e=0,t=s.channels.length;e<t;e++){const t=s.channels[e],i=s.samplers[t.sampler],a=t.target,c=a.node,A=void 0!==s.parameters?s.parameters[i.input]:i.input,u=void 0!==s.parameters?s.parameters[i.output]:i.output;void 0!==a.node&&(r.push(this.getDependency("node",c)),n.push(this.getDependency("accessor",A)),o.push(this.getDependency("accessor",u)),l.push(i),h.push(a))}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(o),Promise.all(l),Promise.all(h)]).then((function(e){const t=e[0],s=e[1],r=e[2],n=e[3],o=e[4],l=[];for(let e=0,a=t.length;e<a;e++){const a=t[e],h=s[e],c=r[e],A=n[e],u=o[e];if(void 0===a)continue;a.updateMatrix&&a.updateMatrix();const d=i._createAnimationTracks(a,h,c,A,u);if(d)for(let e=0;e<d.length;e++)l.push(d[e])}return new Ke(a,void 0,l)}))}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return void 0===s.mesh?null:i.getDependency("mesh",s.mesh).then((function(e){const t=i._getNodeRef(i.meshCache,s.mesh,e);return void 0!==s.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,i=s.weights.length;t<i;t++)e.morphTargetInfluences[t]=s.weights[t]})),t}))}loadNode(e){const t=this,i=this.json.nodes[e],s=t._loadNodeShallow(e),a=[],r=i.children||[];for(let e=0,i=r.length;e<i;e++)a.push(t.getDependency("node",r[e]));const n=void 0===i.skin?Promise.resolve(null):t.getDependency("skin",i.skin);return Promise.all([s,Promise.all(a),n]).then((function(e){const t=e[0],i=e[1],s=e[2];null!==s&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(s,Da)}));for(let e=0,s=i.length;e<s;e++)t.add(i[e]);return t}))}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const a=t.nodes[e],r=a.name?s.createUniqueName(a.name):"",n=[],o=s._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return o&&n.push(o),void 0!==a.camera&&n.push(s.getDependency("camera",a.camera).then((function(e){return s._getNodeRef(s.cameraCache,a.camera,e)}))),s._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){n.push(e)})),this.nodeCache[e]=Promise.all(n).then((function(t){let n;if(n=!0===a.isBone?new We:t.length>1?new Oe:1===t.length?t[0]:new ie,n!==t[0])for(let e=0,i=t.length;e<i;e++)n.add(t[e]);if(a.name&&(n.userData.name=a.name,n.name=r),ka(n,a),a.extensions&&xa(i,n,a),void 0!==a.matrix){const e=new J;e.fromArray(a.matrix),n.applyMatrix4(e)}else void 0!==a.translation&&n.position.fromArray(a.translation),void 0!==a.rotation&&n.quaternion.fromArray(a.rotation),void 0!==a.scale&&n.scale.fromArray(a.scale);if(s.associations.has(n)){if(void 0!==a.mesh&&s.meshCache.refs[a.mesh]>1){const e=s.associations.get(n);s.associations.set(n,{...e})}}else s.associations.set(n,{});return s.associations.get(n).nodes=e,n})),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,a=new Oe;i.name&&(a.name=s.createUniqueName(i.name)),ka(a,i),i.extensions&&xa(t,a,i);const r=i.nodes||[],n=[];for(let e=0,t=r.length;e<t;e++)n.push(s.getDependency("node",r[e]));return Promise.all(n).then((function(e){for(let t=0,i=e.length;t<i;t++)a.add(e[t]);return s.associations=(e=>{const t=new Map;for(const[e,i]of s.associations)(e instanceof _e||e instanceof Ye)&&t.set(e,i);return e.traverse((e=>{const i=s.associations.get(e);null!=i&&t.set(e,i)})),t})(a),a}))}_createAnimationTracks(e,t,i,s,a){const r=[],n=e.name?e.name:e.uuid,o=[];let l;switch(Ia[a.path]===Ia.weights?e.traverse((function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)})):o.push(n),Ia[a.path]){case Ia.weights:l=$e;break;case Ia.rotation:l=et;break;case Ia.translation:case Ia.scale:l=Ze;break;default:if(1===i.itemSize)l=$e;else l=Ze}const h=void 0!==s.interpolation?Ea[s.interpolation]:Xe,c=this._getArrayFromAccessor(i);for(let e=0,i=o.length;e<i;e++){const i=new l(o[e]+"."+Ia[a.path],t.array,c,h);"CUBICSPLINE"===s.interpolation&&this._createCubicSplineTrackInterpolant(i),r.push(i)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=Ra(t.constructor),i=new Float32Array(t.length);for(let s=0,a=t.length;s<a;s++)i[s]=t[s]*e;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof et?pa:ua)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Fa(e,t,i){const s=t.attributes,a=[];function r(t,s){return i.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(const t in s){const i=wa[t]||t.toLowerCase();i in e.attributes||a.push(r(s[t],i))}if(void 0!==t.indices&&!e.index){const s=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(s)}return tt.workingColorSpace!==we&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${tt.workingColorSpace}" not supported.`),ka(e,t),function(e,t,i){const s=t.attributes,a=new te;if(void 0===s.POSITION)return;{const e=i.json.accessors[s.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(a.set(new W(t[0],t[1],t[2]),new W(r[0],r[1],r[2])),e.normalized){const t=Ra(ma[e.componentType]);a.min.multiplyScalar(t),a.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new W,t=new W;for(let s=0,a=r.length;s<a;s++){const a=r[s];if(void 0!==a.POSITION){const s=i.json.accessors[a.POSITION],r=s.min,n=s.max;if(void 0!==r&&void 0!==n){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(n[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(n[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(n[2]))),s.normalized){const e=Ra(ma[s.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(e)}e.boundingBox=a;const n=new st;a.getCenter(n.center),n.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=n}(e,t,i),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,i){let s=!1,a=!1,r=!1;for(let e=0,i=t.length;e<i;e++){const i=t[e];if(void 0!==i.POSITION&&(s=!0),void 0!==i.NORMAL&&(a=!0),void 0!==i.COLOR_0&&(r=!0),s&&a&&r)break}if(!s&&!a&&!r)return Promise.resolve(e);const n=[],o=[],l=[];for(let h=0,c=t.length;h<c;h++){const c=t[h];if(s){const t=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;n.push(t)}if(a){const t=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal;o.push(t)}if(r){const t=void 0!==c.COLOR_0?i.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(n),Promise.all(o),Promise.all(l)]).then((function(t){const i=t[0],n=t[1],o=t[2];return s&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=n),r&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.8.2
*/var La=Uint8Array,Pa=Uint16Array,_a=Int32Array,za=new La([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ua=new La([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Na=new La([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ga=function(e,t){for(var i=new Pa(31),s=0;s<31;++s)i[s]=t+=1<<e[s-1];var a=new _a(i[30]);for(s=1;s<30;++s)for(var r=i[s];r<i[s+1];++r)a[r]=r-i[s]<<5|s;return{b:i,r:a}},Oa=Ga(za,2),qa=Oa.b,ja=Oa.r;qa[28]=258,ja[258]=28;for(var Ha=Ga(Ua,0).b,Va=new Pa(32768),Ka=0;Ka<32768;++Ka){var Wa=(43690&Ka)>>1|(21845&Ka)<<1;Wa=(61680&(Wa=(52428&Wa)>>2|(13107&Wa)<<2))>>4|(3855&Wa)<<4,Va[Ka]=((65280&Wa)>>8|(255&Wa)<<8)>>1}var Ja=function(e,t,i){for(var s=e.length,a=0,r=new Pa(t);a<s;++a)e[a]&&++r[e[a]-1];var n,o=new Pa(t);for(a=1;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(i){n=new Pa(1<<t);var l=15-t;for(a=0;a<s;++a)if(e[a])for(var h=a<<4|e[a],c=t-e[a],A=o[e[a]-1]++<<c,u=A|(1<<c)-1;A<=u;++A)n[Va[A]>>l]=h}else for(n=new Pa(s),a=0;a<s;++a)e[a]&&(n[a]=Va[o[e[a]-1]++]>>15-e[a]);return n},Xa=new La(288);for(Ka=0;Ka<144;++Ka)Xa[Ka]=8;for(Ka=144;Ka<256;++Ka)Xa[Ka]=9;for(Ka=256;Ka<280;++Ka)Xa[Ka]=7;for(Ka=280;Ka<288;++Ka)Xa[Ka]=8;var Ya=new La(32);for(Ka=0;Ka<32;++Ka)Ya[Ka]=5;var Za=Ja(Xa,9,1),$a=Ja(Ya,5,1),er=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},tr=function(e,t,i){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&i},ir=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},sr=function(e){return(e+7)/8|0},ar=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],rr=function(e,t,i){var s=new Error(t||ar[e]);if(s.code=e,Error.captureStackTrace&&Error.captureStackTrace(s,rr),!i)throw s;return s},nr=function(e,t,i,s){var a=e.length;if(!a||t.f&&!t.l)return i||new La(0);var r=!i,n=r||2!=t.i,o=t.i;r&&(i=new La(3*a));var l=function(e){var t=i.length;if(e>t){var s=new La(Math.max(2*t,e));s.set(i),i=s}},h=t.f||0,c=t.p||0,A=t.b||0,u=t.l,d=t.d,p=t.m,g=t.n,m=8*a;do{if(!u){h=tr(e,c,1);var f=tr(e,c+1,3);if(c+=3,!f){var b=e[(S=sr(c)+4)-4]|e[S-3]<<8,y=S+b;if(y>a){o&&rr(0);break}n&&l(A+b),i.set(e.subarray(S,y),A),t.b=A+=b,t.p=c=8*y,t.f=h;continue}if(1==f)u=Za,d=$a,p=9,g=5;else if(2==f){var w=tr(e,c,31)+257,I=tr(e,c+10,15)+4,E=w+tr(e,c+5,31)+1;c+=14;for(var C=new La(E),v=new La(19),B=0;B<I;++B)v[Na[B]]=tr(e,c+3*B,7);c+=3*I;var x=er(v),k=(1<<x)-1,Q=Ja(v,x,1);for(B=0;B<E;){var S,M=Q[tr(e,c,k)];if(c+=15&M,(S=M>>4)<16)C[B++]=S;else{var R=0,D=0;for(16==S?(D=3+tr(e,c,3),c+=2,R=C[B-1]):17==S?(D=3+tr(e,c,7),c+=3):18==S&&(D=11+tr(e,c,127),c+=7);D--;)C[B++]=R}}var T=C.subarray(0,w),F=C.subarray(w);p=er(T),g=er(F),u=Ja(T,p,1),d=Ja(F,g,1)}else rr(1);if(c>m){o&&rr(0);break}}n&&l(A+131072);for(var L=(1<<p)-1,P=(1<<g)-1,_=c;;_=c){var z=(R=u[ir(e,c)&L])>>4;if((c+=15&R)>m){o&&rr(0);break}if(R||rr(2),z<256)i[A++]=z;else{if(256==z){_=c,u=null;break}var U=z-254;if(z>264){var N=za[B=z-257];U=tr(e,c,(1<<N)-1)+qa[B],c+=N}var G=d[ir(e,c)&P],O=G>>4;G||rr(3),c+=15&G;F=Ha[O];if(O>3){N=Ua[O];F+=ir(e,c)&(1<<N)-1,c+=N}if(c>m){o&&rr(0);break}n&&l(A+131072);var q=A+U;if(A<F){var j=0-F,H=Math.min(F,q);for(j+A<0&&rr(3);A<H;++A)i[A]=s[j+A]}for(;A<q;++A)i[A]=i[A-F]}}t.l=u,t.p=_,t.b=A,t.f=h,u&&(h=1,t.m=p,t.d=d,t.n=g)}while(!h);return A!=i.length&&r?function(e,t,i){return(null==i||i>e.length)&&(i=e.length),new La(e.subarray(t,i))}(i,0,A):i.subarray(0,A)},or=new La(0);function lr(e,t){return nr(e.subarray(function(e){return(8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31)&&rr(6,"invalid zlib data"),1==(e[1]>>5&1)&&rr(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)}(e),-4),{i:2},t,t)}var hr="undefined"!=typeof TextDecoder&&new TextDecoder;try{hr.decode(or,{stream:!0})}catch(e){}function cr(e,t,i){const s=i.length-e-1;if(t>=i[s])return s-1;if(t<=i[e])return e;let a=e,r=s,n=Math.floor((a+r)/2);for(;t<i[n]||t>=i[n+1];)t<i[n]?r=n:a=n,n=Math.floor((a+r)/2);return n}function Ar(e,t){let i=1;for(let t=2;t<=e;++t)i*=t;let s=1;for(let e=2;e<=t;++e)s*=e;for(let i=2;i<=e-t;++i)s*=i;return i/s}function ur(e,t,i,s,a){const r=function(e,t,i,s,a){const r=a<e?a:e,n=[],o=cr(e,s,t),l=function(e,t,i,s,a){const r=[];for(let e=0;e<=i;++e)r[e]=0;const n=[];for(let e=0;e<=s;++e)n[e]=r.slice(0);const o=[];for(let e=0;e<=i;++e)o[e]=r.slice(0);o[0][0]=1;const l=r.slice(0),h=r.slice(0);for(let s=1;s<=i;++s){l[s]=t-a[e+1-s],h[s]=a[e+s]-t;let i=0;for(let e=0;e<s;++e){const t=h[e+1],a=l[s-e];o[s][e]=t+a;const r=o[e][s-1]/o[s][e];o[e][s]=i+t*r,i=a*r}o[s][s]=i}for(let e=0;e<=i;++e)n[0][e]=o[e][i];for(let e=0;e<=i;++e){let t=0,a=1;const l=[];for(let e=0;e<=i;++e)l[e]=r.slice(0);l[0][0]=1;for(let r=1;r<=s;++r){let s=0;const h=e-r,c=i-r;e>=r&&(l[a][0]=l[t][0]/o[c+1][h],s=l[a][0]*o[h][c]);const A=e-1<=c?r-1:i-e;for(let e=h>=-1?1:-h;e<=A;++e)l[a][e]=(l[t][e]-l[t][e-1])/o[c+1][h+e],s+=l[a][e]*o[h+e][c];e<=c&&(l[a][r]=-l[t][r-1]/o[c+1][e],s+=l[a][r]*o[e][c]),n[r][e]=s;const u=t;t=a,a=u}}let c=i;for(let e=1;e<=s;++e){for(let t=0;t<=i;++t)n[e][t]*=c;c*=i-e}return n}(o,s,e,r,t),h=[];for(let e=0;e<i.length;++e){const t=i[e].clone(),s=t.w;t.x*=s,t.y*=s,t.z*=s,h[e]=t}for(let t=0;t<=r;++t){const i=h[o-e].clone().multiplyScalar(l[t][0]);for(let s=1;s<=e;++s)i.add(h[o-e+s].clone().multiplyScalar(l[t][s]));n[t]=i}for(let e=r+1;e<=a+1;++e)n[e]=new at(0,0,0);return n}(e,t,i,s,a);return function(e){const t=e.length,i=[],s=[];for(let a=0;a<t;++a){const t=e[a];i[a]=new W(t.x,t.y,t.z),s[a]=t.w}const a=[];for(let e=0;e<t;++e){const t=i[e].clone();for(let i=1;i<=e;++i)t.sub(a[e-i].clone().multiplyScalar(Ar(e,i)*s[i]));a[e]=t.divideScalar(s[0])}return a}(r)}class dr extends rt{constructor(e,t,i,s,a){super();const r=t?t.length-1:0,n=i?i.length:0;this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=s||0,this.endKnot=a||r;for(let e=0;e<n;++e){const t=i[e];this.controlPoints[e]=new at(t.x,t.y,t.z,t.w)}}getPoint(e,t=new W){const i=t,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),a=function(e,t,i,s){const a=cr(e,s,t),r=function(e,t,i,s){const a=[],r=[],n=[];a[0]=1;for(let o=1;o<=i;++o){r[o]=t-s[e+1-o],n[o]=s[e+o]-t;let i=0;for(let e=0;e<o;++e){const t=n[e+1],s=r[o-e],l=a[e]/(t+s);a[e]=i+t*l,i=s*l}a[o]=i}return a}(a,s,e,t),n=new at(0,0,0,0);for(let t=0;t<=e;++t){const s=i[a-e+t],o=r[t],l=s.w*o;n.x+=s.x*l,n.y+=s.y*l,n.z+=s.z*l,n.w+=s.w*o}return n}(this.degree,this.knots,this.controlPoints,s);return 1!==a.w&&a.divideScalar(a.w),i.set(a.x,a.y,a.z)}getTangent(e,t=new W){const i=t,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),a=ur(this.degree,this.knots,this.controlPoints,s,1);return i.copy(a[1]).normalize(),i}toJSON(){const e=super.toJSON();return e.degree=this.degree,e.knots=[...this.knots],e.controlPoints=this.controlPoints.map((e=>e.toArray())),e.startKnot=this.startKnot,e.endKnot=this.endKnot,e}fromJSON(e){return super.fromJSON(e),this.degree=e.degree,this.knots=[...e.knots],this.controlPoints=e.controlPoints.map((e=>new at(e[0],e[1],e[2],e[3]))),this.startKnot=e.startKnot,this.endKnot=e.endKnot,this}}let pr,gr,mr;class fr extends ne{constructor(e){super(e)}load(e,t,i,s){const a=this,r=""===a.path?ye.extractUrlBase(e):a.path,n=new oe(this.manager);n.setPath(a.path),n.setResponseType("arraybuffer"),n.setRequestHeader(a.requestHeader),n.setWithCredentials(a.withCredentials),n.load(e,(function(i){try{t(a.parse(i,r))}catch(t){s?s(t):console.error(t),a.manager.itemError(e)}}),i,s)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===Fr(e,0,t.length)}(e))pr=(new Er).parse(e);else{const t=Fr(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let i=0;function s(t){const s=e[t-1];return e=e.slice(i+t),i++,s}for(let e=0;e<t.length;++e){if(s(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(Br(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Br(t));pr=(new Ir).parse(t)}const i=new ve(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new br(i,this.manager).parse(pr)}}class br{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){gr=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),i=this.parseMaterials(t),s=this.parseDeformers(),a=(new yr).parse(s);return this.parseScene(s,a,i),mr}parseConnections(){const e=new Map;if("Connections"in pr){pr.Connections.connections.forEach((function(t){const i=t[0],s=t[1],a=t[2];e.has(i)||e.set(i,{parents:[],children:[]});const r={ID:s,relationship:a};e.get(i).parents.push(r),e.has(s)||e.set(s,{parents:[],children:[]});const n={ID:i,relationship:a};e.get(s).children.push(n)}))}return e}parseImages(){const e={},t={};if("Video"in pr.Objects){const i=pr.Objects.Video;for(const s in i){const a=i[s];if(e[parseInt(s)]=a.RelativeFilename||a.Filename,"Content"in a){const e=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,r="string"==typeof a.Content&&""!==a.Content;if(e||r){const e=this.parseImage(i[s]);t[a.RelativeFilename||a.Filename]=e}}}}for(const i in e){const s=e[i];void 0!==t[s]?e[i]=t[s]:e[i]=e[i].split("\\").pop()}return e}parseImage(e){const t=e.Content,i=e.RelativeFilename||e.Filename,s=i.slice(i.lastIndexOf(".")+1).toLowerCase();let a;switch(s){case"bmp":a="image/bmp";break;case"jpg":case"jpeg":a="image/jpeg";break;case"png":a="image/png";break;case"tif":a="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",i),a="image/tga";break;case"webp":a="image/webp";break;default:return void console.warn('FBXLoader: Image type "'+s+'" is not supported.')}if("string"==typeof t)return"data:"+a+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:a}))}}parseTextures(e){const t=new Map;if("Texture"in pr.Objects){const i=pr.Objects.Texture;for(const s in i){const a=this.parseTexture(i[s],e);t.set(parseInt(s),a)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const s=e.WrapModeU,a=e.WrapModeV,r=void 0!==s?s.value:0,n=void 0!==a?a.value:0;if(i.wrapS=0===r?A:Le,i.wrapT=0===n?A:Le,"Scaling"in e){const t=e.Scaling.value;i.repeat.x=t[0],i.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;i.offset.x=t[0],i.offset.y=t[1]}return i}loadTexture(e,t){const i=e.FileName.split(".").pop().toLowerCase();let s=this.manager.getHandler(`.${i}`);null===s&&(s=this.textureLoader);const a=s.path;a||s.setPath(this.textureLoader.path);const r=gr.get(e.id).children;let n;if(void 0!==r&&r.length>0&&void 0!==t[r[0].ID]&&(n=t[r[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||s.setPath(void 0)),void 0===n)return console.warn("FBXLoader: Undefined filename, creating placeholder texture."),new Ye;const o=s.load(n);return s.setPath(a),o}parseMaterials(e){const t=new Map;if("Material"in pr.Objects){const i=pr.Objects.Material;for(const s in i){const a=this.parseMaterial(i[s],e);null!==a&&t.set(parseInt(s),a)}}return t}parseMaterial(e,t){const i=e.id,s=e.attrName;let a=e.ShadingModel;if("object"==typeof a&&(a=a.value),!gr.has(i))return null;const r=this.parseParameters(e,t,i);let n;switch(a.toLowerCase()){case"phong":n=new E;break;case"lambert":n=new I;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',a),n=new E}return n.setValues(r),n.name=s,n}parseParameters(e,t,i){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=tt.colorSpaceToWorking((new p).fromArray(e.Diffuse.value),u):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(s.color=tt.colorSpaceToWorking((new p).fromArray(e.DiffuseColor.value),u)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=tt.colorSpaceToWorking((new p).fromArray(e.Emissive.value),u):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(s.emissive=tt.colorSpaceToWorking((new p).fromArray(e.EmissiveColor.value),u)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),s.opacity=1-(e.TransparencyFactor?parseFloat(e.TransparencyFactor.value):0),1!==s.opacity&&0!==s.opacity||(s.opacity=e.Opacity?parseFloat(e.Opacity.value):null,null===s.opacity&&(s.opacity=1-(e.TransparentColor?parseFloat(e.TransparentColor.value[0]):0))),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=tt.colorSpaceToWorking((new p).fromArray(e.Specular.value),u):e.SpecularColor&&"Color"===e.SpecularColor.type&&(s.specular=tt.colorSpaceToWorking((new p).fromArray(e.SpecularColor.value),u));const a=this;return gr.get(i).children.forEach((function(e){const i=e.relationship;switch(i){case"Bump":s.bumpMap=a.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":s.aoMap=a.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=a.getTexture(t,e.ID),void 0!==s.map&&(s.map.colorSpace=u);break;case"DisplacementColor":s.displacementMap=a.getTexture(t,e.ID);break;case"EmissiveColor":s.emissiveMap=a.getTexture(t,e.ID),void 0!==s.emissiveMap&&(s.emissiveMap.colorSpace=u);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=a.getTexture(t,e.ID);break;case"ReflectionColor":s.envMap=a.getTexture(t,e.ID),void 0!==s.envMap&&(s.envMap.mapping=nt,s.envMap.colorSpace=u);break;case"SpecularColor":s.specularMap=a.getTexture(t,e.ID),void 0!==s.specularMap&&(s.specularMap.colorSpace=u);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=a.getTexture(t,e.ID),s.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",i)}})),s}getTexture(e,t){return"LayeredTexture"in pr.Objects&&t in pr.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=gr.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in pr.Objects){const i=pr.Objects.Deformer;for(const s in i){const a=i[s],r=gr.get(parseInt(s));if("Skin"===a.attrType){const t=this.parseSkeleton(r,i);t.ID=s,r.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=r.parents[0].ID,e[s]=t}else if("BlendShape"===a.attrType){const e={id:s};e.rawTargets=this.parseMorphTargets(r,i),e.id=s,r.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach((function(e){const s=t[e.ID];if("Cluster"!==s.attrType)return;const a={ID:e.ID,indices:[],weights:[],transformLink:(new J).fromArray(s.TransformLink.a)};"Indexes"in s&&(a.indices=s.Indexes.a,a.weights=s.Weights.a),i.push(a)})),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const i=[];for(let s=0;s<e.children.length;s++){const a=e.children[s],r=t[a.ID],n={name:r.attrName,initialWeight:r.DeformPercent,id:r.id,fullWeights:r.FullWeights.a};if("BlendShapeChannel"!==r.attrType)return;n.geoID=gr.get(parseInt(a.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,i.push(n)}return i}parseScene(e,t,i){mr=new Oe;const s=this.parseModels(e.skeletons,t,i),a=pr.Objects.Model,r=this;s.forEach((function(e){const t=a[e.ID];r.setLookAtProperties(e,t);gr.get(e.ID).parents.forEach((function(t){const i=s.get(t.ID);void 0!==i&&i.add(e)})),null===e.parent&&mr.add(e)})),this.bindSkeleton(e.skeletons,t,s),this.addGlobalSceneSettings(),mr.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=Rr(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const n=(new wr).parse();1===mr.children.length&&mr.children[0].isGroup&&(mr.children[0].animations=n,mr=mr.children[0]),mr.animations=n}parseModels(e,t,i){const s=new Map,a=pr.Objects.Model;for(const r in a){const n=parseInt(r),o=a[r],l=gr.get(n);let h=this.buildSkeleton(l,e,n,o.attrName);if(!h){switch(o.attrType){case"Camera":h=this.createCamera(l);break;case"Light":h=this.createLight(l);break;case"Mesh":h=this.createMesh(l,t,i);break;case"NurbsCurve":h=this.createCurve(l,t);break;case"LimbNode":case"Root":h=new We;break;default:h=new Oe}h.name=o.attrName?ze.sanitizeNodeName(o.attrName):"",h.userData.originalName=o.attrName,h.ID=n}this.getTransformData(h,o),s.set(n,h)}return s}buildSkeleton(e,t,i,s){let a=null;return e.parents.forEach((function(e){for(const r in t){const n=t[r];n.rawBones.forEach((function(t,r){if(t.ID===e.ID){const e=a;a=new We,a.matrixWorld.copy(t.transformLink),a.name=s?ze.sanitizeNodeName(s):"",a.userData.originalName=s,a.ID=i,n.bones[r]=a,null!==e&&a.add(e)}}))}})),a}createCamera(e){let t,i;if(e.children.forEach((function(e){const t=pr.Objects.NodeAttribute[e.ID];void 0!==t&&(i=t)})),void 0===i)t=new ie;else{let e=0;void 0!==i.CameraProjectionType&&1===i.CameraProjectionType.value&&(e=1);let s=1;void 0!==i.NearPlane&&(s=i.NearPlane.value/1e3);let a=1e3;void 0!==i.FarPlane&&(a=i.FarPlane.value/1e3);let r=window.innerWidth,n=window.innerHeight;void 0!==i.AspectWidth&&void 0!==i.AspectHeight&&(r=i.AspectWidth.value,n=i.AspectHeight.value);const o=r/n;let l=45;void 0!==i.FieldOfView&&(l=i.FieldOfView.value);const h=i.FocalLength?i.FocalLength.value:null;switch(e){case 0:t=new qe(l,o,s,a),null!==h&&t.setFocalLength(h);break;case 1:console.warn("THREE.FBXLoader: Orthographic cameras not supported yet."),t=new ie;break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new ie}}return t}createLight(e){let t,i;if(e.children.forEach((function(e){const t=pr.Objects.NodeAttribute[e.ID];void 0!==t&&(i=t)})),void 0===i)t=new ie;else{let e;e=void 0===i.LightType?0:i.LightType.value;let s=16777215;void 0!==i.Color&&(s=tt.colorSpaceToWorking((new p).fromArray(i.Color.value),u));let a=void 0===i.Intensity?1:i.Intensity.value/100;void 0!==i.CastLightOnObject&&0===i.CastLightOnObject.value&&(a=0);let r=0;void 0!==i.FarAttenuationEnd&&(r=void 0!==i.EnableFarAttenuation&&0===i.EnableFarAttenuation.value?0:i.FarAttenuationEnd.value);const n=1;switch(e){case 0:t=new Ee(s,a,r,n);break;case 1:t=new Ce(s,a);break;case 2:let e=Math.PI/3;void 0!==i.InnerAngle&&(e=je.degToRad(i.InnerAngle.value));let o=0;void 0!==i.OuterAngle&&(o=je.degToRad(i.OuterAngle.value),o=Math.max(o,1)),t=new Ie(s,a,r,e,o,n);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new Ee(s,a)}void 0!==i.CastShadows&&1===i.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,i){let s,a=null,r=null;const n=[];if(e.children.forEach((function(e){t.has(e.ID)&&(a=t.get(e.ID)),i.has(e.ID)&&n.push(i.get(e.ID))})),n.length>1?r=n:n.length>0?r=n[0]:(r=new E({name:ne.DEFAULT_MATERIAL_NAME,color:13421772}),n.push(r)),"color"in a.attributes&&n.forEach((function(e){e.vertexColors=!0})),a.groups.length>0){let e=!1;for(let t=0,i=a.groups.length;t<i;t++){const i=a.groups[t];(i.materialIndex<0||i.materialIndex>=n.length)&&(i.materialIndex=n.length,e=!0)}if(e){const e=new E;n.push(e)}}return a.FBX_Deformer?(s=new Ue(a,r),s.normalizeSkinWeights()):s=new Z(a,r),s}createCurve(e,t){const i=e.children.reduce((function(e,i){return t.has(i.ID)&&(e=t.get(i.ID)),e}),null),s=new a({name:ne.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new K(i,s)}getTransformData(e,t){const i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),i.eulerOrder=Dr("RotationOrder"in t?t.RotationOrder.value:0),"Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i}setLookAtProperties(e,t){if("LookAtProperty"in t){gr.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const i=pr.Objects.Model[t.ID];if("Lcl_Translation"in i){const t=i.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),mr.add(e.target)):e.lookAt((new W).fromArray(t))}}}))}}bindSkeleton(e,t,i){const s=this.parsePoseNodes();for(const a in e){const r=e[a];gr.get(parseInt(r.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;gr.get(t).parents.forEach((function(e){if(i.has(e.ID)){i.get(e.ID).bind(new Ve(r.bones),s[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in pr.Objects){const t=pr.Objects.Pose;for(const i in t)if("BindPose"===t[i].attrType&&t[i].NbPoseNodes>0){const s=t[i].PoseNode;Array.isArray(s)?s.forEach((function(t){e[t.Node]=(new J).fromArray(t.Matrix.a)})):e[s.Node]=(new J).fromArray(s.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in pr){if("AmbientColor"in pr.GlobalSettings){const e=pr.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],s=e[2];if(0!==t||0!==i||0!==s){const e=(new p).setRGB(t,i,s,u);mr.add(new ot(e,1))}}"UnitScaleFactor"in pr.GlobalSettings&&(mr.userData.unitScaleFactor=pr.GlobalSettings.UnitScaleFactor.value)}}}class yr{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in pr.Objects){const i=pr.Objects.Geometry;for(const s in i){const a=gr.get(parseInt(s)),r=this.parseGeometry(a,i[s],e);t.set(parseInt(s),r)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,i){const s=i.skeletons,a=[],r=e.parents.map((function(e){return pr.Objects.Model[e.ID]}));if(0===r.length)return;const n=e.children.reduce((function(e,t){return void 0!==s[t.ID]&&(e=s[t.ID]),e}),null);e.children.forEach((function(e){void 0!==i.morphTargets[e.ID]&&a.push(i.morphTargets[e.ID])}));const o=r[0],l={};"RotationOrder"in o&&(l.eulerOrder=Dr(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const h=Rr(l);return this.genGeometry(t,n,a,h)}genGeometry(e,i,a,r){const n=new t;e.attrName&&(n.name=e.attrName);const o=this.parseGeoNode(e,i),l=this.genBuffers(o),h=new s(l.vertex,3);if(h.applyMatrix4(r),n.setAttribute("position",h),l.colors.length>0&&n.setAttribute("color",new s(l.colors,3)),i&&(n.setAttribute("skinIndex",new lt(l.weightsIndices,4)),n.setAttribute("skinWeight",new s(l.vertexWeights,4)),n.FBX_Deformer=i),l.normal.length>0){const e=(new le).getNormalMatrix(r),t=new s(l.normal,3);t.applyNormalMatrix(e),n.setAttribute("normal",t)}if(l.uvs.forEach((function(e,t){const i=0===t?"uv":`uv${t}`;n.setAttribute(i,new s(l.uvs[t],2))})),o.material&&"AllSame"!==o.material.mappingType){let e=l.materialIndex[0],t=0;if(l.materialIndex.forEach((function(i,s){i!==e&&(n.addGroup(t,s-t,e),e=i,t=s)})),n.groups.length>0){const t=n.groups[n.groups.length-1],i=t.start+t.count;i!==l.materialIndex.length&&n.addGroup(i,l.materialIndex.length-i,e)}0===n.groups.length&&n.addGroup(0,l.materialIndex.length,l.materialIndex[0])}return this.addMorphTargets(n,e,a,r),n}parseGeoNode(e,t){const i={};if(i.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],i.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&e.LayerElementColor.Color&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return i.weightTable={},null!==t&&(i.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(s,a){void 0===i.weightTable[s]&&(i.weightTable[s]=[]),i.weightTable[s].push({id:t,weight:e.weights[a]})}))}))),i}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,s=0,a=!1,r=[],n=[],o=[],l=[],h=[],c=[];const A=this;return e.vertexIndices.forEach((function(u,d){let p,g=!1;u<0&&(u^=-1,g=!0);let m=[],f=[];if(r.push(3*u,3*u+1,3*u+2),e.color){const t=Qr(d,i,u,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[u]&&e.weightTable[u].forEach((function(e){f.push(e.weight),m.push(e.id)})),f.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);const e=[0,0,0,0],t=[0,0,0,0];f.forEach((function(i,s){let a=i,r=m[s];t.forEach((function(t,i,s){if(a>t){s[i]=a,a=t;const n=e[i];e[i]=r,r=n}}))})),m=e,f=t}for(;f.length<4;)f.push(0),m.push(0);for(let e=0;e<4;++e)h.push(f[e]),c.push(m[e])}if(e.normal){const t=Qr(d,i,u,e.normal);n.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(p=Qr(d,i,u,e.material)[0],p<0&&(A.negativeMaterialIndices=!0,p=0)),e.uv&&e.uv.forEach((function(e,t){const s=Qr(d,i,u,e);void 0===l[t]&&(l[t]=[]),l[t].push(s[0]),l[t].push(s[1])})),s++,g&&(A.genFace(t,e,r,p,n,o,l,h,c,s),i++,s=0,r=[],n=[],o=[],l=[],h=[],c=[])})),t}getNormalNewell(e){const t=new W(0,0,0);for(let i=0;i<e.length;i++){const s=e[i],a=e[(i+1)%e.length];t.x+=(s.y-a.y)*(s.z+a.z),t.y+=(s.z-a.z)*(s.x+a.x),t.z+=(s.x-a.x)*(s.y+a.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),i=(Math.abs(t.z)>.5?new W(0,1,0):new W(0,0,1)).cross(t).normalize(),s=t.clone().cross(i).normalize();return{normal:t,tangent:i,bitangent:s}}flattenVertex(e,t,i){return new g(e.dot(t),e.dot(i))}genFace(e,t,i,s,a,r,n,o,l,h){let c;if(h>3){const e=[],s=t.baseVertexPositions||t.vertexPositions;for(let t=0;t<i.length;t+=3)e.push(new W(s[i[t]],s[i[t+1]],s[i[t+2]]));const{tangent:a,bitangent:r}=this.getNormalTangentAndBitangent(e),n=[];for(const t of e)n.push(this.flattenVertex(t,a,r));c=ce.triangulateShape(n,[])}else c=[[0,1,2]];for(const[h,A,u]of c)e.vertex.push(t.vertexPositions[i[3*h]]),e.vertex.push(t.vertexPositions[i[3*h+1]]),e.vertex.push(t.vertexPositions[i[3*h+2]]),e.vertex.push(t.vertexPositions[i[3*A]]),e.vertex.push(t.vertexPositions[i[3*A+1]]),e.vertex.push(t.vertexPositions[i[3*A+2]]),e.vertex.push(t.vertexPositions[i[3*u]]),e.vertex.push(t.vertexPositions[i[3*u+1]]),e.vertex.push(t.vertexPositions[i[3*u+2]]),t.skeleton&&(e.vertexWeights.push(o[4*h]),e.vertexWeights.push(o[4*h+1]),e.vertexWeights.push(o[4*h+2]),e.vertexWeights.push(o[4*h+3]),e.vertexWeights.push(o[4*A]),e.vertexWeights.push(o[4*A+1]),e.vertexWeights.push(o[4*A+2]),e.vertexWeights.push(o[4*A+3]),e.vertexWeights.push(o[4*u]),e.vertexWeights.push(o[4*u+1]),e.vertexWeights.push(o[4*u+2]),e.vertexWeights.push(o[4*u+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3]),e.weightsIndices.push(l[4*A]),e.weightsIndices.push(l[4*A+1]),e.weightsIndices.push(l[4*A+2]),e.weightsIndices.push(l[4*A+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(r[3*h]),e.colors.push(r[3*h+1]),e.colors.push(r[3*h+2]),e.colors.push(r[3*A]),e.colors.push(r[3*A+1]),e.colors.push(r[3*A+2]),e.colors.push(r[3*u]),e.colors.push(r[3*u+1]),e.colors.push(r[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(a[3*h]),e.normal.push(a[3*h+1]),e.normal.push(a[3*h+2]),e.normal.push(a[3*A]),e.normal.push(a[3*A+1]),e.normal.push(a[3*A+2]),e.normal.push(a[3*u]),e.normal.push(a[3*u+1]),e.normal.push(a[3*u+2])),t.uv&&t.uv.forEach((function(t,i){void 0===e.uvs[i]&&(e.uvs[i]=[]),e.uvs[i].push(n[i][2*h]),e.uvs[i].push(n[i][2*h+1]),e.uvs[i].push(n[i][2*A]),e.uvs[i].push(n[i][2*A+1]),e.uvs[i].push(n[i][2*u]),e.uvs[i].push(n[i][2*u+1])}))}addMorphTargets(e,t,i,s){if(0===i.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const a=this;i.forEach((function(i){i.rawTargets.forEach((function(i){const r=pr.Objects.Geometry[i.geoID];void 0!==r&&a.genMorphGeometry(e,t,r,s,i.name)}))}))}genMorphGeometry(e,t,i,a,r){const n=void 0!==t.Vertices?t.Vertices.a:[],o=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],l=void 0!==i.Vertices?i.Vertices.a:[],h=void 0!==i.Indexes?i.Indexes.a:[],c=3*e.attributes.position.count,A=new Float32Array(c);for(let e=0;e<h.length;e++){const t=3*h[e];A[t]=l[3*e],A[t+1]=l[3*e+1],A[t+2]=l[3*e+2]}const u={vertexIndices:o,vertexPositions:A,baseVertexPositions:n},d=this.genBuffers(u),p=new s(d.vertex,3);p.name=r||i.attrName,p.applyMatrix4(a),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.Normals.a;let a=[];return"IndexToDirect"===i&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:a,mappingType:t,referenceType:i}}parseUVs(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.UV.a;let a=[];return"IndexToDirect"===i&&(a=e.UVIndex.a),{dataSize:2,buffer:s,indices:a,mappingType:t,referenceType:i}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.Colors.a;let a=[];"IndexToDirect"===i&&(a=e.ColorIndex.a);for(let e=0,t=new p;e<s.length;e+=4)t.fromArray(s,e),tt.colorSpaceToWorking(t,u),t.toArray(s,e);return{dataSize:4,buffer:s,indices:a,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,i=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const s=e.Materials.a,a=[];for(let e=0;e<s.length;++e)a.push(e);return{dataSize:1,buffer:s,indices:a,mappingType:t,referenceType:i}}parseNurbsGeometry(e){const i=parseInt(e.Order);if(isNaN(i))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new t;const s=i-1,a=e.KnotVector.a,r=[],n=e.Points.a;for(let e=0,t=n.length;e<t;e+=4)r.push((new at).fromArray(n,e));let o,l;if("Closed"===e.Form)r.push(r[0]);else if("Periodic"===e.Form){o=s,l=a.length-1-o;for(let e=0;e<s;++e)r.push(r[e])}const h=new dr(s,a,r,o,l).getPoints(12*r.length);return(new t).setFromPoints(h)}}class wr{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const i in t){const s=t[i],a=this.addClip(s);e.push(a)}return e}parseClips(){if(void 0===pr.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=pr.Objects.AnimationCurveNode,t=new Map;for(const i in e){const s=e[i];if(null!==s.attrName.match(/S|R|T|DeformPercent/)){const e={id:s.id,attr:s.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=pr.Objects.AnimationCurve;for(const i in t){const s={id:t[i].id,times:t[i].KeyTime.a.map(xr),values:t[i].KeyValueFloat.a},a=gr.get(s.id);if(void 0!==a){const t=a.parents[0].ID,i=a.parents[0].relationship;i.match(/X/)?e.get(t).curves.x=s:i.match(/Y/)?e.get(t).curves.y=s:i.match(/Z/)?e.get(t).curves.z=s:i.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=s)}}}parseAnimationLayers(e){const t=pr.Objects.AnimationLayer,i=new Map;for(const s in t){const t=[],a=gr.get(parseInt(s));if(void 0!==a){a.children.forEach((function(i,s){if(e.has(i.ID)){const a=e.get(i.ID);if(void 0!==a.curves.x||void 0!==a.curves.y||void 0!==a.curves.z){if(void 0===t[s]){const e=gr.get(i.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const a=pr.Objects.Model[e.toString()];if(void 0===a)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",i);const r={modelName:a.attrName?ze.sanitizeNodeName(a.attrName):"",ID:a.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};mr.traverse((function(e){e.ID===a.id&&(r.transform=e.matrix,e.userData.transformData&&(r.eulerOrder=e.userData.transformData.eulerOrder))})),r.transform||(r.transform=new J),"PreRotation"in a&&(r.preRotation=a.PreRotation.value),"PostRotation"in a&&(r.postRotation=a.PostRotation.value),t[s]=r}}t[s]&&(t[s][a.attr]=a)}else if(void 0!==a.curves.morph){if(void 0===t[s]){const e=gr.get(i.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,a=gr.get(e).parents[0].ID,r=gr.get(a).parents[0].ID,n=gr.get(r).parents[0].ID,o=pr.Objects.Model[n],l={modelName:o.attrName?ze.sanitizeNodeName(o.attrName):"",morphName:pr.Objects.Deformer[e].attrName};t[s]=l}t[s][a.attr]=a}}})),i.set(parseInt(s),t)}}return i}parseAnimStacks(e){const t=pr.Objects.AnimationStack,i={};for(const s in t){const a=gr.get(parseInt(s)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const r=e.get(a[0].ID);i[s]={name:t[s].attrName,layer:r}}return i}addClip(e){let t=[];const i=this;return e.layer.forEach((function(e){t=t.concat(i.generateTracks(e))})),new Ke(e.name,-1,t)}generateTracks(e){const t=[];let i=new W,s=new W;if(e.transform&&e.transform.decompose(i,new Y,s),i=i.toArray(),s=s.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");void 0!==s&&t.push(s)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const i=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==i&&t.push(i)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const i=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");void 0!==i&&t.push(i)}if(void 0!==e.DeformPercent){const i=this.generateMorphTrack(e);void 0!==i&&t.push(i)}return t}generateVectorTrack(e,t,i,s){const a=this.getTimesForAllAxes(t),r=this.getKeyframeTrackValues(a,t,i);return new Ze(e+"."+s,a,r)}generateRotationTrack(e,t,i,s,a){let r,n;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,a);r=e[0],n=e[1]}const o=Dr(0);void 0!==i&&((i=i.map(je.degToRad)).push(o),i=(new ge).fromArray(i),i=(new Y).setFromEuler(i)),void 0!==s&&((s=s.map(je.degToRad)).push(o),s=(new ge).fromArray(s),s=(new Y).setFromEuler(s).invert());const l=new Y,h=new ge,c=[];if(!n||!r)return new et(e+".quaternion",[0],[0]);for(let e=0;e<n.length;e+=3){if(h.set(n[e],n[e+1],n[e+2],a),l.setFromEuler(h),void 0!==i&&l.premultiply(i),void 0!==s&&l.multiply(s),e>2){(new Y).fromArray(c,(e-3)/3*4).dot(l)<0&&l.set(-l.x,-l.y,-l.z,-l.w)}l.toArray(c,e/3*4)}return new et(e+".quaternion",r,c)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map((function(e){return e/100})),s=mr.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new $e(e.modelName+".morphTargetInfluences["+s+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,i=t[0];for(let s=1;s<t.length;s++){const a=t[s];a!==i&&(t[e]=a,i=a,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,i){const s=i,a=[];let r=-1,n=-1,o=-1;return e.forEach((function(e){if(t.x&&(r=t.x.times.indexOf(e)),t.y&&(n=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==r){const e=t.x.values[r];a.push(e),s[0]=e}else a.push(s[0]);if(-1!==n){const e=t.y.values[n];a.push(e),s[1]=e}else a.push(s[1]);if(-1!==o){const e=t.z.values[o];a.push(e),s[2]=e}else a.push(s[2])})),a}interpolateRotations(e,t,i,s){const a=[],r=[];a.push(e.times[0]),r.push(je.degToRad(e.values[0])),r.push(je.degToRad(t.values[0])),r.push(je.degToRad(i.values[0]));for(let n=1;n<e.values.length;n++){const o=[e.values[n-1],t.values[n-1],i.values[n-1]];if(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))continue;const l=o.map(je.degToRad),h=[e.values[n],t.values[n],i.values[n]];if(isNaN(h[0])||isNaN(h[1])||isNaN(h[2]))continue;const c=h.map(je.degToRad),A=[h[0]-o[0],h[1]-o[1],h[2]-o[2]],u=[Math.abs(A[0]),Math.abs(A[1]),Math.abs(A[2])];if(u[0]>=180||u[1]>=180||u[2]>=180){const t=Math.max(...u)/180,i=new ge(...l,s),o=new ge(...c,s),h=(new Y).setFromEuler(i),A=(new Y).setFromEuler(o);h.dot(A)&&A.set(-A.x,-A.y,-A.z,-A.w);const d=e.times[n-1],p=e.times[n]-d,g=new Y,m=new ge;for(let e=0;e<1;e+=1/t)g.copy(h.clone().slerp(A.clone(),e)),a.push(d+e*p),m.setFromQuaternion(g,s),r.push(m.x),r.push(m.y),r.push(m.z)}else a.push(e.times[n]),r.push(je.degToRad(e.values[n])),r.push(je.degToRad(t.values[n])),r.push(je.degToRad(i.values[n]))}return[a,r]}}class Ir{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new vr,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,i=e.split(/[\r\n]+/);return i.forEach((function(e,s){const a=e.match(/^[\s\t]*;/),r=e.match(/^[\s\t]*$/);if(a||r)return;const n=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");n?t.parseNodeBegin(e,n):o?t.parseNodeProperty(e,o,i[++s]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const i=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),a={name:i},r=this.parseNodeAttr(s),n=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(i,a):i in n?("PoseNode"===i?n.PoseNode.push(a):void 0!==n[i].id&&(n[i]={},n[i][n[i].id]=n[i]),""!==r.id&&(n[i][r.id]=a)):"number"==typeof r.id?(n[i]={},n[i][r.id]=a):"Properties70"!==i&&(n[i]="PoseNode"===i?[a]:a),"number"==typeof r.id&&(a.id=r.id),""!==r.name&&(a.attrName=r.name),""!==r.type&&(a.attrType=r.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let i="",s="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:i,type:s}}parseNodeProperty(e,t,i){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===s&&","===a&&(a=i.replace(/"/g,"").replace(/,$/,"").trim());const r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===s){const e=a.split(",").slice(1),t=parseInt(e[0]),i=parseInt(e[1]);let n=a.split(",").slice(3);n=n.map((function(e){return e.trim().replace(/^"/,"")})),s="connections",a=[t,i],function(e,t){for(let i=0,s=e.length,a=t.length;i<a;i++,s++)e[s]=t[i]}(a,n),void 0===r[s]&&(r[s]=[])}"Node"===s&&(r.id=a),s in r&&Array.isArray(r[s])?r[s].push(a):"a"!==s?r[s]=a:r.a=a,this.setCurrentProp(r,s),"a"===s&&","!==a.slice(-1)&&(r.a=Tr(a))}else this.parseNodeSpecialProperty(e,s,a)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=Tr(t.a))}parseNodeSpecialProperty(e,t,i){const s=i.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),a=s[0],r=s[1],n=s[2],o=s[3];let l=s[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=Tr(l)}this.getPrevNode()[a]={type:r,type2:n,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),a)}}class Er{parse(e){const t=new Cr(e);t.skip(23);const i=t.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const s=new vr;for(;!this.endOfContent(t);){const e=this.parseNode(t,i);null!==e&&s.add(e.name,e)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const i={},s=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const r=e.getUint8(),n=e.getString(r);if(0===s)return null;const o=[];for(let t=0;t<a;t++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(i.singleProperty=1===a&&e.getOffset()===s;s>e.getOffset();){const s=this.parseNode(e,t);null!==s&&this.parseSubNode(n,i,s)}return i.propertyList=o,"number"==typeof l&&(i.id=l),""!==h&&(i.attrName=h),""!==c&&(i.attrType=c),""!==n&&(i.name=n),i}parseSubNode(e,t,i){if(!0===i.singleProperty){const e=i.propertyList[0];Array.isArray(e)?(t[i.name]=i,i.a=e):t[i.name]=e}else if("Connections"===e&&"C"===i.name){const e=[];i.propertyList.forEach((function(t,i){0!==i&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===i.name){Object.keys(i).forEach((function(e){t[e]=i[e]}))}else if("Properties70"===e&&"P"===i.name){let e=i.propertyList[0],s=i.propertyList[1];const a=i.propertyList[2],r=i.propertyList[3];let n;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),n="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:i.propertyList[4],t[e]={type:s,type2:a,flag:r,value:n}}else void 0===t[i.name]?"number"==typeof i.id?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:"PoseNode"===i.name?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):void 0===t[i.name][i.id]&&(t[i.name][i.id]=i)}parseProperty(e){const t=e.getString(1);let i;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return i=e.getUint32(),e.getArrayBuffer(i);case"S":return i=e.getUint32(),e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),a=e.getUint32(),r=e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const n=lr(new Uint8Array(e.getArrayBuffer(r))),o=new Cr(n.buffer);switch(t){case"b":case"c":return o.getBooleanArray(s);case"d":return o.getFloat64Array(s);case"f":return o.getFloat32Array(s);case"i":return o.getInt32Array(s);case"l":return o.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Cr{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let i=0;i<e;i++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let i=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const s=i.indexOf(0);return s>=0&&(i=new Uint8Array(this.dv.buffer,t,s)),this._textDecoder.decode(i)}}class vr{add(e,t){this[e]=t}}function Br(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function xr(e){return e/46186158e3}const kr=[];function Qr(e,t,i,s){let a;switch(s.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=i;break;case"AllSame":a=s.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+s.mappingType)}"IndexToDirect"===s.referenceType&&(a=s.indices[a]);const r=a*s.dataSize,n=r+s.dataSize;return function(e,t,i,s){for(let a=i,r=0;a<s;a++,r++)e[r]=t[a];return e}(kr,s.buffer,r,n)}const Sr=new ge,Mr=new W;function Rr(e){const t=new J,i=new J,s=new J,a=new J,r=new J,n=new J,o=new J,l=new J,h=new J,c=new J,A=new J,u=new J,d=e.inheritType?e.inheritType:0;e.translation&&t.setPosition(Mr.fromArray(e.translation));const p=Dr(0);if(e.preRotation){const t=e.preRotation.map(je.degToRad);t.push(p),i.makeRotationFromEuler(Sr.fromArray(t))}if(e.rotation){const t=e.rotation.map(je.degToRad);t.push(e.eulerOrder||p),s.makeRotationFromEuler(Sr.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(je.degToRad);t.push(p),a.makeRotationFromEuler(Sr.fromArray(t)),a.invert()}e.scale&&r.scale(Mr.fromArray(e.scale)),e.scalingOffset&&o.setPosition(Mr.fromArray(e.scalingOffset)),e.scalingPivot&&n.setPosition(Mr.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(Mr.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(Mr.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(A.copy(e.parentMatrix),c.copy(e.parentMatrixWorld));const g=i.clone().multiply(s).multiply(a),m=new J;m.extractRotation(c);const f=new J;f.copyPosition(c);const b=f.clone().invert().multiply(c),y=m.clone().invert().multiply(b),w=r,I=new J;if(0===d)I.copy(m).multiply(g).multiply(y).multiply(w);else if(1===d)I.copy(m).multiply(y).multiply(g).multiply(w);else{const e=(new J).scale((new W).setFromMatrixScale(A)).clone().invert(),t=y.clone().multiply(e);I.copy(m).multiply(g).multiply(t).multiply(w)}const E=h.clone().invert(),C=n.clone().invert();let v=t.clone().multiply(l).multiply(h).multiply(i).multiply(s).multiply(a).multiply(E).multiply(o).multiply(n).multiply(r).multiply(C);const B=(new J).copyPosition(v),x=c.clone().multiply(B);return u.copyPosition(x),v=u.clone().multiply(I),v.premultiply(c.invert()),v}function Dr(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function Tr(e){return e.split(",").map((function(e){return parseFloat(e)}))}function Fr(e,t,i){return void 0===t&&(t=0),void 0===i&&(i=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,i))}const Lr=/^[og]\s*(.+)?/,Pr=/^mtllib /,_r=/^usemtl /,zr=/^usemap /,Ur=/\s+/,Nr=new W,Gr=new W,Or=new W,qr=new W,jr=new W,Hr=new p;function Vr(){const e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);const i=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(e,t){const i=this._finalize(!1);i&&(i.inherited||i.groupCount<=0)&&this.materials.splice(i.index,1);const s={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==i?i.smooth:this.smooth,groupStart:void 0!==i?i.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){const t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(s),s},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){const t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(let e=this.materials.length-1;e>=0;e--)this.materials[e].groupCount<=0&&this.materials.splice(e,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},i&&i.name&&"function"==typeof i.clone){const e=i.clone(0);e.inherited=!0,this.object.materials.push(e)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)},parseNormalIndex:function(e,t){const i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)},parseUVIndex:function(e,t){const i=parseInt(e,10);return 2*(i>=0?i-1:i+t/2)},addVertex:function(e,t,i){const s=this.vertices,a=this.object.geometry.vertices;a.push(s[e+0],s[e+1],s[e+2]),a.push(s[t+0],s[t+1],s[t+2]),a.push(s[i+0],s[i+1],s[i+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,i){const s=this.normals,a=this.object.geometry.normals;a.push(s[e+0],s[e+1],s[e+2]),a.push(s[t+0],s[t+1],s[t+2]),a.push(s[i+0],s[i+1],s[i+2])},addFaceNormal:function(e,t,i){const s=this.vertices,a=this.object.geometry.normals;Nr.fromArray(s,e),Gr.fromArray(s,t),Or.fromArray(s,i),jr.subVectors(Or,Gr),qr.subVectors(Nr,Gr),jr.cross(qr),jr.normalize(),a.push(jr.x,jr.y,jr.z),a.push(jr.x,jr.y,jr.z),a.push(jr.x,jr.y,jr.z)},addColor:function(e,t,i){const s=this.colors,a=this.object.geometry.colors;void 0!==s[e]&&a.push(s[e+0],s[e+1],s[e+2]),void 0!==s[t]&&a.push(s[t+0],s[t+1],s[t+2]),void 0!==s[i]&&a.push(s[i+0],s[i+1],s[i+2])},addUV:function(e,t,i){const s=this.uvs,a=this.object.geometry.uvs;a.push(s[e+0],s[e+1]),a.push(s[t+0],s[t+1]),a.push(s[i+0],s[i+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,i,s,a,r,n,o,l){const h=this.vertices.length;let c=this.parseVertexIndex(e,h),A=this.parseVertexIndex(t,h),u=this.parseVertexIndex(i,h);if(this.addVertex(c,A,u),this.addColor(c,A,u),void 0!==n&&""!==n){const e=this.normals.length;c=this.parseNormalIndex(n,e),A=this.parseNormalIndex(o,e),u=this.parseNormalIndex(l,e),this.addNormal(c,A,u)}else this.addFaceNormal(c,A,u);if(void 0!==s&&""!==s){const e=this.uvs.length;c=this.parseUVIndex(s,e),A=this.parseUVIndex(a,e),u=this.parseUVIndex(r,e),this.addUV(c,A,u),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let i=0,s=e.length;i<s;i++){const s=this.parseVertexIndex(e[i],t);this.addVertexPoint(s),this.addColor(s)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const i=this.vertices.length,s=this.uvs.length;for(let t=0,s=e.length;t<s;t++)this.addVertexLine(this.parseVertexIndex(e[t],i));for(let e=0,i=t.length;e<i;e++)this.addUVLine(this.parseUVIndex(t[e],s))}};return e.startObject("",!1),e}class Kr extends ne{constructor(e){super(e),this.materials=null}load(e,t,i,s){const a=this,r=new oe(this.manager);r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(function(i){try{t(a.parse(i))}catch(t){s?s(t):console.error(t),a.manager.itemError(e)}}),i,s)}setMaterials(e){return this.materials=e,this}parse(i){const r=new Vr;-1!==i.indexOf("\r\n")&&(i=i.replace(/\r\n/g,"\n")),-1!==i.indexOf("\\\n")&&(i=i.replace(/\\\n/g,""));const n=i.split("\n");let o=[];for(let e=0,t=n.length;e<t;e++){const t=n[e].trimStart();if(0===t.length)continue;const i=t.charAt(0);if("#"!==i)if("v"===i){const e=t.split(Ur);switch(e[0]){case"v":r.vertices.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),e.length>=7?(Hr.setRGB(parseFloat(e[4]),parseFloat(e[5]),parseFloat(e[6]),u),r.colors.push(Hr.r,Hr.g,Hr.b)):r.colors.push(void 0,void 0,void 0);break;case"vn":r.normals.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));break;case"vt":r.uvs.push(parseFloat(e[1]),parseFloat(e[2]))}}else if("f"===i){const e=t.slice(1).trim().split(Ur),i=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];if(s.length>0){const e=s.split("/");i.push(e)}}const s=i[0];for(let e=1,t=i.length-1;e<t;e++){const t=i[e],a=i[e+1];r.addFace(s[0],t[0],a[0],s[1],t[1],a[1],s[2],t[2],a[2])}}else if("l"===i){const e=t.substring(1).trim().split(" ");let i=[];const s=[];if(-1===t.indexOf("/"))i=e;else for(let t=0,a=e.length;t<a;t++){const a=e[t].split("/");""!==a[0]&&i.push(a[0]),""!==a[1]&&s.push(a[1])}r.addLineGeometry(i,s)}else if("p"===i){const e=t.slice(1).trim().split(" ");r.addPointGeometry(e)}else if(null!==(o=Lr.exec(t))){const e=(" "+o[0].slice(1).trim()).slice(1);r.startObject(e)}else if(_r.test(t))r.object.startMaterial(t.substring(7).trim(),r.materialLibraries);else if(Pr.test(t))r.materialLibraries.push(t.substring(7).trim());else if(zr.test(t))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if("s"===i){if(o=t.split(" "),o.length>1){const e=o[1].trim().toLowerCase();r.object.smooth="0"!==e&&"off"!==e}else r.object.smooth=!0;const e=r.object.currentMaterial();e&&(e.smooth=r.object.smooth)}else{if("\0"===t)continue;console.warn('THREE.OBJLoader: Unexpected line: "'+t+'"')}}r.finalize();const l=new Oe;l.materialLibraries=[].concat(r.materialLibraries);if(!0===!(1===r.objects.length&&0===r.objects[0].geometry.vertices.length))for(let i=0,n=r.objects.length;i<n;i++){const n=r.objects[i],o=n.geometry,h=n.materials,c="Line"===o.type,A="Points"===o.type;let u=!1;if(0===o.vertices.length)continue;const d=new t;d.setAttribute("position",new s(o.vertices,3)),o.normals.length>0&&d.setAttribute("normal",new s(o.normals,3)),o.colors.length>0&&(u=!0,d.setAttribute("color",new s(o.colors,3))),!0===o.hasUVIndices&&d.setAttribute("uv",new s(o.uvs,2));const p=[];for(let e=0,t=h.length;e<t;e++){const t=h[e],i=t.name+"_"+t.smooth+"_"+u;let s=r.materials[i];if(null!==this.materials)if(s=this.materials.create(t.name),!c||!s||s instanceof a){if(A&&s&&!(s instanceof Pe)){const e=new Pe({size:10,sizeAttenuation:!1});_e.prototype.copy.call(e,s),e.color.copy(s.color),e.map=s.map,s=e}}else{const e=new a;_e.prototype.copy.call(e,s),e.color.copy(s.color),s=e}void 0===s&&(s=c?new a:A?new Pe({size:1,sizeAttenuation:!1}):new E,s.name=t.name,s.flatShading=!t.smooth,s.vertexColors=u,r.materials[i]=s),p.push(s)}let g;if(p.length>1){for(let e=0,t=h.length;e<t;e++){const t=h[e];d.addGroup(t.groupStart,t.groupCount,e)}g=c?new e(d,p):A?new Ge(d,p):new Z(d,p)}else g=c?new e(d,p[0]):A?new Ge(d,p[0]):new Z(d,p[0]);g.name=n.name,l.add(g)}else if(r.vertices.length>0){const e=new Pe({size:1,sizeAttenuation:!1}),i=new t;i.setAttribute("position",new s(r.vertices,3)),r.colors.length>0&&void 0!==r.colors[0]&&(i.setAttribute("color",new s(r.colors,3)),e.vertexColors=!0);const a=new Ge(i,e);l.add(a)}return l}}class Wr extends ne{constructor(e){super(e)}load(e,t,i,s){const a=this,r=new oe(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(function(i){try{t(a.parse(i))}catch(t){s?s(t):console.error(t),a.manager.itemError(e)}}),i,s)}parse(e){function a(e,t,i){for(let s=0,a=e.length;s<a;s++)if(e[s]!==t.getUint8(i+s))return!1;return!0}const r=function(e){if("string"==typeof e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=255&e.charCodeAt(i);return t.buffer||t}return e}(e);return function(e){const t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;const i=[115,111,108,105,100];for(let e=0;e<5;e++)if(a(i,t,e))return!1;return!0}(r)?function(e){const s=new DataView(e),a=s.getUint32(80,!0);let r,n,o,l,h,c,A,d,g=!1;for(let e=0;e<70;e++)1129270351==s.getUint32(e,!1)&&82==s.getUint8(e+4)&&61==s.getUint8(e+5)&&(g=!0,l=new Float32Array(3*a*3),h=s.getUint8(e+6)/255,c=s.getUint8(e+7)/255,A=s.getUint8(e+8)/255,d=s.getUint8(e+9)/255);const m=new t,f=new Float32Array(3*a*3),b=new Float32Array(3*a*3),y=new p;for(let e=0;e<a;e++){const t=84+50*e,i=s.getFloat32(t,!0),a=s.getFloat32(t+4,!0),d=s.getFloat32(t+8,!0);if(g){const e=s.getUint16(t+48,!0);32768&e?(r=h,n=c,o=A):(r=(31&e)/31,n=(e>>5&31)/31,o=(e>>10&31)/31)}for(let h=1;h<=3;h++){const c=t+12*h,A=3*e*3+3*(h-1);f[A]=s.getFloat32(c,!0),f[A+1]=s.getFloat32(c+4,!0),f[A+2]=s.getFloat32(c+8,!0),b[A]=i,b[A+1]=a,b[A+2]=d,g&&(y.setRGB(r,n,o,u),l[A]=y.r,l[A+1]=y.g,l[A+2]=y.b)}}return m.setAttribute("position",new i(f,3)),m.setAttribute("normal",new i(b,3)),g&&(m.setAttribute("color",new i(l,3)),m.hasColors=!0,m.alpha=d),m}(r):function(e){const i=new t,a=/solid([\s\S]*?)endsolid/g,r=/facet([\s\S]*?)endfacet/g,n=/solid\s(.+)/;let o=0;const l=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,h=new RegExp("vertex"+l+l+l,"g"),c=new RegExp("normal"+l+l+l,"g"),A=[],u=[],d=[],p=new W;let g,m=0,f=0,b=0;for(;null!==(g=a.exec(e));){f=b;const e=g[0],t=null!==(g=n.exec(e))?g[1]:"";for(d.push(t);null!==(g=r.exec(e));){let e=0,t=0;const i=g[0];for(;null!==(g=c.exec(i));)p.x=parseFloat(g[1]),p.y=parseFloat(g[2]),p.z=parseFloat(g[3]),t++;for(;null!==(g=h.exec(i));)A.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])),u.push(p.x,p.y,p.z),e++,b++;1!==t&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+o),3!==e&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+o),o++}const s=f,a=b-f;i.userData.groupNames=d,i.addGroup(s,a,m),m++}return i.setAttribute("position",new s(A,3)),i.setAttribute("normal",new s(u,3)),i}("string"!=typeof(n=e)?(new TextDecoder).decode(n):n);var n}}let Jr=class extends ht{constructor(e){super(e),this.type=ct}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},i=function(e,t,i){t=t||1024;let s=e.pos,a=-1,r=0,n="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));for(;0>(a=o.indexOf("\n"))&&r<t&&s<e.byteLength;)n+=o,r+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));return-1<a&&(e.pos+=r+a+1,n+o.slice(0,a))},s=function(e,t,i,s){const a=e[t+3],r=Math.pow(2,a-128)/255;i[s+0]=e[t+0]*r,i[s+1]=e[t+1]*r,i[s+2]=e[t+2]*r,i[s+3]=1},a=function(e,t,i,s){const a=e[t+3],r=Math.pow(2,a-128)/255;i[s+0]=ut.toHalfFloat(Math.min(e[t+0]*r,65504)),i[s+1]=ut.toHalfFloat(Math.min(e[t+1]*r,65504)),i[s+2]=ut.toHalfFloat(Math.min(e[t+2]*r,65504)),i[s+3]=ut.toHalfFloat(1)},r=new Uint8Array(e);r.pos=0;const n=function(e){const s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,n=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((e.pos>=e.byteLength||!(l=i(e)))&&t(1,"no header found"),(h=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),o.valid|=1,o.programtype=h[1],o.string+=l+"\n";l=i(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(s))&&(o.gamma=parseFloat(h[1])),(h=l.match(a))&&(o.exposure=parseFloat(h[1])),(h=l.match(r))&&(o.valid|=2,o.format=h[1]),(h=l.match(n))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||t(3,"missing format specifier"),4&o.valid||t(3,"missing image size specifier"),o}(r),o=n.width,l=n.height,h=function(e,i,s){const a=i;if(a<8||a>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);a!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const r=new Uint8Array(4*i*s);r.length||t(4,"unable to allocate buffer space");let n=0,o=0;const l=4*a,h=new Uint8Array(4),c=new Uint8Array(l);let A=s;for(;A>0&&o<e.byteLength;){o+4>e.byteLength&&t(1),h[0]=e[o++],h[1]=e[o++],h[2]=e[o++],h[3]=e[o++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==a||t(3,"bad rgbe scanline format");let i,s=0;for(;s<l&&o<e.byteLength;){i=e[o++];const a=i>128;if(a&&(i-=128),(0===i||s+i>l)&&t(3,"bad scanline data"),a){const t=e[o++];for(let e=0;e<i;e++)c[s++]=t}else c.set(e.subarray(o,o+i),s),s+=i,o+=i}const u=a;for(let e=0;e<u;e++){let t=0;r[n]=c[e+t],t+=a,r[n+1]=c[e+t],t+=a,r[n+2]=c[e+t],t+=a,r[n+3]=c[e+t],n+=4}A--}return r}(r.subarray(r.pos),o,l);let c,A,u;switch(this.type){case At:u=h.length/4;const e=new Float32Array(4*u);for(let t=0;t<u;t++)s(h,4*t,e,4*t);c=e,A=At;break;case ct:u=h.length/4;const t=new Uint16Array(4*u);for(let e=0;e<u;e++)a(h,4*e,t,4*e);c=t,A=ct;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:o,height:l,data:c,header:n.string,gamma:n.gamma,exposure:n.exposure,type:A}}setDataType(e){return this.type=e,this}load(e,t,i,s){return super.load(e,(function(e,i){switch(e.type){case At:case ct:e.colorSpace=we,e.minFilter=De,e.magFilter=De,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,i)}),i,s)}},Xr=class extends ht{constructor(e){super(e),this.type=ct}parse(e){const t=65536,i=14,s=65537,a=16384,r=Math.pow(2.7182818,2.2);const n={l:0,c:0,lc:0};function o(e,t,i,s,a){for(;i<e;)t=t<<8|G(s,a),i+=8;i-=e,n.l=t>>i&(1<<e)-1,n.c=t,n.lc=i}const l=new Array(59);function h(e,t,i,a,r,h){const c=t;let A=0,u=0;for(;a<=r;a++){if(c.value-t.value>i)return!1;o(6,A,u,e,c);const s=n.l;if(A=n.c,u=n.lc,h[a]=s,63==s){if(c.value-t.value>i)throw new Error("Something wrong with hufUnpackEncTable");o(8,A,u,e,c);let s=n.l+6;if(A=n.c,u=n.lc,a+s>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;s--;)h[a++]=0;a--}else if(s>=59){let e=s-59+2;if(a+e>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)h[a++]=0;a--}}!function(e){for(let e=0;e<=58;++e)l[e]=0;for(let t=0;t<s;++t)l[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const i=t+l[e]>>1;l[e]=t,t=i}for(let t=0;t<s;++t){const i=e[t];i>0&&(e[t]=i|l[i]++<<6)}}(h)}function c(e){return 63&e}function A(e){return e>>6}const u={c:0,lc:0};function d(e,t,i,s){e=e<<8|G(i,s),t+=8,u.c=e,u.lc=t}const p={c:0,lc:0};function g(e,t,i,s,a,r,n,o,l){if(e==t){s<8&&(d(i,s,a,r),i=u.c,s=u.lc);let e=i>>(s-=8);if(e=new Uint8Array([e])[0],o.value+e>l)return!1;const t=n[o.value-1];for(;e-- >0;)n[o.value++]=t}else{if(!(o.value<l))return!1;n[o.value++]=e}p.c=i,p.lc=s}function m(e){return 65535&e}function f(e){const t=m(e);return t>32767?t-65536:t}const b={a:0,b:0};function y(e,t){const i=f(e),s=f(t),a=i+(1&s)+(s>>1),r=a,n=a-s;b.a=r,b.b=n}function w(e,t){const i=m(e),s=m(t),a=i-(s>>1)&65535,r=s+a-32768&65535;b.a=r,b.b=a}function I(e,t,i,s,a,r,n){const o=n<16384,l=i>a?a:i;let h,c,A=1;for(;A<=l;)A<<=1;for(A>>=1,h=A,A>>=1;A>=1;){c=0;const n=c+r*(a-h),l=r*A,u=r*h,d=s*A,p=s*h;let g,m,f,I;for(;c<=n;c+=u){let a=c;const r=c+s*(i-h);for(;a<=r;a+=p){const i=a+d,s=a+l,r=s+d;o?(y(e[a+t],e[s+t]),g=b.a,f=b.b,y(e[i+t],e[r+t]),m=b.a,I=b.b,y(g,m),e[a+t]=b.a,e[i+t]=b.b,y(f,I),e[s+t]=b.a,e[r+t]=b.b):(w(e[a+t],e[s+t]),g=b.a,f=b.b,w(e[i+t],e[r+t]),m=b.a,I=b.b,w(g,m),e[a+t]=b.a,e[i+t]=b.b,w(f,I),e[s+t]=b.a,e[r+t]=b.b)}if(i&A){const i=a+l;o?y(e[a+t],e[i+t]):w(e[a+t],e[i+t]),g=b.a,e[i+t]=b.b,e[a+t]=g}}if(a&A){let a=c;const r=c+s*(i-h);for(;a<=r;a+=p){const i=a+d;o?y(e[a+t],e[i+t]):w(e[a+t],e[i+t]),g=b.a,e[i+t]=b.b,e[a+t]=g}}h=A,A>>=1}return c}function E(e,t,r,n,o,l){const m=r.value,f=N(t,r),b=N(t,r);r.value+=4;const y=N(t,r);if(r.value+=4,f<0||f>=s||b<0||b>=s)throw new Error("Something wrong with HUF_ENCSIZE");const w=new Array(s),I=new Array(a);!function(e){for(let t=0;t<a;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(I);if(h(e,r,n-(r.value-m),f,b,w),y>8*(n-(r.value-m)))throw new Error("Something wrong with hufUncompress");!function(e,t,s,a){for(;t<=s;t++){const s=A(e[t]),r=c(e[t]);if(s>>r)throw new Error("Invalid table entry");if(r>i){const e=a[s>>r-i];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let i=0;i<e.lit-1;++i)e.p[i]=t[i]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(r){let e=0;for(let n=1<<i-r;n>0;n--){const n=a[(s<<i-r)+e];if(n.len||n.p)throw new Error("Invalid table entry");n.len=r,n.lit=t,e++}}}}(w,f,b,I),function(e,t,s,a,r,n,o,l,h){let m=0,f=0;const b=o,y=Math.trunc(a.value+(r+7)/8);for(;a.value<y;)for(d(m,f,s,a),m=u.c,f=u.lc;f>=i;){const r=t[m>>f-i&16383];if(r.len)f-=r.len,g(r.lit,n,m,f,s,a,l,h,b),m=p.c,f=p.lc;else{if(!r.p)throw new Error("hufDecode issues");let t;for(t=0;t<r.lit;t++){const i=c(e[r.p[t]]);for(;f<i&&a.value<y;)d(m,f,s,a),m=u.c,f=u.lc;if(f>=i&&A(e[r.p[t]])==(m>>f-i&(1<<i)-1)){f-=i,g(r.p[t],n,m,f,s,a,l,h,b),m=p.c,f=p.lc;break}}if(t==r.lit)throw new Error("hufDecode issues")}}const w=8-r&7;for(m>>=w,f-=w;f>0;){const e=t[m<<i-f&16383];if(!e.len)throw new Error("hufDecode issues");f-=e.len,g(e.lit,n,m,f,s,a,l,h,b),m=p.c,f=p.lc}}(w,I,e,r,y,b,l,o,{value:0})}function C(e){for(let t=1;t<e.length;t++){const i=e[t-1]+e[t]-128;e[t]=i}}function v(e,t){let i=0,s=Math.floor((e.length+1)/2),a=0;const r=e.length-1;for(;!(a>r||(t[a++]=e[i++],a>r));)t[a++]=e[s++]}function B(e){let t=e.byteLength;const i=new Array;let s=0;const a=new DataView(e);for(;t>0;){const e=a.getInt8(s++);if(e<0){const r=-e;t-=r+1;for(let e=0;e<r;e++)i.push(a.getUint8(s++))}else{const r=e;t-=2;const n=a.getUint8(s++);for(let e=0;e<r+1;e++)i.push(n)}}return i}function x(e,t,i){let s,a=1;for(;a<64;)s=t[e.value],65280==s?a=64:s>>8==255?a+=255&s:(i[a]=s,a++),e.value++}function k(e,t){t[0]=V(e[0]),t[1]=V(e[1]),t[2]=V(e[5]),t[3]=V(e[6]),t[4]=V(e[14]),t[5]=V(e[15]),t[6]=V(e[27]),t[7]=V(e[28]),t[8]=V(e[2]),t[9]=V(e[4]),t[10]=V(e[7]),t[11]=V(e[13]),t[12]=V(e[16]),t[13]=V(e[26]),t[14]=V(e[29]),t[15]=V(e[42]),t[16]=V(e[3]),t[17]=V(e[8]),t[18]=V(e[12]),t[19]=V(e[17]),t[20]=V(e[25]),t[21]=V(e[30]),t[22]=V(e[41]),t[23]=V(e[43]),t[24]=V(e[9]),t[25]=V(e[11]),t[26]=V(e[18]),t[27]=V(e[24]),t[28]=V(e[31]),t[29]=V(e[40]),t[30]=V(e[44]),t[31]=V(e[53]),t[32]=V(e[10]),t[33]=V(e[19]),t[34]=V(e[23]),t[35]=V(e[32]),t[36]=V(e[39]),t[37]=V(e[45]),t[38]=V(e[52]),t[39]=V(e[54]),t[40]=V(e[20]),t[41]=V(e[22]),t[42]=V(e[33]),t[43]=V(e[38]),t[44]=V(e[46]),t[45]=V(e[51]),t[46]=V(e[55]),t[47]=V(e[60]),t[48]=V(e[21]),t[49]=V(e[34]),t[50]=V(e[37]),t[51]=V(e[47]),t[52]=V(e[50]),t[53]=V(e[56]),t[54]=V(e[59]),t[55]=V(e[61]),t[56]=V(e[35]),t[57]=V(e[36]),t[58]=V(e[48]),t[59]=V(e[49]),t[60]=V(e[57]),t[61]=V(e[58]),t[62]=V(e[62]),t[63]=V(e[63])}function Q(e){const t=.5*Math.cos(.7853975),i=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),a=.5*Math.cos(3*3.14159/16),r=.5*Math.cos(.981746875),n=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),A=new Array(4);for(let u=0;u<8;++u){const d=8*u;l[0]=s*e[d+2],l[1]=n*e[d+2],l[2]=s*e[d+6],l[3]=n*e[d+6],h[0]=i*e[d+1]+a*e[d+3]+r*e[d+5]+o*e[d+7],h[1]=a*e[d+1]-o*e[d+3]-i*e[d+5]-r*e[d+7],h[2]=r*e[d+1]-i*e[d+3]+o*e[d+5]+a*e[d+7],h[3]=o*e[d+1]-r*e[d+3]+a*e[d+5]-i*e[d+7],c[0]=t*(e[d+0]+e[d+4]),c[3]=t*(e[d+0]-e[d+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[d+0]=A[0]+h[0],e[d+1]=A[1]+h[1],e[d+2]=A[2]+h[2],e[d+3]=A[3]+h[3],e[d+4]=A[3]-h[3],e[d+5]=A[2]-h[2],e[d+6]=A[1]-h[1],e[d+7]=A[0]-h[0]}for(let u=0;u<8;++u)l[0]=s*e[16+u],l[1]=n*e[16+u],l[2]=s*e[48+u],l[3]=n*e[48+u],h[0]=i*e[8+u]+a*e[24+u]+r*e[40+u]+o*e[56+u],h[1]=a*e[8+u]-o*e[24+u]-i*e[40+u]-r*e[56+u],h[2]=r*e[8+u]-i*e[24+u]+o*e[40+u]+a*e[56+u],h[3]=o*e[8+u]-r*e[24+u]+a*e[40+u]-i*e[56+u],c[0]=t*(e[u]+e[32+u]),c[3]=t*(e[u]-e[32+u]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[0+u]=A[0]+h[0],e[8+u]=A[1]+h[1],e[16+u]=A[2]+h[2],e[24+u]=A[3]+h[3],e[32+u]=A[3]-h[3],e[40+u]=A[2]-h[2],e[48+u]=A[1]-h[1],e[56+u]=A[0]-h[0]}function S(e){for(let t=0;t<64;++t){const i=e[0][t],s=e[1][t],a=e[2][t];e[0][t]=i+1.5747*a,e[1][t]=i-.1873*s-.4682*a,e[2][t]=i+1.8556*s}}function M(e,t,i){for(let s=0;s<64;++s)t[i+s]=ut.toHalfFloat(R(e[s]))}function R(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(r,Math.abs(e)-1)}function D(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function T(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),i=new Uint8Array(B(t)),s=new Uint8Array(i.length);return C(i),v(i,s),new DataView(s.buffer)}function F(e){const t=lr(e.array.slice(e.offset.value,e.offset.value+e.size)),i=new Uint8Array(t.length);return C(t),v(t,i),new DataView(i.buffer)}function L(e){const i=e.viewer,s={value:e.offset.value},a=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),r=new Uint8Array(8192);let n=0;const o=new Array(e.inputChannels.length);for(let t=0,i=e.inputChannels.length;t<i;t++)o[t]={},o[t].start=n,o[t].end=o[t].start,o[t].nx=e.columns,o[t].ny=e.lines,o[t].size=e.type,n+=o[t].nx*o[t].ny*o[t].size;const l=K(i,s),h=K(i,s);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let e=0;e<h-l+1;e++)r[e+l]=O(i,s);const c=new Uint16Array(t),A=function(e,i){let s=0;for(let a=0;a<t;++a)(0==a||e[a>>3]&1<<(7&a))&&(i[s++]=a);const a=s-1;for(;s<t;)i[s++]=0;return a}(r,c),u=N(i,s);E(e.array,i,s,u,a,n);for(let t=0;t<e.inputChannels.length;++t){const e=o[t];for(let i=0;i<o[t].size;++i)I(a,e.start+i,e.nx,e.size,e.ny,e.nx*e.size,A)}!function(e,t,i){for(let s=0;s<i;++s)t[s]=e[t[s]]}(c,a,n);let d=0;const p=new Uint8Array(a.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){const e=o[t],i=e.nx*e.size,s=new Uint8Array(a.buffer,2*e.end,2*i);p.set(s,d),d+=2*i,e.end+=i}return new DataView(p.buffer)}function P(e){const t=lr(e.array.slice(e.offset.value,e.offset.value+e.size)),i=e.inputChannels.length*e.lines*e.columns*e.totalBytes,s=new ArrayBuffer(i),a=new DataView(s);let r=0,n=0;const o=new Array(4);for(let i=0;i<e.lines;i++)for(let i=0;i<e.inputChannels.length;i++){let s=0;switch(e.inputChannels[i].pixelType){case 1:o[0]=r,o[1]=o[0]+e.columns,r=o[1]+e.columns;for(let i=0;i<e.columns;++i){s+=t[o[0]++]<<8|t[o[1]++],a.setUint16(n,s,!0),n+=2}break;case 2:o[0]=r,o[1]=o[0]+e.columns,o[2]=o[1]+e.columns,r=o[2]+e.columns;for(let i=0;i<e.columns;++i){s+=t[o[0]++]<<24|t[o[1]++]<<16|t[o[2]++]<<8,a.setUint32(n,s,!0),n+=4}}}return a}function _(e){const t=e.viewer,i={value:e.offset.value},s=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),a={version:q(t,i),unknownUncompressedSize:q(t,i),unknownCompressedSize:q(t,i),acCompressedSize:q(t,i),dcCompressedSize:q(t,i),rleCompressedSize:q(t,i),rleUncompressedSize:q(t,i),rleRawSize:q(t,i),totalAcUncompressedCount:q(t,i),totalDcUncompressedCount:q(t,i),acCompression:q(t,i)};if(a.version<2)throw new Error("EXRLoader.parse: "+se.compression+" version "+a.version+" is unsupported");const r=new Array;let n=K(t,i)-2;for(;n>0;){const e=z(t.buffer,i),s=O(t,i),a=s>>2&3,o=new Int8Array([(s>>4)-1])[0],l=O(t,i);r.push({name:e,index:o,type:l,compression:a}),n-=e.length+3}const o=se.channels,l=new Array(e.inputChannels.length);for(let t=0;t<e.inputChannels.length;++t){const i=l[t]={},s=o[t];i.name=s.name,i.compression=0,i.decoded=!1,i.type=s.pixelType,i.pLinear=s.pLinear,i.width=e.columns,i.height=e.lines}const h={idx:new Array(3)};for(let t=0;t<e.inputChannels.length;++t){const e=l[t];for(let i=0;i<r.length;++i){const s=r[i];e.name==s.name&&(e.compression=s.compression,s.index>=0&&(h.idx[s.index]=t),e.offset=t)}}let c,A,u;if(a.acCompressedSize>0)switch(a.acCompression){case 0:c=new Uint16Array(a.totalAcUncompressedCount),E(e.array,t,i,a.acCompressedSize,c,a.totalAcUncompressedCount);break;case 1:const s=lr(e.array.slice(i.value,i.value+a.totalAcUncompressedCount));c=new Uint16Array(s.buffer),i.value+=a.totalAcUncompressedCount}if(a.dcCompressedSize>0){const t={array:e.array,offset:i,size:a.dcCompressedSize};A=new Uint16Array(F(t).buffer),i.value+=a.dcCompressedSize}if(a.rleRawSize>0){u=B(lr(e.array.slice(i.value,i.value+a.rleCompressedSize)).buffer),i.value+=a.rleCompressedSize}let d=0;const p=new Array(l.length);for(let e=0;e<p.length;++e)p[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<l.length;++t)p[t].push(d),d+=l[t].width*e.type*2;!function(e,t,i,s,a,r){let n=new DataView(r.buffer);const o=i[e.idx[0]].width,l=i[e.idx[0]].height,h=Math.floor(o/8),c=Math.ceil(o/8),A=Math.ceil(l/8),u=o-8*(c-1),d=l-8*(A-1),p={value:0},g=new Array(3),m=new Array(3),f=new Array(3),b=new Array(3),y=new Array(3);for(let i=0;i<3;++i)y[i]=t[e.idx[i]],g[i]=i<1?0:g[i-1]+c*A,m[i]=new Float32Array(64),f[i]=new Uint16Array(64),b[i]=new Uint16Array(64*c);for(let t=0;t<A;++t){let r=8;t==A-1&&(r=d);let o=8;for(let e=0;e<c;++e){e==c-1&&(o=u);for(let e=0;e<3;++e)f[e].fill(0),f[e][0]=a[g[e]++],x(p,s,f[e]),k(f[e],m[e]),Q(m[e]);S(m);for(let t=0;t<3;++t)M(m[t],b[t],64*e)}let l=0;for(let s=0;s<3;++s){const a=i[e.idx[s]].type;for(let e=8*t;e<8*t+r;++e){l=y[s][e];for(let t=0;t<h;++t){const i=64*t+8*(7&e);n.setUint16(l+0*a,b[s][i+0],!0),n.setUint16(l+2*a,b[s][i+1],!0),n.setUint16(l+4*a,b[s][i+2],!0),n.setUint16(l+6*a,b[s][i+3],!0),n.setUint16(l+8*a,b[s][i+4],!0),n.setUint16(l+10*a,b[s][i+5],!0),n.setUint16(l+12*a,b[s][i+6],!0),n.setUint16(l+14*a,b[s][i+7],!0),l+=16*a}}if(h!=c)for(let e=8*t;e<8*t+r;++e){const t=y[s][e]+8*h*2*a,i=64*h+8*(7&e);for(let e=0;e<o;++e)n.setUint16(t+2*e*a,b[s][i+e],!0)}}}const w=new Uint16Array(o);n=new DataView(r.buffer);for(let t=0;t<3;++t){i[e.idx[t]].decoded=!0;const s=i[e.idx[t]].type;if(2==i[t].type)for(let e=0;e<l;++e){const i=y[t][e];for(let e=0;e<o;++e)w[e]=n.getUint16(i+2*e*s,!0);for(let e=0;e<o;++e)n.setFloat32(i+2*e*s,V(w[e]),!0)}}}(h,p,l,c,A,s);for(let t=0;t<l.length;++t){const i=l[t];if(!i.decoded){if(2!==i.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let a=0,r=0;for(let n=0;n<e.lines;++n){let e=p[t][a];for(let t=0;t<i.width;++t){for(let t=0;t<2*i.type;++t)s[e++]=u[r+t*i.width*i.height];r++}a++}}}}return new DataView(s.buffer)}function z(e,t){const i=new Uint8Array(e);let s=0;for(;0!=i[t.value+s];)s+=1;const a=(new TextDecoder).decode(i.slice(t.value,t.value+s));return t.value=t.value+s+1,a}function U(e,t){const i=e.getInt32(t.value,!0);return t.value=t.value+4,i}function N(e,t){const i=e.getUint32(t.value,!0);return t.value=t.value+4,i}function G(e,t){const i=e[t.value];return t.value=t.value+1,i}function O(e,t){const i=e.getUint8(t.value);return t.value=t.value+1,i}const q=function(e,t){let i;return i="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,i};function j(e,t){const i=e.getFloat32(t.value,!0);return t.value+=4,i}function H(e,t){return ut.toHalfFloat(j(e,t))}function V(e){const t=(31744&e)>>10,i=1023&e;return(e>>15?-1:1)*(t?31===t?i?NaN:1/0:Math.pow(2,t-15)*(1+i/1024):i/1024*6103515625e-14)}function K(e,t){const i=e.getUint16(t.value,!0);return t.value+=2,i}function W(e,t){return V(K(e,t))}function J(e,t,i,s,a){return"string"===s||"stringvector"===s||"iccProfile"===s?function(e,t,i){const s=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+i));return t.value=t.value+i,s}(t,i,a):"chlist"===s?function(e,t,i,s){const a=i.value,r=[];for(;i.value<a+s-1;){const s=z(t,i),a=U(e,i),n=O(e,i);i.value+=3;const o=U(e,i),l=U(e,i);r.push({name:s,pixelType:a,pLinear:n,xSampling:o,ySampling:l})}return i.value+=1,r}(e,t,i,a):"chromaticities"===s?function(e,t){return{redX:j(e,t),redY:j(e,t),greenX:j(e,t),greenY:j(e,t),blueX:j(e,t),blueY:j(e,t),whiteX:j(e,t),whiteY:j(e,t)}}(e,i):"compression"===s?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][O(e,t)]}(e,i):"box2i"===s?function(e,t){return{xMin:U(e,t),yMin:U(e,t),xMax:U(e,t),yMax:U(e,t)}}(e,i):"envmap"===s?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][O(e,t)]}(e,i):"tiledesc"===s?function(e,t){const i=N(e,t),s=N(e,t),a=O(e,t);return{xSize:i,ySize:s,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&a],roundingMode:["ROUND_DOWN","ROUND_UP"][a>>4]}}(e,i):"lineOrder"===s?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][O(e,t)]}(e,i):"float"===s?j(e,i):"v2f"===s?function(e,t){return[j(e,t),j(e,t)]}(e,i):"v3f"===s?function(e,t){return[j(e,t),j(e,t),j(e,t)]}(e,i):"int"===s?U(e,i):"rational"===s?function(e,t){return[U(e,t),N(e,t)]}(e,i):"timecode"===s?function(e,t){return[N(e,t),N(e,t)]}(e,i):"preview"===s?(i.value+=a,"skipped"):void(i.value+=a)}function X(e,t,i){let s=0;switch(e.levelMode){case"ONE_LEVEL":s=1;break;case"MIPMAP_LEVELS":s=function(e,t){const i=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(i):Math.ceil(i)}(Math.max(t,i),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return s}function Y(e,t,i,s){const a=new Array(e);for(let r=0;r<e;r++){const e=1<<r;let n=t/e|0;"ROUND_UP"==s&&n*e<t&&(n+=1);const o=Math.max(n,1);a[r]=(o+i-1)/i|0}return a}function Z(){const e=this,t=e.offset,i={value:0};for(let s=0;s<e.tileCount;s++){const s=U(e.viewer,t),a=U(e.viewer,t);t.value+=8,e.size=N(e.viewer,t);const r=s*e.blockWidth,n=a*e.blockHeight;e.columns=r+e.blockWidth>e.width?e.width-r:e.blockWidth,e.lines=n+e.blockHeight>e.height?e.height-n:e.blockHeight;const o=e.columns*e.totalBytes,l=e.size<e.lines*o?e.uncompress(e):D(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const s=t*e.columns*e.totalBytes;for(let a=0;a<e.inputChannels.length;a++){const o=se.channels[a].name,h=e.channelByteOffsets[o]*e.columns,c=e.decodeChannels[o];if(void 0===c)continue;i.value=s+h;const A=(e.height-(1+n+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const s=A+(t+r)*e.outputChannels+c;e.byteArray[s]=e.getter(l,i)}}}}}function $(){const e=this,t=e.offset,i={value:0};for(let s=0;s<e.height/e.blockHeight;s++){const a=U(e.viewer,t)-se.dataWindow.yMin;e.size=N(e.viewer,t),e.lines=a+e.blockHeight>e.height?e.height-a:e.blockHeight;const r=e.columns*e.totalBytes,n=e.size<e.lines*r?e.uncompress(e):D(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const a=s*e.blockHeight,o=t+e.scanOrder(a);if(o>=e.height)continue;const l=t*r,h=(e.height-1-o)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const s=se.channels[t].name,a=e.channelByteOffsets[s]*e.columns,r=e.decodeChannels[s];if(void 0!==r){i.value=l+a;for(let t=0;t<e.columns;t++){const s=h+t*e.outputChannels+r;e.byteArray[s]=e.getter(n,i)}}}}}}const ee={value:0},te=new DataView(e),ie=new Uint8Array(e),se=function(e,t,i){const s={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");s.version=e.getUint8(4);const a=e.getUint8(5);s.spec={singleTile:!!(2&a),longName:!!(4&a),deepFormat:!!(8&a),multiPart:!!(16&a)},i.value=8;let r=!0;for(;r;){const a=z(t,i);if(""===a)r=!1;else{const r=z(t,i),n=J(e,t,i,r,N(e,i));void 0===n?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${r}'.`):s[a]=n}}if(-7&a)throw console.error("THREE.EXRHeader:",s),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return s}(te,e,ee),ae=function(e,t,i,s,a){const r={size:0,viewer:t,array:i,offset:s,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:we};switch(e.compression){case"NO_COMPRESSION":r.blockHeight=1,r.uncompress=D;break;case"RLE_COMPRESSION":r.blockHeight=1,r.uncompress=T;break;case"ZIPS_COMPRESSION":r.blockHeight=1,r.uncompress=F;break;case"ZIP_COMPRESSION":r.blockHeight=16,r.uncompress=F;break;case"PIZ_COMPRESSION":r.blockHeight=32,r.uncompress=L;break;case"PXR24_COMPRESSION":r.blockHeight=16,r.uncompress=P;break;case"DWAA_COMPRESSION":r.blockHeight=32,r.uncompress=_;break;case"DWAB_COMPRESSION":r.blockHeight=256,r.uncompress=_;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const n={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":n[t.name]=!0,r.type=t.pixelType}let o=!1;if(n.R&&n.G&&n.B)o=!n.A,r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else{if(!n.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");r.outputChannels=1,r.decodeChannels={Y:0}}if(1==r.type)switch(a){case At:r.getter=W;break;case ct:r.getter=K}else{if(2!=r.type)throw new Error("EXRLoader.parse: unsupported pixelType "+r.type+" for "+e.compression+".");switch(a){case At:r.getter=j;break;case ct:r.getter=H}}r.columns=r.width;const l=r.width*r.height*r.outputChannels;switch(a){case At:r.byteArray=new Float32Array(l),o&&r.byteArray.fill(1,0,l);break;case ct:r.byteArray=new Uint16Array(l),o&&r.byteArray.fill(15360,0,l);break;default:console.error("THREE.EXRLoader: unsupported type: ",a)}let h=0;for(const t of e.channels)void 0!==r.decodeChannels[t.name]&&(r.channelByteOffsets[t.name]=h),h+=2*t.pixelType;if(r.totalBytes=h,r.outLineWidth=r.width*r.outputChannels,"INCREASING_Y"===e.lineOrder?r.scanOrder=e=>e:r.scanOrder=e=>r.height-1-e,4==r.outputChannels?(r.format=dt,r.colorSpace=we):(r.format=pt,r.colorSpace=gt),e.spec.singleTile){r.blockHeight=e.tiles.ySize,r.blockWidth=e.tiles.xSize;const i=X(e.tiles,r.width,r.height),a=Y(i,r.width,e.tiles.xSize,e.tiles.roundingMode),n=Y(i,r.height,e.tiles.ySize,e.tiles.roundingMode);r.tileCount=a[0]*n[0];for(let e=0;e<i;e++)for(let i=0;i<n[e];i++)for(let i=0;i<a[e];i++)q(t,s);r.decode=Z.bind(r)}else{r.blockWidth=r.width;const e=Math.ceil(r.height/r.blockHeight);for(let i=0;i<e;i++)q(t,s);r.decode=$.bind(r)}return r}(se,te,ie,ee,this.type);return ae.decode(),{header:se,width:ae.width,height:ae.height,data:ae.byteArray,format:ae.format,colorSpace:ae.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,s){return super.load(e,(function(e,i){e.colorSpace=i.colorSpace,e.minFilter=De,e.magFilter=De,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,i)}),i,s)}};const Yr=Array(1024).fill(0).map(((e,t)=>Math.pow(t/255*.9478672986+.0521327014,2.4)));class Zr extends ne{constructor(e){super(e),this.type=ct}setDataType(e){return this.type=e,this}parse(e,t){const i={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},s=new TextDecoder,a=new DataView(e);let r=0;const n=[];for(;r<a.byteLength;){const e=a.getUint8(r);if(255===e){const t=a.getUint8(r+1);[216,224,225,226].includes(t)?(n.push({sectionType:t,section:[e,t],sectionOffset:r+2}),r+=2):(n[n.length-1].section.push(e,t),r+=2)}else n[n.length-1].section.push(e),r++}let o,l;for(let e=0;e<n.length;e++){const{sectionType:t,section:r,sectionOffset:h}=n[e];if(224===t);else if(225===t)this._parseXMPMetadata(s.decode(new Uint8Array(r)),i);else if(226===t){const e=new DataView(new Uint8Array(r.slice(2)).buffer);if(1297106432===e.getUint32(2,!1)){const t=1229531648===e.getUint32(6),i=60,s=e.getUint32(i,t),r=e.getUint32(i+4,t),n=e.getUint32(i+16,t),c=e.getUint32(i+20,t)+h+6;o=new Uint8Array(a.buffer,r,s),l=new Uint8Array(a.buffer,c,n)}}}if(!i.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(!o||!l)throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images");this._applyGainmapToSDR(i,o,l,((e,i,s)=>{t({width:i,height:s,data:e,format:dt,type:this.type})}),(e=>{throw new Error(e)}))}load(e,t,i,s){const a=new mt(this.type===ct?new Uint16Array:new Float32Array,0,0,dt,this.type,ft,Le,Le,De,bt,1,we);a.generateMipmaps=!0,a.flipY=!0;const r=new oe(this.manager);return r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setPath(this.path),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{try{this.parse(e,(e=>{a.image={data:e.data,width:e.width,height:e.height},a.needsUpdate=!0,t&&t(a,e)}))}catch(e){s&&s(e),console.error(e)}}),i,s),a}_parseXMPMetadata(e,t){const i=(new DOMParser).parseFromString(e.substring(e.indexOf("<"),e.lastIndexOf(">")+1),"text/xml"),[s]=i.getElementsByTagName("Container:Directory");if(s);else{const[e]=i.getElementsByTagName("rdf:Description");t.version=e.getAttribute("hdrgm:Version"),t.baseRenditionIsHDR="True"===e.getAttribute("hdrgm:BaseRenditionIsHDR"),t.gainMapMin=parseFloat(e.getAttribute("hdrgm:GainMapMin")||0),t.gainMapMax=parseFloat(e.getAttribute("hdrgm:GainMapMax")||1),t.gamma=parseFloat(e.getAttribute("hdrgm:Gamma")||1),t.offsetSDR=parseFloat(e.getAttribute("hdrgm:OffsetSDR")/(1/64)),t.offsetHDR=parseFloat(e.getAttribute("hdrgm:OffsetHDR")/(1/64)),t.hdrCapacityMin=parseFloat(e.getAttribute("hdrgm:HDRCapacityMin")||0),t.hdrCapacityMax=parseFloat(e.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(e){return e/255<.04045?e/255*.0773993808:e<1024?Yr[~~e]:Math.pow(e/255*.9478672986+.0521327014,2.4)}_applyGainmapToSDR(e,t,i,s,a){const r=e=>new Promise(((t,i)=>{const s=document.createElement("img");s.onload=()=>{const e={width:s.naturalWidth,height:s.naturalHeight,source:s};URL.revokeObjectURL(s.src),t(e)},s.onerror=()=>{URL.revokeObjectURL(s.src),i()},s.src=URL.createObjectURL(new Blob([e],{type:"image/jpeg"}))}));Promise.all([r(t),r(i)]).then((([t,i])=>{if(t.width/t.height!==i.width/i.height)return void a("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");const r=document.createElement("canvas"),n=r.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});r.width=t.width,r.height=t.height,n.drawImage(i.source,0,0,i.width,i.height,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});n.drawImage(t.source,0,0);const l=n.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});let h;h=this.type===ct?new Uint16Array(l.data.length).fill(23544):new Float32Array(l.data.length).fill(255);const c=Math.sqrt(Math.pow(1.8,e.hdrCapacityMax)),A=(Math.log2(c)-e.hdrCapacityMin)/(e.hdrCapacityMax-e.hdrCapacityMin),u=Math.min(Math.max(A,0),1),d=1===e.gamma;for(let i=0;i<l.data.length;i+=4){const s=i/4%t.width,a=Math.floor(i/4/t.width);for(let r=0;r<3;r++){const n=l.data[i+r],c=4*(a*t.width+s)+r,A=o.data[c]/255,p=d?A:Math.pow(A,1/e.gamma),g=e.gainMapMin*(1-p)+e.gainMapMax*p,m=(n+e.offsetSDR)*(g*u===0?1:Math.pow(2,g*u))-e.offsetHDR,f=Math.min(Math.max(this._srgbToLinear(m),0),65504);h[i+r]=this.type===ct?ut.toHalfFloat(f):f}}s(h,t.width,t.height)})).catch((()=>{throw new Error("THREE.UltraHDRLoader Error: Could not parse UltraHDR images")}))}}var $r=function(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var i,s=WebAssembly.validate(e)?r("b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q:6dkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;G9Mqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk:183lYud97dur978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxavaialfgmar9Rgoad;8qbbcj;abad9Uc;WFbGcjdadca0EhPdndndnadTmbaoadfhscbhzinaeaz9nmdamax9RaD6miabazad2fhHaxaDfhOaPaeaz9RazaPfae6EgAcsfgocl4cifcd4hCavcj;cbfaoc9WGgXcetfhQavcj;cbfaXci2fhLavcj;cbfaXfhKcbhYaoc;ab6h8AincbhodnawTmbaxaYcd4fRbbhokaocFeGhEcbh3avcj;cbfh5indndndndnaEa3cet4ciGgoc9:fPdebdkamaO9RaX6mwavcj;cbfa3aX2faOaX;8qbbaOaAfhOxdkavcj;cbfa3aX2fcbaX;8kbxekamaO9RaC6moaoclVcbawEhraOaCfhocbhidna8Ambamao9Rc;Gb6mbcbhlina5alfhidndndndndndnaOalco4fRbbgqciGarfPDbedibledibkaipxbbbbbbbbbbbbbbbbpklbxlkaiaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiaopbbbpklbaoczfhoxekaiaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcd4ciGarfPDbedibledibkaiczfpxbbbbbbbbbbbbbbbbpklbxlkaiczfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiczfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiczfaopbbbpklbaoczfhoxekaiczfaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcl4ciGarfPDbedibledibkaicafpxbbbbbbbbbbbbbbbbpklbxlkaicafaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaicafaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaicafaopbbbpklbaoczfhoxekaicafaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqco4arfPDbedibledibkaic8Wfpxbbbbbbbbbbbbbbbbpklbxlkaic8Wfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaoclffaqc:q:yjjbfRbbfhoxikaic8Wfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaocwffaqc:q:yjjbfRbbfhoxdkaic8Wfaopbbbpklbaoczfhoxekaic8WfaopbbdaoRbbgicitc:q1jjbfpbibaic:q:yjjbfRbbgipsaoRbegqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaiaocdffaqc:q:yjjbfRbbfhokalc;abfhialcjefaX0meaihlamao9Rc;Fb0mbkkdnaiaX9pmbaici4hlinamao9RcK6mwa5aifhqdndndndndndnaOaico4fRbbalcoG4ciGarfPDbedibledibkaqpxbbbbbbbbbbbbbbbbpkbbxlkaqaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaoclffahc:q:yjjbfRbbfhoxikaqaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaocwffahc:q:yjjbfRbbfhoxdkaqaopbbbpkbbaoczfhoxekaqaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpkbbaaaocdffahc:q:yjjbfRbbfhokalcdfhlaiczfgiaX6mbkkaohOaoTmoka5aXfh5a3cefg3cl9hmbkdndndndnawTmbasaYcd4fRbbglciGPlbedwbkaXTmdavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep9Ta8Epxeeeeeeeeeeeeeeeeg8Fp9op9Hp9rg8Eagp9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Ug8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9AbbbaladfhlaoczfgoaX6mbxikkaXTmeavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep:nea8Epxebebebebebebebebg8Fp9op:bep9rg8Eagp:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeg8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9AbbbaladfhlaoczfgoaX6mbxdkkaXTmbcbhocbalcl4gl9Rc8FGhiavcjdfaYfhravaYfpbdbh8Finaravcj;cbfaofpblbggaKaofpblbg8JpmbzeHdOiAlCvXoQrLg8KaQaofpblbg8LaLaofpblbg8MpmbzeHdOiAlCvXoQrLg8NpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ea8Fp9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Fa8Ka8NpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwKDYq8AkEx3m5P8Es8Fgga8La8MpmwKDYq8AkEx3m5P8Es8Fg8JpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9AbbbaradfhraoczfgoaX6mbkkaYclfgYad6mbkaHavcjdfaAad2;8qbbavavcjdfaAcufad2fad;8qbbaAazfhzc9:hoaOhxaOmbxlkkaeTmbaDalfhrcbhocuhlinaralaD9RglfaD6mdaPaeao9RaoaPfae6Eaofgoae6mbkaial9Rhxkcbc99amax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaokwbz:bjjjbk:TseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:SPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalaeSmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oaoarpmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalaeSmbaiczfpxbbbbbbbbbbbbbbbbgopklbaiaopklbaiabalcitfgdaeciGglcitgv;8qbbdnalTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oaoarpmbezHdiOAlvCXorQLp9qpklbkadaiav;8qbbkk:oDllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalaeSmbaiczfpxbbbbbbbbbbbbbbbbgkpklbaiakpklbaiabalcitfgoaeciGgvcitgw;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkaoaiaw;8qbbkk;uddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnavalSmbaic8WfpxbbbbbbbbbbbbbbbbgopklbaicafaopklbaiczfaopklbaiaopklbaiabavcdtfgdalciGgecdtgv;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkadaiav;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz:Dbb"):r("b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:W:Odkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:S86qdbk;jYi5ud9:du8Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxcj;abad9Uc;WFbGcjdadca0EhmaialfgPar9Rgoadfhsavaoadz1jjjbgzceVhHcbhOdndninaeaO9nmeaPax9RaD6mdamaeaO9RaOamfgoae6EgAcsfglc9WGhCabaOad2fhXaAcethQaxaDfhiaOaeaoaeao6E9RhLalcl4cifcd4hKazcj;cbfaAfhYcbh8AazcjdfhEaHh3incbhodnawTmbaxa8Acd4fRbbhokaocFeGh5cbh8Eazcj;cbfhqinaih8Fdndndndna5a8Ecet4ciGgoc9:fPdebdkaPa8F9RaA6mrazcj;cbfa8EaA2fa8FaAz1jjjb8Aa8FaAfhixdkazcj;cbfa8EaA2fcbaAz:jjjjb8Aa8FhixekaPa8F9RaK6mva8FaKfhidnaCTmbaPai9RcK6mbaocdtc:q1jjbfcj1jjbawEhaczhrcbhlinargoc9Wfghaqfhrdndndndndndnaaa8Fahco4fRbbalcoG4ciGcdtfydbPDbedvivvvlvkar9cb83bbarcwf9cb83bbxlkarcbaiRbdai8Xbb9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbaqaofgrcGfag9c8F1:NghcKtc8F91aicdfa8J9c8N1:Nfg8KRbbG86bbarcVfcba8KahcjeGcr4fghRbbag9cjjjjjl:dg8J9qE86bbarc7fcbaha8J9c8L1:NfghRbbag9cjjjjjd:dg8J9qE86bbarctfcbaha8J9c8K1:NfghRbbag9cjjjjje:dg8J9qE86bbarc91fcbaha8J9c8J1:NfghRbbag9cjjjj;ab:dg8J9qE86bbarc4fcbaha8J9cg1:NfghRbbag9cjjjja:dg8J9qE86bbarc93fcbaha8J9ch1:NfghRbbag9cjjjjz:dgg9qE86bbarc94fcbahag9ca1:NfghRbbai8Xbe9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbarc95fag9c8F1:NgicKtc8F91aha8J9c8N1:NfghRbbG86bbarc96fcbahaicjeGcr4fgiRbbag9cjjjjjl:dg8J9qE86bbarc97fcbaia8J9c8L1:NfgiRbbag9cjjjjjd:dg8J9qE86bbarc98fcbaia8J9c8K1:NfgiRbbag9cjjjjje:dg8J9qE86bbarc99fcbaia8J9c8J1:NfgiRbbag9cjjjj;ab:dg8J9qE86bbarc9:fcbaia8J9cg1:NfgiRbbag9cjjjja:dg8J9qE86bbarcufcbaia8J9ch1:NfgiRbbag9cjjjjz:dgg9qE86bbaiag9ca1:NfhixikaraiRblaiRbbghco4g8Ka8KciSg8KE86bbaqaofgrcGfaiclfa8Kfg8KRbbahcl4ciGg8La8LciSg8LE86bbarcVfa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc7fa8Ka8Lfg8KRbbahciGghahciSghE86bbarctfa8Kahfg8KRbbaiRbeghco4g8La8LciSg8LE86bbarc91fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc4fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc93fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc94fa8Kahfg8KRbbaiRbdghco4g8La8LciSg8LE86bbarc95fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc96fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc97fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc98fa8KahfghRbbaiRbigico4g8Ka8KciSg8KE86bbarc99faha8KfghRbbaicl4ciGg8Ka8KciSg8KE86bbarc9:faha8KfghRbbaicd4ciGg8Ka8KciSg8KE86bbarcufaha8KfgrRbbaiciGgiaiciSgiE86bbaraifhixdkaraiRbwaiRbbghcl4g8Ka8KcsSg8KE86bbaqaofgrcGfaicwfa8Kfg8KRbbahcsGghahcsSghE86bbarcVfa8KahfghRbbaiRbeg8Kcl4g8La8LcsSg8LE86bbarc7faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarctfaha8KfghRbbaiRbdg8Kcl4g8La8LcsSg8LE86bbarc91faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc4faha8KfghRbbaiRbig8Kcl4g8La8LcsSg8LE86bbarc93faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc94faha8KfghRbbaiRblg8Kcl4g8La8LcsSg8LE86bbarc95faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc96faha8KfghRbbaiRbvg8Kcl4g8La8LcsSg8LE86bbarc97faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc98faha8KfghRbbaiRbog8Kcl4g8La8LcsSg8LE86bbarc99faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc9:faha8KfghRbbaiRbrgicl4g8Ka8KcsSg8KE86bbarcufaha8KfgrRbbaicsGgiaicsSgiE86bbaraifhixekarai8Pbb83bbarcwfaicwf8Pbb83bbaiczfhikdnaoaC9pmbalcdfhlaoczfhraPai9RcL0mekkaoaC6moaimexokaCmva8FTmvkaqaAfhqa8Ecefg8Ecl9hmbkdndndndnawTmbasa8Acd4fRbbgociGPlbedrbkaATmdaza8Afh8Fazcj;cbfhhcbh8EaEhaina8FRbbhraahocbhlinaoahalfRbbgqce4cbaqceG9R7arfgr86bbaoadfhoaAalcefgl9hmbkaacefhaa8Fcefh8FahaAfhha8Ecefg8Ecl9hmbxikkaATmeaza8Afhaazcj;cbfhhcbhoceh8EaYh8FinaEaofhlaa8Vbbhrcbhoinala8FaofRbbcwtahaofRbbgqVc;:FiGce4cbaqceG9R7arfgr87bbaladfhlaLaocefgofmbka8FaQfh8FcdhoaacdfhaahaQfhha8EceGhlcbh8EalmbxdkkaATmbcbaocl49Rh8Eaza8AfRbbhqcwhoa3hlinalRbbaotaqVhqalcefhlaocwfgoca9hmbkcbhhaEh8FaYhainazcj;cbfahfRbbhrcwhoaahlinalRbbaotarVhralaAfhlaocwfgoca9hmbkara8E93aq7hqcbhoa8Fhlinalaqao486bbalcefhlaocwfgoca9hmbka8Fadfh8FaacefhaahcefghaA9hmbkkaEclfhEa3clfh3a8Aclfg8Aad6mbkaXazcjdfaAad2z1jjjb8AazazcjdfaAcufad2fadz1jjjb8AaAaOfhOaihxaimbkc9:hoxdkcbc99aPax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaok:XseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;oiliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavciGfgkcd7cetfaD87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavcufciGfcetfaD87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohvxekcjjjj94hvkabakcetfav87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbyd:K1jjbgeabcifc98GfgbBd:K1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;teeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiaeydlBdlaiaeydwBdwaiaeydxBdxaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk:3eedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdxaialBdwaialBdlaialBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkk81dbcjwk8Kbbbbdbbblbbbwbbbbbbbebbbdbbblbbbwbbbbc:Kwkl8WNbb"),a=WebAssembly.instantiate(s,{}).then((function(e){(i=e.instance).exports.__wasm_call_ctors()}));function r(e){for(var i=new Uint8Array(e.length),s=0;s<e.length;++s){var a=e.charCodeAt(s);i[s]=a>96?a-97:a>64?a-39:a+4}var r=0;for(s=0;s<e.length;++s)i[r++]=i[s]<60?t[i[s]]:64*(i[s]-60)+i[++s];return i.buffer.slice(0,r)}function n(e,t,i,s,a,r,n){var o=e.exports.sbrk,l=s+3&-4,h=o(l*a),c=o(r.length),A=new Uint8Array(e.exports.memory.buffer);A.set(r,c);var u=t(h,s,a,c,r.length);if(0==u&&n&&n(h,l,a),i.set(A.subarray(h,h+s*a)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function A(e){var t={object:new Worker(e),pending:0,requests:{}};return t.object.onmessage=function(e){var i=e.data;t.pending-=i.count,t.requests[i.id][i.action](i.value),delete t.requests[i.id]},t}function u(e){var t=e.data;if(!t.id)return self.close();self.ready.then((function(e){try{var i=new Uint8Array(t.count*t.size);n(e,e.exports[t.mode],i,t.count,t.size,t.source,e.exports[t.filter]),self.postMessage({id:t.id,count:t.count,action:"resolve",value:i},[i.buffer])}catch(e){self.postMessage({id:t.id,count:t.count,action:"reject",value:e})}}))}return{ready:a,supported:!0,useWorkers:function(e){!function(e){for(var t="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(s)+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+u.name+";"+n.toString()+u.toString(),i=new Blob([t],{type:"text/javascript"}),a=URL.createObjectURL(i),r=h.length;r<e;++r)h[r]=A(a);for(r=e;r<h.length;++r)h[r].object.postMessage({});h.length=e,URL.revokeObjectURL(a)}(e)},decodeVertexBuffer:function(e,t,s,a,r){n(i,i.exports.meshopt_decodeVertexBuffer,e,t,s,a,i.exports[o[r]])},decodeIndexBuffer:function(e,t,s,a){n(i,i.exports.meshopt_decodeIndexBuffer,e,t,s,a)},decodeIndexSequence:function(e,t,s,a){n(i,i.exports.meshopt_decodeIndexSequence,e,t,s,a)},decodeGltfBuffer:function(e,t,s,a,r,h){n(i,i.exports[l[r]],e,t,s,a,i.exports[o[h]])},decodeGltfBufferAsync:function(e,t,s,r,A){return h.length>0?function(e,t,i,s,a){for(var r=h[0],n=1;n<h.length;++n)h[n].pending<r.pending&&(r=h[n]);return new Promise((function(n,o){var l=new Uint8Array(i),h=++c;r.pending+=e,r.requests[h]={resolve:n,reject:o},r.object.postMessage({id:h,count:e,size:t,source:l,mode:s,filter:a},[l.buffer])}))}(e,t,s,l[r],o[A]):a.then((function(){var a=new Uint8Array(e*t);return n(i,i.exports[l[r]],a,e,t,s,i.exports[o[A]]),a}))}}}();const en=new WeakMap;class tn extends ne{constructor(e){super(e),this.useLocal=!1,this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setUseLocal(e){return this.useLocal=e,this}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,s){const a=new oe(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),console.log(this.withCredentials,this.requestHeader,this.path),a.load(e,(e=>{this.parse(e,t,s)}),i,s)}parse(e,t,i){this.decodeDracoFile(e,t,null,null,u).catch(i)}decodeDracoFile(e,t,i,s,a=we){const r={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:a};return this.decodeGeometry(e,r).then(t)}decodeGeometry(e,t){const i=JSON.stringify(t);if(en.has(e)){const t=en.get(e);if(t.key===i)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const a=this.workerNextTaskID++,r=e.byteLength,n=this._getWorker(a,r).then((i=>(s=i,new Promise(((i,r)=>{s._callbacks[a]={resolve:i,reject:r},s.postMessage({type:"decode",id:a,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return n.catch((()=>!0)).then((()=>{s&&a&&this._releaseTask(s,a)})),en.set(e,{key:i,promise:n}),n}_createGeometry(e){const s=new t;e.index&&s.setIndex(new i(e.index.array,1));for(let t=0;t<e.attributes.length;t++){const a=e.attributes[t],r=a.name,n=a.array,o=a.itemSize,l=new i(n,o);"color"===r&&(this._assignVertexColorSpace(l,a.vertexColorSpace),l.normalized=n instanceof Float32Array==!1),s.setAttribute(r,l)}return s}_assignVertexColorSpace(e,t){if(t!==u)return;const i=new p;for(let t=0,s=e.count;t<s;t++)i.fromBufferAttribute(e,t).convertSRGBToLinear(),e.setXYZ(t,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new oe(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise(((t,s)=>{i.load(e,t,void 0,s)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?this.useLocal?(this.decoderPath="",e.push(this._loadLibrary(new URL("../build/draco/draco_decoder.js",import.meta.url),"text"))):e.push(this._loadLibrary("draco_decoder.js","text")):this.useLocal?(this.decoderPath="",e.push(this._loadLibrary(new URL("../build/draco/draco_wasm_wrapper.js",import.meta.url),"text"))):e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(e).then((e=>{const t=e[0],i=sn.toString(),s=["/* draco decoder */",t,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const i=t.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function sn(){let e,t;function i(e,t,i,s,a,r){const n=r.num_components(),o=i.num_points()*n,l=o*a.BYTES_PER_ELEMENT,h=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(i,r,h,l,c);const A=new a(e.HEAPF32.buffer,c,o).slice();return e._free(c),{name:s,array:A,itemSize:n}}onmessage=function(s){const a=s.data;switch(a.type){case"init":e=a.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const s=a.buffer,r=a.taskConfig;t.then((e=>{const t=e.draco,n=new t.Decoder;try{const e=function(e,t,s,a){const r=a.attributeIDs,n=a.attributeTypes;let o,l;const h=t.GetEncodedGeometryType(s);if(h===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeArrayToMesh(s,s.byteLength,o);else{if(h!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeArrayToPointCloud(s,s.byteLength,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const s in r){const l=self[n[s]];let h,A;if(a.useUniqueIDs)A=r[s],h=t.GetAttributeByUniqueId(o,A);else{if(A=t.GetAttributeId(o,e[r[s]]),-1===A)continue;h=t.GetAttribute(o,A)}const u=i(e,t,o,s,l,h);"color"===s&&(u.vertexColorSpace=a.vertexColorSpace),c.attributes.push(u)}h===e.TRIANGULAR_MESH&&(c.index=function(e,t,i){const s=i.num_faces(),a=3*s,r=4*a,n=e._malloc(r);t.GetTrianglesUInt32Array(i,r,n);const o=new Uint32Array(e.HEAPF32.buffer,n,a).slice();return e._free(n),{array:o,itemSize:1}}(e,t,o));return e.destroy(o),c}(t,n,new Int8Array(s),r),o=e.attributes.map((e=>e.array.buffer));e.index&&o.push(e.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:e},o)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{t.destroy(n)}}))}}}class an{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0,this.workerCreator=null}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:t,msg:i,transfer:s}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(i,s)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((i=>{const s=this._getIdleWorker();-1!==s?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const rn=9,nn=15,on=16,ln=22,hn=37,cn=43,An=76,un=83,dn=97,pn=100,gn=103,mn=109,fn=131,bn=132,yn=133,wn=134,In=137,En=138,Cn=141,vn=142,Bn=145,xn=146,kn=148,Qn=152,Sn=157,Mn=158,Rn=165,Dn=166,Tn=1000066e3;class Fn{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Ln{constructor(e,t,i,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){void 0===t&&(t=0);const i=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,s)}}const Pn=[171,75,84,88,32,50,48,187,13,10,26,10];function _n(e){return(new TextDecoder).decode(e)}let zn,Un,Nn;const Gn={env:{emscripten_notify_memory_growth:function(e){Nn=new Uint8Array(Un.exports.memory.buffer)}}};let On=class{init(){return zn||(zn="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+qn).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,Gn))).then(this._init):WebAssembly.instantiate(Buffer.from(qn,"base64"),Gn).then(this._init),zn)}_init(e){Un=e.instance,Gn.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Un)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,s=Un.exports.malloc(i);Nn.set(e,s),t=t||Number(Un.exports.ZSTD_findDecompressedSize(s,i));const a=Un.exports.malloc(t),r=Un.exports.ZSTD_decompress(a,t,s,i),n=Nn.slice(a,a+r);return Un.exports.free(s),Un.exports.free(a),n}};const qn="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQh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ASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdB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IAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEE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",jn=new WeakMap;let Hn,Vn=0,Kn=class e extends ne{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new an,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const t=new oe(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const i=t.loadAsync("basis_transcoder.js"),s=new oe(this.manager);s.setPath(this.transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const a=s.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([i,a]).then((([t,i])=>{const s=e.BasisWorker.toString(),a=["/* constants */","let _EngineFormat = "+JSON.stringify(e.EngineFormat),"let _EngineType = "+JSON.stringify(e.EngineType),"let _TranscoderFormat = "+JSON.stringify(e.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(e.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a])),this.transcoderBinary=i,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),Vn>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Vn++}return this.transcoderPending}load(e,t,i,s){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const a=new oe(this.manager);a.setPath(this.path),a.setCrossOrigin(this.crossOrigin),a.setWithCredentials(this.withCredentials),a.setResponseType("arraybuffer"),a.load(e,(e=>{this.parse(e,t,s)}),i,s)}parse(e,t,i){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(jn.has(e)){return jn.get(e).promise.then(t).catch(i)}this._createTexture(e).then((e=>t?t(e):null)).catch(i)}_createTextureFrom(e,t){const{type:i,error:s,data:{faces:a,width:r,height:n,format:o,type:l,dfdFlags:h}}=e;if("error"===i)return Promise.reject(s);let c;if(6===t.faceCount)c=new Mt(a,o,l);else{const e=a[0].mipmaps;c=t.layerCount>1?new Rt(e,r,n,t.layerCount,o,l):new Dt(e,r,n,o,l)}return c.minFilter=1===a[0].mipmaps.length?De:Qe,c.magFilter=De,c.generateMipmaps=!1,c.needsUpdate=!0,c.colorSpace=Yn(t),c.premultiplyAlpha=!!(1&h),c}async _createTexture(e,t={}){const i=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,Pn.length);if(t[0]!==Pn[0]||t[1]!==Pn[1]||t[2]!==Pn[2]||t[3]!==Pn[3]||t[4]!==Pn[4]||t[5]!==Pn[5]||t[6]!==Pn[6]||t[7]!==Pn[7]||t[8]!==Pn[8]||t[9]!==Pn[9]||t[10]!==Pn[10]||t[11]!==Pn[11])throw new Error("Missing KTX 2.0 identifier.");const i=new Fn,s=17*Uint32Array.BYTES_PER_ELEMENT,a=new Ln(e,Pn.length,s,!0);i.vkFormat=a._nextUint32(),i.typeSize=a._nextUint32(),i.pixelWidth=a._nextUint32(),i.pixelHeight=a._nextUint32(),i.pixelDepth=a._nextUint32(),i.layerCount=a._nextUint32(),i.faceCount=a._nextUint32();const r=a._nextUint32();i.supercompressionScheme=a._nextUint32();const n=a._nextUint32(),o=a._nextUint32(),l=a._nextUint32(),h=a._nextUint32(),c=a._nextUint64(),A=a._nextUint64(),u=new Ln(e,Pn.length+s,3*r*8,!0);for(let t=0;t<r;t++)i.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+u._nextUint64(),u._nextUint64()),uncompressedByteLength:u._nextUint64()});const d=new Ln(e,n,o,!0),p={vendorId:d._skip(4)._nextUint16(),descriptorType:d._nextUint16(),versionNumber:d._nextUint16(),descriptorBlockSize:d._nextUint16(),colorModel:d._nextUint8(),colorPrimaries:d._nextUint8(),transferFunction:d._nextUint8(),flags:d._nextUint8(),texelBlockDimension:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],bytesPlane:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],samples:[]},g=(p.descriptorBlockSize/4-6)/4;for(let e=0;e<g;e++){const t={bitOffset:d._nextUint16(),bitLength:d._nextUint8(),channelType:d._nextUint8(),samplePosition:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=d._nextInt32(),t.sampleUpper=d._nextInt32()):(t.sampleLower=d._nextUint32(),t.sampleUpper=d._nextUint32()),p.samples[e]=t}i.dataFormatDescriptor.length=0,i.dataFormatDescriptor.push(p);const m=new Ln(e,l,h,!0);for(;m._offset<h;){const e=m._nextUint32(),t=m._scan(e),s=_n(t);if(i.keyValue[s]=m._nextUint8Array(e-t.byteLength-1),s.match(/^ktx/i)){const e=_n(i.keyValue[s]);i.keyValue[s]=e.substring(0,e.lastIndexOf("\0"))}m._skip(e%4?4-e%4:0)}if(A<=0)return i;const f=new Ln(e,c,A,!0),b=f._nextUint16(),y=f._nextUint16(),w=f._nextUint32(),I=f._nextUint32(),E=f._nextUint32(),C=f._nextUint32(),v=[];for(let e=0;e<r;e++)v.push({imageFlags:f._nextUint32(),rgbSliceByteOffset:f._nextUint32(),rgbSliceByteLength:f._nextUint32(),alphaSliceByteOffset:f._nextUint32(),alphaSliceByteLength:f._nextUint32()});const B=c+f._offset,x=B+w,k=x+I,Q=k+E,S=new Uint8Array(e.buffer,e.byteOffset+B,w),M=new Uint8Array(e.buffer,e.byteOffset+x,I),R=new Uint8Array(e.buffer,e.byteOffset+k,E),D=new Uint8Array(e.buffer,e.byteOffset+Q,C);return i.globalData={endpointCount:b,selectorCount:y,imageDescs:v,endpointsData:S,selectorsData:M,tablesData:R,extendedData:D},i}(new Uint8Array(e)),s=i.vkFormat===Tn&&167===i.dataFormatDescriptor[0].colorModel;if(!(0===i.vkFormat||s&&!this.workerConfig.astcHDRSupported))return async function(e){const{vkFormat:t}=e;if(void 0===Jn[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let i;2===e.supercompressionScheme&&(Hn||(Hn=new Promise((async e=>{const t=new On;await t.init(),e(t)}))),i=await Hn);const s=[];for(let a=0;a<e.levels.length;a++){const r=Math.max(1,e.pixelWidth>>a),n=Math.max(1,e.pixelHeight>>a),o=e.pixelDepth?Math.max(1,e.pixelDepth>>a):0,l=e.levels[a];let h,c;if(0===e.supercompressionScheme)h=l.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");h=i.decode(l.levelData,l.uncompressedByteLength)}c=Xn[t]===At?new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):Xn[t]===ct?new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):h,s.push({data:c,width:r,height:n,depth:o})}let a;if(Wn.has(Jn[t]))a=0===e.pixelDepth?new mt(s[0].data,e.pixelWidth,e.pixelHeight):new _t(s[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");a=new Dt(s,e.pixelWidth,e.pixelHeight),a.minFilter=1===s.length?De:Qe,a.magFilter=De}return a.mipmaps=s,a.type=Xn[t],a.format=Jn[t],a.colorSpace=Yn(e),a.needsUpdate=!0,Promise.resolve(a)}(i);const a=t,r=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:a},[e]))).then((e=>this._createTextureFrom(e.data,i)));return jn.set(e,{promise:r}),r}dispose(){this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Vn--}};Kn.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},Kn.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},Kn.EngineFormat={RGBAFormat:dt,RGBA_ASTC_4x4_Format:Qt,RGB_BPTC_UNSIGNED_Format:kt,RGBA_BPTC_Format:xt,RGBA_ETC2_EAC_Format:Bt,RGBA_PVRTC_4BPPV1_Format:vt,RGBA_S3TC_DXT5_Format:Ct,RGB_ETC1_Format:Et,RGB_ETC2_Format:It,RGB_PVRTC_4BPPV1_Format:wt,RGBA_S3TC_DXT1_Format:yt},Kn.EngineType={UnsignedByteType:St,HalfFloatType:ct,FloatType:At},Kn.BasisWorker=function(){let e,t,i;const s=_EngineFormat,a=_EngineType,r=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",(function(s){const r=s.data;switch(r.type){case"init":e=r.config,o=r.transcoderBinary,t=new Promise((e=>{i={wasmBinary:o,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis(),void 0===i.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:s,width:o,height:A,hasAlpha:u,format:d,type:p,dfdFlags:g}=function(t){const s=new i.KTX2File(new Uint8Array(t));function r(){s.close(),s.delete()}if(!s.isValid())throw r(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");let o;if(s.isUASTC())o=n.UASTC;else if(s.isETC1S())o=n.ETC1S;else{if(!s.isHDR())throw new Error("THREE.KTX2Loader: Unknown Basis encoding");o=n.UASTC_HDR}const A=s.getWidth(),u=s.getHeight(),d=s.getLayers()||1,p=s.getLevels(),g=s.getFaces(),m=s.getHasAlpha(),f=s.getDFDFlags(),{transcoderFormat:b,engineFormat:y,engineType:w}=function(t,i,s,a){const r=l[t];for(let n=0;n<r.length;n++){const o=r[n];if(o.if&&!e[o.if])continue;if(!o.basisFormat.includes(t))continue;if(a&&o.transcoderFormat.length<2)continue;if(o.needsPowerOfTwo&&(!h(i)||!h(s)))continue;return{transcoderFormat:o.transcoderFormat[a?1:0],engineFormat:o.engineFormat[a?1:0],engineType:o.engineType[0]}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}(o,A,u,m);if(!A||!u||!p)throw r(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!s.startTranscoding())throw r(),new Error("THREE.KTX2Loader: .startTranscoding failed");const I=[],E=[];for(let e=0;e<g;e++){const t=[];for(let i=0;i<p;i++){const n=[];let o,l;for(let t=0;t<d;t++){const h=s.getImageLevelInfo(i,t,e);0!==e||0!==i||0!==t||h.origWidth%4==0&&h.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),p>1?(o=h.origWidth,l=h.origHeight):(o=h.width,l=h.height);let c=new Uint8Array(s.getImageTranscodedSizeInBytes(i,t,0,b));const A=s.transcodeImage(c,i,t,e,b,0,-1,-1);if(w===a.HalfFloatType&&(c=new Uint16Array(c.buffer,c.byteOffset,c.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!A)throw r(),new Error("THREE.KTX2Loader: .transcodeImage failed.");n.push(c)}const h=c(n);t.push({data:h,width:o,height:l}),E.push(h.buffer)}I.push({mipmaps:t,width:A,height:u,format:y,type:w})}return r(),{faces:I,buffers:E,width:A,height:u,hasAlpha:m,dfdFlags:f,format:y,type:w}}(r.buffer);self.postMessage({type:"transcode",id:r.id,data:{faces:t,width:o,height:A,hasAlpha:u,format:d,type:p,dfdFlags:g}},s)}catch(e){console.error(e),self.postMessage({type:"error",id:r.id,error:e.message})}}))}var o}));const o=[{if:"astcSupported",basisFormat:[n.UASTC],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],engineType:[a.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],engineType:[a.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.BC1,r.BC3],engineFormat:[s.RGBA_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],engineType:[a.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],engineType:[a.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.ETC1],engineFormat:[s.RGB_ETC1_Format],engineType:[a.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],engineType:[a.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[n.UASTC_HDR],transcoderFormat:[r.BC6H],engineFormat:[s.RGB_BPTC_UNSIGNED_Format],engineType:[a.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[r.RGBA32,r.RGBA32],engineFormat:[s.RGBAFormat,s.RGBAFormat],engineType:[a.UnsignedByteType,a.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[n.UASTC_HDR],transcoderFormat:[r.RGBA_HALF],engineFormat:[s.RGBAFormat],engineType:[a.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],l={[n.ETC1S]:o.filter((e=>e.basisFormat.includes(n.ETC1S))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[n.UASTC]:o.filter((e=>e.basisFormat.includes(n.UASTC))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[n.UASTC_HDR]:o.filter((e=>e.basisFormat.includes(n.UASTC_HDR))).sort(((e,t)=>e.priorityHDR-t.priorityHDR))};function h(e){return e<=2||!(e&e-1)&&0!==e}function c(e){if(1===e.length)return e[0];let t=0;for(let i=0;i<e.length;i++){t+=e[i].byteLength}const i=new Uint8Array(t);let s=0;for(let t=0;t<e.length;t++){const a=e[t];i.set(a,s),s+=a.byteLength}return i}};const Wn=new Set([dt,Pt,pt]),Jn={[mn]:dt,[dn]:dt,[hn]:dt,[cn]:dt,[gn]:Pt,[un]:Pt,[on]:Pt,[ln]:Pt,[pn]:pt,[An]:pt,[nn]:pt,[rn]:pt,[kn]:It,[Qn]:Bt,[Tn]:Qt,[Mn]:Qt,[Sn]:Qt,[Dn]:Lt,[Rn]:Lt,[yn]:yt,[wn]:yt,[fn]:Ft,[bn]:Ft,[En]:Tt,[In]:Tt,[vn]:Ct,[Cn]:Ct,[xn]:xt,[Bn]:xt},Xn={[mn]:At,[dn]:ct,[hn]:St,[cn]:St,[gn]:At,[un]:ct,[on]:St,[ln]:St,[pn]:At,[An]:ct,[nn]:St,[rn]:St,[kn]:St,[Qn]:St,[Tn]:ct,[Dn]:St,[Rn]:St};function Yn(e){const t=e.dataFormatDescriptor[0];return 1===t.colorPrimaries?2===t.transferFunction?u:we:10===t.colorPrimaries?2===t.transferFunction?"display-p3":"display-p3-linear":(0===t.colorPrimaries||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),gt)}let Zn=0;class $n extends Kn{constructor(e){super(e),this.useLocal=!1}setUseLocal(e){return this.useLocal=e,this}_loadLibrary(e,t){const i=new oe(this.manager);return i.setPath(this.transcoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise(((t,s)=>{i.load(e,t,void 0,s)}))}init(){if(!this.transcoderPending){let e,t;this.useLocal?(this.transcoderPath="",e=this._loadLibrary(new URL("../build/basis/basis_transcoder.js",import.meta.url),"text"),t=this._loadLibrary(new URL("../build/basis/basis_transcoder.wasm",import.meta.url),"arraybuffer")):(e=this._loadLibrary("basis_transcoder.js","text"),t=this._loadLibrary("basis_transcoder.wasm","arraybuffer")),this.transcoderPending=Promise.all([e,t]).then((([e,t])=>{const i=$n.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify($n.EngineFormat),"let _EngineType = "+JSON.stringify($n.EngineType),"let _TranscoderFormat = "+JSON.stringify($n.TranscoderFormat),"let _BasisFormat = "+JSON.stringify($n.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=t,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),Zn>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Zn++}return this.transcoderPending}}var eo=function(){var e,t=0x10000000000000000,i=4294967295,s=2147483647;function a(e){var t=[];return t[e-1]=void 0,t}function r(e,t){return o(e[0]+t[0],e[1]+t[1])}function n(e,t){var i,s;return e[0]==t[0]&&e[1]==t[1]?0:(i=0>e[1],s=0>t[1],i&&!s?-1:!i&&s?1:function(e,t){return o(e[0]-t[0],e[1]-t[1])}(e,t)[1]<0?-1:1)}function o(e,s){var a,r;for(e%=t,s=(s%=t)-(a=s%P)+(r=Math.floor(e/P)*P),e=e-r+a;0>e;)e+=P,s-=P;for(;e>i;)e-=P,s+=P;for(s%=t;s>0x7fffffff00000000;)s-=t;for(;-0x10000000000000000>s;)s+=t;return[e,s]}function l(e){return e>=0?[e,0]:[e+P,-4294967296]}function h(e){return e[0]>=2147483648?~~Math.max(Math.min(e[0]-P,s),-2147483648):~~Math.max(Math.min(e[0],s),-2147483648)}function c(e){return e.cb>=e.O?-1:255&e.ab[e.cb++]}function A(e){var t=e.ab;return t.length=e.O,t}function u(e,t,s){var a,r,n,o,h="",A=[];for(r=0;5>r;++r){if(-1==(n=c(t)))throw Error("truncated input");A[r]=n<<24>>24}if(!function(e,t){var i,s,a,r,n,o,l;if(5>t.length)return 0;for(l=255&t[0],a=l%9,r=(o=~~(l/9))%5,n=~~(o/5),i=0,s=0;4>s;++s)i+=(255&t[1+s])<<8*s;return i>99999999||!function(e,t,i,s){if(t>8||i>4||s>4)return 0;v(e.k,i,t);var a=1<<s;return w(e.C,a),w(e.o,a),e.P=a-1,1}(e,a,r,n)?0:function(e,t){return 0>t?0:(e.z!=t&&(e.z=t,e.m=Math.max(e.z,1),p(e.b,Math.max(e.m,4096))),1)}(e,i)}(a=y({}),A))throw Error("corrupted input");for(r=0;64>r;r+=8){if(-1==(n=c(t)))throw Error("truncated input");1==(n=n.toString(16)).length&&(n="0"+n),h=n+""+h}/^0+$|^f+$/i.test(h)?e.N=_:(o=parseInt(h,16),e.N=o>i?_:l(o)),e.Q=function(e,t,i,s){return e.a.K=t,f(e.b),e.b.V=i,function(e){e.b.w=0,e.b.D=0,M(e.q),M(e.n),M(e.E),M(e.s),M(e.u),M(e.r),M(e.J),function(e){var t,i;for(i=1<<e.g+e.y,t=0;i>t;++t)M(e.F[t].v)}(e.k);for(var t=0;4>t;++t)M(e.j[t].B);C(e.C),C(e.o),M(e.t.B),function(e){e.p=0,e.i=-1;for(var t=0;5>t;++t)e.p=e.p<<8|c(e.K)}(e.a)}(e),e.f=0,e.l=0,e.T=0,e.R=0,e._=0,e.U=s,e.d=z,e.I=0,function(e,t){return e.h=t,e.bb=null,e.X=1,e}({},e)}(a,t,s,e.N)}function d(e,t){return e.S=function(e){return e.ab=a(32),e.O=0,e}({}),u(e,function(e,t){return e.ab=t,e.cb=0,e.O=t.length,e}({},t),e.S),e}function p(e,t){(null==e.x||e.c!=t)&&(e.x=a(t)),e.c=t,e.D=0,e.w=0}function g(e){var t=e.D-e.w;t&&(function(e,t,i,s){(function(e,t,i,s,a){for(var r=0;a>r;++r)i[s+r]=e[t+r]})(t,i,e.ab,e.O,s),e.O+=s}(e.V,e.x,e.w,t),e.D>=e.c&&(e.D=0),e.w=e.D)}function m(e,t){var i=e.D-t-1;return 0>i&&(i+=e.c),e.x[i]}function f(e){g(e),e.V=null}function b(e){if(!e.X)throw Error("bad state");if(e.bb)throw Error("No encoding");return function(e){var t=function(e){var t,i,s,a,o,c;if(c=h(e.d)&e.P,Q(e.a,e.q,(e.f<<4)+c)){if(Q(e.a,e.E,e.f))s=0,Q(e.a,e.s,e.f)?(Q(e.a,e.u,e.f)?(Q(e.a,e.r,e.f)?(i=e._,e._=e.R):i=e.R,e.R=e.T):i=e.T,e.T=e.l,e.l=i):Q(e.a,e.n,(e.f<<4)+c)||(e.f=7>e.f?9:11,s=1),s||(s=I(e.o,e.a,c)+2,e.f=7>e.f?8:11);else if(e._=e.R,e.R=e.T,e.T=e.l,s=2+I(e.C,e.a,c),e.f=7>e.f?7:10,o=k(e.j[function(e){return 4>(e-=2)?e:3}(s)],e.a),o>=4){if(a=(o>>1)-1,e.l=(2|1&o)<<a,14>o)e.l+=function(e,t,i,s){var a,r,n=1,o=0;for(r=0;s>r;++r)a=Q(i,e,t+n),n<<=1,n+=a,o|=a<<r;return o}(e.J,e.l-o-1,e.a,a);else if(e.l+=S(e.a,a-4)<<4,e.l+=function(e,t){var i,s,a=1,r=0;for(s=0;e.A>s;++s)i=Q(t,e.B,a),a<<=1,a+=i,r|=i<<s;return r}(e.t,e.a),0>e.l)return-1==e.l?1:-1}else e.l=o;if(n(l(e.l),e.d)>=0||e.l>=e.m)return-1;(function(e,t,i){var s=e.D-t-1;for(0>s&&(s+=e.c);0!=i;--i)s>=e.c&&(s=0),e.x[e.D++]=e.x[s++],e.D>=e.c&&g(e)})(e.b,e.l,s),e.d=r(e.d,l(s)),e.I=m(e.b,0)}else t=function(e,t,i){return e.F[((t&e.Y)<<e.g)+((255&i)>>>8-e.g)]}(e.k,h(e.d),e.I),e.I=7>e.f?function(e,t){var i=1;do{i=i<<1|Q(t,e.v,i)}while(256>i);return i<<24>>24}(t,e.a):function(e,t,i){var s,a,r=1;do{if(a=i>>7&1,i<<=1,s=Q(t,e.v,(1+a<<8)+r),r=r<<1|s,a!=s){for(;256>r;)r=r<<1|Q(t,e.v,r);break}}while(256>r);return r<<24>>24}(t,e.a,m(e.b,e.l)),function(e,t){e.x[e.D++]=t,e.D>=e.c&&g(e)}(e.b,e.I),e.f=function(e){return 4>e?0:10>e?e-3:e-6}(e.f),e.d=r(e.d,U);return 0}(e.h);if(-1==t)throw Error("corrupted input");e.$=_,e.Z=e.h.d,(t||n(e.h.U,z)>=0&&n(e.h.d,e.h.U)>=0)&&(g(e.h.b),f(e.h.b),e.h.a.K=null,e.X=0)}(e),e.X}function y(e){e.b={},e.a={},e.q=a(192),e.E=a(12),e.s=a(12),e.u=a(12),e.r=a(12),e.n=a(192),e.j=a(4),e.J=a(114),e.t=x({},4),e.C=E({}),e.o=E({}),e.k={};for(var t=0;4>t;++t)e.j[t]=x({},6);return e}function w(e,t){for(;t>e.e;++e.e)e.G[e.e]=x({},3),e.H[e.e]=x({},3)}function I(e,t,i){return Q(t,e.M,0)?8+(Q(t,e.M,1)?8+k(e.L,t):k(e.H[i],t)):k(e.G[i],t)}function E(e){return e.M=a(2),e.G=a(16),e.H=a(16),e.L=x({},8),e.e=0,e}function C(e){M(e.M);for(var t=0;e.e>t;++t)M(e.G[t].B),M(e.H[t].B);M(e.L.B)}function v(e,t,i){var s,r;if(null==e.F||e.g!=i||e.y!=t)for(e.y=t,e.Y=(1<<t)-1,e.g=i,r=1<<e.g+e.y,e.F=a(r),s=0;r>s;++s)e.F[s]=B({})}function B(e){return e.v=a(768),e}function x(e,t){return e.A=t,e.B=a(1<<t),e}function k(e,t){var i,s=1;for(i=e.A;0!=i;--i)s=(s<<1)+Q(t,e.B,s);return s-(1<<e.A)}function Q(e,t,i){var s,a=t[i];return(-2147483648^(s=(e.i>>>11)*a))>(-2147483648^e.p)?(e.i=s,t[i]=a+(2048-a>>>5)<<16>>16,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8),0):(e.i-=s,e.p-=s,t[i]=a-(a>>>5)<<16>>16,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8),1)}function S(e,t){var i,s,a=0;for(i=t;0!=i;--i)e.i>>>=1,s=e.p-e.i>>>31,e.p-=e.i&s-1,a=a<<1|1-s,-16777216&e.i||(e.p=e.p<<8|c(e.K),e.i<<=8);return a}function M(e){for(var t=e.length-1;t>=0;--t)e[t]=1024}function R(e){for(var t,i,s,a=0,r=0,n=e.length,o=[],l=[];n>a;++a,++r){if(128&(t=255&e[a]))if(192==(224&t)){if(a+1>=n)return e;if(128!=(192&(i=255&e[++a])))return e;l[r]=(31&t)<<6|63&i}else{if(224!=(240&t))return e;if(a+2>=n)return e;if(128!=(192&(i=255&e[++a])))return e;if(128!=(192&(s=255&e[++a])))return e;l[r]=(15&t)<<12|(63&i)<<6|63&s}else{if(!t)return e;l[r]=t}16383==r&&(o.push(String.fromCharCode.apply(String,l)),r=-1)}return r>0&&(l.length=r,o.push(String.fromCharCode.apply(String,l))),o.join("")}function D(e){return e[1]+e[0]}var T=2,F=3,L="function"==typeof setImmediate?setImmediate:setTimeout,P=4294967296,_=[i,-4294967296],z=[0,0],U=[1,0];return{decompress:function(t,i,s){var a,r,n,o,l={},h=void 0===i&&void 0===s;if("function"!=typeof i&&(r=i,i=s=0),s=s||function(t){return void 0!==r?function(t,i){e({action:F,cbn:i,result:t})}(n?t:-1,r):void 0},i=i||function(t,i){return void 0!==r?e({action:T,cbn:r,result:t,error:i}):void 0},h){for(l.d=d({},t);b(l.d.Q););return R(A(l.d.S))}try{l.d=d({},t),o=D(l.d.N),n=o>-1,s(0)}catch(e){return i(null,e)}L((function e(){try{for(var t,r=0,h=(new Date).getTime();b(l.d.Q);)if(++r%1e3==0&&(new Date).getTime()-h>200)return n&&(a=D(l.d.Q.h.d)/o,s(a)),L(e,0),0;s(1),t=R(A(l.d.S)),L(i.bind(null,t),0)}catch(e){i(null,e)}}),0)}}}();const to={decompress:(e,t)=>{eo.decompress(new Uint8Array(e),t)}},io={getMesh:(e,t)=>{let i={};if(t){let t=[],i=[],s={},a=[];e.traverse((e=>{if(e.isGroup){let r=io.groupToMesh(e);r&&(t.push(e),a.push(e.name),r.applyMatrix4(e.matrix),i.push(r),s[r.name]=i)}}));let r,n,o=t.length;for(;o--;)r=t[o].parent,n=r.name,r.remove(t[o]),-1!==a.indexOf(n)&&(r=s[n]),r.add(i[o])}return e.traverse((e=>{e.isMesh&&(i[e.name]=e)})),i},getGroup:(e,t,i)=>{const s={};return e.traverse((e=>{e.isGroup&&(s[e.name]=t?io.groupToMesh(e,mats):e)})),s},getMaterial:e=>{const t={};let i,s=[];return e.traverse((e=>{e.isMesh&&(i=e.material,-1===s.indexOf(i.name)&&(s.push(i.name),t[i.name]=i))})),t},groupToMesh:e=>{if(e.children[0].name!==e.name+"_1")return!1;if(!e.children[0].isMesh)return!1;let t=[],i=[],s=e.children.length;for(;s--;)i[s]=e.children[s].material,t[s]=e.children[s].geometry,t[s].group=s;let a=new Z(new ps(t,!0),i);return a.name=e.name,a},symetric:e=>{e.isMesh&&(e=e.geometry);let t=e.attributes.uv.array,i=.5*t.length;for(;i--;)t[2*i]<0&&(t[2*i]*=-1);e.attributes.uv.needsUpdate=!0},uv2:e=>{e.isMesh&&(e=e.geometry),e.setAttribute("uv2",e.attributes.uv)},autoMorph:(e,t,i=!0,a=!1)=>{let r,n,o,l,h,c,A,u,d,p,g,m={},f=[];e.traverse((e=>{e.isMesh&&-1!==e.name.search("__M__")&&(m[e.name]=e.geometry,f.push(e))}));for(let e in m)if(r=e.substring(0,e.indexOf("__")),n=e.substring(e.lastIndexOf("__")+2),o=t[r],o)if(h=o.geometry,c=m[e],h.morphTargetsRelative=a,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],i&&(h.morphAttributes.normal=[]),o.morphTargetInfluences=[],o.morphTargetDictionary={}),l=h.morphAttributes.position.length,a){for(A=c.attributes.position.array.length,p=[];A--;)p[A]=c.attributes.position.array[A]-h.attributes.position.array[A];u=new s(p,3)}else u=new s(c.attributes.position.array,3);h.morphAttributes.position.push(u),i&&(d=new s(c.attributes.normal.array,3),h.morphAttributes.normal.push(d)),o.morphTargetInfluences.push(0),o.morphTargetDictionary[n]=l}else console.warn("Morph "+n+" target is no good on "+o.name);for(m={},A=f.length;A--;)g=f[A],g.parent&&g.parent.remove(g),g.material&&g.material.dispose(),g.geometry&&g.geometry.dispose()}},so={manager:new zt,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./build/draco/",basisPath:"./build/basis/",useLocal:!1,formatGltf:{draco:!0,ktx2:!1,meshop:!1},setSupport:e=>{for(let t in e)so.formatGltf[t]&&(so.formatGltf[t]=e[t])},maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:e=>{},materialRoot:e=>{console.log(e)},setLoadEvent:(e,t)=>{so.onLoad=e,so.onEnd=t},prefix:e=>{let t="";switch(e){case"S":case"sound":case"mp3":case"wav":case"ogg":t="S_";break;case"I":case"image":case"jpg":case"png":t="I_";break;case"E":case"hdr":case"env":case"T":case"texture":t="T_";break;case"J":case"json":t="J_";break;case"JS":case"js":t="JS_";break;case"H":case"bin":case"hex":t="H_";break;case"O":case"object3d":t="O_";break;case"M":case"material":t="M_"}return t},dispose:()=>{so.data.forEach((function(e,t){(e.isMaterial||e.isTexture)&&(e.dispose(),so.data.delete(t)),e.isObject3D&&(e.traverse((function(e){e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose())})),so.data.delete(t))}))},createElementNS:e=>document.createElementNS("http://www.w3.org/1999/xhtml",e),exist:(e,t="")=>!!so.get(e,t),delete:(e,t="")=>so.data.delete(so.prefix(t)+e),get:(e,t="")=>so.data.get(so.prefix(t)+e),set:(e,t,i="",s)=>{t?(t.isMaterial&&(i="material",t.name=e,so.materialRoot(t,s)),t.isTexture&&(i="texture"),t.isObject3D&&(i="object3d"),so.get(e,i)||so.data.set(so.prefix(i)+e,t)):console.log("Loading error on "+e)},getScript:e=>so.data.get(so.prefix("js")+e),getMaterials:e=>("string"==typeof e&&(e=so.get(e,"O")),io.getMaterial(e)),getGLB:(e,t)=>("string"==typeof e&&(e=so.get(e,"O")),e?(t&&io.getMesh(e,t),e):console.error("Not find Model ?")),getMesh:(e,t)=>("string"==typeof e&&(e=so.get(e,"O")),e?io.getMesh(e,t):console.error("Not find Model ?")),getGroup:(e,t,i)=>("string"==typeof e&&(e=so.get(e,"O")),io.getGroup(e,t,i)),applyMorph(e,t=null,i=!0,s=!0){let a;a=e.isObject3D?e:so.get(e,"O"),t||(t=so.getMesh(e)),a&&t&&io.autoMorph(a,t,i,s)},uv2(e){io.uv2(e)},symetric(e){io.symetric(e)},objectSpaceNormal(e){e.material.normalMapType=Nt},add:(e,t,i)=>{so.set(e,t,i),so.next()},getMaterial:e=>so.data.get("M_"+e),texture:(e={})=>{so.loaderMap||(so.loaderMap=new ve);let t=e.name||"";return e.url&&(t=-1!==e.url.lastIndexOf(".")?e.url.substring(e.url.lastIndexOf("/")+1,e.url.lastIndexOf(".")):e.url.substring(e.url.lastIndexOf("/")+1)),-1===t.search("_c")&&-1===t.search("_l")&&-1===t.search("_u")&&-1===t.search("_d")||(e.srgb=!0),so.exist(t,"texture")?so.get(t,"texture"):so.exist(t,"image")?so.getTexture(t,e):so.loaderMap.load(e.url,(function(i){return so.setTextureOption(i,e),so.data.set("T_"+t,i),e.callback&&e.callback(),i}))},getTexture:(e,t={})=>{e=(t.quality?t.quality+"k_":"")+e;let i=so.get(e,"texture");if(!i){let s=so.get(e,"image");if(!s)return null;i=new Ye(s),-1===e.search("_c")&&-1===e.search("_d")&&-1===e.search("_l")&&-1===e.search("_u")||(t.srgb=!0),so.data.set("T_"+e,i)}return so.setTextureOption(i,t),i},setTextureOption:(e,t={})=>{t.encoding&&(e.colorSpace=u),t.srgb&&(e.colorSpace=u),e.flipY=(void 0!==t.flipY||void 0!==t.flip)&&t.flipY,t.anisotropy&&(e.anisotropy="max"===t.anisotropy?so.maxAnisotropy:t.anisotropy),void 0!==t.generateMipmaps&&(e.generateMipmaps=t.generateMipmaps),t.repeat&&(e.repeat.fromArray(t.repeat),e.wrapS=e.wrapT=A),t.center&&e.center.fromArray(t.center),t.offset&&e.offset.fromArray(t.offset),t.filter&&"near"===t.filter&&(e.minFilter=Te,e.magFilter=Te),t.channel&&(e.channel=t.channel),e.needsUpdate=!0},loadAsync:(e,t="",i="")=>new Promise(((s,a)=>{so.waiting=!0,so.load(e,(()=>{so.waiting=!1}),t,i)})),load:(e,t,i="",s="",a=0)=>{so.msg=s;let r=[],n=t||function(){},o=("undefined"==typeof performance?Date:performance).now();"string"==typeof e||e instanceof String?r.push(e):r=r.concat(e),so.tmp.push({urls:r,path:i,callback:n,start:o,quality:a}),so.inLoad||so.loadOne()},loadOne:()=>{so.inLoad=!0,so.onLoad();let e=so.tmp[0].path+so.tmp[0].urls[0],t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),i=e.substring(e.lastIndexOf(".")+1).toLowerCase();"jpg"!==i&&"png"!==i||(t=(so.tmp[0].quality?so.tmp[0].quality+"k_":"")+t),so.exist(t,i)?so.next():so.loading(e,t,i)},next:()=>{so.tmp[0].urls.shift(),0===so.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-so.tmp[0].start),so.tmp[0].callback(),so.tmp.shift(),so.tmp.length>0?so.loadOne():(so.inLoad=!1,so.clearDRACO(),so.clearKTX2(),so.onEnd())):so.loadOne()},loading:(e,t,i)=>{switch(so.log(so.msg),i){case"glb":case"gltf":so.load_GLTF(e,t);break;case"fbx":case"FBX":so.load_FBX(e,t);break;case"obj":so.load_OBJ(e,t);break;case"stl":so.load_STL(e,t);break;case"ktx2":so.load_KTX2(e,t);break;case"hdr":so.load_RGBE(e,t);break;case"exr":so.load_EXR(e,t);break;default:so.extand(e,t,i)}},extand:(e,t,i)=>{so.XHTTP||(so.XHTTP=new XMLHttpRequest);const s=so.XHTTP;switch(s.open("GET",e,!0),"json"===i&&s.overrideMimeType("application/json"),i){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":s.responseType="arraybuffer";break;case"jpg":case"png":s.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):so.direct(s.response,t,i))},"onprogress"in s&&(s.onprogress=function(e){}),s.send(null)},direct:(e,t,i)=>{switch(i){case"jpg":case"png":let s=so.createElementNS("img");s.onload=function(e){window.URL.revokeObjectURL(s.src),so.add(t,s,"image")},s.src=window.URL.createObjectURL(e);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(e.slice(0),(function(e){so.add(t,e,"sound")}),(function(e){console.error("decodeAudioData error",e)}));break;case"hex":case"bin":to.decompress(e,(e=>{so.add(t,e,i)}));break;case"wasm":so.add(t,new Uint8Array(e),i);break;case"json":so.add(t,JSON.parse(e),i);break;default:so.add(t,e,i)}},clearKTX2:()=>{so.KTX2&&(so.KTX2.dispose(),so.KTX2=null)},clearDRACO:()=>{so.dracoLoader&&(so.dracoLoader.dispose(),so.dracoLoader=null),so.GLTF&&(so.GLTF=null)},loaderFILE:()=>(so.FILE||(so.FILE=new oe(so.manager)),so.FILE),loaderDRACO:()=>{if(so.dracoLoader)return so.dracoLoader;if(!so.dracoLoaderType)if(navigator.userAgentData)so.dracoLoaderType="wasm";else{let e=navigator.userAgent.toLowerCase();so.dracoLoaderType=-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"js":"wasm"}return so.dracoLoader=(new tn).setDecoderConfig({type:so.dracoLoaderType}).setDecoderPath(so.dracoPath).setUseLocal(so.useLocal),so.dracoLoader},loaderKTX2:()=>(so.KTX2||(so.KTX2=new $n(so.manager).setTranscoderPath(so.basisPath).detectSupport(so.renderer).setUseLocal(so.useLocal)),so.KTX2),loaderGLTF:()=>(so.GLTF||(so.GLTF=new zs(so.manager).setCrossOrigin("anonymous"),so.formatGltf.draco&&so.GLTF.setDRACOLoader(so.loaderDRACO()),so.formatGltf.ktx2&&so.GLTF.setKTX2Loader(so.loaderKTX2()),so.formatGltf.meshop&&so.GLTF.setMeshoptDecoder($r)),so.GLTF),loaderFBX:()=>(so.FBX||(so.FBX=new fr(so.manager)),so.FBX),loaderSTL:()=>(so.STL||(so.STL=new Wr(so.manager)),so.STL),loaderOBJ:()=>(so.OBJ||(so.OBJ=new Kr(so.manager)),so.OBJ),loaderRGBE:()=>(so.RGBE||(so.RGBE=new Jr(so.manager)),so.RGBE),loaderEXR:()=>(so.EXR||(so.EXR=new Xr(so.manager)),so.EXR),loaderUltra:()=>(so.ULTRA||(so.ULTRA=new Zr(so.manager).setDataType(THREE.HalfFloatType)),so.ULTRA),load_GLTF:(e,t)=>{so.loaderGLTF().load(e,(function(e){const i=e.scene;if(e.animations){const t=e.animations,s=new Ut(e.scene);i.mixer=s,i.actions={};for(let e=0;e<t.length;e++){let a=t[e];i.actions[a.name]=s.clipAction(a)}i.play=e=>{i.actions[e]&&(i.actions[e].paused=!1,i.actions[e].time=0,i.actions[e].play())},i.pause=(e,t=!0)=>{i.actions[e]&&(i.actions[e].paused=t)}}so.add(t,i)}))},load_FBX:(e,t)=>{so.loaderFBX().load(e,(function(e){so.add(t,e)}))},load_OBJ:(e,t)=>{so.loaderOBJ().load(e,(function(e){so.add(t,e)}))},load_STL:(e,t)=>{so.loaderSTL().load(e,(function(e){let i=new Z(e);so.add(t,i)}))},load_KTX2:(e,t,i)=>{so.loaderKTX2().load(e,(function(e){return so.add(t,e),e}))},load_RGBE:(e,t)=>{so.loaderRGBE().load(e,(function(e){e.mapping=nt,so.add(t,e)}))},load_EXR:(e,t,i)=>{so.loaderEXR().load(e,(function(e){return i&&i(e),e}))},direct_EXR:(e,t)=>{so.loaderEXR().parse(url,(function(e){return so.add(t,e),e}))}};class ao{constructor(e,t){this.target=t||e,this.baseGeometry=e.geometry,this.geometry=this.target.geometry,this.V=[new W,new W,new W],this.X=[new at,new at,new J],this.M=[new W,new W,new W],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const e=this.geometry;let t=e.attributes.position.array.length;e.setAttribute("color",new s(new Array(t).fill(0),3))}resetEdge(e){let t=e.length;for(;t--;)e[t]=0}getEdge(e,t,i=!1,s=!1){let a=e.attributes.position.array;const r=e.index.array;let n,o,l,h,c,A,u,d=this.V[0],p=this.V[1],g=this.V[2],m=0;for(s&&(a=this.getMorph()),i&&(a=this.getSkinned(a)),(i||s)&&this.resetEdge(t),n=this.indexLength;n--;)o=r[m],l=r[m+1],h=r[m+2],d.fromArray(a,3*o),p.fromArray(a,3*l),g.fromArray(a,3*h),c=d.distanceTo(p),A=d.distanceTo(g),u=p.distanceTo(g),t[o]+=.5*(c+A),t[l]+=.5*(c+u),t[h]+=.5*(A+u),m+=3}isZero(e){return 0===e.x&&0===e.y&&0===e.z}getMorph(){const e=this.target.morphTargetInfluences,t=this.geometry.morphAttributes.position,i=e.length,s=this.geometry.attributes.position.array;let a,r,n,o,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],A=this.M[2],u=this.geometry.morphTargetsRelative;for(r=l;r--;){for(a=3*r,c.fromArray(s,a),h.set(0,0,0),n=i;n--;)0!=e[n]&&(o=t[n].data?t[n].data.array:t[n].array,u?h.addScaledVector(A.fromArray(o,a),e[n]):h.addScaledVector(A.fromArray(o,a).sub(c),e[n]));c.add(h),c.toArray(this.back,a)}return this.back}getSkinned(e){const t=this.target.skeleton;t.boneMatrices;const i=this.geometry,s=i.attributes.skinIndex.array,a=i.attributes.skinWeight.array,r=this.target.bindMatrix,n=this.target.bindMatrixInverse;let o,l,h,c,A,u=this.V[0],d=this.V[1],p=this.V[2],g=this.X[0],m=this.X[1],f=this.X[2];for(o=i.attributes.position.count;o--;){for(A=3*o,g.fromArray(s,4*o),m.fromArray(a,4*o),u.fromArray(e,A).applyMatrix4(r),d.set(0,0,0),l=4;l--;)c=m.getComponent(l),c>0&&(h=g.getComponent(l),f.multiplyMatrices(t.bones[h].matrixWorld,t.boneInverses[h]),d.addScaledVector(p.copy(u).applyMatrix4(f),c));d.applyMatrix4(n),d.toArray(this.back,A)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const e=this.geometry.attributes.color.array;let t,i,s,a=this.length;for(;a--;)t=this.originEdges[a],i=(t-this.targetEdges[a])/t+.5,s=3*a,e[s]=i>.5?2*(i-.5):0,e[s+1]=0,e[s+2]=i<.5?1-2*i:0;this.geometry.attributes.color.needsUpdate=!0}}class ro extends ie{constructor(e,t){super(),this.isReady=!1,this.skeleton=t,this.bones=this.skeleton.bones,this.root=e,this.box=new l,this.mtxr=new J,this.mtx0=new J,this.mtx1=new J,this.mtx=new J,this.mtx2=new J,this.p=new W,this.s=new W,this.q=new Y,this.e=new ge,this.mat=new w({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){if(!this.isReady)return;let t,i,s=this.children,a=s.length;for(this.mtxr.copy(this.root.matrixWorld).invert();a--;)t=s[a],i=t.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,i.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,t.userData.decal),this.mtx.decompose(this.p,this.q,this.s),t.position.copy(this.p),t.quaternion.copy(this.q),t.updateMatrix();super.updateMatrixWorld(e)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const e=this.bones;let t,i,s,a,r,n,o,l,h,c,A,u=new W,d=new W,p=e.length;for(t=0;t<p;t++)l=null,a=e[t],i=a.name,r=a.parent,r&&(s=r.name,u.setFromMatrixPosition(r.matrixWorld),d.setFromMatrixPosition(a.matrixWorld),o=u.distanceTo(d),h=[0,0,.5*o],n=[o,1,1],c=[0,0,0],A="_C","head"===s&&"End_head"===i&&(l="box",n=[.16,.2,o],h=[0,.025,.5*-o]),"chest"===s&&"neck"===i&&(l="box",n=[.3,.28,o],h=[0,0,.5*-o]),"abdomen"===s&&(l="box",n=[.28,.24,o+.14],c[2]=0,h=[0,0,.5*-o],h[2]+=.07),"rThigh"===s&&(l="box",n=[.15,.15,o]),"lThigh"===s&&(l="box",n=[.15,.15,o]),"rShin"===s&&(l="box",n=[.12,.12,o+.1],h[2]+=.05),"lShin"===s&&(l="box",n=[.12,.12,o+.1],h[2]+=.05),"rShldr"===s&&(l="box",n=[o+.06,.12,.12],h[0]=.03-h[2],h[2]=0),"lShldr"===s&&(l="box",n=[o+.06,.12,.12],h[0]=h[2]-.03,h[2]=0),"rForeArm"===s&&(l="box",n=[o+.1,.1,.1],h[0]=-h[2]-.05,h[2]=0),"lForeArm"===s&&(l="box",n=[o+.1,.1,.1],h[0]=h[2]+.05,h[2]=0),null!==l&&this.addMesh(r,l,n,h,c,"_C"));this.isReady=!0}addMesh(e,t,i,s,a,r){this.mtx.makeTranslation(s[0],s[1],s[2]);var n=new Z(this.box,this.mat);n.scale.fromArray(i),n.userData.decal=this.mtx.clone(),n.userData.bone=e,n.userData.size=i,this.add(n)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const no={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:1,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},oo={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:no,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",roughness:.54,metalness:.14,normalScale:new g(no.normal,-no.normal),wireframe:no.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new p(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new g(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new g(2,-2),clearcoat:.25},hair:{type:"Standard",color:no.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:C,emissive:no.hair,emissiveIntensity:.5,transparent:!0,blending:Gt,blendDst:P,blendDstAlpha:D,alphaToCoverage:!0},hair_man:{type:"Standard",color:no.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:C,transparent:!0,blending:Gt,blendDst:P,blendDstAlpha:D,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:no.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:C,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(e={},t=!1)=>{if(!so.getMaterial(oo.materialRef))return;const i=oo.setting,s=oo.materials;let a,r=!1;for(let t in e)void 0!==i[t]&&i[t]!==e[t]&&(i[t]=e[t],r=!0);if(r)for(let i in s){a=so.getMaterial(i);for(let r in e)void 0!==a[r]&&(t&&s[i][r]?a[r]=s[i][r]:a[r]=e[r])}},applyMaterial:(e,t)=>{const i=!0,s=so.getMaterial("skin");//!Human.haveLOD;
e.traverse((e=>{if(e.isMesh)switch(e.name){case"body":case"Head":e.material=s,e.receiveShadow=!0,e.castShadow=!0,e.visible=i;break;case"body_low":e.material=s,e.receiveShadow=!0,e.castShadow=!0,e.visible=!1;break;case"crane":e.material=s,e.receiveShadow=!0,e.castShadow=!1,e.visible=!oo.haveHair;break;case"mouth":e.material=so.getMaterial("mouth")||s,e.receiveShadow=!0,e.castShadow=!1,e.visible=i,e.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":e.material=so.getMaterial("eyelash")||s,e.receiveShadow=!1,e.castShadow=!1,e.visible=i;break;case"tear":e.material=so.getMaterial("tear")||s,e.receiveShadow=!1,e.castShadow=!1,e.visible=i;break;case"eye_l":case"eye_r":e.material=so.getMaterial("eye")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"eye_l_s":case"eye_r_s":e.material=so.getMaterial("sub_eye")||s,e.receiveShadow=!1,e.castShadow=!1,e.visible=i;break;case"hair":e.material=so.getMaterial("hair")||s,e.receiveShadow=!1,e.castShadow=!1,e.visible=!!oo.haveHair&&i;break;case"hair_man":e.material=so.getMaterial("hair_man")||s,e.receiveShadow=!1,e.castShadow=!1,e.visible=!!oo.haveHair&&i}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},lo={wireframe:!1,normal:.25,hair:2433041},ho={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:lo,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new g(lo.normal,-lo.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:lo.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:lo.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(e={},t=!1)=>{if(!so.getMaterial(ho.materialRef))return;const i=Lee.materials;let s;for(let a in i){s=so.getMaterial(a);for(let r in e)void 0!==s[r]&&(t&&i[a][r]?s[r]=i[a][r]:s[r]=e[r])}},applyMaterial:(e,t)=>{const i=so.getMaterial(ho.materialRef);e.traverse((e=>{if(e.isMesh)switch(e.name){case"body_low":e.material=i,e.receiveShadow=!0,e.castShadow=!0;break;case"hair_low":e.material=so.getMaterial("hair_low")||i,e.receiveShadow=!1,e.castShadow=!1;break;case"hair_low_2":e.material=so.getMaterial("hair_low_2")||i,e.receiveShadow=!1,e.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},co={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},Ao={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:co,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:co.roughness,metalness:co.metalness,wireframe:co.wireframe,clearcoat:co.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:co.roughness,metalness:co.metalness,wireframe:co.wireframe,clearcoat:co.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:co.roughness,metalness:co.metalness,wireframe:co.wireframe,clearcoat:co.clearcoat,aoMap:"eva_ao"}},changeMaterial:(e,t=!1)=>{if(!so.getMaterial(Ao.materialRef))return;const i=Ao.materials;let s;for(let a in i){s=so.getMaterial(a);for(let r in e)void 0!==s[r]&&(t&&i[a][r]?s[r]=i[a][r]:s[r]=e[r]);s.needsUpdate=!0}},applyMaterial:(e,t)=>{const i=so.getMaterial(t);e.traverse((e=>{if(e.isMesh)switch(e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.name){case"eva_2_head":case"eva_2_mach":e.visible="eva02"===t;break;case"eva_L_COLLAR":case"eva_R_COLLAR":e.visible="eva00"!==t;break;case"eva_HEAD":case"eva_MACHOIR":e.visible="eva01"===t;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":e.visible="eva00"===t;break;case"eva_0_CHEST2":e.visible="eva01"!==t}}))}},uo={metalness:.2,roughness:.8,wireframe:!1},po={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:uo,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:uo.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(e,t=!1)=>{if(!so.getMaterial(po.materialRef))return;const i=po.materials;let s;for(let a in i){s=so.getMaterial(a);for(let r in e)void 0!==s[r]&&(t&&i[a][r]?s[r]=i[a][r]:s[r]=e[r])}},applyMaterial:(e,t)=>{const i=so.getMaterial("lee_material");e.traverse((e=>{e.isMesh&&(e.material=i,e.receiveShadow=!0,e.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},go={metalness:.2,roughness:.8,wireframe:!1},mo={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:go,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:go.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(e,t=!1)=>{},applyMaterial:(e,t)=>{},adjustment:()=>[]},fo=1/30,bo=Math.PI/180,yo=180/Math.PI,wo=new W,Io={tmp:[],model:[],avatar:null,callback:()=>{},add:(e,t)=>{Io.tmp=[...e],Io.callback=t,Io.tmp.length&&Io.loadOne()},loadOne:()=>{let e=Io.tmp[0];Io.avatar=new Eo({type:e,callback:Io.next,morph:!0,isPreload:!0})},next:e=>{Io.avatar.dispose(),Io.tmp.shift(),0===Io.tmp.length?Io.callback():Io.loadOne()}};class Eo extends Oe{constructor(e={}){switch(super(),this.isPreload=e.isPreload||!1,this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.rootPath=e.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",this.callback=e.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=e.randomMorph||!1,this.randomSize=e.randomSize||!1,this.actionPose=null,this.model=e.type||"man",this.startAnimation=e.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=mo;break;case"lee":this.ref=po;break;case"man":case"woman":this.ref=oo;break;case"man_low":case"woman_low":this.ref=ho;break;case"eva00":case"eva01":case"eva02":this.ref=Ao}this.compact=void 0===e.compact||e.compact,this.haveMorph=void 0!==e.morph&&e.morph,this.fullMaterial=void 0===e.material||e.material,this.size=e.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,e.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new Y).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new W,this.eyeTarget=new Oe,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new J,this.tmpQ=new Y,this.setting={},this.root=so.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=Ls(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(e=0,t=1){return e+Math.random()*(t-e)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=so.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const e=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");so.load(this.ref.textures,this.loadModels.bind(this),e,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const e=this.ref.forceModel?this.ref.forceModel:this.model,t=[e+".glb"],i=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&t.push(e+"_morph.glb"),so.load(t,this.init.bind(this),i,"loading models...")}update(e){this.done&&this.mixer&&(this.mixer.update(e),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*e),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const e=this.n++;let t=0;e<=10&&(t=.1*e),e>10&&e<=20&&(t=1-.1*(e-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",t)}look(e){if(!this.isEyeMove)return;if(this.isPause)return;const t=window.mouse||{x:0,y:0};e>1&&(e=1),this.headBoneLook.lerp({x:-20*t.y*bo,y:0,z:-20*t.x*bo},e),this.eyeTarget.position.lerp({x:.5*t.x,y:1,z:.25*-t.y},e);let i=this.headBoneLook;this.tmpQ.setFromEuler({_x:i.x,_y:i.y,_z:i.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let s=this.bones.ER,a=this.bones.EL,r={x:0,y:0,z:1};this.tmpMtx.lookAt(a.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),r),a.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(s.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),r),s.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let e=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,e),this.lerp(1,1.04,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,e),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,e),this.lerp(1.04,1,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,e),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(e,t,i){this.position.set(e,t,i),this.updateMatrix()}setRotation(e,t,i,s){let a=this.lerp(this.rotation.y,t,s);this.rotation.set(e,a,i),this.updateMatrix()}lerp(e,t,i){return(1-i)*e+i*t}onReady(){}initMaterial(){if(so.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void so.set(this.ref.materialRef,new f);let e,t,i;for(const s in this.ref.materials){i={...this.ref.materials[s]},t=i.type,delete i.type;for(const e in i)"envMapIntensity"!==e&&"normalMapType"!==e&&"aoMapIntensity"!==e&&"aoMapIntensity"!==e&&("map"!==e&&-1===e.search("Map")||(i[e]=so.getTexture(i[e],{quality:this.textureQuality})));"Basic"===t?e=new w(i):"Standard"===t?e=new f(i):"Physical"===t?e=new d(i):"Sss"===t&&(e=new vi(i)),e.name=s,so.set(s,e)}this.setting=this.ref.setting}setMaterial(e,t){let i=so.getMaterial(this.ref.materialRef);if(i)for(let t in e)void 0!==i[t]&&(i[t]=e[t])}setMaterialNormal(e){let t=so.getMaterial("skin");t&&(e<0&&(e=0),t.normalScale.set(e,-e))}getMaterial(e){return so.getMaterial(e)}init(){if(this.initMaterial(),!this.isClone){let e=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&so.getMesh(e,!0),this.root=so.get(e,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(e){e.raycast=function(){},e.isMesh&&(e.name===this.ref.skeletonRef&&(e.matrixAutoUpdate=!1,this.skeleton=e.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=e.geometry.boundingBox.max.y),"Head"===e.name&&(this.realSize=e.geometry.boundingBox.max.y),this.mesh[e.name]=e),e.isBone&&(this.bones[e.name]=e)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let e in this.mesh)this.mesh[e].isSkinnedMesh&&e!==this.ref.skeletonRef&&(this.mesh[e].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&so.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),so.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new Ut(this),0===so.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let e=so.clip.length;for(;e--;)this.addAction(so.clip[e]);this.start()}}setRealSize(e){this.realSize=e;let t=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(t)}setSize(e){this.size=e,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(e){this.bones.head.scale.set(1,1,1).multiplyScalar(e)}addTensionMap(){this.tension1=new ao(this.mesh.body),this.tension2=new ao(this.mesh.Head)}setBounding(e){for(let t in this.mesh)this.mesh[t].isMesh&&(this.mesh[t].geometry.boundingSphere.radius=e)}setLevel(e){this.haveLOD&&this.lod!==e&&(this.lod=e,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let e in this.mesh)this.mesh[e].visible=!1}setVisible(e,t){"string"==typeof e&&(e=[e]);let i,s=e.length;for(;s--;)i=e[s],this.mesh[i]&&(this.mesh[i].visible=t)}setMorph(e,t){t=t<0?0:t,this.haveMorph&&(this.morpher("eyelash",e,t),this.morpher("eyebrow",e,t),this.morpher("tear",e,t),this.morpher("mouth",e,t),this.morpher("body",e,t),this.morpher("Head",e,t),this.morpher("body_low",e,t))}morpher(e,t,i){this.mesh[e]&&this.mesh[e].morphTargetInfluences&&void 0!==this.mesh[e].morphTargetDictionary[t]&&(this.mesh[e].morphTargetInfluences[this.mesh[e].morphTargetDictionary[t]]=i)}lerp(e,t,i){return(1-i)*e+i*t}clone(e){return new this.constructor({type:e.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(e){if(!this.haveMorph)return;e&&(this.bodyMorph=e);let t=Number(this.bodyMorph[0]),i=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",i<0?-i:0),this.setMorph("LOW",i>=0?i:0),this.setMorph("BIG",t<0?-t:0),this.setMorph("MONSTER",t>=0?t:0);let s=.5*(t+1),a=1-.5*(i+1);this.setMaterialNormal(.5*(a+s))}setFaceMorph(e){if(!this.haveMorph)return;e&&(this.faceMorph=e);let t=Number(this.faceMorph[0]),i=Number(this.faceMorph[1]);this.setMorph("Shock",i<0?-i:0),this.setMorph("Frown",i>=0?i:0),this.setMorph("SmileOpen",t<0?-t:0),this.setMorph("Angry",t>=0?t:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new Ot(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new ro(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(e,t){e.matrix=t.matrixWorld,e.matrixAutoUpdate=!1}loadAnimationJson(e,t){const i=new XMLHttpRequest;i.open("GET",e,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){let e=JSON.parse(i.responseText);this.urls=[];for(let t in e)"main"===t?this.urls.push(...e[t]):this.urls.push(...e[t].map((e=>t+"/"+e)));this.endCallback=t||function(){},this.loadOne()}}.bind(this),i.send()}loadOne(){let e=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+e+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(e="./assets/models/animations.bin"){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer";const i={animations:[]},s=this;t.onload=function(){to.decompress(t.response,(e=>{const t=JSON.parse(e);for(let e in t)i.animations.push(Ke.parse(t[e]));s.applydAnimation(i),s.start()}))},t.send()}loadAnimationGlb(e,t){let i=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));so.loaderGLTF().load(e,function(e){this.applydAnimation(e,i),t&&t()}.bind(this),null,t)}directGlb(e,t){so.loaderGLTF().parse(e,"",function(e){this.stop(),this.applydAnimation(e,t)}.bind(this))}loadAnimationFbx(e,t){let i=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));so.loaderFBX().load(e,function(e){this.convertFbx(i,e.animations[0]),t&&t()}.bind(this),null,t)}directFbx(e,t){try{let i=so.loaderFBX().parse(e,"");this.convertFbx(t,i.animations[0],!0)}catch(e){console.error("bug",e)}}applydAnimation(e,t){let i=e.animations.length,s=!1;for(1===i&&(t&&(e.animations[0].name=t),s=!0);i--;)this.addClip(e.animations[i]),this.addAction(e.animations[i],s)}addClip(e,t=!1){t&&qt.makeClipAdditive(e);let i=so.clip.length,s=-1;for(;i--;)so.clip[i].name===e.name&&(s=i);-1!==s&&so.clip.slice(s,1),so.clip.push(e)}addAction(e,t){const i=this.mixer.clipAction(e);i.frameMax=Math.round(30*e.duration),i.play(),i.enabled=!0,-1!==e.name.search("idle")&&(i.enabled=!0),"Jumping Up"===e.name&&(i.loop=LoopPingPong),this.actions.set(e.name,i),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(e=!1,t=!1){let i=[],s=0;if(t){let t=so.clip.length;for(;t--;)i[s]=e?so.clip[s].toJSON():so.clip[s],s++}else this.actions.forEach((function(t,a){i[s]=e?t._clip.toJSON():t._clip,s++}));return i}exportAnimationLzma(e){this.lzma||(this.lzma=new to(this.lzmaPath));const t=this.getAnimation(!0);this.lzma.compress(JSON.stringify(t),2,(function(t){if(e)e({name:"animations",data:new Uint8Array(t),type:"bin"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"application/octet-stream"})),e.download="animations.bin",e.click()}}))}armAngle(){}autoToes(){if(!this.fixToe)return;let e=this.getRot("rFoot"),t=this.getRot("lFoot"),i=this.getWorldPos("hip"),s=this.getWorldPos("rToes"),a=this.getWorldPos("lToes");e[0]>0&&s.z-i.z<0?this.setRot("rToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("rToes",0,0,0),t[0]>0&&a.z-i.z<0?this.setRot("lToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(e,t,i){const s=Math.PI/180;let a=new W,r=new Y,n=(new Y).setFromAxisAngle({x:1,y:0,z:0},90*s);const o=t.tracks,l=[];let h,c,A,u,d=o.length,p=0;for(;d--;){if(A=o[p],u=A.name.substring(0,A.name.lastIndexOf(".")),"hip.position"===A.name){let e=[];for(h=A.values.length/3;h--;)c=3*h,a.set(A.values[c],A.values[c+1],0).multiplyScalar(.01),a.toArray(e,c);l.push(new Ze(A.name,A.times,e))}else{let e=[];for(h=A.values.length/4;h--;)c=4*h,"hip"===u?r.set(A.values[c],A.values[c+1],A.values[c+2],A.values[c+3]).multiply(n):r.set(A.values[c],A.values[c+2],-A.values[c+1],A.values[c+3]),r.toArray(e,c);l.push(new et(A.name,A.times,e))}p++}let g=new Ke(e,-1,l);g.duration=t.duration,this.stop(),this.addClip(g),this.addAction(g,i)}makePoseTrack(e,t,i=!1){const s=Math.PI/180;let a=new Y;const r=t,n=[];let o,l,h,c,A=r.length,u=0;for(;A--;){c=r[A],c.name;let e=[],t=[];for(u=0,o=3;o--;)l=0,h=4*u,t.push(.03333333507180214*u),a.setFromEuler({_x:c.values[0]*s,_y:c.values[1]*s,_z:c.values[2]*s,_order:"XYZ"}),a.toArray(e,h),u++;n.push(new et(c.name+".quaternion",t,e))}let d=new Ke(e,-1,n,i?jt:Ht);d.duration=.10000000521540642;const p=this.mixer.clipAction(d);p.enabled=!0,p.setEffectiveTimeScale(1),p.setEffectiveWeight(1),p.play(),this.actionPose=p}prepareCrossFade(e,t,i){this.isPause=!1,this.unPause(),"idle"!==t._clip.name?this.executeCrossFade(e,t,i):this.synchronizeCrossFade(e,t,i)}synchronizeCrossFade(e,t,i){this.mixer.addEventListener("loop",(function a(r){r.action===e&&(s.mixer.removeEventListener("loop",a),s.executeCrossFade(e,t,i))}));const s=this}executeCrossFade(e,t,i,s=!0){this.setWeight(t,1),t.time=0,e.crossFadeTo(t,i,!0)}pause(){this.actions.forEach((function(e){e.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(e){e.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(e){e.play()}))}setTimescale(e){this.actions.forEach((function(t){t.setEffectiveTimeScale(e)}))}syncro(e){let t=this.getAction(e);if(!t)return;let i=t.time;this.actions.forEach((function(e){e.time=i}))}setWeight(e,t){e.enabled=!0,t<0&&(t=0),t>1&&(t=1),e.setEffectiveWeight(t)}getAnimInfo(e){let t=this.getAction(e);if(t)return{name:e,time:t.time,frame:Math.round(30*t.time),frameMax:t.frameMax,timeScale:t.timeScale}}getAction(e){return this.actions.get(e)}play(e,t=.5){let i=this.getAction(e);if(!i)return!1;if(this.current){if(this.current!==i){this.old=this.current,this.current=i;let s="idle"===this.current.getClip().name;s="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(e)?this.fixToe=!0:this.resetToes();let a=this.old.getEffectiveWeight(),r=this.current.getEffectiveWeight(),n=this.current.time;if(!s){let e=this.current.getClip().duration/this.old.getClip().duration;n=this.old.time*e}this.current.reset(),this.current.time=n,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(t,a,0),this.current._scheduleFading(t,r,1)):this.executeCrossFade(this.old,this.current,t)}}else this.stop(),this.current=i,i.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(e,t,i=1){let s=this.getAction(e);s&&(s.time=t*fo,s.setEffectiveWeight(i),s.play(),s.paused=!0,this.isPause=!0)}playOne(e,t=1){this.current&&(this.current.time=e*fo,this.current.setEffectiveWeight(t),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(e){e.setEffectiveWeight(0)}))}setRot(e,t,i,s){let a=this.bones[e];a&&(a.rotation.set(t*bo,i*bo,s*bo,"XYZ"),a.updateMatrix())}setRot2(e,t,i,s){let a=this.bones[e];if(!a)return;let r=(new Y).setFromEuler({_x:t*yo,_y:i*yo,_z:s*yo,_order:"XYZ"}).invert();a.quaternion.premultiply(r),a.updateMatrix()}getRot(e){let t=this.bones[e];if(!t)return;let i=t.rotation.toArray();return[Math.round(i[0]*yo),Math.round(i[1]*yo),Math.round(i[2]*yo)]}getWorldPos(e){let t=this.bones[e];if(t)return wo.set(0,0,0),t.localToWorld(wo),{x:wo.x,y:wo.y,z:wo.z}}bodyMask(e={arm:!0,leg:!0,foot:!0,chest:!0}){let t=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const i=this.canvas.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,256,256),i.fillStyle="black",e.arm&&i.fillRect(196,112,59,46.5),e.leg&&i.fillRect(128,183.5,71.75,72.5),e.foot&&i.fillRect(817*t,205.5,51.5,50),e.chest&&(i.fillRect(120,144,75,40),i.fillRect(553*t,116.5,57,27.5),i.fillRect(533*t,531*t,5,45*t));let s=new Image;s.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new Ye(s),this.mask.flipY=!1,this.mask.needsUpdate=!0;const a=so.getMaterial("skin");a.alphaTest=.9,a.alphaMap=this.mask}zeroColor(e){e.isMesh&&(e=e.geometry);let t=e.attributes.position.array.length;e.setAttribute("color",new s(new Array(t).fill(0),3))}}class Co extends ie{constructor(e={},t){super(),this.motor=t,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=e.useImpulse||!1,this.useFloating=e.floating||!1,this.waitRotation=!1;let i=.3,s=e.radius||.3,a=e.height||1.8;this.realHeight=a,this.useFloating&&(a-=i),this.option={debug:!1,capsuleHalfHeight:.5*a,capsuleRadius:s,floatHeight:i,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-a,z:0},rayHitForgiveness:.1,rayLength:s+2,rayDir:{x:0,y:-1,z:0},floatingDis:s+i+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:s-.03,slopeRayLength:s+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new W,movingObjectVelocity:new W,standingForcePoint:new W,pivotPosition:new W,modelQuat:new Y,moveImpulse:new W,impulseCenter:new W,movingDirection:new W,moveAccNeeded:new W,jumpVelocityVec:new W,jumpDirection:new W,currentVel:new W,currentPos:new W,dragForce:new W,dragAngForce:new W,wantToMoveVel:new W,rejectVel:new W,floatingForce:null,springDirVec:new W,rayOrigin:new W,characterMassForce:new W,slopeAngle:null,actualSlopeNormal:new W,actualSlopeAngle:null,actualSlopeNormalVec:new W,floorNormal:new W(0,1,0),slopeRayOriginRef:new W,slopeRayorigin:new W,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.type="character",this.name=e.name||"hero",e.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=s,this.height=a,this.mass=e.mass||.84,delete e.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.velocity=new W,this.angular=new W,this.tmpV1=new W,this.tmpV2=new W,this.ease=new W,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(e.angle||0)*ri,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=e.ray||!1,this.callback=e.callback||function(){},e.callback&&delete e.callback,this.initPhysic(e)}setHeight(e){this.model&&this.model.setRealSize(e)}reSizePhysics(e){if(e===this.realHeight)return;this.realHeight=e,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let t=this.position.toArray();t[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let i=[this.radius,this.height-2*this.radius];this.phyData.pos=t,this.phyData.size=i,this.motor.post({m:"add",o:this.phyData})}initPhysic(e){e.size||(e.size=[this.radius,this.height-2*this.radius]),e.pos||(e.pos=[0,0,0]),e.pos[1]+=.5*this.height,this.useFloating&&(e.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.getGeometryRef({...e,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:e.size,pos:e.pos,type:"character",shapeType:e.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==e.friction?e.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:e.massInfo},"HAVOK"===this.motor.engine&&(this.phyData.inertia=[0,0,0]),e.mask&&(this.phyData.mask=e.mask),this.motor.getCharacterRef().addToWorld(this,e.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),e.gender?this.addModel(e):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(e){e.hit?(this.distance=e.distance,this.rayAngle=e.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(e){this.contact=e}showHelper(e){e?this.helper||(this.helper=new Xi(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=e)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Fs(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(e=!1){this.skeletonBody&&this.skeletonBody.isVisible(e),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:e,opacity:e?.8:1},!e),this.showHelper(e)}setMode(e){this.skeletonBody&&this.skeletonBody.setMode(e)}addModel(e){this.model=new Eo({type:e.gender,anim:void 0!==e.anim?e.anim:"idle",compact:!0,material:!e.noMat,morph:e.morph||!1,randomMorph:e.randomMorph||!1,randomSize:e.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:e.noLOD||!1}),this.add(this.model);let t=-.5*this.height;this.useFloating&&(t-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+t,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(e,t){this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.velocity.fromArray(e,t+8),this.angular.fromArray(e,t+11),this.fall=this.position.y<this.oy,this.floor=ci.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const e=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let t=this.tmpV1.distanceTo(this.tmpV2)/e.zoom>3?0:1;this.model.setLevel(t)}set(e){e.morph&&this.model&&this.model.setMorph(e.morph,e.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper()}onFrame(e,t){this.v,this.option}autoBalance(){const e=this.v,t=this.option,i=this.rotation;e.dragAngForce.set(-t.autoBalanceSpringK*i.x-this.angular.x*t.autoBalanceDampingC,-t.autoBalanceSpringK*i.y-this.angular.y*t.autoBalanceDampingOnY,-t.autoBalanceSpringK*i.z-this.angular.z*t.autoBalanceDampingC)}moveCharacter(e,t=0){const i=this.v,s=this.option,a=this.motor.getKey();this.motor.getAzimut(),i.currentPos.copy(this.position),i.slopeAngle=0,i.actualSlopeAngle<s.slopeMaxAngle&&Math.abs(i.slopeAngle)>.2&&Math.abs(i.slopeAngle)<s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle),Math.cos(i.slopeAngle)):i.actualSlopeAngle>=s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle)>0?0:Math.sin(i.slopeAngle),Math.sin(i.slopeAngle)>0?.1:1):i.movingDirection.set(0,0,1),i.movingDirection.applyAxisAngle({x:0,y:1,z:0},t),i.movingObjectVelocityInCharacterDir.copy(i.movingObjectVelocity).projectOnVector(i.movingDirection).multiply(i.movingDirection);const r=i.movingObjectVelocity.angleTo(i.movingDirection),n=i.currentVel.dot(i.movingDirection);i.wantToMoveVel.set(i.movingDirection.x*n,0,i.movingDirection.z*n),i.rejectVel.copy(i.currentVel).sub(i.wantToMoveVel),i.moveAccNeeded.set((i.movingDirection.x*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.x)-(i.currentVel.x-i.movingObjectVelocity.x*Math.sin(r)+i.rejectVel.x*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime,0,(i.movingDirection.z*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.z)-(i.currentVel.z-i.movingObjectVelocity.z*Math.sin(r)+i.rejectVel.z*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime);const o=i.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(t).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?i.moveImpulse.set(o.x*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),o.z*(i.canJump?1:s.airDragMultiplier)):i.moveImpulse.set(o.x*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*s.turnVelMultiplier*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),o.z*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier)),i.impulseCenter.set(i.currentPos.x,i.currentPos.y+s.moveImpulsePointY,i.currentPos.z),i.currentVel.copy(this.velocity),a[4]&&i.canJump&&(i.jumpVelocityVec.set(i.currentVel.x,this.running?s.sprintJumpMult*s.jumpVel:s.jumpVel,i.currentVel.z),i.moveImpulse.y=i.jumpVelocityVec.y)}getFloating(){const e=this.v,t=this.option,i=t.springK*(t.floatingDis-this.distance)-this.velocity.y*t.dampingC;e.moveImpulse.y=i*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const e=this.motor.getKey(),t=this.motor.getAzimut(),i=this.motor.delta;let s=0!==e[7]?"run":"walk";0===e[0]&&0===e[1]&&(s="idle");let a=0!==e[0]&&0!==e[1]?this.diagonal:1;e[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===e[5]&&(this.toggle=!0),"walk"!==s&&"run"!==s||!this.crouch||(s="crouch"),1===e[6]&&(s="fight"),!this.jump&&e[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(s){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}this.moving=0!==e[0]||0!==e[1],this.running=0!==e[7],this.wantJump=0!==e[4];let n=ci.unwrapRad(Math.atan2(e[0],e[1])+t);if(this.useImpulse)this.moving?this.moveCharacter(i,n):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*i;const r=1;let n=this.speed[s]*r;this.moving&&(this.rs=e[0]*n,this.ts=e[1]*n),0===e[0]&&0===e[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*a),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let o=this.vy-9.81;this.ease.y=o,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},t),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=t,"idle"!==s&&this.helper.setDirection(n)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(r,.75),"idle"!==s)){let e=ci.unwrapRad(this.model.rotation.y),i=ci.nearAngle(n,e),a=Math.abs(Math.floor((e-i)*math.todeg)/180);this.model.rotation.y="fight"===s?t+Math.PI:ci.lerp(e,i,.2-.1*a),this.model.updateMatrix()}}}class vo extends Fi{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="character",this.num=yi[this.type]}step(e,t){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=t+a*this.num,s&&s.step(e,i)}add(e={}){this.setName(e);return new Co(e,this.motor)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}const Bo={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),toFixed:(e,t=3)=>1*e.toFixed(t),int:e=>Math.floor(e),lerp:(e,t,i)=>(1-i)*e+i*t,clamp:(e,t,i)=>Math.max(t,Math.min(i,e)),nearEquals:(e,t,i)=>Math.abs(e-t)<=i,lerpAr:(e,t,i,s)=>{let a=e.length;for(;a--;)e[a]=Bo.lerp(t[a],i[a],s)},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),scaleArray:(e,t)=>{for(var i=e.length;i--;)e[i]*=t;return e},addArray:(e,t)=>{for(var i=[],s=e.length;s--;)i[s]=e[s]+t[s];return i},angleDistance:(e,t)=>{var i=(e-t+180)%360-180;return i<-180?i+360:i},tmpE:new ge,tmpM:new J,tmpM2:new J,tmpV:new W,tmpQ:new Y,fromTransformToQ:(e,t,i)=>(i=i||!1,Bo.tmpM.compose(Bo.tmpV.fromArray(e),Bo.tmpQ.fromArray(t),{x:1,y:1,z:1}),Bo.tmpM.decompose(Bo.tmpV,Bo.tmpQ,{x:1,y:1,z:1}),i&&Bo.tmpQ.invert(),Bo.tmpQ.toArray()),fromTransform:(e,t,i,s,a)=>(a=a||!1,s=s||[0,0,0,1],Bo.tmpM.compose(Bo.tmpV.fromArray(e),Bo.tmpQ.fromArray(t),{x:1,y:1,z:1}),Bo.tmpM2.compose(Bo.tmpV.fromArray(i),Bo.tmpQ.fromArray(s),{x:1,y:1,z:1}),a?(Bo.tmpM.invert(),Bo.tmpM.multiply(Bo.tmpM2)):Bo.tmpM.multiply(Bo.tmpM2),Bo.tmpM.decompose(Bo.tmpV,Bo.tmpQ,{x:1,y:1,z:1}),Bo.tmpV.toArray()),arCopy:(e,t)=>{},axisToQuatArray:(e,t)=>(t=t||!1,Bo.tmpQ.setFromAxisAngle(Bo.tmpV.fromArray(e,1),t?e[0]*Bo.torad:e[0]).normalize().toArray()),toQuatArray:e=>Bo.tmpQ.setFromEuler(Bo.tmpE.fromArray(Bo.vectorad(e))).toArray(),vectorad:e=>{let t=3,i=[];for(;t--;)i[t]=e[t]*Bo.torad;return i[3]=e[3],i},rgbToHex:e=>"0x"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]).toString(16)).slice(-6),hexToRgb:e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255],htmlToHex:e=>e.toUpperCase().replace("#","0x"),hexToHtml:e=>"#"+("000000"+(e=void 0===e?0:e).toString(16)).substr(-6),rgbToHtml:e=>"#"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==Bo.perlin&&(Bo.perlin=null)},noise:(e,t)=>{null===Bo.perlin&&(Bo.perlin=new xo);let i,s,a=(t=t||{}).level||[1,.2,.05],r=t.frequency||[.016,.05,.2],n=0,o=0;for(i=0;i<a.length;i++)s=r[i],n+=a[i]*(.5+.5*Bo.perlin.noise3d(e.x*s,e.y*s,e.z*s)),o+=a[i];return n/=o,n}};class xo{constructor(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,i){return e[0]*t+e[1]*i}dot3(e,t,i,s){return e[0]*t+e[1]*i+e[2]*s}dot4(e,t,i,s,a){return e[0]*t+e[1]*i+e[2]*s+e[3]*a}noise(e,t){var i,s,a=(e+t)*(.5*(Math.sqrt(3)-1)),r=Math.floor(e+a),n=Math.floor(t+a),o=(3-Math.sqrt(3))/6,l=(r+n)*o,h=e-(r-l),c=t-(n-l);h>c?(i=1,s=0):(i=0,s=1);var A=h-i+o,u=c-s+o,d=h-1+2*o,p=c-1+2*o,g=255&r,m=255&n,f=this.perm[g+this.perm[m]]%12,b=this.perm[g+i+this.perm[m+s]]%12,y=this.perm[g+1+this.perm[m+1]]%12,w=.5-h*h-c*c,I=.5-A*A-u*u,E=.5-d*d-p*p;return 70*((w<0?0:(w*=w)*w*this.dot(this.grad3[f],h,c))+(I<0?0:(I*=I)*I*this.dot(this.grad3[b],A,u))+(E<0?0:(E*=E)*E*this.dot(this.grad3[y],d,p)))}noise3d(e,t,i){var s,a,r,n,o,l,h=(e+t+i)*(1/3),c=Math.floor(e+h),A=Math.floor(t+h),u=Math.floor(i+h),d=1/6,p=(c+A+u)*d,g=e-(c-p),m=t-(A-p),f=i-(u-p);g>=m?m>=f?(s=1,a=0,r=0,n=1,o=1,l=0):g>=f?(s=1,a=0,r=0,n=1,o=0,l=1):(s=0,a=0,r=1,n=1,o=0,l=1):m<f?(s=0,a=0,r=1,n=0,o=1,l=1):g<f?(s=0,a=1,r=0,n=0,o=1,l=1):(s=0,a=1,r=0,n=1,o=1,l=0);var b=g-s+d,y=m-a+d,w=f-r+d,I=g-n+2*d,E=m-o+2*d,C=f-l+2*d,v=g-1+.5,B=m-1+.5,x=f-1+.5,k=255&c,Q=255&A,S=255&u,M=this.perm[k+this.perm[Q+this.perm[S]]]%12,R=this.perm[k+s+this.perm[Q+a+this.perm[S+r]]]%12,D=this.perm[k+n+this.perm[Q+o+this.perm[S+l]]]%12,T=this.perm[k+1+this.perm[Q+1+this.perm[S+1]]]%12,F=.6-g*g-m*m-f*f,L=.6-b*b-y*y-w*w,P=.6-I*I-E*E-C*C,_=.6-v*v-B*B-x*x;return 32*((F<0?0:(F*=F)*F*this.dot3(this.grad3[M],g,m,f))+(L<0?0:(L*=L)*L*this.dot3(this.grad3[R],b,y,w))+(P<0?0:(P*=P)*P*this.dot3(this.grad3[D],I,E,C))+(_<0?0:(_*=_)*_*this.dot3(this.grad3[T],v,B,x)))}noise4d(e,t,i,s){var a,r,n,o,l,h,c,A,u,d,p,g,m=this.grad4,f=this.simplex,b=this.perm,y=(Math.sqrt(5)-1)/4,w=(5-Math.sqrt(5))/20,I=(e+t+i+s)*y,E=Math.floor(e+I),C=Math.floor(t+I),v=Math.floor(i+I),B=Math.floor(s+I),x=(E+C+v+B)*w,k=e-(E-x),Q=t-(C-x),S=i-(v-x),M=s-(B-x),R=(k>Q?32:0)+(k>S?16:0)+(Q>S?8:0)+(k>M?4:0)+(Q>M?2:0)+(S>M?1:0),D=k-(a=f[R][0]>=3?1:0)+w,T=Q-(r=f[R][1]>=3?1:0)+w,F=S-(n=f[R][2]>=3?1:0)+w,L=M-(o=f[R][3]>=3?1:0)+w,P=k-(l=f[R][0]>=2?1:0)+2*w,_=Q-(h=f[R][1]>=2?1:0)+2*w,z=S-(c=f[R][2]>=2?1:0)+2*w,U=M-(A=f[R][3]>=2?1:0)+2*w,N=k-(u=f[R][0]>=1?1:0)+3*w,G=Q-(d=f[R][1]>=1?1:0)+3*w,O=S-(p=f[R][2]>=1?1:0)+3*w,q=M-(g=f[R][3]>=1?1:0)+3*w,j=k-1+4*w,H=Q-1+4*w,V=S-1+4*w,K=M-1+4*w,W=255&E,J=255&C,X=255&v,Y=255&B,Z=b[W+b[J+b[X+b[Y]]]]%32,$=b[W+a+b[J+r+b[X+n+b[Y+o]]]]%32,ee=b[W+l+b[J+h+b[X+c+b[Y+A]]]]%32,te=b[W+u+b[J+d+b[X+p+b[Y+g]]]]%32,ie=b[W+1+b[J+1+b[X+1+b[Y+1]]]]%32,se=.6-k*k-Q*Q-S*S-M*M,ae=.6-D*D-T*T-F*F-L*L,re=.6-P*P-_*_-z*z-U*U,ne=.6-N*N-G*G-O*O-q*q,oe=.6-j*j-H*H-V*V-K*K;return 27*((se<0?0:(se*=se)*se*this.dot4(m[Z],k,Q,S,M))+(ae<0?0:(ae*=ae)*ae*this.dot4(m[$],D,T,F,L))+(re<0?0:(re*=re)*re*this.dot4(m[ee],P,_,z,U))+(ne<0?0:(ne*=ne)*ne*this.dot4(m[te],N,G,O,q))+(oe<0?0:(oe*=oe)*oe*this.dot4(m[ie],j,H,V,K)))}}class ko extends Z{constructor(e={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=e.name,this.folder=e.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=e.terrainType||"terrain",this.callback=e.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[e.uv||18,e.uv||18],this.sample=null==e.sample?[128,128]:e.sample,this.size=void 0===e.size?[100,30,100]:e.size;let t=this.sample[0]-1,s=this.sample[1]-1;this.rx=t/this.size[0],this.rz=s/this.size[2],this.zone=e.zone||1;let a=[this.size[0]/t,this.size[2]/s];this.sampleZ=[e.sample[0]*this.zone,e.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*a[0],e.size[1],(this.sampleZ[1]-1)*a[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:e.level||[1,.2,.05],frequency:e.frequency||[.016,.05,.2],expo:e.expo||1},this.isWater=e.water||!1,this.isIsland=e.island||!1,this.isBorder=!1,this.wantBorder=e.border||!1,this.isBottom=!1,this.wantBottom=e.bottom||!1,this.wantBorder=e.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=e.maxSpeed||.1,this.acc=null==e.acc?.01:e.acc,this.dec=null==e.dec?.01:e.dec,this.deep=null==e.deep?0:e.deep,this.ease=new g,this.complexity=null==e.complexity?30:e.complexity,this.complexity2=null==e.complexity2?null:e.complexity2,this.local=new W,e.local&&this.local.fromArray(e.local),this.pp=new W,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=e.is64||!1,this.isTurn=e.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=e.isAbsolute||!1,this.isTurned=e.isTurned||!1,this.isReverse=e.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new h(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-Bo.PI90),this.geometry.setAttribute("color",new i(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var r=new Y(.5,.5,.1,.2);e.maplevels&&r.fromArray(e.maplevels);var n,o=Qo,l=e.maps||["sand","grass3","rock"],c={};this.isWater&&(l=["water"]);for(let t in l)n=l[t],c[n+"_c"]=so.texture({url:this.folder+n+"_c.jpg",flip:!1,repeat:this.uvx,encoding:e.encoding||!0,callback:this.mapcallback.bind(this)}),c[n+"_n"]=so.texture({url:this.folder+n+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});c.noise=so.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=c,this.material=new d({name:"terrain",vertexColors:!0,color:16777215,map:c[l[0]+"_c"],normalMap:c[l[0]+"_n"]}),void 0!==e.envmap&&(this.material.envMap=e.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=e.opacity||.4,this.material.side=C,this.material.alphaMap=c[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=e.metalness||0,this.material.roughness=e.roughness||.3);var A=e.nScale||.5;if(this.material.normalScale.set(A,-A),this.isWater)this.material.onBeforeCompile=function(e){var t=e.fragmentShader;t=t.replace("#include <alphamap_fragment>",o.alphamap),e.fragmentShader=t};else{let e=this;this.material.onBeforeCompile=function(t){let i=t.uniforms;i.clevels={value:r},i.map1={value:c[l[1]+"_c"]},i.map2={value:c[l[2]+"_c"]},i.randomUv={value:1},i.normalMap1={value:c[l[1]+"_n"]},i.normalMap2={value:c[l[2]+"_n"]},i.noiseMap={value:c.noise},i.useNoiseMap={value:1},t.uniforms=i;let s=t.fragmentShader;s=s.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+So+o.fragmentAdd),s=s.replace("#include <map_fragment>",o.map),s=s.replace("#include <normal_fragment_maps>",o.normal),s=s.replace("#include <color_fragment>",""),t.fragmentShader=s,e.material.userData.shader=t},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(e){this.userData.shader.uniforms.randomUv.value=e?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(e){this.userData.shader.uniforms.map1.value=e}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(e){this.userData.shader.uniforms.map2.value=e}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(e){this.userData.shader.uniforms.normalMap1.value=e}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(e){this.userData.shader.uniforms.normalMap2.value=e}})}e.debug&&this.debugZone(e),this.wantBorder&&this.addBorder(e),this.wantBottom&&this.addBottom(e),e.pos&&this.position.fromArray(e.pos),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=Bo.toQuatArray(e.rot),delete e.rot),this.quaternion.fromArray(e.quat),e.decal&&(this.position.y+=e.decal),this.castShadow=!0,this.receiveShadow=!0,so.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let e=.5*(this.sample[0]-this.sampleZ[0]),t=.5*(this.sample[1]-this.sampleZ[1]),i=this.sample[0]*t+e,s=0;for(let t=0;t<this.lngZ;t++)s=Math.floor(t/this.sampleZ[0]),this.zid[i+t+s*(2*e)]=t}debugZone(e){this.geometryZ=new h(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-Bo.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const t=new Z(this.geometryZ,new w({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(t)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(e){var t=new h(this.size[0],this.size[2],1,1);t.rotateX(Bo.PI90),this.bottomMesh=new Z(t,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(e){this.borderMaterial=new f({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?e.opacity||.8:1,envMap:e.envmap||null});var t=new h(this.size[0],2,this.sample[0]-1,1),s=new h(this.size[0],2,this.sample[0]-1,1),a=new h(this.size[2],2,this.sample[1]-1,1),r=new h(this.size[2],2,this.sample[1]-1,1);t.translate(0,1,.5*this.size[2]),s.rotateY(-Bo.Pi),s.translate(0,1,.5*-this.size[2]),a.rotateY(-Bo.PI90),a.translate(.5*-this.size[0],1,0),r.rotateY(Bo.PI90),r.translate(.5*this.size[0],1,0),this.borderGeometry=ms(ps([t,s,a,r])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new i(this.borderColors,3)),this.borderMesh=new Z(this.borderGeometry,this.borderMaterial);for(var n,o,l=this.lng2;l--;)n=3*l,o=this.borderVertices[n+1]>0?this.findPoint(this.borderVertices[n],this.borderVertices[n+2]):-1,this.list[l]=o;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let e in this.txt)this.txt[e].dispose()}easing(e,t,i){if(0!==e[0]||0!==e[1]){var s=t||0;e[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=e[1]*this.acc,this.ease.x+=e[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,e[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),e[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(i))}}getTri(){return this.geometry}getHeight(e,t){return e*=this.rx,t*=this.rz,e+=.5*this.sample[0],t+=.5*this.sample[1],e=Math.floor(e),t=Math.floor(t),(this.isTurn?this.height[this.findId2(e,t)]:this.height[this.findId(e,t)])*this.size[1]+this.position.y}findIdZ(e,t){return e+t*this.sampleZ[1]}findId(e,t){return e+t*this.sample[1]}findId2(e,t){return t+-e*this.sample[0]||1}findPoint(e,t){for(var i,s=this.lng;s--;)if(i=3*s,this.vertices[i]===e&&this.vertices[i+2]===t)return s;return-1}getReverseID(){this.invId=[];let e,t,i=this.lngZ;const s=this.sampleZ[1]-1;for(this.sampleZ[0];i--;)e=i%this.sampleZ[0],t=Math.floor(i*this.ratioZ),this.isReverse&&(t=s-t),this.invId[i]=this.isTurned?this.lngZ-1-this.findIdZ(t,e):this.findIdZ(e,t)}set(e){e.ease&&this.easing(e.key,e.azimut),e.decal&&this.decal(e.decal,!0)}decal(e,t){this.local.x+=e[0],this.local.y+=e[1],this.local.z+=e[2],this.update(t)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let e={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(e),this.material.normalMap&&this.material.normalMap.offset.copy(e)}}distance(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}clamp(e,t=0,i=1){return e=(e=e<t?t:e)>i?i:e}update(e){let t,i,s,a,r,n,o,l,h,c,A,u=this.pp,d=[1,1,1],p=this.lng;for(;p--;){if(t=3*p,i=p%this.sample[0],s=Math.floor(p*this.ratio),u.set(i+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),a=Bo.noise(u,this.data),this.isIsland){let e=1-this.distance({x:i,y:s},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));e*=4,e=this.clamp(e),a*=e}a=Math.pow(a,this.data.expo),a=this.clamp(a),"road"===this.ttype&&(l===s?a=1===i||2===i||29===i||30===i?h+.1:h:(l=s,h=a)),this.height[p]=a,c=a*this.size[1]+this.deep,this.vertices[t+1]=c,n=this.isAbsolute?a:a*this.size[1],void 0!==this.zid[p]&&(o=this.zid[p],r=this.changeId?this.invId[o]:o,this.heightData[r]=n,this.verticesZ&&(this.verticesZ[3*o+1]=c)),d=this.isWater?[a*this.colorBase.r,a*this.colorBase.g,a*this.colorBase.b]:[a,0,0],A=d[0],this.colors[t]=A,this.colors[t+1]=A,this.colors[t+2]=A}if(this.isBorder){let e,i=this.lng2;for(;i--;)t=3*i,-1!==this.list[i]?(e=this.height[this.list[i]],this.borderVertices[t+1]=e*this.size[1]+this.deep,A=Bo.clamp(e+.25,.25,1),this.borderColors[t]=A,this.borderColors[t+1]=A,this.borderColors[t+2]=A):(this.borderColors[t]=this.colorBase.r,this.borderColors[t+1]=this.colorBase.g,this.borderColors[t+2]=this.colorBase.b)}e?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(e){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const Qo={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "},So="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n";let Mo=null;class Ro extends Fi{constructor(e){super(),this.motor=e,this.engine=this.motor.engine,this.Utils=this.motor.utils,Mo=this.motor.mat,this.type="terrain",this.num=yi[this.type]}step(e,t){let i,s=this.list.length;for(;s--;)i=this.list[s],i.step()}add(e={}){this.setName(e),"JOLT"===this.engine&&(e.isAbsolute=!0,e.isTurned=!1),"PHYSX"===this.engine&&(e.isAbsolute=!0,e.isTurned=!0),"HAVOK"===this.engine&&(e.isAbsolute=!0,e.isTurned=!0),"OIMO"!==this.engine&&(e.zone=e.zone||.25);const t=new ko(e);return Mo.extendShader(t.material,t.material.onBeforeCompile),t.physicsUpdate=(e,t)=>{this.motor.flow.tmp.push({name:e,heightData:t})},this.addToWorld(t,e.id),this.motor.post({m:"add",o:Do(t,this.engine)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}const Do=function(e,t){const i={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===t?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===t||"AMMO"===t||"HAVOK"===t||"JOLT"===t?(i.type="terrain",i.size=e.sizeZ,i.sample=e.sampleZ,i.zone=e.zone,i.heightData=e.heightData):(i.type="mesh",i.v=ci.getVertex(e.geometry,"OIMO"===t),i.index="OIMO"===t?null:ci.getIndex(e.geometry)),i};class To extends Fi{constructor(e){super(),this.motor=e,this.Utils=this.motor.utils,this.type="solver"}step(e,t){let i,s=this.list.length;for(;s--;)i=t+s*yi[this.type],this.list[s].update(e,i)}add(e={}){this.setName(e);let t=new Fo(e,this.motor);return this.addToWorld(t,e.id),this.motor.post({m:"add",o:e}),t}set(e={}){}}class Fo{constructor(e,t){this.motor=t,this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(e){this.bones.push(e)}dispose(){this.motor.remove(this.bones,!0)}update(e,t){if(!this.needData)return;let i,s,a=this.joints.length;for(;a--;)s=t+7*a,i=this.joints[a],i.data.target.x=e[s+0],i.data.target.y=e[s+1],i.data.target.z=e[s+2],i.data.target.rx=e[s+3],i.data.target.ry=e[s+4],i.data.target.rz=e[s+5],i.data.target.count=e[s+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,void 0!==e.rot1&&(e.quat1=ci.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=ci.quatFromEuler(e.rot2),delete e.rot2),"fixe"!==e.type&&this.joints.push(new Lo(e,this)),this.motor.post({m:"addSolverJoint",o:e})}driveJoints(e){let t,i,s=!1,a=this.joints.length,r=[];for(;a--;)t=this.joints[a],t.update(e),i=t.isDrive,t.nup&&r.push(t.nup),s=!!i||s;s?this.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(!e)return;let i=this.joints.length;for(;i--;)this.joints[i].pose(void 0!==e[i]?e[i]:0,void 0!==t?t:this.speed);return new Promise((e=>this.resolve=e))}}class Lo{constructor(e,t){if(this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},e.limits&&(this.driveType=e.limits[0][0],this.min=e.limits[0][1],this.max=e.limits[0][2]),e.position&&(e.target=e.position),e.target){let t,i=e.target.length;for(;i--;)t=e.target[i],this.data.target[t[0]]=t[1]}}start(){}pose(e,t){this.target=ci.clamp(e,this.min,this.max),this.current=ci.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e*this.time;let t=this.tmp;t=t>1?1:t;let i=ci.lerp(this.start,this.target,t);this.nup={name:this.name,drivesTarget:[[this.driveType,i]]},1===t&&(this.isDrive=!1)}else this.nup=null}}class Po{constructor(e){this.map=new Map,this.motor=e,this.enginReady=["PHYSX","HAVOK","OIMO"],this.rc=this.refresh.bind(this)}reset(){this.map=new Map}step(){this.map.forEach(this.rc)}refresh(e,t){let i=this.motor.reflow.contact[t];if(void 0!==i)for(let t=0,s=i.length;t<s;t++)e.userData.collisionCallback?e.userData.collisionCallback(i[t]):e.dispatchEvent({type:"collision",data:i[t]})}isReady(){return-1!==this.enginReady.indexOf(this.motor.engine)}remove(e){this.isReady()&&this.map.has(e)&&(this.map.delete(e),this.motor.post({m:"removeCollision",o:{name:e}}))}add(e){if(!this.isReady())return;let t=e.name,i=this.motor.byName(t);null!==i&&(e.vs&&e.vs.constructor!==Array&&(e.vs=[e.vs]),e.ignore&&e.ignore.constructor!==Array&&(e.ignore=[e.ignore]),e.callback&&(i.userData.collisionCallback=e.callback,delete e.callback),this.map.set(t,i),this.motor.post({m:"addCollision",o:e}))}}class _o extends Z{constructor(e={}){super(new h,new w({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=e.nam||"text",this.canvas=null,this.w=e.w||0,this.h=e.h||0,this.weight=e.weight??700,this.font=e.font??"'Mulish', sans-serif",this.fontSize=e.fontSize??32,this.backgroundColor=e.backgroundColor??"#00000000",this.fontColor=e.color??"#FFFFFF",this.material.alphaTest=.5,this.set(e.text),e.pos&&this.position.fromArray(e.pos),e.rot&&this.quaternion.fromArray(ci.quatFromEuler(e.rot))}set(e){this.canvas||(this.canvas=document.createElement("canvas"));let t,i,s,a=this.canvas.getContext("2d");a.font=this.weight+" "+this.fontSize+"px "+this.font;let r=a.measureText(e);t=2**Math.ceil(Math.log2(r.width)),i=2**Math.ceil(Math.log2(a.measureText("M").width)),this.canvas.width=t,this.canvas.height=i,a.fillStyle=this.backgroundColor,a.fillRect(0,0,t,i),a.fillStyle=this.fontColor,a.font=this.weight+" "+this.fontSize+"px "+this.font,a.textAlign="center",a.textBaseline="middle",a.fillText(e,.5*t,.5*i),this.material.map=new c(this.canvas),0!==this.h?(s=this.h/i,this.scale.set(t*s,this.h,0)):0!==this.w?(s=this.w/i,this.scale.set(this.w,i*s,0)):this.scale.set(.025*t,.025*i,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let zo=0;class Uo{constructor(e={},t){this.motor=t,this.down=!1,this.time=e.time||250,this.p=e.pos||[0,0,0],this.type=e.type||"box",this.name=e.name||"button"+zo++,this.pos=e.pos||[0,0,0],this.size=e.size||[1,1,1],this.radius=e.radius||0,this.axe=void 0!==e.axe?e.axe:1,this.fontSize=e.fontSize||.8,this.fontScale=e.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let i=this.size[this.axe]-2*this.radius;this.range=[this.origin-i,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},e.callback&&(this.callback=e.callback,delete e.callback),e.button=!0,e.pos=this.pos,e.material||(e.material="button"),e.kinematic=!0,e.mask=1,this.timeout=null,this.b=this.motor.add(e),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),e.text&&this.addText(e.text)}addText(e,t){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let i={text:e,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(i={text:e,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new _o(i),this.b.add(this.txt)}action(e){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(e||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=ci.lerp(this.value,this.target,this.speed),ci.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class No extends t{constructor(e=1,t=1,i=1,a=.01,r=1,o=1,l=1,c=2){super(),this.type="ChamferBox",r=Math.floor(r),o=Math.floor(o),l=Math.floor(l),c=Math.floor(c);let A=Math.PI,u=.5*A,d=2*a,p=.5*e,m=.5*t,f=.5*i,b=new J,y=new J,w=new J,I=a/e,E=1-2*I,C=a/t,v=1-2*I,B=a/i,x=1-2*B,k=new h(e-d,t-d,r,o),Q=new n(a,a,e-d,c,r,!0,0,u),S=new n(a,a,t-d,c,o,!0,0,u),M=new Go(a,c,c,0,u,0,-u),R=new Go(a,c,c,0,u,0,-u);Oo(k,-I,C,E,v),Oo(Q,0,I,C,E),y.makeTranslation(0,m-a,0),b.makeRotationX(u),M.applyMatrix4(y.multiply(b)),y.makeTranslation(0,-m+a,0),b.makeRotationX(u),w.makeRotationY(-u),R.applyMatrix4(y.multiply(b).multiply(w));let D=ps([S,M,R]),T=D.clone();y.makeTranslation(p-a,0,-a),D.applyMatrix4(y),y.makeTranslation(-p+a,0,-a),b.makeRotationZ(A),T.applyMatrix4(y.multiply(b));let F=Q.clone();b.makeRotationZ(u),y.makeTranslation(0,m-a,-a),Q.applyMatrix4(y.multiply(b)),y.makeTranslation(0,-m+a,-a),b.makeRotationZ(-u),F.applyMatrix4(y.multiply(b));let L=ps([Q,F,k,D,T]),P=L.clone();y.makeTranslation(0,0,f),L.applyMatrix4(y),y.makeTranslation(0,0,-f),b.makeRotationY(A),P.applyMatrix4(y.multiply(b)),k=new h(i-d,t-d,l,o),Q=new n(a,a,i-d,c,l,!0,0,u),F=Q.clone(),Oo(k,-B,C,x,v),y.makeTranslation(0,-(m-a),-a,0),b.makeRotationZ(-u),Q.applyMatrix4(y.multiply(b)),y.makeTranslation(0,m-a,-a,0),b.makeRotationZ(u),F.applyMatrix4(y.multiply(b));let _=ps([Q,F,k]),z=_.clone();y.makeTranslation(-p,0,0),b.makeRotationY(-u),_.applyMatrix4(y.multiply(b)),y.makeTranslation(p,0,0),b.makeRotationY(u),z.applyMatrix4(y.multiply(b)),k=new h(e-d,i-d,r,l),Oo(k,-I,B,E,x);let U=k.clone();y.makeTranslation(0,m,0),b.makeRotationX(-u),k.applyMatrix4(y.multiply(b)),y.makeTranslation(0,-m,0),b.makeRotationX(u),U.applyMatrix4(y.multiply(b));let N=ms(ps([L,P,_,z,k,U]));!function(e,t="sphere",i,a=[0,0,0],r=[0,0,0,1],n){void 0===n&&(n=new J);if(n.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){e.boundingBox||e.computeBoundingBox();let t=e.boundingBox;i=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z)}let o=new te(new W(-i/2,-i/2,-i/2),new W(i/2,i/2,i/2)),l=[];l.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.setAttribute("uv",new s(l,2));let h,c,A,u,d,p=function(e,t,i){e.applyMatrix4(n),t.applyMatrix4(n),i.applyMatrix4(n);let s=1/(2*Math.PI),a=1/Math.PI;return e.normalize(),t.normalize(),i.normalize(),{uv0:new g(.5-Math.atan(e.z,-e.x)*s,.5-Math.asin(e.y)*a),uv1:new g(.5-Math.atan(t.z,-t.x)*s,.5-Math.asin(t.y)*a),uv2:new g(.5-Math.atan(i.z,-i.x)*s,.5-Math.asin(i.y)*a)}},m=function(e,t,s){e.applyMatrix4(n),t.applyMatrix4(n),s.applyMatrix4(n);let a=new W;a.crossVectors(t.clone().sub(e),t.clone().sub(s)).normalize(),a.x<0||a.y<0||a.z,a.x=Math.abs(a.x),a.y=Math.abs(a.y),a.z=Math.abs(a.z);let r=new g,l=new g,h=new g,c=1/i;return a.y>a.x&&a.y>a.z?(r.set(e.x-o.min.x,o.max.z-e.z).multiplyScalar(c),l.set(t.x-o.min.x,o.max.z-t.z).multiplyScalar(c),h.set(s.x-o.min.x,o.max.z-s.z).multiplyScalar(c)):a.x>a.y&&a.x>a.z?(r.set(e.z-o.min.z,e.y-o.min.y).multiplyScalar(c),l.set(t.z-o.min.z,t.y-o.min.y).multiplyScalar(c),h.set(s.z-o.min.z,s.y-o.min.y).multiplyScalar(c)):a.z>a.y&&a.z>a.x&&(r.set(e.x-o.min.x,e.y-o.min.y).multiplyScalar(c),l.set(t.x-o.min.x,t.y-o.min.y).multiplyScalar(c),h.set(s.x-o.min.x,s.y-o.min.y).multiplyScalar(c)),{uv0:r,uv1:l,uv2:h}},f=new W,b=new W,y=new W;new W,new W,new W;const w=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(h=0;h<e.index.count;h+=3)c=e.index.getX(h+0),A=e.index.getX(h+1),u=e.index.getX(h+2),f.fromBufferAttribute(w,c),b.fromBufferAttribute(w,A),y.fromBufferAttribute(w,u),d="sphere"===t?p(f,b,y):m(f,b,y),l[2*c]=d.uv0.x,l[2*c+1]=d.uv0.y,l[2*A]=d.uv1.x,l[2*A+1]=d.uv1.y,l[2*u]=d.uv2.x,l[2*u+1]=d.uv2.y;else for(h=0;h<w.count;h+=3){f.fromBufferAttribute(w,h+0),b.fromBufferAttribute(w,h+1),y.fromBufferAttribute(w,h+2),d="sphere"===t?p(f,b,y):m(f,b,y);let e=h,i=h+1,s=h+2;l[2*e]=d.uv0.x,l[2*e+1]=d.uv0.y,l[2*i]=d.uv1.x,l[2*i+1]=d.uv1.y,l[2*s]=d.uv2.x,l[2*s+1]=d.uv2.y}e.attributes.uv.array=new Float32Array(l),e.attributes.uv.needsUpdate=!0}(N,"box"),this.copy(N)}}class Go extends t{constructor(e=1,t=8,i=6,a=0,r=2*Math.PI,n=0,o=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:a,phiLength:r,thetaStart:n,thetaLength:o},t=Math.floor(t),i=Math.floor(i);const l=Math.min(n+o,Math.PI);let h=0;const c=[],A=new W,u=new W,d=[],p=[],g=[],m=[];for(let s=0;s<=i;s++){const d=[],f=s/i;let b=0;0==s&&0==n?b=.5/t:s==i&&l==Math.PI&&(b=-.5/t);for(let i=0;i<=t;i++){const s=i/t;A.x=-e*Math.cos(a+s*r)*Math.sin(n+f*o),A.y=e*Math.cos(n+f*o),A.z=e*Math.sin(a+s*r)*Math.sin(n+f*o),p.push(A.x,A.y,A.z),u.copy(A).normalize(),g.push(u.x,u.y,u.z),m.push(s+b,1-f),d.push(h++)}c.push(d)}for(let e=0;e<i;e++)for(let s=0;s<t;s++){const t=c[e][s+1],a=c[e][s],r=c[e+1][s],o=c[e+1][s+1];(0!==e||n>0)&&d.push(t,a,o),(e!==i-1||l<Math.PI)&&d.push(a,r,o)}this.setIndex(d),this.setAttribute("position",new s(p,3)),this.setAttribute("normal",new s(g,3)),this.setAttribute("uv",new s(m,2))}}function Oo(e,t=0,i=0,s=1,a=1,r){let n=e.attributes.uv,o=n.array,l=n.count,h=0;for(;l--;)h=2*l,o[h]=o[h]*s-t,o[h+1]=o[h+1]*a+i}const qo=new te;class jo extends e{constructor(e,s=16776960){const r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24);let o=new p(s),l=[],h=8;for(;h--;)l.push(o.r,o.g,o.b);const c=new Float32Array(l),A=new t;A.setIndex(new i(r,1)),A.setAttribute("position",new i(n,3)),A.setAttribute("color",new i(c,3)),super(A,new a({vertexColors:!0,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&qo.setFromObject(this.object),qo.isEmpty())return;const t=qo.min,i=qo.max,s=this.geometry.attributes.position,a=s.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=t.x,a[4]=i.y,a[5]=i.z,a[6]=t.x,a[7]=t.y,a[8]=i.z,a[9]=i.x,a[10]=t.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=t.z,a[15]=t.x,a[16]=i.y,a[17]=t.z,a[18]=t.x,a[19]=t.y,a[20]=t.z,a[21]=i.x,a[22]=t.y,a[23]=t.z,s.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e,t){return super.copy(e,t),this.object=e.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Ho{constructor(e={},t){this.motor=t,this.isCompound=!0,this.remplace=e.remplace||!1,this.init(e)}init(e={}){const t=e.intern||!1;let i=e.size||[5,3,8],s=e.pos||[0,2,0],a=e.wall||.1;void 0!==e.size[3]&&(a=e.size[3]),a<=0&&(a=.01);let r=.5*a,n=2*a;e.face||(e.face={});let o={up:1,down:1,left:1,right:1,front:1,back:1,...e.face};delete e.face;const h=[];t?(1===o.up&&h.push({pos:[0,.5*i[1]+r,0],size:[i[0]+n,a,i[2]+n]}),1===o.down&&h.push({pos:[0,-r-.5*i[1],0],size:[i[0]+n,a,i[2]+n]}),1===o.left&&h.push({pos:[-r-.5*i[0],0,0],size:[a,i[1],i[2]]}),1===o.right&&h.push({pos:[.5*i[0]+r,0,0],size:[a,i[1],i[2]]}),1===o.back&&h.push({pos:[0,0,-r-.5*i[2]],size:[i[0]+n,i[1],a]}),1===o.front&&h.push({pos:[0,0,.5*i[2]+r],size:[i[0]+n,i[1],a]})):(1===o.up&&h.push({pos:[0,.5*i[1]-r,0],size:[i[0],a,i[2]]}),1===o.down&&h.push({pos:[0,r-.5*i[1],0],size:[i[0],a,i[2]]}),1===o.left&&h.push({pos:[r-.5*i[0],0,0],size:[a,i[1]-n,i[2]]}),1===o.right&&h.push({pos:[.5*i[0]-r,0,0],size:[a,i[1]-n,i[2]]}),1===o.back&&h.push({pos:[0,0,r-.5*i[2]],size:[i[0]-n,i[1]-n,a]}),1===o.front&&h.push({pos:[0,0,.5*i[2]-r],size:[i[0]-n,i[1]-n,a]}));const c=[];let A,u,d=h.length,p=0;for(;d--;)u=h[p],A=this.isCompound?u.pos:ci.addArray(s,u.pos),c.push({type:"box",size:u.size,pos:A,material:e.material}),p++;if(this.isCompound){let t=null;this.remplace&&(t=0===e.radius?new Z(new l(i[0],i[1],i[2])):new Z(new No(i[0],i[1],i[2],e.radius||r)),e.material&&"debug"===e.material&&(t=new jo(t,e.color),e.material="line"),t.raycast=()=>{}),this.motor.add({...e,mesh:t,shapes:c,type:"compound",ray:!1})}else this.motor.add(c)}}class Vo{constructor(e,t="drag",i){this.motor=i,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=t,this.option={},this.overObj=null,this.controler=e,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new W,this.tmpPos=new W,this.tmpD=new W,this.mouse=new g,this.oldMouse=new g,this.raycast=new Vt,this.raycast.far=1e3,this.button=0,this.pos=new W,this.velocity=new W,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.floorDrag=2===this.button,this.helper=new Ko(this.motor),this.dragPlane=new Z(new h(1,1),this.motor.mat.get("hide")),this.floorDrag&&this.dragPlane.geometry.rotateX(.5*-Math.PI),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(e,t={}){e!==this.mode&&(this.mode=e,this.option=t,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(e){e?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(e){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(e){this.raycastTest=!1}controleChange(e){}getMouse(e){this.motor.viewSize?(this.mouse.x=e.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-e.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=e.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-e.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==e.pointerType?e.button:0}contextmenu(e){}mousedown(e){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(e),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(e){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(e){if("drag"===this.mode)this.getMouse(e),this.needRay=!0}castray(){let e,t,i,s,a,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObject(this.dragPlane),e.length&&this.mouseDown&&this.moveSelect(e[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,e.length>0?(i=e[0].object,i.isInstancedMesh?(a=e[0].instanceId,t=this.motor.byName(i.getIDName(a))):i.parent!==this.motor.scene?(s=i.parent,t=s.parent!==this.motor.scene?s.parent:s):t=i,this.mouseDown2&&t.extra&&t.extra(t.name),r=t&&!t.isButton?this.select(t,e[0].point):this.actionButton(t,e[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.needRay=!0}blast(){let e=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let t=this.raycast.intersectObjects(this.motor.scene.children,!0);t.length>0?t[0].object.isButton?t[0].object.parent.userData.direct():e=t[0]:(t=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),t.length>0&&(e=t[0]));const i=this.option;e&&(this.motor.explosion(e.point,i.radius||3,i.power||.1),i.visible&&this.motor.addParticle({name:"blast",type:"cube",position:e.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){const e=this.option;this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(e.velocity||60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",mass:e.mass||10,size:[e.size||.2],material:e.mat||"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(e,t){if(this.buttonRef?this.buttonRef.name!==e.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=e):this.mouseDown&&(this.buttonRef=e),this.mouseDown&&this.buttonRef.userData.action){let e=t.point;this.buttonRef.userData.action(e)}return"pointer"}setOver(e){e&&(this.overObj&&e.name!==this.overObj.name&&this.resetOver(),this.overObj=e,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(e,t){if(this.mouseDown||this.setOver(e),!this.mouseDown||this.selected===e)return"grab";this.pz=0;let i=t,s=[0,0,0,1];this.selected=e,this.decal.copy(i).sub(this.selected.position),this.tmpPos.copy(i).sub(this.decal),this.angle=this.controler.getAzimuthalAngle(),s=this.selected.quaternion.toArray(),this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(i),this.helper.position.copy(i);let a=i.toArray(),r=!1;this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0});const n=this.motor.engine;if(this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let e=[-.1,.1,600,1],t=[-.1,.1,600,1],i="OIMO"===n||"RAPIER"===n||"JOLT"===n,o=0===this.selected.link?"fixe":"d6";"JOLT"===n&&(o="fixe");let l=[["x",...e],["y",...e],["z",...e],["rx",...t],["ry",...t],["rz",...t]];"HAVOK"===n&&(l=[["x",...e],["y",...e],["z",...e]]),"OIMO"===n&&(r=!0,o=0===this.selected.link?"fixe":"spherical",l=[["x",...e],["y",...e],["z",...e]]),"HAVOK"===n&&(o=0===this.selected.link?"fixe":"spherical",l=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:a,quat:s,kinematic:!i},{name:"mouseJoint",type:"joint",mode:o,lm:l,sd:[4,1],autoDrive:!0,b1:r?this.selected.name:"mouse",b2:r?"mouse":this.selected.name,worldAnchor:a,visible:!1}])}return"grabbing"}moveSelect(e){if(null===this.selected)return;if(e&&this.tmpPos.copy(e).sub(this.decal),this.moveDeep){let e=this.selected.position.y,t=e-this.tmpPos.y;this.tmpPos.y=e,this.tmpD.set(0,0,t).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let t=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:t,reset:!0}):this.motor.change({name:"mouse",pos:e.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let e=this.motor.flow.key;if(0!==e[1]){let t=.1*e[1];this.dragPlane.translateZ(t),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class Ko extends K{constructor(e){super(new t,e.mat.get("line"));let i=.75;const a=[i,i,i,0,0,0];this.geometry.setAttribute("position",new s([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new s(a,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}const Wo=new W;new W;const Jo=new W,Xo=new W,Yo=new W,Zo=new W,$o=new W;class el{constructor(e={},t){this.first=!0,this.debug=e.debug||!1,this.motor=t,this.name=e.name||"ppp",this.pMass=e.pMass||.01,this.vSize=e.vSize||.16,this.pSize=e.pSize||.02,this.particles=[],this.density=e.density||.01,this.smoothMulty=e.smoothMulty||1,this.smoothing=e.smoothing||.2,this.smoothing*=this.smoothMulty,this.speed=e.speed||.1,this.viscosity=e.viscosity||.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.maxDist=0,this.tv=new W,this.tv2=new W,e.mesh&&this.setMesh(e.mesh,e.crossEdge)}setMesh(e,t=!1){const i=[],s=[];this.mesh=e,this.geometry=e.geometry,this.geometry.getIndex();const a=this.geometry.getAttribute("position").array,r=ci.getHash(this.geometry),n=ci.getFaces(this.geometry),o=t?ci.getConnectedFaces(n):null;let l,h,c,A,u,d;for(let e in r)l=r[e][0],h=3*l,Wo.set(a[h],a[h+1],a[h+2]),this.mesh.localToWorld(Wo),this.add(Wo.toArray());for(let e=0;e<n.length;e++)c=n[e],A=this.getKey(r,c[0]),u=this.getKey(r,c[1]),d=this.getKey(r,c[2]),this.sameLink(i,A,u)||i.push([A,u]),this.sameLink(i,u,d)||i.push([u,d]),this.sameLink(i,d,A)||i.push([d,A]);if(this.connect(i),o){for(let e=0;e<o.length;e++)c=o[e],A=this.getKey(r,c[0]),u=this.getKey(r,c[1]),this.sameLink(i,A,u)||this.sameLink(s,A,u)||s.push([A,u]);this.connect(s,!0)}this.hash=r,this.mesh.position.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,phy.addDirect(this.mesh)}updateMesh(){if(!this.geometry)return;let e,t,i,s=this.hash,a=this.geometry.attributes.position.array,r=this.particles.length;for(;r--;)for(t=this.particles[r],i=s[r].length;i--;)e=3*s[r][i],a[e]=t.position.x,a[e+1]=t.position.y,a[e+2]=t.position.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.computeBoundingSphere()}add(e){let t=this.motor.add({instance:this.name,type:"particle",size:[this.vSize],pSize:this.pSize,pos:e,inertia:[0,0,0],mass:this.pMass,restitution:0,friction:.5,damping:[.2,.1],material:this.debug?"particle":"hide",shadow:!1,getVelocity:!0});this.first=!1,t.force=new W,this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(e,t){let i,s,a,r=e.length,n=[],o=0;for(;r--;){if(i=e[r],this.name,i[0],this.name,i[1],s=this.particles[i[0]].position,a=this.particles[i[1]].position,o=this.tv.copy(s).distanceTo(a),t){if(o>this.maxDist)continue}else o>this.maxDist&&(this.maxDist=o);this.tv.copy(a).sub(s),n.push({type:"distance",helperSize:.03,b1:this.name+i[0],b2:this.name+i[1],limit:[.5*o,o],spring:[20,1],collision:!0,noPreProcess:!0,alway:!0})}this.motor.add(n)}getPosition(){let e,t,i=[],s=this.particles.length;for(;s--;)t=3*s,e=this.particles[s],i[t]=e.position.x,i[t+1]=e.position.y,i[t+2]=e.position.z;return i}getNeighbors(e,t){const i=this.particles.length,s=e.idx,a=this.smoothing*this.smoothing;let r=0;for(let n=0;n!==i;n++){const i=this.particles[n];r=this.distanceSq(i,e),s!==i.idx&&r<a&&t.push(i)}}distance(e,t){const i=e.position.x-t.position.x,s=e.position.y-t.position.y,a=e.position.z-t.position.z;return Math.sqrt(i*i+s*s+a*a)}distanceSq(e,t){const i=e.position.x-t.position.x,s=e.position.y-t.position.y,a=e.position.z-t.position.z;return i*i+s*s+a*a}w(e){const t=this.smoothing;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)}gradw(e,t){const i=e.length(),s=this.smoothing,a=945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-i*i,2);t.copy(e).multiplyScalar(a)}nablaw(e){const t=this.smoothing;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}getKey(e,t){let i;for(let s in e)if(i=e[s],-1!==i.indexOf(t))return s}sameLink(e,t,i){let s,a=e.length,r=!1;for(;a--;)s=e[a],t===i&&(r=!0),t===s[0]&&i===s[1]&&(r=!0),t===s[1]&&i===s[0]&&(r=!0);return r}update(){const e=[],t=this.particles.length,i=this.speed,s=this.eps;let a;for(let e=0;e!==t;e++){const t=this.particles[e];t.force.set(0,0,0);const s=this.neighbors[e];s.length=0,this.getNeighbors(t,s),s.push(this.particles[e]);let r=0;for(a=s.length;a--;){const e=this.w(this.distance(t,s[a]));r+=s[a].mass*e}this.densities[e]=r,this.pressures[e]=i*i*(this.densities[e]-this.density)}const r=Jo,n=Xo,o=Yo,l=Zo,h=$o;let c,A;for(let i=0;i!==t;i++){const t=this.particles[i];let a,u;r.set(0,0,0),n.set(0,0,0);const d=this.neighbors[i],p=d.length;for(let e=0;e!==p;e++)c=d[e],l.copy(t.position).sub(c.position),A=l.length(),a=-c.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+s)+this.pressures[e]/(this.densities[e]*this.densities[e]+s)),this.gradw(l,o),o.multiplyScalar(a),r.add(o),h.copy(c.velocity).sub(t.velocity),h.multiplyScalar(1/(1e-4+this.densities[i]*this.densities[e])*this.viscosity*c.mass),u=this.nablaw(A),h.multiplyScalar(u),n.add(h);n.multiplyScalar(t.mass),r.multiplyScalar(t.mass),t.force.add(n),t.force.add(r),e.push({name:t.name,force:t.force.toArray()})}this.motor.change(e),this.updateMesh()}}function tl(e,t,i,s){return function(e,t,i,s,a){let r=t.x-e.x,n=t.y-e.y,o=s.x-i.x,l=s.y-i.y;const h=ol(e),c=ol(i);if(h===c)return a;const A=ol(t);if(A===c)return a;const u=ol(s);if(h===u)return a;if(A===u)return a;let d=(e.x-i.x)*l-(e.y-i.y)*o,p=(t.x-i.x)*l-(t.y-i.y)*o,g=(i.x-e.x)*n-(i.y-e.y)*r,m=(s.x-e.x)*n-(s.y-e.y)*r;return(d>=0&&p<=0||d<=0&&p>=0)&&(g>=0&&m<=0||g<=0&&m>=0)}(e,t,i,s,!1)}function il(e,t,i,s){let a=0,r=new W;return ll(e)===ll(t)||0===i.x&&0===i.y&&0===i.z?null:(a=((s.x-e.x)*i.x+(s.y-e.y)*i.y+(s.z-e.z)*i.z)/((t.x-e.x)*i.x+(t.y-e.y)*i.y+(t.z-e.z)*i.z),a<0||a>1?null:(r=new W(e.x+(t.x-e.x)*a,e.y+(t.y-e.y)*a,e.z+(t.z-e.z)*a),{x:r,s:a}))}function sl(e,t,i){return(t.x-e.x)*(i.y-e.y)-(t.y-e.y)*(i.x-e.x)<=0}function al(e){return parseInt(Math.round(1e6*e))}function rl(e,t=1e6){return Math.floor(e*t)}function nl(e,t){return Math.round((e+t)*(e+t+1)*.5+t)}function ol(e){return nl(rl(e.x),rl(e.y))}function ll(e){const t=rl(e.x),i=rl(e.y),s=rl(e.z),a=(t+i)*(t+i+1)*.5+i;return(a+s)*(a+s+1)*.5+s}function hl(e,t,i){return!(t.x*(e.x-i.x)+t.y*(e.y-i.y)+t.z*(e.z-i.z)<0)}class cl{constructor(e=new W,t=new W,i=new g){this.position=e,this.normal=t,this.uv=i}equals(e){return ll(this.position)===ll(e.position)}toString(){return`Position = ${this.position.x}, ${this.position.y}, ${this.position.z}, Normal = ${this.normal.x}, ${this.normal.y}, ${this.normal.z}, UV = ${this.uv.x}, ${this.uv.y}`}}class Al{constructor(){this.vertices=[],this.cutVertices=[],this.triangles=[[],[]],this.constraints=[],this.indexMap=[],this.bounds=new te,this.vertexAdjacency=[],this.convextested=!1}static fromGeometry(e){const t=e.attributes.position.array,i=e.attributes.normal.array,s=e.attributes.uv.array,a=e.attributes.position.count;let r,n;const o=new Al;for(let e=0;e<a;e++)r=3*e,n=2*e,o.vertices.push(new cl(new W(t[r],t[r+1],t[r+2]),new W(i[r],i[r+1],i[r+2]),new g(s[n],s[n+1])));return o.triangles=[[...e.index.array],[]],o.calculateBounds(),o}get size(){this.bounds||this.calculateBounds();let e=new W;return this.bounds.getSize(e)}get convex(){return this.convextested||(this.cc=this.isConvex()),this.cc}get triangleCount(){return(this.triangles[0].length+this.triangles[1].length)/3}get vertexCount(){return this.vertices.length+this.cutVertices.length}addCutFaceVertex(e,t,i){const s=new cl(e,t,i);this.vertices.push(s),this.cutVertices.push(s),this.vertexAdjacency.push(this.vertices.length-1)}addMappedVertex(e,t){this.vertices.push(e),this.indexMap[t]=this.vertices.length-1}addTriangle(e,t,i,s){this.triangles[s].push(e,t,i)}addMappedTriangle(e,t,i,s){this.triangles[s].push(this.indexMap[e],this.indexMap[t],this.indexMap[i])}weldCutFaceVertices(){const e=[],t=[],i=new Array(this.cutVertices.length);let s=0;const a=new Map;this.cutVertices.forEach(((r,n)=>{const o=function(e){let t=al(e.x),i=al(e.y),s=al(e.z),a=(t+i)*(t+i+1)*.5+i;return(a+s)*(a+s+1)*.5+s}(r.position),l=a.get(o);void 0===l?(i[n]=s,a.set(o,s),e.push(this.cutVertices[n]),t.push(this.vertexAdjacency[n]),s++):i[n]=l}));for(let e=0;e<this.constraints.length;e++){const t=this.constraints[e];t.v1=i[t.v1],t.v2=i[t.v2]}this.cutVertices=e,this.vertexAdjacency=t}calculateBounds(){if(!this.vertices.length)return;let e=this.vertices[0].position.clone(),t=e.clone();this.vertices.forEach((i=>{e.x=Math.min(e.x,i.position.x),e.y=Math.min(e.y,i.position.y),e.z=Math.min(e.z,i.position.z),t.x=Math.max(t.x,i.position.x),t.y=Math.max(t.y,i.position.y),t.z=Math.max(t.z,i.position.z)})),this.bounds.set(e,t)}calculateBounds_(e=!1){null===this.bounds&&(this.bounds=new te);let t=this.vertices.length;e&&(t+=this.cutVertices.length);const i=[];let s=-1;for(const e of this.vertices)i[s++]=e.position;if(e)for(const e of this.cutVertices)i[s++]=e.position;this.bounds.setFromPoints(i)}toMesh(e,t=null,i=!0,s=0){const a=new W,r=new W;let n=this.toGeometry(i,s);n.boundingBox.getCenter(a),n.boundingBox.getSize(r),n.translate(-a.x,-a.y,-a.z),n.boundingSphere=new st(new W,.5*r.length());let o=e.material;t&&o.isMaterial&&(o=[e.material,t]);const l=new Z(n,o);return l.receiveShadow=e.receiveShadow,l.castShadow=e.castShadow,l.sizer=r.length(),a.applyQuaternion(e.quaternion),l.position.copy(e.position).add(a),l.quaternion.copy(e.quaternion),l.userData={origin:l.position.clone(),direction:a.normalize(),size:r},l}makeTrickness(e,t,i,s,a){let r,n=1-a,o=[...e],l=[...t],h=[...i],c=e.length/3,A=c;for(;A--;)r=3*A,o[r]*=n,o[r+1]*=n,o[r+2]*=n;let u=[];for(A=s.length;A--;)u[A]=s[A]+c;return[o,l,h,u]}toGeometry(e,s){let a;const r=new t;let n=[],o=[],l=[];if(this.vertices.forEach((e=>{n.push(e.position.x,e.position.y,e.position.z),o.push(e.normal.x,e.normal.y,e.normal.z),l.push(e.uv.x,e.uv.y)})),0!==s){let e=this.makeTrickness(n,o,l,this.triangles[0],s);n=n.concat(e[0]),o=o.concat(e[1]),l=l.concat(e[2]),a=e[3]}return e&&this.cutVertices.forEach((e=>{n.push(e.position.x,e.position.y,e.position.z),o.push(e.normal.x,e.normal.y,e.normal.z),l.push(e.uv.x,e.uv.y)})),r.addGroup(0,this.triangles[0].length,0),0!==s&&(r.addGroup(this.triangles[0].length,a.length,1),this.triangles[0]=this.triangles[0].concat(a)),e&&r.addGroup(this.triangles[0].length,this.triangles[1].length,1),r.setAttribute("position",new i(new Float32Array(n),3)),r.setAttribute("normal",new i(new Float32Array(o),3)),r.setAttribute("uv",new i(new Float32Array(l),2)),r.setIndex(new i(new Uint32Array(this.triangles.flat()),1)),r.computeBoundingBox(),r}isConvex(e=.001){this.convextested=!0;let t=0;const i=this.triangleCount,s=[...this.triangles[0],...this.triangles[1]],a=[...this.vertices,...this.cutVertices],r=a.length;if(0===i||0===r)return!1;const n=new W,o=new W,l=new W,h=new W,c=new W;let A,u;for(let d=0;d<i;d++){t=3*d,c.copy(a[0].position),n.copy(a[s[t]].position),o.copy(a[s[t+1]].position),l.copy(a[s[t+2]].position),o.sub(n),l.sub(n),h.copy(o).cross(l).normalize(),A=c.sub(n).dot(h);for(let t=0;t<r;t++)if(u=c.copy(a[t].position).sub(n).dot(h),Math.abs(A)>e&&Math.abs(u)>e&&A*u<0)return!1}return!0}}class ul{constructor(e){this.parent=new Array(e),this.rank=new Array(e);for(let t=0;t<e;t++)this.parent[t]=t,this.rank[t]=1}find(e){return this.parent[e]!==e&&(this.parent[e]=this.find(this.parent[e])),this.parent[e]}union(e,t){const i=this.find(e),s=this.find(t);i!==s&&(this.rank[i]>this.rank[s]?this.parent[s]=i:this.rank[i]<this.rank[s]?this.parent[i]=s:(this.parent[s]=i,this.rank[i]+=1))}}let dl=class{constructor(e,t,i,s,a){this.v1=e,this.v2=t,this.t1=void 0!==i?i:-1,this.t2=void 0!==s?s:-1,this.t1Edge=void 0!==a?a:0}equals(e){return this.v1===e.v1&&this.v2===e.v2||this.v1===e.v2&&this.v2===e.v1}toString(){return`Edge: T${this.t1}->T${this.t2} (V${this.v1}->V${this.v2})`}};class pl{static getBinNumber(e,t,i){return e%2==0?e*i+t:(e+1)*i-t-1}static sort(e,t,i){if(i<=1)return e;t>e.length&&(t=e.length);const s=new Array(i).fill(0),a=new Array(e.length);for(let i=0;i<t;i++)s[e[i].bin]++;for(let e=1;e<i;e++)s[e]+=s[e-1];for(let i=t-1;i>=0;i--){const t=e[i].bin;s[t]--,a[s[t]]=e[i]}for(let i=t;i<a.length;i++)a[i]=e[i];return a}}let gl=class{constructor(e,t){this.index=e,this.coords=t,this.bin=0}toString(){return`${this.coords} -> ${this.bin}`}};const ml=-1;class fl{constructor(e,t){if(this.normalizationScaleFactor=1,this.N=e.length,this.N>=3){this.triangleCount=2*this.N+1,this.triangulation=Array.from({length:this.triangleCount},(()=>new Array(6).fill(0))),this.skipTriangle=new Array(this.triangleCount).fill(!1),this.points=new Array(this.N+3),this.normal=t.clone().normalize();let a=e[0].position.clone().sub(e[1].position).normalize(),r=this.normal.clone(),n=new W;n.crossVectors(a,r).normalize();for(let t=0;t<this.N;t++){var i=e[t].position,s=new g(i.dot(a),i.dot(n));this.points[t]=new gl(t,s)}}else this.triangleCount=0,this.triangulation=[],this.skipTriangle=[],this.points=[],this.normal=new W}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.discardTrianglesWithSuperTriangleVertices();const e=[];for(let t=0;t<this.triangleCount;t++)this.skipTriangle[t]||e.push(this.triangulation[t][0],this.triangulation[t][1],this.triangulation[t][2]);return e}normalizeCoordinates(){let e=Number.MAX_VALUE,t=Number.MIN_VALUE,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let a=0;a<this.N;a++)e=Math.min(e,this.points[a].coords.x),t=Math.max(t,this.points[a].coords.x),i=Math.min(i,this.points[a].coords.y),s=Math.max(s,this.points[a].coords.y);const a=Math.max(t-e,s-i);for(let t=0;t<this.N;t++){var r=this.points[t],n=new g((r.coords.x-e)/a,(r.coords.y-i)/a);this.points[t].coords=n}}sortPointsIntoBins(){const e=Math.round(Math.pow(this.N,.25)),t=e*e;for(let t=0;t<this.N;t++){var i=this.points[t];const s=Math.floor(.99*e*i.coords.y),a=Math.floor(.99*e*i.coords.x);i.bin=pl.getBinNumber(s,a,e)}return pl.sort(this.points,this.N,t)}computeTriangulation(){let e=0,t=0,i=this.sortPointsIntoBins();for(let s=0;s<this.N;s++){let a=i[s];if(!a)break;let r=0,n=!1;for(;!n&&!(r++>t||e===ml);){let i=this.points[this.triangulation[e][0]].coords,s=this.points[this.triangulation[e][1]].coords,r=this.points[this.triangulation[e][2]].coords;sl(i,s,a.coords)?sl(s,r,a.coords)?sl(r,i,a.coords)?(this.insertPointIntoTriangle(a,e,t),t+=2,e=t,n=!0):e=this.triangulation[e][5]:e=this.triangulation[e][4]:e=this.triangulation[e][3]}}}addSuperTriangle(){this.points[this.N]=new gl(this.N,new g(-100,-100)),this.points[this.N+1]=new gl(this.N+1,new g(0,100)),this.points[this.N+2]=new gl(this.N+2,new g(100,-100)),this.triangulation[0][0]=this.N,this.triangulation[0][1]=this.N+1,this.triangulation[0][2]=this.N+2,this.triangulation[0][3]=ml,this.triangulation[0][4]=ml,this.triangulation[0][5]=ml}insertPointIntoTriangle(e,t,i){const s=t,a=i+1,r=i+2;this.triangulation[a][0]=e.index,this.triangulation[a][1]=this.triangulation[t][1],this.triangulation[a][2]=this.triangulation[t][2],this.triangulation[a][3]=r,this.triangulation[a][4]=this.triangulation[t][4],this.triangulation[a][5]=s,this.triangulation[r][0]=e.index,this.triangulation[r][1]=this.triangulation[t][0],this.triangulation[r][2]=this.triangulation[t][1],this.triangulation[r][3]=s,this.triangulation[r][4]=this.triangulation[t][3],this.triangulation[r][5]=a,this.updateAdjacency(this.triangulation[t][3],t,r),this.updateAdjacency(this.triangulation[t][4],t,a),this.triangulation[s][1]=this.triangulation[t][2],this.triangulation[s][2]=this.triangulation[t][0],this.triangulation[s][0]=e.index,this.triangulation[s][4]=this.triangulation[t][5],this.triangulation[s][3]=a,this.triangulation[s][5]=r,this.restoreDelauneyTriangulation(e,s,a,r)}restoreDelauneyTriangulation(e,t,i,s){const a=[];for(a.push([t,this.triangulation[t][4]]),a.push([i,this.triangulation[i][4]]),a.push([s,this.triangulation[s][4]]);a.length>0;)if([t,i]=a.pop()??[ml,ml],i!==ml){const s=this.swapQuadDiagonalIfNeeded(e.index,t,i);null!==s&&(a.push([t,s.t3]),a.push([i,s.t4]))}}swapQuadDiagonalIfNeeded(e,t,i){let s=0,a=0,r=0,n=e,o=0,l=0;return this.triangulation[i][3]===t?(s=this.triangulation[i][1],a=this.triangulation[i][0],r=this.triangulation[i][2],o=this.triangulation[i][4],l=this.triangulation[i][5]):this.triangulation[i][4]===t?(s=this.triangulation[i][2],a=this.triangulation[i][1],r=this.triangulation[i][0],o=this.triangulation[i][5],l=this.triangulation[i][3]):(s=this.triangulation[i][0],a=this.triangulation[i][2],r=this.triangulation[i][1],o=this.triangulation[i][3],l=this.triangulation[i][4]),this.swapTest(this.points[s].coords,this.points[a].coords,this.points[r].coords,this.points[n].coords)?(this.updateAdjacency(o,i,t),this.updateAdjacency(this.triangulation[t][5],t,i),this.triangulation[t][0]=n,this.triangulation[t][1]=s,this.triangulation[t][2]=r,this.triangulation[i][0]=n,this.triangulation[i][1]=r,this.triangulation[i][2]=a,this.triangulation[i][3]=t,this.triangulation[i][4]=l,this.triangulation[i][5]=this.triangulation[t][5],this.triangulation[t][4]=o,this.triangulation[t][5]=i,{t3:o,t4:l}):null}discardTrianglesWithSuperTriangleVertices(){for(let e=0;e<this.triangleCount;e++)(this.triangleContainsVertex(e,this.N)||this.triangleContainsVertex(e,this.N+1)||this.triangleContainsVertex(e,this.N+2))&&(this.skipTriangle[e]=!0)}swapTest(e,t,i,s){const a=e.x-i.x,r=t.x-i.x,n=e.y-i.y,o=t.y-i.y,l=e.x-s.x,h=t.x-s.x,c=e.y-s.y,A=t.y-s.y,u=a*r+n*o,d=h*l+A*c;return!(u>=0&&d>=0)&&(u<0&&d<0||(a*o-r*n)*d+(h*c-l*A)*u<0)}triangleContainsVertex(e,t){return this.triangulation[e][0]===t||this.triangulation[e][1]===t||this.triangulation[e][2]===t}updateAdjacency(e,t,i){if(e===ml)return;const s=this.findSharedEdge(e,t);null!==s&&(this.triangulation[e][s]=i)}findSharedEdge(e,t){return e===ml?null:this.triangulation[e][3]===t?3:this.triangulation[e][4]===t?4:this.triangulation[e][5]===t?5:null}}class bl{constructor(e,t,i,s,a,r,n,o,l,h){this.q1=e,this.q2=t,this.q3=i,this.q4=s,this.t1=a,this.t2=r,this.t1L=n,this.t1R=o,this.t2L=l,this.t2R=h}toString(){return`T${this.t1}/T${this.t2} (V${this.q1},V${this.q2},V${this.q3},V${this.q4})`}}class yl extends fl{edgeVertex1=[0,0,0,0,1,2];edgeVertex2=[0,0,0,1,2,0];oppositePoint=[0,0,0,2,0,1];nextEdge=[0,0,0,4,5,3];previousEdge=[0,0,0,5,3,4];constructor(e,t,i){super(e,i),this.constraints=t,this.vertexTriangles=[],this.visited=[]}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.constraints.length>0&&(this.applyConstraints(),this.discardTrianglesViolatingConstraints()),this.discardTrianglesWithSuperTriangleVertices();let e=[];for(let t=0;t<this.triangleCount;t++)this.skipTriangle[t]||(e.push(this.triangulation[t][0]),e.push(this.triangulation[t][1]),e.push(this.triangulation[t][2]));return e}applyConstraints(){const e=this.triangulation.length;this.visited=new Array(e).fill(!1),this.vertexTriangles=new Array(this.N+3).fill(0);for(let t=0;t<e;t++)this.vertexTriangles[this.triangulation[t][0]]=t,this.vertexTriangles[this.triangulation[t][1]]=t,this.vertexTriangles[this.triangulation[t][2]]=t;for(let e of this.constraints){if(e.v1===e.v2)continue;const t=this.findIntersectingEdges(e,this.vertexTriangles);this.removeIntersectingEdges(e,t)}}findIntersectingEdges(e,t){const i=[],s=this.findStartingEdge(t,e);if(null===s)return i;i.push(s);let a=s.t1,r=s.t1Edge,n=a,o=!1;for(;!o;){n=a,a=this.triangulation[a][r];const t=this.points[e.v1].coords,s=this.points[e.v2].coords,h=this.points[this.triangulation[a][0]].coords,c=this.points[this.triangulation[a][1]].coords,A=this.points[this.triangulation[a][2]].coords;if(this.triangleContainsVertex(a,e.v2))o=!0;else if(this.triangulation[a][3]!==n&&tl(t,s,h,c)){r=3;var l=new dl(this.triangulation[a][0],this.triangulation[a][1],a,this.triangulation[a][3],r);i.push(l)}else if(this.triangulation[a][4]!==n&&tl(t,s,c,A))r=4,l=new dl(this.triangulation[a][1],this.triangulation[a][2],a,this.triangulation[a][4],r),i.push(l);else{if(this.triangulation[a][5]===n||!tl(t,s,A,h)){console.warn("Failed to find final triangle, exiting early.");break}r=5,l=new dl(this.triangulation[a][2],this.triangulation[a][0],a,this.triangulation[a][5],r),i.push(l)}}return i}findStartingEdge(e,t){let i,s,a,r=new dl(-1,-1),n=t.v1,o=e[n],l=!1,h=null;for(this.visited.fill(!1);!h&&!l;){if(this.visited[o]=!0,this.triangleContainsConstraint(o,t))return null;if(h=this.edgeConstraintIntersectsTriangle(o,t),h)break;if(i=this.triangulation[o][3],s=this.triangulation[o][4],a=this.triangulation[o][5],-1!==i&&!this.visited[i]&&this.triangleContainsVertex(i,n))o=i;else if(-1!==s&&!this.visited[s]&&this.triangleContainsVertex(s,n))o=s;else{if(-1===a||this.visited[a]||!this.triangleContainsVertex(a,n)){l=!0;break}o=a}}if(h){const e=this.triangulation[o][this.edgeVertex1[h]],t=this.triangulation[o][this.edgeVertex2[h]],i=this.triangulation[o][h];return r=new dl(e,t,o,i,h),r}return null}removeIntersectingEdges(e,t){let i,s=[],a=0;for(;t.length>0&&a<=t.length;){if(i=t.shift(),null==i)continue;let r=this.findQuadFromSharedEdge(i.t1,i.t1Edge);if(r)if(tl(this.points[r.q4].coords,this.points[r.q3].coords,this.points[r.q1].coords,this.points[r.q2].coords)){this.swapQuadDiagonal(r,t,s,this.constraints);let i=new dl(r.q3,r.q4,r.t1,r.t2,5);tl(this.points[e.v1].coords,this.points[e.v2].coords,this.points[r.q3].coords,this.points[r.q4].coords)?t.push(i):(a=0,s.push(i))}else t.push(i);a++}s.length>0&&this.restoreConstrainedDelauneyTriangulation(e,s)}restoreConstrainedDelauneyTriangulation(e,t){let i=!0;for(;i;){i=!1;for(let s=0;s<t.length;s++){const a=t[s];if(a.equals(e))continue;let r=this.findQuadFromSharedEdge(a.t1,a.t1Edge);if(r&&this.swapTest(this.points[r.q1].coords,this.points[r.q2].coords,this.points[r.q3].coords,this.points[r.q4].coords)){this.swapQuadDiagonal(r,t,this.constraints,null);const e=r.q3,a=r.q4;t[s]=new dl(e,a,r.t1,r.t2,5),i=!0}}}}discardTrianglesViolatingConstraints(){this.skipTriangle.fill(!0);let e=new Set;for(let t=0;t<this.constraints.length;t++){const i=this.constraints[t];e.add(nl(i.v1,i.v2))}this.visited.fill(!1);let t,i,s,a,r,n,o=[];for(let l=0;l<this.triangleCount;l++)if(!this.visited[l]&&(t=this.triangulation[l][0],i=this.triangulation[l][1],s=this.triangulation[l][2],a=e.has(nl(t,i)),r=e.has(nl(i,s)),n=e.has(nl(s,t)),a||r||n))for(this.skipTriangle[l]=!1,o=[],a||o.push(this.triangulation[l][3]),r||o.push(this.triangulation[l][4]),n||o.push(this.triangulation[l][5]);o.length>0;){const a=o.shift();-1===a||this.visited[a]||(this.skipTriangle[a]=!1,this.visited[a]=!0,t=this.triangulation[a][0],i=this.triangulation[a][1],s=this.triangulation[a][2],e.has(nl(t,i))||o.push(this.triangulation[a][3]),e.has(nl(i,s))||o.push(this.triangulation[a][4]),e.has(nl(s,t))||o.push(this.triangulation[a][5]))}}triangleContainsConstraint(e,t){return!(e>=this.triangulation.length||this.triangulation[e][0]!==t.v1&&this.triangulation[e][1]!==t.v1&&this.triangulation[e][2]!==t.v1||this.triangulation[e][0]!==t.v2&&this.triangulation[e][1]!==t.v2&&this.triangulation[e][2]!==t.v2)}edgeConstraintIntersectsTriangle(e,t){const i=this.points[t.v1].coords,s=this.points[t.v2].coords,a=this.points[this.triangulation[e][0]].coords,r=this.points[this.triangulation[e][1]].coords,n=this.points[this.triangulation[e][2]].coords;return tl(i,s,a,r)?3:tl(i,s,r,n)?4:tl(i,s,n,a)?5:null}findQuadFromSharedEdge(e,t){let i,s,a,r,n,o,l,h,c=this.triangulation[e][t],A=this.findSharedEdge(c,e);return A?(3===A?(s=this.triangulation[c][0],i=this.triangulation[c][1],a=this.triangulation[c][2]):4===A?(s=this.triangulation[c][1],i=this.triangulation[c][2],a=this.triangulation[c][0]):(s=this.triangulation[c][2],i=this.triangulation[c][0],a=this.triangulation[c][1]),r=this.triangulation[e][this.oppositePoint[t]],n=this.triangulation[e][this.previousEdge[t]],o=this.triangulation[e][this.nextEdge[t]],l=this.triangulation[c][this.nextEdge[A]],h=this.triangulation[c][this.previousEdge[A]],new bl(i,s,a,r,e,c,n,o,l,h)):null}swapQuadDiagonal(e,t,i,s){const a=e.t1,r=e.t2,n=e.t1R,o=e.t1L,l=e.t2R,h=e.t2L;this.triangulation[a][0]=e.q4,this.triangulation[a][1]=e.q1,this.triangulation[a][2]=e.q3,this.triangulation[r][0]=e.q4,this.triangulation[r][1]=e.q3,this.triangulation[r][2]=e.q2,this.triangulation[a][3]=o,this.triangulation[a][4]=h,this.triangulation[a][5]=r,this.triangulation[r][3]=a,this.triangulation[r][4]=l,this.triangulation[r][5]=n,this.updateAdjacency(h,r,a),this.updateAdjacency(n,a,r),this.updateEdgesAfterSwap(t,a,r,o,n,h,l),this.updateEdgesAfterSwap(i,a,r,o,n,h,l),this.updateEdgesAfterSwap(s,a,r,o,n,h,l),this.vertexTriangles[e.q1]=a,this.vertexTriangles[e.q2]=r}updateEdgesAfterSwap(e,t,i,s,a,r,n){if(e)for(let o of e)o.t1===t&&o.t2===a?(o.t1=i,o.t2=a,o.t1Edge=5):o.t1===t&&o.t2===s?o.t1Edge=3:o.t1===a&&o.t2===t?o.t2=i:o.t1===s&&o.t2===t||(o.t1===i&&o.t2===n?o.t1Edge=4:o.t1===i&&o.t2===r?(o.t1=t,o.t2=r,o.t1Edge=4):o.t1===n&&o.t2===i||o.t1===r&&o.t2===i&&(o.t2=t))}}function wl(e,t,i,s,a,r,n=!0){const o=new Al,l=new Al,h=new Array(e.vertexCount).fill(!1);for(let s=0;s<e.vertices.length;s++){var c=e.vertices[s];h[s]=hl(c.position,t,i),(h[s]?o:l).addMappedVertex(c,s)}const A=e.vertices.length;for(let s=0;s<e.cutVertices.length;s++)c=e.cutVertices[s],h[s+A]=hl(c.position,t,i),(h[s+A]?o:l).addMappedVertex(c,s+A);return Il(e,o,l,t,i,h,0),n&&Il(e,o,l,t,i,h,1),n&&function(e,t,i,s,a,r){e.weldCutFaceVertices();const n=i.clone().negate().normalize();if(e.cutVertices.length<3)return;const o=r?new fl(e.cutVertices,n):new yl(e.cutVertices,e.constraints,n),l=o.triangulate();for(let r=0;r<e.cutVertices.length;r++){var h=e.cutVertices[r],c=o.points[r];const l=new g(o.normalizationScaleFactor*c.coords.x*s.x+a.x,o.normalizationScaleFactor*c.coords.y*s.y+a.y),A=new cl(h.position.clone(),n.clone(),l.clone()),u=new cl(h.position.clone(),i.clone(),l.clone());e.cutVertices[r]=A,t.cutVertices[r]=u}let A=e.vertices.length,u=t.vertices.length;for(let i=0;i<l.length;i+=3)e.addTriangle(A+l[i],A+l[i+1],A+l[i+2],1),t.addTriangle(u+l[i],u+l[i+2],u+l[i+1],1)}(o,l,t,s,a,r),{topSlice:o,bottomSlice:l}}function Il(e,t,i,s,a,r,n){const o=e.triangles[n];let l,h,c;for(let A=0;A<o.length;A+=3)l=o[A],h=o[A+1],c=o[A+2],r[l]&&r[h]&&r[c]?t.addMappedTriangle(l,h,c,n):r[l]||r[h]||r[c]?r[h]&&r[c]&&!r[l]?El(h,c,l,s,a,e,t,i,n,!0):r[c]&&r[l]&&!r[h]?El(c,l,h,s,a,e,t,i,n,!0):r[l]&&r[h]&&!r[c]?El(l,h,c,s,a,e,t,i,n,!0):r[h]||r[c]||!r[l]?r[c]||r[l]||!r[h]?r[l]||r[h]||!r[c]||El(l,h,c,s,a,e,t,i,n,!1):El(c,l,h,s,a,e,t,i,n,!1):El(h,c,l,s,a,e,t,i,n,!1):i.addMappedTriangle(l,h,c,n)}function El(e,t,i,s,a,r,n,o,l,h){let c=e<r.vertices.length?r.vertices[e]:r.cutVertices[e-r.vertices.length],A=t<r.vertices.length?r.vertices[t]:r.cutVertices[t-r.vertices.length],u=i<r.vertices.length?r.vertices[i]:r.cutVertices[i-r.vertices.length];const d=il(c.position,u.position,s,a),p=il(A.position,u.position,s,a);if(d&&p){const s=new W(c.normal.x+d.s*(u.normal.x-c.normal.x),c.normal.y+d.s*(u.normal.y-c.normal.y),c.normal.z+d.s*(u.normal.z-c.normal.z)).normalize(),a=new W(A.normal.x+p.s*(u.normal.x-A.normal.x),A.normal.y+p.s*(u.normal.y-A.normal.y),A.normal.z+p.s*(u.normal.z-A.normal.z)).normalize(),r=new g(c.uv.x+d.s*(u.uv.x-c.uv.x),c.uv.y+d.s*(u.uv.y-c.uv.y)),m=new g(A.uv.x+p.s*(u.uv.x-A.uv.x),A.uv.y+p.s*(u.uv.y-A.uv.y));n.addCutFaceVertex(d.x,s,r),n.addCutFaceVertex(p.x,a,m),o.addCutFaceVertex(d.x,s,r),o.addCutFaceVertex(p.x,a,m);const f=n.vertices.length-2,b=n.vertices.length-1,y=o.vertices.length-2,w=o.vertices.length-1;h?(n.addTriangle(b,f,n.indexMap[t],l),n.addTriangle(f,n.indexMap[e],n.indexMap[t],l),o.addTriangle(o.indexMap[i],y,w,l),n.constraints.push(new dl(n.cutVertices.length-2,n.cutVertices.length-1)),o.constraints.push(new dl(o.cutVertices.length-1,o.cutVertices.length-2))):(n.addTriangle(f,b,n.indexMap[i],l),o.addTriangle(o.indexMap[e],o.indexMap[t],y,l),o.addTriangle(o.indexMap[t],w,y,l),n.constraints.push(new dl(n.cutVertices.length-1,n.cutVertices.length-2)),o.constraints.push(new dl(o.cutVertices.length-2,o.cutVertices.length-1)))}}const Cl={textureScale:new g(1,1),textureOffset:new g},vl=new W,Bl=new W,xl=new W,kl=new ae,Ql=new ae;function Sl(e){const t=new ul(e.vertexCount),i={},s=e.vertices.length,a=e.cutVertices.length,r=new Map;e.vertices.forEach(((e,i)=>{const s=ll(e.position),a=r.get(s);void 0===a?r.set(s,i):t.union(a,i)}));for(let i=0;i<a;i++)t.union(e.vertexAdjacency[i],i+s);const n=e.triangles;for(let e=0;e<n.length;e++)for(let s=0;s<n[e].length;s+=3){const a=n[e][s],r=n[e][s+1],o=n[e][s+2];t.union(a,r),t.union(r,o);const l=t.find(a);i[l]||(i[l]=[[],[]]),i[l][e].push(a,r,o)}const o={},l=Array(e.vertexCount);for(let i=0;i<s;i++){const s=t.find(i);o[s]||(o[s]=new Al),o[s].vertices.push(e.vertices[i]),l[i]=o[s].vertices.length-1}for(let i=0;i<a;i++){const a=t.find(i+s);o[a].cutVertices.push(e.cutVertices[i]),l[i+s]=o[a].vertices.length+o[a].cutVertices.length-1}for(const s of Object.keys(i)){let a=Number(s),r=t.parent[a];for(let t=0;t<e.triangles.length;t++)for(const e of i[a][t]){const i=l[e];o[r].triangles[t].push(i)}}return Object.values(o)}class Ml{constructor(e){this.motor=e,this.tpos=new W,this.tnormal=new W,this.nDebris=0,this.maxDebris=1500,this.interneMat=this.motor.getMat("chrome"),this.tt=null}add(e,t=[]){let i=this,s=0;-1!==e.name.search("_debris_")&&(s=1e3),setTimeout((()=>{i.motor.addCollision({name:e.name,ignore:e.ignore}),e.addEventListener("collision",(e=>{let t=e.data;1===t.hit&&i.makeBreak(t.from,t.point,t.normal,t.impulse,t.v1)}))}),s)}makeBreak(e,t,i,s,a){let r=this.motor.byName(e);if(!r)return;if(!r.breakable)return;let n=r.breakOption;const o=void 0===n[4]||n[4];if(s<n[0])return;this.motor.removeCollision(e),this.motor.remove(e);const l=new W;r.geometry.boundingBox.getSize(l);const h=l.length();let c=function(e,t,i,s,a,r){const n=[],o=e.matrixWorld.clone().invert(),l=e.position;t.applyMatrix4(o);const h=Al.fromGeometry(e.geometry);let c=h.convex;vl.addVectors(t,i),kl.setFromCoplanarPoints(t,l,vl);const A=a+s;return function e(a,h,u,d){if(0===a.vertexCount)return;if(Math.random()<.05*d||d>A)return void n.push(a);let p=Math.PI,g=new W;a.calculateBounds(),a.bounds.getCenter(g);let m=c;if(0===d)Ql.normal.copy(kl.normal),Ql.constant=kl.constant;else if(d<=s)p=(u-h)*(.2+.6*Math.random())+h,Bl.copy(l).sub(t).applyAxisAngle(i,p).add(t),Ql.setFromCoplanarPoints(t,vl,Bl);else{let e=g.clone().applyMatrix4(o);p=(.5*(1&d)+.2*(2-Math.random()))*Math.PI,Bl.copy(t).sub(e).applyAxisAngle(i,p).add(e),xl.copy(i).add(e),Ql.setFromCoplanarPoints(e,xl,Bl)}const{topSlice:f,bottomSlice:b}=wl(a,Ql.normal,Bl,Cl.textureScale,Cl.textureOffset,m,r);let y=f,w=b;m||(y=Sl(f),w=Sl(b)),y&&(y instanceof Array?y.length>0&&y.forEach((t=>{t.vertices.length>12&&e(t,h,p,d+1)})):e(y,h,p,d+1)),w&&(w instanceof Array?w.length>0&&w.forEach((t=>{t.vertices.length>12&&e(t,h,p,d+1)})):e(b,p,u,d+1))}(h,0,2*Math.PI,0),n}(r,this.tpos.fromArray(t),this.tnormal.fromArray(i),n[1],n[2],o),A=function(e,t,i,s=!0,a=0){const r=[];return e.map(((e,n)=>{r.push(e.toMesh(t,i,s,a))})),r}(c,r,this.interneMat,o,0);if(A.length<1)return;let u,d,p,g,m,f=[],b=A.length,y=0,w=[...r.ignore];for(;b--;)u=A[y],d=u.geometry.attributes.position.count,p=u.sizer/h,g={},m=[...n],m[3]=m[3]-1,p<.2&&(m[3]=0),u.sizer>.02&&d>6&&(this.nDebris++,g.name=e+"_debris_"+y,g.mass=r.mass*p,f.push(this.addDebris(u,m,g)),w.push(g.name)),y++;for(b=f.length;b--;)f[b].ignore=w;this.motor.add(f)}addDebris(e,t,i){let s=t[3]>0;return{...i,type:"convex",shape:e.geometry,material:e.material,pos:e.position.toArray(),quat:e.quaternion.toArray(),breakable:s,breakOption:t}}}class Rl{constructor(e={},t){this.motor=t,this.utils=this.motor.utils,this.id=0,this.type="autoRagdoll",this.name=e.name||this.type+this.id++;let i=this.utils.byName(this.name);i&&this.utils.remove(i),this._mode=e.mode||"follow",this._size=e.size||1,this._debug=e.debug||!1;const s=Ls(e.model);let a;s.scale.set(1,1,1).multiplyScalar(this._size),e.pos&&s.position.fromArray(e.pos),s.raycast=function(){},s.name=this.name,s.traverse((t=>{t.isMesh&&(t.frustumCulled=!1),t.isSkinnedMesh&&(t.raycast=function(){},t.frustumCulled=!1,t.matrixAutoUpdate=!1,t.receiveShadow=!0,t.castShadow=!0,e.material&&(t.material=e.material),t.skeleton.resetScalling(),a=t.skeleton.bones)}));let r=e.mass||null;return this.skeletonBody=new Fs(this.motor,s.name,s,a,r,e.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),this.model=s,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(e){this._size=e,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(e){this._debug=e,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(e){this._mode=e,this.skeletonBody.setMode(this._mode)}}class Dl extends e{constructor(e){super(),this.rayCount=0,this.ray=[],this.motor=e,this.maxVertices=1e4,this.currentVertex=0,this.geometry=new t,this.geometry.setAttribute("position",new s(3*this.maxVertices,3)),this.geometry.setAttribute("color",new s(3*this.maxVertices,3)),this.positions=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material=new a({vertexColors:!0,toneMapped:!1,depthTest:!1,depthWrite:!1}),this.material.transparent=!0,this.renderOrder=3e4,this.frustumCulled=!1}DrawRay(e,t,i){i=new p(i);let s=this.currentVertex,a=3*s;this.positions[a]=e.x,this.positions[a+1]=e.y,this.positions[a+2]=e.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,s++,a=3*s,this.positions[a]=e.x+t.x,this.positions[a+1]=e.y+t.y,this.positions[a+2]=e.z+t.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,this.currentVertex+=2}collapseBuffer(){let e=this.maxVertices,t=this.currentVertex,i=0;for(;e>=t;)i=3*e,this.positions[i]=0,this.positions[i+1]=0,this.positions[i+2]=0,this.colors[i]=0,this.colors[i+1]=0,this.colors[i+2]=0,e--}insertLine(e,t,i){let s=this.currentVertex,a=3*s;this.positions[a]=e.x,this.positions[a+1]=e.y,this.positions[a+2]=e.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,s++,a=3*s,this.positions[a]=t.x,this.positions[a+1]=t.y,this.positions[a+2]=t.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,this.currentVertex+=2}draw(){this.collapseBuffer(),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.currentVertex=0}dispose(){this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}class Tl extends ht{constructor(e){super(e),this.type=ct}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},i=function(e,t,i){t=t||1024;let s=e.pos,a=-1,r=0,n="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));for(;0>(a=o.indexOf("\n"))&&r<t&&s<e.byteLength;)n+=o,r+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));return-1<a&&(e.pos+=r+a+1,n+o.slice(0,a))},s=function(e,t,i,s){const a=e[t+3],r=Math.pow(2,a-128)/255;i[s+0]=e[t+0]*r,i[s+1]=e[t+1]*r,i[s+2]=e[t+2]*r,i[s+3]=1},a=function(e,t,i,s){const a=e[t+3],r=Math.pow(2,a-128)/255;i[s+0]=ut.toHalfFloat(Math.min(e[t+0]*r,65504)),i[s+1]=ut.toHalfFloat(Math.min(e[t+1]*r,65504)),i[s+2]=ut.toHalfFloat(Math.min(e[t+2]*r,65504)),i[s+3]=ut.toHalfFloat(1)},r=new Uint8Array(e);r.pos=0;const n=function(e){const s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,n=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((e.pos>=e.byteLength||!(l=i(e)))&&t(1,"no header found"),(h=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),o.valid|=1,o.programtype=h[1],o.string+=l+"\n";l=i(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(s))&&(o.gamma=parseFloat(h[1])),(h=l.match(a))&&(o.exposure=parseFloat(h[1])),(h=l.match(r))&&(o.valid|=2,o.format=h[1]),(h=l.match(n))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||t(3,"missing format specifier"),4&o.valid||t(3,"missing image size specifier"),o}(r),o=n.width,l=n.height,h=function(e,i,s){const a=i;if(a<8||a>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);a!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const r=new Uint8Array(4*i*s);r.length||t(4,"unable to allocate buffer space");let n=0,o=0;const l=4*a,h=new Uint8Array(4),c=new Uint8Array(l);let A=s;for(;A>0&&o<e.byteLength;){o+4>e.byteLength&&t(1),h[0]=e[o++],h[1]=e[o++],h[2]=e[o++],h[3]=e[o++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==a||t(3,"bad rgbe scanline format");let i,s=0;for(;s<l&&o<e.byteLength;){i=e[o++];const a=i>128;if(a&&(i-=128),(0===i||s+i>l)&&t(3,"bad scanline data"),a){const t=e[o++];for(let e=0;e<i;e++)c[s++]=t}else c.set(e.subarray(o,o+i),s),s+=i,o+=i}const u=a;for(let e=0;e<u;e++){let t=0;r[n]=c[e+t],t+=a,r[n+1]=c[e+t],t+=a,r[n+2]=c[e+t],t+=a,r[n+3]=c[e+t],n+=4}A--}return r}(r.subarray(r.pos),o,l);let c,A,u;switch(this.type){case At:u=h.length/4;const e=new Float32Array(4*u);for(let t=0;t<u;t++)s(h,4*t,e,4*t);c=e,A=At;break;case ct:u=h.length/4;const t=new Uint16Array(4*u);for(let e=0;e<u;e++)a(h,4*e,t,4*e);c=t,A=ct;break;default:throw new Error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:o,height:l,data:c,header:n.string,gamma:n.gamma,exposure:n.exposure,type:A}}setDataType(e){return this.type=e,this}load(e,t,i,s){return super.load(e,(function(e,i){switch(e.type){case At:case ct:e.colorSpace=we,e.minFilter=De,e.magFilter=De,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,i)}),i,s)}}
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/var Fl=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};try{URL.revokeObjectURL(Fl(""))}catch(e){Fl=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var Ll=Uint8Array,Pl=Uint16Array,_l=Uint32Array,zl=new Ll([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ul=new Ll([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Nl=new Ll([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Gl=function(e,t){for(var i=new Pl(31),s=0;s<31;++s)i[s]=t+=1<<e[s-1];var a=new _l(i[30]);for(s=1;s<30;++s)for(var r=i[s];r<i[s+1];++r)a[r]=r-i[s]<<5|s;return[i,a]},Ol=Gl(zl,2),ql=Ol[0],jl=Ol[1];ql[28]=258,jl[258]=28;for(var Hl=Gl(Ul,0)[0],Vl=new Pl(32768),Kl=0;Kl<32768;++Kl){var Wl=(43690&Kl)>>>1|(21845&Kl)<<1;Wl=(61680&(Wl=(52428&Wl)>>>2|(13107&Wl)<<2))>>>4|(3855&Wl)<<4,Vl[Kl]=((65280&Wl)>>>8|(255&Wl)<<8)>>>1}var Jl=function(e,t,i){for(var s=e.length,a=0,r=new Pl(t);a<s;++a)++r[e[a]-1];var n,o=new Pl(t);for(a=0;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(i){n=new Pl(1<<t);var l=15-t;for(a=0;a<s;++a)if(e[a])for(var h=a<<4|e[a],c=t-e[a],A=o[e[a]-1]++<<c,u=A|(1<<c)-1;A<=u;++A)n[Vl[A]>>>l]=h}else for(n=new Pl(s),a=0;a<s;++a)e[a]&&(n[a]=Vl[o[e[a]-1]++]>>>15-e[a]);return n},Xl=new Ll(288);for(Kl=0;Kl<144;++Kl)Xl[Kl]=8;for(Kl=144;Kl<256;++Kl)Xl[Kl]=9;for(Kl=256;Kl<280;++Kl)Xl[Kl]=7;for(Kl=280;Kl<288;++Kl)Xl[Kl]=8;var Yl=new Ll(32);for(Kl=0;Kl<32;++Kl)Yl[Kl]=5;var Zl=Jl(Xl,9,1),$l=Jl(Yl,5,1),eh=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},th=function(e,t,i){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&i},ih=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},sh=function(e){return(e/8|0)+(7&e&&1)},ah=function(e,t,i){var s=e.length;if(!s||i&&!i.l&&s<5)return t||new Ll(0);var a=!t||i,r=!i||i.i;i||(i={}),t||(t=new Ll(3*s));var n=function(e){var i=t.length;if(e>i){var s=new Ll(Math.max(2*i,e));s.set(t),t=s}},o=i.f||0,l=i.p||0,h=i.b||0,c=i.l,A=i.d,u=i.m,d=i.n,p=8*s;do{if(!c){i.f=o=th(e,l,1);var g=th(e,l+1,3);if(l+=3,!g){var m=e[(k=sh(l)+4)-4]|e[k-3]<<8,f=k+m;if(f>s){if(r)throw"unexpected EOF";break}a&&n(h+m),t.set(e.subarray(k,f),h),i.b=h+=m,i.p=l=8*f;continue}if(1==g)c=Zl,A=$l,u=9,d=5;else{if(2!=g)throw"invalid block type";var b=th(e,l,31)+257,y=th(e,l+10,15)+4,w=b+th(e,l+5,31)+1;l+=14;for(var I=new Ll(w),E=new Ll(19),C=0;C<y;++C)E[Nl[C]]=th(e,l+3*C,7);l+=3*y;var v=eh(E),B=(1<<v)-1,x=Jl(E,v,1);for(C=0;C<w;){var k,Q=x[th(e,l,B)];if(l+=15&Q,(k=Q>>>4)<16)I[C++]=k;else{var S=0,M=0;for(16==k?(M=3+th(e,l,3),l+=2,S=I[C-1]):17==k?(M=3+th(e,l,7),l+=3):18==k&&(M=11+th(e,l,127),l+=7);M--;)I[C++]=S}}var R=I.subarray(0,b),D=I.subarray(b);u=eh(R),d=eh(D),c=Jl(R,u,1),A=Jl(D,d,1)}if(l>p){if(r)throw"unexpected EOF";break}}a&&n(h+131072);for(var T=(1<<u)-1,F=(1<<d)-1,L=l;;L=l){var P=(S=c[ih(e,l)&T])>>>4;if((l+=15&S)>p){if(r)throw"unexpected EOF";break}if(!S)throw"invalid length/literal";if(P<256)t[h++]=P;else{if(256==P){L=l,c=null;break}var _=P-254;if(P>264){var z=zl[C=P-257];_=th(e,l,(1<<z)-1)+ql[C],l+=z}var U=A[ih(e,l)&F],N=U>>>4;if(!U)throw"invalid distance";l+=15&U;D=Hl[N];if(N>3){z=Ul[N];D+=ih(e,l)&(1<<z)-1,l+=z}if(l>p){if(r)throw"unexpected EOF";break}a&&n(h+131072);for(var G=h+_;h<G;h+=4)t[h]=t[h-D],t[h+1]=t[h+1-D],t[h+2]=t[h+2-D],t[h+3]=t[h+3-D];h=G}}i.l=c,i.p=L,i.b=h,c&&(o=1,i.m=u,i.d=A,i.n=d)}while(!o);return h==t.length?t:function(e,t,i){(null==i||i>e.length)&&(i=e.length);var s=new(e instanceof Pl?Pl:e instanceof _l?_l:Ll)(i-t);return s.set(e.subarray(t,i)),s}(t,0,h)},rh=new Ll(0);function nh(e,t){return ah((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),t)}var oh="undefined"!=typeof TextDecoder&&new TextDecoder;try{oh.decode(rh,{stream:!0})}catch(e){}class lh extends ht{constructor(e){super(e),this.type=ct}parse(e){const t=65536,i=14,s=65537,a=16384,r=Math.pow(2.7182818,2.2);const n={l:0,c:0,lc:0};function o(e,t,i,s,a){for(;i<e;)t=t<<8|G(s,a),i+=8;i-=e,n.l=t>>i&(1<<e)-1,n.c=t,n.lc=i}const l=new Array(59);function h(e,t,i,a,r,h){const c=t;let A=0,u=0;for(;a<=r;a++){if(c.value-t.value>i)return!1;o(6,A,u,e,c);const s=n.l;if(A=n.c,u=n.lc,h[a]=s,63==s){if(c.value-t.value>i)throw new Error("Something wrong with hufUnpackEncTable");o(8,A,u,e,c);let s=n.l+6;if(A=n.c,u=n.lc,a+s>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;s--;)h[a++]=0;a--}else if(s>=59){let e=s-59+2;if(a+e>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)h[a++]=0;a--}}!function(e){for(let e=0;e<=58;++e)l[e]=0;for(let t=0;t<s;++t)l[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const i=t+l[e]>>1;l[e]=t,t=i}for(let t=0;t<s;++t){const i=e[t];i>0&&(e[t]=i|l[i]++<<6)}}(h)}function c(e){return 63&e}function A(e){return e>>6}const u={c:0,lc:0};function d(e,t,i,s){e=e<<8|G(i,s),t+=8,u.c=e,u.lc=t}const p={c:0,lc:0};function g(e,t,i,s,a,r,n,o,l){if(e==t){s<8&&(d(i,s,a,r),i=u.c,s=u.lc);let e=i>>(s-=8);if(e=new Uint8Array([e])[0],o.value+e>l)return!1;const t=n[o.value-1];for(;e-- >0;)n[o.value++]=t}else{if(!(o.value<l))return!1;n[o.value++]=e}p.c=i,p.lc=s}function m(e){return 65535&e}function f(e){const t=m(e);return t>32767?t-65536:t}const b={a:0,b:0};function y(e,t){const i=f(e),s=f(t),a=i+(1&s)+(s>>1),r=a,n=a-s;b.a=r,b.b=n}function w(e,t){const i=m(e),s=m(t),a=i-(s>>1)&65535,r=s+a-32768&65535;b.a=r,b.b=a}function I(e,t,i,s,a,r,n){const o=n<16384,l=i>a?a:i;let h,c,A=1;for(;A<=l;)A<<=1;for(A>>=1,h=A,A>>=1;A>=1;){c=0;const n=c+r*(a-h),l=r*A,u=r*h,d=s*A,p=s*h;let g,m,f,I;for(;c<=n;c+=u){let a=c;const r=c+s*(i-h);for(;a<=r;a+=p){const i=a+d,s=a+l,r=s+d;o?(y(e[a+t],e[s+t]),g=b.a,f=b.b,y(e[i+t],e[r+t]),m=b.a,I=b.b,y(g,m),e[a+t]=b.a,e[i+t]=b.b,y(f,I),e[s+t]=b.a,e[r+t]=b.b):(w(e[a+t],e[s+t]),g=b.a,f=b.b,w(e[i+t],e[r+t]),m=b.a,I=b.b,w(g,m),e[a+t]=b.a,e[i+t]=b.b,w(f,I),e[s+t]=b.a,e[r+t]=b.b)}if(i&A){const i=a+l;o?y(e[a+t],e[i+t]):w(e[a+t],e[i+t]),g=b.a,e[i+t]=b.b,e[a+t]=g}}if(a&A){let a=c;const r=c+s*(i-h);for(;a<=r;a+=p){const i=a+d;o?y(e[a+t],e[i+t]):w(e[a+t],e[i+t]),g=b.a,e[i+t]=b.b,e[a+t]=g}}h=A,A>>=1}return c}function E(e,t,r,n,o,l){const m=r.value,f=N(t,r),b=N(t,r);r.value+=4;const y=N(t,r);if(r.value+=4,f<0||f>=s||b<0||b>=s)throw new Error("Something wrong with HUF_ENCSIZE");const w=new Array(s),I=new Array(a);!function(e){for(let t=0;t<a;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(I);if(h(e,r,n-(r.value-m),f,b,w),y>8*(n-(r.value-m)))throw new Error("Something wrong with hufUncompress");!function(e,t,s,a){for(;t<=s;t++){const s=A(e[t]),r=c(e[t]);if(s>>r)throw new Error("Invalid table entry");if(r>i){const e=a[s>>r-i];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let i=0;i<e.lit-1;++i)e.p[i]=t[i]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(r){let e=0;for(let n=1<<i-r;n>0;n--){const n=a[(s<<i-r)+e];if(n.len||n.p)throw new Error("Invalid table entry");n.len=r,n.lit=t,e++}}}}(w,f,b,I),function(e,t,s,a,r,n,o,l,h){let m=0,f=0;const b=o,y=Math.trunc(a.value+(r+7)/8);for(;a.value<y;)for(d(m,f,s,a),m=u.c,f=u.lc;f>=i;){const r=t[m>>f-i&16383];if(r.len)f-=r.len,g(r.lit,n,m,f,s,a,l,h,b),m=p.c,f=p.lc;else{if(!r.p)throw new Error("hufDecode issues");let t;for(t=0;t<r.lit;t++){const i=c(e[r.p[t]]);for(;f<i&&a.value<y;)d(m,f,s,a),m=u.c,f=u.lc;if(f>=i&&A(e[r.p[t]])==(m>>f-i&(1<<i)-1)){f-=i,g(r.p[t],n,m,f,s,a,l,h,b),m=p.c,f=p.lc;break}}if(t==r.lit)throw new Error("hufDecode issues")}}const w=8-r&7;for(m>>=w,f-=w;f>0;){const e=t[m<<i-f&16383];if(!e.len)throw new Error("hufDecode issues");f-=e.len,g(e.lit,n,m,f,s,a,l,h,b),m=p.c,f=p.lc}}(w,I,e,r,y,b,l,o,{value:0})}function C(e){for(let t=1;t<e.length;t++){const i=e[t-1]+e[t]-128;e[t]=i}}function v(e,t){let i=0,s=Math.floor((e.length+1)/2),a=0;const r=e.length-1;for(;!(a>r||(t[a++]=e[i++],a>r));)t[a++]=e[s++]}function B(e){let t=e.byteLength;const i=new Array;let s=0;const a=new DataView(e);for(;t>0;){const e=a.getInt8(s++);if(e<0){const r=-e;t-=r+1;for(let e=0;e<r;e++)i.push(a.getUint8(s++))}else{const r=e;t-=2;const n=a.getUint8(s++);for(let e=0;e<r+1;e++)i.push(n)}}return i}function x(e,t,i){let s,a=1;for(;a<64;)s=t[e.value],65280==s?a=64:s>>8==255?a+=255&s:(i[a]=s,a++),e.value++}function k(e,t){t[0]=V(e[0]),t[1]=V(e[1]),t[2]=V(e[5]),t[3]=V(e[6]),t[4]=V(e[14]),t[5]=V(e[15]),t[6]=V(e[27]),t[7]=V(e[28]),t[8]=V(e[2]),t[9]=V(e[4]),t[10]=V(e[7]),t[11]=V(e[13]),t[12]=V(e[16]),t[13]=V(e[26]),t[14]=V(e[29]),t[15]=V(e[42]),t[16]=V(e[3]),t[17]=V(e[8]),t[18]=V(e[12]),t[19]=V(e[17]),t[20]=V(e[25]),t[21]=V(e[30]),t[22]=V(e[41]),t[23]=V(e[43]),t[24]=V(e[9]),t[25]=V(e[11]),t[26]=V(e[18]),t[27]=V(e[24]),t[28]=V(e[31]),t[29]=V(e[40]),t[30]=V(e[44]),t[31]=V(e[53]),t[32]=V(e[10]),t[33]=V(e[19]),t[34]=V(e[23]),t[35]=V(e[32]),t[36]=V(e[39]),t[37]=V(e[45]),t[38]=V(e[52]),t[39]=V(e[54]),t[40]=V(e[20]),t[41]=V(e[22]),t[42]=V(e[33]),t[43]=V(e[38]),t[44]=V(e[46]),t[45]=V(e[51]),t[46]=V(e[55]),t[47]=V(e[60]),t[48]=V(e[21]),t[49]=V(e[34]),t[50]=V(e[37]),t[51]=V(e[47]),t[52]=V(e[50]),t[53]=V(e[56]),t[54]=V(e[59]),t[55]=V(e[61]),t[56]=V(e[35]),t[57]=V(e[36]),t[58]=V(e[48]),t[59]=V(e[49]),t[60]=V(e[57]),t[61]=V(e[58]),t[62]=V(e[62]),t[63]=V(e[63])}function Q(e){const t=.5*Math.cos(.7853975),i=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),a=.5*Math.cos(3*3.14159/16),r=.5*Math.cos(.981746875),n=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),A=new Array(4);for(let u=0;u<8;++u){const d=8*u;l[0]=s*e[d+2],l[1]=n*e[d+2],l[2]=s*e[d+6],l[3]=n*e[d+6],h[0]=i*e[d+1]+a*e[d+3]+r*e[d+5]+o*e[d+7],h[1]=a*e[d+1]-o*e[d+3]-i*e[d+5]-r*e[d+7],h[2]=r*e[d+1]-i*e[d+3]+o*e[d+5]+a*e[d+7],h[3]=o*e[d+1]-r*e[d+3]+a*e[d+5]-i*e[d+7],c[0]=t*(e[d+0]+e[d+4]),c[3]=t*(e[d+0]-e[d+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[d+0]=A[0]+h[0],e[d+1]=A[1]+h[1],e[d+2]=A[2]+h[2],e[d+3]=A[3]+h[3],e[d+4]=A[3]-h[3],e[d+5]=A[2]-h[2],e[d+6]=A[1]-h[1],e[d+7]=A[0]-h[0]}for(let u=0;u<8;++u)l[0]=s*e[16+u],l[1]=n*e[16+u],l[2]=s*e[48+u],l[3]=n*e[48+u],h[0]=i*e[8+u]+a*e[24+u]+r*e[40+u]+o*e[56+u],h[1]=a*e[8+u]-o*e[24+u]-i*e[40+u]-r*e[56+u],h[2]=r*e[8+u]-i*e[24+u]+o*e[40+u]+a*e[56+u],h[3]=o*e[8+u]-r*e[24+u]+a*e[40+u]-i*e[56+u],c[0]=t*(e[u]+e[32+u]),c[3]=t*(e[u]-e[32+u]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],A[0]=c[0]+c[1],A[1]=c[3]+c[2],A[2]=c[3]-c[2],A[3]=c[0]-c[1],e[0+u]=A[0]+h[0],e[8+u]=A[1]+h[1],e[16+u]=A[2]+h[2],e[24+u]=A[3]+h[3],e[32+u]=A[3]-h[3],e[40+u]=A[2]-h[2],e[48+u]=A[1]-h[1],e[56+u]=A[0]-h[0]}function S(e){for(let t=0;t<64;++t){const i=e[0][t],s=e[1][t],a=e[2][t];e[0][t]=i+1.5747*a,e[1][t]=i-.1873*s-.4682*a,e[2][t]=i+1.8556*s}}function M(e,t,i){for(let s=0;s<64;++s)t[i+s]=ut.toHalfFloat(R(e[s]))}function R(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(r,Math.abs(e)-1)}function D(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function T(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),i=new Uint8Array(B(t)),s=new Uint8Array(i.length);return C(i),v(i,s),new DataView(s.buffer)}function F(e){const t=nh(e.array.slice(e.offset.value,e.offset.value+e.size)),i=new Uint8Array(t.length);return C(t),v(t,i),new DataView(i.buffer)}function L(e){const i=e.viewer,s={value:e.offset.value},a=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),r=new Uint8Array(8192);let n=0;const o=new Array(e.inputChannels.length);for(let t=0,i=e.inputChannels.length;t<i;t++)o[t]={},o[t].start=n,o[t].end=o[t].start,o[t].nx=e.columns,o[t].ny=e.lines,o[t].size=e.type,n+=o[t].nx*o[t].ny*o[t].size;const l=K(i,s),h=K(i,s);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let e=0;e<h-l+1;e++)r[e+l]=O(i,s);const c=new Uint16Array(t),A=function(e,i){let s=0;for(let a=0;a<t;++a)(0==a||e[a>>3]&1<<(7&a))&&(i[s++]=a);const a=s-1;for(;s<t;)i[s++]=0;return a}(r,c),u=N(i,s);E(e.array,i,s,u,a,n);for(let t=0;t<e.inputChannels.length;++t){const e=o[t];for(let i=0;i<o[t].size;++i)I(a,e.start+i,e.nx,e.size,e.ny,e.nx*e.size,A)}!function(e,t,i){for(let s=0;s<i;++s)t[s]=e[t[s]]}(c,a,n);let d=0;const p=new Uint8Array(a.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){const e=o[t],i=e.nx*e.size,s=new Uint8Array(a.buffer,2*e.end,2*i);p.set(s,d),d+=2*i,e.end+=i}return new DataView(p.buffer)}function P(e){const t=nh(e.array.slice(e.offset.value,e.offset.value+e.size)),i=e.inputChannels.length*e.lines*e.columns*e.totalBytes,s=new ArrayBuffer(i),a=new DataView(s);let r=0,n=0;const o=new Array(4);for(let i=0;i<e.lines;i++)for(let i=0;i<e.inputChannels.length;i++){let s=0;switch(e.inputChannels[i].pixelType){case 1:o[0]=r,o[1]=o[0]+e.columns,r=o[1]+e.columns;for(let i=0;i<e.columns;++i){s+=t[o[0]++]<<8|t[o[1]++],a.setUint16(n,s,!0),n+=2}break;case 2:o[0]=r,o[1]=o[0]+e.columns,o[2]=o[1]+e.columns,r=o[2]+e.columns;for(let i=0;i<e.columns;++i){s+=t[o[0]++]<<24|t[o[1]++]<<16|t[o[2]++]<<8,a.setUint32(n,s,!0),n+=4}}}return a}function _(e){const t=e.viewer,i={value:e.offset.value},s=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),a={version:q(t,i),unknownUncompressedSize:q(t,i),unknownCompressedSize:q(t,i),acCompressedSize:q(t,i),dcCompressedSize:q(t,i),rleCompressedSize:q(t,i),rleUncompressedSize:q(t,i),rleRawSize:q(t,i),totalAcUncompressedCount:q(t,i),totalDcUncompressedCount:q(t,i),acCompression:q(t,i)};if(a.version<2)throw new Error("EXRLoader.parse: "+se.compression+" version "+a.version+" is unsupported");const r=new Array;let n=K(t,i)-2;for(;n>0;){const e=z(t.buffer,i),s=O(t,i),a=s>>2&3,o=new Int8Array([(s>>4)-1])[0],l=O(t,i);r.push({name:e,index:o,type:l,compression:a}),n-=e.length+3}const o=se.channels,l=new Array(e.inputChannels.length);for(let t=0;t<e.inputChannels.length;++t){const i=l[t]={},s=o[t];i.name=s.name,i.compression=0,i.decoded=!1,i.type=s.pixelType,i.pLinear=s.pLinear,i.width=e.columns,i.height=e.lines}const h={idx:new Array(3)};for(let t=0;t<e.inputChannels.length;++t){const e=l[t];for(let i=0;i<r.length;++i){const s=r[i];e.name==s.name&&(e.compression=s.compression,s.index>=0&&(h.idx[s.index]=t),e.offset=t)}}let c,A,u;if(a.acCompressedSize>0)switch(a.acCompression){case 0:c=new Uint16Array(a.totalAcUncompressedCount),E(e.array,t,i,a.acCompressedSize,c,a.totalAcUncompressedCount);break;case 1:const s=nh(e.array.slice(i.value,i.value+a.totalAcUncompressedCount));c=new Uint16Array(s.buffer),i.value+=a.totalAcUncompressedCount}if(a.dcCompressedSize>0){const t={array:e.array,offset:i,size:a.dcCompressedSize};A=new Uint16Array(F(t).buffer),i.value+=a.dcCompressedSize}if(a.rleRawSize>0){u=B(nh(e.array.slice(i.value,i.value+a.rleCompressedSize)).buffer),i.value+=a.rleCompressedSize}let d=0;const p=new Array(l.length);for(let e=0;e<p.length;++e)p[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<l.length;++t)p[t].push(d),d+=l[t].width*e.type*2;!function(e,t,i,s,a,r){let n=new DataView(r.buffer);const o=i[e.idx[0]].width,l=i[e.idx[0]].height,h=Math.floor(o/8),c=Math.ceil(o/8),A=Math.ceil(l/8),u=o-8*(c-1),d=l-8*(A-1),p={value:0},g=new Array(3),m=new Array(3),f=new Array(3),b=new Array(3),y=new Array(3);for(let i=0;i<3;++i)y[i]=t[e.idx[i]],g[i]=i<1?0:g[i-1]+c*A,m[i]=new Float32Array(64),f[i]=new Uint16Array(64),b[i]=new Uint16Array(64*c);for(let t=0;t<A;++t){let r=8;t==A-1&&(r=d);let o=8;for(let e=0;e<c;++e){e==c-1&&(o=u);for(let e=0;e<3;++e)f[e].fill(0),f[e][0]=a[g[e]++],x(p,s,f[e]),k(f[e],m[e]),Q(m[e]);S(m);for(let t=0;t<3;++t)M(m[t],b[t],64*e)}let l=0;for(let s=0;s<3;++s){const a=i[e.idx[s]].type;for(let e=8*t;e<8*t+r;++e){l=y[s][e];for(let t=0;t<h;++t){const i=64*t+8*(7&e);n.setUint16(l+0*a,b[s][i+0],!0),n.setUint16(l+2*a,b[s][i+1],!0),n.setUint16(l+4*a,b[s][i+2],!0),n.setUint16(l+6*a,b[s][i+3],!0),n.setUint16(l+8*a,b[s][i+4],!0),n.setUint16(l+10*a,b[s][i+5],!0),n.setUint16(l+12*a,b[s][i+6],!0),n.setUint16(l+14*a,b[s][i+7],!0),l+=16*a}}if(h!=c)for(let e=8*t;e<8*t+r;++e){const t=y[s][e]+8*h*2*a,i=64*h+8*(7&e);for(let e=0;e<o;++e)n.setUint16(t+2*e*a,b[s][i+e],!0)}}}const w=new Uint16Array(o);n=new DataView(r.buffer);for(let t=0;t<3;++t){i[e.idx[t]].decoded=!0;const s=i[e.idx[t]].type;if(2==i[t].type)for(let e=0;e<l;++e){const i=y[t][e];for(let e=0;e<o;++e)w[e]=n.getUint16(i+2*e*s,!0);for(let e=0;e<o;++e)n.setFloat32(i+2*e*s,V(w[e]),!0)}}}(h,p,l,c,A,s);for(let t=0;t<l.length;++t){const i=l[t];if(!i.decoded){if(2!==i.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let a=0,r=0;for(let n=0;n<e.lines;++n){let e=p[t][a];for(let t=0;t<i.width;++t){for(let t=0;t<2*i.type;++t)s[e++]=u[r+t*i.width*i.height];r++}a++}}}}return new DataView(s.buffer)}function z(e,t){const i=new Uint8Array(e);let s=0;for(;0!=i[t.value+s];)s+=1;const a=(new TextDecoder).decode(i.slice(t.value,t.value+s));return t.value=t.value+s+1,a}function U(e,t){const i=e.getInt32(t.value,!0);return t.value=t.value+4,i}function N(e,t){const i=e.getUint32(t.value,!0);return t.value=t.value+4,i}function G(e,t){const i=e[t.value];return t.value=t.value+1,i}function O(e,t){const i=e.getUint8(t.value);return t.value=t.value+1,i}const q=function(e,t){let i;return i="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,i};function j(e,t){const i=e.getFloat32(t.value,!0);return t.value+=4,i}function H(e,t){return ut.toHalfFloat(j(e,t))}function V(e){const t=(31744&e)>>10,i=1023&e;return(e>>15?-1:1)*(t?31===t?i?NaN:1/0:Math.pow(2,t-15)*(1+i/1024):i/1024*6103515625e-14)}function K(e,t){const i=e.getUint16(t.value,!0);return t.value+=2,i}function W(e,t){return V(K(e,t))}function J(e,t,i,s,a){return"string"===s||"stringvector"===s||"iccProfile"===s?function(e,t,i){const s=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+i));return t.value=t.value+i,s}(t,i,a):"chlist"===s?function(e,t,i,s){const a=i.value,r=[];for(;i.value<a+s-1;){const s=z(t,i),a=U(e,i),n=O(e,i);i.value+=3;const o=U(e,i),l=U(e,i);r.push({name:s,pixelType:a,pLinear:n,xSampling:o,ySampling:l})}return i.value+=1,r}(e,t,i,a):"chromaticities"===s?function(e,t){return{redX:j(e,t),redY:j(e,t),greenX:j(e,t),greenY:j(e,t),blueX:j(e,t),blueY:j(e,t),whiteX:j(e,t),whiteY:j(e,t)}}(e,i):"compression"===s?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][O(e,t)]}(e,i):"box2i"===s?function(e,t){return{xMin:U(e,t),yMin:U(e,t),xMax:U(e,t),yMax:U(e,t)}}(e,i):"envmap"===s?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][O(e,t)]}(e,i):"tiledesc"===s?function(e,t){const i=N(e,t),s=N(e,t),a=O(e,t);return{xSize:i,ySize:s,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&a],roundingMode:["ROUND_DOWN","ROUND_UP"][a>>4]}}(e,i):"lineOrder"===s?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][O(e,t)]}(e,i):"float"===s?j(e,i):"v2f"===s?function(e,t){return[j(e,t),j(e,t)]}(e,i):"v3f"===s?function(e,t){return[j(e,t),j(e,t),j(e,t)]}(e,i):"int"===s?U(e,i):"rational"===s?function(e,t){return[U(e,t),N(e,t)]}(e,i):"timecode"===s?function(e,t){return[N(e,t),N(e,t)]}(e,i):"preview"===s?(i.value+=a,"skipped"):void(i.value+=a)}function X(e,t,i){let s=0;switch(e.levelMode){case"ONE_LEVEL":s=1;break;case"MIPMAP_LEVELS":s=function(e,t){const i=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(i):Math.ceil(i)}(Math.max(t,i),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return s}function Y(e,t,i,s){const a=new Array(e);for(let r=0;r<e;r++){const e=1<<r;let n=t/e|0;"ROUND_UP"==s&&n*e<t&&(n+=1);const o=Math.max(n,1);a[r]=(o+i-1)/i|0}return a}function Z(){const e=this,t=e.offset,i={value:0};for(let s=0;s<e.tileCount;s++){const s=U(e.viewer,t),a=U(e.viewer,t);t.value+=8,e.size=N(e.viewer,t);const r=s*e.blockWidth,n=a*e.blockHeight;e.columns=r+e.blockWidth>e.width?e.width-r:e.blockWidth,e.lines=n+e.blockHeight>e.height?e.height-n:e.blockHeight;const o=e.columns*e.totalBytes,l=e.size<e.lines*o?e.uncompress(e):D(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const s=t*e.columns*e.totalBytes;for(let a=0;a<e.inputChannels.length;a++){const o=se.channels[a].name,h=e.channelByteOffsets[o]*e.columns,c=e.decodeChannels[o];if(void 0===c)continue;i.value=s+h;const A=(e.height-(1+n+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const s=A+(t+r)*e.outputChannels+c;e.byteArray[s]=e.getter(l,i)}}}}}function $(){const e=this,t=e.offset,i={value:0};for(let s=0;s<e.height/e.blockHeight;s++){const a=U(e.viewer,t)-se.dataWindow.yMin;e.size=N(e.viewer,t),e.lines=a+e.blockHeight>e.height?e.height-a:e.blockHeight;const r=e.columns*e.totalBytes,n=e.size<e.lines*r?e.uncompress(e):D(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const a=s*e.blockHeight,o=t+e.scanOrder(a);if(o>=e.height)continue;const l=t*r,h=(e.height-1-o)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const s=se.channels[t].name,a=e.channelByteOffsets[s]*e.columns,r=e.decodeChannels[s];if(void 0!==r){i.value=l+a;for(let t=0;t<e.columns;t++){const s=h+t*e.outputChannels+r;e.byteArray[s]=e.getter(n,i)}}}}}}const ee={value:0},te=new DataView(e),ie=new Uint8Array(e),se=function(e,t,i){const s={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");s.version=e.getUint8(4);const a=e.getUint8(5);s.spec={singleTile:!!(2&a),longName:!!(4&a),deepFormat:!!(8&a),multiPart:!!(16&a)},i.value=8;let r=!0;for(;r;){const a=z(t,i);if(0==a)r=!1;else{const r=z(t,i),n=J(e,t,i,r,N(e,i));void 0===n?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${r}'.`):s[a]=n}}if(-7&a)throw console.error("THREE.EXRHeader:",s),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return s}(te,e,ee),ae=function(e,t,i,s,a){const r={size:0,viewer:t,array:i,offset:s,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:we};switch(e.compression){case"NO_COMPRESSION":r.blockHeight=1,r.uncompress=D;break;case"RLE_COMPRESSION":r.blockHeight=1,r.uncompress=T;break;case"ZIPS_COMPRESSION":r.blockHeight=1,r.uncompress=F;break;case"ZIP_COMPRESSION":r.blockHeight=16,r.uncompress=F;break;case"PIZ_COMPRESSION":r.blockHeight=32,r.uncompress=L;break;case"PXR24_COMPRESSION":r.blockHeight=16,r.uncompress=P;break;case"DWAA_COMPRESSION":r.blockHeight=32,r.uncompress=_;break;case"DWAB_COMPRESSION":r.blockHeight=256,r.uncompress=_;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const n={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":n[t.name]=!0,r.type=t.pixelType}let o=!1;if(n.R&&n.G&&n.B)o=!n.A,r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else{if(!n.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");r.outputChannels=1,r.decodeChannels={Y:0}}if(1==r.type)switch(a){case At:r.getter=W;break;case ct:r.getter=K}else{if(2!=r.type)throw new Error("EXRLoader.parse: unsupported pixelType "+r.type+" for "+e.compression+".");switch(a){case At:r.getter=j;break;case ct:r.getter=H}}r.columns=r.width;const l=r.width*r.height*r.outputChannels;switch(a){case At:r.byteArray=new Float32Array(l),o&&r.byteArray.fill(1,0,l);break;case ct:r.byteArray=new Uint16Array(l),o&&r.byteArray.fill(15360,0,l);break;default:console.error("THREE.EXRLoader: unsupported type: ",a)}let h=0;for(const t of e.channels)void 0!==r.decodeChannels[t.name]&&(r.channelByteOffsets[t.name]=h),h+=2*t.pixelType;if(r.totalBytes=h,r.outLineWidth=r.width*r.outputChannels,"INCREASING_Y"===e.lineOrder?r.scanOrder=e=>e:r.scanOrder=e=>r.height-1-e,4==r.outputChannels?(r.format=dt,r.colorSpace=we):(r.format=pt,r.colorSpace=gt),e.spec.singleTile){r.blockHeight=e.tiles.ySize,r.blockWidth=e.tiles.xSize;const i=X(e.tiles,r.width,r.height),a=Y(i,r.width,e.tiles.xSize,e.tiles.roundingMode),n=Y(i,r.height,e.tiles.ySize,e.tiles.roundingMode);r.tileCount=a[0]*n[0];for(let e=0;e<i;e++)for(let i=0;i<n[e];i++)for(let i=0;i<a[e];i++)q(t,s);r.decode=Z.bind(r)}else{r.blockWidth=r.width;const e=Math.ceil(r.height/r.blockHeight);for(let i=0;i<e;i++)q(t,s);r.decode=$.bind(r)}return r}(se,te,ie,ee,this.type);return ae.decode(),{header:se,width:ae.width,height:ae.height,data:ae.byteArray,format:ae.format,colorSpace:ae.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,s){return super.load(e,(function(e,i){e.colorSpace=i.colorSpace,e.minFilter=De,e.magFilter=De,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,i)}),i,s)}}const hh={sunPosition:new W(.27,1,.5),sunTop:new W(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new p(16777209).multiplyScalar(1),skyColor:new p(4348022),fogColor:new p(11253184),groundColor:new p(8421504),sunColor:new p(16777215).multiplyScalar(3)},ch={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:hh.sunPosition},sunTop:{value:hh.sunTop},noiseMap:{value:hh.noiseMap},mixRatio:{value:hh.mixRatio},cloud_size:{value:hh.cloud_size},cloud_covr:{value:hh.cloud_covr},cloud_dens:{value:hh.cloud_dens},cloud_dist:{value:hh.cloud_dist},nightLuminosity:{value:hh.nightLuminosity},haze:{value:hh.haze},saturation:{value:hh.saturation},SAMPLE:{value:hh.SAMPLE},STEP:{value:hh.STEP},fogy:{value:hh.fogy},t:{value:1},fogColor:{value:hh.fogColor},groundColor:{value:hh.groundColor},cloudColor:{value:hh.cloudColor},skyColor:{value:hh.skyColor},sunColor:{value:hh.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},Ah=Math.PI/180;class uh{constructor(e={}){this.mainScene=e.scene,this.renderer=e.renderer,this.usePrem=void 0!==e.usePmrem&&e.usePmrem,this.useBackground=void 0===e.useBackground||e.useBackground,this.envBlur=void 0!==e.envBlur?e.envBlur:0,this.callback=e.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new Kt(this.renderer),this.pmremGenerator.compileEquirectangularShader()),e.cube&&this.initCubeEnv(e),e.url&&this.load(e.url)}initCubeEnv(e={}){this.isCubeEnv=!0,this._quality=e.quality||1,this.scene=new Wt,e.color&&(this.scene.background=new p(e.color)),this.target=new Jt(256*this._quality,{minFilter:De,type:ct,colorSpace:u,anisotropy:1}),this.camera=new Xt(e.near||.1,e.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let e=new Yt(20,1);const t=new Zt(ch);this.sky=new Z(e,t),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return hh}setSkyOtion(e){if(!this.isSky)return;let t=this.sky.material.uniforms;for(let i in e)t[i]&&(t[i].value=e[i]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const e=this.renderer,t=e.toneMapping;e.toneMapping=$t,this.camera.update(e,this.scene),e.toneMapping=t}load(e){switch(this.name=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),this.type=e.substring(e.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new Tl).load(e,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new lh).load(e,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let e;switch(this.type){case"hdr":case"exr":e=this.loader,e.mapping=nt;break;case"jpg":e=this.loader.renderTarget.texture,e.mapping=nt}this.usePrem&&(e=this.pmremGenerator.fromEquirectangular(e).texture,this.pmremGenerator.dispose()),e.needsUpdate=!0;const t=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(t.background=e),this.envBlur&&(t.backgroundBlurriness=this.envBlur),t.environment=e,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(e){this.mainScene.environmentIntensity=e}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(e){this.mainScene.backgroundIntensity=e}get blur(){return this.mainScene.backgroundBlurriness}set blur(e){this.mainScene.backgroundBlurriness=e}rotate(e=0,t=0,i=0){0!==e&&(e*=Ah),0!==t&&(t*=Ah),0!==i&&(i*=Ah),this.mainScene.environmentRotation.set(e,t,i),this.mainScene.backgroundRotation.set(e,t,i)}}const dh=Math.PI/180,ph=[new W(1,0,0),new W(0,1,0),new W(0,0,1)],gh=new W,mh=new W,fh=new W,bh=new W,yh=[],wh=[],Ih=new W,Eh=new W,Ch=new W;new J;class vh{constructor(e={},t){this.motor=t,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=e.name||"car",this.mass=e.mass||1e3,this.size=e.size||[1.5,.7,3.8],this.pos=e.pos||[0,4,0],this.rot=e.rot||[0,0,0],this.friction=e.friction||.2,this.restitution=e.restitution||.3,this.massCenter=e.massCenter||[0,0,0],this.driveWheel=e.driveWheel||null;let i=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];e.shapeMesh&&(i=[{type:"convex",shape:e.shapeMesh.geometry,pos:e.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:i,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:e.bodyMesh||null,meshPos:e.meshPos||[0,-1.1,0],material:e.material,damping:[.05,.05],debug:!1}),this.body.inertia=new W(1.416666865348816,1.666666865348816,.416666716337204),this.vehicle=new Bh({chassis:this.body},this.motor);let s=e.wheelPosition||[.61,0,1.2];const a=[new W(-s[0],s[1],-s[2]),new W(s[0],s[1],-s[2]),new W(-s[0],s[1],s[2]),new W(s[0],s[1],s[2])],r={radius:e.wheelRadius||.31,directionLocal:new W(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new W(1,0,0),chassisConnectionPointLocal:new W(1,1,0)};let o,l,h;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),a.forEach((e=>{r.chassisConnectionPointLocal.copy(e),this.vehicle.addWheel(r)}));let c=this.motor.getMat("debug");if(e.wheelMesh?(l=e.wheelMesh,h=e.wheelMesh2?e.wheelMesh2:null,e.material&&(c=e.material||c,l.material=c,h&&(h.material=c))):(o=new n(r.radius,r.radius,e.wheelDepth||.2),o.rotateZ(.5*Math.PI),l=new Z(o,c),h=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[h||l.clone(),l,h?h.clone():l.clone(),l.clone()];let e=this.vehicle.wheelMeshes.length,t=0;for(;e--;)this.body.add(this.vehicle.wheelMeshes[t++])}else m.matrixAutoUpdate=!1,h&&(h.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(h||m.clone()),this.motor.add(m),this.motor.add(h?h.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let e=this.motor.getDelta();this.motor.getAzimut();let t=this.motor.getKey();this.tmp.forwardForce=t[1],this.tmp.steerDirection=-1*t[0],this.tmp.brakeForce=1===t[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let i=Math.abs(this.vehicle.currentVehicleSpeedKmHour);i=Math.min(i,this.maxSpeed),this.maxSpeed;const s=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(s,0),this.vehicle.applyEngineForce(s,1),this.vehicle.applyEngineForce(s,2),this.vehicle.applyEngineForce(s,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(e),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*dh)}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.vehicle&&this.vehicle.setWheels(e,this.extra[e])}})}}class Bh{constructor(e,t){this.motor=t,this.chassisBody=e.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:0,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:2,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(e={}){let t=new Qh(e,this.motor),i=this.wheelInfos.length-1;t.chassisBody=this.chassisBody;let s=t.suspensionRestLength+t.radius;return t.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+i,begin:t.chassisConnectionPointLocal.toArray(),end:[t.chassisConnectionPointLocal.x,-s,t.chassisConnectionPointLocal.z],callback:function(e){t.castRay(e)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(t),i}setWheels(e,t){let i,s=this.wheelInfos.length;for(;s--;)i=this.wheelInfos[s],i[e]&&(i[e]=t)}setSteeringValue(e,t){this.wheelInfos[t].steering=e}applyEngineForce(e,t){this.wheelInfos[t].engineForce=e}setBrake(e,t){this.wheelInfos[t].brake=e}getVehicleAxisWorld(e,t){return t.set(0===e?1:0,1===e?1:0,2===e?1:0),Gh(t,Fh(this.chassisBody,new J),t),t}updateVehicle(e){let t=this.wheelInfos,i=t.length,s=this.chassisBody,a=i;for(;a--;)this.updateWheelTransform(a);const r=Th(s,new W),n=Oh(r,Fh(s,new J).invert(),new W);this.currentVehicleSpeedKmHour=n.z;let o=new W;this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(e);let l=new W;for(new W,a=0;a<i;a++){let i=t[a],r=i.suspensionForce;r>i.maxSuspensionForce&&(r=i.maxSuspensionForce),l.copy(i.raycastResult.hitNormalWorld).multiplyScalar(r*e),Ph(this.motor,s,l,i.raycastResult.hitPointWorld)}this.updateFriction(e);let h=new W,c=new W,A=new W;for(a=0;a<i;a++){let i=t[a];_h(s,i.chassisConnectionPointWorld,A);let r=1;if(1===this.indexUpAxis)r=-1;if(i.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);let t=Uh(c,i.raycastResult.hitNormalWorld);h.copy(i.raycastResult.hitNormalWorld).multiplyScalar(t),c.sub(h);let s=Uh(c,A);i.deltaRotation=r*s*e/i.radius}!i.sliding&&i.isInContact||0===i.engineForce||!i.useCustomSlidingRotationalSpeed||(i.deltaRotation=(i.engineForce>0?1:-1)*i.customSlidingRotationalSpeed*e),Math.abs(i.brake)>Math.abs(i.engineForce)&&(i.deltaRotation=0),i.rotation-=i.deltaRotation,i.deltaRotation*=.99}}updateSuspension(e){let t=this.chassisBody,i=Mh(t),s=this.wheelInfos,a=s.length;for(let e=0;e<a;e++){let t=s[e];if(t.isInContact){let e,s=t.suspensionRestLength-t.suspensionLength;e=t.suspensionStiffness*s*t.clippedInvContactDotSuspension;let a,r=t.suspensionRelativeVelocity;a=r<0?t.dampingCompression:t.dampingRelaxation,e-=a*r,t.suspensionForce=e*i,t.suspensionForce<0&&(t.suspensionForce=0)}else t.suspensionForce=0}}updateFriction(e){let t,i,s,a=bh,r=this.wheelInfos,n=r.length,o=this.chassisBody,l=yh,h=wh;for(t=0;t<n;t++)if(i=r[t],s=i.raycastResult.body,i.sideImpulse=0,i.forwardImpulse=0,l[t]||(l[t]=new W),h[t]||(h[t]=new W),s){let e=h[t],r=this.getWheelTransformWorld(t);Oh(ph[this.indexRightAxis],r,e);let n=i.raycastResult.hitNormalWorld,c=Uh(e,n);a.copy(n).multiplyScalar(c),e.sub(a).normalize(),Nh(n,e,l[t]),l[t].normalize(),i.sideImpulse=$h(o,i.raycastResult.hitPointWorld,s,i.raycastResult.hitPointWorld,e),i.sideImpulse*=1}for(this.sliding=!1,t=0;t<n;t++){i=r[t],s=i.raycastResult.body;let a=0;if(i.slipInfo=1,s){let r=0,n=i.brake?i.brake:r;a=jh(o,s,i.raycastResult.hitPointWorld,l[t],n),a+=i.engineForce*e;let h=n/a;i.slipInfo*=h}if(i.forwardImpulse=0,i.skidInfo=1,s){i.skidInfo=1;let t=i.suspensionForce*e*i.frictionSlip,s=t*t;i.forwardImpulse=a;let r=.5*i.forwardImpulse/i.forwardAcceleration,n=1*i.sideImpulse/i.sideAcceleration,o=r*r+n*n;if(i.sliding=!1,o>s){this.sliding=!0,i.sliding=!0;let e=t/Math.sqrt(o);i.skidInfo*=e}}}if(this.sliding)for(let e=0;e<n;e++)i=r[e],0!==i.sideImpulse&&i.skidInfo<1&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(t=0;t<n;t++){i=r[t];let e=new W;if(e.copy(i.raycastResult.hitPointWorld).sub(Dh(o,new W)),0!==i.forwardImpulse){let e=new W;e.copy(l[t]).multiplyScalar(i.forwardImpulse),Ph(this.motor,o,e,i.raycastResult.hitPointWorld)}if(0!==i.sideImpulse){s=i.raycastResult.body,(new W).copy(i.raycastResult.hitPointWorld).sub(Dh(s,new W));let a=new W;a.copy(h[t]).multiplyScalar(i.sideImpulse),Oh(e,Fh(o,new J).invert(),e),e["xyz"[this.indexUpAxis]]*=i.rollInfluence,Oh(e,Fh(o,new J),e),Ph(this.motor,o,a,Dh(o,new W).add(e)),a.multiplyScalar(-1),Ph(this.motor,s,a,i.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(e){const t=this.chassisBody.matrixWorld;Gh(e.chassisConnectionPointLocal,t,e.chassisConnectionPointWorld),Oh(e.directionLocal,t,e.directionWorld)}updateWheelTransform(e){let t=Ih,i=Eh,s=Ch,a=this.wheelInfos[e];this.updateWheelTransformWorld(a),t.copy(a.directionLocal).multiplyScalar(-1),i.copy(a.axleLocal),Nh(t,i,s),s.normalize(),i.normalize();let r=a.steering,n=new Y;qh(t,r,n);let o=new Y;qh(i,a.rotation,o);let l=a.quaternion;Lh(this.chassisBody,l),l.multiply(n).multiply(o).normalize();let h=a.position;h.copy(a.directionWorld),h.multiplyScalar(a.suspensionLength);let c=h.clone();h.add(a.chassisConnectionPointWorld),a.matrix.compose(a.position,a.quaternion,{x:1,y:1,z:1}),this.localWheel?(c.add(a.chassisConnectionPointLocal),this.wheelMeshes[e].quaternion.copy(n).multiply(o).normalize(),this.wheelMeshes[e].position.copy(c),this.brakeMeshs&&(2!==e&&3!==e||this.brakeMeshs[e].quaternion.copy(n).normalize(),this.brakeMeshs[e].position.copy(c),this.brakeMeshs[e].updateMatrix())):(this.wheelMeshes[e].position.copy(a.position),this.wheelMeshes[e].quaternion.copy(a.quaternion),this.wheelMeshes[e].updateMatrix())}getWheelTransformWorld(e){return this.wheelInfos[e].matrix}}var xh=new W,kh=new W;class Qh{constructor(e,t){this.motor=t,e=((e,t)=>{for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e})(e,{chassisConnectionPointLocal:new W,chassisConnectionPointWorld:new W,directionLocal:new W,directionWorld:new W,axleLocal:new W,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointLocal.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionLocal.clone(),this.axleLocal=e.axleLocal.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.forwardAcceleration=e.forwardAcceleration,this.sideAcceleration=e.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Sh,this.position=(new W).copy(this.chassisConnectionPointLocal),this.quaternion=new Y,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new J}castRay(e){if(e.hit){this.isInContact=!0;let i=e.distance;this.raycastResult.hitPointWorld.fromArray(e.point),this.raycastResult.hitNormalWorld.fromArray(e.normal),this.raycastResult.body=this.motor.byName(e.body),this.suspensionLength=i-this.radius;let s=this.suspensionRestLength-this.maxSuspensionTravel,a=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<s&&(this.suspensionLength=s),this.suspensionLength>a&&(this.suspensionLength=a,this.raycastResult.reset());let r=Uh(this.raycastResult.hitNormalWorld,this.directionWorld);_h(this.chassisBody,this.raycastResult.hitPointWorld,xh);var t=Uh(this.raycastResult.hitNormalWorld,xh);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/r;this.suspensionRelativeVelocity=t*e,this.clippedInvContactDotSuspension=e}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(e){let t=this.raycastResult;if(this.isInContact){let i=t.hitNormalWorld.dot(t.directionWorld);kh.copy(t.hitPointWorld).sub(e.position),_h(e,kh,xh);let s=t.hitNormalWorld.dot(xh);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/i;this.suspensionRelativeVelocity=s*e,this.clippedInvContactDotSuspension=e}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.hitNormalWorld.copy(t.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class Sh{constructor(){this.body=null,this.hitPointWorld=new W,this.hitNormalWorld=new W,this.directionWorld=new W}reset(){this.body=null,this.hitPointWorld=new W,this.hitNormalWorld=new W,this.directionWorld=new W}}const Mh=e=>e.mass,Rh=e=>e.mass>0?1/e.mass:0,Dh=(e,t)=>t.copy(e.position),Th=(e,t)=>t.copy(e.velocity),Fh=(e,t)=>t.copy(e.matrixWorld),Lh=(e,t)=>t.copy(e.quaternion),Ph=(e,t,i,s)=>{e.change({name:t.name,impulse:i.toArray(),impulseCenter:s.toArray()})},_h=(e,t,i)=>(i.copy(t).sub(e.position),i.crossVectors(e.angular,i),i.add(e.velocity),i),zh=(e,t)=>(e.inertia&&t.copy(e.inertia),Oh(t,e.matrixWorld,t),t.x=t.x>0?1/t.x:0,t.y=t.y>0?1/t.y:0,t.z=t.z>0?1/t.z:0,t),Uh=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,Nh=(e,t,i)=>{const s=e.y*t.z-e.z*t.y,a=e.z*t.x-e.x*t.z,r=e.x*t.y-e.y*t.x;return i.set(s,a,r),i},Gh=(e,t,i)=>{const s=e.x,a=e.y,r=e.z,n=t.elements,o=s*n[0]+a*n[4]+r*n[8]+n[12],l=s*n[1]+a*n[5]+r*n[9]+n[13],h=s*n[2]+a*n[6]+r*n[10]+n[14],c=1/(s*n[3]+a*n[7]+r*n[11]+n[15]);return i.x=o*c,i.y=l*c,i.z=h*c,i},Oh=(e,t,i)=>{const s=e.x,a=e.y,r=e.z,n=t.elements;return i.x=s*n[0]+a*n[4]+r*n[8],i.y=s*n[1]+a*n[5]+r*n[9],i.z=s*n[2]+a*n[6]+r*n[10],i},qh=(e,t,i)=>{const s=Math.sin(t/2);return e.normalize(),i.w=Math.cos(t/2),i.x=e.x*s,i.y=e.y*s,i.z=e.z*s,i};function jh(e,t,i,s,a){var r=0,n=i,o=gh,l=mh,h=fh;_h(e,n,o),_h(t,n,l),h.copy(o).sub(l);return a<(r=-Uh(s,h)*(1/(Jh(e,i,s)+Jh(t,i,s))))&&(r=a),r<-a&&(r=-a),r}var Hh=new W,Vh=new W,Kh=new W,Wh=new W;function Jh(e,t,i){var s=Hh,a=Vh,r=Kh,n=Wh;return s.copy(t).sub(Dh(e,new W)),Nh(s,i,a),n.copy(zh(e,new W)).multiply(a),Nh(n,s,r),Rh(e)+Uh(i,r)}var Xh=new W,Yh=new W,Zh=new W;function $h(e,t,i,s,a){if(a.lengthSq()>1.1)return 0;let r=Xh,n=Yh,o=Zh;return _h(e,t,r),_h(i,s,n),o.copy(r).sub(n),-.1*Uh(a,o)*(1/(Rh(e)+Rh(i)))}class ec{constructor(e={},t){this.MoveSpeed=50,this.MaxSpeed=15,this.Drag=.98,this.SteerAngle=20,this.Traction=10,this.MoveForce=new W(0,0,0),this.tt=new W(0,0,0),this.v1=new W(0,0,0),this.v2=new W(0,0,0),this.motor=t,this.debug=this.motor.addDebuger(),this._reponsivness=500,this._throttleAmt=25,this._thottle=0,this._roll=0,this._pitch=0,this._yaw=0,this.init(e)}init(){this.car=new Z(new l(2,1,3),new w({wireframe:!0})),this.car.position.y=.5,this.motor.add(this.car);let e=new ei;this.car.add(e)}update(e){this.updateCar(e)}updateCar(e){const t=this.motor.getKey(),i=this.motor.getTransform(this.car);this.tt.copy(i.forward).multiplyScalar(this.MoveSpeed*-t[1]*e),this.MoveForce.add(this.tt),this.car.position.add(this.MoveForce.clone().multiplyScalar(e));let s=-t[0],a=this.MoveForce.length();i.up.multiplyScalar(s*a*this.SteerAngle*e),this.car.rotation.y+=i.up.y*this.motor.math.torad,this.MoveForce.multiplyScalar(this.Drag),this.MoveForce.clampLength(0,this.MaxSpeed),a=this.MoveForce.length(),this.v1.copy(this.MoveForce).normalize().multiplyScalar(3),this.v2.copy(i.forward).multiplyScalar(3),this.debug.DrawRay(i.position,this.v1,"white"),this.debug.DrawRay(i.position,this.v2,"blue"),this.debug.DrawRay(i.position,i.right,"red"),this.v1.copy(this.MoveForce).normalize().lerp(i.forward,this.Traction*e),this.MoveForce.copy(this.v1).multiplyScalar(a)}fixedUpdate(e){const t=this.motor.getTransform(this.body);t.position.copy(this.body.position),t.forward.copy(this.forward).applyQuaternion(this.body.quaternion),t.right.copy(this.right).applyQuaternion(this.body.quaternion),t.up.copy(this.up).applyQuaternion(this.body.quaternion),t.thottle.copy(t.up),this.motor.change({name:this.body.name,impulse:t.thottle.multiplyScalar(this._thottle).toArray()}),this.debug.DrawRay(t.position,t.thottle,"red"),this.debug.DrawRay(t.position,t.forward,"yellow"),this.debug.DrawRay(t.position,t.right,"cyan"),this.debug.DrawRay(t.position,t.up,"green")}handleInputs(e){const t=this.motor.getKey();this._roll=t[0],this._pitch=t[1],t[4]?this._thottle+=e*this._throttleAmt:t[5]&&(this._thottle-=e*this._throttleAmt),this._thottle=this.motor.math.clamp(this._thottle,0,100)}}class tc{constructor(e={},t){this.startPosition=e.pos||[0,0,0],this.model=e.model||null,this.debug=e.debug||!1,this.angle=0,this.speed=50,this.maxSpeed=20,this.drag=.98,this.steerAngle=5,this.traction=3,this.moveForce=new W(0,0,0),this.side=0,this.onAir=!1,this.tt=new W(0,0,0),this.v1=new W(0,0,0),this.v2=new W(0,0,0),this.floorNormal=new W(0,0,0),this.up=new W(0,1,0),this.decal=new W(0,-.5,0),this.tmpQ1=new Y,this.tmpQ2=new Y,this.tmpQ3=new Y,this.motor=t,this.angleS=0,this.debug&&(this.debuger=this.motor.addDebuger()),this.phyMove=!0,this.init(e)}setDebug(e){e&&(this.debug=e),this.sphere.visible=this.debug,this.ray.visible=this.debug}init(){this.radius=1,this.decal.y=-.5,this.radius=1.7,this.decal.y=-1.2;const e=this.motor.math;this.sphere=this.motor.add({type:"sphere",name:"baser",mass:1,size:[this.radius],pos:e.addArray(this.startPosition,[0,this.radius,0]),friction:.5,material:"debug",getVelocity:!0,visible:this.debug,shadow:!1,ray:!1});let t=this.rayHit.bind(this);if(this.ray=this.motor.add({name:"raySphere",type:"ray",begin:[0,0,0],end:[0,-(this.radius+1),0],visible:this.debug,parent:this.sphere,noRotation:!0,callback:t}),this.model){for(let e in this.model)this.model[e].receiveShadow=!0,this.model[e].castShadow=!0;this.car=this.model.body,this.w=[this.model.wheel_0,this.model.wheel_1,this.model.wheel_2,this.model.wheel_3,this.model.d_wheel]}else this.car=new Z(new l(1,.4,2),new w({wireframe:!0})),this.addWheels();this.motor.add(this.car)}addWheels(){let e=new n(.3,.3,.3,16);e.rotateZ(Math.PI/2);let t,i=new w({wireframe:!0}),s=4,a=[.7,-.2,.7],r=[];for(;s--;)r[s]=new Z(e,i),t=[0===s||3===s?a[0]:-.7,a[1],s<2?a[2]:-.7],r[s].position.fromArray(t),this.car.add(r[s]);this.w=r}updateWheels(){this.motor.math;let e,t=4;this.tmpQ3.setFromAxisAngle({x:0,y:1,z:0},3*this.angleS);let i=this.sphere.velocity.length()*this.side,s={x:1,y:0,z:0};for(;t--;)e=this.w[t],t<2?e.quaternion.setFromAxisAngle(s,i).premultiply(this.tmpQ3):e.quaternion.setFromAxisAngle(s,i);this.w[4]&&(this.w[4].rotation.y=10*this.angleS)}rayHit(e){e.hit?this.floorNormal.fromArray(e.normal).normalize():this.floorNormal.set(0,0,0),this.onAir=!e.hit}update(e){const t=this.motor.getKey(),i=this.motor.math;this.phyMove&&this.car.position.copy(this.sphere.position).add(this.decal);const s=this.motor.getTransform(this.car);let a=-t[1]*this.speed*e;this.onAir&&(a=0),this.tt.copy(s.forward).multiplyScalar(a),this.moveForce.add(this.tt),this.phyMove||this.car.position.add(this.moveForce.clone().multiplyScalar(e)),this.tmpQ1.setFromUnitVectors(this.up,this.floorNormal),this.tmpQ2.slerp(this.tmpQ1,4*e);let r=this.moveForce.toArray();this.motor.change({name:this.sphere.name,linear:r,velocityOperation:"xz"}),this.chassis&&this.motor.change({name:this.chassis.name,quat:this.car.quaternion.toArray(),pos:this.car.position.toArray()});let n=-t[0],o=this.moveForce.length();this.angleS=n*this.steerAngle*i.torad,this.angle+=this.angleS*o*e,this.car.quaternion.setFromAxisAngle(this.up,this.angle).premultiply(this.tmpQ2),this.moveForce.multiplyScalar(this.drag),this.moveForce.clampLength(0,this.maxSpeed),o=this.moveForce.length(),this.v1.copy(this.moveForce).normalize().multiplyScalar(1),this.v2.copy(s.forward).multiplyScalar(1),this.debug&&(this.debuger.DrawRay(s.position,this.v1,"white"),this.debuger.DrawRay(s.position,this.v2,"blue")),this.v1.copy(this.moveForce).normalize().lerp(s.forward,this.traction*e),this.moveForce.copy(this.v1).multiplyScalar(o),this.side=this.moveForce.dot(s.forward)>0?-1:1,this.updateWheels()}}const ic=new J,sc=new J;new W;let ac=Ve.prototype;ac.byName=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return this.bones[t];return null},ac.getId=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return t;return null},ac.setExtraRotation=function(e,t,i,s){(e.isBone?e:this.byName(e))&&je.DEG2RAD},ac.setScalling=function(e,t,i,s){let a=e.isBone?e:this.byName(e);a&&(a.scalling=new W(t,i,s))},ac.resetScalling=function(e){this.pose(),this.scalled=!0;for(let e=0,t=this.bones.length;e<t;e++)this.bones[e].isPhysics=!1,this.bones[e].phyMtx=new J;e||this.applyScalling()},ac.childScale=function(e,t){if(!this.scalled)return;e.scalling&&t.scale(e.scalling);let i,s=e.children.length,a=0;for(;s--;)i=e.children[a],a++,i.isBone,i.matrixWorld.multiplyMatrices(t,i.matrix)},ac.applyScalling=function(e){let t,i,s,a=this.bones.length;for(i=0;i<a;i++)t=this.bones[i],s=t.parent||null,null!==s&&s.scalling&&"root"!==t.name&&(t.position.multiply(s.scalling),t.updateMatrixWorld(!0));this.calculateInverses()},ac.update=function(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;let a,r=e.length,n=0;for(;r--;){a=e[n];const s=a?a.isPhysics?a.phyMtx:a.matrixWorld:sc;this.childScale(a,s),ic.multiplyMatrices(s,t[n]),ic.toArray(i,16*n),n++}null!==s&&(s.needsUpdate=!0)};const rc={getColor(e){let t=e.toString();t=t.substring(t.lastIndexOf(".")+1);let i,s=[255,255,255];switch(t){case"grass":s=[.223,.827,.325],i=[.741,.498,.258];break;case"dirt":s=[.741,.498,.258];break;case"leaves":s=[.152,.682,.376];break;case"sand":s=[.878,.819,.686];break;case"ice":s=[.65,.882,.96];break;case"stone":s=[.537,.64,.65];break;case"cobblestone":s=[.666,.647,.588];break;case"wood":s=[.603,.321,.152];break;case"snow":s=[.905,.976,1]}return i?[s[0],s[1],s[2],i[0],i[1],i[2]]:[s[0],s[1],s[2]]},fire:{type:"star",numParticles:20,position:[0,0,0],colors:[1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,.5,0,0,0,0],lifeTime:2,timeRange:2,startSize:.3,endSize:.9,velocity:[0,.8,0],velocityRange:[.15,.15,.15],gravity:[0,-.2,0],spinSpeedRange:4},smoke:{position:[-2,-.2,0],colors:[0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],numParticles:20,lifeTime:2,timeRange:2,startSize:.5,endSize:2,velocity:[0,1.6,0],velocityRange:[.2,0,.2],gravity:[0,-.25,0],spinSpeedRange:4,blending:"normal"},addBlock:{type:"cube",numParticles:30,lifeTime:1.5,endTime:1.5,startTime:0,startSize:.25,endSize:.5,sizeRange:.25,spinSpeedRange:2,radius:.25,velocity:[1,0,1],velocityRange:[.25,0,.25],acceleration:[1,0,1],accelerationRange:[.25,0,.25],gravity:[0,.05,0],tween:"outQuad",blending:"normal",alphaTest:.1},removeBlock:{type:"cube",lifeTime:1.5,endTime:1.5,startTime:0,startSize:.5,sizeRange:.25,endSize:.1,spinSpeedRange:2,accelerationRange:[.5,.5,.5],gravity:[0,-.1,0],tween:"outQuad",blending:"normal",alphaTest:.1},explosion:{colors:[1,0,0,0,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,.5,1,1,1,0],type:"cloud",radius:.5,radiusRange:.5,numParticles:400,positionRange:[2,1,2],lifeTime:3,endTime:4,lifeTimeRange:1,startTime:0,startSize:.1,endSize:2,sizeRange:1,accelerationRange:[1,.3,1],acceleration:[.8,.8,.8],gravity:[0,-.5,0],spinSpeedRange:2,luma:!1},playerMove:{trail:!0,colors:[1,1,1,1,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:1e3,positionRange:[.2,0,.2],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.1,0]},vehicleMove:{trail:!0,colors:[.5,.5,.5,.25,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:2e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.2,0]},vehicleTrack:{trail:!0,colors:[.2,.2,.2,.1,.2,.2,.2,0],type:"round2",blending:"normal",startSize:.3,endSize:.3,numParticles:4,maxParticles:2e3,position:[0,-.1,0],lifeTime:6,oriented:!0},underWater:{trail:!0,colors:[1,1,1,1,.5,.5,1,0],type:"bubble",blending:"normal",numParticles:1,maxParticles:1e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.1,endSize:.5,sizeRange:.05,velocity:[0,1,0],velocityRange:[1,0,1],acceleration:[.2,0,.2],gravity:[0,1,0]},bazookaFire:{trail:!0,colors:[1,0,0,1,1,1,0,.5,1,1,1,0],type:"round",numParticles:2,maxParticles:600,positionRange:[.1,.1,.1],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.1,velocityRange:[.6,.6,.6],gravity:[0,.1,0],luma:!1}},nc=["pixel","basic","cube","cloud","round","round2","donut","bubble","smoke","circle","field","star","octo"];function oc(){this.parent=null,this.position=[0,0,0],this.rotation=[0,0,0],this.name="default",this.type="round",this.tween="linear",this.trail=!1,this.model="",this.numParticles=1,this.maxParticles=0,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.endTime=-1,this.lifeTimeRange=0,this.sizeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.pposition=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.gravity=[0,0,0],this.oriented=!1,this.orientation=[0,0,0,1],this.colors=[1,1,1,1],this.blending="additive",this.radius=0,this.radiusPosition=!1,this.axis="Y",this.radiusRange=0,this.tmpRotation=null,this.alphaTest=0,this.renderOrder=0,this.luma=!0,this.depthWrite=!1,this.transparent=!0}const lc={torad:Math.PI/180,todeg:180/Math.PI,random:()=>Math.random(),rand:(e,t)=>e+lc.random()*(t-e),randInt:(e,t)=>e+Math.floor(lc.random()*(t-e+1)),plusMinus:e=>(lc.random()-.5)*e*2,plusMinusVector:e=>{const t=[];let i=e.length;for(;i--;)t.push(lc.plusMinus(e[i]));return t},toTexture:e=>{let t=new Ye(e);return t.minFilter=De,t.magFilter=De,t.flipY=!1,t.colorSpace=u,t.needsUpdate=!0,t},createTextureFromFloats:(e,t,i,s)=>{let a=null;if(null==s){const s=new Uint8Array(i.length);let r;for(let e=0;e<i.length;e++)r=255*i[e],s[e]=r;return a=new mt(s,e,t,dt),a.minFilter=De,a.magFilter=De,a.needsUpdate=!0,a}return a=s,a}},hc=function(e){let t;switch(e){case"linear":t="float tween( float k ) { return k; }";break;case"inQuad":t="float tween( float k ) { return k * k; }";break;case"outQuad":t="float tween( float k ) { return k * ( 2.0 - k ); }";break;case"inOutQuad":t="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k;\n            return - 0.5 * ( --k * ( k - 2.0 ) - 1.0 ); \n        }";break;case"inCubic":t="float tween( float k ) { return k * k * k; }";break;case"outCubic":t="float tween( float k ) { return --k * k * k + 1.0; }";break;case"inOutCubic":t="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k + 2.0 ); \n        }";break;case"inQuart":t="float tween( float k ) { return k * k * k * k; }";break;case"outQuart":t="float tween( float k ) { return 1.0 - ( --k * k * k * k ); }";break;case"inOutQuart":t="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return 0.5 * k * k * k * k;\n\t\t\treturn - 0.5 * ( ( k -= 2.0 ) * k * k * k - 2.0 ); \n        }";break;case"inQuint":t="float tween( float k ) { return k * k * k * k * k; }";break;case"outQuint":t="float tween( float k ) { return --k * k * k * k * k + 1.0; }";break;case"inOutQuint":t="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k * k * k + 2.0 );\n        }";break;case"inSine":t="#define PI_90 1.570796326794896\n        float tween( float k ) { float j = k * PI_90; return 1.0 - cos( j ); }";break;case"outSine":t="#define PI_90 1.570796326794896\n\t\tfloat tween( float k ) { float j = k * PI_90; return sin( j ); }";break;case"inOutSine":t="#define M_PI 3.14159265358979323846\n\t\tfloat tween( float k ) { \n\t\t\tfloat j = k * M_PI; return 0.5 * (1.0-cos(j));\n        }";break;case"inExpo":t="float tween( float k ) { return k == 0.0 ? 0.0 : pow( 1024.0, k - 1.0 ); }";break;case"outExpo":t="float tween( float k ) { return k == 1.0 ? 1.0 : 1.0 - pow( 2.0, - 10.0 * k ); }";break;case"inOutExpo":t="float tween( float k ) { \n\t\t\tif ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * pow( 1024.0, k - 1.0 );\n\t\t    return 0.5 * ( - pow( 2.0, - 10.0 * ( k - 1.0 ) ) + 2.0 );\n        }";break;case"inCirc":t="float tween( float k ) { return 1.0 - sqrt( 1.0 - k * k ); }";break;case"outCirc":t="float tween( float k ) { return sqrt( 1.0 - ( --k * k ) ); }";break;case"inOutCirc":t="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return - 0.5 * ( sqrt( 1.0 - k * k ) - 1.0 );\n\t\t\treturn 0.5 * ( sqrt( 1.0 - ( k -= 2.0 ) * k ) + 1.0 ); \n        }";break;case"inElastic":t="#define TWO_PI 6.28318530717958647692\n        float tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return - ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t}";break;case"outElastic":t="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1; \n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return ( a * pow( 2.0, - 10.0 * k) * sin( ( k - s ) * TWO_PI / p ) + 1.0 );\n\t\t}";break;case"inOutElastic":t="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return - 0.5 * ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t    return a * pow( 2.0, -10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) * 0.5 + 1.0;\n\t\t}";break;case"inBack":t="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return k * k * ( ( s + 1.0 ) * k - s );\n\t\t}";break;case"outBack":t="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return --k * k * ( ( s + 1.0 ) * k + s ) + 1.0;\n\t\t}";break;case"inOutBack":t="float tween(float k) {\n\t\t    float s = 1.70158 * 1.525;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * ( k * k * ( ( s + 1.0 ) * k - s ) );\n\t\t    return 0.5 * ( ( k -= 2.0 ) * k * ( ( s + 1.0 ) * k + s ) + 2.0 );\n\t\t}";break;case"inBounce":t="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat tween(float k) { return 1.0 - outBounce( 1.0 - k ); }";break;case"outBounce":t="float tween(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}";break;case"inOutBounce":t="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat inBounce(float k) { return 1.0 - outBounce( 1.0 - k ); }\n\t\tfloat tween(float k) {\n\t\t    if ( k < 0.5 ) return inBounce( k * 2.0 ) * 0.5;\n\t\t    return outBounce( k * 2.0 - 1.0 ) * 0.5 + 0.5;\n\t\t}"}return t},cc=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],Ac=new Float32Array(28);class uc extends Ge{constructor(e,t){super(),this.pe=e,this.count=0,this.color=null,this.texture=null,this.localTime=0,this.time=0,this.endTime=-1,this.num=0,this.matrixAutoUpdate=!1,this.frustumCulled=t.frustum||!1,this.receiveShadow=!1,this.castShadow=!1,this.birthIndex=0,this.luma=!0,t&&this.setParameters(t)}setParameters(e){this.validateParameters(e),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.name=e.name,this.isTrail=e.trail||!1,this.parameters=e;const t=this.isTrail?e.maxParticles:e.numParticles;this.allocateParticles_(t,e),this.isTrail||this.createParticles_(0,t,e),e.parent?e.parent.add(this):this.pe.scene?this.pe.scene.add(this):this.pe.add(this)}makeGeometry(e){this.geometry=e.oriented?new ti:new t,this.isMesh=e.oriented}setColorRamp(e){const t=e.length/4;if(t%1!=0)throw"colorRamp must have multiple of 4 entries";this.color=lc.createTextureFromFloats(t,1,e)}validateParameters(e){var t=new oc;for(let i in e)if(void 0===t[i])throw'unknown particle parameter "'+i+'"';for(let i in t)void 0===e[i]&&(e[i]=t[i])}perParticle(e,t){}birthParticles(e,t){var i=this.parameters.numParticles;this.parameters.pposition=e,this.parameters.startTime=this.time,this.endTime=this.time+this.parameters.lifeTime,t&&this.setColorRamp(t),this.createParticles_(this.birthIndex,i,this.parameters),this.birthIndex+=i,this.birthIndex+i>=this.parameters.maxParticles&&(this.birthIndex=0)}createParticles_(e,t,i){const s=lc.plusMinus,a=lc.plusMinusVector,r=this.interleavedBuffer.array;let n,o=t;for(;o--;){this.perParticle(o,i);let l=i.lifeTime+s(i.lifeTimeRange),h=null===i.startTime?o*i.lifeTime/t:i.startTime,c=i.frameStart+s(i.frameStartRange),A=(new W).addVectors((new W).fromArray(i.pposition),(new W).fromArray(a(i.positionRange))),u=(new W).addVectors((new W).fromArray(i.velocity),(new W).fromArray(a(i.velocityRange))),d=(new W).addVectors((new W).fromArray(i.acceleration),(new W).fromArray(a(i.accelerationRange))),p=(new at).addVectors((new at).fromArray(i.colorMult),(new at).fromArray(a(i.colorMultRange))),g=i.spinStart+s(i.spinStartRange),m=i.spinSpeed+s(i.spinSpeedRange),f=i.startSize+s(i.sizeRange||i.startSizeRange),b=i.endSize+s(i.sizeRange||i.endSizeRange),y=(new at).fromArray(i.orientation);if(i.positionRange[0],i.positionRange[1],i.positionRange[2],i.radius){let e=i.axis||"Y",t=lc.rand(0,2*Math.PI);i.tmpRotation=[90,-t*lc.todeg,90,"YXZ"];let a=i.radius+s(i.radiusRange),r=Math.cos(t),n=Math.sin(t),o=new W;switch(e){case"X":o.y=r,o.z=n;break;case"Y":o.x=r,o.z=n;break;case"Z":o.x=r,o.y=n}switch(o.multiplyScalar(a),i.radiusPosition&&A.add(o),e){case"X":o.x=1;break;case"Y":o.y=1;break;case"Z":o.z=1}d.multiply(o),u.multiply(o)}i.tmpRotation&&(y=(new Y).setFromEuler(new ge(i.tmpRotation[0]*lc.torad,i.tmpRotation[1]*lc.torad,i.tmpRotation[2]*lc.torad,i.tmpRotation[3]))),n=0+28*o*4+28*e*4,r[0+n]=A.x,r[0+n+1]=A.y,r[0+n+2]=A.z,r[0+n+3]=h,r[4+n]=cc[0][0],r[4+n+1]=cc[0][1],r[4+n+2]=l,r[4+n+3]=c,r[8+n]=u.x,r[8+n+1]=u.y,r[8+n+2]=u.z,r[8+n+3]=f,r[12+n]=d.x,r[12+n+1]=d.y,r[12+n+2]=d.z,r[12+n+3]=b,r[16+n]=g,r[16+n+1]=m,r[16+n+2]=0,r[16+n+3]=0,r[20+n]=y.x,r[20+n+1]=y.y,r[20+n+2]=y.z,r[20+n+3]=y.w,r[24+n]=p.x,r[24+n+1]=p.y,r[24+n+2]=p.z,r[24+n+3]=p.w}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value.fromArray(i.worldVelocity),this.material.uniforms.gravity.value.fromArray(i.gravity),this.material.uniforms.timeRange.value=i.timeRange,this.material.uniforms.frameDuration.value=i.frameDuration,this.material.uniforms.numFrames.value=i.numFrames,this.material.uniforms.rampSampler.value=this.color,this.material.uniforms.colorSampler.value=this.texture,this.material.blending="normal"===i.blending?H:j,this.updateMatrix()}allocateParticles_(e,t){if(this.count!==e){if(t.oriented||(t.oriented=!1),t.position&&this.position.fromArray(t.position),t.rotation&&this.quaternion.setFromEuler(new ge(t.rotation[0]*lc.torad,t.rotation[1]*lc.torad,t.rotation[2]*lc.torad)),this.setColorRamp(t.colors),this.pe.textures.has(t.type)||-1!==nc.indexOf(t.type)&&this.pe.textures.make(t.type),this.texture=this.pe.textures.get(t.type),this.texture||console.log("this texture is undefined !!"),this.endTime=t.endTime||-1,this.luma=t.luma,this.makeGeometry(t),this.count=e,t.oriented){var s=new xe(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8);this.geometry.setAttribute("position",new ke(s,3,0)),this.geometry.setAttribute("uv",new ke(s,2,4)),this.geometry.setIndex(new i(new Uint16Array([0,1,2,0,2,3]),1)),this.interleavedBuffer=new ii(new Float32Array(e*Ac.byteLength),28,1).setUsage(si)}else this.interleavedBuffer=new xe(new Float32Array(e*Ac.byteLength),28).setUsage(si);this.geometry.setAttribute("position",new ke(this.interleavedBuffer,3,0)),this.geometry.setAttribute("startTime",new ke(this.interleavedBuffer,1,3)),this.geometry.setAttribute("uvLifeTimeFrameStart",new ke(this.interleavedBuffer,4,4)),this.geometry.setAttribute("velocityStartSize",new ke(this.interleavedBuffer,4,8)),this.geometry.setAttribute("accelerationEndSize",new ke(this.interleavedBuffer,4,12)),this.geometry.setAttribute("spinStartSpinSpeed",new ke(this.interleavedBuffer,4,16)),this.geometry.setAttribute("orientation",new ke(this.interleavedBuffer,4,20)),this.geometry.setAttribute("colorMult",new ke(this.interleavedBuffer,4,24)),this.geometry.boundingSphere=new st,this.geometry.boundingSphere.radius=3;let r=j;switch(t.blending){case"sub":case"subtractive":r=q;break;case"multi":case"multiply":r=O;break;case"normal":r=H;break;default:r=j}var a={worldVelocity:{value:new W},gravity:{value:new W},timeRange:{value:0},time:{value:0},timeOffset:{value:0},frameDuration:{value:0},numFrames:{value:0},rampSampler:{value:null},colorSampler:{value:null},scale:{value:.5*window.innerHeight},luma:{value:this.luma?this.pe.luminosity:1},alphaTest:{value:t.alphaTest}};this.material=new Zt({defines:{USE_ORIENTATION:t.oriented},uniforms:a,vertexShader:hc(t.tween||"linear")+"\nprecision mediump float;\nprecision mediump int;\n\n#ifdef USE_ORIENTATION\n\t//uniform mat4 worldViewProjection;\n\t//uniform mat4 world;\n\tattribute vec3 offset;\n\tattribute vec4 orientation;\n#else\n    uniform float scale;\n#endif\n\nuniform vec3 worldVelocity;\nuniform vec3 gravity;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n//#include <clipping_planes_pars_vertex>\n\nvec3 lerp( vec3 a, vec3 b, float p ){ return a + (b - a) * p; }\n\nvoid main() \n{\n    float lifeTime = uvLifeTimeFrameStart.z;\n    float frameStart = uvLifeTimeFrameStart.w;\n    float startSize = velocityStartSize.w;\n\n    //vec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz, 0.0)).xyz + worldVelocity;\n\t//vec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz, 0.0)).xyz + gravity;\n\n    //vec3 velocity = velocityStartSize.xyz + worldVelocity;\n\t//vec3 acceleration = accelerationEndSize.xyz + gravity;\n\n\tvec3 velocity = velocityStartSize.xyz + (inverse(modelMatrix) * vec4(worldVelocity, 0.0)).xyz;\n\tvec3 acceleration = accelerationEndSize.xyz + (inverse(modelMatrix) * vec4(gravity, 0.0)).xyz;\n\n    float endSize = accelerationEndSize.w;\n    float spinStart = spinStartSpinSpeed.x;\n    float spinSpeed = spinStartSpinSpeed.y;\n\n    float localTime = mod((time - timeOffset - startTime), timeRange);\n    //localTime = tween( localTime );\n    float percentLife = localTime / lifeTime;\n    percentLife = tween( percentLife );\n\n    vec3 posEnd = velocity * lifeTime + acceleration * lifeTime * lifeTime;\n\n    float frame = mod(floor(localTime / frameDuration + frameStart), numFrames);\n    float uOffset = frame / numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n    outputTexcoord = vec2(u, uv.y + 0.5);\n    outputColorMult = colorMult;\n\n    float size = mix(startSize, endSize, percentLife);\n\tsize = (percentLife < 0. || percentLife > 1.0) ? 0.0 : size;\n\n\tfloat s = sin(spinStart + spinSpeed * localTime);\n\tfloat c = cos(spinStart + spinSpeed * localTime);\n\n    #ifdef USE_ORIENTATION\n\t\t\n\t\tvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., (uv.x * s - uv.y * c) * size, 1.);\n\t\t//vec3 center = velocity * localTime + acceleration * localTime * localTime + position + offset;\n\t\tvec3 center = (posEnd * percentLife) + position + offset;\n\n\t\tvec4 q2 = orientation + orientation;\n\t\tvec4 qx = orientation.xxxw * q2.xyzx;\n\t\tvec4 qy = orientation.xyyw * q2.xyzy;\n\t\tvec4 qz = orientation.xxzw * q2.xxzz;\n\n\t\tmat4 localMatrix = mat4(\n\t\t    (1.0 - qy.y) - qz.z,  qx.y + qz.w,  qx.z - qy.w, 0,\n\t\t    qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n\t\t    qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n\t\t    center.x, center.y, center.z, 1\n\t\t);\n\t\trotatedPoint = localMatrix * rotatedPoint;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n\n\t#else\n\n\t    //vec3 pos = position + velocity * localTime + acceleration * localTime * localTime;\n\n\t    vec3 pos = (posEnd * percentLife) + position;\n\t    \n\t    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );\n        //gl_PointSize = size * 1.5 * ( scale / length( mvPosition.xyz ) );\n        gl_PointSize = size * 1.5 * ( scale / - mvPosition.z );\n\n        mat2 r = mat2( c, -s, s, c);\n        r *= 0.5; r += 0.5;  r = r * 2.0 - 1.0;\n        rotationMtx = r;\n\n        gl_Position = projectionMatrix * mvPosition;\n\n\t#endif\n\n\toutputPercentLife = percentLife;\n\n\t#include <logdepthbuf_vertex>\n\t//#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nuniform float luma;\nuniform float alphaTest;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n//#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t//#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\n\tvec4 diffuseColor = texture2D( rampSampler, vec2(outputPercentLife, 0.5) ) * outputColorMult;\n\n    vec2 uv = vec2(0.0);\n    #ifdef USE_ORIENTATION\n        uv = outputTexcoord;\n\t#else\n\t    uv = gl_PointCoord;\n\t    uv -= 0.5; uv = uv * rotationMtx; uv += 0.5;\n\t#endif\n\n\t// texture\n\tdiffuseColor *= texture2D( colorSampler, uv );\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n\tdiffuseColor.rgb *= luma;\n\n\tgl_FragColor = diffuseColor; \n\t#include <fog_fragment>\n\n}\n",side:t.oriented?C:B,blending:r,depthTest:!0,depthWrite:t.depthWrite,transparent:t.transparent,forceSinglePass:t.single||!1,fog:t.fog||!1}),this.renderOrder=t.renderOrder||0}}draw(e=0){if(!this.material.uniforms)return;const t=this.material.uniforms;this.time+=this.pe.delta,t.time.value=this.time,t.timeOffset.value=e,t.scale.value=this.pe.hscale,t.luma.value=this.luma?this.pe.luminosity:1,-1!==this.endTime&&this.time>=this.endTime&&this.pe.remove(this.name)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.material.dispose(),this.color.dispose()}raycast(){}clone(e){return void 0===e&&(e=this.pe.createEmitter(this.texture)),e.time=0,e.endTime=this.endTime,e.geometry=this.geometry,e.material=this.material.clone(),e.material.uniforms.rampSampler.value=this.color,e.material.uniforms.colorSampler.value=this.texture,super.copy(e),this.num++,e.name=this.name+this.num,e}}class dc extends Map{constructor(){super()}dispose(){this.forEach((e=>{e.dispose()})),this.clear()}add(e,t){this.has(e)||this.set(e,t)}make(e){if(!this.has(e)){let t=this["make"+e[0].toUpperCase()+e.substring(1)]();this.set(e,t)}}makePixel(){const e=[];for(let t=0;t<2;++t)for(let t=0;t<2;++t)e.push(1,1,1,1);return lc.createTextureFromFloats(2,2,e)}makeBasic(){const e=[0,.2,.7,1,.7,.2,0,0],t=[];for(let i=0;i<8;++i)for(let s=0;s<8;++s){let a=e[s]*e[i];t.push(a,a,a,1)}return lc.createTextureFromFloats(8,8,t)}makeCube(){let e=document.createElement("canvas");e.width=e.height=8;const t=e.getContext("2d");return t.fillStyle="rgba(255,255,255,1.0)",t.fillRect(2,2,4,4),lc.toTexture(e)}makeCloud(){let e=16,t=document.createElement("canvas");t.width=t.height=e;const i=t.getContext("2d");let s="rgba(255,255,255,1)",a="rgba(255,255,255,0)",r=i.createRadialGradient(8,6.4,0,8,6.4,6.4);return r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,e,e),r=i.createRadialGradient(6.4,9.92,0,6.4,9.92,5.6),r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,e,e),r=i.createRadialGradient(4.32,6.4,0,4.32,6.4,4.16),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,e,e),r=i.createRadialGradient(12.16,9.6,0,12.16,9.6,3.68),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,e,e),lc.toTexture(t)}makeRound(){let e=document.createElement("canvas");e.width=e.height=16;const t=e.getContext("2d"),i=t.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.3,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),i.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=i,t.fillRect(0,0,16,16),lc.toTexture(e)}makeRound2(){let e=document.createElement("canvas");e.width=e.height=16;const t=e.getContext("2d"),i=t.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,1)"),i.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=i,t.fillRect(0,0,16,16),lc.toTexture(e)}makeDonut(){let e=document.createElement("canvas");e.width=e.height=32;const t=e.getContext("2d"),i=t.createRadialGradient(16,16,0,16,16,16);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,0.1)"),i.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=i,t.beginPath(),t.arc(16,16,16,0,2*Math.PI,!1),t.arc(16,16,8,0,2*Math.PI,!0),t.fill(),lc.toTexture(e)}makeBubble(){let e=document.createElement("canvas");e.width=e.height=64;let t="rgba(0,255,255,0)";const i=e.getContext("2d"),s=i.createRadialGradient(25.6,25.6,0,32,32,32);return s.addColorStop(.4,t),s.addColorStop(.9,"rgba(0,255,255,0.6)"),s.addColorStop(.99,"rgba(0,255,255,1)"),s.addColorStop(1,t),i.fillStyle=s,i.fillRect(0,0,64,64),i.fillStyle="rgba(255,255,255,1)",i.beginPath(),i.arc(44.8,25.6,8.96,0,2*Math.PI,!1),i.fill(),i.beginPath(),i.arc(12.8,41.6,3.2,0,2*Math.PI,!1),i.fill(),lc.toTexture(e)}makeSmoke(){let e=document.createElement("canvas");e.width=e.height=64;const t=e.getContext("2d");let i=new Image;i.src=pc;let s=lc.toTexture(e);return i.onload=function(){t.drawImage(i,0,0),s.needsUpdate=!0},s}makeCircle(){let e=document.createElement("canvas");e.width=e.height=64;const t=e.getContext("2d");return t.strokeStyle="white",t.lineWidth=4,t.beginPath(),t.arc(32,32,30,0,2*Math.PI),t.stroke(),lc.toTexture(e)}makeField(){let e=document.createElement("canvas");e.width=e.height=64;const t=e.getContext("2d"),i=t.createLinearGradient(0,0,0,64);return i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.8,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=i,t.fillRect(24,0,16,64),lc.toTexture(e)}makeStar(){let e=document.createElement("canvas");e.width=e.height=64;const t=e.getContext("2d"),i=t.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255,255,255,0.5)"),i.addColorStop(.5,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),t.fillStyle=i,this.star(t,32,6.4,32,32,3),this.star(t,32,25.6,32,32,3),lc.toTexture(e)}makeOcto(){let e=document.createElement("canvas");e.width=e.height=64;const t=e.getContext("2d"),i=t.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(.4,"rgba(255,255,255,0.2)"),i.addColorStop(1,"rgba(255,255,255,0.4)"),t.fillStyle=i,this.star(t,25.6,22.4,32,32,6),t.strokeStyle="rgba(255,255,255,0.1)",t.lineWidth=6,t.stroke(),lc.toTexture(e)}star(e,t,i,s,a,r){let n,o,l;e.beginPath(),e.moveTo(s+t,a);for(var h=1;h<=2*r;h++)h%2==0?(l=h*(2*Math.PI)/(2*r),n=s+t*Math.cos(l),o=a+t*Math.sin(l)):(l=h*(2*Math.PI)/(2*r),n=s+i*Math.cos(l),o=a+i*Math.sin(l)),e.lineTo(n,o);e.closePath(),e.fill()}}const pc="data:image/png;base64,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\nJRU5ErkJggg==";class gc extends Oe{constructor(e){super(),this.scene=e||null,this.isGl2=!0,this.emitters=new Map,this.textures=new dc,this.loader=null,this.now=0,this.last=0,this.delta=0,this.elapsed=0,this.num=0,this.hscale=.5*window.innerHeight,this.luminosity=1,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}updateMatrixWorld(e){super.updateMatrixWorld(e),null===this.scene&&this.update()}get(e){return this.emitters.has(e)?this.emitters.get(e):null}add(e,t){if(e.isPoints)return void super.add(e);e.name||(e.name="PP"+this.num++),this.remove(e.name),e.model&&rc[e.model]&&(e={...rc[e.model],...e});let i=new uc(this,e);return this.emitters.set(e.name,i),i}remove(e){if("string"==typeof e||e instanceof String){if(!this.emitters.has(e))return;this.emitters.get(e).dispose(),this.emitters.delete(e)}else if(e.isPoints)return void super.remove(e)}addTexture(e,t,i=!0){this.textures.has(e)?console.log("this name of texture is already take !"):"string"==typeof t?(this.loader||(this.loader=new ve),this.loader.load(t,(t=>{t.flipY=!1,i&&(t.colorSpace=u),this.textures.add(e,t)}))):t.isTexture&&(t.flipY=!1,this.textures.add(e,t))}load(e){const t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));var i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let e=JSON.parse(i.responseText);for(let t in e)this.add(e[t])}else console.error("Couldn't load ["+t+"] ["+i.status+"]")}.bind(this),i.send()}resize(e){this.hscale=.5*e}onresize(e){this.hscale=.5*e}loop(e){this.delta=e,this.emitters.forEach((e=>{e.draw()}))}update(e){this.now=void 0!==e?e:Date.now(),this.delta=.001*(this.now-this.last),this.elapsed+=this.delta,this.last=this.now,this.emitters.forEach((e=>{e.draw()}))}dispose(e=!0){this.emitters.forEach((e=>{e.dispose()})),this.emitters.clear(),e&&this.textures.dispose(),this.num=0}addBlock(e,t){let i=e[1]<=4?-2:0,s=rc.getColor(t),a=s[0],r=s[1],n=s[2];s.length>3&&(a=s[3],r=s[4],n=s[5]),e[0]+=.5,e[2]+=.5,this.add({position:e,colors:[a,r,n,1,a,r,n,0],renderOrder:i,...rc.addBlock})}delBlock(e,t){let i=e[1]<=4?-2:0,s=rc.getColor(t),a=s[0],r=s[1],n=s[2];e[0]+=.5,e[2]+=.5,e[1]+=.5;let o=30;s.length>3&&(o=20,this.add({position:[e[0],e[1]+.375,e[2]],positionRange:[.5,.25,.5],colors:[a,r,n,.5,a,r,n,0],numParticles:10,renderOrder:i,...rc.removeBlock}),a=s[3],r=s[4],n=s[5]),this.add({position:e,positionRange:[.5,.5,.5],colors:[a,r,n,.5,a,r,n,0],numParticles:o,renderOrder:i,...rc.removeBlock})}removePlayerTrail(e){this.remove("PlayerTrail_"+e)}onPlayerWalk(e,t,i){let s=this.get("PlayerTrail_"+t);null===s&&(s=this.addTrail({name:"PlayerTrail_"+t,...rc.playerMove}));let a=e.toArray();a[1]+=.2;let r=rc.getColor(i),n=[r[0],r[1],r[2],.75,r[0],r[1],r[2],0];r.length>3&&(n=[r[0],r[1],r[2],.75,r[3],r[4],r[5],0]),s.birthParticles(a,n)}onVehicleDrive(e,t){let i=this.get("VehicleTrail_"+t);null===i&&(i=this.addTrail({name:"VehicleTrail_"+t,...rc.vehicleMove})),i.birthParticles(e.toArray())}onBazookaFire(e,t){let i=this.get("BazookaTrail_"+t);null===i&&(i=this.addTrail({name:"BazookaTrail_"+t,...rc.bazookaFire})),i.birthParticles(e.toArray())}onExplosion(e){this.add({position:e.toArray(),...rc.explosion})}}new W,new W,new Z(new r(.03),new w({transparent:!0})),new W,new W,new Z(new r(.03),new w({transparent:!0})),new h;new n(1,1,1).rotateX(Math.PI/2),new ie,new W,new W,new p("red");const mc={PHY:"0.5.0",PHYSX:"5.06.10",HAVOK:"1.2.1",JOLT:"0.36.0",RAPIER:"0.16.2",OIMO:"1.2.4",AMMO:"3.2.6"};class fc{constructor(e={}){this.noBuffer=!0,this.geo=new Ei,this.mat=new Mi,this.math=ci,this.pool=so,this.version=mc.PHY,this.Version=mc,this.engine="",this.jointVisible=!1,this.utils=new yc(this),this.collision=new Po(this),this.viewSize=null,this.debug=!1,this.delta=0,this.debuger=null,this.mouseActive=!1;const t=this;let i=null,s=!1,a=!1,r=!1,n=null,o=null,l=null,h=!1,c=!1,A=!1,u=!0,d=!1,p=null,g=!1,m={t1:0,t2:0,t3:0,t4:0},f=null,b=null,y=null,w=!1,I=!0,E=null,C=null,v=0,B=0,x="",k=null,Q=null,S=null;const M=new Di,R=new Ri(60),D={start:0,end:0,startTime:""};let T=()=>0,F=()=>{},L=()=>{},P=()=>{},_=[],z=[],U=[],N=null;const G={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let O=null,q={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0,delta:0,ms:0},point:{},contact:{},velocity:{}};const j={};this.scene=null,this.scenePlus=null,this.ws=1,this.uws=1,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let e,t,i;for(e in this.tmpMesh){if(i=this.tmpMesh[e],i.children)for(t in i.children)this.disposeMesh(i.children[t]);this.disposeMesh(i),i.parent&&i.parent.remove(i)}for(e in this.tmpMesh=[],this.tmpTex)this.tmpTex[e].dispose();this.tmpTex=[]},this.disposeMesh=e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()},this.setStep=e=>{L=e},this.debugMode=e=>{this.setDebugMode(e)},this.setDebugMode=e=>{this.debug=e},this.useRealLight=e=>{this.mat.useRealLight(e)},this.getSetting=()=>G,this.setGravity=e=>{e&&(G.gravity=e),this.post({m:"setGravity",o:{gravity:G.gravity}})},this.set=(e={})=>{G.fixe=void 0===e.fixe||e.fixe,G.full=void 0!==e.full&&e.full,G.gravity=e.gravity?e.gravity:[0,-9.81,0],G.substep=e.substep?e.substep:1,G.fps=e.fps?e.fps:60,this.ws=void 0!==e.worldScale?e.worldScale:1,this.uws=1/this.ws,e.key&&P(),j.body.setFull(G.full),this.initArray(G.full),B=0,A=h,u=!A,this.jointVisible=e.jointVisible||!1,u&&R.setFramerate(G.fps);const t={...G,ArPos:q,isTimeout:A,outsideStep:u};this.post({m:"set",o:t})},this.activeMouse=(e,t)=>{f||(f=new Vo(e,t,this)),this.mouseActive=!0},this.mouseMode=(e,t)=>{f&&f.setMode(e,t)},this.getTime=()=>Ri.now(),this.readTime=e=>Ri.format_time(e),this.startTime=()=>D.startTime,this.getTimeTest=()=>m,this.setMaxFps=e=>{},this.getMouse=()=>f?f.mouse:null,this.setMaxAnisotropy=e=>{so.maxAnisotropy=e},this.setAddControl=e=>{P=e},this.setPrevUpdate=e=>{},this.setPostUpdate=e=>{L=null!==e?e:()=>{}},this.setAzimut=e=>{T=e},this.setRenderer=e=>{Q=e,so.renderer=Q},this.setKey=(e,t)=>M.setKey(e,t),this.getKey=()=>M.key,this.getKey2=()=>M.key2,this.getAzimut=()=>T(),this.setContent=e=>{g||(S=e,S.add(this.scene),S.add(this.scenePlus),g=!0)},this.message=e=>{let i=e.data;i.Ar&&(O=i.Ar),i.reflow&&(this.reflow=i.reflow,this.reflow.stat.delta&&(B+=this.reflow.stat.delta)),t[i.m](i.o)},this.worldScaler=e=>{const t=this.ws;if(e.pos&&(e.pos=ci.worldscale(e.pos,t)),e.localPos&&(e.localPos=ci.worldscale(e.localPos,t)),e.massCenter&&(e.massCenter=ci.worldscale(e.massCenter,t)),e.pos1&&(e.pos1=ci.worldscale(e.pos1,t)),e.pos2&&(e.pos2=ci.worldscale(e.pos2,t)),e.shapes){let i,s=e.shapes.length;for(;s--;)i=e.shapes[s],i.size&&(e.shapes[s].size=ci.worldscale(i.size,t)),i.pos&&(e.shapes[s].pos=ci.worldscale(i.pos,t)),i.v&&(e.shapes[s].v=ci.worldscale(i.v,t))}else e.size&&(e.size=ci.worldscale(e.size,t)),e.v&&(e.v=ci.worldscale(e.v,t))},this.post=(e,t=null,i=!1)=>{1!==this.ws&&("add"!==e.m&&"change"!==e.m||this.worldScaler(e.o)),h?(e.o&&("solver"===e.o.type&&(i=!0),void 0!==e.o.solver&&(i=!0)),i?l.postMessage(e,t):"add"===e.m?this.flow.add.push(e.o):"remove"===e.m?this.flow.remove.push(e.o):l.postMessage(e,t)):b({data:e})},this.addDebuger=()=>{if(null===this.debuger)return this.debuger=new Dl(this),this.scenePlus.add(this.debuger),this.debuger},this.removeDebuger=()=>{null!==this.debuger&&(this.debuger.dispose(),this.debuger=null)},this.vehicle=e=>{let t;switch(e.type){case"raycar":t=new vh(e,this);break;case"kart":t=new tc(e,this);break;case"helico":t=new ec(e,this)}return t},this.autoRagdoll=e=>{const t=new Rl(e,this);return this.scene.add(t.model),t},this.byName=e=>this.utils.byName(e),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=e=>{this.viewSize=e,i&&i.resize(this.viewSize.h)},this.init=(e={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,D.start=Ri.now();const i=e.compact||!1;let r=document.location.href.replace(/\/[^/]*$/,"/"),n=r.split("/");r=n[0]+"//"+n[2]+"/","https://lo-th.github.io/"===r&&(r="https://lo-th.github.io/phy/");let A=e.path||"";A+=i?"compact/":"build/";let u=e.type||"PHYSX",d=u.toLowerCase(),p=d.charAt(0).toUpperCase()+d.slice(1);if(this.engine=u.toUpperCase(),this.initItems(),so.materialRoot=this.mat.set.bind(this.mat),e.callback&&(o=e.callback,delete e.callback),h=e.worker||!1,this.scene=new Oe,this.scene.name="phy_scene",this.scenePlus=new Oe,this.scenePlus.name="phy_scenePlus",e.scene&&(this.setContent(e.scene),delete e.scene),e.renderer&&(this.setRenderer(e.renderer),delete e.renderer),x=e.envmap||"",a=!!e.useModule&&this.supportModuleWorker(),s=e.useLocal||!1,e.useDecal,so.useLocal=s,i)s?a?so.load(new URL("../"+A+p+".module.hex",import.meta.url),(function(){t.onCompactDone(e)})):so.load(new URL("../"+A+p+".hex",import.meta.url),(function(){t.onCompactDone(e)})):a?so.load(r+A+p+".module.hex",(function(){t.onCompactDone(e)})):so.load(r+A+p+".hex",(function(){t.onCompactDone(e)}));else if(h){let t,i=a?p+".module.js":p+".min.js";if(t=s?new URL(`./${i}`,import.meta.url):r+A+i,l=new Worker(t,{type:a?"module":"classic"}),l.postMessage=l.webkitPostMessage||l.postMessage,l.onmessage=this.message,this.noBuffer)e.isBuffer=!1;else{let t=new ArrayBuffer(1);l.postMessage({m:"test",ab:t},[t]),c=!t.byteLength,e.isBuffer=c}this.initPhysics(e)}else e.devMode?this.preLoad(p,e,r):this.preLoadMin(p,e,r)},this.supportModuleWorker=()=>{let e=!1;const t={get type(){e=!0}};try{new Worker("data:,",t).terminate()}finally{return e}},this.onCompactDone=e=>{let t=this.engine.toLowerCase(),i=t.charAt(0).toUpperCase()+t.slice(1),s=a?so.get(i+".module","H"):so.get(i,"H");if(h){let t;try{t=new Blob([s],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,t=new BlobBuilder,t.append(s),t=t.getBlob()}if(l=a?new Worker(URL.createObjectURL(t),{type:"module"}):new Worker(URL.createObjectURL(t)),l.postMessage=l.webkitPostMessage||l.postMessage,l.onmessage=this.message,this.noBuffer)e.isBuffer=!1;else{let t=new ArrayBuffer(1);l.postMessage({m:"test",ab:t},[t]),c=!t.byteLength,e.isBuffer=c}this.initPhysics(e)}else{let i=t.toUpperCase(),a=document.createElement("script");a.language="javascript",a.type="text/javascript",a.charset="utf-8",a.async=!0,a.innerHTML=s,document.getElementsByTagName("head")[0].appendChild(a),b=window[i].engine.message,e.message=this.message,this.initPhysics(e)}},this.loadWasmDirect=(e,t,i,s)=>{let a=document.createElement("script");a.src=s+e,document.body.appendChild(a),a.onload=()=>{this.preLoad(i,t,s)}},this.preLoadMin=(e,t,i)=>{let s=i+"build/"+e+".min.js",a=e.toUpperCase();var r=new XMLHttpRequest;r.open("GET",s),r.overrideMimeType("text/javascript"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status){let e=document.createElement("script");e.language="javascript",e.type="text/javascript",e.charset="utf-8",e.async=!0,e.innerHTML=r.responseText,document.getElementsByTagName("head")[0].appendChild(e),b=window[a].engine.message,t.message=this.message,this.initPhysics(t)}else console.error("Couldn't load ["+e+"] ["+r.status+"]")}.bind(this),r.send(null)},this.preLoad=async(e,t,i)=>{let s=i+"build/"+e+".module.js";t.devMode&&(s=i+"src/"+e+".js");let a=await import(s);b=a.engine.message,t.message=this.message,this.initPhysics(t)},this.initPhysics=e=>{""===x?(this.post({m:"init",o:e}),d=!0):this.preloadEnvmap(e)},this.addEnvmap=e=>(k||(k=new uh({renderer:Q,scene:S,...e})),k),this.preloadEnvmap=e=>{k=new uh({url:x,renderer:Q,scene:S,usePmrem:e.usePmrem,useBackground:void 0===e.useBackground||e.useBackground,envBlur:void 0!==e.envBlur?e.envBlur:0,callback:()=>{x="",this.initPhysics(e)}})},this.getPause=()=>w,this.pause=e=>{e!==w&&(w=e,w?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:w}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=e=>{if(I)return I=!1,void e();_=[],n=null,r=!1,y&&y.resetAll(),f&&f.unSelect(),i&&(i.dispose(),i=null),F=e,L=function(){},this.collision.reset(),this.clearText(),this.clearSoftSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.garbage=[],N=null,null!==p&&(p=null),null!==this.debuger&&this.removeDebuger(),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset",o:{}})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=e=>{this.reset(e)},this.resetCallback=()=>{F()},this.dispose=()=>{this.reset((()=>{l&&(l.terminate(),l=null),g&&(t.scene.parent.remove(t.scene),t.scenePlus.parent.remove(t.scenePlus),g=!1)}))},this.ready=()=>{D.end=Ri.now(),D.startTime=Ri.format_time(D.end-D.start),console.log("%c"+this.engine+" %c"+mc[this.engine]+"%c | "+(a?"Module ":"")+(h?"Worker":"Direct")+" "+D.startTime,"font-size:16px","font-size:12px","font-size:12px"),o&&o()},this.start=(e={})=>{this.post({m:"start",o:e})},this.morph=(e,t,i)=>{this.utils.morph(e,t,i)},this.getFps=()=>this.reflow.stat.fps,this.getMs=()=>this.reflow.stat.ms.toFixed(1),this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>B,this.setDelta=e=>{R.delta=e},this.getDelta=()=>R.delta,this.getElapsedTime=()=>R.elapsedTime,this.doStep=e=>{d&&u&&R.up(e)&&this.post({m:"step",o:e})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=M.update(),this.flow.current=null!==n?n.name:"",this.stepItems(),this.collision.step(),f&&f.step(),null!==n&&n.move(),null!==this.debuger&&this.debuger.draw();let e=u?R.delta:this.delta;L(e),this.changes(this.flow.tmp),c?this.post({m:"poststep",flow:this.flow,Ar:O},[O.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(e=!1)=>{q={...wi(this.engine,e)}},this.takeControl=(e=null)=>{this.control(e)},this.control=(e=null)=>{null!==n?null===e?(n.isPlayer&&(n.isPlayer=!1),n=null):e!==n.name&&(n=this.byName(e),n&&(n.isPlayer=!0)):null!==e&&(n=this.byName(e),n&&(n.isPlayer=!0))},this.getAllBody=e=>j.body.list,this.activeContact=()=>{r||(r=!0,this.post({m:"activeContact",o:{}}))},this.addCollision=e=>{this.collision.add(e)},this.removeCollision=e=>{this.collision.remove(e)},this.initItems=()=>{j.body=new ds(t),j.ray=new Li(t),j.joint=new Is(t),j.solid=new bc(t),j.contact=new Es(t),j.terrain=new Ro(t),j.character=new vo(t),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(j.vehicle=new Bs(t)),"PHYSX"===this.engine&&(j.solver=new To(t))},this.getBodyRef=()=>j.body,this.getCharacterRef=()=>j.character,this.getGeometryRef=(e,t,i)=>{j.body.geometry(e,t,i)},this.clearBody=()=>{j.body.reset()},this.resetItems=()=>{Object.values(j).forEach((e=>e.reset()))},this.stepItems=()=>{Object.values(j).forEach((e=>e.step(O,q[e.type]))),this.upInstance(),this.upButton()},this.getTransform=e=>j.body.getTransform(e),this.upInstance=()=>{Object.values(this.instanceMesh).forEach((e=>e.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((e=>e.dispose())),this.instanceMesh={}},this.adds=(e=[],t=!1)=>{let i=e.length,s=0;for(;i--;)this.add(e[s++],t)},this.add=(e={},t=!1)=>{if(e.isObject3D)return this.addDirect(e);if(e.constructor===Array)return this.adds(e,t);if("container"===e.type)return new Ho(e,this);void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box"),void 0!==e.mode&&(e.type="joint");let i=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.mass||e.density||e.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return e.type}}(e);"joint"===i&&void 0===e.mode&&(e.mode=e.type,e.type="joint");let s=j[i].add(e);return this.garbage.push(s.name),s},this.addDirect=e=>(this.scenePlus.add(e),this.tmpMesh.push(e),e),this.removes=(e=[],t)=>{let i=e.length,s=0;for(;i--;)this.remove(e[s++],t)},this.remove=(e,t=!1)=>{if(e.constructor===Array)return this.removes(e,t);let i=this.byName(e);null!==i?(this.removeCollision(e),"autoRagdoll"!==i.type?(i.extraRemove&&i.extraRemove(),j[i.type].clear(i),this.post({m:"remove",o:{name:e,type:i.type}},null,t)):this.utils.remove(i)):this.instanceMesh[e]&&j.body.clearInstance(e)},this.changes=(e=[],t=!1)=>{let i=e.length,s=0;for(;i--;)this.changeOne(e[s++],t)},this.change=(e,t=!1)=>{t?e instanceof Array?this.changes(e,!0):this.changeOne(e,!0):e instanceof Array?this.flow.tmp.push(...e):this.flow.tmp.push(e)},this.changeOne=(e={},t=!1)=>{if(e.heightData)return;let i=this.byName(e.name);if(null===i)return null;let s=i.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=ci.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=ci.quatFromEuler(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=ci.toLocalQuatArray(e.localRot,i),delete e.localRot),s){case"terrain":i=j.terrain.set(e,i),t=!1;break;case"ray":i=j.ray.set(e,i),t=!1;break;case"character":i=j.character.set(e,i);break;case"solid":i=j.solid.set(e,i);break;case"joint":i=j.joint.set(e,i);break;case"body":i.isKinematic||(i.actif&&!i.sleep||j.body.set(e,i),e.sleep&&j.body.set(e,i))}t&&this.post({m:"change",o:e},null,t)},this.setControl=e=>{y=e,T=y.getAzimuthalAngle},this.getControl=()=>y,this.getCurrentCharacterPosition=()=>y.followGroup.position,this.getCamera=(e={})=>y.object,this.setCamera=(e={})=>{y.moveCam(e)},this.follow=(e="",t={})=>{let i=null;"string"==typeof e||e instanceof String?i=""===e?null:this.byName(e):e.isObject3D&&(i=e),null===i?y.resetFollow():y.startFollow(i,t)},this.setTimeout=(e,t=0,i=!1)=>{i?E=setTimeout(e,t):(C=e,v=t,E=setTimeout(C,v))},this.playtimout=()=>{null!==C&&(E=setTimeout(C,v))},this.pausetimout=()=>{null!==E&&clearTimeout(E)},this.cleartimout=(e,t)=>{null!==E&&(C=null,v=0,clearTimeout(E),E=null)},this.texture=(e={})=>so.texture(e),this.getTexture=(e,t={})=>so.getTexture(e,t),this.setExtendShader=e=>{this.mat.extendShader=e},this.addMaterial=(e,t)=>{this.mat.set(e,t)},this.directIntensity=e=>{},this.setEnvmapIntensity=e=>{},this.getMatRef=()=>this.mat,this.getMat=e=>this.mat.get(e),this.getMaterial=e=>this.mat.get(e),this.getMaterialList=()=>this.mat.getList(),this.material=(e={})=>this.mat.create(e),this.changeRenderMode=e=>this.mat.changeRenderMode(e),this.load=so.load,this.get=so.get,this.getGroup=so.getGroup,this.getScript=so.getScript,this.preload=(e,t)=>{Io.add(e,t)},this.applyMorph=(e,t=null,i=!0,s=!0)=>{so.applyMorph(e,null,!0,!0)},this.getMesh=(e,t,i)=>{if(t){let t=so.getMaterials(e);for(let e in t)this.addMaterial(t[e])}return so.getMesh(e,i)},this.getGlb=(e,t,i)=>{if(t){let t=so.getMaterials(e);for(let e in t)this.addMaterial(t[e])}return so.getGLB(e,i)},this.getGlbMaterial=e=>{let t=so.getMaterials(e);return this.mat.addToMat(t),t},this.poolDispose=()=>so.dispose(),this.setDracoPath=e=>so.dracoPath=e,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addSoftSolver=e=>{let t=new el(e,this);return U.push(t),t},this.updateSoftSolver=()=>{let e=U.length;for(;e--;)U[e].update()},this.clearSoftSolver=()=>{U.length,U=[]},this.addButton=e=>{let t=new Uo(e,this);return _.push(t),t},this.upButton=e=>{for(const e in _)_[e].update()},this.addText=e=>{let t=new _o(e);return e.parent?e.parent.add(t):this.scenePlus.add(t),z.push(t),t},this.clearText=()=>{let e=z.length;for(;e--;)z[e].dispose();z=[]},this.screenshot=()=>{var e=window.open("","");e.document.title="Screenshot",e.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var t=new Image;Q.render(S,this.getCamera()),t.src=Q.domElement.toDataURL(),e.document.body.appendChild(t)},this.getBreaker=()=>(null!==p||(p=new Ml(this)),p),this.setColorChecker=e=>{N=e},this.getColorChecker=()=>N,this.addWiggle=(e={})=>{},this.initParticleEngine=()=>{i||(i=new gc,this.scene.add(i))},this.addParticle=(e={})=>(null===i&&this.initParticleEngine(),i.add(e)),this.getParticle=e=>null===i?null:i.get(e),this.explosion=(e=[0,0,0],t=10,i=1)=>{let s=[],a=new W;e&&(e.isVector3?a.copy(e):a.fromArray(e));let r,n,o=new W,l=j.body.list.length;for(;l--;)r=j.body.list[l],o.copy(r.position).sub(a),n=1-o.length()/t,r.isKinematic||n<0||(o.setLength(n),o.multiplyScalar(i),s.push({name:r.name,impulse:o.toArray(),wake:!0}));this.change(s)}}set onStep(e){this.setStep(e)}}class bc extends ds{constructor(e){super(e),this.type="solid"}step(){}}class yc{constructor(e){this.map=new Map,this.motor=e}byName(e){return this.map.has(e)?this.map.get(e):null}add(e,t){if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else if(e.isButton)this.motor.scene.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(e);break;default:this.motor.scene.add(e)}e.isInstance&&e.refName!==e.name&&this.map.set(e.refName,e),this.map.set(e.name,e)}remove(e){e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.isInstance&&(e.refName!==e.name&&this.map.delete(e.refName),e.instance.remove(e.idx)),this.map.delete(e.name)}noRay(e){e.isObject3D&&(e.raycast=()=>{},e.traverse((e=>{e.isObject3D&&(e.raycast=()=>{})})))}morph(e,t,i){e.morphTargetInfluences&&void 0!==e.morphTargetDictionary[t]&&(e.morphTargetInfluences[e.morphTargetDictionary[t]]=i)}toLocal(e,t,i=!1){i||e.sub(t.position);let s=t.quaternion;return e.applyQuaternion({x:-s._x,y:-s._y,z:-s._z,w:s._w}),e}quatLocal(e,t){t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new Y).fromArray(e),s=t.quaternion.clone().invert();return i.premultiply(s),i.normalize().toArray()}axisLocal(e,t){t.isObject3D&&t.updateWorldMatrix(!0,!1);let i=(new le).setFromMatrix4(t.matrixWorld);return(new W).fromArray(e).applyMatrix3(i).toArray()}quatToAngular(e,t){t[0]*=-1,t[1]*=-1,t[2]*=-1;let i,s=t[0]*e[3]+t[3]*e[0]+t[1]*e[2]-t[2]*e[1],a=t[1]*e[3]+t[3]*e[1]+t[2]*e[0]-t[0]*e[2],r=t[2]*e[3]+t[3]*e[2]+t[0]*e[1]-t[1]*e[0],n=t[3]*e[3]-t[0]*e[0]-t[1]*e[1]-t[2]*e[2],o=2*Math.acos(n),l=Math.sqrt(1-n*n);i=l<.001?[0,0,0]:[s/l,a/l,r/l];(new W).fromArray(i).multiplyScalar(o/1)}refAxis(e,t){let i=(new W).fromArray(t),s=new W(1,0,0),a=new W(0,1,0);Math.abs(t[1])>.9999||s.copy(i).cross(a).normalize(),a.copy(s).cross(i).normalize(),e.makeBasis(s,a,i)}}const wc=new fc,Ic=fc,Ec=ci,Cc=so;export{Ec as math,wc as phy,Ic as phy2,Cc as pool};
